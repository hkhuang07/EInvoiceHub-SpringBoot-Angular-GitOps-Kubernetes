flowchart TB
    subgraph Client["Ứng Dụng Khách Hàng"]
        FE["Frontend Application"]
        API["API Client"]
    end

    subgraph Gateway["API Gateway Layer"]
        LB["Load Balancer"]
    end

    subgraph Security["Security Layer"]
        AKF["ApiKeyFilter\n(OncePerRequestFilter)"]
        AUTH["Authentication Manager"]
    end

    subgraph Controller["Presentation Layer"]
        ICC["InvoiceController"]
        V["Validator"]
    end

    subgraph Service["Business Logic Layer"]
        ISV["InvoiceService"]
        ICM["InvoiceContext\nBuilder"]
        PCF["ProviderFactory"]
    end

    subgraph Provider["Provider Adapter Layer"]
        subgraph Providers["Concrete Adapters"]
            VNPT["VnptAdapter"]
            VT["ViettelAdapter"]
            BKAV["BkavAdapter"]
            MISA["MisaAdapter"]
        end
        IP["InvoiceProvider\nInterface"]
    end

    subgraph DAL["Data Access Layer"]
        REPO["Repository Layer"]
        DB["MySQL\nMetadata"]
        MONGO["MongoDB\nPayloads"]
    end

    subgraph External["External Providers"]
        VNPT_API["VNPT API"]
        VT_API["Viettel API"]
        BKAV_API["BKAV API\n(WebService + AES-256)"]
        MISA_API["MISA API\n(REST + OAuth)"]
    end

    %% Client Request Flow
    FE -->|HTTP Request| API
    API -->|HTTP Request with\nX-CLIENT-ID, X-API-KEY| LB
    LB -->|Forward Request| AKF

    %% Security Flow
    AKF -->|Extract Headers| AUTH
    AUTH -->|Validate API Key| REPO
    REPO -->|Query Credential| DB
    
    alt Authentication Successful
        AUTH -->|Set Security Context| ICC
        ICC -->|Validated Request| V
        V -->|Valid Data| ISV
    else Authentication Failed
        AUTH -->|401 Unauthorized| API
    end

    %% Service Layer Flow
    ISV -->|Build Context| ICM
    ICM -->|Select Provider| PCF
    PCF -->|Return Adapter Instance| ISV
    
    ISV -->|Forward Request| IP
    
    %% Provider Selection and Execution
    IP -->|Check Provider Code| PCF
    PCF -->|Route to| VNPT
    PCF -->|Route to| VT
    PCF -->|Route to| BKAV
    PCF -->|Route to| MISA

    %% VNPT Flow
    VNPT -->|REST API Call| VNPT_API
    VNPT_API -->|JSON Response| VNPT
    
    %% Viettel Flow
    VT -->|REST API Call| VT_API
    VT_API -->|JSON Response| VT
    
    %% BKAV Flow
    BKAV -->|AES-256 Encrypt\n+ SOAP Call| BKAV_API
    BKAV_API -->|XML Response\n+ Decrypt| BKAV
    
    %% MISA Flow
    MISA -->|1. Get Bearer Token| MISA_API
    MISA -->|2. REST API Call\nwith Token| MISA_API
    MISA_API -->|JSON Response| MISA

    %% Return from Provider
    VNPT -->|InvoiceResponse| ISV
    VT -->|InvoiceResponse| ISV
    BKAV -->|InvoiceResponse| ISV
    MISA -->|InvoiceResponse| ISV

    %% Database Updates
    ISV -->|Save Metadata| REPO
    ISV -->|Save Full Payload| MONGO

    %% Response to Client
    ISV -->|InvoiceResponse| ICC
    ICC -->|HTTP 200 OK| LB
    LB -->|HTTP Response| API
    API -->|JSON Response| FE

    %% Style Definitions
    classDef client fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef security fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef service fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef provider fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef database fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef external fill:#fce4ec,stroke:#c2185b,stroke-width:2px

    class FE,API client
    class AKF,AUTH security
    class ISV,ICM,PCF service
    class VNPT,VT,BKAV,MISA,IP provider
    class DB,MONGO,REPO database
    class VNPT_API,VT_API,BKAV_API,MISA_API external
