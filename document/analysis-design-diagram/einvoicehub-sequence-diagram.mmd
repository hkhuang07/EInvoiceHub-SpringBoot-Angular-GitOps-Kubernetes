sequenceDiagram
    autonumber
    participant Client as "Client App"
    participant Filter as "ApiKeyFilter"
    participant Controller as "InvoiceController"
    participant Service as "InvoiceService"
    participant DB_SQL as "MySQL (Metadata)"
    participant DB_Mongo as "MongoDB (Payload)"
    participant Factory as "ProviderFactory"
    participant Adapter as "Concrete Adapter"
    participant External as "External API"

    Note over Client,Filter: Phase 1: Authentication & Authorization
    Client->>Filter: POST /api/v1/invoices (Headers: API-KEY)
    Filter->>DB_SQL: Validate API Key & Rate Limit
    DB_SQL-->>Filter: Valid & Within Quota
    Filter->>Filter: Set SecurityContext

    Note over Controller,DB_Mongo: Phase 2: Initialization & Persistence
    Filter->>Controller: Forward Request
    Controller->>Service: createInvoice(InvoiceRequest)
    Service->>DB_SQL: Save InvoiceMetadata (Status: PENDING)
    Service->>DB_Mongo: Save Raw Request Payload
    
    Note over Service,Factory: Phase 3: Provider Selection
    Service->>Factory: getProvider(providerCode)
    Factory-->>Service: Return Adapter Instance
    
    Note over Adapter,External: Phase 4: Provider-Specific Execution
    Service->>Adapter: issueInvoice(request, config)
    
    alt BKAV (Security Focus)
        Adapter->>Adapter: AES-256 Encrypt Data
        Adapter->>External: SOAP Request (Encrypted)
        External-->>Adapter: SOAP Response
        Adapter->>Adapter: AES-256 Decrypt Data
    else MISA (Token Focus)
        Adapter->>External: POST /auth/token (Get Session)
        External-->>Adapter: Access Token
        Adapter->>External: POST /invoice (with Bearer Token)
    else VNPT/Viettel (Rest Focus)
        Adapter->>External: POST /invoices (JSON)
    end
    
    External-->>Adapter: Invoice Response (Success/Fail)
    Adapter-->>Service: Unified InvoiceResponse
    
    Note over Service,DB_SQL: Phase 5: Final Update
    Service->>DB_SQL: Update Metadata (Status: SUCCESS/FAILED, InvoiceNo, UUID)
    Service->>DB_Mongo: Update Response Payload & Latency
    
    Service-->>Controller: Return Result
    Controller-->>Client: HTTP 200 OK + JSON Response