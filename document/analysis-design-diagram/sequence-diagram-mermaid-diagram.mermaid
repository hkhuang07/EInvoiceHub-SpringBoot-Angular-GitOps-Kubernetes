sequenceDiagram
    autonumber
    participant Client as "Client App"
    participant Filter as "ApiKeyFilter"
    participant Controller as "InvoiceController"
    participant Service as "InvoiceService"
    participant Factory as "ProviderFactory"
    participant Adapter as "Concrete Adapter"
    participant DB as "Database"
    participant External as "External API"

    Note over Client,Filter: Phase 1: Authentication
    Client->>Filter: POST /api/v1/invoices\nHeaders: X-CLIENT-ID, X-API-KEY
    Filter->>DB: Validate API Key
    DB-->>Filter: Credentials Valid
    Filter->>Filter: Set SecurityContext
    
    Note over Controller,Service: Phase 2: Request Processing
    Filter->>Controller: Forward Valid Request
    Controller->>Service: issueInvoice(InvoiceRequest)
    
    Note over Service,Factory: Phase 3: Provider Selection
    Service->>Factory: getProvider(providerCode)
    Factory-->>Service: InvoiceProvider Instance
    
    Note over Adapter,External: Phase 4: External API Call
    Service->>Adapter: issueInvoice(request, config)
    
    Note over Adapter,External: Provider-Specific Logic
    alt VNPT/Viettel
        Adapter->>External: HTTP POST + JSON
    else BKAV
        Adapter->>Adapter: AES-256 Encrypt
        Adapter->>External: SOAP Request
        External-->>Adapter: SOAP Response
        Adapter->>Adapter: AES-256 Decrypt
    else MISA
        Adapter->>External: POST /auth/token
        External-->>Adapter: Bearer Token
        Adapter->>External: HTTP POST + Authorization
    end
    
    External-->>Adapter: Invoice Response
    Adapter-->>Service: InvoiceResponse
    
    Note over Service,DB: Phase 5: Data Persistence
    Service->>DB: Save InvoiceMetadata
    Service->>DB: Update Status
    
    Service-->>Controller: InvoiceResponse
    Controller-->>Client: HTTP 200 OK + JSON
