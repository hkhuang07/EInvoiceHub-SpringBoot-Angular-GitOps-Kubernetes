1. Hệ quản trị cơ sở dữ liệu MySQL (Relational)
Đây là nơi lưu trữ "xương sống" của hệ thống, phục vụ quản lý, tra cứu và báo cáo.
1.1. Nhóm Quản lý Merchant (Khách hàng doanh nghiệp)
Thay vì chỉ một bảng merchants, ta cần tách nhỏ để quản lý bảo mật và phân quyền tốt hơn.
-   Bảng merchants (Thông tin pháp nhân):
o	id (UUID/Long): Primary Key.
o	tax_code (VARCHAR 20): Mã số thuế (Unique - dùng để định danh doanh nghiệp).
o	company_name: Tên công ty.
o	address, email, phone: Thông tin liên hệ.
o	subscription_plan (Enum): Gói dịch vụ (Trial, Basic, Premium) - để giới hạn số lượng hóa đơn.
o	status (Enum): ACTIVE, INACTIVE, SUSPENDED.
o	is_delete (Boolean).
o	created_at, updated_at.
-   Bảng merchant_users (Tài khoản nhân viên của Merchant):
o	id, merchant_id (FK).
o	username, password_hash.
o	full_name, role (ADMIN, STAFF, VIEWER).
o	Mục đích: Cho phép nhiều người trong một doanh nghiệp cùng quản lý hóa đơn.
1.2. Nhóm Bảo mật & Tích hợp (API Keys)
-   Bảng api_credentials:
o	id, merchant_id (FK).
o	client_id (VARCHAR 50): Công khai.
o	api_key_hash (VARCHAR 255): Lưu hash của Secret Key.
o	salt (VARCHAR 50).
o	scopes (TEXT): Lưu các quyền (VD: invoice.create, invoice.view).
o	ip_whitelist (TEXT): Chỉ cho phép các IP cụ thể gọi API (Tăng tính bảo mật cho doanh nghiệp).
o	expired_at: Ngày hết hạn key.
1.3. Nhóm Cấu hình Provider (Kết nối VNPT, Viettel...)
-   Bảng service_providers (Danh mục nhà cung cấp):
o	id, provider_code (VNPT, VIETTEL, BKAV, MISA).
o	provider_name, official_api_url.
-   Bảng merchant_provider_configs (Cấu hình riêng cho từng Merchant):
o	id, merchant_id (FK), provider_id (FK).
o	username_service, password_service_encrypted: Tài khoản do Provider cấp cho Merchant.
o	service_url_custom: Đường dẫn API riêng (nếu có).
o	extra_config (JSON): Lưu các tham số đặc thù như Pattern, Serial của hóa đơn.
o	is_active (Boolean).
1.4. Nhóm Quản lý Hóa đơn (Metadata)
Bảng này cực kỳ quan trọng để người dùng tìm kiếm hóa đơn trên Dashboard Angular mà không cần truy vấn MongoDB.
-   Bảng invoices_metadata:
o	id (Long): PK.
o	merchant_id (FK), provider_id (FK).
o	invoice_number (VARCHAR 20): Số hóa đơn từ Provider trả về.
o	symbol (VARCHAR 10): Ký hiệu hóa đơn (VD: 1C23TML).
o	customer_name, customer_tax_code: Thông tin người mua.
o	total_amount, tax_amount, currency (VND/USD).
o	status (Enum): DRAFT, SIGNING, SENT_TO_PROVIDER, SUCCESS, FAILED, CANCELLED, REPLACED.
o	mongo_payload_id (String): ID của bản ghi trong MongoDB.
o	issue_date: Ngày lập hóa đơn.
________________________________________
2. Hệ quản trị MongoDB (Document-based)
Dùng để lưu trữ những dữ liệu "phình to" theo thời gian và không cần cấu trúc chặt chẽ.
2.1. Collection invoice_payloads
Lưu dữ liệu thô mà Merchant gửi lên EInvoiceHub.
JSON
{
  "_id": "ObjectId",
  "merchant_id": 101,
  "client_request_id": "REQ-001",
  "data": {
    "buyer": { "name": "Nguyễn Văn A", "tax_code": "01020304" },
    "items": [
      { "name": "Laptop Dell", "qty": 1, "price": 20000000 },
      { "name": "Chuột không dây", "qty": 2, "price": 500000 }
    ],
    "total": 21000000
  },
  "created_at": "2025-12-23T..."
}
2.2. Collection provider_transactions
Lưu vết mọi giao tiếp với bên thứ 3 (VNPT/Viettel). Đây là căn cứ để đối soát khi có tranh chấp hoặc lỗi hệ thống.
JSON
{
  "_id": "ObjectId",
  "invoice_metadata_id": 5001,
  "provider_code": "VNPT",
  "request_to_provider": { "url": "...", "body": "..." },
  "response_from_provider": { "status_code": 200, "body": "...", "error_message": "" },
  "latency_ms": 150,
  "timestamp": "2025-12-23T..."
}
________________________________________
