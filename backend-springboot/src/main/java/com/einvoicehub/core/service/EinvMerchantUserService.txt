package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.MerchantEntity;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.domain.entity.EinvMerchantUserEntity;
import com.einvoicehub.core.domain.repository.MerchantRepository;
import com.einvoicehub.core.domain.repository.EinvMerchantUserRepository;
import com.einvoicehub.core.dto.EinvMerchantUserRequest;
import com.einvoicehub.core.dto.EinvMerchantUserResponse;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvMerchantUserService {

    private final EinvMerchantUserRepository repository;
    private final MerchantRepository merchantRepository;
    private final EinvHubMapper mapper;

    // private final PasswordEncoder passwordEncoder;

    @Transactional(readOnly = true)
    public List<EinvMerchantUserResponse> getAllByMerchant(Long merchantId) {
        log.info("[User] Lấy danh sách nhân sự cho Merchant ID: {}", merchantId);
        return repository.findAll().stream()
                .filter(u -> u.getMerchant().getId().equals(merchantId))
                .map(mapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvMerchantUserResponse getById(Long id) {
        return repository.findById(id)
                .map(mapper::toResponse)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Người dùng không tồn tại"));
    }

    @Transactional
    public EinvMerchantUserResponse create(EinvMerchantUserRequest request) {
        log.info("[User] Tạo tài khoản mới: {} cho Merchant ID: {}", request.getUsername(), request.getMerchantId());

        // 1. Kiểm tra trạng thái Merchant (Logic SOFTZ)
        MerchantEntity merchant = merchantRepository.findById(request.getMerchantId())
                .filter(m -> !m.getIsDeleted())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND));

        // 2. Kiểm tra trùng lặp tài khoản
        if (repository.findByUsername(request.getUsername()).isPresent()) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Tên đăng nhập đã tồn tại");
        }

        EinvMerchantUserEntity entity = mapper.toEntity(request);
        entity.setMerchant(merchant);

        // 3. Logic SOFTZ: Mã hóa mật khẩu (Giả định hash mật khẩu ở đây)
        // entity.setPasswordHash(passwordEncoder.encode(request.getPassword()));
        entity.setPasswordHash("HASHED_" + request.getPassword());

        entity.setIsActive(true);
        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public EinvMerchantUserResponse update(Long id, EinvMerchantUserRequest request) {
        log.info("[User] Cập nhật thông tin người dùng ID: {}", id);
        EinvMerchantUserEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Tài khoản không tồn tại"));

        entity.setFullName(request.getFullName());
        entity.setPhone(request.getPhone());
        entity.setRole(com.einvoicehub.core.domain.entity.enums.UserRole.valueOf(request.getRole()));

        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[User] Xóa tài khoản ID: {}", id);
        EinvMerchantUserEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Tài khoản không tồn tại"));

        if (entity.getIsPrimary()) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Không thể xóa tài khoản chủ của doanh nghiệp");
        }

        repository.delete(entity);
    }
}