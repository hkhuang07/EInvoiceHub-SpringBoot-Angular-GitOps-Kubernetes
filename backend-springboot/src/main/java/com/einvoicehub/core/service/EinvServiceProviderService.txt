package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.EinvProviderEntity;
import com.einvoicehub.core.domain.repository.EinvInvoiceRepository;
import com.einvoicehub.core.domain.repository.EinvMerchantProviderConfigRepository;
import com.einvoicehub.core.domain.repository.EinvProviderRepository;
import com.einvoicehub.core.dto.EinvServiceProviderDto;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvServiceProviderService {

    private final EinvProviderRepository repository;
    private final EinvMerchantProviderConfigRepository providerConfigRepository;
    private final EinvInvoiceRepository metadataRepository;
    private final EinvHubMapper mapper;


    @Transactional(readOnly = true)
    public List<EinvServiceProviderDto> getAll() {
        log.info("[Config] Đang truy vấn danh sách toàn bộ nhà cung cấp dịch vụ");
        return repository.findAll().stream()
                .map(mapper::toDto)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvServiceProviderDto getById(Long id) {
        log.info("[Config] Đang tìm kiếm nhà cung cấp ID: {}", id);
        return repository.findById(id)
                .map(mapper::toDto)
                .orElseThrow(() -> {
                    log.error("[Config] Không tìm thấy nhà cung cấp với ID: {}", id);
                    return new InvalidDataException(ErrorCode.INVALID_DATA, "Nhà cung cấp không tồn tại trên hệ thống");
                });
    }

    @Transactional
    public EinvServiceProviderDto create(EinvServiceProviderDto dto) {
        log.info("[Config] Đang tạo mới nhà cung cấp với mã: {}", dto.getProviderCode());

        if (repository.findByProviderCodeAndIsActiveTrue(dto.getProviderCode()).isPresent()) {
            log.warn("[Config] Mã nhà cung cấp {} đã tồn tại", dto.getProviderCode());
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Mã nhà cung cấp đã tồn tại trong danh mục");
        }

        if (Boolean.TRUE.equals(dto.getIsDefault())) {
            repository.findByIsDefaultTrue().ifPresent(oldDefault -> {
                oldDefault.setIsDefault(false);
                repository.save(oldDefault);
            });
        }

        EinvProviderEntity entity = mapper.toEntity(dto);
        entity = repository.save(entity);

        log.info("[Config] Đã tạo thành công nhà cung cấp: {} (ID: {})", entity.getProviderName(), entity.getId());
        return mapper.toDto(entity);
    }

    @Transactional
    public EinvServiceProviderDto update(Long id, EinvServiceProviderDto dto) {
        log.info("[Config] Đang cập nhật thông tin nhà cung cấp ID: {}", id);

        EinvProviderEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Dữ liệu không tồn tại để cập nhật"));

        entity.setProviderName(dto.getProviderName());
        entity.setOfficialApiUrl(dto.getOfficialApiUrl());
        entity.setLookupUrl(dto.getLookupUrl());
        entity.setSupportEmail(dto.getSupportEmail());
        entity.setSupportPhone(dto.getSupportPhone());
        entity.setIsActive(dto.getIsActive());
        entity.setDisplayOrder(dto.getDisplayOrder());

        // Xử lý logic đổi Provider mặc định
        if (Boolean.TRUE.equals(dto.getIsDefault()) && !entity.getIsDefault()) {
            repository.findByIsDefaultTrue().ifPresent(oldDefault -> {
                oldDefault.setIsDefault(false);
                repository.save(oldDefault);
            });
            entity.setIsDefault(true);
        }

        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Config] Đang thực hiện yêu cầu xóa nhà cung cấp ID: {}", id);
        if (!repository.existsById(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Bản ghi không tồn tại");
        }
        if (providerConfigRepository.existsByProviderId(id)) {
            log.error("[Config] Xóa thất bại: Nhà cung cấp ID {} đang được dùng trong cấu hình Merchant", id);
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Không thể xóa nhà cung cấp đang có doanh nghiệp liên kết");
        }
        if (metadataRepository.existsByProviderId(id)) {
            log.error("[Config] Xóa thất bại: Nhà cung cấp ID {} đã phát sinh dữ liệu hóa đơn", id);
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Hệ thống đã phát sinh hóa đơn thông qua nhà cung cấp này, không được xóa");
        }
        repository.deleteById(id);
        log.info("[Config] Đã xóa thành công nhà cung cấp ID: {}", id);
    }
}