This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: **/*
- Files matching these patterns are excluded: **/bin/**, **/target/**, **/*.class, **/*.exe, **/*.jar, mvnw, mvnw.cmd, **/HELP.md, **/.git/**, **/.idea/**, **/.vscode/**, **/node_modules/**, **/dist/**
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.mvn/
  wrapper/
    maven-wrapper.properties
helm/
  einvoicehub/
    Chart.yaml
    values.yaml
kubernetes/
  deployment.yaml
  ingress.yaml
  service.yaml
monitoring/
  alertmanager/
    alertmanager.yml
  grafana/
    dashboards/
      einvoicehub/
        einvoicehub-overview.json
    provisioning/
      dashboards/
        default.yaml
      datasources/
        prometheus.yaml
  prometheus/
    prometheus.yml
src/
  main/
    java/
      com/
        einvoicehub/
          core/
            common/
              exception/
                AppException.java
                ErrorCode.java
                GlobalExceptionHandler.java
                InsufficientQuotaException.java
                MerchantNotFoundException.java
            config/
              SecurityConfig.java
              VirtualThreadConfig.java
              WebClientConfig.java
            converter/
              EncryptionConverter.java
              JsonAttributeConverter.java
            dto/
              request/
                InvoiceItemRequest.java
                InvoiceRequest.java
              response/
                ApiResponse.java
                InvoiceResponse.java
            entity/
              enums/
                EntityStatus.java
                InvoiceStatus.java
                SubscriptionPlan.java
                UserRole.java
              jpa/
                ApiCredential.java
                InvoiceItem.java
                InvoiceMetadata.java
                InvoicePayload.java
                Merchant.java
                MerchantProviderConfig.java
                MerchantUser.java
                ProviderTransaction.java
                ServiceProvider.java
            provider/
              exception/
                ProviderException.java
              impl/
                bkav/
                  BkavAdapter.java
                  BkavApiMapper.java
                misa/
                  MisaAdapter.java
                  MisaApiMapper.java
                viettel/
                  ViettelAdapter.java
                  ViettelApiMapper.java
                vnpt/
                  VnptAdapter.java
                  VnptApiMapper.java
              model/
                InvoiceRequest.java
                InvoiceResponse.java
              InvoiceProvider.java
              ProviderConfig.java
              ProviderFactory.java
            repository/
              jpa/
                ApiCredentialRepository.java
                InvoiceItemRepository.java
                InvoiceMetadataRepository.java
                InvoicePayloadRepository.java
                MerchantProviderConfigRepository.java
                MerchantRepository.java
                MerchantUserRepository.java
                ProviderTransactionRepository.java
                ServiceProviderRepository.java
            security/
              ApiKeyAuthenticationToken.java
              ApiKeyFilter.java
              JwtAuthenticationFilter.java
              JwtTokenProvider.java
              SecurityConfig.java
            service/
              InvoicePayloadService.java
              InvoiceService.java
            util/
              IdGenerator.java
            EinvoiceCoreApplication.java
    resources/
      db/
        migration/
          Initial_Schema_Ver01.sql
          Initial_Schema_Ver02.sql
          V1__Initial_Schema.sql
      application.yaml
  test/
    java/
      com/
        einvoicehub/
          core/
            EinvoiceCoreApplicationTests.java
terraform/
  main.tf
  outputs.tf
  variables.tf
.gitattributes
.gitignore
config.yaml
docker-compose.yml
Dockerfile
Jenkinsfile.txt
pom.xml
purge-data.sh
repomix.config.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".mvn/wrapper/maven-wrapper.properties">
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.12/apache-maven-3.9.12-bin.zip
</file>

<file path="helm/einvoicehub/Chart.yaml">
# EInvoiceHub Helm Chart

apiVersion: v2
name: einvoicehub
description: A Helm chart for EInvoiceHub - Electronic Invoice Hub Service

# Application version
version: 1.0.0
appVersion: "1.0.0"

# Maintainers
maintainers:
  - name:  EInvoiceHub SoftZ
    email: softz@einvoicehub.io

# Dependencies
dependencies:
  - name: mysql
    version: "9.x.x"
    repository: "https://charts.bitnami.com/bitnami"
    condition: mysql.enabled
    alias: mysql

  - name: mongodb
    version: "13.x.x"
    repository: "https://charts.bitnami.com/bitnami"
    condition: mongodb.enabled
    alias: mongodb

  - name: redis
    version: "17.x.x"
    repository: "https://charts.bitnami.com/bitnami"
    condition: redis.enabled
    alias: redis

  - name: prometheus
    version: "45.x.x"
    repository: "https://prometheus-community.github.io/helm-charts"
    condition: prometheus.enabled
    alias: prometheus

  - name: grafana
    version: "6.x.x"
    repository: "https://grafana.github.io/helm-charts"
    condition: grafana.enabled
    alias: grafana

  - name: jaeger
    version: "0.x.x"
    repository: "https://jaegertracing.github.io/helm-charts"
    condition: jaeger.enabled
    alias: jaeger

# Keywords
keywords:
  - einvoicehub
  - electronic-invoice
  - invoicing
  - spring-boot
  - java
  - kubernetes

# Home page home: https://einvoicehub.io

# Icon icon: https://einvoicehub.io/logo.svg

# License
license: Apache-2.0

# Annotations
annotations:
  category: Application
  licenses: Apache-2.0
</file>

<file path="helm/einvoicehub/values.yaml">
# EInvoiceHub Helm Chart Values

# Global Settings

global:
  imageRegistry: registry.einvoicehub.io
  imagePullSecrets:
    - name: registry-credentials
  storageClass: standard
  timezone: Asia/Ho_Chi_Minh

# EInvoiceHub Application Configuration
replicaCount: 2

image:
  repository: einvoicehub/backend
  tag: 1.0.0
  pullPolicy: IfNotPresent

imagePullSecrets:
  - name: registry-credentials

nameOverride: ""
fullnameOverride: ""

# Service Account
serviceAccount:
  create: true
  name: einvoicehub
  annotations: {}

# Pod Security Context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000

# Container Security Context
securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

# Service Configuration
service:
  type: ClusterIP
  port: 80
  targetPort: 8080

# Ingress Configuration
ingress:
  enabled: true
  className: nginx
  hosts:
    - host: einvoice.local
      paths:
        - path: /api
          pathType: ImplementationSpecific
        - path: /actuator
          pathType: ImplementationSpecific
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"

# Resources Configuration
resources:
  requests:
    cpu: 250m
    memory: 256Mi
  limits:
    cpu: 1000m
    memory: 1Gi

# Autoscaling Configuration
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# Node Selection
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app: einvoicehub
          topologyKey: kubernetes.io/hostname

# Liveness Probe
livenessProbe:
  httpGet:
    path: /actuator/health/liveness
    port: http
  initialDelaySeconds: 60
  periodSeconds: 30
  timeoutSeconds: 10
  failureThreshold: 3
  successThreshold: 1

# Readiness Probe
readinessProbe:
  httpGet:
    path: /actuator/health/readiness
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

# Startup Probe
startupProbe:
  httpGet:
    path: /actuator/health
    port: http
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 30
  successThreshold: 1

# Application Environment Variables
env:
  # Application Settings
  APP_NAME: einvoicehub
  APP_VERSION: 1.0.0
  SPRING_PROFILES_ACTIVE: prod

  # Logging
  LOG_LEVEL: INFO
  LOG_FORMAT: json

  # JVM Options
  JAVA_OPTS: "-XX:+UseG1GC -XX:MaxGCPauseMillis=200 -Xms256m -Xmx512m"
  JAVA_THREADS_VIRTUAL_ENABLED: "true"

# Environment Variables from Secrets
envFrom:
  - configMapRef:
      name: einvoicehub-config
  - secretRef:
      name: einvoicehub-secrets
  - secretRef:
      name: einvoicehub-provider-secrets


# Database Configuration
mysql:
  enabled: true
  architecture: standalone
  auth:
    database: einvoicehub
    existingSecret: einvoicehub-mysql-secret
    secretKeys:
      rootPasswordKey: mysql-root-password
      userPasswordKey: mysql-password
  primary:
    persistence:
      enabled: true
      size: 10Gi
      storageClass: standard
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1Gi
    livenessProbe:
      enabled: true
      initialDelaySeconds: 120
    readinessProbe:
      enabled: true
      initialDelaySeconds: 30

mongodb:
  enabled: true
  architecture: standalone
  auth:
    database: einvoicehub
    existingSecret: einvoicehub-mongodb-secret
    secretKeys:
      mongodbPasswordKey: mongodb-password
      mongodbRootPasswordKey: mongodb-root-password
  persistence:
    enabled: true
    size: 10Gi
    storageClass: standard
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi

redis:
  enabled: true
  architecture: standalone
  auth:
    existingSecret: einvoicehub-redis-secret
    secretKeys:
      redisPasswordKey: redis-password
  master:
    persistence:
      enabled: false
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 256Mi

# Monitoring Configuration
prometheus:
  enabled: true
  prometheus:
    prometheusSpec:
      retention: 15d
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: standard
            resources:
              requests:
                storage: 20Gi
      ruleSelector:
        matchLabels:
          prometheus: einvoicehub
      serviceMonitorSelector:
        matchLabels:
          release: prometheus

grafana:
  enabled: true
  adminUser: admin
  adminPassword: einvoicehub_grafana_admin
  persistence:
    enabled: true
    storageClassName: standard
    size: 5Gi
  dashboardsProvider: true
  dashboardProviders:
    dashboardproviders.yaml:
      providers:
        - name: einvoicehub
          orgId: 1
          folder: EInvoiceHub
          type: file
          disableDeletion: false
          options:
            path: /var/lib/grafana/dashboards/einvoicehub
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          url: http://einvoicehub-prometheus:9090
          isDefault: true

jaeger:
  enabled: true
  collector:
    replicaCount: 1
    options:
      collector:
        zipkin:
          host-port: 9411
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
  query:
    replicaCount: 1
    options:
      query:
        base-path: /jaeger
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
  storage:
    type: memory

# Init Containers Configuration
initContainers:
  waitForMysql:
    enabled: true
    image: busybox:1.36
    resources:
      requests:
        cpu: 10m
        memory: 16Mi
      limits:
        cpu: 50m
        memory: 32Mi

  waitForMongodb:
    enabled: true
    image: busybox:1.36
    resources:
      requests:
        cpu: 10m
        memory: 16Mi
      limits:
        cpu: 50m
        memory: 32Mi

  waitForRedis:
    enabled: true
    image: busybox:1.36
    resources:
      requests:
        cpu: 10m
        memory: 16Mi
      limits:
        cpu: 50m
        memory: 32Mi

# Volume Configuration
volumes:
  logs:
    enabled: true
    type: emptyDir
  config:
    enabled: true
    type: configmap
    name: einvoicehub-config

# Topology Spread Configuration
topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: kubernetes.io/hostname
    whenUnsatisfiable: DoNotSchedule
    labelSelector:
      matchLabels:
        app: einvoicehub

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Network Policy
networkPolicy:
  enabled: true
  ingressRules:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - port: 8080
  egressRules:
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - port: 53
          protocol: UDP


# Rollout Strategy
rollingUpdate:
  maxSurge: 1
  maxUnavailable: 0


# Termination Grace Period
terminationGracePeriodSeconds: 30
</file>

<file path="kubernetes/ingress.yaml">
# EInvoiceHub Kubernetes Ingress Manifest

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: einvoicehub-ingress
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    version: v1
  annotations:
    # NGINX Ingress Controller Annotations
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"

    # Rate Limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "50"

    # CORS Configuration
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "Content-Type, Authorization, X-API-KEY, X-CLIENT-ID"

    # Security Headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;
      add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Custom Error Pages
    nginx.ingress.kubernetes.io/custom-http-errors: "404,500,503";

    # Rewrite Target for API
    nginx.ingress.kubernetes.io/rewrite-target: /$2

    # App Root
    nginx.ingress.kubernetes.io/app-root: "/actuator/health"

spec:
  ingressClassName: nginx
  rules:
    - host: einvoice.local
      http:
        paths:
          # API Routes
          - path: /api(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: einvoicehub
                port:
                  number: 80

          # Actuator Endpoints
          - path: /actuator(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: einvoicehub
                port:
                  number: 80

          # Prometheus Metrics (for scraping)
          - path: /metrics
            pathType: Exact
            backend:
              service:
                name: einvoicehub-prometheus
                port:
                  number: 9090

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: einvoicehub-monitoring-ingress
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: monitoring
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
spec:
  ingressClassName: nginx
  rules:
    - host: monitoring.einvoice.local
      http:
        paths:
          # Grafana Dashboard
          - path: /
            pathType: Prefix
            backend:
              service:
                name: einvoicehub-grafana
                port:
                  number: 3000

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: einvoicehub-tracing-ingress
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: tracing
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
spec:
  ingressClassName: nginx
  rules:
    - host: tracing.einvoice.local
      http:
        paths:
          # Jaeger UI
          - path: /
            pathType: Prefix
            backend:
              service:
                name: einvoicehub-jaeger
                port:
                  number: 16686

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: einvoicehub-network-policy
  namespace: einvoice-dev
  labels:
    app: einvoicehub
spec:
  podSelector:
    matchLabels:
      app: einvoicehub
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow traffic from Ingress Controller
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8080

    # Allow traffic from same namespace
    - from:
        - podSelector:
            matchLabels:
              app: einvoicehub
      ports:
        - protocol: TCP
          port: 8080

  egress:
    # Allow DNS resolution
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53

    # Allow traffic to MySQL
    - to:
        - podSelector:
            matchLabels:
              app: mysql
      ports:
        - protocol: TCP
          port: 3306

    # Allow traffic to MongoDB
    - to:
        - podSelector:
            matchLabels:
              app: mongodb
      ports:
        - protocol: TCP
          port: 27017

    # Allow traffic to Redis
    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379

    # Allow external API calls
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443

---
apiVersion: v1
kind: LimitRange
metadata:
  name: einvoicehub-limit-range
  namespace: einvoice-dev
spec:
  limits:
    - default:
        cpu: 1000m
        memory: 1Gi
      defaultRequest:
        cpu: 250m
        memory: 256Mi
      type: Container

---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: einvoicehub-resource-quota
  namespace: einvoice-dev
spec:
  hard:
    pods: "20"
    services: "10"
    secrets: "20"
    configmaps: "20"
    persistentvolumeclaims: "10"
    "limits.cpu": "8"
    "limits.memory": "8Gi"

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: einvoicehub
  namespace: einvoice-dev
  labels:
    app: einvoicehub
automountServiceAccountToken: false

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: einvoicehub-role
  namespace: einvoice-dev
  labels:
    app: einvoicehub
rules:
  - apiGroups: [""]
    resources: ["pods", "pods/log"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["pods/exec"]
    verbs: ["create"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: einvoicehub-rolebinding
  namespace: einvoice-dev
  labels:
    app: einvoicehub
subjects:
  - kind: ServiceAccount
    name: einvoicehub
    namespace: einvoice-dev
roleRef:
  kind: Role
  name: einvoicehub-role
  apiGroup: rbac.authorization.k8s.io
</file>

<file path="kubernetes/service.yaml">
# EInvoiceHub Kubernetes Service Manifest

---
apiVersion: v1
kind: Service
metadata:
  name: einvoicehub
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    version: v1
    tier: backend
  annotations:
    description: "EInvoiceHub Backend Service"
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: 8080
      protocol: TCP
    - name: metrics
      port: 9090
      targetPort: 9090
      protocol: TCP
  selector:
    app: einvoicehub
    version: v1

---
apiVersion: v1
kind: Service
metadata:
  name: einvoicehub-mysql
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: database
  annotations:
    description: "MySQL Database Service"
spec:
  type: ClusterIP
  ports:
    - port: 3306
      targetPort: 3306
      protocol: TCP
  selector:
    app: mysql
    tier: database

---
apiVersion: v1
kind: Service
metadata:
  name: einvoicehub-mongodb
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: database
  annotations:
    description: "MongoDB Database Service"
spec:
  type: ClusterIP
  ports:
    - port: 27017
      targetPort: 27017
      protocol: TCP
  selector:
    app: mongodb
    tier: database

---
apiVersion: v1
kind: Service
metadata:
  name: einvoicehub-redis
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: cache
  annotations:
    description: "Redis Cache Service"
spec:
  type: ClusterIP
  ports:
    - port: 6379
      targetPort: 6379
      protocol: TCP
  selector:
    app: redis
    tier: cache

---
apiVersion: v1
kind: Service
metadata:
  name: einvoicehub-prometheus
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: monitoring
  annotations:
    description: "Prometheus Metrics Service"
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 9090
      targetPort: 9090
      protocol: TCP
  selector:
    app: prometheus
    tier: monitoring

---
apiVersion: v1
kind: Service
metadata:
  name: einvoicehub-grafana
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: monitoring
  annotations:
    description: "Grafana Dashboard Service"
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 3000
      targetPort: 3000
      protocol: TCP
  selector:
    app: grafana
    tier: monitoring

---
apiVersion: v1
kind: Service
metadata:
  name: einvoicehub-jaeger
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: tracing
  annotations:
    description: "Jaeger Tracing Service"
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 16686
      targetPort: 16686
      protocol: TCP
    - name: otlp
      port: 4317
      targetPort: 4317
      protocol: TCP
    - name: otlp-http
      port: 4318
      targetPort: 4318
      protocol: TCP
  selector:
    app: jaeger
    tier: tracing

---
apiVersion: v1
kind: Endpoints
metadata:
  name: einvoicehub-headless
  namespace: einvoice-dev
  labels:
    app: einvoicehub
subsets:
  - addresses:
      - ip: 10.0.0.1
        targetRef:
          kind: Pod
          name: einvoicehub-0
          namespace: einvoice-dev
      - ip: 10.0.0.2
        targetRef:
          kind: Pod
          name: einvoicehub-1
          namespace: einvoice-dev
    ports:
      - port: 8080
        protocol: TCP
        name: http
</file>

<file path="monitoring/alertmanager/alertmanager.yml">
# EInvoiceHub Alertmanager Configuration

global:
  resolve_timeout: 5m
  slack_api_url: 'https://hooks.slack.com/services/xxx/yyy/zzz'

# Route defines a routing tree for processing alerts
route:
  group_by: ['alertname', 'severity']
  receiver: 'default-receiver'
  group_interval: 5m
  group_wait: 30s
  repeat_interval: 4h

  # Child routes for specific severities
  routes:
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 1h

    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 1m
      repeat_interval: 6h

    - match:
        alertname: 'HighErrorRate'
      receiver: 'urgent-alerts'
      continue: true

# Receivers define notification destinations
receivers:
  - name: 'default-receiver'
    slack_configs:
      - channel: '#alerts'
        send_resolved: true
        title: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ end }}'
        text: |
          {{ range .Alerts }}
          **{{ .Labels.severity | upper }}** - {{ .Labels.alertname }}
          Description: {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          Start: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        color:
          critical: '#ff0000'
          warning: '#ffa500'
          info: '#00ff00'

  - name: 'critical-alerts'
    slack_configs:
      - channel: '#critical-alerts'
        send_resolved: true
        title: 'üö® CRITICAL ALERT: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        text: |
          {{ range .Alerts }}
          **Severity:** {{ .Labels.severity | upper }}
          **Alert:** {{ .Labels.alertname }}
          **Description:** {{ .Annotations.description }}
          **Namespace:** {{ .Labels.namespace }}
          **Pod:** {{ .Labels.pod }}
          **Value:** {{ .Annotations.current_value }}
          **Started:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  - name: 'warning-alerts'
    slack_configs:
      - channel: '#warning-alerts'
        send_resolved: true
        title: '‚ö†Ô∏è WARNING: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        text: |
          {{ range .Alerts }}
          **Alert:** {{ .Labels.alertname }}
          **Description:** {{ .Annotations.description }}
          **Value:** {{ .Annotations.current_value }}
          {{ end }}

  - name: 'urgent-alerts'
    slack_configs:
      - channel: '#urgent-alerts'
        send_resolved: true
        mention_users: '@oncall'
        title: 'üî• URGENT: High Error Rate Detected'
        text: |
          **Alert:** High Error Rate Detected
          **Error Rate:** {{ range .Alerts }}{{ .Annotations.current_value }}{{ end }}
          **Endpoint:** {{ range .Alerts }}{{ .Annotations.endpoint }}{{ end }}
          **Action Required:** Immediate investigation needed!

  - name: 'pagerduty'
    pagerduty_configs:
      - service_key: 'pagerduty-service-key'
        severity: critical
        description: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        source: 'EInvoiceHub'
        custom_details:
          environment: '{{ env "ENVIRONMENT" }}'
          cluster: '{{ env "CLUSTER_NAME" }}'

  - name: 'email'
    email_configs:
      - to: 'alerts@einvoicehub.io'
        send_resolved: true
        html: |
          <html>
          <body>
          <h2>Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}</h2>
          <p><strong>Severity:</strong> {{ range .Alerts }}{{ .Labels.severity }}{{ end }}</p>
          <p><strong>Description:</strong> {{ range .Alerts }}{{ .Annotations.description }}{{ end }}</p>
          <p><strong>Value:</strong> {{ range .Alerts }}{{ .Annotations.current_value }}{{ end }}</p>
          <p><strong>Started:</strong> {{ range .Alerts }}{{ .StartsAt.Format "2006-01-02 15:04:05" }}{{ end }}</p>
          </body>
          </html>

# Inhibition rules
inhibit_rules:
  # Inhibit warning alerts if the same alert is already firing as critical
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'namespace', 'pod']

  # Inhibit info alerts if warning or critical for same alert
  - source_match:
      severity: 'warning'
    target_match:
      severity: 'info'
    equal: ['alertname', 'namespace']

# Time intervals for notification routing
time_intervals:
  - name: 'business-hours'
    time_intervals:
      - times:
          - start_time: '09:00'
            end_time: '17:00'
        weekdays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday']
        months: ['january', 'february', 'march', 'april', 'may', 'june',
                 'july', 'august', 'september', 'october', 'november', 'december']
        location: 'Asia/Ho_Chi_Minh'

  - name: 'off-hours'
    time_intervals:
      - times:
          - start_time: '17:00'
            end_time: '09:00'
        weekdays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday']
        months: ['january', 'february', 'march', 'april', 'may', 'june',
                 'july', 'august', 'september', 'october', 'november', 'december']
        location: 'Asia/Ho_Chi_Minh'
      - times:
          - start_time: '00:00'
            end_time: '23:59'
        weekdays: ['saturday', 'sunday']
        months: ['january', 'february', 'march', 'april', 'may', 'june',
                 'july', 'august', 'september', 'october', 'november', 'december']
        location: 'Asia/Ho_Chi_Minh'
</file>

<file path="monitoring/grafana/dashboards/einvoicehub/einvoicehub-overview.json">
{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "grafana",
          "uid": "-- Grafana --"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "description": "EInvoiceHub Application Overview Dashboard",
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": null,
  "links": [],
  "liveNow": false,
  "panels": [
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 1,
      "panels": [],
      "title": "Application Overview",
      "type": "row"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 0,
        "y": 1
      },
      "id": 2,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.2.0",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "up{job=\"einvoicehub\", namespace=\"einvoice-dev\"}",
          "refId": "A"
        }
      ],
      "title": "Application Status",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 1
              },
              {
                "color": "red",
                "value": 2
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 6,
        "y": 1
      },
      "id": 3,
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.2.0",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "count(kube_pod_container_status_ready{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"})",
          "refId": "A"
        }
      ],
      "title": "Running Pods",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 70
              },
              {
                "color": "red",
                "value": 90
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 12,
        "y": 1
      },
      "id": 4,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["mean"],
          "fields": "",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.2.0",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "sum(rate(container_cpu_usage_seconds_total{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}[5m])) / sum(kube_pod_container_resource_requests{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\", resource=\"cpu\"}) * 100",
          "refId": "A"
        }
      ],
      "title": "CPU Usage",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 70
              },
              {
                "color": "red",
                "value": 90
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 18,
        "y": 1
      },
      "id": 5,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["mean"],
          "fields": "",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.2.0",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "sum(container_memory_working_set_bytes{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}) / sum(kube_pod_container_resource_requests{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\", resource=\"memory\"}) * 100",
          "refId": "A"
        }
      ],
      "title": "Memory Usage",
      "type": "stat"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 5
      },
      "id": 6,
      "panels": [],
      "title": "HTTP Metrics",
      "type": "row"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "reqps"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 6
      },
      "id": 7,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "sum(rate(http_server_requests_seconds_count{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}[5m])) by (uri, method)",
          "legendFormat": "{{method}} {{uri}}",
          "refId": "A"
        }
      ],
      "title": "Request Rate by URI",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "s"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 6
      },
      "id": 8,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "histogram_quantile(0.50, sum(rate(http_server_requests_seconds_bucket{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}[5m])) by (le, uri))",
          "legendFormat": "p50 - {{uri}}",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "histogram_quantile(0.90, sum(rate(http_server_requests_seconds_bucket{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}[5m])) by (le, uri))",
          "legendFormat": "p90 - {{uri}}",
          "refId": "B"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "histogram_quantile(0.99, sum(rate(http_server_requests_seconds_bucket{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}[5m])) by (le, uri))",
          "legendFormat": "p99 - {{uri}}",
          "refId": "C"
        }
      ],
      "title": "Response Time Percentiles",
      "type": "timeseries"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 14
      },
      "id": 9,
      "panels": [],
      "title": "JVM Metrics",
      "type": "row"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "bytes"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 15
      },
      "id": 10,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "jvm_memory_used_bytes{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\", area=\"heap\"}",
          "legendFormat": "{{pod}} - {{area}}",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "jvm_memory_max_bytes{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\", area=\"heap\"}",
          "legendFormat": "{{pod}} - max {{area}}",
          "refId": "B"
        }
      ],
      "title": "JVM Heap Memory",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 15
      },
      "id": 11,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "jvm_threads_live{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}",
          "legendFormat": "{{pod}} - live threads",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "jvm_threads_daemon{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}",
          "legendFormat": "{{pod}} - daemon threads",
          "refId": "B"
        }
      ],
      "title": "JVM Threads",
      "type": "timeseries"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 23
      },
      "id": 12,
      "panels": [],
      "title": "Database & Cache Metrics",
      "type": "row"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "reqps"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 24
      },
      "id": 13,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "rate(hikaricp_connections_usage_seconds_count{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}[5m])",
          "legendFormat": "{{pod}} - connections",
          "refId": "A"
        }
      ],
      "title": "HikariCP Connection Usage",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "reqps"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 24
      },
      "id": 14,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "redis_keyspace_hits_total / (redis_keyspace_hits_total + redis_keyspace_misses_total)",
          "legendFormat": "hit ratio",
          "refId": "A"
        }
      ],
      "title": "Redis Cache Hit Ratio",
      "type": "timeseries"
    }
  ],
  "refresh": "30s",
  "schemaVersion": 38,
  "style": "dark",
  "tags": ["einvoicehub", "spring-boot", "java", "kubernetes"],
  "templating": {
    "list": []
  },
  "time": {
    "from": "now-1h",
    "to": "now"
  },
  "timepicker": {},
  "timezone": "browser",
  "title": "EInvoiceHub Overview",
  "uid": "einvoicehub-overview",
  "version": 1,
  "weekStart": ""
}
</file>

<file path="monitoring/grafana/provisioning/dashboards/default.yaml">
# EInvoiceHub Grafana Dashboards Configuration

apiVersion: 1

# Dashboard providers
providers:
  - name: 'einvoicehub'
    orgId: 1
    folder: 'EInvoiceHub'
    type: file
    disableDeletion: false
    updateIntervalSeconds: 10
    options:
      path: /var/lib/grafana/dashboards/einvoicehub
      foldersFromFilesStructure: true

  - name: 'kubernetes'
    orgId: 1
    folder: 'Kubernetes'
    type: file
    disableDeletion: false
    updateIntervalSeconds: 10
    options:
      path: /var/lib/grafana/dashboards/kubernetes
      foldersFromFilesStructure: true

  - name: 'infrastructure'
    orgId: 1
    folder: 'Infrastructure'
    type: file
    disableDeletion: false
    updateIntervalSeconds: 10
    options:
      path: /var/lib/grafana/dashboards/infrastructure
      foldersFromFilesStructure: true
</file>

<file path="monitoring/grafana/provisioning/datasources/prometheus.yaml">
# EInvoiceHub Grafana Datasource Configuration

apiVersion: 1

# Delete all datasources before inserting new ones
deleteDatasources:
  - name: Prometheus
    orgId: 1

# Insert/update datasources
datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    orgId: 1
    url: http://prometheus:9090
    isDefault: true
    version: 1
    editable: false
    jsonData:
      httpMethod: GET
      manageAlerts: true
      prometheusType: Prometheus
      prometheusVersion: 2.48.0
      enableLoGS: true
      loGSRequestToken: ''
      loGSStartTimeParam: start
      loGSEndTimeParam: end
      loGSTimeFormat: RFC3339Nano
      loGSTimeZone: UTC
      apiVersion: 1
      cachedResponseTTLMinutes: 60
    secureJsonData:
      httpHeaderValue1: ''
    cacheTimeout: 30

  - name: Loki
    type: loki
    access: proxy
    orgId: 1
    url: http://loki:3100
    isDefault: false
    version: 1
    editable: false
    jsonData:
      maxLines: 5000
      derivedFields:
        - matcherRegex: '(?:apikey|client)[=\\s]+([A-Za-z0-9_=-]+)'
          name: apikey
          datasourceUid:grafana
        - matcherRegex: 'trace_id=([A-Za-z0-9_=-]+)'
          name: trace_id
          datasourceUid: jaeger
    secureJsonData:
      httpHeaderValue1: ''

  - name: Jaeger
    type: jaeger
    access: proxy
    orgId: 1
    url: http://jaeger:16686
    isDefault: false
    version: 1
    editable: false
    jsonData:
      tracesToLogs:
        datasourceUid: Loki
      nodeGraph:
        enabled: true
    secureJsonData: {}

  - name: Elasticsearch
    type: elasticsearch
    access: proxy
    orgId: 1
    url: http://elasticsearch:9200
    isDefault: false
    version: 1
    editable: false
    jsonData:
      interval: Daily
      timeField: '@timestamp'
      logMessageField: message
      logLevelField: level
      database: 'einvoicehub-logs'
    secureJsonData:
      basicAuthPassword: ''

  - name: MySQL
    type: mysql
    access: proxy
    orgId: 1
    url: mysql:3306/einvoicehub
    isDefault: false
    version: 1
    editable: false
    jsonData:
      database: einvoicehub
      user: grafana
    secureJsonData:
      basicAuthPassword: ''
</file>

<file path="monitoring/prometheus/prometheus.yml">
# EInvoiceHub Prometheus Configuration
global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'einvoice-cluster'
    environment: 'dev'

# Alertmanager configuration (optional)
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  - '/etc/prometheus/rules/*.yml'

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
    # Prometheus Self-Monitoring

  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # =====================================================================
  # EInvoiceHub Application Metrics
  # =====================================================================
  - job_name: 'einvoicehub'
    kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
            - einvoice-dev
            - einvoice-staging
            - einvoice-prod
    relabel_configs:
      # Only scrape pods with the prometheus.io/scrape annotation
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true

      # Use the prometheus.io/path annotation to scrape a specific path
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)

      # Use the prometheus.io/port annotation to scrape a specific port
      - source_labels: [
          __address__,
          __meta_kubernetes_pod_annotation_prometheus_io_port
        ]
        action: replace
        regex: ([^:]+)(?::\\d+)?;(\\d+)
        replacement: $1:$2
        target_label: __address__

      # Add environment label
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: namespace

      # Add pod name label
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: pod

      # Add app name label
      - source_labels: [__meta_kubernetes_pod_label_app]
        action: replace
        target_label: app

  # =====================================================================
  # Kubernetes Node Exporter (infrastructure metrics)
  # =====================================================================
  - job_name: 'node-exporter'
    kubernetes_sd_configs:
      - role: node
    relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)

  # =====================================================================
  # MySQL Exporter (database metrics)
  # =====================================================================
  - job_name: 'mysql-exporter'
    static_configs:
      - targets: ['mysql-exporter:9104']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'mysql-primary'

  # =====================================================================
  # MongoDB Exporter (database metrics)
  # =====================================================================
  - job_name: 'mongodb-exporter'
    static_configs:
      - targets: ['mongodb-exporter:9216']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'mongodb-primary'

  # =====================================================================
  # Redis Exporter (cache metrics)
  # =====================================================================
  - job_name: 'redis-exporter'
    static_configs:
      - targets: ['redis-exporter:9121']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'redis-primary'

  # =====================================================================
  # Spring Boot Actuator Metrics (via HTTP)
  # =====================================================================
  - job_name: 'spring-actuator'
    metrics_path: '/actuator/prometheus'
    scrape_interval: 5s
    static_configs:
      - targets: ['einvoicehub:8080']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'einvoicehub-backend'

# Remote write configuration (for long-term storage)
remote_write:
  - url: 'https://prometheus-remote-write.einvoicehub.io/api/v1/write'
    basic_auth:
      username: 'prometheus'
      password_file: '/etc/prometheus/remote_write_password'
    queue_config:
      max_samples_per_send: 10000
      batch_send_deadline: 30s
      capacity: 20000
      max_shards: 30
    tls_config:
      insecure_skip_verify: false
</file>

<file path="src/main/java/com/einvoicehub/core/common/exception/AppException.java">
package com.einvoicehub.core.common.exception;

import lombok.Getter;
import java.util.Collections;
import java.util.Map;

@Getter
public class AppException extends RuntimeException {

    private final ErrorCode errorCode;
    private final Map<String, Object> details;

    public AppException(ErrorCode errorCode) {
        this(errorCode, errorCode.getMessage(), Collections.emptyMap());
    }

    public AppException(ErrorCode errorCode, String customMessage) {
        this(errorCode, customMessage, Collections.emptyMap());
    }

    public AppException(ErrorCode errorCode, Map<String, Object> details) {
        this(errorCode, errorCode.getMessage(), details);
    }

    public AppException(ErrorCode errorCode, String customMessage, Map<String, Object> details) {
        super(customMessage);
        this.errorCode = errorCode;
        this.details = details != null ? details : Collections.emptyMap();
    }

    /* Exception chaining support */
    public AppException(ErrorCode errorCode, Throwable cause) {
        super(errorCode.getMessage(), cause);
        this.errorCode = errorCode;
        this.details = Collections.emptyMap();
    }

    @Override
    public String toString() {
        return String.format("AppException[errorCode=%s, code=%d, message='%s']",
                errorCode.name(), errorCode.getCode(), getMessage());
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/common/exception/ErrorCode.java">
package com.einvoicehub.core.common.exception;

import com.fasterxml.jackson.annotation.JsonValue;
import lombok.Getter;
import org.springframework.http.HttpStatus;

import java.util.Map;
import java.util.Optional;
import java.util.function.Function;
import java.util.stream.Collectors;
import java.util.stream.Stream;

@Getter
public enum ErrorCode {
    SUCCESS(1000, "Success", HttpStatus.OK),
    UNCATEGORIZED_EXCEPTION(9999, "Uncategorized system error", HttpStatus.INTERNAL_SERVER_ERROR),
    MERCHANT_NOT_FOUND(1001, "Merchant not found", HttpStatus.NOT_FOUND),
    INSUFFICIENT_QUOTA(1002, "Merchant has exceeded invoice quota", HttpStatus.FORBIDDEN),
    VALIDATION_ERROR(1003, "Invalid input data", HttpStatus.BAD_REQUEST),
    PROVIDER_ERROR(1004, "Service provider error", HttpStatus.BAD_GATEWAY),
    API_KEY_INVALID(1005, "Invalid or expired API Key", HttpStatus.UNAUTHORIZED),
    UNAUTHORIZED(403, "Access denied", HttpStatus.FORBIDDEN),
    UNAUTHENTICATED(401, "Authentication failed", HttpStatus.UNAUTHORIZED);

    private static final Map<Integer, ErrorCode> CACHE = Stream.of(values())
            .collect(Collectors.toMap(ErrorCode::getCode, Function.identity()));

    @JsonValue
    private final int code;
    private final String message;
    private final HttpStatus statusCode;

    ErrorCode(int code, String message, HttpStatus statusCode) {
        this.code = code;
        this.message = message;
        this.statusCode = statusCode;
    }

    public static Optional<ErrorCode> findByCode(int code) {
        return Optional.ofNullable(CACHE.get(code));
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/common/exception/GlobalExceptionHandler.java">
package com.einvoicehub.core.common.exception;

import com.einvoicehub.core.dto.response.ApiResponse;
import com.einvoicehub.core.provider.exception.ProviderException;
import jakarta.validation.ConstraintViolationException;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.ResponseEntity;
import org.springframework.http.converter.HttpMessageNotReadableException;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.web.HttpRequestMethodNotSupportedException;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.web.method.annotation.MethodArgumentTypeMismatchException;
import org.springframework.web.servlet.NoHandlerFoundException;

import java.util.LinkedHashMap;
import java.util.Map;

@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(AppException.class)
    public ResponseEntity<ApiResponse<?>> handleAppException(AppException ex) {
        log.warn("Business Exception: [{}] - {}", ex.getErrorCode().getCode(), ex.getMessage());
        return buildResponse(ex.getErrorCode(), ex.getMessage(), null);
    }

    @ExceptionHandler(ProviderException.class)
    public ResponseEntity<ApiResponse<?>> handleProviderException(ProviderException ex) {
        log.error("Provider Error [{}]: {} - Status: {}", ex.getProviderCode(), ex.getMessage(), ex.getStatusCode());

        ApiResponse<Map<String, Object>> response = ApiResponse.<Map<String, Object>>builder()
                .code(ErrorCode.PROVIDER_ERROR)
                .message(ex.getMessage())
                .result(ex.getDetails())
                .build();
        return ResponseEntity.status(ex.getStatusCode()).body(response);
    }

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ApiResponse<?>> handleValidation(MethodArgumentNotValidException ex) {
        Map<String, String> errors = new LinkedHashMap<>();
        ex.getBindingResult().getFieldErrors().forEach(error ->
                errors.put(error.getField(), error.getDefaultMessage())
        );

        ErrorCode errorCode = ErrorCode.VALIDATION_ERROR;
        try {
            String firstMsg = ex.getBindingResult().getFieldError().getDefaultMessage();
            if (firstMsg != null) errorCode = ErrorCode.valueOf(firstMsg);
        } catch (Exception ignored) {}

        log.warn("Validation Failed: {}", errors);
        return buildResponse(errorCode, errorCode.getMessage(), errors);
    }

    @ExceptionHandler(ConstraintViolationException.class)
    public ResponseEntity<ApiResponse<?>> handleConstraintViolation(ConstraintViolationException ex) {
        return buildResponse(ErrorCode.VALIDATION_ERROR, "Invalid parameter: " + ex.getMessage(), null);
    }

    @ExceptionHandler(AccessDeniedException.class)
    public ResponseEntity<ApiResponse<?>> handleAccessDenied(AccessDeniedException ex) {
        return buildResponse(ErrorCode.UNAUTHORIZED, "Access denied", null);
    }

    @ExceptionHandler(HttpMessageNotReadableException.class)
    public ResponseEntity<ApiResponse<?>> handleInvalidJson(HttpMessageNotReadableException ex) {
        return buildResponse(ErrorCode.VALIDATION_ERROR, "Invalid JSON format", null);
    }

    @ExceptionHandler(MethodArgumentTypeMismatchException.class)
    public ResponseEntity<ApiResponse<?>> handleTypeMismatch(MethodArgumentTypeMismatchException ex) {
        String msg = String.format("Parameter '%s' has an invalid data type", ex.getName());
        return buildResponse(ErrorCode.VALIDATION_ERROR, msg, null);
    }

    @ExceptionHandler(NoHandlerFoundException.class)
    public ResponseEntity<ApiResponse<?>> handleNotFound(NoHandlerFoundException ex) {
        return buildResponse(ErrorCode.VALIDATION_ERROR, "API endpoint not found: " + ex.getRequestURL(), null);
    }

    @ExceptionHandler(HttpRequestMethodNotSupportedException.class)
    public ResponseEntity<ApiResponse<?>> handleMethodNotAllowed(HttpRequestMethodNotSupportedException ex) {
        return buildResponse(ErrorCode.VALIDATION_ERROR, "HTTP method not supported", null);
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<ApiResponse<?>> handleGenericException(Exception ex) {
        log.error("CRITICAL SYSTEM ERROR: ", ex);
        return buildResponse(ErrorCode.UNCATEGORIZED_EXCEPTION, ErrorCode.UNCATEGORIZED_EXCEPTION.getMessage(), null);
    }

    private ResponseEntity<ApiResponse<?>> buildResponse(ErrorCode errorCode, String message, Object result) {
        ApiResponse<?> response = ApiResponse.builder()
                .code(errorCode)
                .message(message)
                .result(result)
                .build();
        return ResponseEntity.status(errorCode.getStatusCode()).body(response);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/common/exception/InsufficientQuotaException.java">
package com.einvoicehub.core.common.exception;

import lombok.Getter;
import org.springframework.http.HttpStatus;

/**
 * Exception khi v∆∞·ª£t h·∫°n m·ª©c h√≥a ƒë∆°n.
 */
@Getter
public class InsufficientQuotaException extends AppException {
    private final String errorCode = "QUOTA_EXCEEDED";
    private final HttpStatus status = HttpStatus.FORBIDDEN;

    public InsufficientQuotaException(String message) {
        super(ErrorCode.INSUFFICIENT_QUOTA);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/common/exception/MerchantNotFoundException.java">
package com.einvoicehub.core.common.exception;

import lombok.Getter;
import org.springframework.http.HttpStatus;

/**
 * Exception khi kh√¥ng t√¨m th·∫•y Merchant.
 */
@Getter
public class MerchantNotFoundException extends AppException {
    private final String errorCode = "MERCHANT_NOT_FOUND";
    private final HttpStatus status = HttpStatus.NOT_FOUND;

    public MerchantNotFoundException(String merchantCode) {
        super(ErrorCode.MERCHANT_NOT_FOUND);     }
}
</file>

<file path="src/main/java/com/einvoicehub/core/config/SecurityConfig.java">
package com.einvoicehub.core.config;

import com.einvoicehub.core.security.ApiKeyFilter;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfig {

    private final ApiKeyFilter apiKeyFilter;

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
                .csrf(AbstractHttpConfigurer::disable)
                .sessionManagement(session ->
                        session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers(
                                "/api/actuator/**",
                                "/api/v3/api-docs/**",
                                "/api/swagger-ui/**",
                                "/api/health/**"
                        ).permitAll()
                        .anyRequest().authenticated())
                .addFilterBefore(apiKeyFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/config/VirtualThreadConfig.java">
package com.einvoicehub.core.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

@Configuration
public class VirtualThreadConfig {

    /* Use Java 21 Virtual Threads to handle high-concurrency Provider API calls efficiently */
    @Bean
    public ExecutorService virtualThreadExecutorService() {
        return Executors.newVirtualThreadPerTaskExecutor();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/config/WebClientConfig.java">
package com.einvoicehub.core.config;

import io.netty.channel.ChannelOption;
import io.netty.handler.timeout.ReadTimeoutHandler;
import io.netty.handler.timeout.WriteTimeoutHandler;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.http.client.reactive.ReactorClientHttpConnector;
import org.springframework.web.reactive.function.client.ExchangeStrategies;
import org.springframework.web.reactive.function.client.WebClient;
import reactor.netty.http.client.HttpClient;

import java.time.Duration;
import java.util.concurrent.TimeUnit;

@Configuration
public class WebClientConfig {

    @Value("${app.provider.timeout-ms:30000}")
    private int defaultTimeout;

    @Value("${provider.vnpt.timeout-ms:30000}")
    private int vnptTimeout;

    @Value("${provider.viettel.timeout-ms:30000}")
    private int viettelTimeout;

    @Value("${provider.bkav.timeout-ms:30000}")
    private int bkavTimeout;

    @Value("${provider.misa.timeout-ms:30000}")
    private int misaTimeout;

    @Bean
    @Primary
    public WebClient.Builder webClientBuilder() {
        /* Increase memory buffer to 16MB for large XML/PDF invoice processing */
        ExchangeStrategies strategies = ExchangeStrategies.builder()
                .codecs(configurer -> configurer.defaultCodecs().maxInMemorySize(16 * 1024 * 1024))
                .build();

        return WebClient.builder()
                .exchangeStrategies(strategies)
                .clientConnector(new ReactorClientHttpConnector(createHttpClient(defaultTimeout, defaultTimeout * 2)));
    }

    @Bean(name = "vnptWebClient")
    public WebClient vnptWebClient(WebClient.Builder builder, @Value("${provider.vnpt.base-url:}") String url) {
        return createWebClient(builder, url, vnptTimeout);
    }

    @Bean(name = "viettelWebClient")
    public WebClient viettelWebClient(WebClient.Builder builder, @Value("${provider.viettel.base-url:}") String url) {
        return createWebClient(builder, url, viettelTimeout);
    }

    @Bean(name = "bkavWebClient")
    public WebClient bkavWebClient(WebClient.Builder builder, @Value("${provider.bkav.base-url:}") String url) {
        return createWebClient(builder, url, bkavTimeout);
    }

    @Bean(name = "misaWebClient")
    public WebClient misaWebClient(WebClient.Builder builder, @Value("${provider.misa.base-url:}") String url) {
        return createWebClient(builder, url, misaTimeout);
    }

    private WebClient createWebClient(WebClient.Builder builder, String baseUrl, int timeout) {
        return builder.clone()
                .baseUrl(baseUrl)
                .clientConnector(new ReactorClientHttpConnector(createHttpClient(timeout, timeout * 2)))
                .build();
    }

    private HttpClient createHttpClient(int connectTimeout, int readWriteTimeout) {
        return HttpClient.create()
                .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, connectTimeout)
                .responseTimeout(Duration.ofMillis(readWriteTimeout))
                .doOnConnected(conn -> conn
                        .addHandlerLast(new ReadTimeoutHandler(readWriteTimeout, TimeUnit.MILLISECONDS))
                        .addHandlerLast(new WriteTimeoutHandler(readWriteTimeout, TimeUnit.MILLISECONDS)));
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/converter/EncryptionConverter.java">
package com.einvoicehub.core.converter;

import jakarta.persistence.AttributeConverter;
import jakarta.persistence.Converter;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import javax.crypto.Cipher;
import javax.crypto.spec.GCMParameterSpec;
import javax.crypto.spec.SecretKeySpec;
import java.nio.ByteBuffer;
import java.nio.charset.StandardCharsets;
import java.security.SecureRandom;
import java.util.Base64;

@Converter
@Component
public class EncryptionConverter implements AttributeConverter<String, String> {

    private static final String ALGORITHM = "AES/GCM/NoPadding";
    private static final int IV_LENGTH = 12;
    private static final int TAG_LENGTH = 128;

    @Value("${app.security.encryption.key}")
    private String secretKey;

    private SecretKeySpec getSecretKey() {
        byte[] keyBytes = secretKey.getBytes(StandardCharsets.UTF_8);
        byte[] adjustedKey = new byte[32];
        System.arraycopy(keyBytes, 0, adjustedKey, 0, Math.min(keyBytes.length, 32));
        return new SecretKeySpec(adjustedKey, "AES");
    }

    @Override
    public String convertToDatabaseColumn(String attribute) {
        if (attribute == null || attribute.isEmpty()) return null;
        try {
            Cipher cipher = Cipher.getInstance(ALGORITHM);
            byte[] iv = new byte[IV_LENGTH];
            new SecureRandom().nextBytes(iv);

            cipher.init(Cipher.ENCRYPT_MODE, getSecretKey(), new GCMParameterSpec(TAG_LENGTH, iv));
            byte[] encrypted = cipher.doFinal(attribute.getBytes(StandardCharsets.UTF_8));

            ByteBuffer buffer = ByteBuffer.allocate(iv.length + encrypted.length);
            buffer.put(iv).put(encrypted);
            return Base64.getEncoder().encodeToString(buffer.array());
        } catch (Exception e) {
            throw new IllegalStateException("Encryption failure: " + e.getMessage());
        }
    }

    @Override
    public String convertToEntityAttribute(String dbData) {
        if (dbData == null || dbData.isEmpty()) return null;
        try {
            byte[] decoded = Base64.getDecoder().decode(dbData);
            ByteBuffer buffer = ByteBuffer.wrap(decoded);

            byte[] iv = new byte[IV_LENGTH];
            buffer.get(iv);
            byte[] encrypted = new byte[buffer.remaining()];
            buffer.get(encrypted);

            Cipher cipher = Cipher.getInstance(ALGORITHM);
            cipher.init(Cipher.DECRYPT_MODE, getSecretKey(), new GCMParameterSpec(TAG_LENGTH, iv));
            return new String(cipher.doFinal(encrypted), StandardCharsets.UTF_8);
        } catch (Exception e) {
            throw new IllegalStateException("Decryption failure: " + e.getMessage());
        }
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/converter/JsonAttributeConverter.java">
package com.einvoicehub.core.converter;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import jakarta.persistence.AttributeConverter;
import jakarta.persistence.Converter;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.Map;

@Converter
@Component
public class JsonAttributeConverter implements AttributeConverter<Object, String> {

    private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();

    @Override
    public String convertToDatabaseColumn(Object attribute) {
        if (attribute == null) return null;
        try {
            return OBJECT_MAPPER.writeValueAsString(attribute);
        } catch (JsonProcessingException e) {
            throw new IllegalArgumentException("JSON serialization error: " + e.getMessage());
        }
    }

    @Override
    public Object convertToEntityAttribute(String dbData) {
        if (dbData == null || dbData.isEmpty()) return null;
        try {
            return OBJECT_MAPPER.readValue(dbData, Object.class);
        } catch (JsonProcessingException e) {
            throw new IllegalArgumentException("JSON deserialization error: " + e.getMessage());
        }
    }

    public static List<String> fromJsonToList(String json) {
        if (json == null || json.isEmpty()) return List.of();
        try {
            return OBJECT_MAPPER.readValue(json, new TypeReference<List<String>>() {});
        } catch (JsonProcessingException e) {
            throw new IllegalArgumentException("JSON to List conversion error");
        }
    }

    public static Map<String, Object> fromJsonToMap(String json) {
        if (json == null || json.isEmpty()) return Map.of();
        try {
            return OBJECT_MAPPER.readValue(json, new TypeReference<Map<String, Object>>() {});
        } catch (JsonProcessingException e) {
            throw new IllegalArgumentException("JSON to Map conversion error");
        }
    }

    public static String toJson(Object obj) {
        if (obj == null) return null;
        try {
            return OBJECT_MAPPER.writeValueAsString(obj);
        } catch (JsonProcessingException e) {
            throw new IllegalArgumentException("Object to JSON conversion error");
        }
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/request/InvoiceItemRequest.java">
package com.einvoicehub.core.dto.request;

import jakarta.validation.constraints.*;
import lombok.*;

import java.math.BigDecimal;
import java.math.RoundingMode;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class InvoiceItemRequest {

    @NotBlank(message = "VALIDATION_ERROR")
    @Size(max = 500, message = "VALIDATION_ERROR")
    private String itemName;

    @Size(max = 100, message = "VALIDATION_ERROR")
    private String itemCode;

    @NotBlank(message = "VALIDATION_ERROR")
    @Size(max = 50, message = "VALIDATION_ERROR")
    private String unitName;

    @NotNull(message = "VALIDATION_ERROR")
    @DecimalMin(value = "0.000001", message = "VALIDATION_ERROR")
    private BigDecimal quantity;

    @NotNull(message = "VALIDATION_ERROR")
    @DecimalMin(value = "0.0", message = "VALIDATION_ERROR")
    private BigDecimal unitPrice;

    private BigDecimal amount;

    @Builder.Default
    private BigDecimal discountAmount = BigDecimal.ZERO;

    @NotNull(message = "VALIDATION_ERROR")
    @DecimalMin(value = "0.0", message = "VALIDATION_ERROR")
    private BigDecimal taxRate;

    private BigDecimal taxAmount;
    private BigDecimal totalAmountWithVat;
    private String description;
    private String taxCategoryCode;

    /* Normalize financial data to ensure 100% precision before provider submission */
    public void normalizeData() {
        if (quantity != null && unitPrice != null) {
            this.amount = quantity.multiply(unitPrice).setScale(2, RoundingMode.HALF_UP);
        }

        if (amount != null && taxRate != null) {
            BigDecimal baseAmount = amount.subtract(discountAmount != null ? discountAmount : BigDecimal.ZERO);
            this.taxAmount = baseAmount.multiply(taxRate)
                    .divide(BigDecimal.valueOf(100), 2, RoundingMode.HALF_UP);
        }

        if (amount != null && taxAmount != null) {
            BigDecimal netAmount = amount.subtract(discountAmount != null ? discountAmount : BigDecimal.ZERO);
            this.totalAmountWithVat = netAmount.add(taxAmount).setScale(2, RoundingMode.HALF_UP);
        }
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/request/InvoiceRequest.java">
package com.einvoicehub.core.dto.request;

import jakarta.validation.Valid;
import jakarta.validation.constraints.*;
import lombok.*;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class InvoiceRequest {

    @NotBlank(message = "MERCHANT_NOT_FOUND")
    private String merchantId;

    @NotBlank(message = "VALIDATION_ERROR")
    @Pattern(regexp = "^(?i)(VNPT|MISA|BKAV|VIETTEL)$", message = "VALIDATION_ERROR")
    private String providerCode;

    @NotBlank(message = "VALIDATION_ERROR")
    private String invoiceType;

    @NotNull(message = "VALIDATION_ERROR")
    private LocalDateTime invoiceDate;

    @NotBlank(message = "VALIDATION_ERROR")
    @Builder.Default
    private String currency = "VND";

    @Builder.Default
    private String exchangeRate = "1";

    /* Seller Info */
    @NotBlank(message = "VALIDATION_ERROR")
    private String sellerName;

    @NotBlank(message = "VALIDATION_ERROR")
    @Pattern(regexp = "^\\d{10,13}$", message = "VALIDATION_ERROR")
    private String sellerTaxCode;

    @Size(max = 500, message = "VALIDATION_ERROR")
    private String sellerAddress;

    private String sellerPhone;
    private String sellerEmail;

    /* Buyer Info */
    @NotBlank(message = "VALIDATION_ERROR")
    private String buyerName;

    @Pattern(regexp = "^(\\d{10,13})?$", message = "VALIDATION_ERROR")
    private String buyerTaxCode;

    private String buyerAddress;
    private String buyerPhone;
    private String buyerEmail;

    /* Totals & Payment */
    @NotNull(message = "VALIDATION_ERROR")
    private PaymentMethod paymentMethod;

    @NotNull(message = "VALIDATION_ERROR")
    @DecimalMin(value = "0.0", message = "VALIDATION_ERROR")
    private BigDecimal totalAmount;

    @NotNull(message = "VALIDATION_ERROR")
    @DecimalMin(value = "0.0", message = "VALIDATION_ERROR")
    private BigDecimal totalTaxAmount;

    @NotNull(message = "VALIDATION_ERROR")
    @DecimalMin(value = "0.0", message = "VALIDATION_ERROR")
    private BigDecimal grandTotalAmount;

    @NotEmpty(message = "VALIDATION_ERROR")
    @Valid
    private List<InvoiceItemRequest> items;

    @NotBlank(message = "VALIDATION_ERROR")
    private String internalReferenceCode;

    private String invoiceNote;
    private String customerCode;
    private String orderNumber;

    public enum PaymentMethod {
        CASH, BANK_TRANSFER, CREDIT_CARD, E_WALLET, OTHER
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/response/ApiResponse.java">
package com.einvoicehub.core.dto.response;

import com.einvoicehub.core.common.exception.ErrorCode;
import com.fasterxml.jackson.annotation.JsonInclude;
import lombok.*;

import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@JsonInclude(JsonInclude.Include.NON_NULL)
public class ApiResponse<T> {

    private ErrorCode code;
    private String message;
    private T result;

    @Builder.Default
    private LocalDateTime timestamp = LocalDateTime.now();

    public static <T> ApiResponse<T> success(T data) {
        return ApiResponse.<T>builder()
                .code(ErrorCode.SUCCESS)
                .message(ErrorCode.SUCCESS.getMessage())
                .result(data)
                .build();
    }

    public static <T> ApiResponse<T> success(T data, String message) {
        return ApiResponse.<T>builder()
                .code(ErrorCode.SUCCESS)
                .message(message)
                .result(data)
                .build();
    }

    public static <T> ApiResponse<T> error(ErrorCode errorCode) {
        return ApiResponse.<T>builder()
                .code(errorCode)
                .message(errorCode.getMessage())
                .build();
    }

    public static <T> ApiResponse<T> error(ErrorCode errorCode, String customMessage) {
        return ApiResponse.<T>builder()
                .code(errorCode)
                .message(customMessage)
                .build();
    }

    /* Standard check for response status */
    public boolean isSuccess() {
        return this.code == ErrorCode.SUCCESS;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/response/InvoiceResponse.java">
package com.einvoicehub.core.dto.response;

import lombok.*;

import java.math.BigDecimal;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class InvoiceResponse {
    private boolean success;
    private String errorCode;
    private String message;
    private String cqtCode;
    private String providerCode;
    private String transactionId;
    private String clientRequestId;
    private String invoiceNumber;
    private String invoiceCode;
    private String invoiceSerial;

    private String status;
    private String statusDescription;

    private LocalDateTime issuedDate;
    private LocalDateTime signedDate;

    private BigDecimal totalAmount;
    private BigDecimal totalTaxAmount;
    private BigDecimal grandTotalAmount;
    private String currency;

    private String buyerName;
    private String buyerTaxCode;
    private String sellerName;
    private String sellerTaxCode;

    private String pdfDownloadUrl;
    private String xmlDownloadUrl;

    private String rawResponse;
    private String providerMessage;
}
</file>

<file path="src/main/java/com/einvoicehub/core/entity/enums/EntityStatus.java">
package com.einvoicehub.core.entity.enums;

import lombok.Getter;
import lombok.RequiredArgsConstructor;

@Getter
@RequiredArgsConstructor
public enum EntityStatus {
    ACTIVE("Active"),
    INACTIVE("Inactive"),
    SUSPENDED("Suspended");

    private final String description;
}
</file>

<file path="src/main/java/com/einvoicehub/core/entity/enums/InvoiceStatus.java">
package com.einvoicehub.core.entity.enums;

import lombok.Getter;
import lombok.RequiredArgsConstructor;

@Getter
@RequiredArgsConstructor
public enum InvoiceStatus {
    DRAFT("Draft", "Invoice is being drafted"),
    PENDING("Pending", "Request received, awaiting processing"),
    SIGNING("Signing", "Digital signature in progress"),
    SENT_TO_PROVIDER("Sent to Provider", "Forwarded to the service provider"),
    SUCCESS("Success", "Invoice issued successfully"),
    FAILED("Failed", "An error occurred during processing"),
    CANCELLED("Cancelled", "Invoice has been voided"),
    REPLACED("Replaced", "Invoice has been replaced by another");

    private final String displayName;
    private final String description;

    /* Terminal states where no further processing is expected */
    public boolean isTerminal() {
        return this == SUCCESS || this == FAILED || this == CANCELLED || this == REPLACED;
    }

    public boolean isError() {
        return this == FAILED || this == CANCELLED;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/entity/enums/SubscriptionPlan.java">
package com.einvoicehub.core.entity.enums;

import lombok.Getter;
import lombok.RequiredArgsConstructor;

@Getter
@RequiredArgsConstructor
public enum SubscriptionPlan {
    TRIAL("Trial", 100),
    BASIC("Basic", 1000),
    PREMIUM("Premium", 10000),
    ENTERPRISE("Enterprise", -1); // -1 indicates unlimited quota

    private final String displayName;
    private final int defaultQuota;

    public boolean isUnlimited() {
        return defaultQuota == -1;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/entity/enums/UserRole.java">
package com.einvoicehub.core.entity.enums;

import lombok.Getter;
import lombok.RequiredArgsConstructor;

@Getter
@RequiredArgsConstructor
public enum UserRole {
        ADMIN("Administrator", "Full access to merchant account"),
        MANAGER("Manager", "Manage invoices and view reports"),
        STAFF("Staff", "Create and view invoices"),
        VIEWER("Viewer", "Read-only access");

        private final String displayName;
        private final String description;

        public boolean canManageUsers() {
                return this == ADMIN;
        }

        public boolean canCreateInvoice() {
                return this == ADMIN || this == MANAGER || this == STAFF;
        }

        public boolean canViewReports() {
                return this == ADMIN || this == MANAGER || this == VIEWER;
        }
}
</file>

<file path="src/main/java/com/einvoicehub/core/entity/jpa/ApiCredential.java">
package com.einvoicehub.core.entity.jpa;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "api_credentials")
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@ToString(exclude = "merchant")
@EqualsAndHashCode(of = "id")
public class ApiCredential {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "merchant_id", nullable = false)
    private Merchant merchant;

    @Column(name = "client_id", nullable = false, unique = true, length = 50)
    private String clientId;

    @Column(name = "api_key_hash", nullable = false)
    private String apiKeyHash;

    @Column(name = "api_key_prefix", nullable = false, length = 8)
    private String apiKeyPrefix;

    @Column(nullable = false, columnDefinition = "TEXT")
    private String scopes;

    @Column(name = "ip_whitelist", columnDefinition = "TEXT")
    private String ipWhitelist;

    @Builder.Default
    private Integer rateLimitPerHour = 1000;

    @Builder.Default
    private Integer rateLimitPerDay = 10000;

    @Builder.Default
    private Integer requestCountHour = 0;

    @Builder.Default
    private Integer requestCountDay = 0;

    private LocalDateTime requestCountResettedAt;
    private LocalDateTime expiredAt;
    private LocalDateTime lastUsedAt;

    @Builder.Default
    private Boolean isActive = true;

    @Column(updatable = false)
    @Builder.Default
    private LocalDateTime createdAt = LocalDateTime.now();

    @Builder.Default
    private LocalDateTime updatedAt = LocalDateTime.now();

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }

    /* Business Logic */

    public boolean isValid() {
        boolean isExpired = expiredAt != null && expiredAt.isBefore(LocalDateTime.now());
        return isActive && !isExpired;
    }

    public boolean hasScope(String requiredScope) {
        if (scopes == null || scopes.isEmpty()) return false;
        return scopes.contains(requiredScope) || scopes.contains("*");
    }

    public boolean canMakeRequest() {
        return isValid() && requestCountHour < rateLimitPerHour && requestCountDay < rateLimitPerDay;
    }

    public void incrementRequestCount() {
        this.requestCountHour++;
        this.requestCountDay++;
        this.lastUsedAt = LocalDateTime.now();
    }

    public void resetLimits(boolean daily) {
        this.requestCountHour = 0;
        if (daily) this.requestCountDay = 0;
        this.requestCountResettedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/entity/jpa/InvoiceItem.java">
package com.einvoicehub.core.entity.jpa;

import jakarta.persistence.*;
import lombok.*;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.jpa.domain.support.AuditingEntityListener;

import java.math.BigDecimal;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoice_items")
@EntityListeners(AuditingEntityListener.class)
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class InvoiceItem {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "invoice_payload_id", nullable = false)
    private Long invoicePayloadId;

    @Column(name = "line_number", nullable = false)
    private Integer lineNumber;

    @Column(name = "item_code", length = 50)
    private String itemCode;

    @Column(name = "item_name", nullable = false, length = 500)
    private String itemName;

    @Column(name = "unit_name", length = 50)
    private String unitName;

    @Column(name = "quantity", nullable = false, precision = 18, scale = 4)
    private BigDecimal quantity;

    @Column(name = "unit_price", nullable = false, precision = 18, scale = 4)
    private BigDecimal unitPrice;

    @Column(name = "amount", nullable = false, precision = 18, scale = 2)
    private BigDecimal amount;

    @Column(name = "discount_amount", precision = 18, scale = 2)
    @Builder.Default
    private BigDecimal discountAmount = BigDecimal.ZERO;

    @Column(name = "discount_percent", precision = 5, scale = 2)
    @Builder.Default
    private BigDecimal discountPercent = BigDecimal.ZERO;

    @Column(name = "vat_rate", nullable = false, precision = 5, scale = 2)
    private BigDecimal vatRate;

    @Column(name = "vat_amount", nullable = false, precision = 18, scale = 2)
    private BigDecimal vatAmount;

    @Column(name = "total_amount", nullable = false, precision = 18, scale = 2)
    private BigDecimal totalAmount;

    @Column(name = "tax_category", length = 10)
    private String taxCategory;

    @Column(name = "description", columnDefinition = "TEXT")
    private String description;

    @Column(name = "product_code", length = 50)
    private String productCode;

    @Column(name = "product_type", length = 20)
    private String productType;

    @Column(name = "item_note", columnDefinition = "TEXT")
    private String itemNote;

    @CreatedDate
    @Column(name = "created_at", nullable = false, updatable = false)
    @Builder.Default
    private LocalDateTime createdAt = LocalDateTime.now();
}
</file>

<file path="src/main/java/com/einvoicehub/core/entity/jpa/InvoiceMetadata.java">
package com.einvoicehub.core.entity.jpa;

import com.einvoicehub.core.entity.enums.InvoiceStatus;
import jakarta.persistence.*;
import lombok.*;
import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoices_metadata")
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@ToString(exclude = {"merchant", "provider", "providerConfig"})
public class InvoiceMetadata {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "merchant_id", nullable = false)
    private Merchant merchant;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "provider_id")
    private ServiceProvider provider;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "provider_config_id")
    private MerchantProviderConfig providerConfig;

    @Column(name = "cqt_code")
    private String cqtCode; // M√£ c∆° quan thu·∫ø c·∫•p

    private String clientRequestId;
    private String providerCode;
    private String invoiceNumber;
    private String symbolCode;
    private String invoiceTypeCode;
    private String templateCode;

    private String sellerName;
    private String sellerTaxCode;
    @Column(columnDefinition = "TEXT")
    private String sellerAddress;

    private String buyerName;
    private String buyerTaxCode;
    private String buyerEmail;
    private String buyerPhone;
    @Column(columnDefinition = "TEXT")
    private String buyerAddress;

    @Builder.Default
    private BigDecimal subtotalAmount = BigDecimal.ZERO;
    @Builder.Default
    private BigDecimal taxAmount = BigDecimal.ZERO;
    @Builder.Default
    private BigDecimal totalAmount = BigDecimal.ZERO;

    @Builder.Default
    private String currencyCode = "VND";

    private LocalDate issueDate;
    private LocalDateTime signedAt;
    private LocalDateTime sentToProviderAt;

    @Enumerated(EnumType.STRING)
    @Builder.Default
    private InvoiceStatus status = InvoiceStatus.DRAFT;

    @Column(columnDefinition = "TEXT")
    private String statusMessage;

    private String providerTransactionCode;
    private String providerErrorCode;

    @Column(columnDefinition = "TEXT")
    private String providerErrorMessage;

    @Builder.Default
    private Boolean isDeleted = false;

    @Column(updatable = false)
    @Builder.Default
    private LocalDateTime createdAt = LocalDateTime.now();

    @Builder.Default
    private LocalDateTime updatedAt = LocalDateTime.now();

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }

    public void markAsSuccess(String txCode) {
        this.status = InvoiceStatus.SUCCESS;
        this.providerTransactionCode = txCode;
        this.updatedAt = LocalDateTime.now();
    }

    public void markAsFailed(String code, String message) {
        this.status = InvoiceStatus.FAILED;
        this.providerErrorCode = code;
        this.providerErrorMessage = message;
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/entity/jpa/InvoicePayload.java">
package com.einvoicehub.core.entity.jpa;

import jakarta.persistence.*;
import lombok.*;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.annotation.LastModifiedDate;
import org.springframework.data.jpa.domain.support.AuditingEntityListener;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;

@Entity
@Table(name = "invoice_payloads")
@EntityListeners(AuditingEntityListener.class)
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class InvoicePayload {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "merchant_id")
    private Long merchantId;

    @Column(name = "client_request_id", unique = true)
    private String clientRequestId;

    @Column(name = "transaction_id")
    private String transactionId;

    @Column(name = "provider_code")
    private String providerCode;

    @Column(name = "invoice_id", unique = true)
    private Long invoiceId;

    @Column(name = "raw_data", columnDefinition = "JSON")
    private String rawData;

    @Column(name = "response_raw", columnDefinition = "LONGTEXT")
    private String responseRaw;

    @Column(name = "xml_content", columnDefinition = "LONGTEXT")
    private String xmlContent;

    @Column(name = "json_content", columnDefinition = "LONGTEXT")
    private String jsonContent;

    @Column(name = "signed_xml", columnDefinition = "LONGTEXT")
    private String signedXml;

    @Column(name = "pdf_data", columnDefinition = "LONGTEXT")
    private String pdfData;

    @Column(name = "status")
    private String status;

    @CreatedDate
    @Column(name = "created_at", nullable = false, updatable = false)
    @Builder.Default
    private LocalDateTime createdAt = LocalDateTime.now();

    @LastModifiedDate
    @Column(name = "updated_at")
    private LocalDateTime updatedAt;

    @Column(name = "extra_data", columnDefinition = "JSON")
    private String extraData;

// Nested classes for buyer, seller, items, summary
// L∆∞u tr·ªØ d∆∞·ªõi d·∫°ng JSON trong c√°c c·ªôt ri√™ng bi·ªát ho·∫∑c trong extra_data

    @Data
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    @Embeddable
    public static class BuyerInfo {
        private String name;
        private String taxCode;
        private String email;
        private String phone;
        private String address;
        private String bankAccount;
        private String bankName;
    }

    @Data
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    @Embeddable
    public static class SellerInfo {
        private String name;
        private String taxCode;
        private String address;
        private String phone;
        private String email;
        private String bankAccount;
        private String bankName;
    }

    @Data
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    @Embeddable
    public static class InvoiceItem {
        private String itemCode;
        private String itemName;
        private String unitName;
        private BigDecimal quantity;
        private BigDecimal unitPrice;
        private BigDecimal amount;
        private BigDecimal discountAmount;
        private BigDecimal discountPercent;
        private BigDecimal taxRate;
        private BigDecimal taxAmount;
        private String taxCategory;
        private String description;
    }

    @Data
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    @Embeddable
    public static class InvoiceSummary {
        private BigDecimal subtotalAmount;
        private BigDecimal totalDiscountAmount;
        private BigDecimal totalTaxAmount;
        private BigDecimal totalAmount;
        private String currencyCode;
        private BigDecimal exchangeRate;
        private String amountInWords;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/entity/jpa/Merchant.java">
package com.einvoicehub.core.entity.jpa;

import com.einvoicehub.core.entity.enums.EntityStatus;
import com.einvoicehub.core.entity.enums.SubscriptionPlan;
import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Entity
@Table(name = "merchants")
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@ToString(exclude = {"users", "apiCredentials", "providerConfigs", "invoices"})
public class Merchant {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(unique = true, nullable = false, length = 20)
    private String taxCode;

    @Column(nullable = false)
    private String companyName;

    private String address;
    private String email;
    private String phone;

    @Builder.Default
    private Integer invoiceQuota = 100;

    @Builder.Default
    private Integer currentInvoiceCount = 0;

    @Enumerated(EnumType.STRING)
    @Builder.Default
    private SubscriptionPlan subscriptionPlan = SubscriptionPlan.TRIAL;

    @Enumerated(EnumType.STRING)
    @Builder.Default
    private EntityStatus status = EntityStatus.ACTIVE;

    @Builder.Default
    private Boolean isDeleted = false;

    @Column(updatable = false)
    @Builder.Default
    private LocalDateTime createdAt = LocalDateTime.now();

    @Builder.Default
    private LocalDateTime updatedAt = LocalDateTime.now();

    @OneToMany(mappedBy = "merchant", cascade = CascadeType.ALL)
    @Builder.Default
    private List<InvoiceMetadata> invoices = new ArrayList<>();

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }

    /* Business Methods */

    public String getName() {
        return companyName;
    }

    public boolean hasAvailableQuota() {
        return subscriptionPlan.isUnlimited() || currentInvoiceCount < invoiceQuota;
    }

    public void incrementInvoiceUsage() {
        if (!hasAvailableQuota()) {
            throw new IllegalStateException("Merchant invoice quota exceeded");
        }
        this.currentInvoiceCount++;
    }

    public int getRemainingQuota() {
        return subscriptionPlan.isUnlimited() ? Integer.MAX_VALUE : invoiceQuota - currentInvoiceCount;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/entity/jpa/MerchantProviderConfig.java">
package com.einvoicehub.core.entity.jpa;

import com.einvoicehub.core.converter.EncryptionConverter;
import jakarta.persistence.*;
import lombok.*;

import java.time.LocalDateTime;

@Entity
@Table(name = "merchant_provider_configs")
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@ToString(exclude = {"merchant", "provider"})
@EqualsAndHashCode(of = "id")
public class MerchantProviderConfig {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "merchant_id", nullable = false)
    private Merchant merchant;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "provider_id", nullable = false)
    private ServiceProvider provider;

    @Column(nullable = false, length = 100)
    private String usernameService;

    @Column(nullable = false, length = 500)
    @Convert(converter = EncryptionConverter.class)
    private String passwordServiceEncrypted;

    @Column(length = 100)
    private String certificateSerial;

    @Column(columnDefinition = "TEXT")
    @Convert(converter = EncryptionConverter.class)
    private String certificateData;

    private LocalDateTime certificateExpiredAt;

    @Column(columnDefinition = "JSON")
    private String extraConfig;

    @Builder.Default
    private Boolean isActive = true;

    @Builder.Default
    private Boolean isDefault = false;

    private LocalDateTime lastSyncAt;

    @Column(updatable = false)
    @Builder.Default
    private LocalDateTime createdAt = LocalDateTime.now();

    @Builder.Default
    private LocalDateTime updatedAt = LocalDateTime.now();

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }

    /* Business Logic */

    public boolean isCertificateExpired() {
        return certificateExpiredAt != null && certificateExpiredAt.isBefore(LocalDateTime.now());
    }

    public boolean hasValidCertificate() {
        return certificateData != null && !certificateData.isEmpty() && !isCertificateExpired();
    }

    public String getProviderCode() {
        return provider != null ? provider.getProviderCode() : null;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/entity/jpa/MerchantUser.java">
package com.einvoicehub.core.entity.jpa;

import com.einvoicehub.core.entity.enums.UserRole;
import jakarta.persistence.*;
import lombok.*;

import java.time.LocalDateTime;

@Entity
@Table(name = "merchant_users")
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@ToString(exclude = "merchant")
@EqualsAndHashCode(of = "id")
public class MerchantUser {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "merchant_id", nullable = false)
    private Merchant merchant;

    @Column(nullable = false, unique = true, length = 50)
    private String username;

    @Column(nullable = false, unique = true)
    private String email;

    @Column(nullable = false)
    private String passwordHash;

    private String fullName;
    private String phone;
    private String avatarUrl;

    @Enumerated(EnumType.STRING)
    @Builder.Default
    private UserRole role = UserRole.STAFF;

    @Builder.Default
    private Boolean isActive = true;

    @Builder.Default
    private Boolean isPrimary = false;

    private LocalDateTime lastLoginAt;

    @Builder.Default
    private Integer failedLoginAttempts = 0;

    private LocalDateTime lockedUntil;

    @Column(updatable = false)
    @Builder.Default
    private LocalDateTime createdAt = LocalDateTime.now();

    @Builder.Default
    private LocalDateTime updatedAt = LocalDateTime.now();

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }

    /* Security Logic */

    public boolean isLocked() {
        return lockedUntil != null && lockedUntil.isAfter(LocalDateTime.now());
    }

    public void incrementFailedAttempts() {
        this.failedLoginAttempts++;
        /* Lock account for 30 minutes after 5 failed attempts */
        if (this.failedLoginAttempts >= 5) {
            this.lockedUntil = LocalDateTime.now().plusMinutes(30);
        }
    }

    public void resetLoginStatus() {
        this.failedLoginAttempts = 0;
        this.lockedUntil = null;
    }

    public void recordSuccessfulLogin() {
        this.lastLoginAt = LocalDateTime.now();
        this.resetLoginStatus();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/entity/jpa/ProviderTransaction.java">
package com.einvoicehub.core.entity.jpa;

import jakarta.persistence.*;
import lombok.*;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.annotation.LastModifiedDate;
import org.springframework.data.jpa.domain.support.AuditingEntityListener;

import java.time.LocalDateTime;

@Entity
@Table(name = "provider_transactions")
@EntityListeners(AuditingEntityListener.class)
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ProviderTransaction {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "merchant_id")
    private Long merchantId;

    @Column(name = "invoice_metadata_id")
    private Long invoiceMetadataId;

    @Column(name = "transaction_id")
    private String transactionId;

    @Column(name = "transaction_type")
    @Enumerated(EnumType.STRING)
    private TransactionType transactionType;

    @Column(name = "provider_code")
    private String providerCode;

    @Column(name = "status")
    @Enumerated(EnumType.STRING)
    private TransactionStatus status;

    @Column(name = "request_data", columnDefinition = "LONGTEXT")
    private String requestData;

    @Column(name = "response_data", columnDefinition = "LONGTEXT")
    private String responseData;

    @Column(name = "error_code")
    private String errorCode;

    @Column(name = "error_message", columnDefinition = "TEXT")
    private String errorMessage;

    @Column(name = "processing_time_ms")
    private Long processingTimeMs;

    @CreatedDate
    @Column(name = "timestamp", nullable = false, updatable = false)
    @Builder.Default
    private LocalDateTime timestamp = LocalDateTime.now();

    @LastModifiedDate
    @Column(name = "updated_at")
    private LocalDateTime updatedAt;

    @Column(name = "retry_count")
    @Builder.Default
    private Integer retryCount = 0;

    @Column(name = "next_retry_at")
    private LocalDateTime nextRetryAt;

    @Column(name = "metadata", columnDefinition = "JSON")
    private String metadata;

    public enum TransactionType {
        CREATE_INVOICE,      // T·∫°o h√≥a ƒë∆°n m·ªõi
        GET_INVOICE_STATUS,  // L·∫•y tr·∫°ng th√°i h√≥a ƒë∆°n
        CANCEL_INVOICE,      // H·ªßy h√≥a ƒë∆°n
        REPLACE_INVOICE,     // Thay th·∫ø h√≥a ƒë∆°n
        SYNC_INVOICE,        // ƒê·ªìng b·ªô h√≥a ƒë∆°n
        VALIDATE_INVOICE,    // Ki·ªÉm tra t√≠nh h·ª£p l·ªá
        DOWNLOAD_INVOICE     // T·∫£i h√≥a ƒë∆°n
    }

    public enum TransactionStatus {
        PENDING,     // ƒêang ch·ªù x·ª≠ l√Ω
        PROCESSING,  // ƒêang x·ª≠ l√Ω
        SUCCESS,     // Th√†nh c√¥ng
        FAILED,      // Th·∫•t b·∫°i
        RETRYING,    // ƒêang th·ª≠ l·∫°i
        CANCELLED    // ƒê√£ h·ªßy
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/entity/jpa/ServiceProvider.java">
package com.einvoicehub.core.entity.jpa;

import jakarta.persistence.*;
import lombok.*;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Entity
@Table(name = "service_providers")
@Getter
@Setter
@Builder
@NoArgsConstructor
@AllArgsConstructor
@ToString(exclude = {"merchantConfigs", "invoices"})
@EqualsAndHashCode(of = "id")
public class ServiceProvider {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(nullable = false, unique = true, length = 20)
    private String providerCode;

    @Column(nullable = false, length = 100)
    private String providerName;

    @Column(nullable = false, length = 500)
    private String officialApiUrl;

    private String documentationUrl;
    private String supportEmail;
    private String supportPhone;

    @Builder.Default
    private Boolean isActive = true;

    @Builder.Default
    private Boolean isDefault = false;

    @Builder.Default
    private Integer displayOrder = 0;

    @Column(columnDefinition = "JSON")
    private String extraConfigSchema;

    @Column(updatable = false)
    @Builder.Default
    private LocalDateTime createdAt = LocalDateTime.now();

    @Builder.Default
    private LocalDateTime updatedAt = LocalDateTime.now();

    @OneToMany(mappedBy = "provider")
    @Builder.Default
    private List<MerchantProviderConfig> merchantConfigs = new ArrayList<>();

    @OneToMany(mappedBy = "provider")
    @Builder.Default
    private List<InvoiceMetadata> invoices = new ArrayList<>();

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }

    public String getDisplayName() {
        return providerName;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/exception/ProviderException.java">
package com.einvoicehub.core.provider.exception;

import lombok.Getter;
import java.time.LocalDateTime;
import java.util.Collections;
import java.util.Map;

@Getter
public class ProviderException extends RuntimeException {
    private final String providerCode;
    private final String errorCode;
    private final int statusCode;
    private final boolean retryable;
    private final LocalDateTime timestamp;
    private final Map<String, Object> details;

    public ProviderException(String message, String providerCode, String errorCode) {
        this(message, providerCode, errorCode, 500, false, null, null);
    }

    public ProviderException(String message, String providerCode, String errorCode, int statusCode) {
        this(message, providerCode, errorCode, statusCode, false, null, null);
    }

    public ProviderException(String message, String providerCode, String errorCode,
                             int statusCode, boolean retryable,
                             Map<String, Object> details, Throwable cause) {
        super(message, cause);
        this.providerCode = providerCode;
        this.errorCode = errorCode;
        this.statusCode = statusCode;
        this.retryable = retryable;
        this.details = details != null ? details : Collections.emptyMap();
        this.timestamp = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/impl/bkav/BkavAdapter.java">
package com.einvoicehub.core.provider.impl.bkav;

import com.einvoicehub.core.entity.enums.InvoiceStatus;
import com.einvoicehub.core.provider.*;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;
import org.springframework.web.reactive.function.client.WebClient;

import javax.crypto.Cipher;
import javax.crypto.spec.GCMParameterSpec;
import javax.crypto.spec.SecretKeySpec;
import java.nio.charset.StandardCharsets;
import java.security.SecureRandom;
import java.time.Duration;
import java.util.*;

@Slf4j
@Service("BKAV")
public class BkavAdapter implements InvoiceProvider {

    private final WebClient webClient;
    private final BkavApiMapper apiMapper;
    private final ObjectMapper objectMapper;

    @Value("${provider.bkav.timeout-ms:30000}")
    private int timeoutMs;

    @Value("${provider.bkav.encryption-key:}")
    private String encryptionKey;

    public BkavAdapter(WebClient.Builder webClientBuilder,
                       BkavApiMapper apiMapper,
                       ObjectMapper objectMapper,
                       @Value("${provider.bkav.base-url:https://einvoice.bkav.com/api/v1}") String baseUrl) {
        this.webClient = webClientBuilder.baseUrl(baseUrl)
                .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)
                .build();
        this.apiMapper = apiMapper;
        this.objectMapper = objectMapper;
    }

    @Override public String getProviderCode() { return "BKAV"; }
    @Override public String getProviderName() { return "Bkav eInvoice"; }
    @Override public boolean isAvailable() { return true; }

    @Override
    public InvoiceResponse issueInvoice(InvoiceRequest request, ProviderConfig config) {
        log.info("BKAV: Issuing invoice for ClientID: {}", request.getClientRequestId());
        try {
            BkavCommandPayload payload = apiMapper.toBkavPayload(request);
            String encryptedData = encryptPayload(payload);

            BkavApiResponse response = callBkavApi(encryptedData, config);
            return apiMapper.toHubResponse(response, request.getClientRequestId());
        } catch (Exception e) {
            log.error("BKAV Issuance failed: {}", e.getMessage());
            return InvoiceResponse.builder()
                    .status(InvoiceResponse.ResponseStatus.FAILED)
                    .errorMessage("Issuance error: " + e.getMessage())
                    .build();
        }
    }

    @Override
    public InvoiceStatus getInvoiceStatus(String invoiceNumber, ProviderConfig config) {
        try {
            BkavCommandPayload payload = BkavCommandPayload.builder()
                    .cmdType(850)
                    .commandObject(invoiceNumber)
                    .build();

            BkavApiResponse response = callBkavApi(encryptPayload(payload), config);
            return (response != null) ? apiMapper.mapBkavStatus(response) : InvoiceStatus.FAILED;
        } catch (Exception e) {
            log.error("BKAV status check failed for {}: {}", invoiceNumber, e.getMessage());
            return InvoiceStatus.FAILED;
        }
    }

    @Override
    public InvoiceResponse cancelInvoice(String invoiceNumber, String reason, ProviderConfig config) {
        try {
            BkavCommandPayload payload = BkavCommandPayload.builder()
                    .cmdType(201)
                    .commandObject(List.of(Map.of("InvoiceGUID", invoiceNumber, "Reason", reason)))
                    .build();

            BkavApiResponse response = callBkavApi(encryptPayload(payload), config);
            return apiMapper.toHubResponse(response, null);
        } catch (Exception e) {
            return InvoiceResponse.builder()
                    .status(InvoiceResponse.ResponseStatus.FAILED)
                    .errorMessage(e.getMessage())
                    .build();
        }
    }

    @Override
    public InvoiceResponse replaceInvoice(String oldNo, InvoiceRequest newReq, ProviderConfig config) {
        try {
            BkavCommandPayload payload = apiMapper.toBkavPayload(newReq);
            payload.setCmdType(120);

            if (payload.getCommandObject() instanceof List<?> list && !list.isEmpty()) {
                Map<String, Object> invoice = (Map<String, Object>) list.get(0);
                invoice.put("OriginalInvoiceIdentify", String.format("[1]_[%s]_[%s]",
                        invoice.getOrDefault("InvoiceSerial", ""), formatInvoiceNo(oldNo)));
            }

            BkavApiResponse response = callBkavApi(encryptPayload(payload), config);
            return apiMapper.toHubResponse(response, newReq.getClientRequestId());
        } catch (Exception e) {
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage(e.getMessage()).build();
        }
    }

    @Override
    public String getInvoicePdf(String invoiceNumber, ProviderConfig config) {
        try {
            BkavCommandPayload payload = BkavCommandPayload.builder()
                    .cmdType(816)
                    .commandObject(List.of(Map.of("PartnerInvoiceID", invoiceNumber, "PartnerInvoiceStringID", "")))
                    .build();

            BkavApiResponse response = callBkavApi(encryptPayload(payload), config);
            return (response != null) ? response.getCode() : null;
        } catch (Exception e) { return null; }
    }

    @Override
    public String getInvoiceXml(String invoiceNumber, ProviderConfig config) {
        try {
            BkavCommandPayload payload = BkavCommandPayload.builder()
                    .cmdType(817)
                    .commandObject(List.of(Map.of("PartnerInvoiceID", invoiceNumber, "PartnerInvoiceStringID", "")))
                    .build();

            BkavApiResponse response = callBkavApi(encryptPayload(payload), config);
            return (response != null && response.getObject() != null) ? response.getObject().toString() : null;
        } catch (Exception e) {
            log.error("BKAV: Failed to fetch XML for {}", invoiceNumber);
            return null;
        }
    }

    @Override public String authenticate(ProviderConfig config) { return config.getUsername(); }
    @Override public boolean testConnection(ProviderConfig config) { return true; }

    /* Helper to call BKAV API with standardized headers */
    private BkavApiResponse callBkavApi(String encryptedData, ProviderConfig config) {
        return webClient.post().uri("/exec-command")
                .header("PartnerGUID", config.getUsername())
                .header("PartnerToken", config.getPassword())
                .bodyValue(Map.of("CommandData", encryptedData))
                .retrieve()
                .bodyToMono(BkavApiResponse.class)
                .timeout(Duration.ofMillis(timeoutMs))
                .block();
    }

    private String encryptPayload(BkavCommandPayload payload) throws Exception {
        String jsonData = objectMapper.writeValueAsString(payload);
        if (!StringUtils.hasText(encryptionKey)) return jsonData;

        SecretKeySpec secretKey = new SecretKeySpec(encryptionKey.getBytes(StandardCharsets.UTF_8), "AES");
        byte[] iv = new byte[12];
        new SecureRandom().nextBytes(iv);

        Cipher cipher = Cipher.getInstance("AES/GCM/NoPadding");
        cipher.init(Cipher.ENCRYPT_MODE, secretKey, new GCMParameterSpec(128, iv));
        byte[] encrypted = cipher.doFinal(jsonData.getBytes(StandardCharsets.UTF_8));

        return Base64.getEncoder().encodeToString(iv) + ":" + Base64.getEncoder().encodeToString(encrypted);
    }

    private String formatInvoiceNo(String no) {
        try { return String.format("%08d", Integer.parseInt(no)); } catch (Exception e) { return no; }
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class BkavCommandPayload { private int cmdType; private Object commandObject; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class BkavApiResponse {
        private int status;
        private Object object;
        private boolean isOk, isError;
        private String code;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/impl/bkav/BkavApiMapper.java">
package com.einvoicehub.core.provider.impl.bkav;

import com.einvoicehub.core.entity.enums.InvoiceStatus;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;

@Slf4j
@Component
@RequiredArgsConstructor
public class BkavApiMapper {

    private final ObjectMapper objectMapper;

    public BkavAdapter.BkavCommandPayload toBkavPayload(InvoiceRequest request) {
        List<Map<String, Object>> details = request.getItems().stream()
                .map(this::convertToBkavDetail)
                .toList();

        Map<String, Object> invoice = new LinkedHashMap<>();
        invoice.put("InvoiceTypeID", getInvoiceTypeId(request));

        LocalDateTime issueTime = request.getIssueDate() != null ?
                request.getIssueDate().atStartOfDay() : LocalDateTime.now();
        invoice.put("InvoiceDate", issueTime.format(DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ss.SSSXXX")));

        invoice.put("BuyerName", request.getBuyer() != null ? request.getBuyer().getName() : "");
        invoice.put("BuyerTaxCode", (request.getBuyer() != null && StringUtils.hasText(request.getBuyer().getTaxCode())) ?
                request.getBuyer().getTaxCode() : "");
        invoice.put("BuyerUnitName", request.getBuyer() != null ? request.getBuyer().getName() : "");
        invoice.put("BuyerAddress", request.getBuyer() != null ? request.getBuyer().getAddress() : "");
        invoice.put("PayMethodID", 3);
        invoice.put("ReceiveTypeID", 3);
        invoice.put("ReceiverEmail", request.getBuyer() != null ? request.getBuyer().getEmail() : "");
        invoice.put("CurrencyID", (request.getSummary() != null && StringUtils.hasText(request.getSummary().getCurrencyCode())) ?
                request.getSummary().getCurrencyCode() : "VND");
        invoice.put("ExchangeRate", 1.0);

        if (request.getExtraConfig() != null) {
            Optional.ofNullable(request.getExtraConfig().get("InvoiceForm")).ifPresent(v -> invoice.put("InvoiceForm", v));
            Optional.ofNullable(request.getExtraConfig().get("InvoiceSerial")).ifPresent(v -> invoice.put("InvoiceSerial", v));
        }

        invoice.put("InvoiceNo", 0);

        Map<String, Object> wrapper = new LinkedHashMap<>();
        wrapper.put("Invoice", invoice);
        wrapper.put("ListInvoiceDetailsWS", details);
        wrapper.put("ListInvoiceAttachFileWS", Collections.emptyList());
        wrapper.put("PartnerInvoiceID", request.getInvoiceMetadataId() != null ? request.getInvoiceMetadataId() : System.currentTimeMillis());

        int cmdType = (request.getExtraConfig() != null && request.getExtraConfig().containsKey("CmdType")) ?
                (Integer) request.getExtraConfig().get("CmdType") : 111;

        return BkavAdapter.BkavCommandPayload.builder()
                .cmdType(cmdType)
                .commandObject(List.of(wrapper))
                .build();
    }

    private Map<String, Object> convertToBkavDetail(InvoiceRequest.InvoiceItem item) {
        Map<String, Object> detail = new LinkedHashMap<>();
        detail.put("ItemName", item.getItemName());
        detail.put("UnitName", item.getUnitName() != null ? item.getUnitName() : "");
        detail.put("Qty", item.getQuantity());
        detail.put("Price", item.getUnitPrice());
        detail.put("Amount", item.getAmount());
        detail.put("TaxRateID", mapTaxRateToBkavId(item.getTaxRate()));
        detail.put("TaxRate", item.getTaxRate());
        detail.put("TaxAmount", item.getTaxAmount() != null ? item.getTaxAmount() : BigDecimal.ZERO);
        detail.put("ItemTypeID", 0);
        return detail;
    }

    public InvoiceResponse toHubResponse(BkavAdapter.BkavApiResponse response, String clientRequestId) {
        if (response == null) {
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage("No response from provider").build();
        }

        boolean isSuccess = response.isOk() && !response.isError();
        return InvoiceResponse.builder()
                .clientRequestId(clientRequestId)
                .status(isSuccess ? InvoiceResponse.ResponseStatus.SUCCESS : InvoiceResponse.ResponseStatus.FAILED)
                .errorCode(String.valueOf(response.getStatus()))
                .errorMessage(isSuccess ? null : extractField(response, "MessLog"))
                .transactionCode(extractField(response, "InvoiceGUID"))
                .invoiceNumber(extractField(response, "InvoiceNo"))
                .symbolCode(extractField(response, "InvoiceSerial"))
                .lookupCode(extractField(response, "MTC"))
                .pdfUrl(extractField(response, "MessLog"))
                .responseTime(LocalDateTime.now())
                .rawResponse(response)
                .build();
    }

    public InvoiceStatus mapBkavStatus(BkavAdapter.BkavApiResponse response) {
        try {
            JsonNode node = objectMapper.readTree(objectMapper.writeValueAsString(response.getObject()));
            if (node.isArray() && !node.isEmpty()) {
                int bkavStatus = node.get(0).path("BkavStatus").asInt();
                int taxStatus = node.get(0).path("TaxStatus").asInt();

                return switch (bkavStatus) {
                    case 1, 11 -> InvoiceStatus.SIGNING;
                    case 2 -> (taxStatus == 33) ? InvoiceStatus.SUCCESS : InvoiceStatus.SENT_TO_PROVIDER;
                    case 3 -> InvoiceStatus.CANCELLED;
                    case 6 -> InvoiceStatus.REPLACED;
                    case 8 -> InvoiceStatus.SUCCESS;
                    default -> InvoiceStatus.FAILED;
                };
            }
        } catch (Exception e) { log.error("BKAV status mapping failed"); }
        return InvoiceStatus.FAILED;
    }

    private String extractField(BkavAdapter.BkavApiResponse response, String field) {
        try {
            JsonNode node = objectMapper.readTree(objectMapper.writeValueAsString(response.getObject()));
            if (node.isArray() && !node.isEmpty()) return node.get(0).path(field).asText();
        } catch (Exception ignored) {}
        return null;
    }

    private int getInvoiceTypeId(InvoiceRequest request) {
        return (request.getExtraConfig() != null && request.getExtraConfig().get("InvoiceTypeID") instanceof Integer id) ? id : 1;
    }

    private int mapTaxRateToBkavId(BigDecimal taxRate) {
        if (taxRate == null) return 1;
        double rate = taxRate.doubleValue();
        if (rate == 5) return 2;
        if (rate == 10) return 3;
        if (rate == -1) return 4;
        return 1;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/impl/misa/MisaAdapter.java">
package com.einvoicehub.core.provider.impl.misa;

import com.einvoicehub.core.entity.enums.InvoiceStatus;
import com.einvoicehub.core.provider.*;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.reactive.function.client.WebClient;

import java.math.BigDecimal;
import java.time.Duration;
import java.time.LocalDateTime;
import java.util.*;

@Slf4j
@Service("MISA")
public class MisaAdapter implements InvoiceProvider {

    private final WebClient webClient;
    private final MisaApiMapper apiMapper;
    private final ObjectMapper objectMapper;

    @Value("${provider.misa.base-url:https://api.meinvoice.vn/api/integration}")
    private String baseUrl;

    private String cachedToken;
    private LocalDateTime tokenExpiry;

    public MisaAdapter(WebClient.Builder webClientBuilder, MisaApiMapper apiMapper, ObjectMapper objectMapper) {
        this.webClient = webClientBuilder.build();
        this.apiMapper = apiMapper;
        this.objectMapper = objectMapper;
    }

    @Override public String getProviderCode() { return "MISA"; }
    @Override public String getProviderName() { return "MISA MeInvoice"; }

    @Override
    public InvoiceResponse issueInvoice(InvoiceRequest request, ProviderConfig config) {
        log.info("MISA: Processing issuance for ClientRequestID: {}", request.getClientRequestId());
        try {
            String token = getOrRefreshToken(config);
            MisaInvoicePayload payload = apiMapper.toMisaPayload(request);

            /* Default SignType: 2 (HSM) */
            Map<String, Object> body = Map.of("SignType", 2, "InvoiceData", List.of(payload));

            MisaApiResponse response = webClient.post()
                    .uri(config.getCustomApiUrl() != null ? config.getCustomApiUrl() + "/invoice" : baseUrl + "/invoice")
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + token)
                    .bodyValue(body)
                    .retrieve()
                    .bodyToMono(MisaApiResponse.class)
                    .timeout(Duration.ofSeconds(30))
                    .block();

            return apiMapper.toHubResponse(response, request.getClientRequestId());
        } catch (Exception e) {
            log.error("MISA: Issuance failed: {}", e.getMessage());
            return InvoiceResponse.builder()
                    .status(InvoiceResponse.ResponseStatus.FAILED)
                    .errorMessage("MISA issuance error: " + e.getMessage())
                    .build();
        }
    }

    @Override
    public InvoiceStatus getInvoiceStatus(String transactionId, ProviderConfig config) {
        try {
            String token = getOrRefreshToken(config);
            MultiValueMap<String, String> params = new LinkedMultiValueMap<>();
            params.add("invoiceWithCode", "true");
            params.add("inputType", "1");

            MisaApiResponse response = webClient.post()
                    .uri(uriBuilder -> uriBuilder.path(baseUrl + "/invoice/status").queryParams(params).build())
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + token)
                    .bodyValue(List.of(transactionId))
                    .retrieve()
                    .bodyToMono(MisaApiResponse.class)
                    .block();

            if (response != null && response.getData() instanceof List<?> dataList && !dataList.isEmpty()) {
                Map<?, ?> dataMap = (Map<?, ?>) dataList.get(0);
                return apiMapper.mapMisaStatus((Integer) dataMap.get("EInvoiceStatus"));
            }
        } catch (Exception e) {
            log.error("MISA: Status check failed for TransactionID {}: {}", transactionId, e.getMessage());
        }
        return InvoiceStatus.FAILED;
    }

    @Override
    public String getInvoiceXml(String invoiceGuid, ProviderConfig config) {
        log.info("MISA: Requesting XML for InvoiceGUID: {}", invoiceGuid);
        try {
            String token = getOrRefreshToken(config);
            MisaApiResponse response = webClient.post()
                    .uri(baseUrl + "/invoice/export-xml")
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + token)
                    .bodyValue(Map.of("InvoiceGUID", invoiceGuid))
                    .retrieve()
                    .bodyToMono(MisaApiResponse.class)
                    .block();

            return (response != null && response.getData() != null) ? response.getData().toString() : null;
        } catch (Exception e) {
            log.error("MISA: XML export failed: {}", e.getMessage());
            return null;
        }
    }

    @Override
    public String authenticate(ProviderConfig config) {
        Map<String, Object> authReq = Map.of(
                "appid", config.getAppId() != null ? config.getAppId() : config.getUsername(),
                "taxcode", config.getUsername(),
                "username", config.getUsername(),
                "password", config.getPassword()
        );
        try {
            Map<?, ?> res = webClient.post()
                    .uri(baseUrl + "/auth/token")
                    .bodyValue(authReq)
                    .retrieve()
                    .bodyToMono(Map.class)
                    .block();

            return (res != null && res.get("Data") != null) ? res.get("Data").toString() : null;
        } catch (Exception e) {
            log.error("MISA: Authentication failed for taxcode {}: {}", config.getUsername(), e.getMessage());
            return null;
        }
    }

    private synchronized String getOrRefreshToken(ProviderConfig config) {
        if (cachedToken != null && tokenExpiry != null && tokenExpiry.isAfter(LocalDateTime.now().plusMinutes(5))) {
            return cachedToken;
        }
        String token = authenticate(config);
        if (token != null) {
            cachedToken = token;
            tokenExpiry = LocalDateTime.now().plusDays(7);
            return token;
        }
        throw new RuntimeException("MISA: Unable to obtain access token");
    }

    @Override public InvoiceResponse cancelInvoice(String no, String r, ProviderConfig c) { return null; }
    @Override public InvoiceResponse replaceInvoice(String o, InvoiceRequest n, ProviderConfig c) { return null; }
    @Override public String getInvoicePdf(String n, ProviderConfig c) { return null; }
    @Override public boolean isAvailable() { return true; }
    @Override public boolean testConnection(ProviderConfig c) { return authenticate(c) != null; }

    /* MISA Specific Data Models */
    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class MisaInvoicePayload {
        private String refId, invSeries, invDate, currencyCode, paymentMethodName, buyerLegalName, buyerTaxCode, buyerAddress, buyerFullName, buyerPhoneNumber, buyerEmail, totalAmountInWords;
        private BigDecimal exchangeRate, totalSaleAmountOC, totalSaleAmount, totalAmountOC, totalAmount, totalVATAmountOC;
        private boolean isInvoiceSummary;
        private List<MisaInvoiceDetail> originalInvoiceDetail;
        private List<MisaTaxRateInfo> taxRateInfo;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class MisaInvoiceDetail {
        private Integer itemType, sortOrder, lineNumber;
        private String itemName, unitName, vatRateName;
        private BigDecimal quantity, unitPrice, amountOC, amount, discountAmountOC, discountAmount, vatAmountOC, vatAmount;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class MisaTaxRateInfo {
        private String vatRateName;
        private BigDecimal amountWithoutVATOC, vatAmountOC;
    }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class MisaApiResponse {
        private Boolean success;
        private String errorCode, descriptionErrorCode;
        private List<Map<String, Object>> publishInvoiceResult;
        private Object data;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/impl/misa/MisaApiMapper.java">
package com.einvoicehub.core.provider.impl.misa;

import com.einvoicehub.core.entity.enums.InvoiceStatus;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;

@Slf4j
@Component
@RequiredArgsConstructor
public class MisaApiMapper {

    public MisaAdapter.MisaInvoicePayload toMisaPayload(InvoiceRequest request) {
        List<MisaAdapter.MisaInvoiceDetail> details = request.getItems().stream()
                .map(this::convertToMisaDetail)
                .toList();

        MisaAdapter.MisaInvoicePayload payload = MisaAdapter.MisaInvoicePayload.builder()
                .refId(UUID.randomUUID().toString())
                .invSeries(getInvSeries(request))
                .invDate(request.getIssueDate() != null ?
                        request.getIssueDate().format(DateTimeFormatter.ISO_DATE) :
                        LocalDateTime.now().format(DateTimeFormatter.ISO_DATE))
                .currencyCode(StringUtils.hasText(getCurrency(request)) ? getCurrency(request) : "VND")
                .exchangeRate(BigDecimal.ONE)
                .paymentMethodName("TM/CK")
                .isInvoiceSummary(false)
                .buyerLegalName(request.getBuyer() != null ? request.getBuyer().getName() : "")
                .buyerTaxCode(request.getBuyer() != null ? request.getBuyer().getTaxCode() : "")
                .buyerAddress(request.getBuyer() != null ? request.getBuyer().getAddress() : "")
                .buyerFullName(request.getBuyer() != null ? request.getBuyer().getName() : "")
                .buyerPhoneNumber(request.getBuyer() != null ? request.getBuyer().getPhone() : "")
                .buyerEmail(request.getBuyer() != null ? request.getBuyer().getEmail() : "")
                .originalInvoiceDetail(details)
                .taxRateInfo(buildTaxRateInfo(details))
                .build();

        calculateTotals(payload);
        return payload;
    }

    private void calculateTotals(MisaAdapter.MisaInvoicePayload payload) {
        BigDecimal totalSaleAmount = BigDecimal.ZERO;
        BigDecimal totalVatAmount = BigDecimal.ZERO;

        for (MisaAdapter.MisaInvoiceDetail detail : payload.getOriginalInvoiceDetail()) {
            totalSaleAmount = totalSaleAmount.add(detail.getAmountOC() != null ? detail.getAmountOC() : BigDecimal.ZERO);
            totalVatAmount = totalVatAmount.add(detail.getVatAmountOC() != null ? detail.getVatAmountOC() : BigDecimal.ZERO);
        }

        BigDecimal totalAmount = totalSaleAmount.add(totalVatAmount);

        payload.setTotalSaleAmountOC(totalSaleAmount.setScale(2, RoundingMode.HALF_UP));
        payload.setTotalSaleAmount(totalSaleAmount.setScale(2, RoundingMode.HALF_UP));
        payload.setTotalAmountOC(totalAmount.setScale(2, RoundingMode.HALF_UP));
        payload.setTotalAmount(totalAmount.setScale(2, RoundingMode.HALF_UP));
        payload.setTotalVATAmountOC(totalVatAmount.setScale(2, RoundingMode.HALF_UP));
        payload.setTotalAmountInWords(convertNumberToWords(totalAmount));
    }

    private MisaAdapter.MisaInvoiceDetail convertToMisaDetail(InvoiceRequest.InvoiceItem item) {
        BigDecimal qty = item.getQuantity() != null ? item.getQuantity() : BigDecimal.ONE;
        BigDecimal price = item.getUnitPrice() != null ? item.getUnitPrice() : BigDecimal.ZERO;
        BigDecimal amount = qty.multiply(price).setScale(2, RoundingMode.HALF_UP);
        BigDecimal taxRate = item.getTaxRate() != null ? item.getTaxRate() : BigDecimal.ZERO;
        BigDecimal vatAmount = amount.multiply(taxRate).divide(BigDecimal.valueOf(100), 2, RoundingMode.HALF_UP);

        return MisaAdapter.MisaInvoiceDetail.builder()
                .itemType(1).sortOrder(1).lineNumber(1)
                .itemName(item.getItemName())
                .unitName(item.getUnitName() != null ? item.getUnitName() : "")
                .quantity(qty.setScale(2, RoundingMode.HALF_UP))
                .unitPrice(price.setScale(2, RoundingMode.HALF_UP))
                .amountOC(amount).amount(amount)
                .vatAmountOC(vatAmount).vatAmount(vatAmount)
                .vatRateName(taxRate.stripTrailingZeros().toPlainString() + "%")
                .discountAmountOC(BigDecimal.ZERO).discountAmount(BigDecimal.ZERO)
                .build();
    }

    private List<MisaAdapter.MisaTaxRateInfo> buildTaxRateInfo(List<MisaAdapter.MisaInvoiceDetail> details) {
        Map<String, MisaAdapter.MisaTaxRateInfo> taxMap = new LinkedHashMap<>();
        for (MisaAdapter.MisaInvoiceDetail detail : details) {
            taxMap.computeIfAbsent(detail.getVatRateName(), k -> MisaAdapter.MisaTaxRateInfo.builder()
                    .vatRateName(k).amountWithoutVATOC(BigDecimal.ZERO).vatAmountOC(BigDecimal.ZERO).build());
            MisaAdapter.MisaTaxRateInfo info = taxMap.get(detail.getVatRateName());
            info.setAmountWithoutVATOC(info.getAmountWithoutVATOC().add(detail.getAmountOC()));
            info.setVatAmountOC(info.getVatAmountOC().add(detail.getVatAmountOC()));
        }
        return new ArrayList<>(taxMap.values());
    }

    /* Vietnamese Number-to-Words for invoice legality */
    public String convertNumberToWords(BigDecimal amount) {
        try {
            long wholePart = amount.longValue();
            if (wholePart == 0) return "Kh√¥ng ƒë·ªìng.";
            return convertWholeNumberToWords(wholePart) + " ƒë·ªìng.";
        } catch (Exception e) { return "Invalid amount"; }
    }

    private String convertWholeNumberToWords(long number) {
        String[] units = {"", "ngh√¨n", "tri·ªáu", "t·ª∑"};
        String result = "";
        int idx = 0;
        while (number > 0) {
            long group = number % 1000;
            if (group > 0) result = convertGroupToWords((int) group) + " " + units[idx] + " " + result;
            number /= 1000;
            idx++;
        }
        return result.trim();
    }

    private String convertGroupToWords(int n) {
        String[] digits = {"kh√¥ng", "m·ªôt", "hai", "ba", "b·ªën", "nƒÉm", "s√°u", "b·∫£y", "t√°m", "ch√≠n"};
        String[] tens = {"", "m∆∞·ªùi", "hai m∆∞∆°i", "ba m∆∞∆°i", "b·ªën m∆∞∆°i", "nƒÉm m∆∞∆°i", "s√°u m∆∞∆°i", "b·∫£y m∆∞∆°i", "t√°m m∆∞∆°i", "ch√≠n m∆∞∆°i"};
        int h = n / 100, r = n % 100;
        String res = (h > 0) ? digits[h] + " trƒÉm " : "";
        if (r > 0) {
            if (r < 10) res += "l·∫ª " + digits[r];
            else if (r < 20) res += "m∆∞·ªùi " + (r % 10 == 5 ? "lƒÉm" : digits[r % 10]);
            else res += tens[r / 10] + (r % 10 == 5 ? " lƒÉm" : (r % 10 > 0 ? " " + digits[r % 10] : ""));
        }
        return res.trim();
    }

    public InvoiceResponse toHubResponse(MisaAdapter.MisaApiResponse misaResponse, String requestId) {
        if (misaResponse == null) return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage("Provider timeout").build();

        boolean isSuccess = Boolean.TRUE.equals(misaResponse.getSuccess());
        InvoiceResponse.InvoiceResponseBuilder builder = InvoiceResponse.builder()
                .clientRequestId(requestId)
                .status(isSuccess ? InvoiceResponse.ResponseStatus.SUCCESS : InvoiceResponse.ResponseStatus.FAILED)
                .errorCode(misaResponse.getErrorCode())
                .errorMessage(misaResponse.getDescriptionErrorCode())
                .responseTime(LocalDateTime.now())
                .rawResponse(misaResponse);

        if (isSuccess && misaResponse.getPublishInvoiceResult() != null && !misaResponse.getPublishInvoiceResult().isEmpty()) {
            Map<String, Object> res = misaResponse.getPublishInvoiceResult().get(0);
            builder.transactionCode((String) res.get("TransactionID"))
                    .invoiceNumber((String) res.get("InvNo"))
                    .symbolCode((String) res.get("InvSeries"))
                    .lookupCode((String) res.get("TransactionID"));
        }
        return builder.build();
    }

    public InvoiceStatus mapMisaStatus(int status) {
        return switch (status) {
            case 1 -> InvoiceStatus.SUCCESS;
            case 2 -> InvoiceStatus.CANCELLED;
            case 3, 7 -> InvoiceStatus.REPLACED;
            default -> InvoiceStatus.FAILED;
        };
    }

    private String getInvSeries(InvoiceRequest r) { return (r.getExtraConfig() != null) ? (String) r.getExtraConfig().getOrDefault("InvSeries", "") : ""; }
    private String getCurrency(InvoiceRequest r) { return (r.getSummary() != null) ? r.getSummary().getCurrencyCode() : "VND"; }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/impl/viettel/ViettelAdapter.java">
package com.einvoicehub.core.provider.impl.viettel;

import com.einvoicehub.core.entity.enums.InvoiceStatus;
import com.einvoicehub.core.provider.*;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.reactive.function.client.WebClientResponseException;

import java.math.BigDecimal;
import java.time.Duration;
import java.util.*;

@Slf4j
@Service("VIETTEL")
public class ViettelAdapter implements InvoiceProvider {

    private final WebClient webClient;
    private final ViettelApiMapper apiMapper;
    private final ObjectMapper objectMapper;

    @Value("${provider.viettel.timeout-ms:30000}")
    private int timeoutMs;

    public ViettelAdapter(WebClient.Builder webClientBuilder,
                          ViettelApiMapper apiMapper,
                          ObjectMapper objectMapper,
                          @Value("${provider.viettel.base-url:https://ebill.vietteltelecom.vn/api/v1}") String baseUrl) {
        this.webClient = webClientBuilder
                .baseUrl(baseUrl)
                .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)
                .defaultHeader("X-Client-Id", "EInvoiceHub")
                .build();
        this.apiMapper = apiMapper;
        this.objectMapper = objectMapper;
    }

    @Override public String getProviderCode() { return "VIETTEL"; }
    @Override public String getProviderName() { return "Viettel Business Invoice"; }
    @Override public boolean isAvailable() { return true; }

    @Override
    public InvoiceResponse issueInvoice(InvoiceRequest request, ProviderConfig config) {
        log.info("Viettel: Issuing invoice for ClientRequestID: {}", request.getClientRequestId());
        try {
            ViettelInvoicePayload payload = apiMapper.toViettelPayload(request);
            ViettelApiResponse response = webClient.post().uri("/invoices/create")
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .bodyValue(payload)
                    .retrieve()
                    .bodyToMono(ViettelApiResponse.class)
                    .timeout(Duration.ofMillis(timeoutMs))
                    .block();

            return apiMapper.toHubResponse(response, request.getClientRequestId());
        } catch (WebClientResponseException e) {
            return apiMapper.toHubResponse(parseError(e.getResponseBodyAsString()), request.getClientRequestId());
        } catch (Exception e) {
            log.error("Viettel: Issuance failed: {}", e.getMessage());
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage(e.getMessage()).build();
        }
    }

    @Override
    public InvoiceStatus getInvoiceStatus(String invoiceNumber, ProviderConfig config) {
        try {
            ViettelApiResponse response = webClient.get()
                    .uri(uri -> uri.path("/invoices/{id}").queryParam("includeDetails", false).build(invoiceNumber))
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .retrieve()
                    .bodyToMono(ViettelApiResponse.class)
                    .block();
            return apiMapper.mapViettelStatus(response);
        } catch (Exception e) {
            log.error("Viettel: Status check failed for {}: {}", invoiceNumber, e.getMessage());
            return InvoiceStatus.FAILED;
        }
    }

    @Override
    public InvoiceResponse cancelInvoice(String invoiceNumber, String reason, ProviderConfig config) {
        try {
            ViettelCancelRequest body = ViettelCancelRequest.builder().invoiceCode(invoiceNumber).note(reason).build();
            ViettelApiResponse response = webClient.post().uri("/invoices/cancel")
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .bodyValue(body)
                    .retrieve().bodyToMono(ViettelApiResponse.class).block();
            return apiMapper.toHubResponse(response, null);
        } catch (Exception e) {
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage(e.getMessage()).build();
        }
    }

    @Override
    public InvoiceResponse replaceInvoice(String oldNo, InvoiceRequest newReq, ProviderConfig config) {
        try {
            ViettelReplaceRequest body = ViettelReplaceRequest.builder()
                    .oldInvoiceCode(oldNo)
                    .newInvoice(apiMapper.toViettelPayload(newReq))
                    .reason("Invoice replacement")
                    .build();
            ViettelApiResponse response = webClient.post().uri("/invoices/replace")
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .bodyValue(body)
                    .retrieve().bodyToMono(ViettelApiResponse.class).block();
            return apiMapper.toHubResponse(response, newReq.getClientRequestId());
        } catch (Exception e) {
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage(e.getMessage()).build();
        }
    }

    @Override
    public String getInvoicePdf(String invoiceNumber, ProviderConfig config) {
        try {
            ViettelPdfResponse res = webClient.get().uri("/invoices/{id}/pdf", invoiceNumber)
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .retrieve().bodyToMono(ViettelPdfResponse.class).block();
            return res != null ? res.getDownloadUrl() : null;
        } catch (Exception e) { return null; }
    }

    @Override
    public String getInvoiceXml(String invoiceNumber, ProviderConfig config) {
        try {
            ViettelXmlResponse res = webClient.get().uri("/invoices/{id}/xml", invoiceNumber)
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .retrieve().bodyToMono(ViettelXmlResponse.class).block();
            return res != null ? res.getXmlData() : null;
        } catch (Exception e) {
            log.error("Viettel: XML retrieval failed: {}", e.getMessage());
            return null;
        }
    }

    @Override
    public String authenticate(ProviderConfig config) {
        try {
            ViettelAuthRequest auth = ViettelAuthRequest.builder()
                    .username(config.getUsername()).password(config.getPassword()).grantType("password").build();
            Map<?, ?> res = webClient.post().uri("/auth/token").bodyValue(auth).retrieve().bodyToMono(Map.class).block();
            return res != null ? (String) res.get("access_token") : null;
        } catch (Exception e) { return null; }
    }

    @Override public boolean testConnection(ProviderConfig config) { return authenticate(config) != null; }

    private ViettelApiResponse parseError(String body) {
        try { return objectMapper.readValue(body, ViettelApiResponse.class); } catch (Exception e) { return null; }
    }

    /* Inner Data Models */
    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelInvoicePayload {
        private String invoiceType, templateCode, issueDate;
        private ViettelParty seller, buyer;
        private List<ViettelInvoiceItem> items;
        private ViettelPayment payment;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelParty {
        private String taxCode, name, address, phone, email, bankAccount, bankName, contactName;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelInvoiceItem {
        private String name, unit, description;
        private BigDecimal quantity, unitPrice, amount, discountAmount, vatRate, vatAmount;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelPayment { private String method, currency; private BigDecimal totalAmount; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelApiResponse { private String code, message, transactionId; private ViettelInvoiceData data; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelInvoiceData { private String invoiceCode, invoiceNo, checkSum, pdfUrl, status; }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelCancelRequest { private String invoiceCode, note; }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelReplaceRequest { private String oldInvoiceCode; private ViettelInvoicePayload newInvoice; private String reason; }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelAuthRequest { private String username, password, grantType; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelPdfResponse { private String downloadUrl; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelXmlResponse { private String xmlData; }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/impl/viettel/ViettelApiMapper.java">
package com.einvoicehub.core.provider.impl.viettel;

import com.einvoicehub.core.entity.enums.InvoiceStatus;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;

@Slf4j
@Component
@RequiredArgsConstructor
public class ViettelApiMapper {

    public ViettelAdapter.ViettelInvoicePayload toViettelPayload(InvoiceRequest request) {
        List<ViettelAdapter.ViettelInvoiceItem> items = request.getItems().stream()
                .map(this::convertToViettelItem)
                .toList();

        return ViettelAdapter.ViettelInvoicePayload.builder()
                .invoiceType(getInvoiceTypeCode(request))
                .templateCode(getTemplateCode(request))
                .issueDate(request.getIssueDate() != null ?
                        request.getIssueDate().format(DateTimeFormatter.ISO_DATE) :
                        LocalDateTime.now().format(DateTimeFormatter.ISO_DATE))
                .seller(ViettelAdapter.ViettelParty.builder()
                        .taxCode(request.getSeller().getTaxCode())
                        .name(request.getSeller().getName())
                        .address(request.getSeller().getAddress())
                        .phone(request.getSeller().getPhone())
                        .email(request.getSeller().getEmail())
                        .bankAccount(request.getSeller().getBankAccount())
                        .bankName(request.getSeller().getBankName())
                        .contactName(request.getSeller().getRepresentativeName())
                        .build())
                .buyer(ViettelAdapter.ViettelParty.builder()
                        .taxCode(request.getBuyer().getTaxCode())
                        .name(request.getBuyer().getName())
                        .address(request.getBuyer().getAddress())
                        .phone(request.getBuyer().getPhone())
                        .email(request.getBuyer().getEmail())
                        .build())
                .items(items)
                .payment(ViettelAdapter.ViettelPayment.builder()
                        .method(request.getPaymentTerm() != null ? request.getPaymentTerm().getMethod() : "TM/CK")
                        .totalAmount(request.getSummary().getTotalAmount())
                        .currency(request.getSummary().getCurrencyCode())
                        .build())
                .build();
    }

    private ViettelAdapter.ViettelInvoiceItem convertToViettelItem(InvoiceRequest.InvoiceItem item) {
        return ViettelAdapter.ViettelInvoiceItem.builder()
                .name(item.getItemName())
                .unit(item.getUnitName())
                .quantity(item.getQuantity())
                .unitPrice(item.getUnitPrice())
                .amount(item.getAmount())
                .discountAmount(item.getDiscountAmount() != null ? item.getDiscountAmount() : BigDecimal.ZERO)
                .vatRate(item.getTaxRate())
                .vatAmount(item.getTaxAmount() != null ? item.getTaxAmount() : BigDecimal.ZERO)
                .description(item.getDescription())
                .build();
    }

    private String getInvoiceTypeCode(InvoiceRequest request) {
        if (request.getInvoiceType() != null) return request.getInvoiceType();
        return (request.getExtraConfig() != null && request.getExtraConfig().containsKey("invoiceType")) ?
                (String) request.getExtraConfig().get("invoiceType") : "01";
    }

    private String getTemplateCode(InvoiceRequest request) {
        return (request.getExtraConfig() != null && request.getExtraConfig().containsKey("templateCode")) ?
                (String) request.getExtraConfig().get("templateCode") : "01GTKT0/001";
    }

    public InvoiceResponse toHubResponse(ViettelAdapter.ViettelApiResponse res, String requestId) {
        if (res == null) {
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage("Provider timeout").build();
        }

        boolean success = "200".equals(res.getCode());
        return InvoiceResponse.builder()
                .clientRequestId(requestId)
                .status(success ? InvoiceResponse.ResponseStatus.SUCCESS : InvoiceResponse.ResponseStatus.FAILED)
                .errorCode(res.getCode())
                .errorMessage(res.getMessage())
                .transactionCode(res.getTransactionId())
                .invoiceNumber(res.getData() != null ? res.getData().getInvoiceCode() : null)
                .symbolCode(res.getData() != null ? res.getData().getInvoiceNo() : null)
                .lookupCode(res.getData() != null ? res.getData().getCheckSum() : null)
                .pdfUrl(res.getData() != null ? res.getData().getPdfUrl() : null)
                .responseTime(LocalDateTime.now())
                .rawResponse(res)
                .build();
    }

    public InvoiceStatus mapViettelStatus(ViettelAdapter.ViettelApiResponse response) {
        String status = (response != null && response.getData() != null) ? response.getData().getStatus() : null;
        if (status == null) return InvoiceStatus.FAILED;

        return switch (status.toUpperCase()) {
            case "DA_PHAT_HANH", "SIGNED" -> InvoiceStatus.SUCCESS;
            case "DA_HUY" -> InvoiceStatus.CANCELLED;
            default -> InvoiceStatus.FAILED;
        };
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/impl/vnpt/VnptAdapter.java">
package com.einvoicehub.core.provider.impl.vnpt;

import com.einvoicehub.core.entity.enums.InvoiceStatus;
import com.einvoicehub.core.provider.*;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.reactive.function.client.WebClientResponseException;

import java.math.BigDecimal;
import java.time.Duration;
import java.util.*;

@Slf4j
@Service("VNPT")
public class VnptAdapter implements InvoiceProvider {

    private final WebClient webClient;
    private final VnptApiMapper apiMapper;
    private final ObjectMapper objectMapper;

    @Value("${provider.vnpt.timeout-ms:30000}")
    private int timeoutMs;

    public VnptAdapter(WebClient.Builder webClientBuilder,
                       VnptApiMapper apiMapper,
                       ObjectMapper objectMapper,
                       @Value("${provider.vnpt.base-url:https://api.vnptinvoice.com.vn/v1}") String baseUrl) {
        this.webClient = webClientBuilder
                .baseUrl(baseUrl)
                .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)
                .build();
        this.apiMapper = apiMapper;
        this.objectMapper = objectMapper;
    }

    @Override public String getProviderCode() { return "VNPT"; }
    @Override public String getProviderName() { return "VNPT Invoice"; }
    @Override public boolean isAvailable() { return true; }

    @Override
    public InvoiceResponse issueInvoice(InvoiceRequest request, ProviderConfig config) {
        log.info("VNPT: Issuing invoice for ClientRequestID: {}", request.getClientRequestId());
        try {
            VnptInvoicePayload payload = apiMapper.toVnptPayload(request);
            VnptApiResponse response = webClient.post().uri("/invoices/publish")
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .bodyValue(payload)
                    .retrieve().bodyToMono(VnptApiResponse.class)
                    .timeout(Duration.ofMillis(timeoutMs)).block();

            return apiMapper.toHubResponse(response, request.getClientRequestId());
        } catch (WebClientResponseException e) {
            return apiMapper.toHubResponse(parseError(e.getResponseBodyAsString()), request.getClientRequestId());
        } catch (Exception e) {
            log.error("VNPT: Issuance failed: {}", e.getMessage());
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage(e.getMessage()).build();
        }
    }

    @Override
    public InvoiceStatus getInvoiceStatus(String invoiceNumber, ProviderConfig config) {
        try {
            VnptStatusResponse response = webClient.get()
                    .uri(uri -> uri.path("/invoices/status").queryParam("invoiceNumber", invoiceNumber).build())
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .retrieve().bodyToMono(VnptStatusResponse.class).block();
            return (response != null) ? apiMapper.mapVnptStatus(response.getStatus()) : InvoiceStatus.FAILED;
        } catch (Exception e) {
            log.error("VNPT: Status check failed for {}: {}", invoiceNumber, e.getMessage());
            return InvoiceStatus.FAILED;
        }
    }

    @Override
    public InvoiceResponse cancelInvoice(String invoiceNumber, String reason, ProviderConfig config) {
        try {
            VnptCancelRequest req = VnptCancelRequest.builder().invoiceNumber(invoiceNumber).reason(reason).build();
            VnptApiResponse response = webClient.post().uri("/invoices/cancel")
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .bodyValue(req)
                    .retrieve().bodyToMono(VnptApiResponse.class).block();
            return apiMapper.toHubResponse(response, null);
        } catch (Exception e) {
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage(e.getMessage()).build();
        }
    }

    @Override
    public InvoiceResponse replaceInvoice(String oldNo, InvoiceRequest newReq, ProviderConfig config) {
        /* Standard VNPT flow: Cancel old and issue new */
        InvoiceResponse cancelRes = cancelInvoice(oldNo, "Replaced by new invoice", config);
        if (cancelRes.isFailed()) return cancelRes;
        return issueInvoice(newReq, config);
    }

    @Override
    public String getInvoicePdf(String invoiceNumber, ProviderConfig config) {
        try {
            VnptPdfResponse res = webClient.get().uri("/invoices/{id}/pdf", invoiceNumber)
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .retrieve().bodyToMono(VnptPdfResponse.class).block();
            return res != null ? res.getPdfUrl() : null;
        } catch (Exception e) { return null; }
    }

    @Override
    public String getInvoiceXml(String invoiceNumber, ProviderConfig config) {
        try {
            VnptXmlResponse res = webClient.get().uri("/invoices/{id}/xml", invoiceNumber)
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .retrieve().bodyToMono(VnptXmlResponse.class).block();
            return res != null ? res.getXmlData() : null;
        } catch (Exception e) {
            log.error("VNPT: XML retrieval failed: {}", e.getMessage());
            return null;
        }
    }

    @Override
    public String authenticate(ProviderConfig config) {
        try {
            VnptAuthRequest req = VnptAuthRequest.builder().username(config.getUsername()).password(config.getPassword()).build();
            VnptAuthResponse res = webClient.post().uri("/auth/login").bodyValue(req).retrieve().bodyToMono(VnptAuthResponse.class).block();
            return (res != null) ? res.getAccessToken() : null;
        } catch (Exception e) { return null; }
    }

    @Override public boolean testConnection(ProviderConfig config) { return authenticate(config) != null; }

    private VnptApiResponse parseError(String body) {
        try { return objectMapper.readValue(body, VnptApiResponse.class); } catch (Exception e) { return null; }
    }

    /* Inner Models */
    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptInvoicePayload {
        private String invoiceType, templateCode, issueDate;
        private VnptParty seller, buyer;
        private List<VnptInvoiceDetail> details;
        private VnptSummary summary;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptParty {
        private String taxCode, companyName, address, phone, email, bankAccount, bankName, representativeName;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptInvoiceDetail {
        private String itemName, unitName, taxCategory, description;
        private BigDecimal quantity, unitPrice, amount, discountAmount, taxRate;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptSummary {
        private BigDecimal subtotalAmount, totalDiscountAmount, totalTaxAmount, totalAmount;
    }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptApiResponse {
        private boolean success;
        private String errorCode, message, transactionId, invoiceNumber, fkey, lookupCode, securityCode, pdfUrl;
    }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptStatusResponse { private String status, invoiceNumber; }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptCancelRequest { private String invoiceNumber, reason; }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptAuthRequest { private String username, password; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptAuthResponse { private String accessToken, refreshToken; private long expiresIn; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptPdfResponse { private String pdfUrl; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptXmlResponse { private String xmlData; }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/impl/vnpt/VnptApiMapper.java">
package com.einvoicehub.core.provider.impl.vnpt;

import com.einvoicehub.core.entity.enums.InvoiceStatus;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;

@Slf4j
@Component
@RequiredArgsConstructor
public class VnptApiMapper {

    public InvoiceResponse toHubResponse(VnptAdapter.VnptApiResponse res, String requestId) {
        if (res == null) {
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage("No response from provider").build();
        }

        return InvoiceResponse.builder()
                .clientRequestId(requestId)
                .status(res.isSuccess() ? InvoiceResponse.ResponseStatus.SUCCESS : InvoiceResponse.ResponseStatus.FAILED)
                .errorCode(res.getErrorCode())
                .errorMessage(res.getMessage())
                .transactionCode(res.getTransactionId())
                .invoiceNumber(res.getInvoiceNumber())
                /* VNPT fkey typically contains series and template info */
                .symbolCode(res.getFkey() != null && res.getFkey().length() > 10 ? res.getFkey().substring(0, 10) : res.getFkey())
                .templateCode(res.getFkey())
                .lookupCode(res.getLookupCode())
                .securityCode(res.getSecurityCode())
                .pdfUrl(res.getPdfUrl())
                .responseTime(LocalDateTime.now())
                .rawResponse(res)
                .build();
    }

    public VnptAdapter.VnptInvoicePayload toVnptPayload(InvoiceRequest request) {
        List<VnptAdapter.VnptInvoiceDetail> details = request.getItems().stream()
                .map(this::convertToVnptDetail)
                .toList();

        return VnptAdapter.VnptInvoicePayload.builder()
                .invoiceType(request.getInvoiceType() != null ? request.getInvoiceType() : "01GTKT")
                .templateCode(request.getExtraConfig() != null ?
                        (String) request.getExtraConfig().getOrDefault("templateCode", "01GTKT0/001") : "01GTKT0/001")
                .issueDate(request.getIssueDate() != null ?
                        request.getIssueDate().format(DateTimeFormatter.ISO_DATE) :
                        LocalDateTime.now().format(DateTimeFormatter.ISO_DATE))
                .seller(VnptAdapter.VnptParty.builder()
                        .taxCode(request.getSeller().getTaxCode())
                        .companyName(request.getSeller().getName())
                        .address(request.getSeller().getAddress())
                        .phone(request.getSeller().getPhone())
                        .email(request.getSeller().getEmail())
                        .build())
                .buyer(VnptAdapter.VnptParty.builder()
                        .taxCode(request.getBuyer().getTaxCode())
                        .companyName(request.getBuyer().getName())
                        .address(request.getBuyer().getAddress())
                        .phone(request.getBuyer().getPhone())
                        .email(request.getBuyer().getEmail())
                        .build())
                .details(details)
                .summary(VnptAdapter.VnptSummary.builder()
                        .subtotalAmount(request.getSummary().getSubtotalAmount())
                        .totalDiscountAmount(request.getSummary().getTotalDiscountAmount())
                        .totalTaxAmount(request.getSummary().getTotalTaxAmount())
                        .totalAmount(request.getSummary().getTotalAmount())
                        .build())
                .build();
    }

    private VnptAdapter.VnptInvoiceDetail convertToVnptDetail(InvoiceRequest.InvoiceItem item) {
        return VnptAdapter.VnptInvoiceDetail.builder()
                .itemName(item.getItemName())
                .unitName(item.getUnitName())
                .quantity(item.getQuantity())
                .unitPrice(item.getUnitPrice())
                .amount(item.getAmount())
                .discountAmount(item.getDiscountAmount())
                .taxRate(item.getTaxRate())
                .taxCategory(item.getTaxCategory() != null ? item.getTaxCategory() : "5")
                .description(item.getDescription())
                .build();
    }

    public InvoiceStatus mapVnptStatus(String vnptStatus) {
        if (vnptStatus == null) return InvoiceStatus.FAILED;
        return switch (vnptStatus.toUpperCase()) {
            case "ISSUED", "SUCCESS" -> InvoiceStatus.SUCCESS;
            case "CANCELLED" -> InvoiceStatus.CANCELLED;
            case "REPLACED" -> InvoiceStatus.REPLACED;
            default -> InvoiceStatus.FAILED;
        };
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/model/InvoiceRequest.java">
package com.einvoicehub.core.provider.model;

import lombok.*;
import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.List;
import java.util.Map;

/**
 * DTO ƒë·∫°i di·ªán cho y√™u c·∫ßu ph√°t h√†nh h√≥a ƒë∆°n n·ªôi b·ªô.
 * ƒê√£ t·ªëi ∆∞u cho vi·ªác mapping sang m·ªçi Provider (VNPT, MISA, BKAV, Viettel).
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class InvoiceRequest {

    private Long invoiceMetadataId;
    private String clientRequestId;
    private String providerCode;
    private String invoiceType; // VD: 01GTKT, 02GTTT

    /** C·∫ßn thi·∫øt cho h·∫ßu h·∫øt Provider Vi·ªát Nam */
    private String templateCode; // M·∫´u s·ªë (VD: 1/001)
    private String symbolCode;   // K√Ω hi·ªáu (VD: C23TBA)

    private SellerInfo seller;
    private BuyerInfo buyer;
    private List<InvoiceItem> items;
    private InvoiceSummary summary;

    private LocalDate issueDate;
    private PaymentTerm paymentTerm;

    /** Ch·ª©a c√°c tham s·ªë ƒë·∫∑c th√π kh√¥ng n·∫±m trong chu·∫©n chung */
    private Map<String, Object> extraConfig;

    @Data @Builder @NoArgsConstructor @AllArgsConstructor
    public static class SellerInfo {
        private String name;
        private String taxCode;
        private String address;
        private String phone;
        private String email;
        private String bankAccount;
        private String bankName;
        private String representativeName;
    }

    @Data @Builder @NoArgsConstructor @AllArgsConstructor
    public static class BuyerInfo {
        private String name;
        private String taxCode;
        private String address;
        private String phone;
        private String email;
        private String bankAccount;
        private String bankName;
        private String customerCode; // M√£ kh√°ch h√†ng n·ªôi b·ªô
    }

    @Data @Builder @NoArgsConstructor @AllArgsConstructor
    public static class InvoiceItem {
        private String itemCode;
        private String itemName;
        private String unitName;
        private BigDecimal quantity;
        private BigDecimal unitPrice;
        private BigDecimal amount; // Th√†nh ti·ªÅn tr∆∞·ªõc thu·∫ø
        private BigDecimal discountAmount;
        private BigDecimal discountPercent; // Th√™m ƒë·ªÉ h·ªó tr·ª£ t√≠nh to√°n chi·∫øt kh·∫•u %
        private BigDecimal taxRate; // Thu·∫ø su·∫•t (0, 5, 8, 10...)
        private BigDecimal taxAmount;
        private String taxCategory; // Lo·∫°i thu·∫ø (theo quy ƒë·ªãnh c·ªßa t·ª´ng h√£ng)
        private String description;
    }

    @Data @Builder @NoArgsConstructor @AllArgsConstructor
    public static class InvoiceSummary {
        private BigDecimal subtotalAmount;
        private BigDecimal totalDiscountAmount;
        private BigDecimal totalTaxAmount;
        private BigDecimal totalAmount; // T·ªïng ti·ªÅn thanh to√°n cu·ªëi c√πng
        private String currencyCode;
        private BigDecimal exchangeRate; // Th√™m ƒë·ªÉ h·ªó tr·ª£ h√≥a ƒë∆°n ngo·∫°i t·ªá
        private String amountInWords;
    }

    @Data @Builder @NoArgsConstructor @AllArgsConstructor
    public static class PaymentTerm {
        private String method; // TM, CK, TM/CK
        private LocalDate dueDate;
        private String description;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/model/InvoiceResponse.java">
package com.einvoicehub.core.provider.model;

import lombok.*;
import java.time.LocalDateTime;

/**
 * DTO ph·∫£n h·ªìi t·ª´ Provider - ƒê√£ chu·∫©n h√≥a d·ªØ li·ªáu tr·∫£ v·ªÅ.
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class InvoiceResponse {

    private String clientRequestId;
    private Long invoiceMetadataId;
    private ResponseStatus status;

    private String errorCode;
    private String errorMessage;

    /** M√£ ƒë·ªãnh danh giao d·ªãch ph√≠a Provider */
    private String transactionCode;
    private String invoiceNumber;
    private String symbolCode;
    private String templateCode;

    /** ƒê·ªìng b·ªô ki·ªÉu LocalDateTime ƒë·ªÉ x·ª≠ l√Ω m√∫i gi·ªù ch√≠nh x√°c */
    private LocalDateTime issueDate;

    private String lookupCode;   // M√£ tra c·ª©u
    private String securityCode; // M√£ x√°c th·ª±c/ch·ªØ k√Ω s·ªë

    private String pdfUrl;
    private String xmlData;      // D·ªØ li·ªáu XML g·ªëc (ph√°p l√Ω)
    private String portalUrl;    // Link tra c·ª©u h√≥a ƒë∆°n tr·ª±c ti·∫øp c·ªßa h√£ng

    private LocalDateTime responseTime;
    private Object rawResponse;  // D·ªØ li·ªáu th√¥ d√πng cho debug/audit

    public enum ResponseStatus {
        SUCCESS, PENDING, FAILED, TIMEOUT
    }

    public boolean isSuccessful() { return status == ResponseStatus.SUCCESS; }
    public boolean isFailed() { return status == ResponseStatus.FAILED; }
    public boolean isPending() { return status == ResponseStatus.PENDING; }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/InvoiceProvider.java">
package com.einvoicehub.core.provider;

import com.einvoicehub.core.entity.enums.InvoiceStatus;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;

public interface InvoiceProvider {
    String getProviderCode();
    String getProviderName();
    boolean isAvailable();

    InvoiceResponse issueInvoice(InvoiceRequest request, ProviderConfig config);
    InvoiceStatus getInvoiceStatus(String invoiceNumber, ProviderConfig config);
    InvoiceResponse cancelInvoice(String invoiceNumber, String reason, ProviderConfig config);
    InvoiceResponse replaceInvoice(String oldInvoiceNumber, InvoiceRequest newRequest, ProviderConfig config);

    /* Returns PDF content as Base64 or URL */
    String getInvoicePdf(String invoiceNumber, ProviderConfig config);

    /* Returns legal XML content as Base64 or String */
    String getInvoiceXml(String invoiceNumber, ProviderConfig config);

    String authenticate(ProviderConfig config);
    boolean testConnection(ProviderConfig config);
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/ProviderConfig.java">
package com.einvoicehub.core.provider;

import lombok.*;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ProviderConfig {
    private Long configId;
    private String providerCode;
    private String providerName;
    private String username;

    @ToString.Exclude
    private String password;

    private String appId;

    @ToString.Exclude
    private String secretKey;

    private String customApiUrl;
    private String certificateSerial;

    @ToString.Exclude
    private String certificateData;
    private LocalDateTime certificateExpiredAt;

    private String extraConfigJson;

    @ToString.Exclude
    private String accessToken;
    private LocalDateTime tokenExpiredAt;

    public boolean hasValidCertificate() {
        return certificateData != null && !certificateData.isEmpty() &&
                (certificateExpiredAt == null || certificateExpiredAt.isAfter(LocalDateTime.now()));
    }

    /* Check if token is valid with a 5-minute safety buffer */
    public boolean hasValidToken() {
        return accessToken != null && !accessToken.isEmpty() &&
                (tokenExpiredAt == null || tokenExpiredAt.isAfter(LocalDateTime.now().plusMinutes(5)));
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/ProviderFactory.java">
package com.einvoicehub.core.provider;

import com.einvoicehub.core.provider.exception.ProviderException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.Map;
import java.util.function.Function;
import java.util.stream.Collectors;

@Component
public class ProviderFactory {
    private final Map<String, InvoiceProvider> providerMap;

    @Autowired
    public ProviderFactory(List<InvoiceProvider> providers) {
        this.providerMap = providers.stream()
                .collect(Collectors.toUnmodifiableMap(
                        p -> p.getProviderCode().toUpperCase(),
                        Function.identity()
                ));
    }

    public InvoiceProvider getProvider(String providerCode) {
        if (providerCode == null) throw new ProviderException("Provider code cannot be null", "SYSTEM", "NULL_CODE");

        InvoiceProvider provider = providerMap.get(providerCode.toUpperCase());
        if (provider == null) {
            throw new ProviderException("Unsupported provider: " + providerCode, providerCode, "PROVIDER_NOT_FOUND");
        }
        return provider;
    }

    public boolean hasProvider(String providerCode) {
        return providerCode != null && providerMap.containsKey(providerCode.toUpperCase());
    }

    public List<String> getAvailableProviders() {
        return providerMap.values().stream()
                .filter(InvoiceProvider::isAvailable)
                .map(InvoiceProvider::getProviderCode)
                .collect(Collectors.toList());
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/repository/jpa/ApiCredentialRepository.java">
package com.einvoicehub.core.repository.jpa;

import com.einvoicehub.core.entity.jpa.ApiCredential;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;

@Repository
public interface ApiCredentialRepository extends JpaRepository<ApiCredential, Long> {

    Optional<ApiCredential> findByClientIdAndIsActiveTrue(String clientId);

    Optional<ApiCredential> findByClientId(String clientId);

    List<ApiCredential> findByMerchantId(Long merchantId);

    List<ApiCredential> findByMerchantIdAndIsActive(Long merchantId, Boolean isActive);

    Optional<ApiCredential> findByMerchantIdAndIsDefaultTrue(Long merchantId);

    boolean existsByClientId(String clientId);

    @Query("SELECT a FROM ApiCredential a WHERE a.apiKeyHash = :hash AND a.isActive = true")
    Optional<ApiCredential> findByApiKeyHash(@Param("hash") String hash);

    @Query("SELECT a FROM ApiCredential a WHERE a.merchant.id = :merchantId AND a.isActive = true " +
            "AND (a.expiredAt IS NULL OR a.expiredAt > :now)")
    List<ApiCredential> findValidCredentialsByMerchant(
            @Param("merchantId") Long merchantId,
            @Param("now") LocalDateTime now);

    @Modifying
    @Query("UPDATE ApiCredential a SET a.requestCountHour = 0 WHERE a.requestCountResettedAt < :threshold")
    int resetHourlyCounts(@Param("threshold") LocalDateTime threshold);

    @Modifying
    @Query("UPDATE ApiCredential a SET a.requestCountDay = 0, a.requestCountHour = 0, " +
            "a.requestCountResettedAt = :now WHERE a.requestCountResettedAt < :threshold")
    int resetDailyCounts(@Param("threshold") LocalDateTime threshold, @Param("now") LocalDateTime now);

    @Query("SELECT COUNT(a) FROM ApiCredential a WHERE a.merchant.id = :merchantId AND a.isActive = true")
    long countActiveCredentialsByMerchant(@Param("merchantId") Long merchantId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/repository/jpa/InvoiceItemRepository.java">
package com.einvoicehub.core.repository.jpa;

import com.einvoicehub.core.entity.jpa.InvoiceItem;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.math.BigDecimal;
import java.util.List;

@Repository
public interface InvoiceItemRepository extends JpaRepository<InvoiceItem, Long> {

    List<InvoiceItem> findByInvoicePayloadIdOrderByLineNumberAsc(Long invoicePayloadId);

    void deleteByInvoicePayloadId(Long invoicePayloadId);

    long countByInvoicePayloadId(Long invoicePayloadId);

    @Query("SELECT COALESCE(SUM(ii.amount), 0) FROM InvoiceItem ii WHERE ii.invoicePayloadId = :invoicePayloadId")
    BigDecimal sumAmountByInvoicePayloadId(@Param("invoicePayloadId") Long invoicePayloadId);

    @Query("SELECT COALESCE(SUM(ii.vatAmount), 0) FROM InvoiceItem ii WHERE ii.invoicePayloadId = :invoicePayloadId")
    BigDecimal sumVatAmountByInvoicePayloadId(@Param("invoicePayloadId") Long invoicePayloadId);

    @Query("SELECT COALESCE(SUM(ii.totalAmount), 0) FROM InvoiceItem ii WHERE ii.invoicePayloadId = :invoicePayloadId")
    BigDecimal sumTotalAmountByInvoicePayloadId(@Param("invoicePayloadId") Long invoicePayloadId);

    List<InvoiceItem> findByInvoicePayloadIdAndItemCode(Long invoicePayloadId, String itemCode);

    @Query(value = "SELECT ii.* FROM invoice_items ii " +
            "INNER JOIN invoice_payloads ip ON ii.invoice_payload_id = ip.id " +
            "WHERE JSON_EXTRACT(ip.extra_data, '$.buyer.taxCode') = :buyerTaxCode " +
            "ORDER BY ii.invoice_payload_id, ii.line_number",
            nativeQuery = true)
    List<InvoiceItem> findByBuyerTaxCode(@Param("buyerTaxCode") String buyerTaxCode);
}
</file>

<file path="src/main/java/com/einvoicehub/core/repository/jpa/InvoiceMetadataRepository.java">
package com.einvoicehub.core.repository.jpa;

import com.einvoicehub.core.entity.jpa.InvoiceMetadata;
import com.einvoicehub.core.entity.enums.InvoiceStatus;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;

/**
 * Repository cho InvoiceMetadata entity
 */
@Repository
public interface InvoiceMetadataRepository
        extends JpaRepository<InvoiceMetadata, Long>, JpaSpecificationExecutor<InvoiceMetadata> {

    Page<InvoiceMetadata> findByMerchantIdAndIsDeletedFalse(Long merchantId, Pageable pageable);

    List<InvoiceMetadata> findByMerchantIdAndStatus(Long merchantId, InvoiceStatus status);

    Optional<InvoiceMetadata> findByIdAndIsDeletedFalse(Long id);

    Optional<InvoiceMetadata> findByMerchantIdAndClientRequestId(Long merchantId, String clientRequestId);

    Optional<InvoiceMetadata> findByInvoiceNumberAndIsDeletedFalse(String invoiceNumber);

    List<InvoiceMetadata> findByMerchantIdAndIssueDateBetween(
            Long merchantId, LocalDate fromDate, LocalDate toDate);

    List<InvoiceMetadata> findByMerchantIdAndCreatedAtBetween(
            Long merchantId, LocalDateTime fromDate, LocalDateTime toDate);

    @Query("SELECT i FROM InvoiceMetadata i WHERE i.merchant.id = :merchantId " +
            "AND i.status IN :statuses ORDER BY i.createdAt DESC")
    List<InvoiceMetadata> findByMerchantAndStatuses(
            @Param("merchantId") Long merchantId,
            @Param("statuses") List<InvoiceStatus> statuses);

    @Query("SELECT COUNT(i) FROM InvoiceMetadata i WHERE i.merchant.id = :merchantId " +
            "AND i.status = :status AND i.isDeleted = false")
    long countByMerchantAndStatus(
            @Param("merchantId") Long merchantId,
            @Param("status") InvoiceStatus status);

    @Query("SELECT COUNT(i) FROM InvoiceMetadata i WHERE i.merchant.id = :merchantId " +
            "AND i.isDeleted = false AND i.createdAt >= :fromDate")
    long countByMerchantSince(
            @Param("merchantId") Long merchantId,
            @Param("fromDate") LocalDateTime fromDate);

    @Query("SELECT i FROM InvoiceMetadata i WHERE i.merchant.id = :merchantId " +
            "AND i.buyerTaxCode = :taxCode AND i.isDeleted = false " +
            "ORDER BY i.createdAt DESC")
    Page<InvoiceMetadata> findByMerchantAndBuyerTaxCode(
            @Param("merchantId") Long merchantId,
            @Param("taxCode") String taxCode,
            Pageable pageable);

    @Query("SELECT i FROM InvoiceMetadata i WHERE i.merchant.id = :merchantId " +
            "AND (i.invoiceNumber LIKE %:keyword% OR i.buyerName LIKE %:keyword%) " +
            "AND i.isDeleted = false ORDER BY i.createdAt DESC")
    Page<InvoiceMetadata> searchByKeyword(
            @Param("merchantId") Long merchantId,
            @Param("keyword") String keyword,
            Pageable pageable);

    @Query("SELECT i FROM InvoiceMetadata i WHERE i.merchant.id = :merchantId " +
            "AND i.status = :status AND i.createdAt < :before")
    List<InvoiceMetadata> findPendingInvoicesOlderThan(
            @Param("merchantId") Long merchantId,
            @Param("status") InvoiceStatus status,
            @Param("before") LocalDateTime before);

    @Query("SELECT DISTINCT i.providerId FROM InvoiceMetadata i WHERE i.providerId IS NOT NULL")
    List<Long> findDistinctProviderIds();

    @Query("SELECT i FROM InvoiceMetadata i WHERE i.merchant.id = :merchantId " +
            "AND i.provider.id = :providerId ORDER BY i.createdAt DESC")
    List<InvoiceMetadata> findByMerchantAndProvider(
            @Param("merchantId") Long merchantId,
            @Param("providerId") Long providerId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/repository/jpa/InvoicePayloadRepository.java">
package com.einvoicehub.core.repository.jpa;

import com.einvoicehub.core.entity.jpa.InvoicePayload;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;

@Repository
public interface InvoicePayloadRepository extends JpaRepository<InvoicePayload, Long> {

    Optional<InvoicePayload> findByClientRequestId(String clientRequestId);

    Optional<InvoicePayload> findByTransactionId(String transactionId);

    Optional<InvoicePayload> findByInvoiceId(Long invoiceId);

    Page<InvoicePayload> findByMerchantIdOrderByCreatedAtDesc(Long merchantId, Pageable pageable);

    List<InvoicePayload> findByMerchantId(Long merchantId);

    Optional<InvoicePayload> findByClientRequestIdAndMerchantId(String clientRequestId, Long merchantId);

    @Query("SELECT ip FROM InvoicePayload ip WHERE ip.merchantId = :merchantId " +
            "AND ip.createdAt >= :fromDate AND ip.createdAt <= :toDate")
    List<InvoicePayload> findByMerchantIdAndCreatedAtBetween(
            @Param("merchantId") Long merchantId,
            @Param("fromDate") LocalDateTime fromDate,
            @Param("toDate") LocalDateTime toDate);

    @Query(value = "SELECT * FROM invoice_payloads ip " +
            "WHERE ip.merchant_id = :merchantId " +
            "AND JSON_EXTRACT(ip.extra_data, '$.buyer.taxCode') = :buyerTaxCode",
            nativeQuery = true)
    List<InvoicePayload> findByMerchantIdAndBuyerTaxCode(
            @Param("merchantId") Long merchantId,
            @Param("buyerTaxCode") String buyerTaxCode);

    long countByMerchantId(Long merchantId);

    long countByMerchantIdAndStatus(Long merchantId, String status);

    void deleteByMerchantId(Long merchantId);

    List<InvoicePayload> findByProviderCodeAndStatus(String providerCode, String status);

    List<InvoicePayload> findTop10ByMerchantIdOrderByCreatedAtDesc(Long merchantId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/repository/jpa/MerchantProviderConfigRepository.java">
package com.einvoicehub.core.repository.jpa;

import com.einvoicehub.core.entity.jpa.MerchantProviderConfig;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

/**
 * Repository cho MerchantProviderConfig entity
 */
@Repository
public interface MerchantProviderConfigRepository extends JpaRepository<MerchantProviderConfig, Long> {

    List<MerchantProviderConfig> findByMerchantId(Long merchantId);

    List<MerchantProviderConfig> findByMerchantIdAndIsActive(Long merchantId, Boolean isActive);

    Optional<MerchantProviderConfig> findByMerchantIdAndProviderId(Long merchantId, Long providerId);

    Optional<MerchantProviderConfig> findByMerchantIdAndIsDefaultTrue(Long merchantId);

    @Query("SELECT c FROM MerchantProviderConfig c WHERE c.merchant.id = :merchantId " +
            "AND c.provider.id = :providerId AND c.isActive = true")
    Optional<MerchantProviderConfig> findActiveConfig(
            @Param("merchantId") Long merchantId,
            @Param("providerId") Long providerId);

    @Query("SELECT c FROM MerchantProviderConfig c JOIN FETCH c.provider " +
            "WHERE c.merchant.id = :merchantId AND c.isActive = true")
    List<MerchantProviderConfig> findActiveConfigsByMerchant(@Param("merchantId") Long merchantId);

    @Query("SELECT c FROM MerchantProviderConfig c WHERE c.isActive = true " +
            "AND c.isDefault = true AND c.merchant.id = :merchantId")
    Optional<MerchantProviderConfig> findDefaultConfig(@Param("merchantId") Long merchantId);

    boolean existsByMerchantIdAndProviderId(Long merchantId, Long providerId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/repository/jpa/MerchantRepository.java">
package com.einvoicehub.core.repository.jpa;

import com.einvoicehub.core.entity.jpa.Merchant;
import com.einvoicehub.core.entity.enums.EntityStatus;
import com.einvoicehub.core.entity.enums.SubscriptionPlan;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;

@Repository
public interface MerchantRepository extends JpaRepository<Merchant, Long> {

    Optional<Merchant> findByTaxCodeAndIsDeletedFalse(String taxCode);

    Optional<Merchant> findByIdAndIsDeletedFalse(Long id);

    List<Merchant> findByStatus(EntityStatus status);

    List<Merchant> findBySubscriptionPlan(SubscriptionPlan plan);

    List<Merchant> findByStatusAndSubscriptionPlan(EntityStatus status, SubscriptionPlan plan);

    boolean existsByTaxCode(String taxCode);

    boolean existsByEmail(String email);

    @Query("SELECT m FROM Merchant m WHERE m.isDeleted = false AND m.status = :status " +
            "AND m.subscriptionPlan = :plan")
    List<Merchant> findActiveMerchantsByPlan(
            @Param("status") EntityStatus status,
            @Param("plan") SubscriptionPlan plan);

    @Query("SELECT COUNT(m) FROM Merchant m WHERE m.isDeleted = false AND m.status = :status")
    long countByStatus(@Param("status") EntityStatus status);

    @Query("SELECT m FROM Merchant m WHERE m.createdAt >= :fromDate AND m.createdAt <= :toDate")
    List<Merchant> findMerchantsCreatedBetween(
            @Param("fromDate") LocalDateTime fromDate,
            @Param("toDate") LocalDateTime toDate);

    @Query("SELECT m FROM Merchant m LEFT JOIN FETCH m.users WHERE m.id = :id")
    Optional<Merchant> findByIdWithUsers(@Param("id") Long id);

    @Query("SELECT m FROM Merchant m LEFT JOIN FETCH m.providerConfigs WHERE m.id = :id")
    Optional<Merchant> findByIdWithConfigs(@Param("id") Long id);
}
</file>

<file path="src/main/java/com/einvoicehub/core/repository/jpa/MerchantUserRepository.java">
package com.einvoicehub.core.repository.jpa;

import com.einvoicehub.core.entity.jpa.MerchantUser;
import com.einvoicehub.core.entity.enums.UserRole;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Optional;

@Repository
public interface MerchantUserRepository extends JpaRepository<MerchantUser, Long> {

    Optional<MerchantUser> findByUsernameAndIsActiveTrue(String username);

    Optional<MerchantUser> findByEmailAndIsActiveTrue(String email);

    List<MerchantUser> findByMerchantId(Long merchantId);

    List<MerchantUser> findByMerchantIdAndIsActive(Long merchantId, Boolean isActive);

    List<MerchantUser> findByMerchantIdAndRole(Long merchantId, UserRole role);

    Optional<MerchantUser> findByMerchantIdAndIsPrimaryTrue(Long merchantId);

    boolean existsByUsername(String username);

    boolean existsByEmail(String email);

    @Query("SELECT u FROM MerchantUser u WHERE u.merchant.id = :merchantId AND u.role = :role")
    List<MerchantUser> findByMerchantAndRole(
            @Param("merchantId") Long merchantId,
            @Param("role") UserRole role);

    @Query("SELECT COUNT(u) FROM MerchantUser u WHERE u.merchant.id = :merchantId AND u.isActive = true")
    long countActiveUsersByMerchant(@Param("merchantId") Long merchantId);

    @Query("SELECT u FROM MerchantUser u WHERE u.merchant.taxCode = :taxCode AND u.isActive = true")
    List<MerchantUser> findActiveUsersByMerchantTaxCode(@Param("taxCode") String taxCode);

    @Query("SELECT u FROM MerchantUser u WHERE u.isActive = true AND u.lockedUntil > :now")
    List<MerchantUser> findLockedUsers(@Param("now") LocalDateTime now);

    @Query("SELECT u FROM MerchantUser u WHERE u.lastLoginAt >= :since")
    List<MerchantUser> findRecentlyActiveUsers(@Param("since") LocalDateTime since);
}
</file>

<file path="src/main/java/com/einvoicehub/core/repository/jpa/ProviderTransactionRepository.java">
package com.einvoicehub.core.repository.jpa;

import com.einvoicehub.core.entity.jpa.ProviderTransaction;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.time.LocalDateTime;
import java.util.List;

@Repository
public interface ProviderTransactionRepository extends JpaRepository<ProviderTransaction, Long> {

    Page<ProviderTransaction> findByMerchantIdOrderByTimestampDesc(Long merchantId, Pageable pageable);

    List<ProviderTransaction> findByInvoiceMetadataIdOrderByTimestampDesc(Long invoiceMetadataId);

    List<ProviderTransaction> findByMerchantIdAndTimestampBetween(
            Long merchantId, LocalDateTime fromDate, LocalDateTime toDate);

    List<ProviderTransaction> findByStatus(ProviderTransaction.TransactionStatus status);

    @Query("SELECT pt FROM ProviderTransaction pt WHERE pt.merchantId = :merchantId " +
            "AND pt.status = :status AND pt.timestamp < :before")
    List<ProviderTransaction> findFailedTransactionsOlderThan(
            @Param("merchantId") Long merchantId,
            @Param("status") ProviderTransaction.TransactionStatus status,
            @Param("before") LocalDateTime before);

    List<ProviderTransaction> findByInvoiceMetadataIdAndTransactionType(
            Long invoiceMetadataId,
            ProviderTransaction.TransactionType transactionType);

    long countByMerchantIdAndStatus(Long merchantId, ProviderTransaction.TransactionStatus status);

    @Query("SELECT pt FROM ProviderTransaction pt WHERE pt.merchantId = :merchantId " +
            "ORDER BY pt.timestamp DESC")
    List<ProviderTransaction> findRecentByMerchant(@Param("merchantId") Long merchantId);

    List<ProviderTransaction> findByTransactionId(String transactionId);

    List<ProviderTransaction> findByProviderCodeAndStatus(
            String providerCode,
            ProviderTransaction.TransactionStatus status);

    long countByStatus(ProviderTransaction.TransactionStatus status);

    @Query("SELECT pt FROM ProviderTransaction pt WHERE pt.status = 'RETRYING' " +
            "AND pt.nextRetryAt <= :now ORDER BY pt.nextRetryAt ASC")
    List<ProviderTransaction> findTransactionsForRetry(@Param("now") LocalDateTime now);

    @Query("SELECT pt.status, COUNT(pt) FROM ProviderTransaction pt " +
            "WHERE pt.merchantId = :merchantId GROUP BY pt.status")
    List<Object[]> getTransactionStatsByMerchant(@Param("merchantId") Long merchantId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/repository/jpa/ServiceProviderRepository.java">
package com.einvoicehub.core.repository.jpa;

import com.einvoicehub.core.entity.jpa.ServiceProvider;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface ServiceProviderRepository extends JpaRepository<ServiceProvider, Long> {

    Optional<ServiceProvider> findByProviderCode(String providerCode);

    List<ServiceProvider> findByIsActiveTrue();

    Optional<ServiceProvider> findByIsActiveTrueAndIsDefaultTrue();

    List<ServiceProvider> findByIsActiveTrueOrderByDisplayOrderAsc();

    @Query("SELECT s FROM ServiceProvider s WHERE s.isActive = true ORDER BY s.displayOrder ASC")
    List<ServiceProvider> findActiveProvidersOrdered();

    @Query("SELECT s FROM ServiceProvider s WHERE s.providerCode IN :codes")
    List<ServiceProvider> findByProviderCodes(@Param("codes") List<String> codes);

    boolean existsByProviderCode(String providerCode);
}
</file>

<file path="src/main/java/com/einvoicehub/core/security/ApiKeyAuthenticationToken.java">
package com.einvoicehub.core.security;

import com.einvoicehub.core.entity.jpa.ApiCredential;
import com.einvoicehub.core.entity.jpa.Merchant;
import lombok.Getter;
import org.springframework.security.authentication.AbstractAuthenticationToken;
import org.springframework.security.core.GrantedAuthority;

import java.util.Collection;

@Getter
public class ApiKeyAuthenticationToken extends AbstractAuthenticationToken {

    private final String clientId;
    private final String apiKey;
    private final ApiCredential credential;
    private final Merchant merchant;

    public ApiKeyAuthenticationToken(String clientId, String apiKey,
                                     ApiCredential credential, Merchant merchant,
                                     Collection<? extends GrantedAuthority> authorities) {
        super(authorities);
        this.clientId = clientId;
        this.apiKey = apiKey;
        this.credential = credential;
        this.merchant = merchant;
        setAuthenticated(authorities != null && !authorities.isEmpty());
    }

    @Override
    public Object getCredentials() {
        return apiKey;
    }

    @Override
    public Object getPrincipal() {
        return clientId;
    }

    public Long getMerchantId() {
        return merchant != null ? merchant.getId() : null;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/security/ApiKeyFilter.java">
package com.einvoicehub.core.security;

import com.einvoicehub.core.common.exception.ErrorCode;
import com.einvoicehub.core.dto.response.ApiResponse;
import com.einvoicehub.core.entity.enums.EntityStatus;
import com.einvoicehub.core.entity.jpa.ApiCredential;
import com.einvoicehub.core.entity.jpa.Merchant;
import com.einvoicehub.core.repository.jpa.ApiCredentialRepository;
import com.fasterxml.jackson.databind.ObjectMapper;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.MediaType;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.util.AntPathMatcher;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.*;

@Slf4j
@Component
@RequiredArgsConstructor
public class ApiKeyFilter extends OncePerRequestFilter {

    private static final String API_KEY_HEADER = "X-API-KEY";
    private static final String CLIENT_ID_HEADER = "X-CLIENT-ID";

    private final ApiCredentialRepository apiCredentialRepository;
    private final ObjectMapper objectMapper;
    private final AntPathMatcher pathMatcher = new AntPathMatcher();

    private static final Set<String> PUBLIC_PATHS = Set.of(
            "/api/v1/auth/**",
            "/api/v1/health/**",
            "/api/v1/public/**",
            "/actuator/**"
    );

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response,
                                    FilterChain filterChain) throws ServletException, IOException {

        if (isPublicPath(request.getRequestURI())) {
            filterChain.doFilter(request, response);
            return;
        }

        String clientId = request.getHeader(CLIENT_ID_HEADER);
        String apiKey = request.getHeader(API_KEY_HEADER);

        if (clientId == null || apiKey == null) {
            writeErrorResponse(response, ErrorCode.UNAUTHENTICATED, "Missing security headers");
            return;
        }

        ApiCredential credential = apiCredentialRepository
                .findByClientIdAndIsActiveTrue(clientId)
                .orElse(null);

        if (credential == null || !hashApiKey(apiKey).equals(credential.getApiKeyHash())) {
            writeErrorResponse(response, ErrorCode.API_KEY_INVALID, "Invalid credentials");
            return;
        }

        if (!credential.isValid()) {
            writeErrorResponse(response, ErrorCode.API_KEY_INVALID, "Credential expired or inactive");
            return;
        }

        /* IP Whitelist validation */
        if (credential.getIpWhitelist() != null && !credential.getIpWhitelist().isBlank()) {
            String clientIp = getClientIp(request);
            if (!isIpAllowed(clientIp, credential.getIpWhitelist())) {
                writeErrorResponse(response, ErrorCode.UNAUTHORIZED, "IP address not whitelisted");
                return;
            }
        }

        /* Rate limit validation */
        if (!credential.canMakeRequest()) {
            writeErrorResponse(response, ErrorCode.VALIDATION_ERROR, "Rate limit exceeded");
            return;
        }

        Merchant merchant = credential.getMerchant();
        if (merchant == null || merchant.getIsDeleted() || merchant.getStatus() != EntityStatus.ACTIVE) {
            writeErrorResponse(response, ErrorCode.UNAUTHORIZED, "Merchant account is inactive");
            return;
        }

        List<SimpleGrantedAuthority> authorities = buildAuthorities(credential.getScopes());
        ApiKeyAuthenticationToken auth = new ApiKeyAuthenticationToken(clientId, apiKey, credential, merchant, authorities);

        credential.incrementRequestCount();
        apiCredentialRepository.save(credential);

        SecurityContextHolder.getContext().setAuthentication(auth);
        filterChain.doFilter(request, response);
    }

    private boolean isPublicPath(String path) {
        return PUBLIC_PATHS.stream().anyMatch(pattern -> pathMatcher.match(pattern, path));
    }

    private String hashApiKey(String apiKey) {
        try {
            MessageDigest digest = MessageDigest.getInstance("SHA-256");
            byte[] hash = digest.digest(apiKey.getBytes(StandardCharsets.UTF_8));
            return HexFormat.of().formatHex(hash);
        } catch (NoSuchAlgorithmException e) {
            throw new RuntimeException("SHA-256 not available", e);
        }
    }

    private String getClientIp(HttpServletRequest request) {
        String xf = request.getHeader("X-Forwarded-For");
        return (xf != null) ? xf.split(",")[0].trim() : request.getRemoteAddr();
    }

    private boolean isIpAllowed(String clientIp, String whitelist) {
        return Arrays.stream(whitelist.split(","))
                .map(String::trim)
                .anyMatch(allowed -> allowed.equals(clientIp));
    }

    private List<SimpleGrantedAuthority> buildAuthorities(String scopes) {
        if (scopes == null || scopes.isBlank()) return List.of(new SimpleGrantedAuthority("ROLE_API"));
        return Arrays.stream(scopes.split(","))
                .map(s -> new SimpleGrantedAuthority("SCOPE_" + s.trim().toUpperCase().replace(".", "_")))
                .toList();
    }

    private void writeErrorResponse(HttpServletResponse response, ErrorCode errorCode, String message) throws IOException {
        response.setStatus(errorCode.getStatusCode().value());
        response.setContentType(MediaType.APPLICATION_JSON_VALUE);
        ApiResponse<?> apiResponse = ApiResponse.error(errorCode, message);
        response.getWriter().write(objectMapper.writeValueAsString(apiResponse));
    }

    @Override
    protected boolean shouldNotFilter(HttpServletRequest request) {
        return !request.getRequestURI().startsWith("/api/");
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/security/JwtAuthenticationFilter.java">
package com.einvoicehub.core.security;

import com.einvoicehub.core.entity.jpa.MerchantUser;
import com.einvoicehub.core.repository.jpa.MerchantUserRepository;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.List;

@Slf4j
@Component
@RequiredArgsConstructor
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    private static final String AUTHORIZATION_HEADER = "Authorization";
    private static final String BEARER_PREFIX = "Bearer ";

    private final JwtTokenProvider jwtTokenProvider;
    private final MerchantUserRepository userRepository;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response,
                                    FilterChain filterChain) throws ServletException, IOException {
        try {
            String jwt = extractJwt(request);

            if (StringUtils.hasText(jwt) && jwtTokenProvider.validateToken(jwt)) {
                String username = jwtTokenProvider.getUsernameFromToken(jwt);

                MerchantUser user = userRepository.findByUsernameAndIsActiveTrue(username).orElse(null);

                if (user != null && !user.isLocked()) {
                    List<SimpleGrantedAuthority> authorities = List.of(
                            new SimpleGrantedAuthority("ROLE_" + user.getRole().name())
                    );

                    UsernamePasswordAuthenticationToken auth = new UsernamePasswordAuthenticationToken(user, null, authorities);
                    auth.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));

                    SecurityContextHolder.getContext().setAuthentication(auth);
                    log.debug("Authenticated user: {} via JWT", username);
                }
            }
        } catch (Exception e) {
            log.error("Failed to set user authentication: {}", e.getMessage());
        }

        filterChain.doFilter(request, response);
    }

    private String extractJwt(HttpServletRequest request) {
        String bearerToken = request.getHeader(AUTHORIZATION_HEADER);
        if (StringUtils.hasText(bearerToken) && bearerToken.startsWith(BEARER_PREFIX)) {
            return bearerToken.substring(BEARER_PREFIX.length());
        }
        return null;
    }

    @Override
    protected boolean shouldNotFilter(HttpServletRequest request) {
        String path = request.getRequestURI();
        return !path.startsWith("/api/v1/admin/") && !path.startsWith("/api/v1/auth/");
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/security/JwtTokenProvider.java">
package com.einvoicehub.core.security;

import io.jsonwebtoken.*;
import io.jsonwebtoken.security.Keys;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import javax.crypto.SecretKey;
import java.nio.charset.StandardCharsets;
import java.util.Date;

@Slf4j
@Component
public class JwtTokenProvider {

    private final SecretKey signingKey;
    private final long expirationMs;

    public JwtTokenProvider(@Value("${app.jwt.secret}") String secret,
                            @Value("${app.jwt.expiration-ms:86400000}") long expirationMs) {
        this.signingKey = Keys.hmacShaKeyFor(secret.getBytes(StandardCharsets.UTF_8));
        this.expirationMs = expirationMs;
    }

    public String generateToken(String username, String role) {
        Date now = new Date();
        Date expiryDate = new Date(now.getTime() + expirationMs);

        return Jwts.builder()
                .subject(username)
                .claim("role", role)
                .issuedAt(now)
                .expiration(expiryDate)
                .signWith(signingKey)
                .compact();
    }

    public String getUsernameFromToken(String token) {
        return Jwts.parser()
                .verifyWith(signingKey)
                .build()
                .parseSignedClaims(token)
                .getPayload()
                .getSubject();
    }

    public boolean validateToken(String token) {
        try {
            Jwts.parser().verifyWith(signingKey).build().parseSignedClaims(token);
            return true;
        } catch (MalformedJwtException e) {
            log.error("Invalid JWT token structure");
        } catch (ExpiredJwtException e) {
            log.error("JWT token has expired");
        } catch (UnsupportedJwtException e) {
            log.error("JWT token type is unsupported");
        } catch (IllegalArgumentException e) {
            log.error("JWT claims string is empty");
        } catch (JwtException e) {
            log.error("JWT validation error: {}", e.getMessage());
        }
        return false;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/security/SecurityConfig.java">
package com.einvoicehub.core.security;

import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.annotation.Order;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
@EnableWebSecurity
@EnableMethodSecurity
@RequiredArgsConstructor
public class SecurityConfig {

    private final ApiKeyFilter apiKeyFilter;
    private final JwtAuthenticationFilter jwtAuthenticationFilter;

    @Bean
    @Order(1)
    public SecurityFilterChain apiSecurityFilterChain(HttpSecurity http) throws Exception {
        http
                .securityMatcher("/api/v1/invoices/**", "/api/v1/merchants/**", "/api/v1/configs/**")
                .csrf(AbstractHttpConfigurer::disable)
                .sessionManagement(s -> s.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(auth -> auth.anyRequest().authenticated())
                .addFilterBefore(apiKeyFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    @Bean
    @Order(2)
    public SecurityFilterChain adminSecurityFilterChain(HttpSecurity http) throws Exception {
        http
                .securityMatcher("/api/v1/admin/**", "/api/v1/portal/**")
                .csrf(AbstractHttpConfigurer::disable)
                .sessionManagement(s -> s.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/api/v1/auth/login").permitAll()
                        .requestMatchers("/api/v1/admin/users/**").hasRole("ADMIN")
                        .anyRequest().authenticated())
                .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    @Bean
    @Order(3)
    public SecurityFilterChain defaultSecurityFilterChain(HttpSecurity http) throws Exception {
        http
                .csrf(AbstractHttpConfigurer::disable)
                .sessionManagement(s -> s.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/actuator/**", "/api/v1/public/**").permitAll()
                        .anyRequest().denyAll());

        return http.build();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/InvoicePayloadService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.entity.jpa.InvoicePayload;
import com.einvoicehub.core.repository.jpa.InvoicePayloadRepository;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;
import java.util.Optional;

@Slf4j
@Service
@RequiredArgsConstructor
public class InvoicePayloadService {

    private final InvoicePayloadRepository invoicePayloadRepository;
    private final ObjectMapper objectMapper;

    @Transactional
    public InvoicePayload savePayload(InvoicePayload invoicePayload) {
        log.info("ƒêang l∆∞u payload h√≥a ƒë∆°n cho clientRequestId: {}",
                invoicePayload.getClientRequestId());
        InvoicePayload savedPayload = invoicePayloadRepository.save(invoicePayload);
        log.info("ƒê√£ l∆∞u payload h√≥a ƒë∆°n th√†nh c√¥ng v·ªõi ID: {}", savedPayload.getId());
        return savedPayload;
    }

    @Transactional
    public InvoicePayload createPayloadFromRequest(
            Long merchantId,
            String clientRequestId,
            String providerCode,
            Map<String, Object> requestData) {
        InvoicePayload payload = InvoicePayload.builder()
                .merchantId(merchantId)
                .clientRequestId(clientRequestId)
                .providerCode(providerCode)
                .rawData(convertToJson(requestData))
                .status("PENDING")
                .createdAt(LocalDateTime.now())
                .build();
        return savePayload(payload);
    }

    @Transactional
    public InvoicePayload updatePayloadWithResponse(
            String clientRequestId,
            String responseData,
            String status) {
        log.info("ƒêang c·∫≠p nh·∫≠t payload h√≥a ƒë∆°n cho clientRequestId: {} v·ªõi tr·∫°ng th√°i: {}",
                clientRequestId, status);
        Optional<InvoicePayload> existingPayload = invoicePayloadRepository
                .findByClientRequestId(clientRequestId);
        if (existingPayload.isEmpty()) {
            log.error("Kh√¥ng t√¨m th·∫•y payload v·ªõi clientRequestId: {}", clientRequestId);
            throw new RuntimeException("Kh√¥ng t√¨m th·∫•y payload v·ªõi clientRequestId: " + clientRequestId);
        }
        InvoicePayload payload = existingPayload.get();
        payload.setResponseRaw(responseData);
        payload.setStatus(status);
        payload.setUpdatedAt(LocalDateTime.now());
        InvoicePayload updatedPayload = invoicePayloadRepository.save(payload);
        log.info("ƒê√£ c·∫≠p nh·∫≠t payload h√≥a ƒë∆°n th√†nh c√¥ng cho clientRequestId: {}", clientRequestId);
        return updatedPayload;
    }

    // Trong c√°c ph∆∞∆°ng th·ª©c updateStatus, updateInvoiceId, updateXmlContent...
    @Transactional
    public void updateStatus(String clientRequestId, String status) {
        InvoicePayload payload = invoicePayloadRepository
                .findByClientRequestId(clientRequestId)
                .orElseThrow(() -> new AppException(ErrorCode.VALIDATION_ERROR, "Kh√¥ng t√¨m th·∫•y Payload v·ªõi requestId: " + clientRequestId));
        payload.setStatus(status);
        payload.setUpdatedAt(LocalDateTime.now());
        invoicePayloadRepository.save(payload);
    }

    @Transactional
    public void updateInvoiceId(String clientRequestId, Long invoiceId) {
        log.info("C·∫≠p nh·∫≠t invoiceId: {} cho clientRequestId: {}", invoiceId, clientRequestId);
        InvoicePayload payload = invoicePayloadRepository
                .findByClientRequestId(clientRequestId)
                .orElseThrow(() -> new RuntimeException(
                        "Kh√¥ng t√¨m th·∫•y payload v·ªõi clientRequestId: " + clientRequestId));
        payload.setInvoiceId(invoiceId);
        payload.setUpdatedAt(LocalDateTime.now());
        invoicePayloadRepository.save(payload);
    }

    @Transactional
    public void updateXmlContent(String clientRequestId, String xmlContent) {
        log.info("C·∫≠p nh·∫≠t XML content cho clientRequestId: {}", clientRequestId);
        InvoicePayload payload = invoicePayloadRepository
                .findByClientRequestId(clientRequestId)
                .orElseThrow(() -> new RuntimeException(
                        "Kh√¥ng t√¨m th·∫•y payload v·ªõi clientRequestId: " + clientRequestId));
        payload.setXmlContent(xmlContent);
        payload.setUpdatedAt(LocalDateTime.now());
        invoicePayloadRepository.save(payload);
    }

    @Transactional
    public void updateSignedXml(String clientRequestId, String signedXml) {
        log.info("C·∫≠p nh·∫≠t Signed XML cho clientRequestId: {}", clientRequestId);
        InvoicePayload payload = invoicePayloadRepository
                .findByClientRequestId(clientRequestId)
                .orElseThrow(() -> new RuntimeException(
                        "Kh√¥ng t√¨m th·∫•y payload v·ªõi clientRequestId: " + clientRequestId));
        payload.setSignedXml(signedXml);
        payload.setUpdatedAt(LocalDateTime.now());
        invoicePayloadRepository.save(payload);
    }

    @Transactional
    public void updateJsonContent(String clientRequestId, String jsonContent) {
        log.info("C·∫≠p nh·∫≠t JSON content cho clientRequestId: {}", clientRequestId);
        InvoicePayload payload = invoicePayloadRepository
                .findByClientRequestId(clientRequestId)
                .orElseThrow(() -> new RuntimeException(
                        "Kh√¥ng t√¨m th·∫•y payload v·ªõi clientRequestId: " + clientRequestId));
        payload.setJsonContent(jsonContent);
        payload.setUpdatedAt(LocalDateTime.now());
        invoicePayloadRepository.save(payload);
    }

    public Optional<InvoicePayload> findByClientRequestId(String clientRequestId) {
        log.debug("ƒêang t√¨m ki·∫øm payload v·ªõi clientRequestId: {}", clientRequestId);
        return invoicePayloadRepository.findByClientRequestId(clientRequestId);
    }

    public Optional<InvoicePayload> findByTransactionId(String transactionId) {
        log.debug("ƒêang t√¨m ki·∫øm payload v·ªõi transactionId: {}", transactionId);
        return invoicePayloadRepository.findByTransactionId(transactionId);
    }

    public Optional<InvoicePayload> findByInvoiceId(Long invoiceId) {
        log.debug("ƒêang t√¨m ki·∫øm payload v·ªõi invoiceId: {}", invoiceId);
        return invoicePayloadRepository.findByInvoiceId(invoiceId);
    }

    public Page<InvoicePayload> findByMerchantId(Long merchantId, Pageable pageable) {
        log.debug("ƒêang l·∫•y danh s√°ch payload cho merchantId: {}", merchantId);
        return invoicePayloadRepository.findByMerchantIdOrderByCreatedAtDesc(merchantId, pageable);
    }

    public List<InvoicePayload> findAllByMerchantId(Long merchantId) {
        log.debug("ƒêang l·∫•y t·∫•t c·∫£ payload cho merchantId: {}", merchantId);
        return invoicePayloadRepository.findByMerchantId(merchantId);
    }

    public List<InvoicePayload> findByMerchantIdAndDateRange(
            Long merchantId,
            LocalDateTime fromDate,
            LocalDateTime toDate) {
        log.debug("T√¨m payload merchantId: {} t·ª´ {} ƒë·∫øn {}", merchantId, fromDate, toDate);
        return invoicePayloadRepository.findByMerchantIdAndCreatedAtBetween(
                merchantId, fromDate, toDate);
    }

    public long countByMerchantId(Long merchantId) {
        return invoicePayloadRepository.countByMerchantId(merchantId);
    }

    public long countByMerchantIdAndStatus(Long merchantId, String status) {
        return invoicePayloadRepository.countByMerchantIdAndStatus(merchantId, status);
    }

    private String convertToJson(Map<String, Object> data) {
        if (data == null) {
            return null;
        }
        try {
            return objectMapper.writeValueAsString(data);
        } catch (JsonProcessingException e) {
            log.error("L·ªói khi chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu sang JSON", e);
            return null;
        }
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/InvoiceService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.common.exception.AppException;
import com.einvoicehub.core.common.exception.ErrorCode;
import com.einvoicehub.core.dto.request.InvoiceItemRequest;
import com.einvoicehub.core.dto.request.InvoiceRequest;
import com.einvoicehub.core.dto.response.InvoiceResponse;
import com.einvoicehub.core.entity.enums.InvoiceStatus;
import com.einvoicehub.core.entity.jpa.*;
import com.einvoicehub.core.provider.InvoiceProvider;
import com.einvoicehub.core.provider.ProviderConfig;
import com.einvoicehub.core.repository.jpa.InvoiceItemRepository;
import com.einvoicehub.core.repository.jpa.InvoiceMetadataRepository;
import com.einvoicehub.core.repository.jpa.MerchantProviderConfigRepository;
import com.einvoicehub.core.repository.jpa.MerchantRepository;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.*;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

@Slf4j
@Service
@RequiredArgsConstructor
public class InvoiceService {

    private final MerchantRepository merchantRepository;
    private final InvoiceMetadataRepository invoiceMetadataRepository;
    private final MerchantProviderConfigRepository providerConfigRepository;
    private final InvoicePayloadService invoicePayloadService;
    private final InvoiceItemRepository invoiceItemRepository;
    private final Map<String, InvoiceProvider> invoiceProviders;
    private final ObjectMapper objectMapper;

    private final ExecutorService virtualThreadExecutor = Executors.newVirtualThreadPerTaskExecutor();

    @Transactional
    public InvoiceResponse createInvoice(InvoiceRequest request) {
        String requestId = request.getInternalReferenceCode();
        log.info("Starting professional invoice issuance: {}", requestId);

        // 1. Ki·ªÉm tra Merchant & Quota
        Merchant merchant = merchantRepository.findById(Long.parseLong(request.getMerchantId()))
                .orElseThrow(() -> new AppException(ErrorCode.MERCHANT_NOT_FOUND));

        if (!merchant.hasAvailableQuota()) {
            throw new AppException(ErrorCode.INSUFFICIENT_QUOTA);
        }

        // 2. L·∫•y c·∫•u h√¨nh k·∫øt n·ªëi
        MerchantProviderConfig merchantConfig = providerConfigRepository
                .findByMerchantIdAndProviderProviderCode(merchant.getId(), request.getProviderCode())
                .orElseThrow(() -> new AppException(ErrorCode.VALIDATION_ERROR, "Config Provider not found"));

        // 3. Kh·ªüi t·∫°o Metadata & Payload
        InvoiceMetadata metadata = initMetadata(merchant, request, requestId, merchantConfig);
        saveInitialPayload(merchant.getId(), requestId, request.getProviderCode(), request);

        // 4. L∆∞u chi ti·∫øt h√†ng h√≥a (MariaDB)
        if (request.getItems() != null && !request.getItems().isEmpty()) {
            saveInvoiceItems(metadata.getId(), request.getItems());
        }

        try {
            InvoiceProvider provider = getProvider(request.getProviderCode());
            ProviderConfig config = mapToProviderConfig(merchantConfig);
            var internalRequest = mapToInternalRequest(request, metadata.getId());

            // 5. G·ªçi API Provider qua Virtual Thread
            var internalRes = virtualThreadExecutor.submit(() -> provider.issueInvoice(internalRequest, config)).join();

            if (internalRes.isSuccessful()) {
                handleSuccess(metadata, requestId, internalRes, merchant);
                return mapToPublicResponse(internalRes, metadata, true, "H√≥a ƒë∆°n ƒë√£ ph√°t h√†nh th√†nh c√¥ng");
            } else {
                handleFailure(metadata, requestId, internalRes.getErrorMessage(), internalRes.getErrorCode());
                return mapToPublicResponse(internalRes, metadata, false, internalRes.getErrorMessage());
            }

        } catch (Exception e) {
            log.error("Critical error during issuance for requestId {}: {}", requestId, e.getMessage());
            handleFailure(metadata, requestId, e.getMessage(), "SYSTEM_ERROR");
            throw new AppException(ErrorCode.PROVIDER_ERROR, "Provider connection failed: " + e.getMessage());
        }
    }

    private void saveInitialPayload(Long merchantId, String clientRequestId, String providerCode, InvoiceRequest request) {
        Map<String, Object> requestData = objectMapper.convertValue(request, new TypeReference<Map<String, Object>>() {});
        invoicePayloadService.createPayloadFromRequest(merchantId, clientRequestId, providerCode, requestData);
    }

    private void handleSuccess(InvoiceMetadata metadata, String requestId, com.einvoicehub.core.provider.model.InvoiceResponse res, Merchant merchant) {
        metadata.markAsSuccess(res.getTransactionCode());
        metadata.setInvoiceNumber(res.getInvoiceNumber());
        metadata.setCqtCode(res.getCqtCode());
        metadata.setSignedAt(LocalDateTime.now());

        // C·∫≠p nh·∫≠t l·∫°i d·∫£i h√≥a ƒë∆°n n·∫øu provider tr·∫£ v·ªÅ kh√°c v·ªõi d·∫£i g·ª≠i ƒëi
        if (res.getTemplateCode() != null) metadata.setTemplateCode(res.getTemplateCode());
        if (res.getSymbolCode() != null) metadata.setSymbolCode(res.getSymbolCode());

        invoiceMetadataRepository.save(metadata);

        // ƒê·ªìng b·ªô Payload chuy√™n s√¢u
        invoicePayloadService.updateInvoiceId(requestId, metadata.getId());
        if (res.getXmlUrl() != null) invoicePayloadService.updateXmlContent(requestId, res.getXmlUrl());
        if (res.getJsonUrl() != null) invoicePayloadService.updateJsonContent(requestId, res.getJsonUrl());
        invoicePayloadService.updatePayloadWithResponse(requestId, res.toString(), "SUCCESS");

        // Tr·ª´ h·∫°n m·ª©c
        merchant.incrementInvoiceUsage();
        merchantRepository.save(merchant);
    }

    private void handleFailure(InvoiceMetadata metadata, String requestId, String errorMessage, String errorCode) {
        metadata.markAsFailed(errorCode, errorMessage);
        invoiceMetadataRepository.save(metadata);
        invoicePayloadService.updatePayloadWithResponse(requestId, errorMessage, "FAILED");
    }

    private InvoiceResponse mapToPublicResponse(com.einvoicehub.core.provider.model.InvoiceResponse res, InvoiceMetadata meta, boolean success, String msg) {
        return InvoiceResponse.builder()
                .success(success)
                .transactionId(res.getTransactionCode())
                .invoiceNumber(res.getInvoiceNumber())
                .cqtCode(res.getCqtCode())
                .clientRequestId(meta.getClientRequestId())
                .providerCode(meta.getProviderCode())
                .status(meta.getStatus().name())
                .buyerName(meta.getBuyerName())
                .totalAmount(meta.getTotalAmount())
                .currency(meta.getCurrencyCode())
                .pdfDownloadUrl(res.getPdfUrl())
                .xmlDownloadUrl(res.getXmlUrl())
                .message(msg)
                .errorCode(res.getErrorCode())
                .build();
    }

    private InvoiceProvider getProvider(String code) {
        InvoiceProvider p = invoiceProviders.get(code.toUpperCase());
        if (p == null) throw new AppException(ErrorCode.PROVIDER_ERROR, "Provider not supported: " + code);
        return p;
    }

    private ProviderConfig mapToProviderConfig(MerchantProviderConfig e) {
        return ProviderConfig.builder()
                .configId(e.getId())
                .providerCode(e.getProviderCode())
                .username(e.getUsernameService())
                .password(e.getPasswordServiceEncrypted())
                .certificateData(e.getCertificateData())
                .certificateSerial(e.getCertificateSerial())
                .extraConfigJson(e.getExtraConfig())
                .build();
    }

    private InvoiceMetadata initMetadata(Merchant merchant, InvoiceRequest request, String requestId, MerchantProviderConfig config) {
        return invoiceMetadataRepository.save(InvoiceMetadata.builder()
                .merchant(merchant)
                .provider(config.getProvider())
                .providerConfig(config)
                .clientRequestId(requestId)
                .providerCode(request.getProviderCode())
                .invoiceTypeCode(request.getInvoiceType())
                .templateCode(request.getTemplateCode())
                .symbolCode(request.getSymbolCode())
                .sellerName(request.getSellerName())
                .sellerTaxCode(request.getSellerTaxCode())
                .sellerAddress(request.getSellerAddress())
                .buyerName(request.getBuyerName())
                .buyerTaxCode(request.getBuyerTaxCode())
                .buyerEmail(request.getBuyerEmail())
                .buyerAddress(request.getBuyerAddress())
                .subtotalAmount(calculateSubtotal(request.getItems()))
                .taxAmount(request.getTotalTaxAmount())
                .totalAmount(request.getGrandTotalAmount())
                .currencyCode(request.getCurrency() != null ? request.getCurrency() : "VND")
                .issueDate(request.getInvoiceDate() != null ? request.getInvoiceDate().toLocalDate() : LocalDate.now())
                .status(InvoiceStatus.PENDING)
                .build());
    }

    private void saveInvoiceItems(Long invoiceId, List<InvoiceItemRequest> itemRequests) {
        List<InvoiceItem> items = itemRequests.stream().map(req -> {
            req.normalizeData();
            return InvoiceItem.builder()
                    .invoiceId(invoiceId)
                    .productName(req.getItemName())
                    .quantity(req.getQuantity())
                    .unitPrice(req.getUnitPrice())
                    .amount(req.getAmount())
                    .taxRate(req.getTaxRate())
                    .totalAmount(req.getTotalAmountWithVat())
                    .build();
        }).toList();
        invoiceItemRepository.saveAll(items);
    }

    private com.einvoicehub.core.provider.model.InvoiceRequest mapToInternalRequest(InvoiceRequest pub, Long metadataId) {
        return com.einvoicehub.core.provider.model.InvoiceRequest.builder()
                .clientRequestId(pub.getInternalReferenceCode())
                .invoiceMetadataId(metadataId)
                .providerCode(pub.getProviderCode())
                .invoiceType(pub.getInvoiceType())
                .templateCode(pub.getTemplateCode())
                .symbolCode(pub.getSymbolCode())
                .issueDate(pub.getInvoiceDate() != null ? pub.getInvoiceDate().toLocalDate() : LocalDate.now())
                .seller(com.einvoicehub.core.provider.model.InvoiceRequest.SellerInfo.builder()
                        .name(pub.getSellerName()).taxCode(pub.getSellerTaxCode()).address(pub.getSellerAddress()).build())
                .buyer(com.einvoicehub.core.provider.model.InvoiceRequest.BuyerInfo.builder()
                        .name(pub.getBuyerName()).taxCode(pub.getBuyerTaxCode()).address(pub.getBuyerAddress()).build())
                .items(pub.getItems() == null ? new ArrayList<>() : pub.getItems().stream().map(i ->
                        com.einvoicehub.core.provider.model.InvoiceRequest.InvoiceItem.builder()
                                .itemName(i.getItemName()).quantity(i.getQuantity()).unitPrice(i.getUnitPrice())
                                .amount(i.getAmount()).taxRate(i.getTaxRate()).build()).toList())
                .summary(com.einvoicehub.core.provider.model.InvoiceRequest.InvoiceSummary.builder()
                        .totalAmount(pub.getGrandTotalAmount())
                        .totalTaxAmount(pub.getTotalTaxAmount())
                        .currencyCode(pub.getCurrency()).build())
                .build();
    }

    private BigDecimal calculateSubtotal(List<InvoiceItemRequest> items) {
        return items == null ? BigDecimal.ZERO : items.stream()
                .map(i -> i.getAmount() != null ? i.getAmount() : BigDecimal.ZERO)
                .reduce(BigDecimal.ZERO, BigDecimal::add);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/util/IdGenerator.java">
package com.einvoicehub.core.util;

import org.springframework.stereotype.Component;
import java.security.SecureRandom;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

/**
 * ID Generator Utility - C·∫≠p nh·∫≠t theo chu·∫©n EInvoiceHub
 * * Th√†nh ph·∫ßn h·ªó tr·ª£ t·∫°o c√°c ƒë·ªãnh danh c√≥ c·∫•u tr√∫c, gi√∫p ƒë·ªëi so√°t d·ªØ li·ªáu
 * gi·ªØa MySQL v√† MongoDB d·ªÖ d√†ng h∆°n so v·ªõi UUID th√¥ng th∆∞·ªùng.
 */
@Component
public class IdGenerator {

    private static final String CHARS = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    private final SecureRandom random = new SecureRandom();
    private final DateTimeFormatter timestampFormatter = DateTimeFormatter.ofPattern("yyyyMMdd-HHmmss");
    private final DateTimeFormatter dateFormatter = DateTimeFormatter.ofPattern("yyyyMMdd");

    /**
     * T·∫°o ID ƒë·ªãnh danh duy nh·∫•t cho m·ªói y√™u c·∫ßu khi ti·∫øp nh·∫≠n v√†o Hub.
     * Kh·∫Øc ph·ª•c: ƒê·ªïi t√™n t·ª´ generateClientRequestId ƒë·ªÉ ph√¢n bi·ªát v·ªõi ID c·ªßa Merchant truy·ªÅn l√™n.
     * Format: HUB-YYYYMMDD-HHMMSS-XXXXXX
     */
    public String generateHubRequestId() {
        String timestamp = LocalDateTime.now().format(timestampFormatter);
        return String.format("HUB-%s-%s", timestamp, generateRandom(6));
    }

    /**
     * T·∫°o m√£ giao d·ªãch n·ªôi b·ªô ƒë·ªÉ li√™n k·∫øt Metadata (MySQL) v√† Payload (MongoDB).
     * Format: TXN-YYYYMMDD-HHMMSS-XXXXXXXX
     */
    public String generateTransactionId() {
        String timestamp = LocalDateTime.now().format(timestampFormatter);
        return String.format("TXN-%s-%s", timestamp, generateRandom(8));
    }

    /**
     * T·∫°o s·ªë h√≥a ƒë∆°n n·ªôi b·ªô (Ch·ªâ d√πng cho b·∫£n nh√°p DRAFT ho·∫∑c tra c·ª©u n·ªôi b·ªô).
     * C·∫£nh b√°o: S·ªë h√≥a ƒë∆°n ph√°p l√Ω s·∫Ω do Provider (MISA, VNPT...) c·∫•p sau khi ph√°t h√†nh.
     * Format: DRAFT-YYYYMMDD-XXXXXX
     */
    public String generateInternalDraftNumber() {
        String date = LocalDateTime.now().format(dateFormatter);
        return String.format("DRAFT-%s-%s", date, generateRandom(6));
    }

    /**
     * Sinh chu·ªói ng·∫´u nhi√™n an to√†n (Alphanumeric)
     * S·ª≠ d·ª•ng SecureRandom ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh b·∫£o m·∫≠t v√† tr√°nh tr√πng l·∫∑p.
     */
    private String generateRandom(int length) {
        StringBuilder sb = new StringBuilder(length);
        for (int i = 0; i < length; i++) {
            sb.append(CHARS.charAt(random.nextInt(CHARS.length())));
        }
        return sb.toString();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/EinvoiceCoreApplication.java">
package com.einvoicehub.core;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class EinvoiceCoreApplication {

	public static void main(String[] args) {
		SpringApplication.run(EinvoiceCoreApplication.class, args);
	}

}
</file>

<file path="src/main/resources/db/migration/Initial_Schema_Ver01.sql">
-- EInvoiceHub Database Schema [MySQL - MongoDB]

--Table
-- merchants , merchant_users,
-- api_credentials, service_providers,merchant_provider_configs
-- invoices_metadata,
-- audit_logs, system_config

-- 1. ENUM Types Definition
-- Subscription Plan: Trial, Basic, Premium
DROP TYPE IF EXISTS subscription_plan;
CREATE TYPE subscription_plan AS ENUM ('TRIAL', 'BASIC', 'PREMIUM');

-- Entity Status: Active, Inactive, Suspended
DROP TYPE IF EXISTS entity_status;
CREATE TYPE entity_status AS ENUM ('ACTIVE', 'INACTIVE', 'SUSPENDED');

-- Invoice Status: Workflow states
DROP TYPE IF EXISTS invoice_status;
CREATE TYPE invoice_status AS ENUM ('DRAFT', 'PENDING', 'SIGNING', 'SENT_TO_PROVIDER', 'SUCCESS', 'FAILED', 'CANCELLED', 'REPLACED');

-- User Role: Ph√¢n quy·ªÅn trong Merchant
DROP TYPE IF EXISTS user_role;
CREATE TYPE user_role AS ENUM ('ADMIN', 'MANAGER', 'STAFF', 'VIEWER');


-- 2. Merchants Table - Qu·∫£n l√Ω doanh nghi·ªáp
CREATE TABLE merchants (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    tax_code VARCHAR(20) NOT NULL UNIQUE COMMENT 'M√£ s·ªë thu·∫ø - ƒë·ªãnh danh doanh nghi·ªáp',
    company_name VARCHAR(255) NOT NULL COMMENT 'T√™n c√¥ng ty ƒë·∫ßy ƒë·ªß',
    short_name VARCHAR(100) COMMENT 'T√™n vi·∫øt t·∫Øt',
    address TEXT COMMENT 'ƒê·ªãa ch·ªâ tr·ª• s·ªü ch√≠nh',
    district VARCHAR(100) COMMENT 'Qu·∫≠n/Huy·ªán',
    city VARCHAR(100) COMMENT 'T·ªânh/Th√†nh ph·ªë',
    email VARCHAR(255) COMMENT 'Email li√™n h·ªá',
    phone VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    representative_name VARCHAR(100) COMMENT 'T√™n ng∆∞·ªùi ƒë·∫°i di·ªán',
    representative_title VARCHAR(100) COMMENT 'Ch·ª©c danh ng∆∞·ªùi ƒë·∫°i di·ªán',
    subscription_plan subscription_plan NOT NULL DEFAULT 'TRIAL' COMMENT 'G√≥i d·ªãch v·ª•',
    invoice_quota INT NOT NULL DEFAULT 100 COMMENT 'H·∫°n m·ª©c h√≥a ƒë∆°n/th√°ng',
    invoice_used INT NOT NULL DEFAULT 0 COMMENT 'H√≥a ƒë∆°n ƒë√£ s·ª≠ d·ª•ng trong th√°ng',
    status entity_status NOT NULL DEFAULT 'ACTIVE' COMMENT 'Tr·∫°ng th√°i ho·∫°t ƒë·ªông',
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'Soft delete flag',
    deleted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    INDEX idx_tax_code (tax_code),
    INDEX idx_status (status),
    INDEX idx_subscription_plan (subscription_plan),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω doanh nghi·ªáp s·ª≠ d·ª•ng d·ªãch v·ª•';


-- 3. Merchant Users - T√†i kho·∫£n ng∆∞·ªùi d√πng c·ªßa Merchant
CREATE TABLE merchant_users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Li√™n k·∫øt v·ªõi doanh nghi·ªáp',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT 'T√™n ƒëƒÉng nh·∫≠p',
    email VARCHAR(255) NOT NULL UNIQUE COMMENT 'Email ng∆∞·ªùi d√πng',
    password_hash VARCHAR(255) NOT NULL COMMENT 'M·∫≠t kh·∫©u ƒë√£ m√£ h√≥a BCrypt',
    full_name VARCHAR(100) COMMENT 'H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß',
    phone VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    avatar_url VARCHAR(500) COMMENT 'URL ·∫£nh ƒë·∫°i di·ªán',
    role user_role NOT NULL DEFAULT 'STAFF' COMMENT 'Vai tr√≤ trong h·ªá th·ªëng',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'K√≠ch ho·∫°t t√†i kho·∫£n',
    is_primary BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'T√†i kho·∫£n ch√≠nh c·ªßa doanh nghi·ªáp',
    last_login_at TIMESTAMP NULL COMMENT 'ƒêƒÉng nh·∫≠p l·∫ßn cu·ªëi',
    failed_login_attempts INT NOT NULL DEFAULT 0 COMMENT 'S·ªë l·∫ßn ƒëƒÉng nh·∫≠p sai',
    locked_until TIMESTAMP NULL COMMENT 'Kh√≥a t√†i kho·∫£n ƒë·∫øn th·ªùi ƒëi·ªÉm',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_merchant_users_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_role (role),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='T√†i kho·∫£n ng∆∞·ªùi d√πng thu·ªôc Merchant';


-- 4. API Credentials - B·∫£o m·∫≠t v√† t√≠ch h·ª£p API
CREATE TABLE api_credentials (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu credential',
    client_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'ID c√¥ng khai c·ªßa ·ª©ng d·ª•ng',
    api_key_hash VARCHAR(255) NOT NULL COMMENT 'Hash c·ªßa API Key (SHA-256)',
    api_key_prefix VARCHAR(8) NOT NULL COMMENT '8 k√Ω t·ª± ƒë·∫ßu c·ªßa API Key (hi·ªÉn th·ªã)',
    scopes TEXT NOT NULL COMMENT 'Quy·ªÅn h·∫°n - JSON array: [invoice.create, invoice.view]',
    ip_whitelist TEXT NULL COMMENT 'Danh s√°ch IP ƒë∆∞·ª£c ph√©p - JSON array ho·∫∑c NULL',
    rate_limit_per_hour INT NOT NULL DEFAULT 1000 COMMENT 'Gi·ªõi h·∫°n request/gi·ªù',
    rate_limit_per_day INT NOT NULL DEFAULT 10000 COMMENT 'Gi·ªõi h·∫°n request/ng√†y',
    request_count_hour INT NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong gi·ªù',
    request_count_day INT NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong ng√†y',
    request_count_resetted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm reset counter',
    expired_at TIMESTAMP NULL COMMENT 'Ng√†y h·∫øt h·∫°n - NULL l√† kh√¥ng gi·ªõi h·∫°n',
    last_used_at TIMESTAMP NULL COMMENT 'L·∫ßn s·ª≠ d·ª•ng cu·ªëi',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_by BIGINT NULL COMMENT 'Ng∆∞·ªùi t·∫°o - merchant_users.id',
    
    CONSTRAINT fk_api_credentials_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    CONSTRAINT fk_api_credentials_created_by FOREIGN KEY (created_by) 
        REFERENCES merchant_users(id) ON DELETE SET NULL,
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_client_id (client_id),
    INDEX idx_api_key_hash (api_key_hash),
    INDEX idx_expired_at (expired_at),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Credentials cho API access';


-- 5. Service Providers - Nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠
CREATE TABLE service_providers (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    provider_code VARCHAR(20) NOT NULL UNIQUE COMMENT 'M√£ provider: VNPT, VIETTEL, MISA, BKAV',
    provider_name VARCHAR(100) NOT NULL COMMENT 'T√™n ƒë·∫ßy ƒë·ªß nh√† cung c·∫•p',
    official_api_url VARCHAR(500) NOT NULL COMMENT 'URL API ch√≠nh th·ª©c',
    documentation_url VARCHAR(500) NULL COMMENT 'Link t√†i li·ªáu API',
    support_email VARCHAR(255) NULL COMMENT 'Email h·ªó tr·ª£',
    support_phone VARCHAR(20) NULL COMMENT 'Hotline h·ªó tr·ª£',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'Provider c√≤n ho·∫°t ƒë·ªông',
    is_default BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh c·ªßa h·ªá th·ªëng',
    display_order INT NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
    extra_config_schema JSON NULL COMMENT 'Schema c·∫•u h√¨nh b·ªï sung cho provider',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_provider_code (provider_code),
    INDEX idx_is_active (is_active),
    INDEX idx_is_default (is_default),
    INDEX idx_display_order (display_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠';

-- Insert default providers
INSERT INTO service_providers (provider_code, provider_name, official_api_url, is_active, is_default, display_order) VALUES
('VNPT', 'VNPT Invoice', 'https://api.vnptinvoice.com.vn/v1', TRUE, FALSE, 1),
('VIETTEL', 'Viettel Business Invoice', 'https://ebill.vietteltelecom.vn/api/v1', TRUE, FALSE, 2),
('MISA', 'MISA Mimosa', 'https://api.misa.com.vn/einvoice/v1', FALSE, FALSE, 3),
('BKAV', 'BKAV eInvoice', 'https://einvoice.bkav.com/api/v1', FALSE, FALSE, 4);


-- 6. Merchant Provider Configs - C·∫•u h√¨nh ri√™ng c·ªßa Merchant
CREATE TABLE merchant_provider_configs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu',
    provider_id BIGINT NOT NULL COMMENT 'Nh√† cung c·∫•p ƒë∆∞·ª£c ch·ªçn',
    username_service VARCHAR(100) NOT NULL COMMENT 'T√†i kho·∫£n API do Provider c·∫•p',
    password_service_encrypted VARCHAR(500) NOT NULL COMMENT 'M·∫≠t kh·∫©u API - ƒë√£ m√£ h√≥a AES-256',
    certificate_serial VARCHAR(100) NULL COMMENT 'Serial number c·ªßa ch·ªØ k√Ω s·ªë',
    certificate_data TEXT NULL COMMENT 'Ch·ª©ng th∆∞ s·ªë - ƒë√£ m√£ h√≥a',
    certificate_expired_at TIMESTAMP NULL COMMENT 'H·∫°n ch·ª©ng th∆∞ s·ªë',
    extra_config JSON NULL COMMENT 'C·∫•u h√¨nh b·ªï sung: pattern, serial, template',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C·∫•u h√¨nh c√≤n hi·ªáu l·ª±c',
    is_default BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh c·ªßa Merchant',
    last_sync_at TIMESTAMP NULL COMMENT 'L·∫ßn ƒë·ªìng b·ªô cu·ªëi v·ªõi Provider',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_mpc_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    CONSTRAINT fk_mpc_provider FOREIGN KEY (provider_id) 
        REFERENCES service_providers(id) ON DELETE RESTRICT,
    CONSTRAINT uq_merchant_provider UNIQUE (merchant_id, provider_id),
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_provider_id (provider_id),
    INDEX idx_is_active (is_active),
    INDEX idx_is_default (is_default)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='C·∫•u h√¨nh k·∫øt n·ªëi Provider cho t·ª´ng Merchant';


-- 7. Invoice Metadata - Th√¥ng tin t√≥m t·∫Øt h√≥a ƒë∆°n
CREATE TABLE invoices_metadata (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp ph√°t h√†nh',
    provider_id BIGINT NULL COMMENT 'Provider x·ª≠ l√Ω h√≥a ƒë∆°n',
    provider_config_id BIGINT NULL COMMENT 'C·∫•u h√¨nh Provider ƒë∆∞·ª£c s·ª≠ d·ª•ng',
    client_request_id VARCHAR(100) NULL COMMENT 'ID request t·ª´ Merchant',
    
    -- Th√¥ng tin h√≥a ƒë∆°n
    invoice_number VARCHAR(20) NULL COMMENT 'S·ªë h√≥a ƒë∆°n t·ª´ Provider tr·∫£ v·ªÅ',
    symbol_code VARCHAR(10) NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n ',
    invoice_type_code VARCHAR(10) NULL COMMENT 'M√£ lo·∫°i h√≥a ƒë∆°n: 01GTKT, 02GTTT, 07KPTQ...',
    template_code VARCHAR(20) NULL COMMENT 'M·∫´u h√≥a ƒë∆°n: 01GTKT0/001, 02GTTT0/001...',
    
    -- Th√¥ng tin ng∆∞·ªùi b√°n (t·ª´ merchant data)
    seller_name VARCHAR(255) NULL COMMENT 'T√™n ng∆∞·ªùi b√°n',
    seller_tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi b√°n',
    seller_address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi b√°n',
    
    -- Th√¥ng tin ng∆∞·ªùi mua
    buyer_name VARCHAR(255) NULL COMMENT 'T√™n ng∆∞·ªùi mua',
    buyer_tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi mua',
    buyer_email VARCHAR(255) NULL COMMENT 'Email ng∆∞·ªùi mua (nh·∫≠n h√≥a ƒë∆°n)',
    buyer_phone VARCHAR(20) NULL COMMENT 'ƒêi·ªán tho·∫°i ng∆∞·ªùi mua',
    buyer_address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi mua',
    
    -- Th√¥ng tin t√†i ch√≠nh
    subtotal_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø',
    tax_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ø',
    discount_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng chi·∫øt kh·∫•u',
    total_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thanh to√°n',
    currency_code VARCHAR(3) NOT NULL DEFAULT 'VND' COMMENT 'ƒê∆°n v·ªã ti·ªÅn t·ªá',
    exchange_rate DECIMAL(10,4) NOT NULL DEFAULT 1.0000 COMMENT 'T·ª∑ gi√° v·ªõi VND',
    
    -- Th√¥ng tin th·ªùi gian
    issue_date DATE NULL COMMENT 'Ng√†y l·∫≠p h√≥a ƒë∆°n',
    accounting_date DATE NULL COMMENT 'Ng√†y h·∫°ch to√°n',
    due_date DATE NULL COMMENT 'Ng√†y thanh to√°n ƒë·∫øn h·∫°n',
    
    -- Tr·∫°ng th√°i v√† ƒëi·ªÅu kho·∫£n
    status invoice_status NOT NULL DEFAULT 'DRAFT' COMMENT 'Tr·∫°ng th√°i x·ª≠ l√Ω',
    status_message TEXT NULL COMMENT 'Th√¥ng b√°o tr·∫°ng th√°i chi ti·∫øt',
    cancellation_reason VARCHAR(500) NULL COMMENT 'L√Ω do h·ªßy/thay th·∫ø',
    replaced_by_invoice_id BIGINT NULL COMMENT 'ID h√≥a ƒë∆°n thay th·∫ø',
    
    -- Li√™n k·∫øt MongoDB
    mongo_payload_id VARCHAR(50) NULL COMMENT 'ObjectId trong collection invoice_payloads',
    mongo_transaction_id VARCHAR(50) NULL COMMENT 'ObjectId trong collection provider_transactions',
    
    -- Tracking
    signed_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm k√Ω ƒëi·ªán t·ª≠',
    sent_to_provider_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i sang Provider',
    received_from_provider_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
    delivered_to_buyer_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i h√≥a ƒë∆°n cho ng∆∞·ªùi mua',
    
    -- Provider response reference
    provider_transaction_code VARCHAR(100) NULL COMMENT 'M√£ giao d·ªãch t·ª´ Provider',
    provider_error_code VARCHAR(50) NULL COMMENT 'M√£ l·ªói t·ª´ Provider',
    provider_error_message TEXT NULL COMMENT 'Chi ti·∫øt l·ªói t·ª´ Provider',
    
    -- Soft delete
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'H√≥a ƒë∆°n ƒë√£ b·ªã x√≥a',
    deleted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
    deleted_by BIGINT NULL COMMENT 'Ng∆∞·ªùi x√≥a - merchant_users.id',
    
    -- Timestamps
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    -- Foreign Keys
    CONSTRAINT fk_invoice_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE RESTRICT,
    CONSTRAINT fk_invoice_provider FOREIGN KEY (provider_id) 
        REFERENCES service_providers(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_config FOREIGN KEY (provider_config_id) 
        REFERENCES merchant_provider_configs(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_replaced_by FOREIGN KEY (replaced_by_invoice_id) 
        REFERENCES invoices_metadata(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_deleted_by FOREIGN KEY (deleted_by) 
        REFERENCES merchant_users(id) ON DELETE SET NULL,
    
    -- Indexes for performance
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_provider_id (provider_id),
    INDEX idx_invoice_number (invoice_number),
    INDEX idx_symbol_code (symbol_code),
    INDEX idx_buyer_tax_code (buyer_tax_code),
    INDEX idx_status (status),
    INDEX idx_issue_date (issue_date),
    INDEX idx_created_at (created_at),
    INDEX idx_client_request_id (client_request_id),
    INDEX idx_merchant_status (merchant_id, status),
    INDEX idx_merchant_created (merchant_id, created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Metadata h√≥a ƒë∆°n - ph·ª•c v·ª• tra c·ª©u nhanh';


-- 8. Audit Log - Nh·∫≠t k√Ω thao t√°c
CREATE TABLE audit_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NULL COMMENT 'Doanh nghi·ªáp li√™n quan',
    user_id BIGINT NULL COMMENT 'Ng∆∞·ªùi th·ª±c hi·ªán',
    entity_type VARCHAR(50) NOT NULL COMMENT 'Lo·∫°i entity: Invoice, Merchant, Config...',
    entity_id BIGINT NOT NULL COMMENT 'ID c·ªßa entity',
    action VARCHAR(50) NOT NULL COMMENT 'H√†nh ƒë·ªông: CREATE, UPDATE, DELETE, STATUS_CHANGE',
    old_value JSON NULL COMMENT 'Gi√° tr·ªã c≈©',
    new_value JSON NULL COMMENT 'Gi√° tr·ªã m·ªõi',
    ip_address VARCHAR(45) NULL COMMENT 'IP th·ª±c hi·ªán',
    user_agent VARCHAR(500) NULL COMMENT 'User Agent c·ªßa browser/client',
    request_id VARCHAR(100) NULL COMMENT 'ID request t·ª´ frontend',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm x·∫£y ra',
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_user_id (user_id),
    INDEX idx_entity (entity_type, entity_id),
    INDEX idx_action (action),
    INDEX idx_created_at (created_at),
    INDEX idx_merchant_entity (merchant_id, entity_type, entity_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Nh·∫≠t k√Ω thay ƒë·ªïi h·ªá th·ªëng';


-- 9. System Configuration - C·∫•u h√¨nh h·ªá th·ªëng
CREATE TABLE system_config (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    config_key VARCHAR(100) NOT NULL UNIQUE COMMENT 'Kh√≥a c·∫•u h√¨nh',
    config_value TEXT NOT NULL COMMENT 'Gi√° tr·ªã c·∫•u h√¨nh',
    config_type VARCHAR(20) NOT NULL DEFAULT 'STRING' COMMENT 'Lo·∫°i: STRING, NUMBER, BOOLEAN, JSON',
    description VARCHAR(500) NULL COMMENT 'M√¥ t·∫£ c·∫•u h√¨nh',
    is_encrypted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'C√≥ c·∫ßn m√£ h√≥a kh√¥ng',
    is_editable BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≥ th·ªÉ ch·ªânh s·ª≠a kh√¥ng',
    updated_by BIGINT NULL COMMENT 'Ng∆∞·ªùi c·∫≠p nh·∫≠t cu·ªëi',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_config_updated_by FOREIGN KEY (updated_by) 
        REFERENCES merchant_users(id) ON DELETE SET NULL,
    
    INDEX idx_config_key (config_key)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='C·∫•u h√¨nh h·ªá th·ªëng';

-- Insert default configurations
INSERT INTO system_config (config_key, config_value, config_type, description) VALUES
('SYSTEM_NAME', 'EInvoiceHub', 'STRING', 'T√™n hi·ªÉn th·ªã c·ªßa h·ªá th·ªëng'),
('INVOICE_EXPIRY_DAYS', '30', 'NUMBER', 'S·ªë ng√†y h√≥a ƒë∆°n c√≥ hi·ªáu l·ª±c sau khi ph√°t h√†nh'),
('MAX_RETRY_ATTEMPTS', '3', 'NUMBER', 'S·ªë l·∫ßn th·ª≠ l·∫°i khi g·ªçi Provider th·∫•t b·∫°i'),
('RETRY_DELAY_MS', '1000', 'NUMBER', 'Th·ªùi gian ch·ªù gi·ªØa c√°c l·∫ßn th·ª≠ l·∫°i (milliseconds)'),
('SESSION_TIMEOUT_MINUTES', '60', 'NUMBER', 'Th·ªùi gian timeout c·ªßa session'),
('PASSWORD_MIN_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i t·ªëi thi·ªÉu c·ªßa m·∫≠t kh·∫©u'),
('API_KEY_PREFIX_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i prefix hi·ªÉn th·ªã c·ªßa API Key'),
('DEFAULT_CURRENCY', 'VND', 'STRING', 'ƒê∆°n v·ªã ti·ªÅn t·ªá m·∫∑c ƒë·ªãnh'),
('TAX_DEFAULT_RATE', '10.00', 'NUMBER', 'Thu·∫ø su·∫•t m·∫∑c ƒë·ªãnh (%)');


/* TRIGGER VERSION 3
-- PH·∫¶N 3: TRIGGERS
-- Trigger 1: T·ª± ƒë·ªông c·∫≠p nh·∫≠t merchants.invoice_used khi h√≥a ƒë∆°n chuy·ªÉn sang SUCCESS
DELIMITER //

CREATE TRIGGER trg_invoice_status_success
    AFTER UPDATE ON invoices_metadata
    FOR EACH ROW
BEGIN
    -- Ki·ªÉm tra n·∫øu tr·∫°ng th√°i chuy·ªÉn sang SUCCESS v√† merchant_id t·ªìn t·∫°i
    IF NEW.status = 'SUCCESS' AND OLD.status != 'SUCCESS' AND NEW.merchant_id IS NOT NULL THEN
    UPDATE merchants
    SET invoice_used = invoice_used + 1,
        updated_at = NOW()
    WHERE id = NEW.merchant_id;

    -- Ghi audit log
    INSERT INTO audit_logs (merchant_id, user_id, entity_type, entity_id, action, old_value, new_value)
    VALUES (
               NEW.merchant_id,
               NULL,
               'Invoice',
               NEW.id,
               'STATUS_CHANGE',
               CONCAT('{"status": "', OLD.status, '"}'),
               CONCAT('{"status": "', NEW.status, '", "invoice_used_incremented": true}')
           );
END IF;

-- X·ª≠ l√Ω tr∆∞·ªùng h·ª£p h·ªßy h√≥a ƒë∆°n: gi·∫£m invoice_used
IF NEW.status = 'CANCELLED' AND OLD.status = 'SUCCESS' AND NEW.merchant_id IS NOT NULL THEN
UPDATE merchants
SET invoice_used = GREATEST(0, invoice_used - 1),
    updated_at = NOW()
WHERE id = NEW.merchant_id;
END IF;
END //

DELIMITER ;


-- Trigger 2: T·ª± ƒë·ªông t√≠nh to√°n total_amount t·ª´ invoice_items
DELIMITER //

CREATE TRIGGER trg_calculate_invoice_totals
    AFTER INSERT ON invoice_items
    FOR EACH ROW
BEGIN
    -- T√≠nh to√°n l·∫°i c√°c t·ªïng ti·ªÅn cho h√≥a ƒë∆°n
    UPDATE invoices_metadata SET
                                 subtotal_amount = (
                                     SELECT COALESCE(SUM(amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 tax_amount = (
                                     SELECT COALESCE(SUM(tax_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 discount_amount = (
                                     SELECT COALESCE(SUM(discount_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 total_amount = (
                                     SELECT COALESCE(SUM(total_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 updated_at = NOW()
    WHERE id = NEW.invoice_id;
END //

DELIMITER ;


-- Trigger 3: T·ª± ƒë·ªông c·∫≠p nh·∫≠t totals khi invoice_items ƒë∆∞·ª£c c·∫≠p nh·∫≠t
DELIMITER //

CREATE TRIGGER trg_update_invoice_totals
    AFTER UPDATE ON invoice_items
    FOR EACH ROW
BEGIN
    UPDATE invoices_metadata SET
                                 subtotal_amount = (
                                     SELECT COALESCE(SUM(amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 tax_amount = (
                                     SELECT COALESCE(SUM(tax_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 discount_amount = (
                                     SELECT COALESCE(SUM(discount_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 total_amount = (
                                     SELECT COALESCE(SUM(total_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 updated_at = NOW()
    WHERE id = NEW.invoice_id;
END //

DELIMITER ;


-- Trigger 4: T·ª± ƒë·ªông c·∫≠p nh·∫≠t totals khi invoice_items b·ªã x√≥a
DELIMITER //

CREATE TRIGGER trg_delete_invoice_totals
    AFTER DELETE ON invoice_items
    FOR EACH ROW
BEGIN
    UPDATE invoices_metadata SET
                                 subtotal_amount = (
                                     SELECT COALESCE(SUM(amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = OLD.invoice_id
                                 ),
                                 tax_amount = (
                                     SELECT COALESCE(SUM(tax_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = OLD.invoice_id
                                 ),
                                 discount_amount = (
                                     SELECT COALESCE(SUM(discount_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = OLD.invoice_id
                                 ),
                                 total_amount = (
                                     SELECT COALESCE(SUM(total_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = OLD.invoice_id
                                 ),
                                 updated_at = NOW()
    WHERE id = OLD.invoice_id;
END //

DELIMITER ;


-- Trigger 5: T·ª± ƒë·ªông t·∫°o invoice_tax_breakdowns khi invoice ƒë∆∞·ª£c t·∫°o
DELIMITER //

CREATE TRIGGER trg_create_tax_breakdowns
    AFTER INSERT ON invoice_items
    FOR EACH ROW
BEGIN
    -- Ch·ªâ ch·∫°y m·ªôt l·∫ßn sau khi t·∫•t c·∫£ items ƒë∆∞·ª£c insert (ki·ªÉm tra b·∫±ng count)
    INSERT INTO invoice_tax_breakdowns
    (invoice_id, vat_rate_id, vat_rate_code, vat_rate_percent,
     subtotal_amount, discount_amount, taxable_amount, tax_amount, total_amount)
    SELECT
        NEW.invoice_id,
        vr.id,
        vr.rate_code,
        vr.rate_percent,
        COALESCE(SUM(ii.amount), 0) AS subtotal_amount,
        COALESCE(SUM(ii.discount_amount), 0) AS discount_amount,
        COALESCE(SUM(ii.amount - ii.discount_amount), 0) AS taxable_amount,
        COALESCE(SUM(ii.tax_amount), 0) AS tax_amount,
        COALESCE(SUM(ii.total_amount), 0) AS total_amount
    FROM invoice_items ii
             INNER JOIN vat_rates vr ON vr.id = NEW.vat_rate_id
    WHERE ii.invoice_id = NEW.invoice_id
        ON DUPLICATE KEY UPDATE
                             subtotal_amount = VALUES(subtotal_amount),
                             discount_amount = VALUES(discount_amount),
                             taxable_amount = VALUES(taxable_amount),
                             tax_amount = VALUES(tax_amount),
                             total_amount = VALUES(total_amount);
END //

DELIMITER ;


-- Trigger 6: T·ª± ƒë·ªông c·∫≠p nh·∫≠t current_number trong invoice_registrations
DELIMITER //

CREATE TRIGGER trg_update_registration_number
    AFTER INSERT ON invoices_metadata
    FOR EACH ROW
BEGIN
    IF NEW.invoice_registration_id IS NOT NULL AND NEW.status = 'SUCCESS' THEN
    UPDATE invoice_registrations SET
                                     current_number = current_number + 1,
                                     status = CASE
                                                  WHEN current_number + 1 >= to_number THEN 'EXHAUSTED'
                                                  ELSE 'ACTIVE'
                                         END,
                                     updated_at = NOW()
    WHERE id = NEW.invoice_registration_id;
END IF;
END //

DELIMITER ;


-- Trigger 7: T·ª± ƒë·ªông t·∫°o lookup_code khi h√≥a ƒë∆°n ƒë∆∞·ª£c t·∫°o
DELIMITER //

CREATE TRIGGER trg_generate_lookup_code
    BEFORE INSERT ON invoices_metadata
    FOR EACH ROW
BEGIN
    -- T·ª± ƒë·ªông t·∫°o lookup_code n·∫øu ch∆∞a c√≥
    IF NEW.lookup_code IS NULL AND NEW.invoice_number IS NOT NULL THEN
        SET NEW.lookup_code = CONCAT(
            NEW.invoice_number,
            '-',
            LPAD(FLOOR(RAND() * 1000000), 6, '0')
        );
END IF;
END //

DELIMITER ;


-- View: T·ªïng h·ª£p th√¥ng tin h√≥a ƒë∆°n ƒë·∫ßy ƒë·ªß
CREATE VIEW v_invoices_full AS
SELECT
    im.id AS invoice_id,
    im.invoice_number,
    im.symbol_code,
    im.template_code,
    im.cqt_code,
    im.status,
    im.issue_date,
    im.total_amount,
    im.tax_amount,
    im.subtotal_amount,
    im.discount_amount,
    im.currency_code,
    im.payment_method,
    im.issuance_method,
    m.tax_code AS merchant_tax_code,
    m.company_name AS merchant_name,
    im.seller_name,
    im.seller_tax_code,
    im.buyer_name,
    im.buyer_tax_code,
    im.buyer_email,
    im.created_at,
    im.provider_transaction_code
FROM invoices_metadata im
         INNER JOIN merchants m ON m.id = im.merchant_id;


-- View: T·ªïng h·ª£p tax breakdown theo h√≥a ƒë∆°n
CREATE VIEW v_invoice_tax_summary AS
SELECT
    itb.invoice_id,
    im.invoice_number,
    im.symbol_code,
    itb.vat_rate_code,
    itb.vat_rate_percent,
    itb.subtotal_amount,
    itb.taxable_amount,
    itb.tax_amount,
    itb.total_amount
FROM invoice_tax_breakdowns itb
         INNER JOIN invoices_metadata im ON im.id = itb.invoice_id
ORDER BY im.invoice_number, itb.vat_rate_percent DESC;


-- View: Th·ªëng k√™ s·ªë l∆∞·ª£ng h√≥a ƒë∆°n theo tr·∫°ng th√°i
CREATE VIEW v_invoice_stats_by_status AS
SELECT
    m.id AS merchant_id,
    m.tax_code AS merchant_tax_code,
    m.company_name AS merchant_name,
    im.status,
    COUNT(*) AS invoice_count,
    COALESCE(SUM(im.total_amount), 0) AS total_amount,
    COALESCE(SUM(im.tax_amount), 0) AS total_tax_amount
FROM invoices_metadata im
         INNER JOIN merchants m ON m.id = im.merchant_id
WHERE im.is_deleted = FALSE
GROUP BY m.id, m.tax_code, m.company_name, im.status;


-- View: Danh s√°ch pending sync jobs
CREATE VIEW v_pending_sync_jobs AS
SELECT
    isq.id AS queue_id,
    isq.invoice_id,
    im.invoice_number,
    im.symbol_code,
    m.tax_code AS merchant_tax_code,
    sp.provider_code,
    isq.sync_type,
    isq.priority,
    isq.attempt_count,
    isq.max_attempts,
    isq.status,
    isq.error_message,
    isq.next_retry_at
FROM invoice_sync_queue isq
         INNER JOIN invoices_metadata im ON im.id = isq.invoice_id
         INNER JOIN merchants m ON m.id = isq.merchant_id
         LEFT JOIN service_providers sp ON sp.id = isq.provider_id
WHERE isq.status IN ('PENDING', 'RETRYING')
ORDER BY isq.priority ASC, isq.next_retry_at ASC;


-- ============================================================================
-- PH·∫¶N 5: STORED PROCEDURES (TH·ª¶ T·ª§C TH∆Ø·ªúNG D√ôNG)
-- ============================================================================

-- Procedure: C·∫≠p nh·∫≠t invoice_registration khi s·ª≠ d·ª•ng s·ªë h√≥a ƒë∆°n
DELIMITER //

CREATE PROCEDURE sp_use_invoice_number(
    IN p_registration_id BIGINT,
    OUT p_new_number BIGINT
)
BEGIN
    DECLARE v_current_number BIGINT;
    DECLARE v_max_number BIGINT;

    -- L·∫•y s·ªë hi·ªán t·∫°i v√† max
SELECT current_number, max_number INTO v_current_number, v_max_number
FROM invoice_registrations
WHERE id = p_registration_id
    FOR UPDATE;

-- Ki·ªÉm tra c√≤n s·ªë kh√¥ng
IF v_current_number < v_max_number THEN
        -- TƒÉng s·ªë hi·ªán t·∫°i
UPDATE invoice_registrations SET
                                 current_number = current_number + 1,
                                 updated_at = NOW()
WHERE id = p_registration_id;

SET p_new_number = v_current_number + 1;
ELSE
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'D·∫£i s·ªë h√≥a ƒë∆°n ƒë√£ h·∫øt';
END IF;
END //

DELIMITER ;


-- Procedure: Reset invoice_used ƒë·∫ßu th√°ng cho t·∫•t c·∫£ merchants
DELIMITER //

CREATE PROCEDURE sp_reset_monthly_invoice_usage()
BEGIN
UPDATE merchants SET
                     invoice_used = 0,
                     updated_at = NOW()
WHERE status = 'ACTIVE';

SELECT ROW_COUNT() AS merchants_reset;
END //

DELIMITER ;


-- Procedure: T·∫°o adjustment cho h√≥a ƒë∆°n ƒëi·ªÅu ch·ªânh
DELIMITER //

CREATE PROCEDURE sp_create_adjustment(
    IN p_original_invoice_id BIGINT,
    IN p_adjustment_type ENUM('ADJUSTMENT', 'REPLACEMENT', 'CANCELLATION'),
    IN p_agreement_number VARCHAR(50),
    IN p_agreement_date DATE,
    IN p_agreement_content TEXT,
    IN p_reason_code VARCHAR(50),
    IN p_reason_description VARCHAR(500),
    OUT p_adjustment_id BIGINT
        )
BEGIN
    DECLARE v_old_subtotal DECIMAL(18,2);
    DECLARE v_old_tax DECIMAL(18,2);
    DECLARE v_old_total DECIMAL(18,2);

    -- L·∫•y th√¥ng tin h√≥a ƒë∆°n g·ªëc
SELECT subtotal_amount, tax_amount, total_amount
INTO v_old_subtotal, v_old_tax, v_old_total
FROM invoices_metadata
WHERE id = p_original_invoice_id;

-- T·∫°o b·∫£n ghi adjustment
INSERT INTO invoice_adjustments (
    original_invoice_id,
    adjustment_type,
    agreement_number,
    agreement_date,
    agreement_content,
    reason_code,
    reason_description,
    old_subtotal_amount,
    old_tax_amount,
    old_total_amount,
    status,
    created_at
) VALUES (
             p_original_invoice_id,
             p_adjustment_type,
             p_agreement_number,
             p_agreement_date,
             p_agreement_content,
             p_reason_code,
             p_reason_description,
             v_old_subtotal,
             v_old_tax,
             v_old_total,
             'PENDING',
             NOW()
         );

SET p_adjustment_id = LAST_INSERT_ID();
END //

DELIMITER ;


-- Procedure: Retry failed sync jobs
DELIMITER //

CREATE PROCEDURE sp_retry_failed_sync_jobs(
    IN p_limit INT
)
BEGIN
    -- C·∫≠p nh·∫≠t c√°c job failed ƒë·ªÉ retry
UPDATE invoice_sync_queue SET
                              status = 'RETRYING',
                              next_retry_at = DATE_ADD(NOW(), INTERVAL 5 MINUTE),
                              updated_at = NOW()
WHERE status = 'FAILED'
  AND attempt_count < max_attempts
  AND next_retry_at <= NOW()
    LIMIT p_limit;

SELECT ROW_COUNT() AS jobs_requeued;
END //

DELIMITER ;
*/

-- End of Database Schema Version 3
</file>

<file path="src/main/resources/db/migration/Initial_Schema_Ver02.sql">
-- EInvoiceHub Database Schema - Version 2 (Optimized)
-- Database: MariaDB 

-- 1. Merchants Table - Qu·∫£n l√Ω doanh nghi·ªáp
CREATE TABLE merchants (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    tax_code VARCHAR(20) NOT NULL UNIQUE COMMENT 'M√£ s·ªë thu·∫ø - ƒë·ªãnh danh doanh nghi·ªáp',
    company_name VARCHAR(255) NOT NULL COMMENT 'T√™n c√¥ng ty ƒë·∫ßy ƒë·ªß',
    short_name VARCHAR(100) COMMENT 'T√™n vi·∫øt t·∫Øt',
    address TEXT COMMENT 'ƒê·ªãa ch·ªâ tr·ª• s·ªü ch√≠nh',
    district VARCHAR(100) COMMENT 'Qu·∫≠n/Huy·ªán',
    city VARCHAR(100) COMMENT 'T·ªânh/Th√†nh ph·ªë',
    email VARCHAR(255) COMMENT 'Email li√™n h·ªá',
    phone VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    representative_name VARCHAR(100) COMMENT 'T√™n ng∆∞·ªùi ƒë·∫°i di·ªán',
    representative_title VARCHAR(100) COMMENT 'Ch·ª©c danh ng∆∞·ªùi ƒë·∫°i di·ªán',
    subscription_plan ENUM('TRIAL', 'BASIC', 'PREMIUM') NOT NULL DEFAULT 'TRIAL' COMMENT 'G√≥i d·ªãch v·ª•: TRIAL, BASIC, PREMIUM',
    invoice_quota INT NOT NULL DEFAULT 100 COMMENT 'H·∫°n m·ª©c h√≥a ƒë∆°n/th√°ng',
    invoice_used INT NOT NULL DEFAULT 0 COMMENT 'H√≥a ƒë∆°n ƒë√£ s·ª≠ d·ª•ng trong th√°ng',
    is_using_hsm BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'S·ª≠ d·ª•ng HSM hay USB Token ƒë·ªÉ k√Ω ƒëi·ªán t·ª≠',
    status ENUM('ACTIVE', 'INACTIVE', 'SUSPENDED') NOT NULL DEFAULT 'ACTIVE' COMMENT 'Tr·∫°ng th√°i ho·∫°t ƒë·ªông',
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'C·ªù x√≥a m·ªÅm',
    deleted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    INDEX idx_tax_code (tax_code),
    INDEX idx_status (status),
    INDEX idx_subscription_plan (subscription_plan),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω doanh nghi·ªáp s·ª≠ d·ª•ng d·ªãch v·ª• h√≥a ƒë∆°n ƒëi·ªán t·ª≠';


-- 2. Merchant Users - T√†i kho·∫£n ng∆∞·ªùi d√πng c·ªßa Merchant
CREATE TABLE merchant_users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Li√™n k·∫øt v·ªõi doanh nghi·ªáp',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT 'T√™n ƒëƒÉng nh·∫≠p',
    email VARCHAR(255) NOT NULL UNIQUE COMMENT 'Email ng∆∞·ªùi d√πng',
    password_hash VARCHAR(255) NOT NULL COMMENT 'M·∫≠t kh·∫©u ƒë√£ m√£ h√≥a BCrypt',
    full_name VARCHAR(100) COMMENT 'H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß',
    phone VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    avatar_url VARCHAR(500) COMMENT 'URL ·∫£nh ƒë·∫°i di·ªán',
    role ENUM('ADMIN', 'MANAGER', 'STAFF', 'VIEWER') NOT NULL DEFAULT 'STAFF' COMMENT 'Vai tr√≤ trong h·ªá th·ªëng: ADMIN, MANAGER, STAFF, VIEWER',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'K√≠ch ho·∫°t t√†i kho·∫£n',
    is_primary BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'T√†i kho·∫£n ch√≠nh c·ªßa doanh nghi·ªáp',
    last_login_at TIMESTAMP NULL COMMENT 'ƒêƒÉng nh·∫≠p l·∫ßn cu·ªëi',
    failed_login_attempts INT NOT NULL DEFAULT 0 COMMENT 'S·ªë l·∫ßn ƒëƒÉng nh·∫≠p sai',
    locked_until TIMESTAMP NULL COMMENT 'Kh√≥a t√†i kho·∫£n ƒë·∫øn th·ªùi ƒëi·ªÉm',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    CONSTRAINT fk_merchant_users_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_role (role),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='T√†i kho·∫£n ng∆∞·ªùi d√πng thu·ªôc Merchant';


-- 3. API Credentials - B·∫£o m·∫≠t v√† t√≠ch h·ª£p API


CREATE TABLE api_credentials (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu credential',
    client_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'ID c√¥ng khai c·ªßa ·ª©ng d·ª•ng',
    api_key_hash VARCHAR(255) NOT NULL COMMENT 'Hash c·ªßa API Key (SHA-256)',
    api_key_prefix VARCHAR(8) NOT NULL COMMENT '8 k√Ω t·ª± ƒë·∫ßu c·ªßa API Key (hi·ªÉn th·ªã)',
    scopes TEXT NOT NULL COMMENT 'Quy·ªÅn h·∫°n - JSON array: [invoice.create, invoice.view]',
    ip_whitelist TEXT NULL COMMENT 'Danh s√°ch IP ƒë∆∞·ª£c ph√©p - JSON array ho·∫∑c NULL',
    rate_limit_per_hour INT NOT NULL DEFAULT 1000 COMMENT 'Gi·ªõi h·∫°n request/gi·ªù',
    rate_limit_per_day INT NOT NULL DEFAULT 10000 COMMENT 'Gi·ªõi h·∫°n request/ng√†y',
    request_count_hour INT NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong gi·ªù',
    request_count_day INT NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong ng√†y',
    request_count_resetted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm reset counter',
    expired_at TIMESTAMP NULL COMMENT 'Ng√†y h·∫øt h·∫°n - NULL l√† kh√¥ng gi·ªõi h·∫°n',
    last_used_at TIMESTAMP NULL COMMENT 'L·∫ßn s·ª≠ d·ª•ng cu·ªëi',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    created_by BIGINT NULL COMMENT 'Ng∆∞·ªùi t·∫°o - merchant_users.id',
    
    CONSTRAINT fk_api_credentials_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    CONSTRAINT fk_api_credentials_created_by FOREIGN KEY (created_by) 
        REFERENCES merchant_users(id) ON DELETE SET NULL,
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_client_id (client_id),
    INDEX idx_api_key_hash (api_key_hash),
    INDEX idx_expired_at (expired_at),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Credentials cho API access';


-- 4. Service Providers - Nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠
CREATE TABLE service_providers (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    provider_code VARCHAR(20) NOT NULL UNIQUE COMMENT 'M√£ provider: VNPT, VIETTEL, MISA, BKAV',
    provider_name VARCHAR(100) NOT NULL COMMENT 'T√™n ƒë·∫ßy ƒë·ªß nh√† cung c·∫•p',
    official_api_url VARCHAR(500) NOT NULL COMMENT 'URL API ch√≠nh th·ª©c',
    documentation_url VARCHAR(500) NULL COMMENT 'Link t√†i li·ªáu API',
    support_email VARCHAR(255) NULL COMMENT 'Email h·ªó tr·ª£',
    support_phone VARCHAR(20) NULL COMMENT 'Hotline h·ªó tr·ª£',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'Provider c√≤n ho·∫°t ƒë·ªông',
    is_default BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh c·ªßa h·ªá th·ªëng',
    display_order INT NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
    extra_config_schema JSON NULL COMMENT 'Schema c·∫•u h√¨nh b·ªï sung cho provider',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    INDEX idx_provider_code (provider_code),
    INDEX idx_is_active (is_active),
    INDEX idx_is_default (is_default),
    INDEX idx_display_order (display_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠';

-- Insert default providers
INSERT INTO service_providers (provider_code, provider_name, official_api_url, is_active, is_default, display_order) VALUES
('VNPT', 'VNPT Invoice', 'https://api.vnptinvoice.com.vn/v1', TRUE, FALSE, 1),
('VIETTEL', 'Viettel Business Invoice', 'https://ebill.vietteltelecom.vn/api/v1', TRUE, FALSE, 2),
('MISA', 'MISA Mimosa', 'https://api.misa.com.vn/einvoice/v1', FALSE, FALSE, 3),
('BKAV', 'BKAV eInvoice', 'https://einvoice.bkav.com/api/v1', FALSE, FALSE, 4);


-- 5. Merchant Provider Configs - C·∫•u h√¨nh ri√™ng c·ªßa Merchant
CREATE TABLE merchant_provider_configs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu',
    provider_id BIGINT NOT NULL COMMENT 'Nh√† cung c·∫•p ƒë∆∞·ª£c ch·ªçn',
    username_service VARCHAR(100) NOT NULL COMMENT 'T√†i kho·∫£n API do Provider c·∫•p',
    password_service_encrypted VARCHAR(500) NOT NULL COMMENT 'M·∫≠t kh·∫©u API - ƒë√£ m√£ h√≥a AES-256',
    certificate_serial VARCHAR(100) NULL COMMENT 'Serial number c·ªßa ch·ª©ng th∆∞ s·ªë',
    certificate_data TEXT NULL COMMENT 'Ch·ª©ng th∆∞ s·ªë - ƒë√£ m√£ h√≥a',
    certificate_chain LONGTEXT NULL COMMENT 'Chu·ªói ch·ª©ng th∆∞ s·ªë ƒë·∫ßy ƒë·ªß (Certificate Chain)',
    certificate_expired_at TIMESTAMP NULL COMMENT 'H·∫°n ch·ª©ng th∆∞ s·ªë',
    extra_config JSON NULL COMMENT 'C·∫•u h√¨nh b·ªï sung: pattern, serial, template',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C·∫•u h√¨nh c√≤n hi·ªáu l·ª±c',
    is_default BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh c·ªßa Merchant',
    last_sync_at TIMESTAMP NULL COMMENT 'L·∫ßn ƒë·ªìng b·ªô cu·ªëi v·ªõi Provider',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    CONSTRAINT fk_mpc_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    CONSTRAINT fk_mpc_provider FOREIGN KEY (provider_id) 
        REFERENCES service_providers(id) ON DELETE RESTRICT,
    CONSTRAINT uq_merchant_provider UNIQUE (merchant_id, provider_id),
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_provider_id (provider_id),
    INDEX idx_is_active (is_active),
    INDEX idx_is_default (is_default)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='C·∫•u h√¨nh k·∫øt n·ªëi Provider cho t·ª´ng Merchant';


-- 6. Invoice Templates - Qu·∫£n l√Ω M·∫´u s·ªë & K√Ω hi·ªáu h√≥a ƒë∆°n
CREATE TABLE invoice_templates (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu m·∫´u',
    provider_id BIGINT NOT NULL COMMENT 'Nh√† cung c·∫•p h√≥a ƒë∆°n',
    invoice_type_code VARCHAR(10) NOT NULL COMMENT 'Lo·∫°i h√≥a ƒë∆°n: 01GTKT, 02GTTT, 07KPTQ, 03KPTQ...',
    template_code VARCHAR(20) NOT NULL COMMENT 'M·∫´u h√≥a ƒë∆°n: 01GTKT0/001, 02GTTT0/001...',
    symbol_code VARCHAR(10) NOT NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n: AA/22E, AB/23T...',
    current_number INT NOT NULL DEFAULT 0 COMMENT 'S·ªë hi·ªán h√≥a ƒë∆°n hi·ªán t·∫°i',
    prefix VARCHAR(20) NULL COMMENT 'Ti·ªÅn t·ªë s·ªë h√≥a ƒë∆°n',
    suffix VARCHAR(20) NULL COMMENT 'H·∫≠u t·ªë s·ªë h√≥a ƒë∆°n',
    min_number INT NOT NULL DEFAULT 1 COMMENT 'S·ªë b·∫Øt ƒë·∫ßu',
    max_number INT NOT NULL DEFAULT 99999 COMMENT 'S·ªë k·∫øt th√∫c',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'M·∫´u c√≤n hi·ªáu l·ª±c',
    is_sequential BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'S·ª≠ d·ª•ng s·ªë th·ª© t·ª± li√™n t·ª•c',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    CONSTRAINT fk_invoice_template_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    CONSTRAINT fk_invoice_template_provider FOREIGN KEY (provider_id) 
        REFERENCES service_providers(id) ON DELETE RESTRICT,
    CONSTRAINT uq_merchant_template UNIQUE (merchant_id, template_code, symbol_code),
    
    INDEX idx_template_merchant (merchant_id),
    INDEX idx_template_code (template_code),
    INDEX idx_symbol_code (symbol_code),
    INDEX idx_invoice_type (invoice_type_code),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω m·∫´u s·ªë v√† k√Ω hi·ªáu h√≥a ƒë∆°n theo quy ƒë·ªãnh';


-- 7. Customers - Danh m·ª•c kh√°ch h√†ng c·ªßa Merchant
CREATE TABLE customers (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu kh√°ch h√†ng',
    customer_code VARCHAR(50) NULL COMMENT 'M√£ kh√°ch h√†ng n·ªôi b·ªô',
    tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø kh√°ch h√†ng',
    name VARCHAR(255) NOT NULL COMMENT 'T√™n kh√°ch h√†ng/ƒë∆°n v·ªã',
    address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ',
    email VARCHAR(255) NULL COMMENT 'Email nh·∫≠n h√≥a ƒë∆°n',
    phone VARCHAR(20) NULL COMMENT 'ƒêi·ªán tho·∫°i',
    contact_person VARCHAR(100) NULL COMMENT 'Ng∆∞·ªùi li√™n h·ªá',
    bank_account VARCHAR(50) NULL COMMENT 'T√†i kho·∫£n ng√¢n h√†ng',
    bank_name VARCHAR(100) NULL COMMENT 'T√™n ng√¢n h√†ng',
    note TEXT NULL COMMENT 'Ghi ch√∫',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n ho·∫°t ƒë·ªông',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    CONSTRAINT fk_customer_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    
    INDEX idx_customer_merchant (merchant_id),
    INDEX idx_customer_code (customer_code),
    INDEX idx_tax_code (tax_code),
    INDEX idx_name (name),
    INDEX idx_email (email),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c kh√°ch h√†ng th∆∞·ªùng xuy√™n c·ªßa Merchant';


-- 8. Invoices Metadata - Th√¥ng tin t√≥m t·∫Øt h√≥a ƒë∆°n
CREATE TABLE invoices_metadata (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp ph√°t h√†nh',
    provider_id BIGINT NULL COMMENT 'Provider x·ª≠ l√Ω h√≥a ƒë∆°n',
    provider_config_id BIGINT NULL COMMENT 'C·∫•u h√¨nh Provider ƒë∆∞·ª£c s·ª≠ d·ª•ng',
    invoice_template_id BIGINT NULL COMMENT 'M·∫´u h√≥a ƒë∆°n ƒë∆∞·ª£c s·ª≠ d·ª•ng',
    client_request_id VARCHAR(100) NULL COMMENT 'ID request t·ª´ Merchant',
    
    -- Th√¥ng tin h√≥a ƒë∆°n
    invoice_number VARCHAR(20) NULL COMMENT 'S·ªë h√≥a ƒë∆°n t·ª´ Provider tr·∫£ v·ªÅ',
    symbol_code VARCHAR(10) NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n (VD: 1C23TML)',
    invoice_type_code VARCHAR(10) NULL COMMENT 'M√£ lo·∫°i h√≥a ƒë∆°n: 01GTKT, 02GTTT, 07KPTQ...',
    template_code VARCHAR(20) NULL COMMENT 'M·∫´u h√≥a ƒë∆°n: 01GTKT0/001, 02GTTT0/001...',
    is_summary_invoice BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'H√≥a ƒë∆°n t·ªïng h·ª£p hay h√≥a ƒë∆°n chi ti·∫øt',
    
    -- Th√¥ng tin C∆° quan Thu·∫ø
    cqt_code VARCHAR(50) NULL COMMENT 'M√£ C∆° quan Thu·∫ø qu·∫£n l√Ω',
    
    -- Th√¥ng tin ng∆∞·ªùi b√°n (t·ª´ merchant data)
    seller_name VARCHAR(255) NULL COMMENT 'T√™n ng∆∞·ªùi b√°n',
    seller_tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi b√°n',
    seller_address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi b√°n',
    
    -- Th√¥ng tin ng∆∞·ªùi mua
    buyer_name VARCHAR(255) NULL COMMENT 'T√™n ng∆∞·ªùi mua',
    buyer_tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi mua',
    buyer_email VARCHAR(255) NULL COMMENT 'Email ng∆∞·ªùi mua (nh·∫≠n h√≥a ƒë∆°n)',
    buyer_phone VARCHAR(20) NULL COMMENT 'ƒêi·ªán tho·∫°i ng∆∞·ªùi mua',
    buyer_address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi mua',
    customer_id BIGINT NULL COMMENT 'Li√™n k·∫øt v·ªõi b·∫£ng customers',
    
    -- Th√¥ng tin t√†i ch√≠nh
    subtotal_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø',
    tax_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ø',
    discount_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng chi·∫øt kh·∫•u',
    total_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thanh to√°n',
    currency_code VARCHAR(3) NOT NULL DEFAULT 'VND' COMMENT 'ƒê∆°n v·ªã ti·ªÅn t·ªá',
    exchange_rate DECIMAL(10,4) NOT NULL DEFAULT 1.0000 COMMENT 'T·ª∑ gi√° v·ªõi VND',
    
    -- Th√¥ng tin th·ªùi gian
    issue_date DATE NULL COMMENT 'Ng√†y l·∫≠p h√≥a ƒë∆°n',
    accounting_date DATE NULL COMMENT 'Ng√†y h·∫°ch to√°n',
    due_date DATE NULL COMMENT 'Ng√†y thanh to√°n ƒë·∫øn h·∫°n',
    
    -- Tr·∫°ng th√°i v√† ƒëi·ªÅu kho·∫£n
    status ENUM('DRAFT', 'PENDING', 'SIGNING', 'SENT_TO_PROVIDER', 'SUCCESS', 'FAILED', 'CANCELLED', 'REPLACED') NOT NULL DEFAULT 'DRAFT' COMMENT 'Tr·∫°ng th√°i x·ª≠ l√Ω h√≥a ƒë∆°n',
    status_message TEXT NULL COMMENT 'Th√¥ng b√°o tr·∫°ng th√°i chi ti·∫øt',
    cancellation_reason VARCHAR(500) NULL COMMENT 'L√Ω do h·ªßy/thay th·∫ø',
    replaced_by_invoice_id BIGINT NULL COMMENT 'ID h√≥a ƒë∆°n thay th·∫ø',
    
    -- Tracking
    signed_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm k√Ω ƒëi·ªán t·ª≠',
    sent_to_provider_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i sang Provider',
    received_from_provider_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
    delivered_to_buyer_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i h√≥a ƒë∆°n cho ng∆∞·ªùi mua',
    
    -- Provider response reference
    provider_transaction_code VARCHAR(100) NULL COMMENT 'M√£ giao d·ªãch t·ª´ Provider',
    provider_error_code VARCHAR(50) NULL COMMENT 'M√£ l·ªói t·ª´ Provider',
    provider_error_message TEXT NULL COMMENT 'Chi ti·∫øt l·ªói t·ª´ Provider',
    
    -- Soft delete
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'H√≥a ƒë∆°n ƒë√£ b·ªã x√≥a',
    deleted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
    deleted_by BIGINT NULL COMMENT 'Ng∆∞·ªùi x√≥a - merchant_users.id',
    
    -- Timestamps
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    -- Foreign Keys
    CONSTRAINT fk_invoice_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE RESTRICT,
    CONSTRAINT fk_invoice_provider FOREIGN KEY (provider_id) 
        REFERENCES service_providers(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_config FOREIGN KEY (provider_config_id) 
        REFERENCES merchant_provider_configs(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_template FOREIGN KEY (invoice_template_id) 
        REFERENCES invoice_templates(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_customer FOREIGN KEY (customer_id) 
        REFERENCES customers(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_replaced_by FOREIGN KEY (replaced_by_invoice_id) 
        REFERENCES invoices_metadata(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_deleted_by FOREIGN KEY (deleted_by) 
        REFERENCES merchant_users(id) ON DELETE SET NULL,
    
    -- Indexes for performance
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_provider_id (provider_id),
    INDEX idx_invoice_number (invoice_number),
    INDEX idx_symbol_code (symbol_code),
    INDEX idx_buyer_tax_code (buyer_tax_code),
    INDEX idx_status (status),
    INDEX idx_issue_date (issue_date),
    INDEX idx_created_at (created_at),
    INDEX idx_client_request_id (client_request_id),
    INDEX idx_merchant_status (merchant_id, status),
    INDEX idx_merchant_created (merchant_id, created_at),
    INDEX idx_cqt_code (cqt_code),
    INDEX idx_invoice_template (invoice_template_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Metadata h√≥a ƒë∆°n - ph·ª•c v·ª• tra c·ª©u nhanh';


-- 9. Invoice Items - Chi ti·∫øt h√†ng h√≥a/d·ªãch v·ª• trong h√≥a ƒë∆°n
CREATE TABLE invoice_items (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    invoice_id BIGINT NOT NULL COMMENT 'ID h√≥a ƒë∆°n cha',
    line_number INT NOT NULL DEFAULT 1 COMMENT 'S·ªë th·ª© t·ª± d√≤ng',
    product_name VARCHAR(500) NOT NULL COMMENT 'T√™n s·∫£n ph·∫©m/d·ªãch v·ª•',
    product_code VARCHAR(100) NULL COMMENT 'M√£ s·∫£n ph·∫©m theo danh m·ª•c',
    unit_name VARCHAR(50) NOT NULL COMMENT 'ƒê∆°n v·ªã t√≠nh: c√°i, kg, chi·∫øc...',
    quantity DECIMAL(18,4) NOT NULL DEFAULT 0 COMMENT 'S·ªë l∆∞·ª£ng',
    unit_price DECIMAL(18,4) NOT NULL DEFAULT 0 COMMENT 'ƒê∆°n gi√° tr∆∞·ªõc thu·∫ø',
    amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Th√†nh ti·ªÅn = quantity * unit_price',
    discount_rate DECIMAL(5,2) NOT NULL DEFAULT 0 COMMENT 'T·ª∑ l·ªá chi·∫øt kh·∫•u (%)',
    discount_amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Ti·ªÅn chi·∫øt kh·∫•u',
    tax_rate DECIMAL(5,2) NOT NULL DEFAULT 0 COMMENT 'Thu·∫ø su·∫•t GTGT (%)',
    tax_amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Ti·ªÅn thu·∫ø GTGT',
    total_amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Th√†nh ti·ªÅn bao g·ªìm thu·∫ø',
    description TEXT NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt s·∫£n ph·∫©m',
    tax_category_code VARCHAR(20) NULL COMMENT 'M√£ nh√≥m h√†ng h√≥a theo thu·∫ø',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    
    CONSTRAINT fk_invoice_item_invoice FOREIGN KEY (invoice_id) 
        REFERENCES invoices_metadata(id) ON DELETE CASCADE,
    
    INDEX idx_item_invoice (invoice_id),
    INDEX idx_line_number (line_number)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Chi ti·∫øt t·ª´ng d√≤ng h√†ng h√≥a/d·ªãch v·ª• trong h√≥a ƒë∆°n';


-- 10. Invoice Payloads - L∆∞u tr·ªØ n·ªôi dung XML/JSON g·ªëc (Thay th·∫ø MongoDB)
CREATE TABLE invoice_payloads (
    invoice_id BIGINT NOT NULL PRIMARY KEY COMMENT 'ID h√≥a ƒë∆°n - kh√≥a ch√≠nh v√† kh√≥a ngo·∫°i',
    raw_data JSON NULL COMMENT 'D·ªØ li·ªáu th√¥ request/response d·∫°ng JSON',
    xml_content LONGTEXT NULL COMMENT 'N·ªôi dung XML g·ªëc c·ªßa h√≥a ƒë∆°n (ph·ª•c v·ª• in ·∫•n)',
    json_content LONGTEXT NULL COMMENT 'N·ªôi dung JSON ƒë·∫ßy ƒë·ªß c·ªßa h√≥a ƒë∆°n',
    signed_xml LONGTEXT NULL COMMENT 'XML ƒë√£ k√Ω ƒëi·ªán t·ª≠ (ch·ªØ k√Ω s·ªë)',
    pdf_data LONGTEXT NULL COMMENT 'D·ªØ li·ªáu PDF ƒë√£ t·∫°o (base64)',
    extra_data JSON NULL COMMENT 'D·ªØ li·ªáu b·ªï sung kh√°c',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm l∆∞u',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    CONSTRAINT fk_invoice_payload_invoice FOREIGN KEY (invoice_id) 
        REFERENCES invoices_metadata(id) ON DELETE CASCADE,
    
    INDEX idx_payload_created (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u tr·ªØ n·ªôi dung XML/JSON g·ªëc h√≥a ƒë∆°n - thay th·∫ø MongoDB';


-- 11. Tax Authority Responses - Ph·∫£n h·ªìi t·ª´ C∆° quan Thu·∫ø
CREATE TABLE tax_authority_responses (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    invoice_id BIGINT NOT NULL COMMENT 'H√≥a ƒë∆°n li√™n quan',
    cqt_code VARCHAR(50) NOT NULL COMMENT 'M√£ C∆° quan Thu·∫ø',
    status_from_cqt VARCHAR(50) NOT NULL COMMENT 'Tr·∫°ng th√°i t·ª´ C∆° quan Thu·∫ø: APPROVED, REJECTED, PENDING',
    processing_code VARCHAR(100) NULL COMMENT 'M√£ x·ª≠ l√Ω t·ª´ C∆° quan Thu·∫ø',
    signature_data TEXT NULL COMMENT 'D·ªØ li·ªáu ch·ªØ k√Ω t·ª´ C∆° quan Thu·∫ø',
    raw_response JSON NULL COMMENT 'Response th√¥ t·ª´ C∆° quan Thu·∫ø',
    error_code VARCHAR(50) NULL COMMENT 'M√£ l·ªói t·ª´ C∆° quan Thu·∫ø',
    error_message TEXT NULL COMMENT 'Th√¥ng b√°o l·ªói t·ª´ C∆° quan Thu·∫ø',
    received_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
    processed_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x·ª≠ l√Ω ho√†n t·∫•t',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o b·∫£n ghi',
    
    CONSTRAINT fk_tax_response_invoice FOREIGN KEY (invoice_id) 
        REFERENCES invoices_metadata(id) ON DELETE CASCADE,
    
    INDEX idx_tax_response_invoice (invoice_id),
    INDEX idx_cqt_code (cqt_code),
    INDEX idx_status_cqt (status_from_cqt),
    INDEX idx_received_at (received_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u v·∫øt t∆∞∆°ng t√°c v·ªõi C∆° quan Thu·∫ø';


-- 12. Audit Log - Nh·∫≠t k√Ω thao t√°c
CREATE TABLE audit_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NULL COMMENT 'Doanh nghi·ªáp li√™n quan',
    user_id BIGINT NULL COMMENT 'Ng∆∞·ªùi th·ª±c hi·ªán',
    entity_type VARCHAR(50) NOT NULL COMMENT 'Lo·∫°i entity: Invoice, Merchant, Config...',
    entity_id BIGINT NOT NULL COMMENT 'ID c·ªßa entity',
    action VARCHAR(50) NOT NULL COMMENT 'H√†nh ƒë·ªông: CREATE, UPDATE, DELETE, STATUS_CHANGE',
    old_value JSON NULL COMMENT 'Gi√° tr·ªã c≈©',
    new_value JSON NULL COMMENT 'Gi√° tr·ªã m·ªõi',
    ip_address VARCHAR(45) NULL COMMENT 'IP th·ª±c hi·ªán',
    user_agent VARCHAR(500) NULL COMMENT 'User Agent c·ªßa browser/client',
    request_id VARCHAR(100) NULL COMMENT 'ID request t·ª´ frontend',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm x·∫£y ra',
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_user_id (user_id),
    INDEX idx_entity (entity_type, entity_id),
    INDEX idx_action (action),
    INDEX idx_created_at (created_at),
    INDEX idx_merchant_entity (merchant_id, entity_type, entity_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Nh·∫≠t k√Ω thay ƒë·ªïi h·ªá th·ªëng';


-- 13. System Configuration - C·∫•u h√¨nh h·ªá th·ªëng
CREATE TABLE system_config (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    config_key VARCHAR(100) NOT NULL UNIQUE COMMENT 'Kh√≥a c·∫•u h√¨nh',
    config_value TEXT NOT NULL COMMENT 'Gi√° tr·ªã c·∫•u h√¨nh',
    config_type VARCHAR(20) NOT NULL DEFAULT 'STRING' COMMENT 'Lo·∫°i: STRING, NUMBER, BOOLEAN, JSON',
    description VARCHAR(500) NULL COMMENT 'M√¥ t·∫£ c·∫•u h√¨nh',
    is_encrypted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'C√≥ c·∫ßn m√£ h√≥a kh√¥ng',
    is_editable BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≥ th·ªÉ ch·ªânh s·ª≠a kh√¥ng',
    updated_by BIGINT NULL COMMENT 'Ng∆∞·ªùi c·∫≠p nh·∫≠t cu·ªëi',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    CONSTRAINT fk_config_updated_by FOREIGN KEY (updated_by) 
        REFERENCES merchant_users(id) ON DELETE SET NULL,
    
    INDEX idx_config_key (config_key)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='C·∫•u h√¨nh h·ªá th·ªëng';

-- Insert default configurations
INSERT INTO system_config (config_key, config_value, config_type, description) VALUES
('SYSTEM_NAME', 'EInvoiceHub', 'STRING', 'T√™n hi·ªÉn th·ªã c·ªßa h·ªá th·ªëng'),
('INVOICE_EXPIRY_DAYS', '30', 'NUMBER', 'S·ªë ng√†y h√≥a ƒë∆°n c√≥ hi·ªáu l·ª±c sau khi ph√°t h√†nh'),
('MAX_RETRY_ATTEMPTS', '3', 'NUMBER', 'S·ªë l·∫ßn th·ª≠ l·∫°i khi g·ªçi Provider th·∫•t b·∫°i'),
('RETRY_DELAY_MS', '1000', 'NUMBER', 'Th·ªùi gian ch·ªù gi·ªØa c√°c l·∫ßn th·ª≠ l·∫°i (milliseconds)'),
('SESSION_TIMEOUT_MINUTES', '60', 'NUMBER', 'Th·ªùi gian timeout c·ªßa session'),
('PASSWORD_MIN_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i t·ªëi thi·ªÉu c·ªßa m·∫≠t kh·∫©u'),
('API_KEY_PREFIX_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i prefix hi·ªÉn th·ªã c·ªßa API Key'),
('DEFAULT_CURRENCY', 'VND', 'STRING', 'ƒê∆°n v·ªã ti·ªÅn t·ªá m·∫∑c ƒë·ªãnh'),
('TAX_DEFAULT_RATE', '10.00', 'NUMBER', 'Thu·∫ø su·∫•t m·∫∑c ƒë·ªãnh (%)'),
('INVOICE_NUMBER_FORMAT', 'PREFIX + NUMBER + SUFFIX', 'STRING', 'C·∫•u tr√∫c s·ªë h√≥a ƒë∆°n m·∫∑c ƒë·ªãnh');

-- End of Migration V1
</file>

<file path="src/main/resources/db/migration/V1__Initial_Schema.sql">
-- EInvoiceHub Database Schema - Version 3
-- Database: MariaDB   |   Character Set: utf8mb4_unicode_ci

--  I: C√ÅC B·∫¢NG DANH M·ª§C (CATALOG TABLES)
-- 1. Invoice Types - Danh m·ª•c lo·∫°i h√≥a ƒë∆°n chu·∫©n TCT
CREATE TABLE invoice_types (
       id BIGINT AUTO_INCREMENT PRIMARY KEY,
       type_code VARCHAR(10) NOT NULL UNIQUE COMMENT 'M√£ lo·∫°i h√≥a ƒë∆°n: 01GTKT, 02GTTT, 07KPTQ, 03KPTQ...',
       type_name VARCHAR(100) NOT NULL COMMENT 'T√™n lo·∫°i h√≥a ƒë∆°n',
       description TEXT NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
       is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
       display_order INT NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
       created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
       updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
       INDEX idx_type_code (type_code),
       INDEX idx_is_active (is_active),
       INDEX idx_display_order (display_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c lo·∫°i h√≥a ƒë∆°n theo quy ƒë·ªãnh TCT';

-- Insert danh m·ª•c lo·∫°i h√≥a ƒë∆°n chu·∫©n
INSERT INTO invoice_types (type_code, type_name, description, display_order) VALUES
     ('01GTKT', 'H√≥a ƒë∆°n gi√° tr·ªã gia tƒÉng', 'H√≥a ƒë∆°n GTGT m·∫´u 01GTKT theo Th√¥ng t∆∞ 78/2021/TT-BTC', 1),
     ('02GTTT', 'H√≥a ƒë∆°n b√°n h√†ng', 'H√≥a ƒë∆°n b√°n h√†ng m·∫´u 02GTTT theo Th√¥ng t∆∞ 78/2021/TT-BTC', 2),
     ('07KPTQ', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ ki·ªÉm so√°t', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ ki·ªÉm so√°t theo Ngh·ªã ƒë·ªãnh 123/2020/Nƒê-CP', 3),
     ('03KPTQ', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ kh√¥ng ki·ªÉm so√°t', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ kh√¥ng ki·ªÉm so√°t theo Ngh·ªã ƒë·ªãnh 123/2020/Nƒê-CP', 4),
     ('04HGDL', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ h√†ng kh√¥ng', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ cho d·ªãch v·ª• h√†ng kh√¥ng', 5),
     ('01TTDN', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ t√†i ch√≠nh', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ cho t·ªï ch·ª©c t√≠n d·ª•ng', 6);


-- 2. Payment Methods - Danh m·ª•c ph∆∞∆°ng th·ª©c thanh to√°n chu·∫©n
CREATE TABLE payment_methods (
     id BIGINT AUTO_INCREMENT PRIMARY KEY,
     method_code VARCHAR(10) NOT NULL UNIQUE COMMENT 'M√£ ph∆∞∆°ng th·ª©c: TM (Ti·ªÅn m·∫∑t), CK (Chuy·ªÉn kho·∫£n), TM/CK...',
     method_name VARCHAR(100) NOT NULL COMMENT 'T√™n ph∆∞∆°ng th·ª©c thanh to√°n',
     description TEXT NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
     is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
     display_order INT NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
     created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
     updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

     INDEX idx_method_code (method_code),
     INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c ph∆∞∆°ng th·ª©c thanh to√°n chu·∫©n';

-- Insert danh m·ª•c ph∆∞∆°ng th·ª©c thanh to√°n
INSERT INTO payment_methods (method_code, method_name, description, display_order) VALUES
   ('TM', 'Ti·ªÅn m·∫∑t', 'Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t tr·ª±c ti·∫øp', 1),
   ('CK', 'Chuy·ªÉn kho·∫£n', 'Thanh to√°n qua chuy·ªÉn kho·∫£n ng√¢n h√†ng', 2),
   ('TM/CK', 'Ti·ªÅn m·∫∑t/Chuy·ªÉn kho·∫£n', 'K·∫øt h·ª£p c·∫£ hai h√¨nh th·ª©c', 3),
   ('POS', 'Th·∫ª POS', 'Thanh to√°n qua m√°y POS', 4),
   ('V√ç ƒêI·ªÜN T·ª¨', 'V√≠ ƒëi·ªán t·ª≠', 'Thanh to√°n qua v√≠ ƒëi·ªán t·ª≠ (MoMo, ZaloPay, VNPay...)', 5),
   ('TH·∫∫', 'Th·∫ª ng√¢n h√†ng', 'Thanh to√°n b·∫±ng th·∫ª t√≠n d·ª•ng/ghi n·ª£', 6);


-- 3. VAT Rates - Danh m·ª•c thu·∫ø su·∫•t GTGT
CREATE TABLE vat_rates (
   id BIGINT AUTO_INCREMENT PRIMARY KEY,
   rate_code VARCHAR(10) NOT NULL UNIQUE COMMENT 'M√£ thu·∫ø su·∫•t: 0, 5, 8, 10, KCT, KKKNT',
   rate_percent DECIMAL(5,2) NOT NULL COMMENT 'Gi√° tr·ªã ph·∫ßn trƒÉm thu·∫ø su·∫•t',
   rate_name VARCHAR(100) NOT NULL COMMENT 'T√™n thu·∫ø su·∫•t',
   description TEXT NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
   is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
   display_order INT NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
   created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
   updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
   CONSTRAINT chk_vat_rate_percent CHECK (rate_percent >= 0),
   INDEX idx_rate_code (rate_code),
   INDEX idx_rate_percent (rate_percent),
   INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c thu·∫ø su·∫•t GTGT theo quy ƒë·ªãnh';

-- Insert danh m·ª•c thu·∫ø su·∫•t
INSERT INTO vat_rates (rate_code, rate_percent, rate_name, description, display_order) VALUES
   ('0', 0.00, 'Thu·∫ø su·∫•t 0%', '√Åp d·ª•ng cho h√†ng h√≥a, d·ªãch v·ª• xu·∫•t kh·∫©u', 1),
   ('5', 5.00, 'Thu·∫ø su·∫•t 5%', '√Åp d·ª•ng cho h√†ng h√≥a, d·ªãch v·ª• thi·∫øt y·∫øu', 2),
   ('8', 8.00, 'Thu·∫ø su·∫•t 8%', 'Gi·∫£m thu·∫ø theo Ngh·ªã quy·∫øt 43/2022/QH15', 3),
   ('10', 10.00, 'Thu·∫ø su·∫•t 10%', 'Thu·∫ø su·∫•t th√¥ng th∆∞·ªùng GTGT', 4),
   ('KCT', 0.00, 'Kh√¥ng ch·ªãu thu·∫ø', 'H√†ng h√≥a, d·ªãch v·ª• kh√¥ng ch·ªãu thu·∫ø GTGT', 5),
   ('KKKNT', 0.00, 'Kh√¥ng k√™ khai, t√≠nh n·ªôp', 'H√†ng h√≥a, d·ªãch v·ª• kh√¥ng k√™ khai n·ªôp thu·∫ø GTGT', 6);


-- II: C√ÅC B·∫¢NG NGHI·ªÜP V·ª§ CH√çNH (CORE BUSINESS TABLES)
-- 4. Merchants Table - Qu·∫£n l√Ω doanh nghi·ªáp (ƒê√£ c·∫≠p nh·∫≠t)
CREATE TABLE merchants (
   id BIGINT AUTO_INCREMENT PRIMARY KEY,
   tax_code VARCHAR(20) NOT NULL UNIQUE COMMENT 'M√£ s·ªë thu·∫ø - ƒë·ªãnh danh doanh nghi·ªáp',
   company_name VARCHAR(255) NOT NULL COMMENT 'T√™n c√¥ng ty ƒë·∫ßy ƒë·ªß',
   short_name VARCHAR(100) COMMENT 'T√™n vi·∫øt t·∫Øt',
   address TEXT COMMENT 'ƒê·ªãa ch·ªâ tr·ª• s·ªü ch√≠nh',
   district VARCHAR(100) COMMENT 'Qu·∫≠n/Huy·ªán',
   city VARCHAR(100) COMMENT 'T·ªânh/Th√†nh ph·ªë',
   email VARCHAR(255) COMMENT 'Email li√™n h·ªá',
   phone VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
   representative_name VARCHAR(100) COMMENT 'T√™n ng∆∞·ªùi ƒë·∫°i di·ªán',
   representative_title VARCHAR(100) COMMENT 'Ch·ª©c danh ng∆∞·ªùi ƒë·∫°i di·ªán',
   tax_authority_code VARCHAR(10) NULL COMMENT 'M√£ c∆° quan thu·∫ø qu·∫£n l√Ω (VD: 01GD, 02HT...)',

   subscription_plan ENUM('TRIAL', 'BASIC', 'PREMIUM') NOT NULL DEFAULT 'TRIAL' COMMENT 'G√≥i d·ªãch v·ª•: TRIAL, BASIC, PREMIUM',
   invoice_quota INT NOT NULL DEFAULT 100 COMMENT 'H·∫°n m·ª©c h√≥a ƒë∆°n/th√°ng',
   invoice_used INT NOT NULL DEFAULT 0 COMMENT 'H√≥a ƒë∆°n ƒë√£ s·ª≠ d·ª•ng trong th√°ng',
   is_using_hsm BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'S·ª≠ d·ª•ng HSM hay USB Token ƒë·ªÉ k√Ω ƒëi·ªán t·ª≠',
   status ENUM('ACTIVE', 'INACTIVE', 'SUSPENDED') NOT NULL DEFAULT 'ACTIVE' COMMENT 'Tr·∫°ng th√°i ho·∫°t ƒë·ªông',
   is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'C·ªù x√≥a m·ªÅm',
   deleted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
   created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
   updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

   INDEX idx_tax_code (tax_code),
   INDEX idx_status (status),
   INDEX idx_subscription_plan (subscription_plan),
   INDEX idx_created_at (created_at),
   INDEX idx_tax_authority (tax_authority_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω doanh nghi·ªáp s·ª≠ d·ª•ng d·ªãch v·ª• h√≥a ƒë∆°n ƒëi·ªán t·ª≠';


-- 5. Merchant Users - T√†i kho·∫£n ng∆∞·ªùi d√πng c·ªßa Merchant
CREATE TABLE merchant_users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Li√™n k·∫øt v·ªõi doanh nghi·ªáp',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT 'T√™n ƒëƒÉng nh·∫≠p',
    email VARCHAR(255) NOT NULL UNIQUE COMMENT 'Email ng∆∞·ªùi d√πng',
    password_hash VARCHAR(255) NOT NULL COMMENT 'M·∫≠t kh·∫©u ƒë√£ m√£ h√≥a BCrypt',
    full_name VARCHAR(100) COMMENT 'H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß',
    phone VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    avatar_url VARCHAR(500) COMMENT 'URL ·∫£nh ƒë·∫°i di·ªán',
    role ENUM('ADMIN', 'MANAGER', 'STAFF', 'VIEWER') NOT NULL DEFAULT 'STAFF' COMMENT 'Vai tr√≤ trong h·ªá th·ªëng: ADMIN, MANAGER, STAFF, VIEWER',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'K√≠ch ho·∫°t t√†i kho·∫£n',
    is_primary BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'T√†i kho·∫£n ch√≠nh c·ªßa doanh nghi·ªáp',
    last_login_at TIMESTAMP NULL COMMENT 'ƒêƒÉng nh·∫≠p l·∫ßn cu·ªëi',
    failed_login_attempts INT NOT NULL DEFAULT 0 COMMENT 'S·ªë l·∫ßn ƒëƒÉng nh·∫≠p sai',
    locked_until TIMESTAMP NULL COMMENT 'Kh√≥a t√†i kho·∫£n ƒë·∫øn th·ªùi ƒëi·ªÉm',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT fk_merchant_users_merchant FOREIGN KEY (merchant_id)
        REFERENCES merchants(id) ON DELETE CASCADE,

    INDEX idx_merchant_id (merchant_id),
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_role (role),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='T√†i kho·∫£n ng∆∞·ªùi d√πng thu·ªôc Merchant';

-- 6. API Credentials - B·∫£o m·∫≠t v√† t√≠ch h·ª£p API
CREATE TABLE api_credentials (
     id BIGINT AUTO_INCREMENT PRIMARY KEY,
     merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu credential',
     client_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'ID c√¥ng khai c·ªßa ·ª©ng d·ª•ng',
     api_key_hash VARCHAR(255) NOT NULL COMMENT 'Hash c·ªßa API Key (SHA-256)',
     api_key_prefix VARCHAR(8) NOT NULL COMMENT '8 k√Ω t·ª± ƒë·∫ßu c·ªßa API Key (hi·ªÉn th·ªã)',
     scopes TEXT NOT NULL COMMENT 'Quy·ªÅn h·∫°n - JSON array: [invoice.create, invoice.view]',
     ip_whitelist TEXT NULL COMMENT 'Danh s√°ch IP ƒë∆∞·ª£c ph√©p - JSON array ho·∫∑c NULL',
     rate_limit_per_hour INT NOT NULL DEFAULT 1000 COMMENT 'Gi·ªõi h·∫°n request/gi·ªù',
     rate_limit_per_day INT NOT NULL DEFAULT 10000 COMMENT 'Gi·ªõi h·∫°n request/ng√†y',
     request_count_hour INT NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong gi·ªù',
     request_count_day INT NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong ng√†y',
     request_count_resetted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm reset counter',
     expired_at TIMESTAMP NULL COMMENT 'Ng√†y h·∫øt h·∫°n - NULL l√† kh√¥ng gi·ªõi h·∫°n',
     last_used_at TIMESTAMP NULL COMMENT 'L·∫ßn s·ª≠ d·ª•ng cu·ªëi',
     is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
     created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
     updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

     CONSTRAINT fk_api_credentials_merchant FOREIGN KEY (merchant_id)
         REFERENCES merchants(id) ON DELETE CASCADE,

     INDEX idx_merchant_id (merchant_id),
     INDEX idx_client_id (client_id),
     INDEX idx_api_key_hash (api_key_hash),
     INDEX idx_expired_at (expired_at),
     INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Credentials cho API access';


-- 7. Service Providers - Nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠
CREATE TABLE service_providers (
       id BIGINT AUTO_INCREMENT PRIMARY KEY,
       provider_code VARCHAR(20) NOT NULL UNIQUE COMMENT 'M√£ provider: VNPT, VIETTEL, MISA, BKAV',
       provider_name VARCHAR(100) NOT NULL COMMENT 'T√™n ƒë·∫ßy ƒë·ªß nh√† cung c·∫•p',
       official_api_url VARCHAR(500) NOT NULL COMMENT 'URL API ch√≠nh th·ª©c',
       documentation_url VARCHAR(500) NULL COMMENT 'Link t√†i li·ªáu API',
       support_email VARCHAR(255) NULL COMMENT 'Email h·ªó tr·ª£',
       support_phone VARCHAR(20) NULL COMMENT 'Hotline h·ªó tr·ª£',
       is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'Provider c√≤n ho·∫°t ƒë·ªông',
       is_default BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh c·ªßa h·ªá th·ªëng',
       display_order INT NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
       extra_config_schema JSON NULL COMMENT 'Schema c·∫•u h√¨nh b·ªï sung cho provider',
       created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
       updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

       INDEX idx_provider_code (provider_code),
       INDEX idx_is_active (is_active),
       INDEX idx_is_default (is_default),
       INDEX idx_display_order (display_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠';

-- Insert default providers
INSERT INTO service_providers (provider_code, provider_name, official_api_url, is_active, is_default, display_order) VALUES
                                                                                                               ('BKAV', 'BKAV eInvoice', 'https://einvoice.bkav.com/api/v1', FALSE, FALSE, 4);
-- 8. Merchant Provider Configs - C·∫•u h√¨nh ri√™ng c·ªßa Merchant
CREATE TABLE merchant_provider_configs (
       id BIGINT AUTO_INCREMENT PRIMARY KEY,
       merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu',
       provider_id BIGINT NOT NULL COMMENT 'Nh√† cung c·∫•p ƒë∆∞·ª£c ch·ªçn',
       username_service VARCHAR(100) NOT NULL COMMENT 'T√†i kho·∫£n API do Provider c·∫•p',
       password_service_encrypted VARCHAR(500) NOT NULL COMMENT 'M·∫≠t kh·∫©u API - ƒë√£ m√£ h√≥a AES-256',
       certificate_serial VARCHAR(100) NULL COMMENT 'Serial number c·ªßa ch·ª©ng th∆∞ s·ªë',
       certificate_data TEXT NULL COMMENT 'Ch·ª©ng th∆∞ s·ªë - ƒë√£ m√£ h√≥a',
       certificate_chain LONGTEXT NULL COMMENT 'Chu·ªói ch·ª©ng th∆∞ s·ªë ƒë·∫ßy ƒë·ªß (Certificate Chain)',
       certificate_expired_at TIMESTAMP NULL COMMENT 'H·∫°n ch·ª©ng th∆∞ s·ªë',
       extra_config JSON NULL COMMENT 'C·∫•u h√¨nh b·ªï sung: pattern, serial, template',
       is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C·∫•u h√¨nh c√≤n hi·ªáu l·ª±c',
       is_default BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh c·ªßa Merchant',
       last_sync_at TIMESTAMP NULL COMMENT 'L·∫ßn ƒë·ªìng b·ªô cu·ªëi v·ªõi Provider',
       created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
       updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

       CONSTRAINT fk_mpc_merchant FOREIGN KEY (merchant_id)
           REFERENCES merchants(id) ON DELETE CASCADE,
       CONSTRAINT fk_mpc_provider FOREIGN KEY (provider_id)
           REFERENCES service_providers(id) ON DELETE RESTRICT,
       CONSTRAINT uq_merchant_provider UNIQUE (merchant_id, provider_id),

       INDEX idx_merchant_id (merchant_id),
       INDEX idx_provider_id (provider_id),
       INDEX idx_is_active (is_active),
       INDEX idx_is_default (is_default)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='C·∫•u h√¨nh k·∫øt n·ªëi Provider cho t·ª´ng Merchant';


-- 9. Invoice Registrations - Qu·∫£n l√Ω ƒëƒÉng k√Ω d·∫£i s·ªë h√≥a ƒë∆°n v·ªõi CQT
CREATE TABLE invoice_registrations (
   id BIGINT AUTO_INCREMENT PRIMARY KEY,
   registration_number VARCHAR(50) NULL COMMENT 'S·ªë quy·∫øt ƒë·ªãnh/ph√™ duy·ªát c·ªßa CQT',
   from_number BIGINT NOT NULL COMMENT 'S·ªë b·∫Øt ƒë·∫ßu c·ªßa d·∫£i (VD: 0000001)',
   to_number BIGINT NOT NULL COMMENT 'S·ªë k·∫øt th√∫c c·ªßa d·∫£i (VD: 0001000)',
   quantity BIGINT NOT NULL COMMENT 'S·ªë l∆∞·ª£ng h√≥a ƒë∆°n trong d·∫£i',
   current_number BIGINT NOT NULL DEFAULT 0 COMMENT 'S·ªë hi·ªán t·∫°i ƒë√£ s·ª≠ d·ª•ng',

   effective_date DATE NOT NULL COMMENT 'Ng√†y c√≥ hi·ªáu l·ª±c',
   expiration_date DATE NULL COMMENT 'Ng√†y h·∫øt h·∫°n (n·∫øu c√≥)',

   status ENUM('ACTIVE', 'EXHAUSTED', 'EXPIRED', 'CANCELLED') NOT NULL DEFAULT 'ACTIVE' COMMENT 'Tr·∫°ng th√°i ƒëƒÉng k√Ω',
   issued_by VARCHAR(255) NULL COMMENT 'Ng∆∞·ªùi ph√™ duy·ªát/CQT',
   note TEXT NULL COMMENT 'Ghi ch√∫ b·ªï sung',

   created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
   updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

   CONSTRAINT chk_registration_range CHECK (from_number <= to_number),
   CONSTRAINT chk_registration_quantity CHECK (quantity = (to_number - from_number + 1)),

   INDEX idx_registration_merchant (merchant_id),
   INDEX idx_registration_status (status),
   INDEX idx_registration_effective (effective_date),
   INDEX idx_registration_expiration (expiration_date),
   INDEX idx_registration_number (registration_number)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω l·ªãch s·ª≠ ƒëƒÉng k√Ω d·∫£i s·ªë h√≥a ƒë∆°n v·ªõi C∆° quan Thu·∫ø';


-- 10. Invoice Templates - Qu·∫£n l√Ω M·∫´u s·ªë & K√Ω hi·ªáu h√≥a ƒë∆°n
CREATE TABLE invoice_templates (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu m·∫´u',
    invoice_type_id BIGINT NULL COMMENT 'Lo·∫°i h√≥a ƒë∆°n (li√™n k·∫øt b·∫£ng invoice_types)',
    invoice_registration_id BIGINT NULL COMMENT 'ƒêƒÉng k√Ω d·∫£i s·ªë li√™n k·∫øt',

    template_code VARCHAR(20) NOT NULL COMMENT 'M·∫´u h√≥a ƒë∆°n: 01GTKT0/001, 02GTTT0/001...',
    symbol_code VARCHAR(10) NOT NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n: AA/22E, AB/23T...',
    current_number INT NOT NULL DEFAULT 0 COMMENT 'S·ªë hi·ªán h√≥a ƒë∆°n hi·ªán t·∫°i',
    prefix VARCHAR(20) NULL COMMENT 'Ti·ªÅn t·ªë s·ªë h√≥a ƒë∆°n',
    suffix VARCHAR(20) NULL COMMENT 'H·∫≠u t·ªë s·ªë h√≥a ƒë∆°n',
    min_number INT NOT NULL DEFAULT 1 COMMENT 'S·ªë b·∫Øt ƒë·∫ßu',
    max_number INT NOT NULL DEFAULT 99999 COMMENT 'S·ªë k·∫øt th√∫c',

    CONSTRAINT chk_symbol_code_format CHECK (symbol_code REGEXP '^[A-Z0-9]{2,7}/[0-9]{2,4}[A-Z0-9]*$'),

    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'M·∫´u c√≤n hi·ªáu l·ª±c',
    is_sequential BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'S·ª≠ d·ª•ng s·ªë th·ª© t·ª± li√™n t·ª•c',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT fk_invoice_template_merchant FOREIGN KEY (merchant_id)
        REFERENCES merchants(id) ON DELETE CASCADE,
    CONSTRAINT fk_invoice_template_type FOREIGN KEY (invoice_type_id)
        REFERENCES invoice_types(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_template_registration FOREIGN KEY (invoice_registration_id)
        REFERENCES invoice_registrations(id) ON DELETE SET NULL,
    CONSTRAINT uq_merchant_template_symbol UNIQUE (merchant_id, template_code, symbol_code),

    INDEX idx_template_merchant (merchant_id),
    INDEX idx_template_code (template_code),
    INDEX idx_symbol_code (symbol_code),
    INDEX idx_invoice_type (invoice_type_id),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω m·∫´u s·ªë v√† k√Ω hi·ªáu h√≥a ƒë∆°n theo quy ƒë·ªãnh';


-- 11. Customers - Danh m·ª•c kh√°ch h√†ng c·ªßa Merchant
CREATE TABLE customers (
   id BIGINT AUTO_INCREMENT PRIMARY KEY,
   merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu kh√°ch h√†ng',
   customer_code VARCHAR(50) NULL COMMENT 'M√£ kh√°ch h√†ng n·ªôi b·ªô',
   tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø kh√°ch h√†ng',
   name VARCHAR(255) NOT NULL COMMENT 'T√™n kh√°ch h√†ng/ƒë∆°n v·ªã',
   address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ',
   email VARCHAR(255) NULL COMMENT 'Email nh·∫≠n h√≥a ƒë∆°n',
   phone VARCHAR(20) NULL COMMENT 'ƒêi·ªán tho·∫°i',
   contact_person VARCHAR(100) NULL COMMENT 'Ng∆∞·ªùi li√™n h·ªá',
   bank_account VARCHAR(50) NULL COMMENT 'T√†i kho·∫£n ng√¢n h√†ng',
   bank_name VARCHAR(100) NULL COMMENT 'T√™n ng√¢n h√†ng',
   note TEXT NULL COMMENT 'Ghi ch√∫',
   is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n ho·∫°t ƒë·ªông',
   created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
   updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

   CONSTRAINT fk_customer_merchant FOREIGN KEY (merchant_id)
       REFERENCES merchants(id) ON DELETE CASCADE,

   INDEX idx_customer_merchant (merchant_id),
   INDEX idx_customer_code (customer_code),
   INDEX idx_tax_code (tax_code),
   INDEX idx_name (name),
   INDEX idx_email (email),
   INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c kh√°ch h√†ng th∆∞·ªùng xuy√™n c·ªßa Merchant';


-- 12. Invoices Metadata - Th√¥ng tin t√≥m t·∫Øt h√≥a ƒë∆°n
CREATE TABLE invoices_metadata (
   id BIGINT AUTO_INCREMENT PRIMARY KEY,
   provider_config_id BIGINT NULL COMMENT 'C·∫•u h√¨nh Provider ƒë∆∞·ª£c s·ª≠ d·ª•ng',
   invoice_template_id BIGINT NULL COMMENT 'M·∫´u h√≥a ƒë∆°n ƒë∆∞·ª£c s·ª≠ d·ª•ng',
   client_request_id VARCHAR(100) NULL COMMENT 'ID request t·ª´ Merchant',

   invoice_number VARCHAR(20) NULL COMMENT 'S·ªë h√≥a ƒë∆°n t·ª´ Provider tr·∫£ v·ªÅ',
   symbol_code VARCHAR(10) NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n (VD: 1C23TML)',
   template_code VARCHAR(20) NULL COMMENT 'M·∫´u h√≥a ƒë∆°n: 01GTKT0/001, 02GTTT0/001...',
   is_summary_invoice BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'H√≥a ƒë∆°n t·ªïng h·ª£p hay h√≥a ƒë∆°n chi ti·∫øt',

   cqt_code VARCHAR(50) NULL COMMENT 'M√£ C∆° quan Thu·∫ø qu·∫£n l√Ω',

   payment_method VARCHAR(10) NULL COMMENT 'M√£ ph∆∞∆°ng th·ª©c thanh to√°n (li√™n k·∫øt b·∫£ng payment_methods)',
   lookup_code VARCHAR(50) NULL COMMENT 'M√£ tra c·ª©u h√≥a ƒë∆°n cho kh√°ch l·∫ª (pattern: S·ªë h√≥a ƒë∆°n + M√£ tra c·ª©u)',
   issuance_method ENUM('STANDARD', 'POS') NOT NULL DEFAULT 'STANDARD' COMMENT 'Ph∆∞∆°ng th·ª©c ph√°t h√†nh: STANDARD (th√¥ng th∆∞·ªùng), POS (m√°y t√≠nh ti·ªÅn)',

   seller_name VARCHAR(255) NULL COMMENT 'T√™n ng∆∞·ªùi b√°n',
   seller_tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi b√°n',
   seller_address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi b√°n',

   buyer_name VARCHAR(255) NULL COMMENT 'T√™n ng∆∞·ªùi mua',
   buyer_tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi mua',
   buyer_email VARCHAR(255) NULL COMMENT 'Email ng∆∞·ªùi mua (nh·∫≠n h√≥a ƒë∆°n)',
   buyer_phone VARCHAR(20) NULL COMMENT 'ƒêi·ªán tho·∫°i ng∆∞·ªùi mua',
   buyer_address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi mua',
   customer_id BIGINT NULL COMMENT 'Li√™n k·∫øt v·ªõi b·∫£ng customers',

   subtotal_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø',
   tax_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ø',
   discount_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng chi·∫øt kh·∫•u',
   total_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thanh to√°n',
   currency_code VARCHAR(3) NOT NULL DEFAULT 'VND' COMMENT 'ƒê∆°n v·ªã ti·ªÅn t·ªá',
   exchange_rate DECIMAL(10,4) NOT NULL DEFAULT 1.0000 COMMENT 'T·ª∑ gi√° v·ªõi VND',

   issue_date DATE NULL COMMENT 'Ng√†y l·∫≠p h√≥a ƒë∆°n',
   accounting_date DATE NULL COMMENT 'Ng√†y h·∫°ch to√°n',
   due_date DATE NULL COMMENT 'Ng√†y thanh to√°n ƒë·∫øn h·∫°n',

   status ENUM('DRAFT', 'PENDING', 'SIGNING', 'SENT_TO_PROVIDER', 'SUCCESS', 'FAILED', 'CANCELLED', 'REPLACED') NOT NULL DEFAULT 'DRAFT' COMMENT 'Tr·∫°ng th√°i x·ª≠ l√Ω h√≥a ƒë∆°n',
   status_message TEXT NULL COMMENT 'Th√¥ng b√°o tr·∫°ng th√°i chi ti·∫øt',
   cancellation_reason VARCHAR(500) NULL COMMENT 'L√Ω do h·ªßy/thay th·∫ø',
   replaced_by_invoice_id BIGINT NULL COMMENT 'ID h√≥a ƒë∆°n thay th·∫ø',
   adjustment_type ENUM('ADJUSTMENT', 'REPLACEMENT', 'CANCELLATION') NULL COMMENT 'Lo·∫°i ƒëi·ªÅu ch·ªânh/thay th·∫ø/h·ªßy',

   signed_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm k√Ω ƒëi·ªán t·ª≠',
   sent_to_provider_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i sang Provider',
   received_from_provider_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
   delivered_to_buyer_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i h√≥a ƒë∆°n cho ng∆∞·ªùi mua',

   provider_transaction_code VARCHAR(100) NULL COMMENT 'M√£ giao d·ªãch t·ª´ Provider',
   provider_error_code VARCHAR(50) NULL COMMENT 'M√£ l·ªói t·ª´ Provider',
   provider_error_message TEXT NULL COMMENT 'Chi ti·∫øt l·ªói t·ª´ Provider',

   is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'H√≥a ƒë∆°n ƒë√£ b·ªã x√≥a',
   deleted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
   deleted_by BIGINT NULL COMMENT 'Ng∆∞·ªùi x√≥a - merchant_users.id',

   created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
   updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

   CONSTRAINT fk_invoice_template FOREIGN KEY (invoice_template_id)
       REFERENCES invoice_templates(id) ON DELETE SET NULL,
   CONSTRAINT fk_invoice_config FOREIGN KEY (provider_config_id)
       REFERENCES merchant_provider_configs(id) ON DELETE SET NULL,
   CONSTRAINT fk_invoice_customer FOREIGN KEY (customer_id)
       REFERENCES customers(id) ON DELETE SET NULL,
   CONSTRAINT fk_invoice_payment_method FOREIGN KEY (payment_method)
       REFERENCES payment_methods(method_code) ON DELETE SET NULL,
   CONSTRAINT fk_invoice_replaced_by FOREIGN KEY (replaced_by_invoice_id)
       REFERENCES invoices_metadata(id) ON DELETE SET NULL,
   CONSTRAINT fk_invoice_deleted_by FOREIGN KEY (deleted_by)
       REFERENCES merchant_users(id) ON DELETE SET NULL,
   CONSTRAINT uq_invoice_lookup_code UNIQUE (lookup_code) COMMENT 'M√£ tra c·ª©u ph·∫£i duy nh·∫•t',

   INDEX idx_merchant_id (merchant_id),
   INDEX idx_provider_id (provider_id),
   INDEX idx_invoice_number (invoice_number),
   INDEX idx_symbol_code (symbol_code),
   INDEX idx_buyer_tax_code (buyer_tax_code),
   INDEX idx_status (status),
   INDEX idx_issue_date (issue_date),
   INDEX idx_created_at (created_at),
   INDEX idx_client_request_id (client_request_id),
   INDEX idx_merchant_status (merchant_id, status),
   INDEX idx_merchant_created (merchant_id, created_at),
   INDEX idx_cqt_code (cqt_code),
   INDEX idx_invoice_template (invoice_template_id),
   INDEX idx_lookup_code (lookup_code),
   INDEX idx_payment_method (payment_method)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Metadata h√≥a ƒë∆°n - ph·ª•c v·ª• tra c·ª©u nhanh';


-- 13. Invoice Items - Chi ti·∫øt h√†ng h√≥a/d·ªãch v·ª• trong h√≥a ƒë∆°n (ƒê√£ c·∫≠p nh·∫≠t)
CREATE TABLE invoice_items (
   id BIGINT AUTO_INCREMENT PRIMARY KEY,
   invoice_id BIGINT NOT NULL COMMENT 'ID h√≥a ƒë∆°n cha',
   line_number INT NOT NULL DEFAULT 1 COMMENT 'S·ªë th·ª© t·ª± d√≤ng',
   product_name VARCHAR(500) NOT NULL COMMENT 'T√™n s·∫£n ph·∫©m/d·ªãch v·ª•',
   product_code VARCHAR(100) NULL COMMENT 'M√£ s·∫£n ph·∫©m theo danh m·ª•c',
   unit_name VARCHAR(50) NOT NULL COMMENT 'ƒê∆°n v·ªã t√≠nh: c√°i, kg, chi·∫øc...',
   quantity DECIMAL(18,4) NOT NULL DEFAULT 0 COMMENT 'S·ªë l∆∞·ª£ng',
   unit_price DECIMAL(18,4) NOT NULL DEFAULT 0 COMMENT 'ƒê∆°n gi√° tr∆∞·ªõc thu·∫ø',
   amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Th√†nh ti·ªÅn = quantity * unit_price',
   discount_rate DECIMAL(5,2) NOT NULL DEFAULT 0 COMMENT 'T·ª∑ l·ªá chi·∫øt kh·∫•u (%)',
   discount_amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Ti·ªÅn chi·∫øt kh·∫•u',
   tax_rate DECIMAL(5,2) NOT NULL DEFAULT 0 COMMENT 'Thu·∫ø su·∫•t GTGT (%)',
   tax_amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Ti·ªÅn thu·∫ø GTGT',
   total_amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Th√†nh ti·ªÅn bao g·ªìm thu·∫ø',
   description TEXT NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt s·∫£n ph·∫©m',

   tax_category_code VARCHAR(20) NULL COMMENT 'M√£ nh√≥m h√†ng h√≥a theo thu·∫ø',
   vat_rate_id BIGINT NULL COMMENT 'Li√™n k·∫øt v·ªõi danh m·ª•c thu·∫ø su·∫•t (vat_rates)',
   is_promotion BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'H√†ng khuy·∫øn m√£i (TRUE) hay h√†ng th∆∞·ªùng (FALSE)',

   created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',

   CONSTRAINT fk_invoice_item_invoice FOREIGN KEY (invoice_id)
       REFERENCES invoices_metadata(id) ON DELETE CASCADE,
   CONSTRAINT fk_invoice_item_vat_rate FOREIGN KEY (vat_rate_id)
       REFERENCES vat_rates(id) ON DELETE SET NULL,

   INDEX idx_item_invoice (invoice_id),
   INDEX idx_line_number (line_number),
   INDEX idx_vat_rate (vat_rate_id),
   INDEX idx_is_promotion (is_promotion)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Chi ti·∫øt t·ª´ng d√≤ng h√†ng h√≥a/d·ªãch v·ª• trong h√≥a ƒë∆°n';


-- 14. Invoice Tax Breakdowns - Ph√¢n r√£ thu·∫ø su·∫•t tr√™n t·ª´ng h√≥a ƒë∆°n
CREATE TABLE invoice_tax_breakdowns (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    invoice_id BIGINT NOT NULL COMMENT 'ID h√≥a ƒë∆°n cha',
    vat_rate_id BIGINT NOT NULL COMMENT 'Li√™n k·∫øt v·ªõi danh m·ª•c thu·∫ø su·∫•t',
    vat_rate_code VARCHAR(10) NOT NULL COMMENT 'M√£ thu·∫ø su·∫•t (0, 5, 8, 10, KCT, KKKNT)',
    vat_rate_percent DECIMAL(5,2) NOT NULL COMMENT 'Gi√° tr·ªã ph·∫ßn trƒÉm thu·∫ø su·∫•t',

    subtotal_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø v·ªõi thu·∫ø su·∫•t n√†y',
    discount_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn chi·∫øt kh·∫•u',
    taxable_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn ch·ªãu thu·∫ø (sau chi·∫øt kh·∫•u)',
    tax_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ø GTGT',
    total_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn bao g·ªìm thu·∫ø',

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',

    CONSTRAINT fk_tax_breakdown_invoice FOREIGN KEY (invoice_id)
        REFERENCES invoices_metadata(id) ON DELETE CASCADE,
    CONSTRAINT fk_tax_breakdown_vat_rate FOREIGN KEY (vat_rate_id)
        REFERENCES vat_rates(id) ON DELETE RESTRICT,
    CONSTRAINT uq_invoice_vat_rate UNIQUE (invoice_id, vat_rate_id),

    INDEX idx_breakdown_invoice (invoice_id),
    INDEX idx_breakdown_vat_rate (vat_rate_id),
    INDEX idx_vat_rate_code (vat_rate_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u t·ªïng ti·ªÅn t√≥m t·∫Øt theo t·ª´ng lo·∫°i thu·∫ø su·∫•t ph·ª•c v·ª• in ·∫•n h√≥a ƒë∆°n';


CREATE TABLE invoice_adjustments (
     id BIGINT AUTO_INCREMENT PRIMARY KEY,
     original_invoice_id BIGINT NOT NULL COMMENT 'H√≥a ƒë∆°n g·ªëc b·ªã ƒëi·ªÅu ch·ªânh/thay th·∫ø/h·ªßy',
     adjustment_type ENUM('ADJUSTMENT', 'REPLACEMENT', 'CANCELLATION') NOT NULL COMMENT 'Lo·∫°i ƒëi·ªÅu ch·ªânh',

     agreement_number VARCHAR(50) NULL COMMENT 'S·ªë bi√™n b·∫£n th·ªèa thu·∫≠n',
     agreement_date DATE NULL COMMENT 'Ng√†y l·∫≠p bi√™n b·∫£n',
     agreement_content TEXT NULL COMMENT 'N·ªôi dung bi√™n b·∫£n th·ªèa thu·∫≠n',
     signers TEXT NULL COMMENT 'Ng∆∞·ªùi k√Ω bi√™n b·∫£n (JSON array)',

     reason_code VARCHAR(50) NULL COMMENT 'M√£ l√Ω do (theo quy ƒë·ªãnh)',
     reason_description VARCHAR(500) NULL COMMENT 'M√¥ t·∫£ l√Ω do chi ti·∫øt',

     old_subtotal_amount DECIMAL(18,2) NULL COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø c≈©',
     old_tax_amount DECIMAL(18,2) NULL COMMENT 'Ti·ªÅn thu·∫ø c≈©',
     old_total_amount DECIMAL(18,2) NULL COMMENT 'T·ªïng ti·ªÅn c≈©',
     new_subtotal_amount DECIMAL(18,2) NULL COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø m·ªõi',
     new_tax_amount DECIMAL(18,2) NULL COMMENT 'Ti·ªÅn thu·∫ø m·ªõi',
     new_total_amount DECIMAL(18,2) NULL COMMENT 'T·ªïng ti·ªÅn m·ªõi',
     difference_amount DECIMAL(18,2) NULL COMMENT 'Ch√™nh l·ªách ti·ªÅn',

     status ENUM('PENDING', 'APPROVED', 'REJECTED', 'CANCELLED') NOT NULL DEFAULT 'PENDING' COMMENT 'Tr·∫°ng th√°i duy·ªát',
     approved_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm duy·ªát',

    -- Th√¥ng tin g·ª≠i CQT
     submitted_to_cqt BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'ƒê√£ g·ª≠i C∆° quan Thu·∫ø',
     cqt_response_code VARCHAR(50) NULL COMMENT 'M√£ ph·∫£n h·ªìi t·ª´ CQT',
     cqt_response_message TEXT NULL COMMENT 'N·ªôi dung ph·∫£n h·ªìi t·ª´ CQT',

     created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
     updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

     CONSTRAINT fk_adjustment_original_invoice FOREIGN KEY (original_invoice_id)
         REFERENCES invoices_metadata(id) ON DELETE RESTRICT,


     INDEX idx_adjustment_original (original_invoice_id),
     INDEX idx_adjustment_type (adjustment_type),
     INDEX idx_adjustment_status (status),
     INDEX idx_agreement_date (agreement_date),
     INDEX idx_submitted_cqt (submitted_to_cqt)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u th√¥ng tin bi√™n b·∫£n th·ªèa thu·∫≠n cho h√≥a ƒë∆°n ƒëi·ªÅu ch·ªânh/thay th·∫ø/h·ªßy';


CREATE TABLE invoice_sync_queue (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    invoice_id BIGINT NOT NULL COMMENT 'ID h√≥a ƒë∆°n c·∫ßn ƒë·ªìng b·ªô',
    sync_type ENUM('SEND_TO_PROVIDER', 'SEND_TO_CQT', 'CANCEL_INVOICE', 'REPLACE_INVOICE') NOT NULL COMMENT 'Lo·∫°i thao t√°c ƒë·ªìng b·ªô',
    priority INT NOT NULL DEFAULT 5 COMMENT 'ƒê·ªô ∆∞u ti√™n (1=cao nh·∫•t, 10=th·∫•p nh·∫•t)',

    status ENUM('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED', 'RETRYING') NOT NULL DEFAULT 'PENDING' COMMENT 'Tr·∫°ng th√°i x·ª≠ l√Ω',
    attempt_count INT NOT NULL DEFAULT 0 COMMENT 'S·ªë l·∫ßn th·ª≠',
    max_attempts INT NOT NULL DEFAULT 3 COMMENT 'S·ªë l·∫ßn th·ª≠ t·ªëi ƒëa',
    last_attempt_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm th·ª≠ l·∫ßn cu·ªëi',
    next_retry_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm th·ª≠ ti·∫øp theo',

    request_data JSON NULL COMMENT 'D·ªØ li·ªáu request g·ª≠i ƒëi',
    response_data JSON NULL COMMENT 'D·ªØ li·ªáu response nh·∫≠n v·ªÅ',
    error_code VARCHAR(50) NULL COMMENT 'M√£ l·ªói',
    error_message TEXT NULL COMMENT 'Chi ti·∫øt l·ªói',

    processed_by VARCHAR(100) NULL COMMENT 'Worker x·ª≠ l√Ω',
    processing_started_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu x·ª≠ l√Ω',
    processing_completed_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm ho√†n th√†nh',

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT fk_sync_queue_invoice FOREIGN KEY (invoice_id)
        REFERENCES invoices_metadata(id) ON DELETE CASCADE,

    CONSTRAINT chk_sync_attempt_count CHECK (attempt_count <= max_attempts),

    INDEX idx_sync_queue_status (status),
    INDEX idx_sync_queue_invoice (invoice_id),
    INDEX idx_sync_queue_merchant (merchant_id),
    INDEX idx_sync_queue_priority (priority),
    INDEX idx_sync_queue_next_retry (next_retry_at),
    INDEX idx_sync_queue_created (created_at),
    INDEX idx_sync_queue_status_priority (status, priority, next_retry_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='H√†ng ƒë·ª£i g·ª≠i h√≥a ƒë∆°n sang Provider/CQT v·ªõi c∆° ch·∫ø Retry';


-- 17. Invoice Payloads - L∆∞u tr·ªØ n·ªôi dung XML/JSON g·ªëc
CREATE TABLE invoice_payloads (
      invoice_id BIGINT NOT NULL PRIMARY KEY COMMENT 'ID h√≥a ƒë∆°n - kh√≥a ch√≠nh v√† kh√≥a ngo·∫°i',
      raw_data JSON NULL COMMENT 'D·ªØ li·ªáu th√¥ request/response d·∫°ng JSON',
      xml_content LONGTEXT NULL COMMENT 'N·ªôi dung XML g·ªëc c·ªßa h√≥a ƒë∆°n (ph·ª•c v·ª• in ·∫•n)',
      json_content LONGTEXT NULL COMMENT 'N·ªôi dung JSON ƒë·∫ßy ƒë·ªß c·ªßa h√≥a ƒë∆°n',
      signed_xml LONGTEXT NULL COMMENT 'XML ƒë√£ k√Ω ƒëi·ªán t·ª≠ (ch·ªØ k√Ω s·ªë)',
      pdf_data LONGTEXT NULL COMMENT 'D·ªØ li·ªáu PDF ƒë√£ t·∫°o (base64)',
      extra_data JSON NULL COMMENT 'D·ªØ li·ªáu b·ªï sung kh√°c',
      created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm l∆∞u',
      updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

      CONSTRAINT fk_invoice_payload_invoice FOREIGN KEY (invoice_id)
          REFERENCES invoices_metadata(id) ON DELETE CASCADE,

      INDEX idx_payload_created (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u tr·ªØ n·ªôi dung XML/JSON g·ªëc h√≥a ƒë∆°n';


-- 18. Tax Authority Responses - Ph·∫£n h·ªìi t·ª´ C∆° quan Thu·∫ø
CREATE TABLE tax_authority_responses (
     id BIGINT AUTO_INCREMENT PRIMARY KEY,
     invoice_id BIGINT NOT NULL COMMENT 'H√≥a ƒë∆°n li√™n quan',
     cqt_code VARCHAR(50) NOT NULL COMMENT 'M√£ C∆° quan Thu·∫ø',
     status_from_cqt VARCHAR(50) NOT NULL COMMENT 'Tr·∫°ng th√°i t·ª´ C∆° quan Thu·∫ø: APPROVED, REJECTED, PENDING',
     processing_code VARCHAR(100) NULL COMMENT 'M√£ x·ª≠ l√Ω t·ª´ C∆° quan Thu·∫ø',
     signature_data TEXT NULL COMMENT 'D·ªØ li·ªáu ch·ªØ k√Ω t·ª´ C∆° quan Thu·∫ø',
     raw_response JSON NULL COMMENT 'Response th√¥ t·ª´ C∆° quan Thu·∫ø',
     error_code VARCHAR(50) NULL COMMENT 'M√£ l·ªói t·ª´ C∆° quan Thu·∫ø',
     error_message TEXT NULL COMMENT 'Th√¥ng b√°o l·ªói t·ª´ C∆° quan Thu·∫ø',
     received_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
     processed_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x·ª≠ l√Ω ho√†n t·∫•t',
     created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o b·∫£n ghi',

     CONSTRAINT fk_tax_response_invoice FOREIGN KEY (invoice_id)
         REFERENCES invoices_metadata(id) ON DELETE CASCADE,

     INDEX idx_tax_response_invoice (invoice_id),
     INDEX idx_cqt_code (cqt_code),
     INDEX idx_status_cqt (status_from_cqt),
     INDEX idx_received_at (received_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u v·∫øt t∆∞∆°ng t√°c v·ªõi C∆° quan Thu·∫ø';


-- 19. Audit Log - Nh·∫≠t k√Ω thao t√°c
CREATE TABLE audit_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchantuser_id BIGINT NULL COMMENT 'Doanh nghi·ªáp li√™n quan',
    user_id BIGINT NULL COMMENT 'Ng∆∞·ªùi th·ª±c hi·ªán',
    entity_type VARCHAR(50) NOT NULL COMMENT 'Lo·∫°i entity: Invoice, Merchant, Config...',
    entity_id BIGINT NOT NULL COMMENT 'ID c·ªßa entity',
    action VARCHAR(50) NOT NULL COMMENT 'H√†nh ƒë·ªông: CREATE, UPDATE, DELETE, STATUS_CHANGE',
    old_value JSON NULL COMMENT 'Gi√° tr·ªã c≈©',
    new_value JSON NULL COMMENT 'Gi√° tr·ªã m·ªõi',
    ip_address VARCHAR(45) NULL COMMENT 'IP th·ª±c hi·ªán',
    user_agent VARCHAR(500) NULL COMMENT 'User Agent c·ªßa browser/client',
    request_id VARCHAR(100) NULL COMMENT 'ID request t·ª´ frontend',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm x·∫£y ra',

    CONSTRAINT fk_merchant_user FOREIGN KEY (merchantuser_id)
        REFERENCES merchant_users(id) ON DELETE CASCADE,

    INDEX idx_merchant_id (merchant_id),
    INDEX idx_user_id (user_id),
    INDEX idx_entity (entity_type, entity_id),
    INDEX idx_action (action),
    INDEX idx_created_at (created_at),
    INDEX idx_merchant_entity (merchant_id, entity_type, entity_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Nh·∫≠t k√Ω thay ƒë·ªïi h·ªá th·ªëng';


-- 20. System Configuration - C·∫•u h√¨nh h·ªá th·ªëng
CREATE TABLE system_config (
   id BIGINT AUTO_INCREMENT PRIMARY KEY,
   config_key VARCHAR(100) NOT NULL UNIQUE COMMENT 'Kh√≥a c·∫•u h√¨nh',
   config_value TEXT NOT NULL COMMENT 'Gi√° tr·ªã c·∫•u h√¨nh',
   config_type VARCHAR(20) NOT NULL DEFAULT 'STRING' COMMENT 'Lo·∫°i: STRING, NUMBER, BOOLEAN, JSON',
   description VARCHAR(500) NULL COMMENT 'M√¥ t·∫£ c·∫•u h√¨nh',
   is_encrypted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'C√≥ c·∫ßn m√£ h√≥a kh√¥ng',
   is_editable BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≥ th·ªÉ ch·ªânh s·ª≠a kh√¥ng',
   updated_by BIGINT NULL COMMENT 'Ng∆∞·ªùi c·∫≠p nh·∫≠t cu·ªëi',
   updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

   CONSTRAINT fk_config_updated_by FOREIGN KEY (updated_by)
       REFERENCES merchant_users(id) ON DELETE SET NULL,

   INDEX idx_config_key (config_key)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='C·∫•u h√¨nh h·ªá th·ªëng';

-- Insert default configurations
INSERT INTO system_config (config_key, config_value, config_type, description) VALUES
('SYSTEM_NAME', 'EInvoiceHub', 'STRING', 'T√™n hi·ªÉn th·ªã c·ªßa h·ªá th·ªëng'),
('INVOICE_EXPIRY_DAYS', '30', 'NUMBER', 'S·ªë ng√†y h√≥a ƒë∆°n c√≥ hi·ªáu l·ª±c sau khi ph√°t h√†nh'),
('MAX_RETRY_ATTEMPTS', '3', 'NUMBER', 'S·ªë l·∫ßn th·ª≠ l·∫°i khi g·ªçi Provider th·∫•t b·∫°i'),
('RETRY_DELAY_MS', '1000', 'NUMBER', 'Th·ªùi gian ch·ªù gi·ªØa c√°c l·∫ßn th·ª≠ l·∫°i (milliseconds)'),
('SESSION_TIMEOUT_MINUTES', '60', 'NUMBER', 'Th·ªùi gian timeout c·ªßa session'),
('PASSWORD_MIN_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i t·ªëi thi·ªÉu c·ªßa m·∫≠t kh·∫©u'),
('API_KEY_PREFIX_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i prefix hi·ªÉn th·ªã c·ªßa API Key'),
('DEFAULT_CURRENCY', 'VND', 'STRING', 'ƒê∆°n v·ªã ti·ªÅn t·ªá m·∫∑c ƒë·ªãnh'),
('TAX_DEFAULT_RATE', '10.00', 'NUMBER', 'Thu·∫ø su·∫•t m·∫∑c ƒë·ªãnh (%)'),
('INVOICE_NUMBER_FORMAT', 'PREFIX + NUMBER + SUFFIX', 'STRING', 'C·∫•u tr√∫c s·ªë h√≥a ƒë∆°n m·∫∑c ƒë·ªãnh'),
('BACKGROUND_JOB_ENABLED', 'true', 'BOOLEAN', 'K√≠ch ho·∫°t x·ª≠ l√Ω background jobs'),
('INVOICE_LOOKUP_CODE_LENGTH', '6', 'NUMBER', 'ƒê·ªô d√†i m√£ tra c·ª©u h√≥a ƒë∆°n ng·∫´u nhi√™n');
</file>

<file path="src/main/resources/application.yaml">
spring:
  threads:
    virtual:
      enabled: true

  application:
    name: einvoice-core

  # =============================================================================
  # MariaDB Database Configuration
  # =============================================================================
  datasource:
    url: jdbc:mariadb://localhost:3306/einvoicehub?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
    username: root
    password: ${DB_PASSWORD:root}
    driver-class-name: org.mariadb.jdbc.Driver

    hikari:
      minimum-idle: 5
      maximum-pool-size: 20
      idle-timeout: 300000
      max-lifetime: 1200000
      connection-timeout: 20000

  # JPA/Hibernate Configuration - S·ª≠ d·ª•ng MariaDBDialect
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.MariaDBDialect
        jdbc:
          batch_size: 50
        order_inserts: true
        order_updates: true

  # =============================================================================
  # Flyway Migration
  # =============================================================================
  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true
    validate-on-migrate: true
    baseline-version: 0
    out-of-order: false

# Server Configuration
server:
  port: 8080
  servlet:
    context-path: /api

# Application Custom Properties
app:
  # Encryption
  encryption:
    secret-key: ${ENCRYPTION_SECRET_KEY: CH∆ØA C√ì!}

  # JWT Configuration
  jwt:
    secret: ${JWT_SECRET: CH∆ØA C√ì!}
    expiration-ms: 86400000  # 24 hours

  # API Key Configuration
  api-key:
    prefix-length: 8
    default-rate-limit-per-hour: 1000
    default-rate-limit-per-day: 10000

  # Provider Configuration
  provider:
    default-timeout-ms: 30000
    max-retry-attempts: 3
    retry-delay-ms: 1000
    vnpt:
      base-url: https://api.vnptinvoice.com.vn/v1
      timeout-ms: 30000
    viettel:
      base-url: https://ebill.vietteltelecom.vn/api/v1
      timeout-ms: 30000
    bkav:
      base-url: https://einvoice.bkav.com/api/v1
      test-base-url: https://demo.ehoadon.vn/api/v1
      timeout-ms: 30000
      encryption-key: ${BKAV_ENCRYPTION_KEY: CH∆ØA C√ì }  # AES-256 key t·ª´ BKAV
    misa:
      base-url: https://api.meinvoice.vn/api/integration
      test-base-url: https://testapi.meinvoice.vn/api/integration
      timeout-ms: 30000

# Logging Configuration
logging:
  level:
    root: INFO
    com.einvoicehub: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# Management/Actuator
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
</file>

<file path="src/test/java/com/einvoicehub/core/EinvoiceCoreApplicationTests.java">
package com.einvoicehub.core;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class EinvoiceCoreApplicationTests {

	@Test
	void contextLoads() {
	}

}
</file>

<file path="terraform/main.tf">
# EInvoiceHub Infrastructure as Code (Terraform)

terraform {
  required_version = ">= 1.5.0"

  required_providers {
    kubernetes = {
      source  = "hashicorp/kubernetes"
      version = "~> 2.24"
    }

    helm = {
      source  = "hashicorp/helm"
      version = "~> 2.12"
    }

    random = {
      source  = "hashicorp/random"
      version = "~> 3.6"
    }

    kubectl = {
      source  = "gavinbunney/kubectl"
      version = "~> 1.14"
    }
  }

  # Configure backend (modify for production)
  backend "local" {
    path = "terraform.tfstate"
  }
}

# Kubernetes Provider Configuration

provider "kubernetes" {
  config_path    = "~/.kube/config"
  config_context = var.kubernetes_context
}

provider "helm" {
  kubernetes {
    config_path    = "~/.kube/config"
    config_context = var.kubernetes_context
  }
}

provider "kubectl" {
  config_path    = "~/.kube/config"
  config_context = var.kubernetes_context
}

# Random Resources for Password Generation

resource "random_string" "mysql_password" {
  length  = 32
  special = false
}

resource "random_string" "mongodb_password" {
  length  = 32
  special = false
}

resource "random_string" "redis_password" {
  length  = 32
  special = false
}

resource "random_string" "grafana_password" {
  length  = 32
  special = false
}

resource "random_id" "session_id" {
  byte_length = 4
}

# Namespace Creation

resource "kubernetes_namespace" "einvoice_namespace" {
  metadata {
    name        = var.namespace
    labels = {
      environment = var.environment
      project     = "einvoicehub"
      managed_by  = "terraform"
    }
  }
}

# ConfigMap for Application Configuration

resource "kubernetes_config_map" "app_config" {
  metadata {
    name      = "${var.app_name}-config"
    namespace = kubernetes_namespace.einvoice_namespace.metadata[0].name
    labels = {
      app = var.app_name
    }
  }

  data = {
    # Application Settings
    APP_NAME                = var.app_name
    APP_VERSION             = var.app_version
    SERVER_PORT             = var.server_port
    SPRING_PROFILES_ACTIVE  = var.environment

    # Logging Configuration
    LOG_LEVEL               = var.log_level
    LOG_FORMAT              = "json"

    # Database Configuration (placeholders - use secrets for actual values)
    SPRING_DATASOURCE_URL   = "jdbc:mysql://${var.mysql_host}:${var.mysql_port}/${var.mysql_database}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC"
    SPRING_JPA_HIBERNATE_DDL_AUTO = "update"

    # MongoDB Configuration
    SPRING_DATA_MONGODB_URI = "mongodb://${var.mongo_host}:${var.mongo_port}/${var.mongo_database}?authSource=admin"

    # Redis Configuration
    SPRING_REDIS_HOST       = var.redis_host
    SPRING_REDIS_PORT       = var.redis_port

    # Actuator Endpoints
    MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE = "health,info,metrics,prometheus"
    MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS    = "when_authorized"

    # Virtual Threads (Java 21)
    JAVA_THREADS_VIRTUAL_ENABLED = "true"
  }
}

# Secrets for Sensitive Data
resource "kubernetes_secret" "database_secrets" {
  metadata {
    name      = "${var.app_name}-db-secrets"
    namespace = kubernetes_namespace.einvoice_namespace.metadata[0].name
    labels = {
      app = var.app_name
    }
  }

  type = "Opaque"

  data = {
    # Base64 encoded values
    SPRING_DATASOURCE_USERNAME = base64encode(var.mysql_username)
    SPRING_DATASOURCE_PASSWORD = base64encode(random_string.mysql_password.result)
    SPRING_DATA_MONGODB_USERNAME = base64encode(var.mongo_username)
    SPRING_DATA_MONGODB_PASSWORD = base64encode(random_string.mongodb_password.result)
    SPRING_REDIS_PASSWORD = base64encode(random_string.redis_password.result)
  }
}

resource "kubernetes_secret" "api_secrets" {
  metadata {
    name      = "${var.app_name}-api-secrets"
    namespace = kubernetes_namespace.einvoice_namespace.metadata[0].name
    labels = {
      app = var.app_name
    }
  }

  type = "Opaque"

  data = {
    # API Key encryption key (should be rotated regularly)
    ENCRYPTION_KEY_AES256 = base64encode(var.encryption_key)
    ENCRYPTION_KEY_IV     = base64encode(var.encryption_iv)

    # JWT Configuration
    JWT_SECRET_KEY        = base64encode(var.jwt_secret)
    JWT_EXPIRATION_MS     = base64encode(var.jwt_expiration_ms)
  }
}

resource "kubernetes_secret" "provider_secrets" {
  metadata {
    name      = "${var.app_name}-provider-secrets"
    namespace = kubernetes_namespace.einvoice_namespace.metadata[0].name
    labels = {
      app = var.app_name
    }
  }

  type = "Opaque"

  data = {
    # Provider-specific API keys (encrypted)
    VIETTEL_API_KEY      = base64encode(var.viettel_api_key)
    VIETTEL_CLIENT_ID    = base64encode(var.viettel_client_id)

    BKAV_API_KEY         = base64encode(var.bkav_api_key)
    BKAV_CLIENT_ID       = base64encode(var.bkav_client_id)

    MISA_API_KEY         = base64encode(var.misa_api_key)
    MISA_CLIENT_ID       = base64encode(var.misa_client_id)
    MISA_CLIENT_SECRET   = base64encode(var.misa_client_secret)
  }
}

# =============================================================================
# Resource Quotas
# =============================================================================

resource "kubernetes_resource_quota" "namespace_quota" {
  metadata {
    name      = "${var.app_name}-quota"
    namespace = kubernetes_namespace.einvoice_namespace.metadata[0].name
  }

  spec {
    hard = {
      "limits.cpu"    = var.resource_quota.cpu_limit
      "limits.memory" = var.resource_quota.memory_limit
      "pods"          = "20"
      "services"      = "10"
      "secrets"       = "20"
      "configmaps"    = "20"
      "persistentvolumeclaims" = "10"
    }
  }
}

# Limit Ranges

resource "kubernetes_limit_range" "namespace_limits" {
  metadata {
    name      = "${var.app_name}-limits"
    namespace = kubernetes_namespace.einvoice_namespace.metadata[0].name
  }

  spec {
    limit {
      type = "Container"

      default_request = {
        cpu    = var.limit_range.cpu_request
        memory = var.limit_range.memory_request
      }

      default = {
        cpu    = var.limit_range.cpu_limit
        memory = var.limit_range.memory_limit
      }

      min = {
        cpu    = var.limit_range.cpu_min
        memory = var.limit_range.memory_min
      }

      max = {
        cpu    = var.limit_range.cpu_max
        memory = var.limit_range.memory_max
      }
    }
  }
}

# Network Policy

resource "kubernetes_network_policy" "einvoice_network_policy" {
  metadata {
    name      = "${var.app_name}-network-policy"
    namespace = kubernetes_namespace.einvoice_namespace.metadata[0].name
  }

  spec {
    pod_selector {
      match_labels = {
        app = var.app_name
      }
    }

    policy_types = ["Ingress", "Egress"]

    ingress {
      from {
        namespace_selector {
          match_labels = {
            name = "ingress-nginx"
          }
        }
      }

      from {
        pod_selector {
          match_labels = {
            app = var.app_name
          }
        }
      }

      ports {
        protocol = "TCP"
        port     = var.server_port
      }

      ports {
        protocol = "TCP"
        port     = 9090
      }
    }

    egress {
      # Allow DNS resolution
      to {
        namespace_selector {
          match_labels = {
            name = "kube-system"
          }
        }
      }

      # Allow traffic to MySQL
      to {
        pod_selector {
          match_labels = {
            tier = "database"
          }
        }
        ports {
          protocol = "TCP"
          port     = 3306
        }
      }

      # Allow traffic to MongoDB
      to {
        pod_selector {
          match_labels = {
            tier = "database"
          }
        }
        ports {
          protocol = "TCP"
          port     = 27017
        }
      }

      # Allow traffic to Redis
      to {
        pod_selector {
          match_labels = {
            tier = "cache"
          }
        }
        ports {
          protocol = "TCP"
          port     = 6379
        }
      }

      # Allow external API calls
      to {
        ip_block {
          cidr = "0.0.0.0/0"
          except = [
            "10.0.0.0/8",
            "172.16.0.0/12",
            "192.168.0.0/16"
          ]
        }
      }
    }
  }
}
</file>

<file path="terraform/outputs.tf">
# EInvoiceHub Terraform Outputs
output "namespace_name" {
  description = "Kubernetes namespace name"
  value       = kubernetes_namespace.einvoice_namespace.metadata[0].name
}

output "namespace_creation_timestamp" {
  description = "Namespace creation timestamp"
  value       = kubernetes_namespace.einvoice_namespace.metadata[0].creation_timestamp
}

# Application Configuration Outputs
output "app_name" {
  description = "Application name"
  value       = var.app_name
}

output "app_version" {
  description = "Application version"
  value       = var.app_version
}

output "environment" {
  description = "Deployment environment"
  value       = var.environment
}

output "server_port" {
  description = "Application server port"
  value       = var.server_port
}

# Resource Outputs
output "replica_count" {
  description = "Number of pod replicas configured"
  value       = var.replicas
}

output "cpu_limit" {
  description = "CPU limit per pod"
  value       = var.limit_range.cpu_limit
}

output "memory_limit" {
  description = "Memory limit per pod"
  value       = var.limit_range.memory_limit
}

# Database Configuration Outputs

output "mysql_host" {
  description = "MySQL hostname"
  value       = var.mysql_host
}

output "mysql_port" {
  description = "MySQL port"
  value       = var.mysql_port
}

output "mysql_database" {
  description = "MySQL database name"
  value       = var.mysql_database
}

output "mongodb_uri" {
  description = "MongoDB connection URI"
  value       = "mongodb://${var.mongo_host}:${var.mongo_port}/${var.mongo_database}"
  sensitive   = false
}

output "redis_host" {
  description = "Redis hostname"
  value       = var.redis_host
}

output "redis_port" {
  description = "Redis port"
  value       = var.redis_port
}

# Secret Names (not values)
output "database_secret_name" {
  description = "Kubernetes secret name for database credentials"
  value       = kubernetes_secret.database_secrets.metadata[0].name
}

output "api_secret_name" {
  description = "Kubernetes secret name for API credentials"
  value       = kubernetes_secret.api_secrets.metadata[0].name
}

output "provider_secret_name" {
  description = "Kubernetes secret name for provider credentials"
  value       = kubernetes_secret.provider_secrets.metadata[0].name
}

output "configmap_name" {
  description = "Kubernetes ConfigMap name for application configuration"
  value       = kubernetes_config_map.app_config.metadata[0].name
}

# Network Policy Outputs
output "network_policy_name" {
  description = "Kubernetes NetworkPolicy name"
  value       = kubernetes_network_policy.einvoice_network_policy.metadata[0].name
}

# Resource Quota Outputs
output "resource_quota_name" {
  description = "ResourceQuota name"
  value       = kubernetes_resource_quota.namespace_quota.metadata[0].name
}

# Connection Information
output "application_url" {
  description = "Application URL (if ingress is enabled)"
  value       = var.ingress_enabled ? "http://${var.ingress_host}" : "http://localhost:${var.server_port}"
}

output "health_endpoint" {
  description = "Application health check endpoint"
  value       = var.ingress_enabled ? "http://${var.ingress_host}/actuator/health" : "http://localhost:${var.server_port}/actuator/health"
}

output "metrics_endpoint" {
  description = "Prometheus metrics endpoint"
  value       = var.ingress_enabled ? "http://${var.ingress_host}/actuator/prometheus" : "http://localhost:${var.server_port}/actuator/prometheus"
}

# Monitoring Endpoints (if enabled)
output "grafana_url" {
  description = "Grafana dashboard URL"
  value       = var.monitoring_enabled ? "http://${var.ingress_host}:3000" : "Grafana not enabled"
}

output "prometheus_url" {
  description = "Prometheus URL"
  value       = var.monitoring_enabled ? "http://${var.ingress_host}:9090" : "Prometheus not enabled"
}

output "jaeger_url" {
  description = "Jaeger tracing UI URL"
  value       = var.tracing_enabled ? "http://${var.ingress_host}:16686" : "Jaeger not enabled"
}

# Kubernetes Context Information
output "kubernetes_context" {
  description = "Kubernetes context used"
  value       = var.kubernetes_context
}

output "kubectl_command" {
  description = "Example kubectl command to access the application"
  value       = "kubectl port-forward -n ${kubernetes_namespace.einvoice_namespace.metadata[0].name} svc/${var.app_name} ${var.server_port}:${var.server_port}"
}

# Image Information
output "image_repository" {
  description = "Container image repository"
  value       = var.image_repository
}

output "image_tag" {
  description = "Container image tag"
  value       = var.image_tag
}

output "full_image_name" {
  description = "Full container image name with tag"
  value       = "${var.image_repository}:${var.image_tag}"
}

# Autoscaling Information
output "hpa_min_replicas" {
  description = "HPA minimum replicas"
  value       = var.autoscaling.min_replicas
}

output "hpa_max_replicas" {
  description = "HPA maximum replicas"
  value       = var.autoscaling.max_replicas
}

output "hpa_cpu_target" {
  description = "HPA CPU target utilization percentage"
  value       = var.autoscaling.cpu_target
}

output "hpa_memory_target" {
  description = "HPA memory target utilization percentage"
  value       = var.autoscaling.memory_target
}

# Security Information

output "encryption_enabled" {
  description = "Whether encryption is enabled"
  value       = var.encryption_key != ""
}

output "tls_enabled" {
  description = "Whether TLS is enabled"
  value       = var.tls_enabled
}

output "ingress_enabled" {
  description = "Whether ingress is enabled"
  value       = var.ingress_enabled
}

# Provider Information

output "providers_configured" {
  description = "List of invoice providers configured"
  value       = ["viettel", "bkav", "misa", "vnpt"]
}

# Summary Message

output "deployment_summary" {
  description = "Summary of deployment configuration"
  value       = <<-EOT
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                  EInvoiceHub Deployment Summary                   ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë Application: ${var.app_name} v${var.app_version}
‚ïë Environment: ${var.environment}
‚ïë Namespace: ${kubernetes_namespace.einvoice_namespace.metadata[0].name}
‚ïë Replicas: ${var.replicas}
‚ïë
‚ïë Database: ${var.mysql_host}:${var.mysql_port}/${var.mysql_database}
‚ïë Cache: ${var.redis_host}:${var.redis_port}
‚ïë MongoDB: ${var.mongo_host}:${var.mongo_port}/${var.mongo_database}
‚ïë
‚ïë Access: ${var.ingress_enabled ? "http://${var.ingress_host}" : "http://localhost:${var.server_port}"}
‚ïë Health: ${var.ingress_enabled ? "http://${var.ingress_host}/actuator/health" : "http://localhost:${var.server_port}/actuator/health"}
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOT
}
</file>

<file path="terraform/variables.tf">
# EInvoiceHub Terraform Variables

# Environment Configuration

variable "environment" {
  description = "Deployment environment (dev, staging, prod)"
  type        = string
  default     = "dev"
}

variable "app_name" {
  description = "Application name"
  type        = string
  default     = "einvoicehub"
}

variable "app_version" {
  description = "Application version"
  type        = string
  default     = "1.0.0"
}

# Kubernetes Configuration

variable "kubernetes_context" {
  description = "Kubernetes context to use"
  type        = string
  default     = "k3d-einvoice"
}

variable "namespace" {
  description = "Kubernetes namespace"
  type        = string
  default     = "einvoice-dev"
}

variable "replicas" {
  description = "Number of pod replicas"
  type        = number
  default     = 2
}

variable "server_port" {
  description = "Application server port"
  type        = number
  default     = 8080
}

# Resource Configuration

variable "resource_quota" {
  description = "Resource quota configuration"
  type = object({
    cpu_limit    = string
    memory_limit = string
  })
  default = {
    cpu_limit    = "8"
    memory_limit = "8Gi"
  }
}

variable "limit_range" {
  description = "Container limit range configuration"
  type = object({
    cpu_request  = string
    memory_request = string
    cpu_limit    = string
    memory_limit = string
    cpu_min      = string
    memory_min   = string
    cpu_max      = string
    memory_max   = string
  })
  default = {
    cpu_request    = "250m"
    memory_request = "256Mi"
    cpu_limit      = "1000m"
    memory_limit   = "1Gi"
    cpu_min        = "100m"
    memory_min     = "128Mi"
    cpu_max        = "2000m"
    memory_max     = "2Gi"
  }
}

variable "autoscaling" {
  description = "Horizontal Pod Autoscaler configuration"
  type = object({
    min_replicas = number
    max_replicas = number
    cpu_target   = number
    memory_target = number
  })
  default = {
    min_replicas = 2
    max_replicas = 10
    cpu_target   = 70
    memory_target = 80
  }
}

# Logging Configuration

variable "log_level" {
  description = "Application log level"
  type        = string
  default     = "INFO"
}

# Database Configuration (for ConfigMap - use secrets for actual values)

variable "mysql_host" {
  description = "MySQL hostname"
  type        = string
  default     = "mysql"
}

variable "mysql_port" {
  description = "MySQL port"
  type        = number
  default     = 3306
}

variable "mysql_database" {
  description = "MySQL database name"
  type        = string
  default     = "einvoicehub"
}

variable "mysql_username" {
  description = "MySQL username"
  type        = string
  default     = "einvoice_user"
}

# MongoDB Configuration

variable "mongo_host" {
  description = "MongoDB hostname"
  type        = string
  default     = "mongodb"
}

variable "mongo_port" {
  description = "MongoDB port"
  type        = number
  default     = 27017
}

variable "mongo_database" {
  description = "MongoDB database name"
  type        = string
  default     = "einvoicehub"
}

variable "mongo_username" {
  description = "MongoDB username"
  type        = string
  default     = "admin"
}

# Redis Configuration

variable "redis_host" {
  description = "Redis hostname"
  type        = string
  default     = "redis"
}

variable "redis_port" {
  description = "Redis port"
  type        = number
  default     = 6379
}

# Security Variables (use environment variables or secret management)

variable "encryption_key" {
  description = "AES-256 encryption key (32 bytes)"
  type        = string
  default     = ""
  sensitive   = true
}

variable "encryption_iv" {
  description = "AES encryption initialization vector (16 bytes)"
  type        = string
  default     = ""
  sensitive   = true
}

variable "jwt_secret" {
  description = "JWT secret key"
  type        = string
  default     = ""
  sensitive   = true
}

variable "jwt_expiration_ms" {
  description = "JWT expiration time in milliseconds"
  type        = string
  default     = "86400000"
}

# Provider API Credentials (use secrets for actual values)

variable "viettel_api_key" {
  description = "Viettel API Key"
  type        = string
  default     = ""
  sensitive   = true
}

variable "viettel_client_id" {
  description = "Viettel Client ID"
  type        = string
  default     = ""
  sensitive   = true
}

variable "bkav_api_key" {
  description = "BKAV API Key"
  type        = string
  default     = ""
  sensitive   = true
}

variable "bkav_client_id" {
  description = "BKAV Client ID"
  type        = string
  default     = ""
  sensitive   = true
}

variable "misa_api_key" {
  description = "MISA API Key"
  type        = string
  default     = ""
  sensitive   = true
}

variable "misa_client_id" {
  description = "MISA Client ID"
  type        = string
  default     = ""
  sensitive   = true
}

variable "misa_client_secret" {
  description = "MISA Client Secret"
  type        = string
  default     = ""
  sensitive   = true
}

# Image Configuration

variable "image_repository" {
  description = "Container image repository"
  type        = string
  default     = "einvoicehub/backend"
}

variable "image_tag" {
  description = "Container image tag"
  type        = string
  default     = "latest"
}

variable "image_pull_policy" {
  description = "Image pull policy (Always, Never, IfNotPresent)"
  type        = string
  default     = "IfNotPresent"
}

# Persistence Configuration

variable "persistence" {
  description = "Persistence configuration"
  type = object({
    enabled  = bool
    size     = string
    storage  = string
  })
  default = {
    enabled  = true
    size     = "10Gi"
    storage  = "standard"
  }
}

# Monitoring Configuration

variable "monitoring_enabled" {
  description = "Enable monitoring stack"
  type        = bool
  default     = true
}

variable "metrics_port" {
  description = "Port for Prometheus metrics"
  type        = number
  default     = 9090
}

# Tracing Configuration

variable "tracing_enabled" {
  description = "Enable distributed tracing"
  type        = bool
  default     = true
}

variable "jaeger_endpoint" {
  description = "Jaeger collector endpoint"
  type        = string
  default     = "http://jaeger:4317"
}

# Ingress Configuration

variable "ingress_enabled" {
  description = "Enable ingress controller"
  type        = bool
  default     = true
}

variable "ingress_host" {
  description = "Ingress hostname"
  type        = string
  default     = "einvoice.local"
}

variable "ingress_class" {
  description = "Ingress class name"
  type        = string
  default     = "nginx"
}

# Certificate Configuration

variable "tls_enabled" {
  description = "Enable TLS for ingress"
  type        = bool
  default     = false
}

variable "tls_secret_name" {
  description = "TLS secret name"
  type        = string
  default     = "einvoice-tls"
}
</file>

<file path=".gitattributes">
/mvnw text eol=lf
*.cmd text eol=crlf
</file>

<file path=".gitignore">
HELP.md
target/
.mvn/wrapper/maven-wrapper.jar
!**/src/main/**/target/
!**/src/test/**/target/

### STS ###
.apt_generated
.classpath
.factorypath
.project
.settings
.springBeans
.sts4-cache

### IntelliJ IDEA ###
.idea
*.iws
*.iml
*.ipr

### NetBeans ###
/nbproject/private/
/nbbuild/
/dist/
/nbdist/
/.nb-gradle/
build/
!**/src/main/**/build/
!**/src/test/**/build/

### VS Code ###
.vscode/
/bin/
</file>

<file path="config.yaml">
spring:
  application:
    name: einvoicehub-core
    
  # MySQL Configuration
  datasource:
    url: jdbc:mysql://${DATABASE_HOST:localhost}:${DATABASE_PORT:3306}/${DATABASE_NAME:einvoicehub}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
    username: ${DATABASE_USERNAME:root}
    password: ${DATABASE_PASSWORD:password}
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      minimum-idle: 5
      maximum-pool-size: 20
      idle-timeout: 300000
      pool-name: EInvoiceHubHikariCP
      max-lifetime: 1200000
      connection-timeout: 20000
      register-mbeans: true
      
  # JPA Configuration
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQLDialect
        format_sql: true
        jdbc:
          time_zone: UTC
          
  # MongoDB Configuration
  data:
    mongodb:
      uri: mongodb://${MONGODB_USERNAME:admin}:${MONGODB_PASSWORD:password}@${MONGODB_HOST:localhost}:${MONGODB_PORT:27017}/${MONGODB_DATABASE:einvoicehub}?authSource=admin
      auto-index-creation: true
      
# Server Configuration
server:
  port: ${SERVER_PORT:8080}
  servlet:
    context-path: /api/v1
  tomcat:
    threads:
      max: 200
      min-spare: 10
    accept-count: 100
    max-connections: 10000
    
# Application Custom Configuration
app:
  name: EInvoiceHub
  version: 1.0.0
  
  # Virtual Threads Configuration
  virtual-threads:
    enabled: true
    
  # Security Configuration
  security:
    api-key:
      header-name: X-API-KEY
      client-id-header: X-CLIENT-ID
      
# Provider Configuration
providers:
  vnpt:
    base-url: ${VNPT_BASE_URL:https://api.vnpt-invoice.vn}
    timeout: 30000
    retry-count: 3
    
  viettel:
    base-url: ${VIETTEL_BASE_URL:https://einvoice.viettel.vn}
    timeout: 30000
    retry-count: 3
    
  bkav:
    base-url: ${BKAV_BASE_URL:https://bkav-invoice.com}
    timeout: 30000
    retry-count: 3
    encryption-key: ${BKAV_ENCRYPTION_KEY:your-256-bit-key}
    
  misa:
    base-url: ${MISA_BASE_URL:https://api.meinvoice.vn}
    timeout: 30000
    retry-count: 3
    app-id: ${MISA_APP_ID:your-app-id}
    
# Actuator & Monitoring
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: when-authorized
  metrics:
    tags:
      application: ${spring.application.name}
      
# Logging Configuration
logging:
  level:
    root: INFO
    com.einvoicehub: DEBUG
    org.springframework.security: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    
# OpenAPI Configuration
springdoc:
  api-docs:
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
    operations-sorter: method
    tags-sorter: alpha
  show-actuator: true
</file>

<file path="docker-compose.yml">
# Docker Compose configuration for EInvoiceHub local development environment
services:
  # MariaDB Database - Primary relational database
  mariadb:
    image: mariadb:10.11
    container_name: einvoice-mariadb
    hostname: mariadb
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD:-einvoice_root_pass}
      MARIADB_DATABASE: einvoicehub
      MARIADB_USER: einvoice_user
      MARIADB_PASSWORD: ${MARIADB_PASSWORD:-einvoice_pass}
    ports:
      - "3306:3306"
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./sql/init:/docker-entrypoint-initdb.d
      - ./sql/config/my.cnf:/etc/mysql/conf.d/my.cnf:ro
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "localhost", "-u", "root", "-p${MARIADB_ROOT_PASSWORD:-einvoice_root_pass}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - einvoice-network
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
  
  # Prometheus - Metrics collection
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: einvoice-prometheus
    hostname: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/rules:/etc/prometheus/rules:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
    networks:
      - einvoice-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  
  # Grafana - Metrics visualization 
  grafana:
    image: grafana/grafana:10.2.0
    container_name: einvoice-grafana
    hostname: grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-einvoice_grafana}
      - GF_USERS_ALLOW_SIGN_UP=false
    ports:
      - "3000:3000"
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards
      - grafana_data:/var/lib/grafana
    depends_on:
      prometheus:
        condition: service_started
    networks:
      - einvoice-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  
  # EInvoiceHub Application - Main backend service
  backend:
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
    container_name: einvoice-backend
    hostname: backend
    ports:
      - "8080:8080"
      - "5005:5005"
    environment:
      # Spring Boot Configuration
      - SPRING_PROFILES_ACTIVE=dev
      - SERVER_PORT=8080

      # Database Configuration - Thay ƒë·ªïi sang MariaDB
      - SPRING_DATASOURCE_URL=jdbc:mariadb://mariadb:3306/einvoicehub?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      - SPRING_DATASOURCE_USERNAME=einvoice_user
      - SPRING_DATASOURCE_PASSWORD=einvoice_pass
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update

      # Application Specific
      - APP_NAME=einvoicehub
      - LOG_LEVEL=INFO

      # Java VM Options
      - JAVA_OPTS=-XX:+UseG1GC -XX:MaxGCPauseMillis=200 -Xms256m -Xmx512m
    depends_on:
      mariadb:
        condition: service_healthy
    volumes:
      - ./logs:/app/logs:rw
      - ./config:/app/config:ro
    networks:
      - einvoice-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    restart: unless-stopped


# Networks Configuration
networks:
  einvoice-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16


# Volumes Configuration
volumes:
  mariadb_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
</file>

<file path="Dockerfile">
# Multi-stage Dockerfile for EInvoiceHub Spring Boot Application
# Optimized for Java 21 with Virtual Threads support



# Stage 1: Builder Stage - Compile and package the application

FROM maven:3.9-eclipse-temurin-21-jdk-alpine AS builder

# Set working directory
WORKDIR /build

# Copy pom.xml first for dependency caching
COPY pom.xml ./

# Download dependencies (this layer will be cached unless pom.xml changes)
RUN mvn dependency:go-offline -B

# Copy source code
COPY src ./src

# Build the application with Spring Boot thin launcher for smaller image
RUN mvn package -DskipTests -B


# Stage 2: Runtime Stage - Minimal JRE image for production

FROM eclipse-temurin:21-jre-alpine AS runtime

# Labels for container metadata
LABEL maintainer="EInvoiceHub Team" \
      version="1.0.0" \
      description="EInvoiceHub - Electronic Invoice Hub Service" \
      org.opencontainers.image.source="https://github.com/hkhuang07/EInvoiceHub-SpringBoot-Angular-GitOps-Kubernetes/tree/main/backend-springboot"

# Set environment variables
ENV JAVA_OPTS="-XX:+EnableDynamicAgentLoading -XX:+UseG1GC" \
    APP_NAME="einvoicehub" \
    APP_VERSION="1.0.0"

# Create non-root user for security
RUN addgroup -g 1000 appgroup && \
    adduser -u 1000 -G appgroup -s /bin/sh -D appuser

# Set working directory
WORKDIR /app

# Copy the built artifact from builder stage
COPY --from=builder /build/target/*.jar app.jar

# Create directories for logs and config
RUN mkdir -p /app/logs /app/config && \
    chown -R appuser:appgroup /app

# Switch to non-root user
USER appuser

# Expose application port (default Spring Boot port)
EXPOSE 8080

# Health check configuration
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1

# Entrypoint and CMD
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -Djava.security.egd=file:/dev/./urandom -jar /app/app.jar"]
CMD ["--spring.profiles.active=prod"]


# Stage 3: Development Stage - For local development with debug support

FROM builder AS dev

# Expose debug port
EXPOSE 5005

# Debug JVM options
ENV JAVA_TOOL_OPTIONS="-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005"

# Entrypoint for development with debug
ENTRYPOINT ["sh", "-c", "java $JAVA_TOOL_OPTIONS -Djava.security.egd=file:/dev/./urandom -jar /app/target/*.jar"]


# Alternative: Native Build Stage (Optional - for GraalVM)

# Uncomment this section and comment out the runtime stage for native image
# FROM ghcr.io/graalvm/native-image:21-ol8 AS native-builder

# WORKDIR /build
# COPY --from=builder /build/target/*.jar application.jar
# COPY --from=builder /build/src src

# RUN native-image \
#     -J-Xmx8g \
#     -H:Class=com.einvoicehub.EinvoicehubApplication \
#     -H:Name=einvoicehub-native \
#     -H:+ReportExceptionStackTraces \
#     --no-fallback \
#     -H:+StaticExecutableWithDynamicLibC \
#     -cp application.jar

# FROM ubuntu:22.04 AS native-runtime
# COPY --from=native-builder /build/einvoicehub-native /app/einvoicehub
# RUN chmod +x /app/einvoicehub
# EXPOSE 8080
# ENTRYPOINT ["/app/einvoicehub"]
</file>

<file path="Jenkinsfile.txt">
// =============================================================================
// EInvoiceHub Jenkins CI/CD Pipeline
// =============================================================================
// Purpose: Automated build, test, and deployment pipeline for EInvoiceHub
// Author: EInvoiceHub Team
// =============================================================================

pipeline {
    agent {
        label 'docker-build-agent'
    }

    options {
        // Timeout for the entire pipeline
        timeout(time: 60, unit: 'MINUTES')

        // Disable concurrent builds for the same branch
        disableConcurrentBuilds()

        // Build retention
        buildDiscarder(logRotator(
            numToKeepStr: '10',
            artifactNumToKeepStr: '10'
        ))

        // Skip default checkout
        skipDefaultCheckout()
    }

    environment {
        // Application Info
        APP_NAME = 'einvoicehub'
        APP_VERSION = "${BUILD_NUMBER}"

        // Docker Configuration
        DOCKER_REGISTRY = 'registry.einvoicehub.io'
        DOCKER_IMAGE = "${DOCKER_REGISTRY}/${APP_NAME}/backend:${APP_VERSION}"
        DOCKER_IMAGE_LATEST = "${DOCKER_REGISTRY}/${APP_NAME}/backend:latest"

        // Maven Configuration
        MAVEN_OPTS = '-Xmx1024m'

        // SonarQube Configuration
        SONAR_SCANNER_HOME = tool 'sonar-scanner'

        // Environment
        ENVIRONMENT = 'dev'

        // Kubernetes
        K8S_NAMESPACE = 'einvoice-dev'

        // Tools
        JAVA_VERSION = '21'
    }

    stages {
        // =====================================================================
        // Stage 1: Checkout
        // =====================================================================
        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/einvoicehub/backend.git',
                        credentialsId: 'github-credentials'
                    ]]
                ])
            }
        }

        // =====================================================================
        // Stage 2: Build
        // =====================================================================
        stage('Build') {
            parallel {
                stage('Maven Build') {
                    steps {
                        dir('backend') {
                            withMaven(
                                maven: 'maven-3.9',
                                jdk: 'java-21'
                            ) {
                                sh 'mvn clean compile -DskipTests -B'
                            }
                        }
                    }
                }

                stage('Security Scan') {
                    steps {
                        dir('backend') {
                            withMaven(
                                maven: 'maven-3.9',
                                jdk: 'java-21'
                            ) {
                                sh 'mvn dependency-check:check -B'
                            }
                        }
                    }
                }
            }
        }

        // =====================================================================
        // Stage 3: Unit Tests
        // =====================================================================
        stage('Unit Tests') {
            steps {
                dir('backend') {
                    withMaven(
                        maven: 'maven-3.9',
                        jdk: 'java-21'
                    ) {
                        sh 'mvn test -B'
                    }
                }
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                    cobertura(
                        coberturaReportFile: '**/target/site/cobertura/coverage.xml',
                        autoUpdateHealth: false,
                        autoUpdateStability: false,
                        onlyStable: false
                    )
                }
            }
        }

        // =====================================================================
        // Stage 4: Code Quality
        // =====================================================================
        stage('Code Quality') {
            steps {
                dir('backend') {
                    withMaven(
                        maven: 'maven-3.9',
                        jdk: 'java-21'
                    ) {
                        sh 'mvn sonar:sonar ' +
                           '-Dsonar.projectKey=einvoicehub_backend ' +
                           '-Dsonar.projectName=EInvoiceHub_Backend ' +
                           '-Dsonar.projectVersion=${BUILD_NUMBER} ' +
                           '-Dsonar.sourceEncoding=UTF-8 ' +
                           '-Dsonar.java.binaries=target/classes ' +
                           '-Dsonar.tests=target/test-classes'
                    }
                }
            }
        }

        // =====================================================================
        // Stage 5: Package
        // =====================================================================
        stage('Package') {
            steps {
                dir('backend') {
                    withMaven(
                        maven: 'maven-3.9',
                        jdk: 'java-21'
                    ) {
                        sh 'mvn package -DskipTests -B'
                    }
                }
            }
        }

        // =====================================================================
        // Stage 6: Build Docker Image
        // =====================================================================
        stage('Build Docker Image') {
            steps {
                script {
                    dockerImage = docker.build(
                        "${DOCKER_IMAGE}",
                        "-f Dockerfile --build-arg APP_VERSION=${BUILD_NUMBER} ./backend"
                    )
                }
            }
        }

        // =====================================================================
        // Stage 7: Push Docker Image
        // =====================================================================
        stage('Push Docker Image') {
            steps {
                script {
                    docker.withRegistry("${DOCKER_REGISTRY}", 'docker-registry-credentials') {
                        dockerImage.push()
                        dockerImage.push('latest')
                    }
                }
            }
        }

        // =====================================================================
        // Stage 8: Trivy Vulnerability Scan
        // =====================================================================
        stage('Vulnerability Scan') {
            steps {
                script {
                    trivy(
                        imageRef: "${DOCKER_IMAGE}",
                        exitCode: '0',
                        severity: 'HIGH,CRITICAL',
                        timeout: '300'
                    )
                }
            }
        }

        // =====================================================================
        // Stage 9: Deploy to Development
        // =====================================================================
        stage('Deploy to Development') {
            when {
                branch 'develop'
            }
            steps {
                script {
                    // Update Kubernetes manifests with new image tag
                    sh "sed -i 's|image: ${DOCKER_REGISTRY}/${APP_NAME}/backend:.*|image: ${DOCKER_IMAGE}|g' kubernetes/deployment.yaml"

                    // Deploy to Kubernetes
                    kubernetesDeploy(
                        configs: 'kubernetes/*.yaml',
                        kubeconfigId: 'kubernetes-credentials',
                        namespace: "${K8S_NAMESPACE}"
                    )

                    // Wait for deployment
                    sh "kubectl rollout status deployment/${APP_NAME} -n ${K8S_NAMESPACE} --timeout=300s"

                    // Health check
                    sh "curl -f http://einvoice.local/actuator/health || exit 1"
                }
            }
        }

        // =====================================================================
        // Stage 10: Deploy to Staging
        // =====================================================================
        stage('Deploy to Staging') {
            when {
                branch 'release/*'
            }
            steps {
                script {
                    // Tag release image
                    dockerImage.push("release-${BUILD_NUMBER}")

                    // Update Kubernetes manifests
                    sh "sed -i 's|image: ${DOCKER_REGISTRY}/${APP_NAME}/backend:.*|image: ${DOCKER_IMAGE}|g' kubernetes/deployment.yaml"

                    // Deploy to staging namespace
                    kubernetesDeploy(
                        configs: 'kubernetes/*.yaml',
                        kubeconfigId: 'kubernetes-credentials',
                        namespace: 'einvoice-staging'
                    )

                    // Wait for deployment
                    sh "kubectl rollout status deployment/${APP_NAME} -n einvoice-staging --timeout=300s"

                    // Run integration tests
                    sh "mvn verify -B -DskipUnitTests"
                }
            }
        }

        // =====================================================================
        // Stage 11: Deploy to Production
        // =====================================================================
        stage('Deploy to Production') {
            when {
                branch 'main'
                environment name: 'DEPLOY_TO_PROD', value: 'true'
            }
            steps {
                script {
                    // Approval step
                    timeout(time: 1, unit: 'HOURS') {
                        input message: 'Deploy to Production?', ok: 'Deploy'
                    }

                    // Blue/Green deployment
                    def blueVersion = 'blue'
                    def greenVersion = 'green'
                    def currentVersion = readFile('current-version.txt').trim()
                    def newVersion = currentVersion == blueVersion ? greenVersion : blueVersion

                    // Deploy new version
                    sh "sed -i 's|image: ${DOCKER_REGISTRY}/${APP_NAME}/backend:.*|image: ${DOCKER_IMAGE}|g' kubernetes/deployment.yaml"

                    kubernetesDeploy(
                        configs: 'kubernetes/*.yaml',
                        kubeconfigId: 'kubernetes-credentials',
                        namespace: 'einvoice-prod'
                    )

                    // Wait for deployment
                    sh "kubectl rollout status deployment/${APP_NAME} -n einvoice-prod --timeout=600s"

                    // Health check
                    sh "curl -f https://api.einvoicehub.com/actuator/health || exit 1"

                    // Update current version
                    writeFile file: 'current-version.txt', text: newVersion
                }
            }
        }

        // =====================================================================
        // Stage 12: Post-Deployment
        // =====================================================================
        stage('Post-Deployment') {
            when {
                anyOf {
                    branch 'develop'
                    branch 'release/*'
                    branch 'main'
                }
            }
            steps {
                script {
                    // Send notification
                    slackSend(
                        channel: '#deployments',
                        color: 'good',
                        message: "Deployment Successful: ${APP_NAME} v${BUILD_NUMBER} to ${ENVIRONMENT}"
                    )

                    // Archive artifacts
                    archiveArtifacts(
                        artifacts: '**/target/*.jar,**/target/site/**/*.html',
                        fingerprint: true,
                        allowEmptyArchive: true
                    )
                }
            }
        }
    }

    // =====================================================================
    // Post Actions
    // =====================================================================
    post {
        success {
            echo '‚úì Pipeline completed successfully'
            script {
                if (env.BRANCH_NAME == 'main') {
                    slackSend(
                        channel: '#deployments',
                        color: 'good',
                        message: "‚úÖ Production deployment successful: ${APP_NAME} v${BUILD_NUMBER}"
                    )
                }
            }
        }

        failure {
            echo '‚úó Pipeline failed'
            script {
                slackSend(
                    channel: '#deployments',
                    color: 'danger',
                    message: "‚ùå Deployment failed: ${APP_NAME} v${BUILD_NUMBER}\n${env.BUILD_URL}"
                )
            }
        }

        unstable {
            echo 'Pipeline marked as unstable'
        }

        cleanup {
            // Clean up workspace
            cleanWs(
                deleteDirs: true,
                patterns: [
                    pattern: '.gitignore',
                    invert: true
                ]
            )
        }
    }
}
</file>

<file path="pom.xml">
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.4.1</version>
        <relativePath/>
    </parent>

    <groupId>com.einvoicehub</groupId>
    <artifactId>einvoicehub-core</artifactId>
    <version>1.0.0-SNAPSHOT</version>
    <name>EInvoiceHub Core</name>
    <description>H·ªá th·ªëng trung gian k·∫øt n·ªëi h√≥a ƒë∆°n ƒëi·ªán t·ª≠ - EInvoiceHub (MariaDB Only)</description>

    <properties>
        <java.version>21</java.version>
        <spring-boot.version>3.4.1</spring-boot.version>
        <snakeyaml.version>2.2</snakeyaml.version>
    </properties>

    <dependencies>
        <!-- Spring Boot Starters -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>

        <!-- LO·∫†I B·ªé: MongoDB Starter -->
        <!-- <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-mongodb</artifactId>
        </dependency> -->

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
        </dependency>

        <dependency>
            <groupId>org.flywaydb</groupId>
            <artifactId>flyway-core</artifactId>
        </dependency>

        <dependency>
            <groupId>org.flywaydb</groupId>
            <artifactId>flyway-mysql</artifactId>
        </dependency>

        <!-- Database Drivers -->
        <dependency>
            <groupId>org.mariadb.jdbc</groupId>
            <artifactId>mariadb-java-client</artifactId>
        </dependency>

        <!-- Lombok -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>

        <!-- Jackson for JSON -->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
        </dependency>

        <dependency>
            <groupId>com.fasterxml.jackson.dataformat</groupId>
            <artifactId>jackson-dataformat-xml</artifactId>
        </dependency>

        <dependency>
            <groupId>com.fasterxml.jackson.datatype</groupId>
            <artifactId>jackson-datatype-jsr310</artifactId>
        </dependency>

        <!-- YAML Configuration -->
        <dependency>
            <groupId>org.yaml</groupId>
            <artifactId>snakeyaml</artifactId>
            <version>${snakeyaml.version}</version>
        </dependency>

        <!-- OpenAPI/Swagger -->
        <dependency>
            <groupId>org.springdoc</groupId>
            <artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
            <version>2.5.0</version>
        </dependency>

        <!-- Micrometer for metrics -->
        <dependency>
            <groupId>io.micrometer</groupId>
            <artifactId>micrometer-registry-prometheus</artifactId>
        </dependency>

        <!-- Testing -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>org.springframework.security</groupId>
            <artifactId>spring-security-test</artifactId>
            <scope>test</scope>
        </dependency>

        <!-- H2 for testing -->
        <dependency>
            <groupId>com.h2database</groupId>
            <artifactId>h2</artifactId>
            <scope>test</scope>
        </dependency>

        <!-- Mockito -->
        <dependency>
            <groupId>org.mockito</groupId>
            <artifactId>mockito-core</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>

            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.11.0</version>
                <configuration>
                    <source>21</source>
                    <target>21</target>
                    <annotationProcessorPaths>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                            <version>1.18.30</version>
                        </path>
                    </annotationProcessorPaths>
                </configuration>
            </plugin>

            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-surefire-plugin</artifactId>
                <version>3.2.2</version>
            </plugin>
        </plugins>
    </build>
</project>
</file>

<file path="purge-data.sh">
#!/bin/bash

# =============================================================================
# EInvoiceHub Data Purge Script
# =============================================================================
# Purpose: Clean up and reset data for local K8s development environment
# Usage: ./purge-data.sh [environment]
# Environments: dev, staging, prod
# =============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Default environment
ENVIRONMENT=${1:-dev}
NAMESPACE="einvoice-${ENVIRONMENT}"

# Confirmation prompt
confirm_purge() {
    echo -e "${YELLOW}‚ö†Ô∏è  WARNING: This will delete all data for environment '${ENVIRONMENT}'${NC}"
    echo -e "${RED}This action cannot be undone!${NC}"
    read -p "Are you sure you want to continue? (yes/no): " CONFIRM

    if [ "$CONFIRM" != "yes" ]; then
        echo -e "${YELLOW}Purge operation cancelled.${NC}"
        exit 0
    fi
}

# Print banner
print_banner() {
    echo -e "${BLUE}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë           EInvoiceHub Data Purge Script                        ‚ïë"
    echo "‚ïë                                                                ‚ïë"
    echo "‚ïë  Environment: ${ENVIRONMENT}${NC}                                  "
    echo -e "${BLUE}‚ïë  Namespace:  ${NAMESPACE}${NC}                                      "
    echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
}

# Check prerequisites
check_prerequisites() {
    echo -e "\n${GREEN}‚úì Checking prerequisites...${NC}"

    # Check for required tools
    local MISSING_TOOLS=()

    if ! command -v kubectl &> /dev/null; then
        MISSING_TOOLS+=("kubectl")
    fi

    if ! command -v docker &> /dev/null; then
        MISSING_TOOLS+=("docker")
    fi

    if ! command -v mongosh &> /dev/null; then
        MISSING_TOOLS+=("mongosh")
    fi

    if ! command -v mysql &> /dev/null; then
        MISSING_TOOLS+=("mysql")
    fi

    if [ ${#MISSING_TOOLS[@]} -ne 0 ]; then
        echo -e "${RED}‚úó Missing required tools: ${MISSING_TOOLS[*]}${NC}"
        echo "Please install the missing tools before running this script."
        exit 1
    fi

    echo -e "${GREEN}‚úì All prerequisites met${NC}"
}

# Stop and remove containers
stop_containers() {
    echo -e "\n${GREEN}‚úì Stopping Docker containers...${NC}"

    if command -v docker &> /dev/null; then
        docker compose down -v --remove-orphans 2>/dev/null || true
        echo -e "${GREEN}‚úì Docker containers stopped and volumes removed${NC}"
    fi
}

# Purge Kubernetes resources
purge_kubernetes() {
    echo -e "\n${GREEN}‚úì Purging Kubernetes resources...${NC}"

    # Check if kubectl is configured
    if ! kubectl cluster-info &> /dev/null; then
        echo -e "${YELLOW}‚ö†Ô∏è  Kubernetes not configured or not accessible. Skipping K8s cleanup.${NC}"
        return
    fi

    # Check if namespace exists
    if kubectl get namespace "$NAMESPACE" &> /dev/null; then
        echo -e "${YELLOW}  Deleting all resources in namespace: $NAMESPACE${NC}"

        # Delete deployments
        kubectl delete deployment --all -n "$NAMESPACE" --ignore-not-found=true

        # Delete services
        kubectl delete service --all -n "$NAMESPACE" --ignore-not-found=true

        # Delete configmaps
        kubectl delete configmap --all -n "$NAMESPACE" --ignore-not-found=true

        # Delete secrets
        kubectl delete secret --all -n "$NAMESPACE" --ignore-not-found=true

        # Delete persistentvolumeclaims
        kubectl delete pvc --all -n "$NAMESPACE" --ignore-not-found=true

        # Delete jobs
        kubectl delete job --all -n "$NAMESPACE" --ignore-not-found=true

        # Delete cronjobs
        kubectl delete cronjob --all -n "$NAMESPACE" --ignore-not-found=true

        echo -e "${GREEN}‚úì Kubernetes resources purged${NC}"
    else
        echo -e "${YELLOW}  Namespace $NAMESPACE does not exist. Skipping.${NC}"
    fi
}

# Purge MySQL data
purge_mysql() {
    echo -e "\n${GREEN}‚úì Purging MySQL data...${NC}"

    local MYSQL_HOST=${MYSQL_HOST:-localhost}
    local MYSQL_PORT=${MYSQL_PORT:-3306}
    local MYSQL_USER=${MYSQL_USER:-root}
    local MYSQL_PASSWORD=${MYSQL_PASSWORD:-einvoice_root_pass}
    local DATABASE=${DATABASE:-einvoicehub}

    # Check if MySQL is running
    if ! docker ps | grep -q "einvoice-mysql"; then
        echo -e "${YELLOW}‚ö†Ô∏è  MySQL container not running. Attempting direct connection...${NC}"
    fi

    # Drop and recreate database
    mysql -h "$MYSQL_HOST" -P "$MYSQL_PORT" -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" <<EOF
DROP DATABASE IF EXISTS $DATABASE;
CREATE DATABASE $DATABASE CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
GRANT ALL PRIVILEGES ON $DATABASE.* TO '$MYSQL_USER'@'%';
FLUSH PRIVILEGES;
EOF

    echo -e "${GREEN}‚úì MySQL data purged and database recreated${NC}"
}

# Purge MongoDB data
purge_mongodb() {
    echo -e "\n${GREEN}‚úì Purging MongoDB data...${NC}"

    local MONGODB_HOST=${MONGODB_HOST:-localhost}
    local MONGODB_PORT=${MONGODB_PORT:-27017}
    local MONGODB_USER=${MONGODB_USER:-admin}
    local MONGODB_PASSWORD=${MONGODB_PASSWORD:-einvoice_mongo_pass}
    local DATABASE=${MONGODB_DATABASE:-einvoicehub}

    # Drop all collections
    mongosh --host "$MONGODB_HOST" --port "$MONGODB_PORT" -u "$MONGODB_USER" -p "$MONGODB_PASSWORD" --authenticationDatabase admin <<EOF
use $DATABASE
db.getCollectionNames().forEach(function(collection) {
    db[collection].drop();
});
print("All collections dropped from database: $DATABASE");
EOF

    echo -e "${GREEN}‚úì MongoDB data purged${NC}"
}

# Purge Redis cache
purge_redis() {
    echo -e "\n${GREEN}‚úì Purging Redis cache...${NC}"

    local REDIS_HOST=${REDIS_HOST:-localhost}
    local REDIS_PORT=${REDIS_PORT:-6379}

    # Flush all Redis databases
    redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" FLUSHALL

    echo -e "${GREEN}‚úì Redis cache purged${NC}"
}

# Purge Elasticsearch indices
purge_elasticsearch() {
    echo -e "\n${GREEN}‚úì Purging Elasticsearch data...${NC}"

    local ES_HOST=${ES_HOST:-localhost}
    local ES_PORT=${ES_PORT:-9200}

    # Delete all indices matching einvoice pattern
    curl -X DELETE "http://$ES_HOST:$ES_PORT/einvoice*" 2>/dev/null || true

    echo -e "${GREEN}‚úì Elasticsearch data purged${NC}"
}

# Clean up local files
cleanup_files() {
    echo -e "\n${GREEN}‚úì Cleaning up local files...${NC}"

    # Remove log files
    if [ -d "logs" ]; then
        rm -rf logs/*
        echo "  - Logs cleared"
    fi

    # Remove temporary files
    if [ -d "tmp" ]; then
        rm -rf tmp/*
        echo "  - Temporary files cleared"
    fi

    # Remove generated reports
    if [ -d "reports" ]; then
        rm -rf reports/*
        echo "  - Reports cleared"
    fi

    echo -e "${GREEN}‚úì Local files cleaned${NC}"
}

# Print summary
print_summary() {
    echo -e "\n${BLUE}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                    PURGE COMPLETED                              ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo -e "\n${GREEN}Summary:${NC}"
    echo "  - Environment: $ENVIRONMENT"
    echo "  - Namespace: $NAMESPACE"
    echo "  - Docker containers: Stopped"
    echo "  - MySQL database: Recreated"
    echo "  - MongoDB collections: Dropped"
    echo "  - Redis cache: Flushed"
    echo "  - Elasticsearch indices: Deleted"
    echo "  - Local files: Cleaned"
    echo -e "\n${YELLOW}Next steps:${NC}"
    echo "  1. Run 'docker compose up -d' to restart services"
    echo "  2. Run migrations if needed"
    echo "  3. Restart the application"
    echo -e "\n"
}

# Main execution
main() {
    print_banner
    confirm_purge
    check_prerequisites

    # Perform purging based on environment
    case "$ENVIRONMENT" in
        dev)
            stop_containers
            purge_mysql
            purge_mongodb
            purge_redis
            cleanup_files
            ;;
        staging|prod)
            purge_kubernetes
            purge_elasticsearch
            cleanup_files
            ;;
        *)
            echo -e "${RED}Invalid environment: $ENVIRONMENT${NC}"
            echo "Valid environments: dev, staging, prod"
            exit 1
            ;;
    esac

    print_summary
}

# Run main function
main "$@"
</file>

<file path="repomix.config.json">
{
  "output": {
    "filePath": "einvoicehub-full-source.txt",
    "style": "xml"
  },
  "include": ["**/*"],
  "ignore": {
    "customPatterns": [
      "**/bin/**",
      "**/target/**",
      "**/*.class",
      "**/*.exe",
      "**/*.jar",
      "mvnw",
      "mvnw.cmd",
      "**/HELP.md",
      "**/.git/**",
      "**/.idea/**",
      "**/.vscode/**",
      "**/node_modules/**",
      "**/dist/**"
    ],
    "useGitignore": true,
    "useDefaultPatterns": true
  },
  "security": {
    "enableSecurityCheck": true
  },
  "tokenCount": {
    "encoding": "cl100k_base"
  }
}
</file>

</files>
