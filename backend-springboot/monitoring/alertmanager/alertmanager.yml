# EInvoiceHub Alertmanager Configuration

global:
  resolve_timeout: 5m
  slack_api_url: 'https://hooks.slack.com/services/xxx/yyy/zzz'

# Route defines a routing tree for processing alerts
route:
  group_by: ['alertname', 'severity']
  receiver: 'default-receiver'
  group_interval: 5m
  group_wait: 30s
  repeat_interval: 4h

  # Child routes for specific severities
  routes:
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 1h

    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 1m
      repeat_interval: 6h

    - match:
        alertname: 'HighErrorRate'
      receiver: 'urgent-alerts'
      continue: true

# Receivers define notification destinations
receivers:
  - name: 'default-receiver'
    slack_configs:
      - channel: '#alerts'
        send_resolved: true
        title: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ end }}'
        text: |
          {{ range .Alerts }}
          **{{ .Labels.severity | upper }}** - {{ .Labels.alertname }}
          Description: {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          Start: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        color:
          critical: '#ff0000'
          warning: '#ffa500'
          info: '#00ff00'

  - name: 'critical-alerts'
    slack_configs:
      - channel: '#critical-alerts'
        send_resolved: true
        title: 'üö® CRITICAL ALERT: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        text: |
          {{ range .Alerts }}
          **Severity:** {{ .Labels.severity | upper }}
          **Alert:** {{ .Labels.alertname }}
          **Description:** {{ .Annotations.description }}
          **Namespace:** {{ .Labels.namespace }}
          **Pod:** {{ .Labels.pod }}
          **Value:** {{ .Annotations.current_value }}
          **Started:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  - name: 'warning-alerts'
    slack_configs:
      - channel: '#warning-alerts'
        send_resolved: true
        title: '‚ö†Ô∏è WARNING: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        text: |
          {{ range .Alerts }}
          **Alert:** {{ .Labels.alertname }}
          **Description:** {{ .Annotations.description }}
          **Value:** {{ .Annotations.current_value }}
          {{ end }}

  - name: 'urgent-alerts'
    slack_configs:
      - channel: '#urgent-alerts'
        send_resolved: true
        mention_users: '@oncall'
        title: 'üî• URGENT: High Error Rate Detected'
        text: |
          **Alert:** High Error Rate Detected
          **Error Rate:** {{ range .Alerts }}{{ .Annotations.current_value }}{{ end }}
          **Endpoint:** {{ range .Alerts }}{{ .Annotations.endpoint }}{{ end }}
          **Action Required:** Immediate investigation needed!

  - name: 'pagerduty'
    pagerduty_configs:
      - service_key: 'pagerduty-service-key'
        severity: critical
        description: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        source: 'EInvoiceHub'
        custom_details:
          environment: '{{ env "ENVIRONMENT" }}'
          cluster: '{{ env "CLUSTER_NAME" }}'

  - name: 'email'
    email_configs:
      - to: 'alerts@einvoicehub.io'
        send_resolved: true
        html: |
          <html>
          <body>
          <h2>Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}</h2>
          <p><strong>Severity:</strong> {{ range .Alerts }}{{ .Labels.severity }}{{ end }}</p>
          <p><strong>Description:</strong> {{ range .Alerts }}{{ .Annotations.description }}{{ end }}</p>
          <p><strong>Value:</strong> {{ range .Alerts }}{{ .Annotations.current_value }}{{ end }}</p>
          <p><strong>Started:</strong> {{ range .Alerts }}{{ .StartsAt.Format "2006-01-02 15:04:05" }}{{ end }}</p>
          </body>
          </html>

# Inhibition rules
inhibit_rules:
  # Inhibit warning alerts if the same alert is already firing as critical
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'namespace', 'pod']

  # Inhibit info alerts if warning or critical for same alert
  - source_match:
      severity: 'warning'
    target_match:
      severity: 'info'
    equal: ['alertname', 'namespace']

# Time intervals for notification routing
time_intervals:
  - name: 'business-hours'
    time_intervals:
      - times:
          - start_time: '09:00'
            end_time: '17:00'
        weekdays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday']
        months: ['january', 'february', 'march', 'april', 'may', 'june',
                 'july', 'august', 'september', 'october', 'november', 'december']
        location: 'Asia/Ho_Chi_Minh'

  - name: 'off-hours'
    time_intervals:
      - times:
          - start_time: '17:00'
            end_time: '09:00'
        weekdays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday']
        months: ['january', 'february', 'march', 'april', 'may', 'june',
                 'july', 'august', 'september', 'october', 'november', 'december']
        location: 'Asia/Ho_Chi_Minh'
      - times:
          - start_time: '00:00'
            end_time: '23:59'
        weekdays: ['saturday', 'sunday']
        months: ['january', 'february', 'march', 'april', 'may', 'june',
                 'july', 'august', 'september', 'october', 'november', 'december']
        location: 'Asia/Ho_Chi_Minh'
