This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: **/*
- Files matching these patterns are excluded: **/bin/**, **/target/**, **/*.class, **/*.exe, **/*.jar, mvnw, mvnw.cmd, **/HELP.md, **/.git/**, **/.idea/**, **/.vscode/**, **/node_modules/**, **/dist/**
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.mvn/
  wrapper/
    maven-wrapper.properties
helm/
  einvoicehub/
    Chart.yaml
    values.yaml
kubernetes/
  deployment.yaml
  ingress.yaml
  service.yaml
monitoring/
  alertmanager/
    alertmanager.yml
  grafana/
    dashboards/
      einvoicehub/
        einvoicehub-overview.json
    provisioning/
      dashboards/
        default.yaml
      datasources/
        prometheus.yaml
  prometheus/
    prometheus.yml
sql/
  init/
    V1__Initial_Schema.sql
src/
  main/
    java/
      com/
        einvoicehub/
          core/
            config/
              SecurityConfig.java
              VirtualThreadConfig.java
              WebClientConfig.java
            converter/
              EncryptionConverter.java
              JsonAttributeConverter.java
            domain/
              entity/
                enums/
                  AdjustmentStatus.java
                  AdjustmentType.java
                  AuditAction.java
                  IssuanceMethod.java
                  SubscriptionPlan.java
                  SyncStatus.java
                  SyncType.java
                  UserRole.java
                EinvApiCredentialsEntity.java
                EinvAuditLogsEntity.java
                EinvInvoiceAdjustmentsEntity.java
                EinvInvoiceItemEntity.java
                EinvInvoiceMetadataEntity.java
                EinvInvoicePayloadEntity.java
                EinvInvoiceRegistrationEntity.java
                EinvInvoiceStatusEntity.java
                EinvInvoiceSyncQueueEntity.java
                EinvInvoiceTaxBreakDownEntity.java
                EinvInvoiceTemplateEntity.java
                EinvInvoiceTypeEntity.java
                EinvMerchantEntity.java
                EinvMerchantProviderConfigEntity.java
                EinvMerchantUserEntity.java
                EinvPaymentMethodEntity.java
                EinvRegistrationStatusEntity.java
                EinvServiceProviderEntity.java
                EinvSystemConfigEntity.java
                EinvTaxAuthorityResponseEntity.java
                EinvUserAuthorEntity.java
                EinvVatRateEntity.java
              repository/
                EinvApiCredentialRepository.java
                EinvAuditLogRepository.java
                EinvInvoiceAdjustmentRepository.java
                EinvInvoiceItemRepository.java
                EinvInvoiceMetadataRepository.java
                EinvInvoicePayloadRepository.java
                EinvInvoiceRegistrationRepository.java
                EinvInvoiceStatusRepository.java
                EinvInvoiceSyncQueueRepository.java
                EinvInvoiceTaxBreakdownRepository.java
                EinvInvoiceTemplateRepository.java
                EinvInvoiceTypeRepository.java
                EinvMerchantProviderConfigRepository.java
                EinvMerchantRepository.java
                EinvMerchantUserRepository.java
                EinvPaymentMethodRepository.java
                EinvRegistrationStatusRepository.java
                EinvServiceProviderRepository.java
                EinvSystemConfigRepository.java
                EinvTaxAuthorityResponseRepository.java
                EinvVatRateRepository.java
            dto/
              request/
                EinvInvoiceAdjustmentRequest.java
                EinvSubmitInvoiceDetailRequest.java
                EinvSubmitInvoiceRequest.java
              response/
                EinvAuditLogResponse.java
                EinvInvoiceAdjustmentResponse.java
                EinvInvoiceMetadataResponse.java
                EinvInvoiceSyncQueueResponse.java
              ApiResponse.java
              EinvApiCredentialDto.java
              EinvInvoiceItemDto.java
              EinvInvoicePayloadDto.java
              EinvInvoiceRegistrationRequest.java
              EinvInvoiceRegistrationResponse.java
              EinvInvoiceStatusDto.java
              EinvInvoiceTaxBreakdownDto.java
              EinvInvoiceTemplateRequest.java
              EinvInvoiceTemplateResponse.java
              EinvInvoiceTypeDto.java
              EinvMerchantProviderConfigRequest.java
              EinvMerchantProviderConfigResponse.java
              EinvMerchantRequest.java
              EinvMerchantResponse.java
              EinvMerchantUserRequest.java
              EinvMerchantUserResponse.java
              EinvoiceHubRequest.java
              EinvoiceHubResponse.java
              EinvPaymentMethodDto.java
              EinvRegistrationStatusDto.java
              EinvServiceProviderDto.java
              EinvSystemConfigDto.java
              EinvTaxAuthorityResponseDto.java
              EinvVatRateDto.java
              PaginationRequestDto.java
              PaginationResponseDto.java
            exception/
              AppException.java
              ErrorCode.java
              GlobalExceptionHandler.java
              InsufficientQuotaException.java
              InvalidDataException.java
              MerchantNotFoundException.java
            mapper/
              EinvHubMapper.java
            provider/
              bkav/
                BkavAdapter.java
                BkavApiMapper.java
              exception/
                ProviderException.java
              misa/
                MisaAdapter.java
                MisaApiMapper.java
              mobifone/
                constant/
                  MobifoneApiEndpoints.java
                  MobifoneInvoiceStatus.java
                mapper/
                  MobifoneDataMapper.java
                model/
                  MobifoneCancelInvoiceRequest.java
                  MobifoneInvoiceData.java
                  MobifoneInvoiceDetail.java
                  MobifoneInvoiceDetailWrapper.java
                  MobifoneInvoiceRequest.java
                  MobifoneInvoiceResponse.java
                  MobifoneLoginRequest.java
                  MobifoneLoginResponse.java
                MobifoneEInvoiceProvider.java
                MobifoneHttpClient.java
              model/
                InvoiceRequest.java
                InvoiceResponse.java
              viettel/
                ViettelAdapter.java
                ViettelApiMapper.java
              vnpt/
                VnptAdapter.java
                VnptApiMapper.java
              InvoiceProvider.java
              ProviderConfig.java
              ProviderFactory.java
            security/
              ApiKeyAuthenticationToken.java
              ApiKeyFilter.java
              JwtAuthenticationFilter.java
              JwtTokenProvider.java
              SecurityConfig.java
            service/
              EinvApiCredentialService.java
              EinvAuditLogService.java
              EinvInvoiceAdjustmentService.java
              EinvInvoiceItemService.java
              EinvInvoiceMetadataService.java
              EinvInvoicePayloadService.java
              EinvInvoiceRegistrationService.java
              EinvInvoiceStatusService.java
              EinvInvoiceSyncQueueService.java
              EinvInvoiceTaxBreakdownService.java
              EinvInvoiceTemplateService.java
              EinvInvoiceTypeService.java
              EinvMerchantProviderConfigService.java
              EinvMerchantService.java
              EinvMerchantUserService.java
              EinvPaymentMethodService.java
              EinvRegistrationStatusService.java
              EinvServiceProviderService.java
              EinvSystemConfigService.java
              EinvTaxAuthorityResponseService.java
              EinvVatRateService.java
            util/
              IdGenerator.java
            EinvoiceCoreApplication.java
    resources/
      db/
        migration/
          Initial_Schema_Ver01.sql
          Initial_Schema_Ver02.sql
          Initial_Schema_Ver03.sql
          Initial_Schema_Ver04.sql
          V1__Initial_Schema.sql
      application-dev.yaml
      application.yaml
  test/
    java/
      com/
        einvoicehub/
          core/
            EinvoiceCoreApplicationTests.java
terraform/
  main.tf
  outputs.tf
  variables.tf
.gitattributes
.gitignore
config.yaml
docker-compose.yml
Dockerfile
dockerfile-temp.txt
einvoicehub-full-source.txt
Jenkinsfile.txt
Makefile
pom.xml
purge-data.sh
repomix.config.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".mvn/wrapper/maven-wrapper.properties">
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.12/apache-maven-3.9.12-bin.zip
</file>

<file path="helm/einvoicehub/Chart.yaml">
# EInvoiceHub Helm Chart

apiVersion: v2
name: einvoicehub
description: A Helm chart for EInvoiceHub - Electronic Invoice Hub Service

# Application version
version: 1.0.0
appVersion: "1.0.0"

# Maintainers
maintainers:
  - name:  EInvoiceHub SoftZ
    email: softz@einvoicehub.io

# Dependencies
dependencies:
  - name: mysql
    version: "9.x.x"
    repository: "https://charts.bitnami.com/bitnami"
    condition: mysql.enabled
    alias: mysql

  - name: mongodb
    version: "13.x.x"
    repository: "https://charts.bitnami.com/bitnami"
    condition: mongodb.enabled
    alias: mongodb

  - name: redis
    version: "17.x.x"
    repository: "https://charts.bitnami.com/bitnami"
    condition: redis.enabled
    alias: redis

  - name: prometheus
    version: "45.x.x"
    repository: "https://prometheus-community.github.io/helm-charts"
    condition: prometheus.enabled
    alias: prometheus

  - name: grafana
    version: "6.x.x"
    repository: "https://grafana.github.io/helm-charts"
    condition: grafana.enabled
    alias: grafana

  - name: jaeger
    version: "0.x.x"
    repository: "https://jaegertracing.github.io/helm-charts"
    condition: jaeger.enabled
    alias: jaeger

# Keywords
keywords:
  - einvoicehub
  - electronic-invoice
  - invoicing
  - spring-boot
  - java
  - kubernetes

# Home page home: https://einvoicehub.io

# Icon icon: https://einvoicehub.io/logo.svg

# License
license: Apache-2.0

# Annotations
annotations:
  category: Application
  licenses: Apache-2.0
</file>

<file path="helm/einvoicehub/values.yaml">
# EInvoiceHub Helm Chart Values

# Global Settings

global:
  imageRegistry: registry.einvoicehub.io
  imagePullSecrets:
    - name: registry-credentials
  storageClass: standard
  timezone: Asia/Ho_Chi_Minh

# EInvoiceHub Application Configuration
replicaCount: 2

image:
  repository: einvoicehub/backend
  tag: 1.0.0
  pullPolicy: IfNotPresent

imagePullSecrets:
  - name: registry-credentials

nameOverride: ""
fullnameOverride: ""

# Service Account
serviceAccount:
  create: true
  name: einvoicehub
  annotations: {}

# Pod Security Context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000

# Container Security Context
securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

# Service Configuration
service:
  type: ClusterIP
  port: 80
  targetPort: 8080

# Ingress Configuration
ingress:
  enabled: true
  className: nginx
  hosts:
    - host: einvoice.local
      paths:
        - path: /api
          pathType: ImplementationSpecific
        - path: /actuator
          pathType: ImplementationSpecific
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"

# Resources Configuration
resources:
  requests:
    cpu: 250m
    memory: 256Mi
  limits:
    cpu: 1000m
    memory: 1Gi

# Autoscaling Configuration
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# Node Selection
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app: einvoicehub
          topologyKey: kubernetes.io/hostname

# Liveness Probe
livenessProbe:
  httpGet:
    path: /actuator/health/liveness
    port: http
  initialDelaySeconds: 60
  periodSeconds: 30
  timeoutSeconds: 10
  failureThreshold: 3
  successThreshold: 1

# Readiness Probe
readinessProbe:
  httpGet:
    path: /actuator/health/readiness
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

# Startup Probe
startupProbe:
  httpGet:
    path: /actuator/health
    port: http
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 30
  successThreshold: 1

# Application Environment Variables
env:
  # Application Settings
  APP_NAME: einvoicehub
  APP_VERSION: 1.0.0
  SPRING_PROFILES_ACTIVE: prod

  # Logging
  LOG_LEVEL: INFO
  LOG_FORMAT: json

  # JVM Options
  JAVA_OPTS: "-XX:+UseG1GC -XX:MaxGCPauseMillis=200 -Xms256m -Xmx512m"
  JAVA_THREADS_VIRTUAL_ENABLED: "true"

# Environment Variables from Secrets
envFrom:
  - configMapRef:
      name: einvoicehub-config
  - secretRef:
      name: einvoicehub-secrets
  - secretRef:
      name: einvoicehub-provider-secrets


# Database Configuration
mysql:
  enabled: true
  architecture: standalone
  auth:
    database: einvoicehub
    existingSecret: einvoicehub-mysql-secret
    secretKeys:
      rootPasswordKey: mysql-root-password
      userPasswordKey: mysql-password
  primary:
    persistence:
      enabled: true
      size: 10Gi
      storageClass: standard
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1Gi
    livenessProbe:
      enabled: true
      initialDelaySeconds: 120
    readinessProbe:
      enabled: true
      initialDelaySeconds: 30

mongodb:
  enabled: true
  architecture: standalone
  auth:
    database: einvoicehub
    existingSecret: einvoicehub-mongodb-secret
    secretKeys:
      mongodbPasswordKey: mongodb-password
      mongodbRootPasswordKey: mongodb-root-password
  persistence:
    enabled: true
    size: 10Gi
    storageClass: standard
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi

redis:
  enabled: true
  architecture: standalone
  auth:
    existingSecret: einvoicehub-redis-secret
    secretKeys:
      redisPasswordKey: redis-password
  master:
    persistence:
      enabled: false
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 256Mi

# Monitoring Configuration
prometheus:
  enabled: true
  prometheus:
    prometheusSpec:
      retention: 15d
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: standard
            resources:
              requests:
                storage: 20Gi
      ruleSelector:
        matchLabels:
          prometheus: einvoicehub
      serviceMonitorSelector:
        matchLabels:
          release: prometheus

grafana:
  enabled: true
  adminUser: admin
  adminPassword: einvoicehub_grafana_admin
  persistence:
    enabled: true
    storageClassName: standard
    size: 5Gi
  dashboardsProvider: true
  dashboardProviders:
    dashboardproviders.yaml:
      providers:
        - name: einvoicehub
          orgId: 1
          folder: EInvoiceHub
          type: file
          disableDeletion: false
          options:
            path: /var/lib/grafana/dashboards/einvoicehub
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          url: http://einvoicehub-prometheus:9090
          isDefault: true

jaeger:
  enabled: true
  collector:
    replicaCount: 1
    options:
      collector:
        zipkin:
          host-port: 9411
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
  query:
    replicaCount: 1
    options:
      query:
        base-path: /jaeger
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
  storage:
    type: memory

# Init Containers Configuration
initContainers:
  waitForMysql:
    enabled: true
    image: busybox:1.36
    resources:
      requests:
        cpu: 10m
        memory: 16Mi
      limits:
        cpu: 50m
        memory: 32Mi

  waitForMongodb:
    enabled: true
    image: busybox:1.36
    resources:
      requests:
        cpu: 10m
        memory: 16Mi
      limits:
        cpu: 50m
        memory: 32Mi

  waitForRedis:
    enabled: true
    image: busybox:1.36
    resources:
      requests:
        cpu: 10m
        memory: 16Mi
      limits:
        cpu: 50m
        memory: 32Mi

# Volume Configuration
volumes:
  logs:
    enabled: true
    type: emptyDir
  config:
    enabled: true
    type: configmap
    name: einvoicehub-config

# Topology Spread Configuration
topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: kubernetes.io/hostname
    whenUnsatisfiable: DoNotSchedule
    labelSelector:
      matchLabels:
        app: einvoicehub

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Network Policy
networkPolicy:
  enabled: true
  ingressRules:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - port: 8080
  egressRules:
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - port: 53
          protocol: UDP


# Rollout Strategy
rollingUpdate:
  maxSurge: 1
  maxUnavailable: 0


# Termination Grace Period
terminationGracePeriodSeconds: 30
</file>

<file path="kubernetes/ingress.yaml">
# EInvoiceHub Kubernetes Ingress Manifest

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: einvoicehub-ingress
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    version: v1
  annotations:
    # NGINX Ingress Controller Annotations
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"

    # Rate Limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "50"

    # CORS Configuration
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "Content-Type, Authorization, X-API-KEY, X-CLIENT-ID"

    # Security Headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;
      add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Custom Error Pages
    nginx.ingress.kubernetes.io/custom-http-errors: "404,500,503";

    # Rewrite Target for API
    nginx.ingress.kubernetes.io/rewrite-target: /$2

    # App Root
    nginx.ingress.kubernetes.io/app-root: "/actuator/health"

spec:
  ingressClassName: nginx
  rules:
    - host: einvoice.local
      http:
        paths:
          # API Routes
          - path: /api(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: einvoicehub
                port:
                  number: 80

          # Actuator Endpoints
          - path: /actuator(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: einvoicehub
                port:
                  number: 80

          # Prometheus Metrics (for scraping)
          - path: /metrics
            pathType: Exact
            backend:
              service:
                name: einvoicehub-prometheus
                port:
                  number: 9090

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: einvoicehub-monitoring-ingress
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: monitoring
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
spec:
  ingressClassName: nginx
  rules:
    - host: monitoring.einvoice.local
      http:
        paths:
          # Grafana Dashboard
          - path: /
            pathType: Prefix
            backend:
              service:
                name: einvoicehub-grafana
                port:
                  number: 3000

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: einvoicehub-tracing-ingress
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: tracing
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
spec:
  ingressClassName: nginx
  rules:
    - host: tracing.einvoice.local
      http:
        paths:
          # Jaeger UI
          - path: /
            pathType: Prefix
            backend:
              service:
                name: einvoicehub-jaeger
                port:
                  number: 16686

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: einvoicehub-network-policy
  namespace: einvoice-dev
  labels:
    app: einvoicehub
spec:
  podSelector:
    matchLabels:
      app: einvoicehub
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow traffic from Ingress Controller
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8080

    # Allow traffic from same namespace
    - from:
        - podSelector:
            matchLabels:
              app: einvoicehub
      ports:
        - protocol: TCP
          port: 8080

  egress:
    # Allow DNS resolution
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53

    # Allow traffic to MySQL
    - to:
        - podSelector:
            matchLabels:
              app: mysql
      ports:
        - protocol: TCP
          port: 3306

    # Allow traffic to MongoDB
    - to:
        - podSelector:
            matchLabels:
              app: mongodb
      ports:
        - protocol: TCP
          port: 27017

    # Allow traffic to Redis
    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379

    # Allow external API calls
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443

---
apiVersion: v1
kind: LimitRange
metadata:
  name: einvoicehub-limit-range
  namespace: einvoice-dev
spec:
  limits:
    - default:
        cpu: 1000m
        memory: 1Gi
      defaultRequest:
        cpu: 250m
        memory: 256Mi
      type: Container

---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: einvoicehub-resource-quota
  namespace: einvoice-dev
spec:
  hard:
    pods: "20"
    services: "10"
    secrets: "20"
    configmaps: "20"
    persistentvolumeclaims: "10"
    "limits.cpu": "8"
    "limits.memory": "8Gi"

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: einvoicehub
  namespace: einvoice-dev
  labels:
    app: einvoicehub
automountServiceAccountToken: false

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: einvoicehub-role
  namespace: einvoice-dev
  labels:
    app: einvoicehub
rules:
  - apiGroups: [""]
    resources: ["pods", "pods/log"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["pods/exec"]
    verbs: ["create"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: einvoicehub-rolebinding
  namespace: einvoice-dev
  labels:
    app: einvoicehub
subjects:
  - kind: ServiceAccount
    name: einvoicehub
    namespace: einvoice-dev
roleRef:
  kind: Role
  name: einvoicehub-role
  apiGroup: rbac.authorization.k8s.io
</file>

<file path="kubernetes/service.yaml">
# EInvoiceHub Kubernetes Service Manifest

---
apiVersion: v1
kind: Service
metadata:
  name: einvoicehub
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    version: v1
    tier: backend
  annotations:
    description: "EInvoiceHub Backend Service"
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: 8080
      protocol: TCP
    - name: metrics
      port: 9090
      targetPort: 9090
      protocol: TCP
  selector:
    app: einvoicehub
    version: v1

---
apiVersion: v1
kind: Service
metadata:
  name: einvoicehub-mysql
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: database
  annotations:
    description: "MySQL Database Service"
spec:
  type: ClusterIP
  ports:
    - port: 3306
      targetPort: 3306
      protocol: TCP
  selector:
    app: mysql
    tier: database

---
apiVersion: v1
kind: Service
metadata:
  name: einvoicehub-mongodb
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: database
  annotations:
    description: "MongoDB Database Service"
spec:
  type: ClusterIP
  ports:
    - port: 27017
      targetPort: 27017
      protocol: TCP
  selector:
    app: mongodb
    tier: database

---
apiVersion: v1
kind: Service
metadata:
  name: einvoicehub-redis
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: cache
  annotations:
    description: "Redis Cache Service"
spec:
  type: ClusterIP
  ports:
    - port: 6379
      targetPort: 6379
      protocol: TCP
  selector:
    app: redis
    tier: cache

---
apiVersion: v1
kind: Service
metadata:
  name: einvoicehub-prometheus
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: monitoring
  annotations:
    description: "Prometheus Metrics Service"
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 9090
      targetPort: 9090
      protocol: TCP
  selector:
    app: prometheus
    tier: monitoring

---
apiVersion: v1
kind: Service
metadata:
  name: einvoicehub-grafana
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: monitoring
  annotations:
    description: "Grafana Dashboard Service"
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 3000
      targetPort: 3000
      protocol: TCP
  selector:
    app: grafana
    tier: monitoring

---
apiVersion: v1
kind: Service
metadata:
  name: einvoicehub-jaeger
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: tracing
  annotations:
    description: "Jaeger Tracing Service"
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 16686
      targetPort: 16686
      protocol: TCP
    - name: otlp
      port: 4317
      targetPort: 4317
      protocol: TCP
    - name: otlp-http
      port: 4318
      targetPort: 4318
      protocol: TCP
  selector:
    app: jaeger
    tier: tracing

---
apiVersion: v1
kind: Endpoints
metadata:
  name: einvoicehub-headless
  namespace: einvoice-dev
  labels:
    app: einvoicehub
subsets:
  - addresses:
      - ip: 10.0.0.1
        targetRef:
          kind: Pod
          name: einvoicehub-0
          namespace: einvoice-dev
      - ip: 10.0.0.2
        targetRef:
          kind: Pod
          name: einvoicehub-1
          namespace: einvoice-dev
    ports:
      - port: 8080
        protocol: TCP
        name: http
</file>

<file path="monitoring/alertmanager/alertmanager.yml">
# EInvoiceHub Alertmanager Configuration

global:
  resolve_timeout: 5m
  slack_api_url: 'https://hooks.slack.com/services/xxx/yyy/zzz'

# Route defines a routing tree for processing alerts
route:
  group_by: ['alertname', 'severity']
  receiver: 'default-receiver'
  group_interval: 5m
  group_wait: 30s
  repeat_interval: 4h

  # Child routes for specific severities
  routes:
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 1h

    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 1m
      repeat_interval: 6h

    - match:
        alertname: 'HighErrorRate'
      receiver: 'urgent-alerts'
      continue: true

# Receivers define notification destinations
receivers:
  - name: 'default-receiver'
    slack_configs:
      - channel: '#alerts'
        send_resolved: true
        title: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ end }}'
        text: |
          {{ range .Alerts }}
          **{{ .Labels.severity | upper }}** - {{ .Labels.alertname }}
          Description: {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          Start: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        color:
          critical: '#ff0000'
          warning: '#ffa500'
          info: '#00ff00'

  - name: 'critical-alerts'
    slack_configs:
      - channel: '#critical-alerts'
        send_resolved: true
        title: 'üö® CRITICAL ALERT: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        text: |
          {{ range .Alerts }}
          **Severity:** {{ .Labels.severity | upper }}
          **Alert:** {{ .Labels.alertname }}
          **Description:** {{ .Annotations.description }}
          **Namespace:** {{ .Labels.namespace }}
          **Pod:** {{ .Labels.pod }}
          **Value:** {{ .Annotations.current_value }}
          **Started:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  - name: 'warning-alerts'
    slack_configs:
      - channel: '#warning-alerts'
        send_resolved: true
        title: '‚ö†Ô∏è WARNING: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        text: |
          {{ range .Alerts }}
          **Alert:** {{ .Labels.alertname }}
          **Description:** {{ .Annotations.description }}
          **Value:** {{ .Annotations.current_value }}
          {{ end }}

  - name: 'urgent-alerts'
    slack_configs:
      - channel: '#urgent-alerts'
        send_resolved: true
        mention_users: '@oncall'
        title: 'üî• URGENT: High Error Rate Detected'
        text: |
          **Alert:** High Error Rate Detected
          **Error Rate:** {{ range .Alerts }}{{ .Annotations.current_value }}{{ end }}
          **Endpoint:** {{ range .Alerts }}{{ .Annotations.endpoint }}{{ end }}
          **Action Required:** Immediate investigation needed!

  - name: 'pagerduty'
    pagerduty_configs:
      - service_key: 'pagerduty-service-key'
        severity: critical
        description: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        source: 'EInvoiceHub'
        custom_details:
          environment: '{{ env "ENVIRONMENT" }}'
          cluster: '{{ env "CLUSTER_NAME" }}'

  - name: 'email'
    email_configs:
      - to: 'alerts@einvoicehub.io'
        send_resolved: true
        html: |
          <html>
          <body>
          <h2>Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}</h2>
          <p><strong>Severity:</strong> {{ range .Alerts }}{{ .Labels.severity }}{{ end }}</p>
          <p><strong>Description:</strong> {{ range .Alerts }}{{ .Annotations.description }}{{ end }}</p>
          <p><strong>Value:</strong> {{ range .Alerts }}{{ .Annotations.current_value }}{{ end }}</p>
          <p><strong>Started:</strong> {{ range .Alerts }}{{ .StartsAt.Format "2006-01-02 15:04:05" }}{{ end }}</p>
          </body>
          </html>

# Inhibition rules
inhibit_rules:
  # Inhibit warning alerts if the same alert is already firing as critical
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'namespace', 'pod']

  # Inhibit info alerts if warning or critical for same alert
  - source_match:
      severity: 'warning'
    target_match:
      severity: 'info'
    equal: ['alertname', 'namespace']

# Time intervals for notification routing
time_intervals:
  - name: 'business-hours'
    time_intervals:
      - times:
          - start_time: '09:00'
            end_time: '17:00'
        weekdays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday']
        months: ['january', 'february', 'march', 'april', 'may', 'june',
                 'july', 'august', 'september', 'october', 'november', 'december']
        location: 'Asia/Ho_Chi_Minh'

  - name: 'off-hours'
    time_intervals:
      - times:
          - start_time: '17:00'
            end_time: '09:00'
        weekdays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday']
        months: ['january', 'february', 'march', 'april', 'may', 'june',
                 'july', 'august', 'september', 'october', 'november', 'december']
        location: 'Asia/Ho_Chi_Minh'
      - times:
          - start_time: '00:00'
            end_time: '23:59'
        weekdays: ['saturday', 'sunday']
        months: ['january', 'february', 'march', 'april', 'may', 'june',
                 'july', 'august', 'september', 'october', 'november', 'december']
        location: 'Asia/Ho_Chi_Minh'
</file>

<file path="monitoring/grafana/dashboards/einvoicehub/einvoicehub-overview.json">
{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "grafana",
          "uid": "-- Grafana --"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "description": "EInvoiceHub Application Overview Dashboard",
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": null,
  "links": [],
  "liveNow": false,
  "panels": [
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 1,
      "panels": [],
      "title": "Application Overview",
      "type": "row"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 0,
        "y": 1
      },
      "id": 2,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.2.0",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "up{job=\"einvoicehub\", namespace=\"einvoice-dev\"}",
          "refId": "A"
        }
      ],
      "title": "Application Status",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 1
              },
              {
                "color": "red",
                "value": 2
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 6,
        "y": 1
      },
      "id": 3,
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.2.0",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "count(kube_pod_container_status_ready{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"})",
          "refId": "A"
        }
      ],
      "title": "Running Pods",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 70
              },
              {
                "color": "red",
                "value": 90
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 12,
        "y": 1
      },
      "id": 4,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["mean"],
          "fields": "",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.2.0",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "sum(rate(container_cpu_usage_seconds_total{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}[5m])) / sum(kube_pod_container_resource_requests{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\", resource=\"cpu\"}) * 100",
          "refId": "A"
        }
      ],
      "title": "CPU Usage",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 70
              },
              {
                "color": "red",
                "value": 90
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 18,
        "y": 1
      },
      "id": 5,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["mean"],
          "fields": "",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.2.0",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "sum(container_memory_working_set_bytes{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}) / sum(kube_pod_container_resource_requests{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\", resource=\"memory\"}) * 100",
          "refId": "A"
        }
      ],
      "title": "Memory Usage",
      "type": "stat"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 5
      },
      "id": 6,
      "panels": [],
      "title": "HTTP Metrics",
      "type": "row"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "reqps"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 6
      },
      "id": 7,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "sum(rate(http_server_requests_seconds_count{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}[5m])) by (uri, method)",
          "legendFormat": "{{method}} {{uri}}",
          "refId": "A"
        }
      ],
      "title": "Request Rate by URI",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "s"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 6
      },
      "id": 8,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "histogram_quantile(0.50, sum(rate(http_server_requests_seconds_bucket{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}[5m])) by (le, uri))",
          "legendFormat": "p50 - {{uri}}",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "histogram_quantile(0.90, sum(rate(http_server_requests_seconds_bucket{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}[5m])) by (le, uri))",
          "legendFormat": "p90 - {{uri}}",
          "refId": "B"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "histogram_quantile(0.99, sum(rate(http_server_requests_seconds_bucket{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}[5m])) by (le, uri))",
          "legendFormat": "p99 - {{uri}}",
          "refId": "C"
        }
      ],
      "title": "Response Time Percentiles",
      "type": "timeseries"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 14
      },
      "id": 9,
      "panels": [],
      "title": "JVM Metrics",
      "type": "row"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "bytes"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 15
      },
      "id": 10,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "jvm_memory_used_bytes{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\", area=\"heap\"}",
          "legendFormat": "{{pod}} - {{area}}",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "jvm_memory_max_bytes{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\", area=\"heap\"}",
          "legendFormat": "{{pod}} - max {{area}}",
          "refId": "B"
        }
      ],
      "title": "JVM Heap Memory",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 15
      },
      "id": 11,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "jvm_threads_live{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}",
          "legendFormat": "{{pod}} - live threads",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "jvm_threads_daemon{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}",
          "legendFormat": "{{pod}} - daemon threads",
          "refId": "B"
        }
      ],
      "title": "JVM Threads",
      "type": "timeseries"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 23
      },
      "id": 12,
      "panels": [],
      "title": "Database & Cache Metrics",
      "type": "row"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "reqps"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 24
      },
      "id": 13,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "rate(hikaricp_connections_usage_seconds_count{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}[5m])",
          "legendFormat": "{{pod}} - connections",
          "refId": "A"
        }
      ],
      "title": "HikariCP Connection Usage",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "reqps"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 24
      },
      "id": 14,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "redis_keyspace_hits_total / (redis_keyspace_hits_total + redis_keyspace_misses_total)",
          "legendFormat": "hit ratio",
          "refId": "A"
        }
      ],
      "title": "Redis Cache Hit Ratio",
      "type": "timeseries"
    }
  ],
  "refresh": "30s",
  "schemaVersion": 38,
  "style": "dark",
  "tags": ["einvoicehub", "spring-boot", "java", "kubernetes"],
  "templating": {
    "list": []
  },
  "time": {
    "from": "now-1h",
    "to": "now"
  },
  "timepicker": {},
  "timezone": "browser",
  "title": "EInvoiceHub Overview",
  "uid": "einvoicehub-overview",
  "version": 1,
  "weekStart": ""
}
</file>

<file path="monitoring/grafana/provisioning/dashboards/default.yaml">
# EInvoiceHub Grafana Dashboards Configuration

apiVersion: 1

# Dashboard providers
providers:
  - name: 'einvoicehub'
    orgId: 1
    folder: 'EInvoiceHub'
    type: file
    disableDeletion: false
    updateIntervalSeconds: 10
    options:
      path: /var/lib/grafana/dashboards/einvoicehub
      foldersFromFilesStructure: true

  - name: 'kubernetes'
    orgId: 1
    folder: 'Kubernetes'
    type: file
    disableDeletion: false
    updateIntervalSeconds: 10
    options:
      path: /var/lib/grafana/dashboards/kubernetes
      foldersFromFilesStructure: true

  - name: 'infrastructure'
    orgId: 1
    folder: 'Infrastructure'
    type: file
    disableDeletion: false
    updateIntervalSeconds: 10
    options:
      path: /var/lib/grafana/dashboards/infrastructure
      foldersFromFilesStructure: true
</file>

<file path="monitoring/grafana/provisioning/datasources/prometheus.yaml">
# EInvoiceHub Grafana Datasource Configuration

apiVersion: 1

# Delete all datasources before inserting new ones
deleteDatasources:
  - name: Prometheus
    orgId: 1

# Insert/update datasources
datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    orgId: 1
    url: http://prometheus:9090
    isDefault: true
    version: 1
    editable: false
    jsonData:
      httpMethod: GET
      manageAlerts: true
      prometheusType: Prometheus
      prometheusVersion: 2.48.0
      enableLoGS: true
      loGSRequestToken: ''
      loGSStartTimeParam: start
      loGSEndTimeParam: end
      loGSTimeFormat: RFC3339Nano
      loGSTimeZone: UTC
      apiVersion: 1
      cachedResponseTTLMinutes: 60
    secureJsonData:
      httpHeaderValue1: ''
    cacheTimeout: 30

  - name: Loki
    type: loki
    access: proxy
    orgId: 1
    url: http://loki:3100
    isDefault: false
    version: 1
    editable: false
    jsonData:
      maxLines: 5000
      derivedFields:
        - matcherRegex: '(?:apikey|client)[=\\s]+([A-Za-z0-9_=-]+)'
          name: apikey
          datasourceUid:grafana
        - matcherRegex: 'trace_id=([A-Za-z0-9_=-]+)'
          name: trace_id
          datasourceUid: jaeger
    secureJsonData:
      httpHeaderValue1: ''

  - name: Jaeger
    type: jaeger
    access: proxy
    orgId: 1
    url: http://jaeger:16686
    isDefault: false
    version: 1
    editable: false
    jsonData:
      tracesToLogs:
        datasourceUid: Loki
      nodeGraph:
        enabled: true
    secureJsonData: {}

  - name: Elasticsearch
    type: elasticsearch
    access: proxy
    orgId: 1
    url: http://elasticsearch:9200
    isDefault: false
    version: 1
    editable: false
    jsonData:
      interval: Daily
      timeField: '@timestamp'
      logMessageField: message
      logLevelField: level
      database: 'einvoicehub-logs'
    secureJsonData:
      basicAuthPassword: ''

  - name: MySQL
    type: mysql
    access: proxy
    orgId: 1
    url: mysql:3306/einvoicehub
    isDefault: false
    version: 1
    editable: false
    jsonData:
      database: einvoicehub
      user: grafana
    secureJsonData:
      basicAuthPassword: ''
</file>

<file path="monitoring/prometheus/prometheus.yml">
# EInvoiceHub Prometheus Configuration
global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'einvoice-cluster'
    environment: 'dev'

# Alertmanager configuration (optional)
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  - '/etc/prometheus/rules/*.yml'

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
    # Prometheus Self-Monitoring

  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # =====================================================================
  # EInvoiceHub Application Metrics
  # =====================================================================
  - job_name: 'einvoicehub'
    kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
            - einvoice-dev
            - einvoice-staging
            - einvoice-prod
    relabel_configs:
      # Only scrape pods with the prometheus.io/scrape annotation
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true

      # Use the prometheus.io/path annotation to scrape a specific path
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)

      # Use the prometheus.io/port annotation to scrape a specific port
      - source_labels: [
          __address__,
          __meta_kubernetes_pod_annotation_prometheus_io_port
        ]
        action: replace
        regex: ([^:]+)(?::\\d+)?;(\\d+)
        replacement: $1:$2
        target_label: __address__

      # Add environment label
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: namespace

      # Add pod name label
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: pod

      # Add app name label
      - source_labels: [__meta_kubernetes_pod_label_app]
        action: replace
        target_label: app

  # =====================================================================
  # Kubernetes Node Exporter (infrastructure metrics)
  # =====================================================================
  - job_name: 'node-exporter'
    kubernetes_sd_configs:
      - role: node
    relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)

  # =====================================================================
  # MySQL Exporter (database metrics)
  # =====================================================================
  - job_name: 'mysql-exporter'
    static_configs:
      - targets: ['mysql-exporter:9104']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'mysql-primary'

  # =====================================================================
  # MongoDB Exporter (database metrics)
  # =====================================================================
  - job_name: 'mongodb-exporter'
    static_configs:
      - targets: ['mongodb-exporter:9216']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'mongodb-primary'

  # =====================================================================
  # Redis Exporter (cache metrics)
  # =====================================================================
  - job_name: 'redis-exporter'
    static_configs:
      - targets: ['redis-exporter:9121']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'redis-primary'

  # =====================================================================
  # Spring Boot Actuator Metrics (via HTTP)
  # =====================================================================
  - job_name: 'spring-actuator'
    metrics_path: '/actuator/prometheus'
    scrape_interval: 5s
    static_configs:
      - targets: ['einvoicehub:8080']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'einvoicehub-backend'

# Remote write configuration (for long-term storage)
remote_write:
  - url: 'https://prometheus-remote-write.einvoicehub.io/api/v1/write'
    basic_auth:
      username: 'prometheus'
      password_file: '/etc/prometheus/remote_write_password'
    queue_config:
      max_samples_per_send: 10000
      batch_send_deadline: 30s
      capacity: 20000
      max_shards: 30
    tls_config:
      insecure_skip_verify: false
</file>

<file path="sql/init/V1__Initial_Schema.sql">
-- =============================================================================
-- EInvoiceHub Database Schema - Core + Shell Strategy
-- Database: MariaDB | Character Set: utf8mb4_unicode_ci
-- =============================================================================

SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- =============================================================================
-- SECTION 1: CATALOG TABLES (Reference Data)
-- =============================================================================

-- 1. Invoice Types - Danh m·ª•c lo·∫°i h√≥a ƒë∆°n
CREATE TABLE `invoice_types` (
    `id`            BIGINT AUTO_INCREMENT PRIMARY KEY,
    `type_code`     VARCHAR(10)  NOT NULL UNIQUE COMMENT 'M√£ lo·∫°i h√≥a ƒë∆°n (VD: 01GTKT)',
    `type_name`     VARCHAR(100) NOT NULL COMMENT 'T√™n lo·∫°i h√≥a ƒë∆°n',
    `description`   TEXT NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
    `is_active`     BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    `display_order` INT          NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
    `created_at`    TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`    TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX `idx_type_code` (`type_code`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c lo·∫°i h√≥a ƒë∆°n';

-- Insert standard invoice types
INSERT INTO invoice_types (type_code, type_name, description, display_order) VALUES
('01GTKT', 'H√≥a ƒë∆°n gi√° tr·ªã gia tƒÉng', 'H√≥a ƒë∆°n GTGT m·∫´u 01GTKT theo Th√¥ng t∆∞ 78/2021/TT-BTC', 1),
('02GTTT', 'H√≥a ƒë∆°n b√°n h√†ng', 'H√≥a ƒë∆°n b√°n h√†ng m·∫´u 02GTTT theo Th√¥ng t∆∞ 78/2021/TT-BTC', 2),
('07KPTQ', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ ki·ªÉm so√°t', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ ki·ªÉm so√°t theo Ngh·ªã ƒë·ªãnh 123/2020/Nƒê-CP', 3),
('03KPTQ', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ kh√¥ng ki·ªÉm so√°t', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ kh√¥ng ki·ªÉm so√°t theo Ngh·ªã ƒë·ªãnh 123/2020/Nƒê-CP', 4);

-- 2. Invoice Statuses - Danh m·ª•c tr·∫°ng th√°i h√≥a ƒë∆°n
CREATE TABLE `invoice_statuses` (
    `id`          INT PRIMARY KEY COMMENT 'ID tr·∫°ng th√°i',
    `name`        VARCHAR(100) NOT NULL UNIQUE COMMENT 'T√™n tr·∫°ng th√°i',
    `description` VARCHAR(255) NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt tr·∫°ng th√°i',
    `note`        VARCHAR(500) NULL COMMENT 'Ghi ch√∫ nghi·ªáp v·ª•',
    `created_at`  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    `updated_at`  TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='B·∫£ng danh m·ª•c tr·∫°ng th√°i h√≥a ƒë∆°n';

INSERT INTO invoice_statuses (id, name, description, note) VALUES
(1, 'DRAFT', 'H√≥a ƒë∆°n nh√°p', 'M·ªõi t·∫°o, ch∆∞a k√Ω'),
(2, 'PENDING', 'ƒêang x·ª≠ l√Ω', 'ƒêang ch·ªù g·ª≠i sang Provider'),
(3, 'SIGNING', 'ƒêang k√Ω s·ªë', 'ƒêang th·ª±c hi·ªán k√Ω ƒëi·ªán t·ª≠'),
(4, 'SENT_TO_PROVIDER', 'ƒê√£ g·ª≠i Provider', 'ƒê√£ g·ª≠i nh∆∞ng ch∆∞a c√≥ k·∫øt qu·∫£ t·ª´ CQT'),
(5, 'SUCCESS', 'Th√†nh c√¥ng', 'H√≥a ƒë∆°n ƒë√£ h·ª£p l·ªá v√† c√≥ m√£ CQT'),
(6, 'FAILED', 'Th·∫•t b·∫°i', 'L·ªói t·ª´ Provider ho·∫∑c CQT'),
(7, 'CANCELLED', 'ƒê√£ h·ªßy', 'H√≥a ƒë∆°n ƒë√£ b·ªã h·ªßy b·ªè'),
(8, 'REPLACED', 'ƒê√£ thay th·∫ø', 'ƒê√£ c√≥ h√≥a ƒë∆°n kh√°c thay th·∫ø cho h√≥a ƒë∆°n n√†y');

-- 3. Payment Methods - Danh m·ª•c ph∆∞∆°ng th·ª©c thanh to√°n
CREATE TABLE `payment_methods` (
    `id`            BIGINT AUTO_INCREMENT PRIMARY KEY,
    `method_code`   VARCHAR(10)  NOT NULL UNIQUE COMMENT 'M√£ ph∆∞∆°ng th·ª©c: TM, CK...',
    `method_name`   VARCHAR(100) NOT NULL COMMENT 'T√™n ph∆∞∆°ng th·ª©c',
    `description`   TEXT NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
    `is_active`     BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    `display_order` INT          NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
    `created_at`    TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`    TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX `idx_method_code` (`method_code`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c ph∆∞∆°ng th·ª©c thanh to√°n';

INSERT INTO payment_methods (method_code, method_name, description, display_order) VALUES
('TM', 'Ti·ªÅn m·∫∑t', 'Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t tr·ª±c ti·∫øp', 1),
('CK', 'Chuy·ªÉn kho·∫£n', 'Thanh to√°n qua chuy·ªÉn kho·∫£n ng√¢n h√†ng', 2),
('TM/CK', 'Ti·ªÅn m·∫∑t/Chuy·ªÉn kho·∫£n', 'K·∫øt h·ª£p c·∫£ hai h√¨nh th·ª©c', 3),
('POS', 'Th·∫ª POS', 'Thanh to√°n qua m√°y POS', 4),
('V√ç ƒêI·ªÜN T·ª¨', 'V√≠ ƒëi·ªán t·ª≠', 'Thanh to√°n qua v√≠ ƒëi·ªán t·ª≠', 5),
('TH·∫∫', 'Th·∫ª ng√¢n h√†ng', 'Thanh to√°n b·∫±ng th·∫ª t√≠n d·ª•ng/ghi n·ª£', 6);

-- 4. VAT Rates - Danh m·ª•c thu·∫ø su·∫•t GTGT
CREATE TABLE `vat_rates` (
    `id`            BIGINT AUTO_INCREMENT PRIMARY KEY,
    `rate_code`     VARCHAR(10)   NOT NULL UNIQUE COMMENT 'M√£ thu·∫ø su·∫•t: 0, 5, 8, 10, KCT',
    `rate_percent`  DECIMAL(5, 2) NOT NULL COMMENT 'Gi√° tr·ªã ph·∫ßn trƒÉm thu·∫ø su·∫•t',
    `rate_name`     VARCHAR(100)  NOT NULL COMMENT 'T√™n thu·∫ø su·∫•t',
    `description`   TEXT NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
    `is_active`     BOOLEAN       NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    `display_order` INT           NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
    `created_at`    TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`    TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    CONSTRAINT `chk_vat_rate_percent` CHECK (rate_percent >= 0),
    INDEX `idx_rate_code` (`rate_code`),
    INDEX `idx_rate_percent` (`rate_percent`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c thu·∫ø su·∫•t GTGT';

INSERT INTO vat_rates (rate_code, rate_percent, rate_name, description, display_order) VALUES
('0', 0.00, 'Thu·∫ø su·∫•t 0%', '√Åp d·ª•ng cho h√†ng h√≥a, d·ªãch v·ª• xu·∫•t kh·∫©u', 1),
('5', 5.00, 'Thu·∫ø su·∫•t 5%', '√Åp d·ª•ng cho h√†ng h√≥a, d·ªãch v·ª• thi·∫øt y·∫øu', 2),
('8', 8.00, 'Thu·∫ø su·∫•t 8%', 'Gi·∫£m thu·∫ø theo Ngh·ªã quy·∫øt 43/2022/QH15', 3),
('10', 10.00, 'Thu·∫ø su·∫•t 10%', 'Thu·∫ø su·∫•t th√¥ng th∆∞·ªùng GTGT', 4),
('KCT', 0.00, 'Kh√¥ng ch·ªãu thu·∫ø', 'H√†ng h√≥a, d·ªãch v·ª• kh√¥ng ch·ªãu thu·∫ø GTGT', 5);

-- 5. Service Providers - Danh m·ª•c nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠
CREATE TABLE `service_providers` (
    `id`                  BIGINT AUTO_INCREMENT PRIMARY KEY,
    `provider_code`       VARCHAR(20)  NOT NULL UNIQUE COMMENT 'M√£ ƒë·ªãnh danh (VNPT, VIETTEL...)',
    `provider_name`       VARCHAR(100) NOT NULL COMMENT 'T√™n nh√† cung c·∫•p',
    `official_api_url`    VARCHAR(500) NOT NULL COMMENT 'URL t√≠ch h·ª£p',
    `lookup_url`          VARCHAR(500) NULL COMMENT 'URL tra c·ª©u h√≥a ƒë∆°n',
    `documentation_url`   VARCHAR(500) NULL COMMENT 'Link t√†i li·ªáu API',
    `support_email`       VARCHAR(255) NULL,
    `support_phone`       VARCHAR(20) NULL,
    `is_active`           BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'Ki·ªÉm tra c√≤n ho·∫°t ƒë·ªông kh√¥ng',
    `is_default`          BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh h·ªá th·ªëng',
    `display_order`       INT          NOT NULL DEFAULT 0,
    `extra_config_schema` JSON NULL COMMENT 'C·∫•u h√¨nh ƒë·∫∑c th√π c·ªßa t·ª´ng h√£ng',
    `created_at`          TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`          TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX `idx_provider_code` (`provider_code`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠';

INSERT INTO service_providers (provider_code, provider_name, official_api_url, lookup_url, is_active, display_order) VALUES
('VNPT', 'VNPT e-Invoice', 'https://api-itg.vnpt.vn', 'https://tracuu.vnpt.vn', TRUE, 1),
('VIETTEL', 'SInvoice Viettel', 'https://sinvoice.viettel.vn/api', 'https://sinvoice.viettel.vn/tracuu', TRUE, 2),
('BKAV', 'BKAV eInvoice', 'https://einvoice.bkav.com/api', 'https://tracuuhdon.bkav.com', TRUE, 3),
('MOBIFONE', 'MobiFone Invoice', 'https://thongke.mobifoneinvoice.vn/api/v1', 'https://mobifoneinvoice.vn/tracuu', TRUE, 4);

-- =============================================================================
-- SECTION 2: CORE JPA TABLES (Business Logic Foundation)
-- Hierarchical Flow: Merchants -> ProviderConfigs -> Templates -> Invoices -> Items
-- =============================================================================

-- =============================================================================
-- CORE TABLE 1: Merchants (Root Entity)
-- Core: Identity & Tax Information
-- Shell: SaaS Subscription Fields
-- =============================================================================
CREATE TABLE `merchants` (
    -- Core Fields (Required for JPA compatibility)
    `id`                   BIGINT AUTO_INCREMENT PRIMARY KEY,
    `tax_code`             VARCHAR(20)  NOT NULL UNIQUE COMMENT 'M√£ s·ªë thu·∫ø - ƒë·ªãnh danh doanh nghi·ªáp',
    `company_name`         VARCHAR(255) NOT NULL COMMENT 'T√™n c√¥ng ty ƒë·∫ßy ƒë·ªß',
    `short_name`           VARCHAR(100) COMMENT 'T√™n vi·∫øt t·∫Øt',
    `address`              TEXT COMMENT 'ƒê·ªãa ch·ªâ tr·ª• s·ªü ch√≠nh',
    `district`             VARCHAR(100) COMMENT 'Qu·∫≠n/Huy·ªán',
    `city`                 VARCHAR(100) COMMENT 'T·ªânh/Th√†nh ph·ªë',
    `email`                VARCHAR(255) COMMENT 'Email li√™n h·ªá',
    `phone`                VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    `representative_name`  VARCHAR(100) COMMENT 'T√™n ng∆∞·ªùi ƒë·∫°i di·ªán',
    `representative_title` VARCHAR(100) COMMENT 'Ch·ª©c danh ng∆∞·ªùi ƒë·∫°i di·ªán',
    `tax_authority_code`   VARCHAR(10) NULL COMMENT 'M√£ c∆° quan thu·∫ø qu·∫£n l√Ω (VD: 01GD, 02HT...)',

    -- Enterprise Shell Fields (SaaS Extensions - NULLABLE for JPA compatibility)
    `subscription_plan`    ENUM('TRIAL', 'BASIC', 'PREMIUM') NOT NULL DEFAULT 'TRIAL' COMMENT 'G√≥i d·ªãch v·ª•: TRIAL, BASIC, PREMIUM',
    `invoice_quota`        INT          NOT NULL DEFAULT 100 COMMENT 'H·∫°n m·ª©c h√≥a ƒë∆°n/th√°ng',
    `invoice_used`         INT          NOT NULL DEFAULT 0 COMMENT 'H√≥a ƒë∆°n ƒë√£ s·ª≠ d·ª•ng trong th√°ng',
    `is_using_hsm`         BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'S·ª≠ d·ª•ng HSM hay USB Token ƒë·ªÉ k√Ω ƒëi·ªán t·ª≠',
    `is_deleted`           BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'C·ªù x√≥a m·ªÅm',
    `deleted_at`           TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
    `created_at`           TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`           TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    INDEX `idx_tax_code` (`tax_code`),
    INDEX `idx_subscription_plan` (`subscription_plan`),
    INDEX `idx_created_at` (`created_at`),
    INDEX `idx_tax_authority` (`tax_authority_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω doanh nghi·ªáp s·ª≠ d·ª•ng d·ªãch v·ª• h√≥a ƒë∆°n ƒëi·ªán t·ª≠';

-- =============================================================================
-- CORE TABLE 2: Merchant User (Child of Merchant)
-- Users who belong to and are managed by a Merchant
-- =============================================================================
CREATE TABLE `merchant_user` (
    `id`                    BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`           BIGINT       NOT NULL COMMENT 'Li√™n k·∫øt v·ªõi doanh nghi·ªáp',
    `username`              VARCHAR(50)  NOT NULL UNIQUE COMMENT 'T√™n ƒëƒÉng nh·∫≠p',
    `email`                 VARCHAR(255) NOT NULL UNIQUE COMMENT 'Email ng∆∞·ªùi d√πng',
    `password_hash`         VARCHAR(255) NOT NULL COMMENT 'M·∫≠t kh·∫©u ƒë√£ m√£ h√≥a BCrypt',
    `full_name`             VARCHAR(100) COMMENT 'H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß',
    `phone`                 VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    `avatar_url`            VARCHAR(500) COMMENT 'URL ·∫£nh ƒë·∫°i di·ªán',
    `role`                  ENUM('ADMIN', 'MANAGER', 'STAFF', 'VIEWER') NOT NULL DEFAULT 'STAFF' COMMENT 'Vai tr√≤ trong h·ªá th·ªëng',
    `is_active`             BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'K√≠ch ho·∫°t t√†i kho·∫£n',
    `is_primary`            BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'T√†i kho·∫£n ch√≠nh c·ªßa doanh nghi·ªáp',
    `last_login_at`         TIMESTAMP NULL COMMENT 'ƒêƒÉng nh·∫≠p l·∫ßn cu·ªëi',
    `failed_login_attempts` INT          NOT NULL DEFAULT 0 COMMENT 'S·ªë l·∫ßn ƒëƒÉng nh·∫≠p sai',
    `locked_until`          TIMESTAMP NULL COMMENT 'Kh√≥a t√†i kho·∫£n ƒë·∫øn th·ªùi ƒëi·ªÉm',
    `created_at`            TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`            TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT `fk_merchant_user_merchant` FOREIGN KEY (`merchant_id`)
        REFERENCES `merchants` (`id`) ON DELETE CASCADE,

    INDEX `idx_merchant_id` (`merchant_id`),
    INDEX `idx_username` (`username`),
    INDEX `idx_email` (`email`),
    INDEX `idx_role` (`role`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='T√†i kho·∫£n ng∆∞·ªùi d√πng thu·ªôc Merchant';

-- =============================================================================
-- CORE TABLE 3: Merchant Provider Configs (Child of Merchant)
-- Configuration for external invoice service providers
-- Core: Connection credentials
-- Shell: Test mode and encrypted storage
-- =============================================================================
CREATE TABLE `merchant_provider_configs` (
    -- Core Fields
    `id`                         BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`                BIGINT       NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu',
    `provider_id`                BIGINT       NOT NULL COMMENT 'Nh√† cung c·∫•p ƒë∆∞·ª£c ch·ªçn',

    -- Connection Credentials
    `partner_id`                 VARCHAR(50) NULL COMMENT 'ID ƒë·ªëi t√°c (partner_id)',
    `partner_token`              VARCHAR(500) NULL COMMENT 'Token truy c·∫≠p (partner_token)',
    `tax_code`                   VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø k·∫øt n·ªëi',
    `integration_url`            VARCHAR(500) NULL COMMENT 'URL t√≠ch h·ª£p ri√™ng',
    `integrated_date`            TIMESTAMP NULL COMMENT 'Ng√†y t√≠ch h·ª£p',

    -- Service Account
    `username_service`           VARCHAR(100) NOT NULL COMMENT 'T√†i kho·∫£n API',
    `password_service_encrypted` VARCHAR(500) NOT NULL COMMENT 'M·∫≠t kh·∫©u API (ƒë√£ m√£ h√≥a)',

    -- Digital Certificate
    `certificate_serial`         VARCHAR(100) NULL,
    `certificate_data`          TEXT NULL,
    `certificate_chain`         LONGTEXT NULL,
    `certificate_expired_at`    TIMESTAMP NULL,

    -- Extra Configuration
    `extra_config`               JSON NULL COMMENT 'C·∫•u h√¨nh b·ªï sung (pattern, serial...)',

    -- Enterprise Shell Fields (NULLABLE for JPA compatibility)
    `is_test_mode`               BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'Ch·∫ø ƒë·ªô ki·ªÉm th·ª≠ (Sandbox)',
    `encrypted_password_storage` VARCHAR(500) NULL COMMENT 'L∆∞u tr·ªØ m·∫≠t kh·∫©u ƒë√£ m√£ h√≥a (AES256)',

    -- Status & Timestamps
    `is_active`                  BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'Tr·∫°ng th√°i k√≠ch ho·∫°t',
    `is_default`                 BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'C·∫•u h√¨nh m·∫∑c ƒë·ªãnh',
    `last_sync_at`               TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm ƒë·ªìng b·ªô cu·ªëi',
    `created_at`                 TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`                 TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT `fk_mpc_merchant` FOREIGN KEY (`merchant_id`) REFERENCES `merchants` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_mpc_provider` FOREIGN KEY (`provider_id`) REFERENCES `service_providers` (`id`) ON DELETE RESTRICT,
    CONSTRAINT `uq_merchant_provider` UNIQUE (`merchant_id`, `provider_id`),

    INDEX `idx_merchant_provider` (`merchant_id`, `provider_id`),
    INDEX `idx_is_active` (`is_active`),
    INDEX `idx_is_test_mode` (`is_test_mode`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='B·∫£ng c·∫•u h√¨nh chi ti·∫øt NCC cho t·ª´ng Merchant';

-- =============================================================================
-- CORE TABLE 4: Invoice Template (Child of Merchant)
-- Template configuration with serial number management
-- =============================================================================
CREATE TABLE `invoice_template` (
    `id`                      BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`             BIGINT      NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu',
    `invoice_type_id`         BIGINT NULL COMMENT 'Lo·∫°i h√≥a ƒë∆°n',
    `invoice_registration_id` BIGINT NULL COMMENT 'Li√™n k·∫øt ƒëƒÉng k√Ω d·∫£i s·ªë',
    `provider_id`             VARCHAR(36) NULL COMMENT 'M√£ NCC',
    `provider_serial_id`      VARCHAR(50) NULL COMMENT 'ID d·∫£i s·ªë ph√≠a NCC',

    -- Template Configuration
    `template_code`           VARCHAR(20) NOT NULL COMMENT 'M·∫´u h√≥a ƒë∆°n: 01GTKT0/001',
    `symbol_code`            VARCHAR(10) NOT NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n: AA/22E',

    -- Serial Number Management
    `current_number`          INT         NOT NULL DEFAULT 0 COMMENT 'S·ªë hi·ªán t·∫°i',
    `min_number`              INT         NOT NULL DEFAULT 1,
    `max_number`              INT         NOT NULL DEFAULT 99999999,
    `start_date`              TIMESTAMP NULL COMMENT 'Ng√†y b·∫Øt ƒë·∫ßu hi·ªáu l·ª±c',

    -- Status
    `status_id`               INT NULL COMMENT 'ID tr·∫°ng th√°i',
    `is_active`               BOOLEAN     NOT NULL DEFAULT TRUE,

    -- Timestamps
    `created_at`              TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`              TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT `fk_template_merchant` FOREIGN KEY (`merchant_id`) REFERENCES `merchants` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_template_type` FOREIGN KEY (`invoice_type_id`) REFERENCES `invoice_types` (`id`) ON DELETE SET NULL,
    CONSTRAINT `uq_merchant_template_symbol` UNIQUE (`merchant_id`, `template_code`, `symbol_code`),

    INDEX `idx_template_codes` (`template_code`, `symbol_code`),
    INDEX `idx_is_active` (`is_active`),
    INDEX `idx_merchant_id` (`merchant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω m·∫´u s·ªë v√† k√Ω hi·ªáu h√≥a ƒë∆°n';

-- =============================================================================
-- CORE TABLE 5: Invoice Registrations (Supporting Core Table)
-- Registration of invoice number ranges with tax authorities
-- =============================================================================
CREATE TABLE `invoice_registrations` (
    `id`                  BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`         BIGINT       NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu d·∫£i s·ªë',
    `registration_number` VARCHAR(50)  NULL COMMENT 'S·ªë quy·∫øt ƒë·ªãnh/ph√™ duy·ªát c·ªßa CQT',
    `from_number`         BIGINT       NOT NULL COMMENT 'S·ªë b·∫Øt ƒë·∫ßu c·ªßa d·∫£i',
    `to_number`           BIGINT       NOT NULL COMMENT 'S·ªë k·∫øt th√∫c c·ªßa d·∫£i',
    `quantity`            BIGINT       NOT NULL COMMENT 'S·ªë l∆∞·ª£ng h√≥a ƒë∆°n trong d·∫£i',
    `current_number`      BIGINT       NOT NULL DEFAULT 0 COMMENT 'S·ªë hi·ªán t·∫°i ƒë√£ s·ª≠ d·ª•ng',
    `effective_date`      DATE         NOT NULL COMMENT 'Ng√†y c√≥ hi·ªáu l·ª±c',
    `expiration_date`    DATE         NULL COMMENT 'Ng√†y h·∫øt h·∫°n',
    `status_id`           INT          NOT NULL DEFAULT 1 COMMENT 'Tr·∫°ng th√°i ƒëƒÉng k√Ω',
    `issued_by`           VARCHAR(255) NULL COMMENT 'Ng∆∞·ªùi ph√™ duy·ªát/C∆° quan Thu·∫ø',
    `note`                TEXT         NULL COMMENT 'Ghi ch√∫ b·ªï sung',
    `created_at`          TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`          TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT `fk_registration_merchant` FOREIGN KEY (`merchant_id`) REFERENCES `merchants` (`id`) ON DELETE CASCADE,
    CONSTRAINT `chk_registration_range` CHECK (`from_number` <= `to_number`),

    INDEX `idx_registration_merchant` (`merchant_id`),
    INDEX `idx_registration_status` (`status_id`),
    INDEX `idx_registration_effective` (`effective_date`),
    INDEX `idx_registration_number` (`registration_number`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω ƒëƒÉng k√Ω d·∫£i s·ªë h√≥a ƒë∆°n v·ªõi C∆° quan Thu·∫ø';

-- Registration Statuses
CREATE TABLE `registration_statuses` (
    `id`          INT PRIMARY KEY COMMENT 'ID tr·∫°ng th√°i',
    `name`        VARCHAR(100) NOT NULL UNIQUE COMMENT 'T√™n tr·∫°ng th√°i',
    `description` VARCHAR(255) NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
    `note`        VARCHAR(500) NULL COMMENT 'Ghi ch√∫ nghi·ªáp v·ª•',
    `created_at`  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    `updated_at`  TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c tr·∫°ng th√°i ƒëƒÉng k√Ω d·∫£i s·ªë';

INSERT INTO registration_statuses (id, name, description, note) VALUES
(1, 'ACTIVE', 'ƒêang hi·ªáu l·ª±c', 'D·∫£i s·ªë ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng'),
(2, 'EXHAUSTED', 'ƒê√£ d√πng h·∫øt', 'To√†n b·ªô s·ªë trong d·∫£i ƒë√£ ph√°t h√†nh'),
(3, 'EXPIRED', 'ƒê√£ h·∫øt h·∫°n', 'D·∫£i s·ªë ƒë√£ qu√° ng√†y hi·ªáu l·ª±c'),
(4, 'CANCELLED', 'ƒê√£ h·ªßy', 'D·∫£i s·ªë b·ªã h·ªßy b·ªè');

-- =============================================================================
-- CORE TABLE 6: Invoice Metadata (Central Transaction Table)
-- Flat Metadata Strategy: Buyer information copied directly (no Customer FK)
-- Core: Invoice business data
-- Shell: Enterprise fields (lookup_code, cqt_code, provider_transaction_id)
-- =============================================================================
CREATE TABLE `invoice_metadata` (
    -- Primary Key
    `id`                        BIGINT AUTO_INCREMENT PRIMARY KEY,

    -- Foreign Keys (Hierarchical references)
    `merchant_id`               BIGINT         NOT NULL COMMENT 'Li√™n k·∫øt doanh nghi·ªáp s·ªü h·ªØu',
    `provider_id`               BIGINT NULL COMMENT 'Li√™n k·∫øt nh√† cung c·∫•p d·ªãch v·ª•',
    `provider_config_id`        BIGINT NULL COMMENT 'C·∫•u h√¨nh Provider ƒë∆∞·ª£c s·ª≠ d·ª•ng',
    `invoice_template_id`       BIGINT NULL COMMENT 'M·∫´u h√≥a ƒë∆°n ƒë∆∞·ª£c s·ª≠ d·ª•ng',
    `payment_method`            VARCHAR(10) NULL COMMENT 'M√£ ph∆∞∆°ng th·ª©c thanh to√°n',

    -- Identifiers & References
    `client_request_id`         VARCHAR(100) NULL COMMENT 'ID request t·ª´ h·ªá th·ªëng Merchant',
    `partner_invoice_id`        VARCHAR(50) NULL COMMENT 'ID ƒë·ªãnh danh t·ª´ ƒë·ªëi t√°c',

    -- Invoice Information
    `invoice_number`            VARCHAR(20) NULL COMMENT 'S·ªë h√≥a ƒë∆°n t·ª´ Provider tr·∫£ v·ªÅ',
    `symbol_code`               VARCHAR(10) NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n',
    `template_code`             VARCHAR(20) NULL COMMENT 'M·∫´u h√≥a ƒë∆°n',
    `invoice_type_code`         VARCHAR(10) NULL COMMENT 'M√£ lo·∫°i h√≥a ƒë∆°n',
    `is_summary_invoice`        BOOLEAN        NOT NULL DEFAULT FALSE COMMENT 'H√≥a ƒë∆°n t·ªïng h·ª£p',
    `issuance_method`           ENUM('STANDARD', 'POS') NOT NULL DEFAULT 'STANDARD' COMMENT 'Ph∆∞∆°ng th·ª©c ph√°t h√†nh',

    -- Enterprise Shell Fields (NULLABLE for JPA compatibility)
    `lookup_code`               VARCHAR(50) NULL COMMENT 'M√£ tra c·ª©u h√≥a ƒë∆°n (Unique)',
    `cqt_code`                  VARCHAR(50) NULL COMMENT 'M√£ C∆° quan Thu·∫ø c·∫•p',
    `provider_transaction_id`   VARCHAR(100) NULL COMMENT 'ID giao d·ªãch t·ª´ Provider',

    -- Seller Information (Flattened from Merchant)
    `seller_name`               VARCHAR(255) NULL COMMENT 'T√™n ng∆∞·ªùi b√°n',
    `seller_tax_code`           VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi b√°n',
    `seller_address`            TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi b√°n',

    -- Buyer Information (FLATTENED - No Customer FK to prevent circular dependencies)
    `buyer_name`                VARCHAR(255) NULL COMMENT 'T√™n ƒë∆°n v·ªã ng∆∞·ªùi mua',
    `buyer_tax_code`            VARCHAR(20) NULL COMMENT 'MST ng∆∞·ªùi mua',
    `buyer_id_no`               VARCHAR(20) NULL COMMENT 'S·ªë CMND/CCCD/H·ªô chi·∫øu',
    `buyer_full_name`           VARCHAR(200) NULL COMMENT 'H·ªç t√™n ng∆∞·ªùi mua h√†ng',
    `buyer_email`               VARCHAR(255) NULL COMMENT 'Email ng∆∞·ªùi mua',
    `buyer_phone`               VARCHAR(20) NULL COMMENT 'ƒêi·ªán tho·∫°i ng∆∞·ªùi mua',
    `buyer_mobile`              VARCHAR(50) NULL COMMENT 'Di ƒë·ªông ng∆∞·ªùi mua',
    `buyer_address`             TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi mua',
    `buyer_bank_account`        VARCHAR(50) NULL COMMENT 'T√†i kho·∫£n ng√¢n h√†ng',
    `buyer_bank_name`           VARCHAR(200) NULL COMMENT 'T√™n ng√¢n h√†ng',
    `buyer_budget_code`        VARCHAR(20) NULL COMMENT 'M√£ ch∆∞∆°ng/NSNN',

    -- Amounts & Currency (DECIMAL(18,2) for precision)
    `subtotal_amount`           DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø',
    `tax_amount`                DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ø',
    `discount_amount`           DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng chi·∫øt kh·∫•u',
    `total_amount`              DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thanh to√°n',
    `gross_amount`              DECIMAL(18, 2)          DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn th√¥',
    `net_amount`                DECIMAL(18, 2)          DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ßn',
    `currency_code`             VARCHAR(3)     NOT NULL DEFAULT 'VND' COMMENT 'ƒê∆°n v·ªã ti·ªÅn t·ªá',
    `exchange_rate`            DECIMAL(10, 4) NOT NULL DEFAULT 1.0000 COMMENT 'T·ª∑ gi√°',

    -- Adjustment / Original Invoice Info
    `org_invoice_id`            VARCHAR(36) NULL COMMENT 'ID h√≥a ƒë∆°n g·ªëc',
    `org_invoice_form`          VARCHAR(50) NULL COMMENT 'M·∫´u h√≥a ƒë∆°n g·ªëc',
    `org_invoice_series`        VARCHAR(50) NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n g·ªëc',
    `org_invoice_no`            VARCHAR(50) NULL COMMENT 'S·ªë h√≥a ƒë∆°n g·ªëc',
    `org_invoice_date`          TIMESTAMP NULL COMMENT 'Ng√†y h√≥a ƒë∆°n g·ªëc',
    `org_invoice_reason`        VARCHAR(500) NULL COMMENT 'L√Ω do ƒëi·ªÅu ch·ªânh',
    `adjustment_type`           ENUM('ADJUSTMENT', 'REPLACEMENT', 'CANCELLATION') NULL COMMENT 'Lo·∫°i ƒëi·ªÅu ch·ªânh',
    `cancellation_reason`       VARCHAR(500) NULL COMMENT 'L√Ω do h·ªßy',
    `replaced_by_invoice_id`    BIGINT NULL COMMENT 'H√≥a ƒë∆°n thay th·∫ø',

    -- Status & Dates
    `status_id`                 INT            NOT NULL DEFAULT 1 COMMENT 'Tr·∫°ng th√°i h√≥a ƒë∆°n',
    `status_message`            TEXT NULL COMMENT 'Th√¥ng b√°o l·ªói ho·∫∑c tr·∫°ng th√°i chi ti·∫øt',
    `issue_date`                DATE NULL COMMENT 'Ng√†y l·∫≠p h√≥a ƒë∆°n',
    `accounting_date`           DATE NULL COMMENT 'Ng√†y h·∫°ch to√°n',
    `due_date`                  DATE NULL COMMENT 'Ng√†y h·∫°n thanh to√°n',

    -- Timestamps for Audit Trail
    `signed_at`                 TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm k√Ω s·ªë',
    `sent_to_provider_at`       TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i NCC',
    `received_from_provider_at` TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
    `delivered_to_buyer_at`     TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i kh√°ch h√†ng',

    -- Provider Feedback
    `provider_error_code`       VARCHAR(50) NULL COMMENT 'M√£ l·ªói t·ª´ Provider',
    `provider_error_message`    TEXT NULL COMMENT 'Chi ti·∫øt l·ªói t·ª´ Provider',

    -- Soft Delete
    `is_deleted`                BOOLEAN        NOT NULL DEFAULT FALSE,
    `deleted_at`                TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
    `deleted_by`                BIGINT NULL COMMENT 'Ng∆∞·ªùi x√≥a',

    -- System Audit Timestamps
    `created_at`                TIMESTAMP      NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`                TIMESTAMP      NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t cu·ªëi',

    -- Constraints
    CONSTRAINT `fk_invoice_merchant` FOREIGN KEY (`merchant_id`) REFERENCES `merchants` (`id`),
    CONSTRAINT `fk_invoice_status` FOREIGN KEY (`status_id`) REFERENCES `invoice_statuses` (`id`),
    CONSTRAINT `fk_invoice_provider` FOREIGN KEY (`provider_id`) REFERENCES `service_providers` (`id`),
    CONSTRAINT `fk_invoice_template` FOREIGN KEY (`invoice_template_id`) REFERENCES `invoice_template` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_invoice_config` FOREIGN KEY (`provider_config_id`) REFERENCES `merchant_provider_configs` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_invoice_payment_method` FOREIGN KEY (`payment_method`) REFERENCES `payment_methods` (`method_code`) ON DELETE SET NULL,
    CONSTRAINT `fk_invoice_replaced_by` FOREIGN KEY (`replaced_by_invoice_id`) REFERENCES `invoice_metadata` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_invoice_deleted_by` FOREIGN KEY (`deleted_by`) REFERENCES `merchant_user` (`id`) ON DELETE SET NULL,
    CONSTRAINT `uq_invoice_lookup_code` UNIQUE (`lookup_code`),

    -- Indexes for Search Optimization
    INDEX `idx_merchant_status` (`merchant_id`, `status_id`),
    INDEX `idx_invoice_number` (`invoice_number`),
    INDEX `idx_client_request_id` (`client_request_id`),
    INDEX `idx_partner_invoice` (`partner_invoice_id`),
    INDEX `idx_buyer_tax_code` (`buyer_tax_code`),
    INDEX `idx_issue_date` (`issue_date`),
    INDEX `idx_created_at` (`created_at`),
    INDEX `idx_cqt_code` (`cqt_code`),
    INDEX `idx_template_code` (`template_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='B·∫£ng l∆∞u tr·ªØ Metadata h√≥a ƒë∆°n t·ªïng h·ª£p';

-- =============================================================================
-- CORE TABLE 7: Invoice Items (Child of Invoice)
-- Line items belonging to a specific invoice
-- =============================================================================
CREATE TABLE `invoice_items` (
    `id`              BIGINT AUTO_INCREMENT PRIMARY KEY,
    `invoice_id`      BIGINT         NOT NULL COMMENT 'ID h√≥a ƒë∆°n cha',
    `line_number`     INT            NOT NULL DEFAULT 1 COMMENT 'S·ªë th·ª© t·ª± d√≤ng',

    -- Product Information
    `is_free`         BOOLEAN                 DEFAULT FALSE COMMENT 'H√†ng khuy·∫øn m√£i/bi·∫øu t·∫∑ng',
    `product_type_id` INT NULL COMMENT 'Lo·∫°i h√†ng h√≥a/d·ªãch v·ª•',
    `product_code`    VARCHAR(100) NULL COMMENT 'M√£ s·∫£n ph·∫©m',
    `product_name`    VARCHAR(500)   NOT NULL COMMENT 'T√™n h√†ng h√≥a/d·ªãch v·ª•',
    `unit_name`       VARCHAR(50) NULL COMMENT 'ƒê∆°n v·ªã t√≠nh',

    -- Quantity & Unit Price
    `quantity`        DECIMAL(18, 4) NOT NULL DEFAULT 0 COMMENT 'S·ªë l∆∞·ª£ng',
    `unit_price`      DECIMAL(18, 4) NOT NULL DEFAULT 0 COMMENT 'ƒê∆°n gi√° ch∆∞a thu·∫ø',

    -- Amount Calculations
    `gross_amount`    DECIMAL(18, 2)          DEFAULT 0 COMMENT 'Th√†nh ti·ªÅn th√¥',
    `discount_rate`   DECIMAL(5, 2)           DEFAULT 0 COMMENT 'T·ª∑ l·ªá chi·∫øt kh·∫•u (%)',
    `discount_amount` DECIMAL(18, 2)          DEFAULT 0 COMMENT 'Ti·ªÅn chi·∫øt kh·∫•u',
    `net_price`       DECIMAL(18, 4)          DEFAULT 0 COMMENT 'Gi√° sau chi·∫øt kh·∫•u ch∆∞a thu·∫ø',
    `net_amount`      DECIMAL(18, 2)          DEFAULT 0 COMMENT 'Th√†nh ti·ªÅn sau chi·∫øt kh·∫•u tr∆∞·ªõc thu·∫ø',

    -- Tax Information
    `tax_type_id`     VARCHAR(36) NULL COMMENT 'Ph√¢n lo·∫°i thu·∫ø',
    `tax_rate`        DECIMAL(5, 2)           DEFAULT 0 COMMENT 'M·ª©c thu·∫ø su·∫•t (%)',
    `tax_amount`      DECIMAL(18, 2)          DEFAULT 0 COMMENT 'Ti·ªÅn thu·∫ø GTGT',

    -- Total
    `total_amount`    DECIMAL(18, 2) NOT NULL DEFAULT 0 COMMENT 'T·ªïng thanh to√°n d√≤ng',

    -- Description
    `description`     TEXT NULL COMMENT 'M√¥ t·∫£ s·∫£n ph·∫©m',
    `notes`          VARCHAR(500) NULL COMMENT 'Ghi ch√∫ th√™m',

    `created_at`      TIMESTAMP      NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT `fk_item_invoice` FOREIGN KEY (`invoice_id`) REFERENCES `invoice_metadata` (`id`) ON DELETE CASCADE,
    INDEX `idx_item_invoice` (`invoice_id`),
    INDEX `idx_product_code` (`product_code`),
    INDEX `idx_line_number` (`line_number`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Chi ti·∫øt t·ª´ng d√≤ng h√†ng h√≥a/d·ªãch v·ª• trong h√≥a ƒë∆°n';

-- =============================================================================
-- CORE TABLE 8: Invoice Tax Breakdowns (Supporting Core Table)
-- Summary of tax amounts by rate for each invoice
-- =============================================================================
CREATE TABLE `invoice_tax_breakdowns` (
    `id`               BIGINT AUTO_INCREMENT PRIMARY KEY,
    `invoice_id`       BIGINT         NOT NULL COMMENT 'ID h√≥a ƒë∆°n cha',
    `vat_rate_id`      BIGINT         NOT NULL COMMENT 'Li√™n k·∫øt v·ªõi danh m·ª•c thu·∫ø su·∫•t',
    `vat_rate_code`    VARCHAR(10)    NOT NULL COMMENT 'M√£ thu·∫ø su·∫•t',
    `vat_rate_percent` DECIMAL(5, 2)  NOT NULL COMMENT 'Gi√° tr·ªã ph·∫ßn trƒÉm thu·∫ø su·∫•t',

    `subtotal_amount`  DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø',
    `discount_amount`  DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn chi·∫øt kh·∫•u',
    `taxable_amount`   DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn ch·ªãu thu·∫ø',
    `tax_amount`       DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ø GTGT',
    `total_amount`     DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn bao g·ªìm thu·∫ø',

    `created_at`       TIMESTAMP      NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',

    CONSTRAINT `fk_tax_breakdown_invoice` FOREIGN KEY (`invoice_id`)
        REFERENCES `invoice_metadata` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_tax_breakdown_vat_rate` FOREIGN KEY (`vat_rate_id`)
        REFERENCES `vat_rates` (`id`) ON DELETE RESTRICT,
    CONSTRAINT `uq_invoice_vat_rate` UNIQUE (`invoice_id`, `vat_rate_id`),

    INDEX `idx_breakdown_invoice` (`invoice_id`),
    INDEX `idx_breakdown_vat_rate` (`vat_rate_id`),
    INDEX `idx_vat_rate_code` (`vat_rate_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Ph√¢n r√£ thu·∫ø su·∫•t tr√™n t·ª´ng h√≥a ƒë∆°n';

-- =============================================================================
-- CORE TABLE 9: Invoice Adjustments (Supporting Core Table)
-- Track adjustment, replacement, and cancellation requests
-- =============================================================================
CREATE TABLE `invoice_adjustments` (
    `id`                   BIGINT AUTO_INCREMENT PRIMARY KEY,
    `original_invoice_id` BIGINT    NOT NULL COMMENT 'H√≥a ƒë∆°n g·ªëc b·ªã ƒëi·ªÅu ch·ªânh/thay th·∫ø/h·ªßy',
    `adjustment_type`      ENUM('ADJUSTMENT', 'REPLACEMENT', 'CANCELLATION') NOT NULL COMMENT 'Lo·∫°i ƒëi·ªÅu ch·ªânh',

    `agreement_number`     VARCHAR(50) NULL COMMENT 'S·ªë bi√™n b·∫£n th·ªèa thu·∫≠n',
    `agreement_date`       DATE NULL COMMENT 'Ng√†y l·∫≠p bi√™n b·∫£n',
    `agreement_content`    TEXT NULL COMMENT 'N·ªôi dung bi√™n b·∫£n th·ªèa thu·∫≠n',
    `signers`              TEXT NULL COMMENT 'Ng∆∞·ªùi k√Ω bi√™n b·∫£n (JSON array)',

    `reason_code`          VARCHAR(50) NULL COMMENT 'M√£ l√Ω do',
    `reason_description`   VARCHAR(500) NULL COMMENT 'M√¥ t·∫£ l√Ω do chi ti·∫øt',

    `old_subtotal_amount`  DECIMAL(18, 2) NULL COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø c≈©',
    `old_tax_amount`       DECIMAL(18, 2) NULL COMMENT 'Ti·ªÅn thu·∫ø c≈©',
    `old_total_amount`     DECIMAL(18, 2) NULL COMMENT 'T·ªïng ti·ªÅn c≈©',
    `new_subtotal_amount`  DECIMAL(18, 2) NULL COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø m·ªõi',
    `new_tax_amount`       DECIMAL(18, 2) NULL COMMENT 'Ti·ªÅn thu·∫ø m·ªõi',
    `new_total_amount`     DECIMAL(18, 2) NULL COMMENT 'T·ªïng ti·ªÅn m·ªõi',
    `difference_amount`    DECIMAL(18, 2) NULL COMMENT 'Ch√™nh l·ªách ti·ªÅn',

    `status`               ENUM('PENDING', 'APPROVED', 'REJECTED', 'CANCELLED') NOT NULL DEFAULT 'PENDING' COMMENT 'Tr·∫°ng th√°i duy·ªát',
    `approved_at`          TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm duy·ªát',

    `submitted_to_cqt`     BOOLEAN   NOT NULL DEFAULT FALSE COMMENT 'ƒê√£ g·ª≠i C∆° quan Thu·∫ø',
    `cqt_response_code`    VARCHAR(50) NULL COMMENT 'M√£ ph·∫£n h·ªìi t·ª´ CQT',
    `cqt_response_message` TEXT NULL COMMENT 'N·ªôi dung ph·∫£n h·ªìi t·ª´ CQT',

    `created_at`           TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`           TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT `fk_adjustment_original_invoice` FOREIGN KEY (`original_invoice_id`)
        REFERENCES `invoice_metadata` (`id`) ON DELETE RESTRICT,

    INDEX `idx_adjustment_original` (`original_invoice_id`),
    INDEX `idx_adjustment_type` (`adjustment_type`),
    INDEX `idx_adjustment_status` (`status`),
    INDEX `idx_agreement_date` (`agreement_date`),
    INDEX `idx_submitted_cqt` (`submitted_to_cqt`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Th√¥ng tin bi√™n b·∫£n th·ªèa thu·∫≠n cho h√≥a ƒë∆°n ƒëi·ªÅu ch·ªânh/thay th·∫ø/h·ªßy';

-- =============================================================================
-- SECTION 3: ENTERPRISE SHELL MODULES (Management & Auxiliary Tables)
-- Strategy: Use INDEX instead of FK for performance and decoupling
-- =============================================================================

-- =============================================================================
-- MANAGEMENT TABLE 1: Invoice Payloads (One-to-One with Metadata)
-- Stores raw XML/JSON data for audit and reprint purposes
-- =============================================================================
CREATE TABLE `invoice_payloads` (
    `invoice_id`   BIGINT    NOT NULL PRIMARY KEY COMMENT 'ID h√≥a ƒë∆°n - kh√≥a ch√≠nh v√† kh√≥a ngo·∫°i',
    `raw_data`     JSON NULL COMMENT 'D·ªØ li·ªáu th√¥ request/response d·∫°ng JSON',
    `xml_content`  LONGTEXT NULL COMMENT 'N·ªôi dung XML g·ªëc c·ªßa h√≥a ƒë∆°n',
    `json_content` LONGTEXT NULL COMMENT 'N·ªôi dung JSON ƒë·∫ßy ƒë·ªß c·ªßa h√≥a ƒë∆°n',
    `signed_xml`   LONGTEXT NULL COMMENT 'XML ƒë√£ k√Ω ƒëi·ªán t·ª≠',
    `pdf_data`     LONGTEXT NULL COMMENT 'D·ªØ li·ªáu PDF ƒë√£ t·∫°o (base64)',
    `extra_data`   JSON NULL COMMENT 'D·ªØ li·ªáu b·ªï sung kh√°c',
    `created_at`   TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm l∆∞u',
    `updated_at`   TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT `fk_invoice_payload_invoice` FOREIGN KEY (`invoice_id`)
        REFERENCES `invoice_metadata` (`id`) ON DELETE CASCADE,

    INDEX `idx_payload_created` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u tr·ªØ n·ªôi dung XML/JSON g·ªëc h√≥a ƒë∆°n';

-- =============================================================================
-- MANAGEMENT TABLE 2: API Credentials
-- For external systems accessing the API (uses INDEX instead of FK)
-- =============================================================================
CREATE TABLE `api_credentials` (
    `id`                        BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`               BIGINT       NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu credential',
    `client_id`                 VARCHAR(50)  NOT NULL UNIQUE COMMENT 'ID c√¥ng khai c·ªßa ·ª©ng d·ª•ng',
    `api_key_hash`              VARCHAR(255) NOT NULL COMMENT 'Hash c·ªßa API Key (SHA-256)',
    `api_key_prefix`            VARCHAR(8)   NOT NULL COMMENT '8 k√Ω t·ª± ƒë·∫ßu c·ªßa API Key',
    `scopes`                    TEXT         NOT NULL COMMENT 'Quy·ªÅn h·∫°n - JSON array',
    `ip_whitelist`              TEXT NULL COMMENT 'Danh s√°ch IP ƒë∆∞·ª£c ph√©p - JSON array',
    `rate_limit_per_hour`       INT          NOT NULL DEFAULT 1000 COMMENT 'Gi·ªõi h·∫°n request/gi·ªù',
    `rate_limit_per_day`        INT          NOT NULL DEFAULT 10000 COMMENT 'Gi·ªõi h·∫°n request/ng√†y',
    `request_count_hour`        INT          NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong gi·ªù',
    `request_count_day`         INT          NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong ng√†y',
    `request_count_resetted_at` TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm reset counter',
    `expired_at`                TIMESTAMP NULL COMMENT 'Ng√†y h·∫øt h·∫°n - NULL kh√¥ng gi·ªõi h·∫°n',
    `last_used_at`              TIMESTAMP NULL COMMENT 'L·∫ßn s·ª≠ d·ª•ng cu·ªëi',
    `is_active`                 BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    `created_at`                TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`                TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    -- Using INDEX instead of FK for performance (decoupled from merchant table)
    INDEX `idx_merchant_id` (`merchant_id`),
    INDEX `idx_client_id` (`client_id`),
    INDEX `idx_api_key_hash` (`api_key_hash`),
    INDEX `idx_expired_at` (`expired_at`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Credentials cho API access';

-- =============================================================================
-- MANAGEMENT TABLE 3: Audit Logs
-- System-wide immutable log (No FKs to prevent locking/blocking)
-- =============================================================================
CREATE TABLE `audit_logs` (
    `id`              BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`     BIGINT NULL COMMENT 'Doanh nghi·ªáp li√™n quan',
    `user_id`         BIGINT NULL COMMENT 'Ng∆∞·ªùi th·ª±c hi·ªán',
    `entity_type`     VARCHAR(50) NOT NULL COMMENT 'Lo·∫°i entity: Invoice, Merchant, Config...',
    `entity_id`       BIGINT      NOT NULL COMMENT 'ID c·ªßa entity',
    `action`          VARCHAR(50) NOT NULL COMMENT 'H√†nh ƒë·ªông: CREATE, UPDATE, DELETE, STATUS_CHANGE',
    `old_value`       JSON NULL COMMENT 'Gi√° tr·ªã c≈©',
    `new_value`       JSON NULL COMMENT 'Gi√° tr·ªã m·ªõi',
    `ip_address`      VARCHAR(45) NULL COMMENT 'IP th·ª±c hi·ªán',
    `user_agent`      VARCHAR(500) NULL COMMENT 'User Agent c·ªßa browser/client',
    `request_id`      VARCHAR(100) NULL COMMENT 'ID request t·ª´ frontend',
    `created_at`      TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm x·∫£y ra',

    -- Using INDEX instead of FK for high-performance logging
    INDEX `idx_merchant_id` (`merchant_id`),
    INDEX `idx_user_id` (`user_id`),
    INDEX `idx_entity` (`entity_type`, `entity_id`),
    INDEX `idx_action` (`action`),
    INDEX `idx_created_at` (`created_at`),
    INDEX `idx_merchant_entity` (`merchant_id`, `entity_type`, `entity_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Nh·∫≠t k√Ω thay ƒë·ªïi h·ªá th·ªëng';

-- =============================================================================
-- MANAGEMENT TABLE 4: Invoice Sync Queue
-- Background job queue for processing invoices
-- =============================================================================
CREATE TABLE `invoice_sync_queue` (
    `id`                      BIGINT AUTO_INCREMENT PRIMARY KEY,
    `invoice_id`              BIGINT    NOT NULL COMMENT 'ID h√≥a ƒë∆°n c·∫ßn ƒë·ªìng b·ªô',
    `sync_type`               ENUM('SEND_TO_PROVIDER', 'SEND_TO_CQT', 'CANCEL_INVOICE', 'REPLACE_INVOICE') NOT NULL COMMENT 'Lo·∫°i thao t√°c ƒë·ªìng b·ªô',
    `priority`                INT       NOT NULL DEFAULT 5 COMMENT 'ƒê·ªô ∆∞u ti√™n (1=cao nh·∫•t, 10=th·∫•p nh·∫•t)',

    `status`                  ENUM('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED', 'RETRYING') NOT NULL DEFAULT 'PENDING' COMMENT 'Tr·∫°ng th√°i x·ª≠ l√Ω',
    `attempt_count`           INT       NOT NULL DEFAULT 0 COMMENT 'S·ªë l·∫ßn th·ª≠',
    `max_attempts`            INT       NOT NULL DEFAULT 3 COMMENT 'S·ªë l·∫ßn th·ª≠ t·ªëi ƒëa',
    `last_attempt_at`         TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm th·ª≠ l·∫ßn cu·ªëi',
    `next_retry_at`           TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm th·ª≠ ti·∫øp theo',

    `request_data`            JSON NULL COMMENT 'D·ªØ li·ªáu request g·ª≠i ƒëi',
    `response_data`           JSON NULL COMMENT 'D·ªØ li·ªáu response nh·∫≠n v·ªÅ',
    `error_code`              VARCHAR(50) NULL COMMENT 'M√£ l·ªói',
    `error_message`           TEXT NULL COMMENT 'Chi ti·∫øt l·ªói',

    `processed_by`            VARCHAR(100) NULL COMMENT 'Worker x·ª≠ l√Ω',
    `processing_started_at`   TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu x·ª≠ l√Ω',
    `processing_completed_at` TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm ho√†n th√†nh',

    `created_at`              TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`              TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT `fk_sync_queue_invoice` FOREIGN KEY (`invoice_id`)
        REFERENCES `invoice_metadata` (`id`) ON DELETE CASCADE,

    CONSTRAINT `chk_sync_attempt_count` CHECK (`attempt_count` <= `max_attempts`),

    INDEX `idx_sync_queue_status` (`status`),
    INDEX `idx_sync_queue_invoice` (`invoice_id`),
    INDEX `idx_sync_queue_merchant` (`invoice_id`),
    INDEX `idx_sync_queue_priority` (`priority`),
    INDEX `idx_sync_queue_next_retry` (`next_retry_at`),
    INDEX `idx_sync_queue_created` (`created_at`),
    INDEX `idx_sync_queue_status_priority` (`status`, `priority`, `next_retry_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='H√†ng ƒë·ª£i g·ª≠i h√≥a ƒë∆°n sang Provider/CQT';

-- =============================================================================
-- MANAGEMENT TABLE 5: Tax Authority Responses
-- Store responses from tax authorities
-- =============================================================================
CREATE TABLE `tax_authority_responses` (
    `id`              BIGINT AUTO_INCREMENT PRIMARY KEY,
    `invoice_id`      BIGINT      NOT NULL COMMENT 'H√≥a ƒë∆°n li√™n quan',
    `cqt_code`        VARCHAR(50) NOT NULL COMMENT 'M√£ C∆° quan Thu·∫ø',
    `status_from_cqt` VARCHAR(50) NOT NULL COMMENT 'Tr·∫°ng th√°i t·ª´ C∆° quan Thu·∫ø',
    `processing_code` VARCHAR(100) NULL COMMENT 'M√£ x·ª≠ l√Ω t·ª´ C∆° quan Thu·∫ø',
    `signature_data`  TEXT NULL COMMENT 'D·ªØ li·ªáu ch·ªØ k√Ω t·ª´ C∆° quan Thu·∫ø',
    `raw_response`    JSON NULL COMMENT 'Response th√¥ t·ª´ C∆° quan Thu·∫ø',
    `error_code`      VARCHAR(50) NULL COMMENT 'M√£ l·ªói t·ª´ C∆° quan Thu·∫ø',
    `error_message`   TEXT NULL COMMENT 'Th√¥ng b√°o l·ªói t·ª´ C∆° quan Thu·∫ø',
    `received_at`    TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
    `processed_at`   TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x·ª≠ l√Ω ho√†n t·∫•t',
    `created_at`     TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o b·∫£n ghi',

    CONSTRAINT `fk_tax_response_invoice` FOREIGN KEY (`invoice_id`)
        REFERENCES `invoice_metadata` (`id`) ON DELETE CASCADE,

    INDEX `idx_tax_response_invoice` (`invoice_id`),
    INDEX `idx_cqt_code` (`cqt_code`),
    INDEX `idx_status_cqt` (`status_from_cqt`),
    INDEX `idx_received_at` (`received_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u v·∫øt t∆∞∆°ng t√°c v·ªõi C∆° quan Thu·∫ø';

-- =============================================================================
-- MANAGEMENT TABLE 6: System Configuration
-- Key-value configuration storage (No FKs)
-- =============================================================================
CREATE TABLE `system_config` (
    `id`           BIGINT AUTO_INCREMENT PRIMARY KEY,
    `config_key`   VARCHAR(100) NOT NULL UNIQUE COMMENT 'Kh√≥a c·∫•u h√¨nh',
    `config_value` TEXT         NOT NULL COMMENT 'Gi√° tr·ªã c·∫•u h√¨nh',
    `config_type`  VARCHAR(20)  NOT NULL DEFAULT 'STRING' COMMENT 'Lo·∫°i: STRING, NUMBER, BOOLEAN, JSON',
    `description` VARCHAR(500) NULL COMMENT 'M√¥ t·∫£ c·∫•u h√¨nh',
    `is_encrypted` BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'C√≥ c·∫ßn m√£ h√≥a kh√¥ng',
    `is_editable`  BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'C√≥ th·ªÉ ch·ªânh s·ª≠a kh√¥ng',
    `updated_by`   BIGINT NULL COMMENT 'Ng∆∞·ªùi c·∫≠p nh·∫≠t cu·ªëi',
    `updated_at`   TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    INDEX `idx_config_key` (`config_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='C·∫•u h√¨nh h·ªá th·ªëng';

-- Insert default system configurations
INSERT INTO system_config (config_key, config_value, config_type, description) VALUES
('SYSTEM_NAME', 'EInvoiceHub', 'STRING', 'T√™n hi·ªÉn th·ªã c·ªßa h·ªá th·ªëng'),
('INVOICE_EXPIRY_DAYS', '30', 'NUMBER', 'S·ªë ng√†y h√≥a ƒë∆°n c√≥ hi·ªáu l·ª±c sau khi ph√°t h√†nh'),
('MAX_RETRY_ATTEMPTS', '3', 'NUMBER', 'S·ªë l·∫ßn th·ª≠ l·∫°i khi g·ªçi Provider th·∫•t b·∫°i'),
('RETRY_DELAY_MS', '1000', 'NUMBER', 'Th·ªùi gian ch·ªù gi·ªØa c√°c l·∫ßn th·ª≠ l·∫°i (milliseconds)'),
('SESSION_TIMEOUT_MINUTES', '60', 'NUMBER', 'Th·ªùi gian timeout c·ªßa session'),
('PASSWORD_MIN_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i t·ªëi thi·ªÉu c·ªßa m·∫≠t kh·∫©u'),
('API_KEY_PREFIX_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i prefix hi·ªÉn th·ªã c·ªßa API Key'),
('DEFAULT_CURRENCY', 'VND', 'STRING', 'ƒê∆°n v·ªã ti·ªÅn t·ªá m·∫∑c ƒë·ªãnh'),
('TAX_DEFAULT_RATE', '10.00', 'NUMBER', 'Thu·∫ø su·∫•t m·∫∑c ƒë·ªãnh (%)'),
('BACKGROUND_JOB_ENABLED', 'true', 'BOOLEAN', 'K√≠ch ho·∫°t x·ª≠ l√Ω background jobs'),
('INVOICE_LOOKUP_CODE_LENGTH', '6', 'NUMBER', 'ƒê·ªô d√†i m√£ tra c·ª©u h√≥a ƒë∆°n ng·∫´u nhi√™n');

-- =============================================================================
-- SECTION 4: SYSTEM VIEWS
-- =============================================================================

-- View for user authorization
CREATE OR REPLACE VIEW `vw_sys_user_author` AS
SELECT
    CAST(id AS CHAR) AS id,
    username         AS name,
    full_name        AS full_name
FROM merchant_user
WHERE is_active = TRUE;

SET FOREIGN_KEY_CHECKS = 1;

-- =============================================================================
-- SCHEMA SUMMARY
-- =============================================================================
/*
Architecture Overview:
======================

CORE JPA TABLES (9 tables - Hierarchical Flow):
-------------------------------------------------
1. merchants              -> Root entity (contains Shell fields: subscription_plan, invoice_quota, updated_at)
2. merchant_user         -> Child of merchants
3. merchant_provider_configs -> Child of merchants (contains Shell fields: is_test_mode, encrypted_password_storage)
4. invoice_template      -> Child of merchants
5. invoice_registrations -> Child of merchants
6. invoice_metadata      -> Central transaction (contains Shell fields: lookup_code, cqt_code, provider_transaction_id)
7. invoice_items         -> Child of invoice_metadata
8. invoice_tax_breakdowns -> Child of invoice_metadata
9. invoice_adjustments   -> Related to invoice_metadata

ENTERPRISE SHELL MODULES (Management Tables):
----------------------------------------------
- invoice_payloads       -> One-to-One with invoice_metadata
- api_credentials        -> INDEX-based (decoupled)
- audit_logs             -> INDEX-based (high-performance)
- invoice_sync_queue     -> Background processing
- tax_authority_responses -> External system integration
- system_config          -> Key-value configuration

Data Flow (Hierarchical - No Reverse Dependencies):
---------------------------------------------------
Merchants -> ProviderConfigs -> Templates -> Invoices -> InvoiceItems
     |
     +-> Users
     +-> Registrations

Key Design Decisions:
---------------------
1. Flat Metadata Strategy: Buyer information stored directly in invoice_metadata
   to prevent circular dependencies when generating historical reports.

2. Hard FK for Core Relations: Ensures data integrity for business-critical
   relationships (Invoice->Items, Invoice->Template, etc.)

3. INDEX for Auxiliary Tables: audit_logs and system_config use INDEX instead
   of FK to maintain high performance and prevent locking issues.

4. NULLABLE Shell Fields: All new enterprise fields are NULLABLE to maintain
   JPA compatibility with existing Spring Boot save() methods.

5. DECIMAL(18,2): Used for all monetary values to ensure precision.

6. utf8mb4_unicode_ci: Full Unicode support including emojis.
*/
</file>

<file path="src/main/java/com/einvoicehub/core/config/SecurityConfig.java">
package com.einvoicehub.core.config;

import com.einvoicehub.core.security.ApiKeyFilter;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfig {

    private final ApiKeyFilter apiKeyFilter;

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
                .csrf(AbstractHttpConfigurer::disable)
                .sessionManagement(session ->
                        session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers(
                                "/api/actuator/**",
                                "/api/v3/api-docs/**",
                                "/api/swagger-ui/**",
                                "/api/health/**"
                        ).permitAll()
                        .anyRequest().authenticated())
                .addFilterBefore(apiKeyFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/config/VirtualThreadConfig.java">
package com.einvoicehub.core.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

@Configuration
public class VirtualThreadConfig {

    /* Use Java 21 Virtual Threads to handle high-concurrency Provider API calls efficiently */
    @Bean
    public ExecutorService virtualThreadExecutorService() {
        return Executors.newVirtualThreadPerTaskExecutor();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/config/WebClientConfig.java">
package com.einvoicehub.core.config;

import io.netty.channel.ChannelOption;
import io.netty.handler.timeout.ReadTimeoutHandler;
import io.netty.handler.timeout.WriteTimeoutHandler;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.http.client.reactive.ReactorClientHttpConnector;
import org.springframework.web.reactive.function.client.ExchangeStrategies;
import org.springframework.web.reactive.function.client.WebClient;
import reactor.netty.http.client.HttpClient;

import java.time.Duration;
import java.util.concurrent.TimeUnit;

@Configuration
public class WebClientConfig {

    @Value("${app.provider.timeout-ms:30000}")
    private int defaultTimeout;

    @Value("${provider.vnpt.timeout-ms:30000}")
    private int vnptTimeout;

    @Value("${provider.viettel.timeout-ms:30000}")
    private int viettelTimeout;

    @Value("${provider.bkav.timeout-ms:30000}")
    private int bkavTimeout;

    @Value("${provider.misa.timeout-ms:30000}")
    private int misaTimeout;

    @Bean
    @Primary
    public WebClient.Builder webClientBuilder() {
        /* Increase memory buffer to 16MB for large XML/PDF invoice processing */
        ExchangeStrategies strategies = ExchangeStrategies.builder()
                .codecs(configurer -> configurer.defaultCodecs().maxInMemorySize(16 * 1024 * 1024))
                .build();

        return WebClient.builder()
                .exchangeStrategies(strategies)
                .clientConnector(new ReactorClientHttpConnector(createHttpClient(defaultTimeout, defaultTimeout * 2)));
    }

    @Bean(name = "vnptWebClient")
    public WebClient vnptWebClient(WebClient.Builder builder, @Value("${provider.vnpt.base-url:}") String url) {
        return createWebClient(builder, url, vnptTimeout);
    }

    @Bean(name = "viettelWebClient")
    public WebClient viettelWebClient(WebClient.Builder builder, @Value("${provider.viettel.base-url:}") String url) {
        return createWebClient(builder, url, viettelTimeout);
    }

    @Bean(name = "bkavWebClient")
    public WebClient bkavWebClient(WebClient.Builder builder, @Value("${provider.bkav.base-url:}") String url) {
        return createWebClient(builder, url, bkavTimeout);
    }

    @Bean(name = "misaWebClient")
    public WebClient misaWebClient(WebClient.Builder builder, @Value("${provider.misa.base-url:}") String url) {
        return createWebClient(builder, url, misaTimeout);
    }

    private WebClient createWebClient(WebClient.Builder builder, String baseUrl, int timeout) {
        return builder.clone()
                .baseUrl(baseUrl)
                .clientConnector(new ReactorClientHttpConnector(createHttpClient(timeout, timeout * 2)))
                .build();
    }

    private HttpClient createHttpClient(int connectTimeout, int readWriteTimeout) {
        return HttpClient.create()
                .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, connectTimeout)
                .responseTimeout(Duration.ofMillis(readWriteTimeout))
                .doOnConnected(conn -> conn
                        .addHandlerLast(new ReadTimeoutHandler(readWriteTimeout, TimeUnit.MILLISECONDS))
                        .addHandlerLast(new WriteTimeoutHandler(readWriteTimeout, TimeUnit.MILLISECONDS)));
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/converter/EncryptionConverter.java">
package com.einvoicehub.core.converter;

import jakarta.persistence.AttributeConverter;
import jakarta.persistence.Converter;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import javax.crypto.Cipher;
import javax.crypto.spec.GCMParameterSpec;
import javax.crypto.spec.SecretKeySpec;
import java.nio.ByteBuffer;
import java.nio.charset.StandardCharsets;
import java.security.SecureRandom;
import java.util.Base64;

@Converter
@Component
public class EncryptionConverter implements AttributeConverter<String, String> {

    private static final String ALGORITHM = "AES/GCM/NoPadding";
    private static final int IV_LENGTH = 12;
    private static final int TAG_LENGTH = 128;

    @Value("${app.security.encryption.key}")
    private String secretKey;

    private SecretKeySpec getSecretKey() {
        byte[] keyBytes = secretKey.getBytes(StandardCharsets.UTF_8);
        byte[] adjustedKey = new byte[32];
        System.arraycopy(keyBytes, 0, adjustedKey, 0, Math.min(keyBytes.length, 32));
        return new SecretKeySpec(adjustedKey, "AES");
    }

    @Override
    public String convertToDatabaseColumn(String attribute) {
        if (attribute == null || attribute.isEmpty()) return null;
        try {
            Cipher cipher = Cipher.getInstance(ALGORITHM);
            byte[] iv = new byte[IV_LENGTH];
            new SecureRandom().nextBytes(iv);

            cipher.init(Cipher.ENCRYPT_MODE, getSecretKey(), new GCMParameterSpec(TAG_LENGTH, iv));
            byte[] encrypted = cipher.doFinal(attribute.getBytes(StandardCharsets.UTF_8));

            ByteBuffer buffer = ByteBuffer.allocate(iv.length + encrypted.length);
            buffer.put(iv).put(encrypted);
            return Base64.getEncoder().encodeToString(buffer.array());
        } catch (Exception e) {
            throw new IllegalStateException("Encryption failure: " + e.getMessage());
        }
    }

    @Override
    public String convertToEntityAttribute(String dbData) {
        if (dbData == null || dbData.isEmpty()) return null;
        try {
            byte[] decoded = Base64.getDecoder().decode(dbData);
            ByteBuffer buffer = ByteBuffer.wrap(decoded);

            byte[] iv = new byte[IV_LENGTH];
            buffer.get(iv);
            byte[] encrypted = new byte[buffer.remaining()];
            buffer.get(encrypted);

            Cipher cipher = Cipher.getInstance(ALGORITHM);
            cipher.init(Cipher.DECRYPT_MODE, getSecretKey(), new GCMParameterSpec(TAG_LENGTH, iv));
            return new String(cipher.doFinal(encrypted), StandardCharsets.UTF_8);
        } catch (Exception e) {
            throw new IllegalStateException("Decryption failure: " + e.getMessage());
        }
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/converter/JsonAttributeConverter.java">
package com.einvoicehub.core.converter;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import jakarta.persistence.AttributeConverter;
import jakarta.persistence.Converter;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.Map;

@Converter
@Component
public class JsonAttributeConverter implements AttributeConverter<Object, String> {

    private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();

    @Override
    public String convertToDatabaseColumn(Object attribute) {
        if (attribute == null) return null;
        try {
            return OBJECT_MAPPER.writeValueAsString(attribute);
        } catch (JsonProcessingException e) {
            throw new IllegalArgumentException("JSON serialization error: " + e.getMessage());
        }
    }

    @Override
    public Object convertToEntityAttribute(String dbData) {
        if (dbData == null || dbData.isEmpty()) return null;
        try {
            return OBJECT_MAPPER.readValue(dbData, Object.class);
        } catch (JsonProcessingException e) {
            throw new IllegalArgumentException("JSON deserialization error: " + e.getMessage());
        }
    }

    public static List<String> fromJsonToList(String json) {
        if (json == null || json.isEmpty()) return List.of();
        try {
            return OBJECT_MAPPER.readValue(json, new TypeReference<List<String>>() {});
        } catch (JsonProcessingException e) {
            throw new IllegalArgumentException("JSON to List conversion error");
        }
    }

    public static Map<String, Object> fromJsonToMap(String json) {
        if (json == null || json.isEmpty()) return Map.of();
        try {
            return OBJECT_MAPPER.readValue(json, new TypeReference<Map<String, Object>>() {});
        } catch (JsonProcessingException e) {
            throw new IllegalArgumentException("JSON to Map conversion error");
        }
    }

    public static String toJson(Object obj) {
        if (obj == null) return null;
        try {
            return OBJECT_MAPPER.writeValueAsString(obj);
        } catch (JsonProcessingException e) {
            throw new IllegalArgumentException("Object to JSON conversion error");
        }
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/enums/AdjustmentStatus.java">
package com.einvoicehub.core.domain.entity.enums;

public enum AdjustmentStatus {
    PENDING, APPROVED, REJECTED, CANCELLED
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/enums/AdjustmentType.java">
package com.einvoicehub.core.domain.entity.enums;

public enum AdjustmentType {
    ADJUSTMENT, REPLACEMENT, CANCELLATION
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/enums/AuditAction.java">
package com.einvoicehub.core.domain.entity.enums;

public enum AuditAction {
    CREATE, UPDATE, DELETE, STATUS_CHANGE
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/enums/IssuanceMethod.java">
package com.einvoicehub.core.domain.entity.enums;

public enum IssuanceMethod {
    STANDARD, POS
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/enums/SubscriptionPlan.java">
package com.einvoicehub.core.domain.entity.enums;

public enum SubscriptionPlan {
    TRIAL, BASIC, PREMIUM
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/enums/SyncStatus.java">
package com.einvoicehub.core.domain.entity.enums;

public enum SyncStatus {
    PENDING,    // Ch·ªù x·ª≠ l√Ω
    PROCESSING, // ƒêang x·ª≠ l√Ω
    COMPLETED,  // ƒê√£ ho√†n th√†nh th√†nh c√¥ng
    FAILED,     // Th·∫•t b·∫°i sau khi ƒë√£ th·ª≠ ƒë·ªß s·ªë l·∫ßn
    RETRYING    // ƒêang ch·ªù ƒë·ªÉ th·ª≠ l·∫°i
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/enums/SyncType.java">
package com.einvoicehub.core.domain.entity.enums;

public enum SyncType {
    SEND_TO_PROVIDER,   // G·ª≠i h√≥a ƒë∆°n sang nh√† cung c·∫•p d·ªãch v·ª•
    SEND_TO_CQT,        // G·ª≠i th√¥ng tin sang C∆° quan Thu·∫ø
    CANCEL_INVOICE,     // H·ªßy h√≥a ƒë∆°n tr√™n h·ªá th·ªëng Provider
    REPLACE_INVOICE     // Thay th·∫ø h√≥a ƒë∆°n tr√™n h·ªá th·ªëng Provider
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/enums/UserRole.java">
package com.einvoicehub.core.domain.entity.enums;

public enum UserRole {
    ADMIN, MANAGER, STAFF, VIEWER
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvApiCredentialsEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "api_credentials")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = "merchant")
public class EinvApiCredentialsEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "merchant_id", nullable = false)
    private EinvMerchantEntity merchant;

    @Column(name = "client_id", length = 50, nullable = false, unique = true)
    private String clientId;

    @Column(name = "api_key_hash", length = 255, nullable = false)
    private String apiKeyHash;

    @Column(name = "api_key_prefix", length = 8, nullable = false)
    private String apiKeyPrefix;

    @Column(name = "scopes", columnDefinition = "TEXT", nullable = false)
    private String scopes; // L∆∞u danh s√°ch quy·ªÅn d·∫°ng JSON array

    // --- Enterprise Shell Fields (H·∫° t·∫ßng b·∫£o m·∫≠t & Gi·ªõi h·∫°n t·∫£i) ---
    @Column(name = "ip_whitelist", columnDefinition = "TEXT")
    private String ipWhitelist;

    @Builder.Default
    @Column(name = "rate_limit_per_hour", nullable = false)
    private Integer rateLimitPerHour = 1000;

    @Builder.Default
    @Column(name = "rate_limit_per_day", nullable = false)
    private Integer rateLimitPerDay = 10000;

    @Builder.Default
    @Column(name = "request_count_hour", nullable = false)
    private Integer requestCountHour = 0;

    @Builder.Default
    @Column(name = "request_count_day", nullable = false)
    private Integer requestCountDay = 0;

    @Column(name = "request_count_resetted_at")
    private LocalDateTime requestCountResettedAt;

    @Column(name = "expired_at")
    private LocalDateTime expiredAt;

    @Column(name = "last_used_at")
    private LocalDateTime lastUsedAt;

    @Builder.Default
    @Column(name = "is_active", nullable = false)
    private Boolean isActive = true;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvAuditLogsEntity.java">
package com.einvoicehub.core.domain.entity;

import com.einvoicehub.core.domain.entity.enums.AuditAction;
import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "audit_logs")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = {"merchant", "user"})
public class EinvAuditLogsEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "merchant_id")
    private EinvMerchantEntity merchant; // Doanh nghi·ªáp li√™n quan

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id")
    private EinvMerchantUserEntity user; // Ng∆∞·ªùi th·ª±c hi·ªán

    @Column(name = "entity_type", length = 50, nullable = false)
    private String entityType; // Lo·∫°i ƒë·ªëi t∆∞·ª£ng (Invoice, Config...)

    @Column(name = "entity_id", nullable = false)
    private Long entityId;

    @Enumerated(EnumType.STRING)
    @Column(name = "action", length = 50, nullable = false)
    private AuditAction action;

    // --- Core Management Fields (D·ªØ li·ªáu ph·ª•c v·ª• ƒë·ªëi so√°t) ---
    @Column(name = "old_value", columnDefinition = "JSON")
    private String oldValue;

    @Column(name = "new_value", columnDefinition = "JSON")
    private String newValue;

    // --- Enterprise Shell Fields (L∆∞u v·∫øt h·∫° t·∫ßng) ---
    @Column(name = "ip_address", length = 45)
    private String ipAddress;

    @Column(name = "user_agent", length = 500)
    private String userAgent;

    @Column(name = "request_id", length = 100)
    private String requestId;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvInvoiceAdjustmentsEntity.java">
package com.einvoicehub.core.domain.entity;

import com.einvoicehub.core.domain.entity.enums.AdjustmentType;
import com.einvoicehub.core.domain.entity.enums.AdjustmentStatus;
import jakarta.persistence.*;
import lombok.*;
import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoice_adjustments")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = "originalInvoice")
public class EinvInvoiceAdjustmentsEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "original_invoice_id", nullable = false)
    private EinvInvoiceMetadataEntity originalInvoice;

    @Enumerated(EnumType.STRING)
    @Column(name = "adjustment_type", nullable = false)
    private AdjustmentType adjustmentType;

    // --- Agreement Information ---
    @Column(name = "agreement_number", length = 50)
    private String agreementNumber;

    @Column(name = "agreement_date")
    private LocalDate agreementDate;

    @Column(name = "agreement_content", columnDefinition = "TEXT")
    private String agreementContent;

    @Column(name = "signers", columnDefinition = "TEXT")
    private String signers; // JSON list of signers

    @Column(name = "reason_code", length = 50)
    private String reasonCode;

    @Column(name = "reason_description", length = 500)
    private String reasonDescription;

    // --- Financial Comparison (Precision 18,2) ---
    @Column(name = "old_subtotal_amount", precision = 18, scale = 2)
    private BigDecimal oldSubtotalAmount;

    @Column(name = "old_tax_amount", precision = 18, scale = 2)
    private BigDecimal oldTaxAmount;

    @Column(name = "old_total_amount", precision = 18, scale = 2)
    private BigDecimal oldTotalAmount;

    @Column(name = "new_subtotal_amount", precision = 18, scale = 2)
    private BigDecimal newSubtotalAmount;

    @Column(name = "new_tax_amount", precision = 18, scale = 2)
    private BigDecimal newTaxAmount;

    @Column(name = "new_total_amount", precision = 18, scale = 2)
    private BigDecimal newTotalAmount;

    @Column(name = "difference_amount", precision = 18, scale = 2)
    private BigDecimal differenceAmount;

    // --- Status & Workflow ---
    @Enumerated(EnumType.STRING)
    @Builder.Default
    @Column(name = "status", nullable = false)
    private AdjustmentStatus status = AdjustmentStatus.PENDING;

    @Column(name = "approved_at")
    private LocalDateTime approvedAt;

    // --- Shell Fields (CQT Integration) ---
    @Builder.Default
    @Column(name = "submitted_to_cqt", nullable = false)
    private Boolean submittedToCqt = false;

    @Column(name = "cqt_response_code", length = 50)
    private String cqtResponseCode;

    @Column(name = "cqt_response_message", columnDefinition = "TEXT")
    private String cqtResponseMessage;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvInvoiceItemEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.math.BigDecimal;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoice_items")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = {"invoice", "vatRate"})
public class EinvInvoiceItemEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "invoice_id", nullable = false)
    private EinvInvoiceMetadataEntity invoice; // Li√™n k·∫øt h√≥a ƒë∆°n cha

    @Column(name = "line_number", nullable = false)
    private Integer lineNumber; // S·ªë th·ª© t·ª± d√≤ng

    // --- Product Information ---
    @Builder.Default
    @Column(name = "is_free")
    private Boolean isFree = false; // H√†ng khuy·∫øn m√£i

    @Column(name = "product_type_id")
    private Integer productTypeId;

    @Column(name = "product_code", length = 100)
    private String productCode;

    @Column(name = "product_name", length = 500, nullable = false)
    private String productName;

    @Column(name = "unit_name", length = 50)
    private String unitName;

    // --- Quantity & Price (Precision 18,4) ---
    @Builder.Default
    @Column(name = "quantity", precision = 18, scale = 4, nullable = false)
    private BigDecimal quantity = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "unit_price", precision = 18, scale = 4, nullable = false)
    private BigDecimal unitPrice = BigDecimal.ZERO;

    // --- Calculations (Precision 18,2) ---
    @Builder.Default
    @Column(name = "gross_amount", precision = 18, scale = 2)
    private BigDecimal grossAmount = BigDecimal.ZERO; // quantity * unit_price

    @Builder.Default
    @Column(name = "discount_rate", precision = 5, scale = 2)
    private BigDecimal discountRate = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "discount_amount", precision = 18, scale = 2)
    private BigDecimal discountAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "net_price", precision = 18, scale = 4)
    private BigDecimal netPrice = BigDecimal.ZERO; // Gi√° sau chi·∫øt kh·∫•u

    @Builder.Default
    @Column(name = "net_amount", precision = 18, scale = 2)
    private BigDecimal netAmount = BigDecimal.ZERO; // Th√†nh ti·ªÅn sau chi·∫øt kh·∫•u

    // --- Tax Information ---
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "vat_rate_id")
    private EinvVatRateEntity vatRate; // FK t·ªõi danh m·ª•c thu·∫ø

    @Builder.Default
    @Column(name = "tax_rate", precision = 5, scale = 2)
    private BigDecimal taxRate = BigDecimal.ZERO; // Snapshot t·ª∑ l·ªá thu·∫ø (%)

    @Builder.Default
    @Column(name = "tax_amount", precision = 18, scale = 2)
    private BigDecimal taxAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "total_amount", precision = 18, scale = 2, nullable = false)
    private BigDecimal totalAmount = BigDecimal.ZERO; // Net + Tax

    // --- Shell Fields ---
    @Column(name = "description", columnDefinition = "TEXT")
    private String description;

    @Column(name = "notes", length = 500)
    private String notes;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvInvoiceMetadataEntity.java">
package com.einvoicehub.core.domain.entity;

import com.einvoicehub.core.domain.entity.*;
import com.einvoicehub.core.domain.entity.enums.IssuanceMethod;
import com.einvoicehub.core.domain.entity.enums.AdjustmentType;
import jakarta.persistence.*;
import lombok.*;
import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoice_metadata")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = {"merchant", "provider", "providerConfig", "invoiceTemplate", "invoiceStatus", "paymentMethodEntity", "replacedBy", "deletedByUser"})
public class EinvInvoiceMetadataEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    // --- Relationships (Hierarchical Core) ---
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "merchant_id", nullable = false)
    private EinvMerchantEntity merchant;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "provider_id")
    private EinvServiceProviderEntity provider;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "provider_config_id")
    private EinvMerchantProviderConfigEntity providerConfig;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "invoice_template_id")
    private EinvInvoiceTemplateEntity invoiceTemplate;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "status_id", nullable = false)
    private EinvInvoiceStatusEntity invoiceStatus;

    // Li√™n k·∫øt v·ªõi b·∫£ng payment_methods qua tr∆∞·ªùng method_code
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "payment_method", referencedColumnName = "method_code")
    private EinvPaymentMethodEntity paymentMethodEntity;

    // --- Identifiers & References ---
    @Column(name = "client_request_id", length = 100)
    private String clientRequestId;

    @Column(name = "partner_invoice_id", length = 50)
    private String partnerInvoiceId;

    @Column(name = "invoice_number", length = 20)
    private String invoiceNumber;

    @Column(name = "symbol_code", length = 10)
    private String symbolCode;

    @Column(name = "template_code", length = 20)
    private String templateCode;

    @Column(name = "invoice_type_code", length = 10)
    private String invoiceTypeCode;

    @Builder.Default
    @Column(name = "is_summary_invoice", nullable = false)
    private Boolean isSummaryInvoice = false;

    @Enumerated(EnumType.STRING)
    @Builder.Default
    @Column(name = "issuance_method", nullable = false)
    private IssuanceMethod issuanceMethod = IssuanceMethod.STANDARD;

    @Column(name = "lookup_code", length = 50, unique = true)
    private String lookupCode; // M√£ tra c·ª©u h√≥a ƒë∆°n

    @Column(name = "tax_authority_code", length = 50)
    private String taxAuthorityCode;

    @Column(name = "cqt_code", length = 50)
    private String cqtCode; // M√£ C∆° quan Thu·∫ø c·∫•p

    @Column(name = "provider_transaction_id", length = 100)
    private String providerTransactionId;

    // --- Seller Information (Flattened) ---
    @Column(name = "seller_name")
    private String sellerName;

    @Column(name = "seller_tax_code", length = 20)
    private String sellerTaxCode;

    @Column(name = "seller_address", columnDefinition = "TEXT")
    private String sellerAddress;

    // --- Buyer Information (Flattened) ---
    @Column(name = "buyer_name")
    private String buyerName;

    @Column(name = "buyer_tax_code", length = 20)
    private String buyerTaxCode;

    @Column(name = "buyer_id_no", length = 20)
    private String buyerIdNo;

    @Column(name = "buyer_full_name", length = 200)
    private String buyerFullName;

    @Column(name = "buyer_email")
    private String buyerEmail;

    @Column(name = "buyer_phone", length = 20)
    private String buyerPhone;

    @Column(name = "buyer_mobile", length = 50)
    private String buyerMobile;

    @Column(name = "buyer_address", columnDefinition = "TEXT")
    private String buyerAddress;

    @Column(name = "buyer_bank_account", length = 50)
    private String buyerBankAccount;

    @Column(name = "buyer_bank_name", length = 200)
    private String buyerBankName;

    @Column(name = "buyer_budget_code", length = 20)
    private String buyerBudgetCode;

    // --- Financial Amounts (DECIMAL 18,2) ---
    @Builder.Default
    @Column(name = "subtotal_amount", precision = 18, scale = 2, nullable = false)
    private BigDecimal subtotalAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "tax_amount", precision = 18, scale = 2, nullable = false)
    private BigDecimal taxAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "discount_amount", precision = 18, scale = 2, nullable = false)
    private BigDecimal discountAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "total_amount", precision = 18, scale = 2, nullable = false)
    private BigDecimal totalAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "gross_amount", precision = 18, scale = 2)
    private BigDecimal grossAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "net_amount", precision = 18, scale = 2)
    private BigDecimal netAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "currency_code", length = 3, nullable = false)
    private String currencyCode = "VND";

    @Builder.Default
    @Column(name = "exchange_rate", precision = 10, scale = 4, nullable = false)
    private BigDecimal exchangeRate = BigDecimal.ONE;

    // --- Adjustment / History ---
    @Column(name = "org_invoice_id", length = 36)
    private String originalInvoiceId;

    @Column(name = "org_invoice_form", length = 50)
    private String originalInvoiceForm;

    @Column(name = "org_invoice_series", length = 50)
    private String originalInvoiceSeries;

    @Column(name = "org_invoice_no", length = 50)
    private String originalInvoiceNo;

    @Column(name = "org_invoice_date")
    private LocalDateTime originalInvoiceDate;

    @Column(name = "org_invoice_reason", length = 500)
    private String originalInvoiceReason;

    @Enumerated(EnumType.STRING)
    @Column(name = "adjustment_type")
    private AdjustmentType adjustmentType;

    @Column(name = "cancellation_reason", length = 500)
    private String cancellationReason;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "replaced_by_invoice_id")
    private EinvInvoiceMetadataEntity replacedBy;

    // --- Dates & Status ---
    @Column(name = "status_message", columnDefinition = "TEXT")
    private String statusMessage;

    @Column(name = "issue_date")
    private LocalDate issueDate;

    @Column(name = "accounting_date")
    private LocalDate accountingDate;

    @Column(name = "due_date")
    private LocalDate dueDate;

    // --- Timestamps Shell Fields ---
    @Column(name = "signed_at")
    private LocalDateTime signedAt;

    @Column(name = "sent_to_provider_at")
    private LocalDateTime sentToProviderAt;

    @Column(name = "received_from_provider_at")
    private LocalDateTime receivedFromProviderAt;

    @Column(name = "delivered_to_buyer_at")
    private LocalDateTime deliveredToBuyerAt;

    @Column(name = "provider_error_code", length = 50)
    private String providerErrorCode;

    @Column(name = "provider_error_message", columnDefinition = "TEXT")
    private String providerErrorMessage;

    // --- System Audit Shell Fields ---
    @Builder.Default
    @Column(name = "is_deleted", nullable = false)
    private Boolean isDeleted = false;

    @Column(name = "deleted_at")
    private LocalDateTime deletedAt;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "deleted_by")
    private EinvMerchantUserEntity deletedByUser;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvInvoicePayloadEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoice_payloads")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = "invoice")
public class EinvInvoicePayloadEntity {

    @Id
    @Column(name = "invoice_id")
    private Long invoiceId;

    @OneToOne(fetch = FetchType.LAZY)
    @MapsId
    @JoinColumn(name = "invoice_id")
    private EinvInvoiceMetadataEntity invoice;

    @Column(name = "raw_data", columnDefinition = "JSON")
    private String rawData;

    @Column(name = "xml_content", columnDefinition = "LONGTEXT")
    private String xmlContent;

    @Column(name = "json_content", columnDefinition = "LONGTEXT")
    private String jsonContent;

    @Column(name = "signed_xml", columnDefinition = "LONGTEXT")
    private String signedXml;

    @Column(name = "pdf_data", columnDefinition = "LONGTEXT")
    private String pdfData;

    @Column(name = "extra_data", columnDefinition = "JSON")
    private String extraData;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvInvoiceRegistrationEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDate;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoice_registrations")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = {"merchant", "status"})
public class EinvInvoiceRegistrationEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "merchant_id", nullable = false)
    private EinvMerchantEntity merchant; // Li√™n k·∫øt doanh nghi·ªáp s·ªü h·ªØu

    @Column(name = "registration_number", length = 50)
    private String registrationNumber; // S·ªë quy·∫øt ƒë·ªãnh c·ªßa CQT

    @Column(name = "from_number", nullable = false)
    private Long fromNumber;

    @Column(name = "to_number", nullable = false)
    private Long toNumber;

    @Column(name = "quantity", nullable = false)
    private Long quantity;

    @Builder.Default
    @Column(name = "current_number", nullable = false)
    private Long currentNumber = 0L; // S·ªë hi·ªán t·∫°i ƒë√£ s·ª≠ d·ª•ng

    @Column(name = "effective_date", nullable = false)
    private LocalDate effectiveDate; // Ng√†y c√≥ hi·ªáu l·ª±c (SQL DATE)

    @Column(name = "expiration_date")
    private LocalDate expirationDate;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "status_id", nullable = false)
    private EinvRegistrationStatusEntity status; // Quan h·ªá v·ªõi registration_statuses

    // --- Enterprise Shell Fields ---
    @Column(name = "issued_by", length = 255)
    private String issuedBy; // C∆° quan Thu·∫ø ph√™ duy·ªát

    @Column(name = "note", columnDefinition = "TEXT")
    private String note;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvInvoiceStatusEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoice_statuses")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString
public class EinvInvoiceStatusEntity {
    @Id
    private Integer id; // ID ƒë·ªãnh danh c·ªë ƒë·ªãnh: 1-DRAFT, 5-SUCCESS...

    @Column(name = "name", length = 100, nullable = false, unique = true)
    private String name;

    // --- Enterprise Shell Fields ---
    @Column(name = "description", length = 255)
    private String description;

    @Column(name = "note", length = 500)
    private String note; // Ghi ch√∫ nghi·ªáp v·ª• m·ªü r·ªông

    @Column(name = "created_at")
    private LocalDateTime createdAt;

    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvInvoiceSyncQueueEntity.java">
package com.einvoicehub.core.domain.entity;

import com.einvoicehub.core.domain.entity.enums.SyncType;
import com.einvoicehub.core.domain.entity.enums.SyncStatus;
import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoice_sync_queue")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = "invoice")
public class EinvInvoiceSyncQueueEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "invoice_id", nullable = false)
    private EinvInvoiceMetadataEntity invoice;

    @Enumerated(EnumType.STRING)
    @Column(name = "sync_type", nullable = false)
    private SyncType syncType;

    @Builder.Default
    @Column(name = "priority", nullable = false)
    private Integer priority = 5; // ƒê·ªô ∆∞u ti√™n: 1-Cao nh·∫•t, 10-Th·∫•p nh·∫•t

    @Enumerated(EnumType.STRING)
    @Builder.Default
    @Column(name = "status", nullable = false)
    private SyncStatus status = SyncStatus.PENDING;

    @Builder.Default
    @Column(name = "attempt_count", nullable = false)
    private Integer attemptCount = 0;

    @Builder.Default
    @Column(name = "max_attempts", nullable = false)
    private Integer maxAttempts = 3;

    @Column(name = "last_attempt_at")
    private LocalDateTime lastAttemptAt;

    @Column(name = "next_retry_at")
    private LocalDateTime nextRetryAt;

    // --- Core Management Fields (D·ªØ li·ªáu ph·ª•c v·ª• x·ª≠ l√Ω l·∫°i) ---
    @Column(name = "request_data", columnDefinition = "JSON")
    private String requestData; // D·ªØ li·ªáu g·ª≠i ƒëi d·∫°ng JSON

    @Column(name = "response_data", columnDefinition = "JSON")
    private String responseData; // D·ªØ li·ªáu nh·∫≠n v·ªÅ t·ª´ API

    @Column(name = "error_code", length = 50)
    private String errorCode;

    @Column(name = "error_message", columnDefinition = "TEXT")
    private String errorMessage;

    // --- Enterprise Shell Fields (L∆∞u v·∫øt worker x·ª≠ l√Ω) ---
    @Column(name = "processed_by", length = 100)
    private String processedBy; // T√™n m√°y ho·∫∑c ID worker x·ª≠ l√Ω

    @Column(name = "processing_started_at")
    private LocalDateTime processingStartedAt;

    @Column(name = "processing_completed_at")
    private LocalDateTime processingCompletedAt;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvInvoiceTaxBreakDownEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.math.BigDecimal;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoice_tax_breakdowns")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = {"invoice", "vatRate"})
public class EinvInvoiceTaxBreakDownEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "invoice_id", nullable = false)
    private EinvInvoiceMetadataEntity invoice;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "vat_rate_id", nullable = false)
    private EinvVatRateEntity vatRate;

    @Column(name = "vat_rate_code", length = 10, nullable = false)
    private String vatRateCode;

    @Column(name = "vat_rate_percent", precision = 5, scale = 2, nullable = false)
    private BigDecimal vatRatePercent;

    @Builder.Default
    @Column(name = "subtotal_amount", precision = 18, scale = 2, nullable = false)
    private BigDecimal subtotalAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "discount_amount", precision = 18, scale = 2, nullable = false)
    private BigDecimal discountAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "taxable_amount", precision = 18, scale = 2, nullable = false)
    private BigDecimal taxableAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "tax_amount", precision = 18, scale = 2, nullable = false)
    private BigDecimal taxAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "total_amount", precision = 18, scale = 2, nullable = false)
    private BigDecimal totalAmount = BigDecimal.ZERO;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvInvoiceTemplateEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoice_template")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = {"merchant", "invoiceType", "registration"})
public class EinvInvoiceTemplateEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "merchant_id", nullable = false)
    private EinvMerchantEntity merchant;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "invoice_type_id")
    private EinvInvoiceTypeEntity invoiceType;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "invoice_registration_id")
    private EinvInvoiceRegistrationEntity registration;

    @Column(name = "template_code", length = 20, nullable = false)
    private String templateCode;
    @Column(name = "symbol_code", length = 10, nullable = false)

    private String symbolCode;

    @Builder.Default
    @Column(name = "current_number", nullable = false)
    private Integer currentNumber = 0;

    @Builder.Default
    @Column(name = "min_number", nullable = false)
    private Integer minNumber = 1;

    @Builder.Default
    @Column(name = "max_number", nullable = false)
    private Integer maxNumber = 99999999;

    @Column(name = "start_date")
    private LocalDateTime startDate;

    @Column(name = "status_id")
    private Integer statusId; // ID tr·∫°ng th√°i m·ªü r·ªông

    @Builder.Default
    @Column(name = "is_active", nullable = false)
    private Boolean isActive = true;

    // --- Enterprise Shell Fields ---
    @Column(name = "provider_id", length = 36)
    private String providerId;

    @Column(name = "provider_serial_id", length = 50)
    private String providerSerialId;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvInvoiceTypeEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoice_types")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString
public class EinvInvoiceTypeEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "type_code", length = 10, nullable = false, unique = true)
    private String typeCode;

    @Column(name = "type_name", length = 100, nullable = false)
    private String typeName;

    @Column(name = "description", columnDefinition = "TEXT")
    private String description;

    @Builder.Default
    @Column(name = "is_active", nullable = false)
    private Boolean isActive = true;

    @Builder.Default
    @Column(name = "display_order", nullable = false)
    private Integer displayOrder = 0;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvMerchantEntity.java">
package com.einvoicehub.core.domain.entity;
import com.einvoicehub.core.domain.entity.enums.SubscriptionPlan;
import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "merchants")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString
public class EinvMerchantEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "tax_code", length = 20, nullable = false, unique = true)
    private String taxCode;

    @Column(name = "company_name", length = 255, nullable = false)
    private String companyName;

    @Column(name = "short_name", length = 100)
    private String shortName;

    @Column(name = "address", columnDefinition = "TEXT")
    private String address;

    @Column(name = "district", length = 100)
    private String district;

    @Column(name = "city", length = 100)
    private String city;

    @Column(name = "email", length = 255)
    private String email;

    @Column(name = "phone", length = 20)
    private String phone;

    @Column(name = "representative_name", length = 100)
    private String representativeName;

    @Column(name = "representative_title", length = 100)
    private String representativeTitle;

    @Column(name = "tax_authority_code", length = 10)
    private String taxAuthorityCode;

    // --- Enterprise Shell Fields ---
    @Enumerated(EnumType.STRING)
    @Builder.Default
    @Column(name = "subscription_plan", nullable = false)
    private SubscriptionPlan subscriptionPlan = SubscriptionPlan.TRIAL;

    @Builder.Default
    @Column(name = "invoice_quota", nullable = false)
    private Integer invoiceQuota = 100;

    @Builder.Default
    @Column(name = "invoice_used", nullable = false)
    private Integer invoiceUsed = 0;

    @Builder.Default
    @Column(name = "is_using_hsm", nullable = false)
    private Boolean isUsingHsm = false;

    @Builder.Default
    @Column(name = "is_deleted", nullable = false)
    private Boolean isDeleted = false;

    @Column(name = "deleted_at")
    private LocalDateTime deletedAt;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvMerchantProviderConfigEntity.java">
package com.einvoicehub.core.domain.entity;
import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "merchant_provider_configs")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = {"merchant", "provider"})
public class EinvMerchantProviderConfigEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "merchant_id", nullable = false)
    private EinvMerchantEntity merchant;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "provider_id", nullable = false)
    private EinvServiceProviderEntity provider;

    @Column(name = "partner_id", length = 50)
    private String partnerId;

    @Column(name = "partner_token", length = 500)
    private String partnerToken;

    @Column(name = "tax_code", length = 20)
    private String taxCode;

    @Column(name = "integration_url", length = 500)
    private String integrationUrl;

    @Column(name = "integrated_date")
    private LocalDateTime integratedDate;

    @Column(name = "username_service", length = 100, nullable = false)
    private String usernameService;

    @Column(name = "password_service_encrypted", length = 500, nullable = false)
    private String passwordServiceEncrypted;

    @Column(name = "certificate_serial", length = 100)
    private String certificateSerial;

    @Column(name = "certificate_data", columnDefinition = "TEXT")
    private String certificateData;

    @Column(name = "certificate_chain", columnDefinition = "LONGTEXT")
    private String certificateChain;

    @Column(name = "certificate_expired_at")
    private LocalDateTime certificateExpiredAt;

    @Column(name = "extra_config", columnDefinition = "JSON")
    private String extraConfig;

    // --- Enterprise Shell Fields ---
    @Builder.Default
    @Column(name = "is_test_mode", nullable = false)
    private Boolean isTestMode = false;

    @Column(name = "encrypted_password_storage", length = 500)
    private String encryptedPasswordStorage;

    @Builder.Default
    @Column(name = "is_active", nullable = false)
    private Boolean isActive = true;

    @Builder.Default
    @Column(name = "is_default", nullable = false)
    private Boolean isDefault = false;

    @Column(name = "last_sync_at")
    private LocalDateTime lastSyncAt;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvMerchantUserEntity.java">
package com.einvoicehub.core.domain.entity;
import com.einvoicehub.core.domain.entity.enums.UserRole;
import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "merchant_user")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = "merchant")
public class EinvMerchantUserEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "merchant_id", nullable = false)
    private EinvMerchantEntity merchant;

    @Column(name = "username", length = 50, nullable = false, unique = true)
    private String username;

    @Column(name = "email", length = 255, nullable = false, unique = true)
    private String email;

    @Column(name = "password_hash", length = 255, nullable = false)
    private String passwordHash;

    @Column(name = "full_name", length = 100)
    private String fullName;

    @Column(name = "phone", length = 20)
    private String phone;

    @Column(name = "avatar_url", length = 500)
    private String avatarUrl;

    @Enumerated(EnumType.STRING)
    @Builder.Default
    @Column(name = "role", nullable = false)
    private UserRole role = UserRole.STAFF;

    @Builder.Default
    @Column(name = "is_active", nullable = false)
    private Boolean isActive = true;

    @Builder.Default
    @Column(name = "is_primary", nullable = false)
    private Boolean isPrimary = false;

    @Column(name = "last_login_at")
    private LocalDateTime lastLoginAt;

    @Builder.Default
    @Column(name = "failed_login_attempts", nullable = false)
    private Integer failedLoginAttempts = 0;

    @Column(name = "locked_until")
    private LocalDateTime lockedUntil;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvPaymentMethodEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "payment_methods")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString
public class EinvPaymentMethodEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "method_code", length = 10, nullable = false, unique = true)
    private String methodCode; // V√≠ d·ª•: TM, CK

    @Column(name = "method_name", length = 100, nullable = false)
    private String methodName;

    // --- Enterprise Shell Fields ---
    @Column(name = "description", columnDefinition = "TEXT")
    private String description; // M√¥ t·∫£ m·ªü r·ªông

    @Builder.Default
    @Column(name = "is_active", nullable = false)
    private Boolean isActive = true;

    @Builder.Default
    @Column(name = "display_order", nullable = false)
    private Integer displayOrder = 0;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvRegistrationStatusEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "registration_statuses")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString
public class EinvRegistrationStatusEntity {

    @Id
    private Integer id;

    @Column(name = "name", length = 100, nullable = false, unique = true)
    private String name;

    // --- Enterprise Shell Fields ---
    @Column(name = "description", length = 255)
    private String description;

    @Column(name = "note", length = 500)
    private String note; // Ghi ch√∫ nghi·ªáp v·ª• m·ªü r·ªông

    @Column(name = "created_at")
    private LocalDateTime createdAt;

    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvServiceProviderEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "service_providers")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString
public class EinvServiceProviderEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "provider_code", length = 20, nullable = false, unique = true)
    private String providerCode; // V√≠ d·ª•: VNPT, VIETTEL

    @Column(name = "provider_name", length = 100, nullable = false)
    private String providerName;

    @Column(name = "official_api_url", length = 500, nullable = false)
    private String officialApiUrl;

    // --- Enterprise Shell Fields ---
    @Column(name = "lookup_url", length = 500)
    private String lookupUrl; // URL tra c·ª©u h√≥a ƒë∆°n

    @Column(name = "documentation_url", length = 500)
    private String documentationUrl;

    @Column(name = "support_email", length = 255)
    private String supportEmail;

    @Column(name = "support_phone", length = 20)
    private String supportPhone;

    @Builder.Default
    @Column(name = "is_active", nullable = false)
    private Boolean isActive = true;

    @Builder.Default
    @Column(name = "is_default", nullable = false)
    private Boolean isDefault = false;

    @Builder.Default
    @Column(name = "display_order", nullable = false)
    private Integer displayOrder = 0;

    @Column(name = "extra_config_schema", columnDefinition = "JSON")
    private String extraConfigSchema; // C·∫•u h√¨nh ƒë·∫∑c th√π d·∫°ng JSON

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvSystemConfigEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "system_config")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString
public class EinvSystemConfigEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "config_key", length = 100, nullable = false, unique = true)
    private String configKey;

    @Column(name = "config_value", columnDefinition = "TEXT", nullable = false)
    private String configValue;

    @Column(name = "config_type", length = 20, nullable = false)
    private String configType; // STRING, NUMBER, BOOLEAN, JSON

    // --- Enterprise Shell Fields ---
    @Column(name = "description", length = 500)
    private String description;

    @Builder.Default
    @Column(name = "is_encrypted", nullable = false)
    private Boolean isEncrypted = false; // M√£ h√≥a d·ªØ li·ªáu nh·∫°y c·∫£m (VD: API Secret)

    @Builder.Default
    @Column(name = "is_editable", nullable = false)
    private Boolean isEditable = true;

    @Column(name = "updated_by")
    private Long updatedBy; // ID c·ªßa MerchantUser th·ª±c hi·ªán thay ƒë·ªïi (Decoupled)

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvTaxAuthorityResponseEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "tax_authority_responses")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = "invoice")
public class EinvTaxAuthorityResponseEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "invoice_id", nullable = false)
    private EinvInvoiceMetadataEntity invoice;

    @Column(name = "cqt_code", length = 50, nullable = false)
    private String cqtCode; // M√£ C∆° quan Thu·∫ø c·∫•p

    @Column(name = "status_from_cqt", length = 50, nullable = false)
    private String statusFromCqt; // APPROVED, REJECTED, ...

    @Column(name = "processing_code", length = 100)
    private String processingCode;

    @Column(name = "signature_data", columnDefinition = "TEXT")
    private String signatureData; // Ch·ªØ k√Ω s·ªë t·ª´ C∆° quan Thu·∫ø

    // --- Enterprise Shell Fields ---
    @Column(name = "raw_response", columnDefinition = "JSON")
    private String rawResponse; // N·ªôi dung ph·∫£n h·ªìi th√¥ d·∫°ng JSON

    @Column(name = "error_code", length = 50)
    private String errorCode;

    @Column(name = "error_message", columnDefinition = "TEXT")
    private String errorMessage;

    @Column(name = "received_at", nullable = false)
    private LocalDateTime receivedAt; // Th·ªùi ƒëi·ªÉm nh·∫≠n th·ª±c t·∫ø

    @Column(name = "processed_at")
    private LocalDateTime processedAt; // Th·ªùi ƒëi·ªÉm h·ªá th·ªëng x·ª≠ l√Ω xong

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        if (this.receivedAt == null) {
            this.receivedAt = LocalDateTime.now();
        }
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvUserAuthorEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import org.hibernate.annotations.Immutable;

@Entity
@Immutable
@Table(name = "vw_sys_user_author")
@Getter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString
public class EinvUserAuthorEntity {

    @Id
    @Column(name = "id")
    private String id;

    @Column(name = "name")
    private String name;

    @Column(name = "full_name")
    private String fullName;
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvVatRateEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.math.BigDecimal;
import java.time.LocalDateTime;

@Entity
@Table(name = "vat_rates")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString
public class EinvVatRateEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "rate_code", length = 10, nullable = false, unique = true)
    private String rateCode; // V√≠ d·ª•: 0, 5, 10, KCT

    @Column(name = "rate_percent", precision = 5, scale = 2, nullable = false)
    private BigDecimal ratePercent;

    @Column(name = "rate_name", length = 100, nullable = false)
    private String rateName;

    // --- Enterprise Shell Fields ---
    @Column(name = "description", columnDefinition = "TEXT")
    private String description;

    @Builder.Default
    @Column(name = "is_active", nullable = false)
    private Boolean isActive = true;

    @Builder.Default
    @Column(name = "display_order", nullable = false)
    private Integer displayOrder = 0;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvApiCredentialRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvApiCredentialsEntity;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface EinvApiCredentialRepository extends JpaRepository<EinvApiCredentialsEntity, Long>,
        JpaSpecificationExecutor<EinvApiCredentialsEntity> {


     //T√¨m ki·∫øm th√¥ng tin x√°c th·ª±c b·∫±ng Client ID c√¥ng khai.
    Optional<EinvApiCredentialsEntity> findByClientIdAndIsActiveTrue(String clientId);

    @Query("SELECT c FROM EinvApiCredentialsEntity c WHERE " +
            "(:merchantId IS NULL OR c.merchant.id = :merchantId) AND " +
            "(:search IS NULL OR " +
            "    LOWER(c.clientId) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "    LOWER(c.apiKeyPrefix) LIKE LOWER(CONCAT('%', :search, '%'))" +
            ")")
    Page<EinvApiCredentialsEntity> findByFilters(
            @Param("merchantId") Long merchantId,
            @Param("search") String search,
            Pageable pageable);


     // Native Query: L·∫•y Prefix c·ªßa API Key m·ªõi nh·∫•t v·ª´a t·∫°o cho Merchant.
    @Query(value = "SELECT api_key_prefix FROM api_credentials " +
            "WHERE merchant_id = :merchantId ORDER BY created_at DESC LIMIT 1",
            nativeQuery = true)
    String findLatestApiKeyPrefix(@Param("merchantId") Long merchantId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvAuditLogRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvAuditLogsEntity;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

@Repository
public interface EinvAuditLogRepository extends JpaRepository<EinvAuditLogsEntity, Long>,
        JpaSpecificationExecutor<EinvAuditLogsEntity> {

    Page<EinvAuditLogsEntity> findByEntityTypeAndEntityIdOrderByCreatedAtDesc(
            String entityType, Long entityId, Pageable pageable);

    @Query("SELECT l FROM EinvAuditLogsEntity l WHERE " +
            "(:merchantId IS NULL OR l.merchant.id = :merchantId) AND " +
            "(:entityType IS NULL OR l.entityType = :entityType) AND " +
            "(:action IS NULL OR l.action = :action) AND " +
            "(:search IS NULL OR LOWER(l.requestId) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            " LOWER(l.ipAddress) LIKE LOWER(CONCAT('%', :search, '%')))")
    Page<EinvAuditLogsEntity> searchAuditLogs(
            @Param("merchantId") Long merchantId,
            @Param("entityType") String entityType,
            @Param("action") String action,
            @Param("search") String search,
            Pageable pageable);

    @Query(value = "SELECT COUNT(*) FROM audit_logs " +
            "WHERE ip_address = :ip AND created_at >= CURDATE()",
            nativeQuery = true)
    long countActionsTodayByIp(@Param("ip") String ipAddress);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvInvoiceAdjustmentRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvInvoiceAdjustmentsEntity;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface EinvInvoiceAdjustmentRepository extends JpaRepository<EinvInvoiceAdjustmentsEntity, Long>,
        JpaSpecificationExecutor<EinvInvoiceAdjustmentsEntity> {

    @EntityGraph(attributePaths = {"originalInvoice"})
    Optional<EinvInvoiceAdjustmentsEntity> findByOriginalInvoiceId(Long originalInvoiceId);

    @Query("SELECT a FROM EinvInvoiceAdjustmentsEntity a WHERE " +
            "(:merchantId IS NULL OR a.originalInvoice.merchant.id = :merchantId) AND " +
            "(:search IS NULL OR " +
            "    LOWER(a.agreementNumber) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "    LOWER(a.reasonDescription) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "    LOWER(a.originalInvoice.invoiceNumber) LIKE LOWER(CONCAT('%', :search, '%'))" +
            ") " +
            "AND (:status IS NULL OR a.status = :status)")
    Page<EinvInvoiceAdjustmentsEntity> findByFilters(
            @Param("merchantId") Long merchantId,
            @Param("search") String search,
            @Param("status") String status,
            Pageable pageable
    );

    @Query(value = "SELECT a.* FROM invoice_adjustments a " +
            "JOIN invoice_metadata m ON a.original_invoice_id = m.id " +
            "WHERE m.merchant_id = :merchantId " +
            "ORDER BY a.created_at DESC LIMIT 1", nativeQuery = true)
    Optional<EinvInvoiceAdjustmentsEntity> findLatestAdjustment(@Param("merchantId") Long merchantId);

    boolean existsByOriginalInvoiceId(Long originalInvoiceId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvInvoiceItemRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvInvoiceItemEntity;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface EinvInvoiceItemRepository extends JpaRepository<EinvInvoiceItemEntity, Long>,
        JpaSpecificationExecutor<EinvInvoiceItemEntity> {

    @EntityGraph(attributePaths = {"vatRate"})
    List<EinvInvoiceItemEntity> findByInvoiceIdOrderByLineNumberAsc(Long invoiceId);
    boolean existsByVatRateId(Long vatRateId);

    @Modifying
    @Query("DELETE FROM EinvInvoiceItemEntity i WHERE i.invoice.id = :invoiceId")
    void deleteByInvoiceId(@Param("invoiceId") Long invoiceId);

    @Query(value = "SELECT product_name, SUM(quantity) as total_qty FROM invoice_items i " +
            "JOIN invoice_metadata m ON i.invoice_id = m.id " +
            "WHERE m.merchant_id = :merchantId GROUP BY product_code, product_name " +
            "ORDER BY total_qty DESC LIMIT 10", nativeQuery = true)
    List<Object[]> findTopSellingProducts(@Param("merchantId") Long merchantId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvInvoiceMetadataRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvInvoiceMetadataEntity;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Optional;


@Repository
public interface EinvInvoiceMetadataRepository extends JpaRepository<EinvInvoiceMetadataEntity, Long>,
        JpaSpecificationExecutor<EinvInvoiceMetadataEntity> {

    Optional<EinvInvoiceMetadataEntity> findByPartnerInvoiceId(String partnerInvoiceId);

    Optional<EinvInvoiceMetadataEntity> findByLookupCode(String lookupCode);

    Optional<EinvInvoiceMetadataEntity> findByInvoiceNumber(String invoiceNumber);

    @EntityGraph(attributePaths = {"items", "invoiceStatus", "merchant"})
    Optional<EinvInvoiceMetadataEntity> findWithDetailsById(Long id);

    @EntityGraph(attributePaths = {"invoiceStatus"})
    Optional<EinvInvoiceMetadataEntity> findTopByPartnerInvoiceIdOrderByCreatedAtDesc(String partnerInvoiceId);

    @Query("SELECT i FROM EinvInvoiceMetadataEntity i WHERE " +
            "(:merchantId IS NULL OR i.merchant.id = :merchantId) AND " +
            "(:search IS NULL OR " +
            "    LOWER(CONCAT(COALESCE(i.templateCode,''), COALESCE(i.symbolCode,''))) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "    LOWER(i.invoiceNumber) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "    LOWER(i.buyerFullName) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "    LOWER(i.buyerTaxCode) LIKE LOWER(CONCAT('%', :search, '%'))" +
            ") " +
            "AND (:statusId IS NULL OR i.invoiceStatus.id = :statusId) " +
            "AND i.isDeleted = false")
    Page<EinvInvoiceMetadataEntity> findByFilters(
            @Param("merchantId") Long merchantId,
            @Param("search") String search,
            @Param("statusId") Integer statusId,
            Pageable pageable
    );

    @Query(value = "SELECT * FROM invoice_metadata " +
            "WHERE merchant_id = :merchantId AND status_id = 5 " +
            "ORDER BY issue_date DESC, created_at DESC LIMIT 1",
            nativeQuery = true)
    Optional<EinvInvoiceMetadataEntity> findLatestSuccessInvoice(@Param("merchantId") Long merchantId);

    boolean existsByLookupCode(String lookupCode);

    boolean existsByInvoiceTypeId(Long invoiceTypeId);
    boolean existsByInvoiceTypeCode(String invoiceTypeCode);

    boolean existsByStatusId(Integer statusId);

    boolean existsByPaymentMethodId(Long paymentMethodId);
    boolean existsByPaymentMethod(String paymentMethod);

    boolean existsByMerchantId(Long merchantId);
    boolean existsByProviderId(Long providerId);
    boolean existsByProviderConfigId(Long providerConfigId);

    boolean existsByTemplateId(Long templateId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvInvoicePayloadRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvInvoicePayloadEntity;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface EinvInvoicePayloadRepository extends JpaRepository<EinvInvoicePayloadEntity, Long>,
        JpaSpecificationExecutor<EinvInvoicePayloadEntity> {

    @EntityGraph(attributePaths = {"invoice"})
    Optional<EinvInvoicePayloadEntity> findByInvoiceId(Long invoiceId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvInvoiceRegistrationRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvInvoiceRegistrationEntity;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface EinvInvoiceRegistrationRepository extends JpaRepository<EinvInvoiceRegistrationEntity, Long>,
        JpaSpecificationExecutor<EinvInvoiceRegistrationEntity> {

    @EntityGraph(attributePaths = {"status"})
    List<EinvInvoiceRegistrationEntity> findByMerchantIdAndStatusIdOrderByEffectiveDateDesc(Long merchantId, Integer statusId);

    Optional<EinvInvoiceRegistrationEntity> findByRegistrationNumber(String registrationNumber);

    @Query(value = "SELECT * FROM invoice_registrations WHERE merchant_id = :merchantId " +
            "AND status_id = 1 ORDER BY effective_date DESC LIMIT 1", nativeQuery = true)
    Optional<EinvInvoiceRegistrationEntity> findLatestActiveRegistration(@Param("merchantId") Long merchantId);

    boolean existsByStatusId(Integer statusId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvInvoiceStatusRepository.java">
package com.einvoicehub.core.domain.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import com.einvoicehub.core.domain.entity.EinvInvoiceStatusEntity;

import java.util.Optional;
import java.util.List;

@Repository
public interface EinvInvoiceStatusRepository extends JpaRepository<EinvInvoiceStatusEntity, Integer>,
        JpaSpecificationExecutor<EinvInvoiceStatusEntity> {

    Optional<EinvInvoiceStatusEntity> findByName(String name);

    @Query("SELECT s FROM EinvInvoiceStatusEntity s WHERE " +
            "(:keyword IS NULL OR LOWER(s.name) LIKE LOWER(CONCAT('%', :keyword, '%')) OR " +
            "LOWER(s.description) LIKE LOWER(CONCAT('%', :keyword, '%')))")
    List<EinvInvoiceStatusEntity> searchByKeyword(@Param("keyword") String keyword);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvInvoiceSyncQueueRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvInvoiceSyncQueueEntity;
import com.einvoicehub.core.domain.entity.enums.SyncStatus;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface EinvInvoiceSyncQueueRepository extends JpaRepository<EinvInvoiceSyncQueueEntity, Long>,
        JpaSpecificationExecutor<EinvInvoiceSyncQueueEntity> {

    @EntityGraph(attributePaths = {"invoice"})
    Optional<EinvInvoiceSyncQueueEntity> findWithInvoiceById(Long id);

    List<EinvInvoiceSyncQueueEntity> findByStatusInOrderByPriorityAscCreatedAtAsc(List<SyncStatus> statuses);

    @Query("SELECT q FROM EinvInvoiceSyncQueueEntity q WHERE " +
            "(:status IS NULL OR q.status = :status) AND " +
            "(:search IS NULL OR LOWER(q.errorMessage) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "LOWER(q.processedBy) LIKE LOWER(CONCAT('%', :search, '%')))")
    Page<EinvInvoiceSyncQueueEntity> findByFilters(
            @Param("status") SyncStatus status,
            @Param("search") String search,
            Pageable pageable
    );

    @Query(value = "SELECT * FROM invoice_sync_queue " +
            "WHERE status = 'RETRYING' AND next_retry_at <= NOW() " +
            "ORDER BY priority ASC LIMIT :batchSize", nativeQuery = true)
    List<EinvInvoiceSyncQueueEntity> findReadyToRetry(@Param("batchSize") int batchSize);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvInvoiceTaxBreakdownRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvInvoiceTaxBreakDownEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface EinvInvoiceTaxBreakdownRepository extends JpaRepository<EinvInvoiceTaxBreakDownEntity, Long>,
        JpaSpecificationExecutor<EinvInvoiceTaxBreakDownEntity> {

    List<EinvInvoiceTaxBreakDownEntity> findByInvoiceId(Long invoiceId);

    @Modifying
    @Query("DELETE FROM EinvInvoiceTaxBreakDownEntity t WHERE t.invoice.id = :invoiceId")
    void deleteByInvoiceId(@Param("invoiceId") Long invoiceId);

    boolean existsByVatRateId(Long vateRateId);

}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvInvoiceTemplateRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvInvoiceTemplateEntity;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface EinvInvoiceTemplateRepository extends JpaRepository<EinvInvoiceTemplateEntity, Long>,
        JpaSpecificationExecutor<EinvInvoiceTemplateEntity> {

    @EntityGraph(attributePaths = {"invoiceType", "registration"})
    Optional<EinvInvoiceTemplateEntity> findWithDetailsById(Long id);

    Optional<EinvInvoiceTemplateEntity> findByMerchantIdAndTemplateCodeAndSymbolCode(Long merchantId, String templateCode, String symbolCode);

    @Query("SELECT t FROM EinvInvoiceTemplateEntity t WHERE t.merchant.id = :merchantId " +
            "AND t.isActive = true AND (:search IS NULL OR " +
            "LOWER(t.templateCode) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "LOWER(t.symbolCode) LIKE LOWER(CONCAT('%', :search, '%')))")
    List<EinvInvoiceTemplateEntity> searchTemplates(@Param("merchantId") Long merchantId, @Param("search") String search);

    @Query(value = "SELECT * FROM invoice_template WHERE merchant_id = :merchantId " +
            "AND is_active = 1 ORDER BY created_at DESC LIMIT 1", nativeQuery = true)
    Optional<EinvInvoiceTemplateEntity> findLatestTemplate(@Param("merchantId") Long merchantId);
    boolean existsByInvoiceTypeId(Long invoiceTypeId);
    boolean existsByRegistrationId(Long registrationId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvInvoiceTypeRepository.java">
package com.einvoicehub.core.domain.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import com.einvoicehub.core.domain.entity.EinvInvoiceTypeEntity;

import java.util.List;
import java.util.Optional;

@Repository
public interface EinvInvoiceTypeRepository extends JpaRepository<EinvInvoiceTypeEntity, Long>,
        JpaSpecificationExecutor<EinvInvoiceTypeEntity> {

    List<EinvInvoiceTypeEntity> findByIsActiveTrueOrderByDisplayOrderAsc();

    Optional<EinvInvoiceTypeEntity> findByTypeCode(String typeCode);

    @Query("SELECT t FROM EinvInvoiceTypeEntity t WHERE " +
            "(:search IS NULL OR LOWER(t.typeCode) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "LOWER(t.typeName) LIKE LOWER(CONCAT('%', :search, '%'))) " +
            "AND t.isActive = true " +
            "ORDER BY t.displayOrder ASC")
    List<EinvInvoiceTypeEntity> searchActiveTypes(@Param("search") String search);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvMerchantProviderConfigRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvMerchantProviderConfigEntity;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface EinvMerchantProviderConfigRepository extends JpaRepository<EinvMerchantProviderConfigEntity, Long>,
        JpaSpecificationExecutor<EinvMerchantProviderConfigEntity> {

    @EntityGraph(attributePaths = {"provider"})
    Optional<EinvMerchantProviderConfigEntity> findByMerchantIdAndIsDefaultTrueAndIsActiveTrue(Long merchantId);

    @Query("SELECT c FROM EinvMerchantProviderConfigEntity c WHERE " +
            "(:merchantId IS NULL OR c.merchant.id = :merchantId) AND " +
            "(:search IS NULL OR LOWER(c.taxCode) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "LOWER(c.partnerId) LIKE LOWER(CONCAT('%', :search, '%')))")
    List<EinvMerchantProviderConfigEntity> searchConfigs(@Param("merchantId") Long merchantId, @Param("search") String search);

    boolean existsByMerchantIdAndProviderId(Long merchantId, Long providerId);
    boolean existsByProviderId(Long providerId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvMerchantRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvMerchantEntity;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface EinvMerchantRepository extends JpaRepository<EinvMerchantEntity, Long>,
        JpaSpecificationExecutor<EinvMerchantEntity> {

    Optional<EinvMerchantEntity> findByTaxCode(String taxCode);

    boolean existsByTaxCodeAndIsDeletedFalse(String taxCode);

    @Query("SELECT m FROM EinvMerchantEntity m WHERE " +
            "(:search IS NULL OR LOWER(m.companyName) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "LOWER(m.taxCode) LIKE LOWER(CONCAT('%', :search, '%'))) " +
            "AND m.isDeleted = false")
    Page<EinvMerchantEntity> searchMerchants(@Param("search") String search, Pageable pageable);

    @Query(value = "SELECT * FROM merchants WHERE is_deleted = 0 ORDER BY created_at DESC LIMIT 1",
            nativeQuery = true)
    Optional<EinvMerchantEntity> findLatestMerchant();
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvMerchantUserRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvMerchantUserEntity;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface EinvMerchantUserRepository extends JpaRepository<EinvMerchantUserEntity, Long>,
        JpaSpecificationExecutor<EinvMerchantUserEntity> {

    @EntityGraph(attributePaths = {"merchant"})
    Optional<EinvMerchantUserEntity> findByUsername(String username);

    Optional<EinvMerchantUserEntity> findByEmail(String email);

    @Query("SELECT u FROM EinvMerchantUserEntity u WHERE u.merchant.id = :merchantId " +
            "AND (:search IS NULL OR LOWER(u.username) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "LOWER(u.fullName) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "LOWER(u.email) LIKE LOWER(CONCAT('%', :search, '%')))")
    Page<EinvMerchantUserEntity> findByMerchantAndFilters(
            @Param("merchantId") Long merchantId,
            @Param("search") String search,
            Pageable pageable);

    boolean existsByMerchantIdAndIsPrimaryTrue(Long merchantId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvPaymentMethodRepository.java">
package com.einvoicehub.core.domain.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import com.einvoicehub.core.domain.entity.EinvPaymentMethodEntity;

import java.util.List;
import java.util.Optional;

@Repository
public interface EinvPaymentMethodRepository extends JpaRepository<EinvPaymentMethodEntity, Long>,
        JpaSpecificationExecutor<EinvPaymentMethodEntity> {

    List<EinvPaymentMethodEntity> findByIsActiveTrueOrderByDisplayOrderAsc();

    Optional<EinvPaymentMethodEntity> findByMethodCode(String methodCode);

    List<EinvPaymentMethodEntity> findAllByIdIn(List<Long> ids);

    @Query("SELECT p FROM EinvPaymentMethodEntity p WHERE " +
            "(:search IS NULL OR LOWER(p.methodCode) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "LOWER(p.methodName) LIKE LOWER(CONCAT('%', :search, '%'))) " +
            "AND p.isActive = true")
    List<EinvPaymentMethodEntity> searchActiveMethods(@Param("search") String search);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvRegistrationStatusRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvRegistrationStatusEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface EinvRegistrationStatusRepository extends JpaRepository<EinvRegistrationStatusEntity, Integer>,
        JpaSpecificationExecutor<EinvRegistrationStatusEntity> {

    Optional<EinvRegistrationStatusEntity> findByName(String name);

    @Query("SELECT r FROM EinvRegistrationStatusEntity r WHERE " +
            "(:keyword IS NULL OR LOWER(r.name) LIKE LOWER(CONCAT('%', :keyword, '%')) OR " +
            "LOWER(r.description) LIKE LOWER(CONCAT('%', :keyword, '%')))")
    List<EinvRegistrationStatusEntity> searchByKeyword(@Param("keyword") String keyword);

    boolean existsById(Integer id);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvServiceProviderRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvServiceProviderEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface EinvServiceProviderRepository extends JpaRepository<EinvServiceProviderEntity, Long>,
        JpaSpecificationExecutor<EinvServiceProviderEntity> {
    Optional<EinvServiceProviderEntity> findByProviderCodeAndIsActiveTrue(String providerCode);

    List<EinvServiceProviderEntity> findByIsActiveTrueOrderByDisplayOrderAsc();

    Optional<EinvServiceProviderEntity> findByIsDefaultTrue();
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvSystemConfigRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvSystemConfigEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface EinvSystemConfigRepository extends JpaRepository<EinvSystemConfigEntity, Long>,
        JpaSpecificationExecutor<EinvSystemConfigEntity> {

    Optional<EinvSystemConfigEntity> findByConfigKey(String configKey);

    @Query(value = "SELECT config_value FROM system_config WHERE config_key = :key", nativeQuery = true)
    String getValueByKey(@Param("key") String key);

    boolean existsByConfigKeyAndIsEditableTrue(String configKey);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvTaxAuthorityResponseRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvTaxAuthorityResponseEntity;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface EinvTaxAuthorityResponseRepository extends JpaRepository<EinvTaxAuthorityResponseEntity, Long>,
        JpaSpecificationExecutor<EinvTaxAuthorityResponseEntity> {

    Optional<EinvTaxAuthorityResponseEntity> findByCqtCode(String cqtCode);

     //L·∫•y th√¥ng tin ph·∫£n h·ªìi k√®m d·ªØ li·ªáu h√≥a ƒë∆°n cha.
    @EntityGraph(attributePaths = {"invoice"})
    Optional<EinvTaxAuthorityResponseEntity> findByInvoiceId(Long invoiceId);

    @Query("SELECT r FROM EinvTaxAuthorityResponseEntity r WHERE " +
            "(:cqtCode IS NULL OR r.cqtCode = :cqtCode) AND " +
            "(:search IS NULL OR LOWER(r.errorMessage) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "LOWER(r.statusFromCqt) LIKE LOWER(CONCAT('%', :search, '%')))")
    Page<EinvTaxAuthorityResponseEntity> searchResponses(
            @Param("cqtCode") String cqtCode,
            @Param("search") String search,
            Pageable pageable
    );
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvVatRateRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvVatRateEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface EinvVatRateRepository extends JpaRepository<EinvVatRateEntity, Long>,
        JpaSpecificationExecutor<EinvVatRateEntity> {

    Optional<EinvVatRateEntity> findByRateCode(String rateCode);

    List<EinvVatRateEntity> findByIsActiveTrueOrderByDisplayOrderAsc();

    @Query("SELECT v FROM EinvVatRateEntity v WHERE " +
            "(:search IS NULL OR LOWER(v.rateCode) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "LOWER(v.rateName) LIKE LOWER(CONCAT('%', :search, '%'))) " +
            "AND v.isActive = true " +
            "ORDER BY v.displayOrder ASC")
    List<EinvVatRateEntity> searchActiveVatRates(@Param("search") String search);

    @Query(value = "SELECT * FROM vat_rates v WHERE v.is_active = 1 " +
            "ORDER BY v.rate_percent DESC LIMIT 1", nativeQuery = true)
    Optional<EinvVatRateEntity> findDefaultMaxTaxRate();
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/request/EinvInvoiceAdjustmentRequest.java">
package com.einvoicehub.core.dto.request;

import com.fasterxml.jackson.annotation.JsonProperty;
import jakarta.validation.constraints.*;
import lombok.*;
import java.math.BigDecimal;
import java.time.LocalDate;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceAdjustmentRequest {

    @NotNull(message = "ID h√≥a ƒë∆°n g·ªëc l√† b·∫Øt bu·ªôc")
    @JsonProperty("OriginalInvoiceID")
    private Long originalInvoiceId;

    @NotBlank(message = "Lo·∫°i ƒëi·ªÅu ch·ªânh (ADJUSTMENT, REPLACEMENT, CANCELLATION) l√† b·∫Øt bu·ªôc")
    @JsonProperty("AdjustmentType")
    private String adjustmentType;

    @NotBlank(message = "S·ªë bi√™n b·∫£n th·ªèa thu·∫≠n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @JsonProperty("AgreementNumber")
    private String agreementNumber;

    @NotNull(message = "Ng√†y l·∫≠p bi√™n b·∫£n l√† b·∫Øt bu·ªôc")
    @JsonProperty("AgreementDate")
    private LocalDate agreementDate;

    @JsonProperty("AgreementContent")
    private String agreementContent;

    @JsonProperty("Signers")
    private String signers; // Danh s√°ch ng∆∞·ªùi k√Ω (JSON String)

    @JsonProperty("ReasonCode")
    private String reasonCode;

    @NotBlank(message = "L√Ω do ƒëi·ªÅu ch·ªânh kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @JsonProperty("ReasonDescription")
    private String reasonDescription;

    @JsonProperty("OldSubtotalAmount")
    private BigDecimal oldSubtotalAmount;

    @JsonProperty("OldTaxAmount")
    private BigDecimal oldTaxAmount;

    @JsonProperty("OldTotalAmount")
    private BigDecimal oldTotalAmount;

    @JsonProperty("NewSubtotalAmount")
    private BigDecimal newSubtotalAmount;

    @JsonProperty("NewTaxAmount")
    private BigDecimal newTaxAmount;

    @JsonProperty("NewTotalAmount")
    private BigDecimal newTotalAmount;

    @JsonProperty("DifferenceAmount")
    private BigDecimal differenceAmount;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/request/EinvSubmitInvoiceDetailRequest.java">
package com.einvoicehub.core.dto.request;

import com.fasterxml.jackson.annotation.JsonProperty;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.PositiveOrZero;
import lombok.*;
import java.math.BigDecimal;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvSubmitInvoiceDetailRequest {

    @JsonProperty("ItemTypeID")
    private Integer itemTypeId;

    @JsonProperty("ItemCode")
    private String itemCode;

    @NotBlank(message = "T√™n h√†ng h√≥a kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @JsonProperty("ItemName")
    private String itemName;

    @JsonProperty("UnitName")
    private String unitName;

    @NotNull(message = "S·ªë l∆∞·ª£ng l√† b·∫Øt bu·ªôc")
    @PositiveOrZero
    @JsonProperty("Quantity")
    private BigDecimal quantity;

    @NotNull(message = "ƒê∆°n gi√° l√† b·∫Øt bu·ªôc")
    @PositiveOrZero
    @JsonProperty("Price")
    private BigDecimal price;

    @JsonProperty("GrossAmount")
    private BigDecimal grossAmount; //Qty * Price

    @JsonProperty("DiscountRate")
    private BigDecimal discountRate;

    @JsonProperty("DiscountAmount")
    private BigDecimal discountAmount;

    @NotNull(message = "ID lo·∫°i thu·∫ø l√† b·∫Øt bu·ªôc")
    @JsonProperty("TaxTypeID")
    private Long taxTypeId; // Mapping t·ªõi vat_rate_id

    @JsonProperty("TaxRate")
    private BigDecimal taxRate;

    @JsonProperty("TaxAmount")
    private BigDecimal taxAmount;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/request/EinvSubmitInvoiceRequest.java">
package com.einvoicehub.core.dto.request;

import com.fasterxml.jackson.annotation.JsonProperty;
import jakarta.validation.Valid;
import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotEmpty;
import jakarta.validation.constraints.NotNull;
import lombok.*;
import java.math.BigDecimal;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvSubmitInvoiceRequest {

    @NotBlank(message = "Lo·∫°i nghi·ªáp v·ª• (SubmitInvoiceType) l√† b·∫Øt bu·ªôc")
    @JsonProperty("SubmitInvoiceType")
    private String submitInvoiceType;

    @JsonProperty("PartnerInvoiceID")
    private String partnerInvoiceId;
    @NotNull(message = "ID lo·∫°i h√≥a ƒë∆°n l√† b·∫Øt bu·ªôc")
    @JsonProperty("InvoiceTypeID")
    private Long invoiceTypeId;

    @JsonProperty("InvoiceDate")
    private String invoiceDate;

    @JsonProperty("InvoiceForm")
    private String invoiceForm;

    @JsonProperty("InvoiceSeries")
    private String invoiceSeries;

    @NotNull(message = "Ph∆∞∆°ng th·ª©c thanh to√°n l√† b·∫Øt bu·ªôc")
    @JsonProperty("PaymentMethodID")
    private Long paymentMethodId; //

    @JsonProperty("BuyerTaxCode")
    private String buyerTaxCode;

    @JsonProperty("BuyerCompany")
    private String buyerCompany;

    @JsonProperty("BuyerName")
    private String buyerName;

    @JsonProperty("BuyerAddress")
    private String buyerAddress;

    @JsonProperty("BuyerIDNo")
    private String buyerIdNo;

    @JsonProperty("BuyerMobile")
    private String buyerMobile;

    @JsonProperty("BuyerBankAccount")
    private String buyerBankAccount;

    @JsonProperty("BuyerBankName")
    private String buyerBankName;

    @JsonProperty("BuyerBudgetCode")
    private String buyerBudgetCode;

    @Email(message = "Email nh·∫≠n h√≥a ƒë∆°n kh√¥ng h·ª£p l·ªá")
    @JsonProperty("ReceiverEmail")
    private String receiverEmail;

    @NotBlank(message = "M√£ ti·ªÅn t·ªá l√† b·∫Øt bu·ªôc")
    @JsonProperty("CurrencyCode")
    private String currencyCode;

    @NotNull(message = "T·ª∑ gi√° l√† b·∫Øt bu·ªôc")
    @JsonProperty("ExchangeRate")
    private BigDecimal exchangeRate;

    @JsonProperty("Notes")
    private String notes;

    @NotEmpty(message = "H√≥a ƒë∆°n ph·∫£i c√≥ √≠t nh·∫•t m·ªôt d√≤ng h√†ng")
    @Valid
    @JsonProperty("Details")
    private List<EinvSubmitInvoiceDetailRequest> details;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/response/EinvAuditLogResponse.java">
package com.einvoicehub.core.dto.response;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvAuditLogResponse {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("MerchantID")
    private Long merchantId;

    @JsonProperty("MerchantName")
    private String merchantName;

    @JsonProperty("UserID")
    private Long userId;

    @JsonProperty("UserName")
    private String userName;

    @JsonProperty("EntityType")
    private String entityType; // Invoice, Merchant, Config...

    @JsonProperty("EntityID")
    private Long entityId;

    @JsonProperty("Action")
    private String action;

    @JsonProperty("OldValue")
    private String oldValue; //old JSON

    @JsonProperty("NewValue")
    private String newValue; //new Json

    @JsonProperty("IpAddress")
    private String ipAddress;

    @JsonProperty("UserAgent")
    private String userAgent;

    @JsonProperty("RequestID")
    private String requestId;

    @JsonProperty("CreatedAt")
    private String createdAt;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/response/EinvInvoiceAdjustmentResponse.java">
package com.einvoicehub.core.dto.response;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;
import java.math.BigDecimal;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceAdjustmentResponse {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("OriginalInvoiceID")
    private Long originalInvoiceId;

    @JsonProperty("OriginalInvoiceNumber")
    private String originalInvoiceNumber;

    @JsonProperty("OriginalSymbolCode")
    private String originalSymbolCode;

    @JsonProperty("OriginalTemplateCode")
    private String originalTemplateCode;

    @JsonProperty("OriginalIssueDate")
    private String originalIssueDate;

    @JsonProperty("AdjustmentType")
    private String adjustmentType;

    @JsonProperty("AgreementNumber")
    private String agreementNumber;

    @JsonProperty("AgreementDate")
    private String agreementDate; // ƒê·ªãnh d·∫°ng dd/MM/yyyy theo SOFTZ

    @JsonProperty("ReasonDescription")
    private String reasonDescription;

    @JsonProperty("Status")
    private String status; // PENDING, APPROVED, REJECTED

    @JsonProperty("OldTotalAmount")
    private BigDecimal oldTotalAmount;

    @JsonProperty("NewTotalAmount")
    private BigDecimal newTotalAmount;

    @JsonProperty("DifferenceAmount")
    private BigDecimal differenceAmount;

    @JsonProperty("SubmittedToCqt")
    private Boolean submittedToCqt;

    @JsonProperty("CqtResponseCode")
    private String cqtResponseCode;

    @JsonProperty("CqtResponseMessage")
    private String cqtResponseMessage;

    @JsonProperty("ApprovedAt")
    private String approvedAt;

    @JsonProperty("CreatedAt")
    private String createdAt;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/response/EinvInvoiceMetadataResponse.java">
package com.einvoicehub.core.dto.response;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;
import java.math.BigDecimal;
import java.util.List;
import com.einvoicehub.core.dto.EinvInvoiceItemDto;
import com.einvoicehub.core.dto.EinvInvoiceTaxBreakdownDto;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceMetadataResponse {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("MerchantID")
    private Long merchantId;

    @JsonProperty("MerchantName")
    private String merchantName;

    @JsonProperty("StatusID")
    private Integer statusId;

    @JsonProperty("StatusName")
    private String statusName;

    @JsonProperty("StatusMessage")
    private String statusMessage;

    @JsonProperty("InvoiceNumber")
    private String invoiceNumber;

    @JsonProperty("SymbolCode")
    private String symbolCode;

    @JsonProperty("TemplateCode")
    private String templateCode;

    @JsonProperty("LookupCode")
    private String lookupCode;

    @JsonProperty("TaxAuthorityCode")
    private String taxAuthorityCode; // cqt_code trong SQL

    @JsonProperty("PartnerInvoiceID")
    private String partnerInvoiceId;

    @JsonProperty("PaymentMethod")
    private String paymentMethod;

    @JsonProperty("SellerName")
    private String sellerName;

    @JsonProperty("SellerTaxCode")
    private String sellerTaxCode;

    @JsonProperty("SellerAddress")
    private String sellerAddress;

    @JsonProperty("BuyerName")
    private String buyerName;

    @JsonProperty("BuyerTaxCode")
    private String buyerTaxCode;

    @JsonProperty("BuyerIdNo")
    private String buyerIdNo;

    @JsonProperty("BuyerFullName")
    private String buyerFullName;

    @JsonProperty("BuyerEmail")
    private String buyerEmail;

    @JsonProperty("BuyerPhone")
    private String buyerPhone;

    @JsonProperty("BuyerAddress")
    private String buyerAddress;

    @JsonProperty("BuyerBankAccount")
    private String buyerBankAccount;

    @JsonProperty("BuyerBankName")
    private String buyerBankName;

    @JsonProperty("SubtotalAmount")
    private BigDecimal subtotalAmount;

    @JsonProperty("TaxAmount")
    private BigDecimal taxAmount;

    @JsonProperty("DiscountAmount")
    private BigDecimal discountAmount;

    @JsonProperty("TotalAmount")
    private BigDecimal totalAmount;

    @JsonProperty("CurrencyCode")
    private String currencyCode;

    @JsonProperty("ExchangeRate")
    private BigDecimal exchangeRate;

    @JsonProperty("IssueDate")
    private String issueDate;

    @JsonProperty("SignedAt")
    private String signedAt;

    @JsonProperty("CreatedAt")
    private String createdAt;

    @JsonProperty("Items")
    private List<EinvInvoiceItemDto> items;

    @JsonProperty("TaxBreakdowns")
    private List<EinvInvoiceTaxBreakdownDto> taxBreakdowns;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/response/EinvInvoiceSyncQueueResponse.java">
package com.einvoicehub.core.dto.response;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceSyncQueueResponse {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("InvoiceID")
    private Long invoiceId;

    @JsonProperty("InvoiceNumber")
    private String invoiceNumber;

    @JsonProperty("SyncType")
    private String syncType;

    @JsonProperty("Priority")
    private Integer priority;

    @JsonProperty("Status")
    private String status; // PENDING, PROCESSING, COMPLETED, FAILED, RETRYING

    @JsonProperty("AttemptCount")
    private Integer attemptCount;

    @JsonProperty("MaxAttempts")
    private Integer maxAttempts;

    @JsonProperty("LastAttemptAt")
    private String lastAttemptAt;

    @JsonProperty("NextRetryAt")
    private String nextRetryAt;

    @JsonProperty("RequestData")
    private String requestData;

    @JsonProperty("ResponseData")
    private String responseData;

    @JsonProperty("ErrorCode")
    private String errorCode;

    @JsonProperty("ErrorMessage")
    private String errorMessage;

    @JsonProperty("ProcessedBy")
    private String processedBy;

    @JsonProperty("ProcessingStartedAt")
    private String processingStartedAt;

    @JsonProperty("ProcessingCompletedAt")
    private String processingCompletedAt;

    @JsonProperty("CreatedAt")
    private String createdAt;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/ApiResponse.java">
package com.einvoicehub.core.dto;

import com.einvoicehub.core.exception.ErrorCode;
import com.fasterxml.jackson.annotation.JsonInclude;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@JsonInclude(JsonInclude.Include.NON_NULL)
public class ApiResponse<T> {

    private ErrorCode code;

    private String message;

    private T result;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvApiCredentialDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvApiCredentialDto {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("MerchantID")
    private Long merchantId;

    @JsonProperty("MerchantName")
    private String merchantName;

    @JsonProperty("ClientID")
    private String clientId;

    @JsonProperty("ApiKeyPrefix")
    private String apiKeyPrefix;

    @JsonProperty("Scopes")
    private String scopes; // JSON array string

    @JsonProperty("IpWhitelist")
    private String ipWhitelist;

    @JsonProperty("RateLimitPerHour")
    private Integer rateLimitPerHour;

    @JsonProperty("RateLimitPerDay")
    private Integer rateLimitPerDay;

    @JsonProperty("RequestCountHour")
    private Integer requestCountHour;

    @JsonProperty("RequestCountDay")
    private Integer requestCountDay;

    @JsonProperty("RequestCountResettedAt")
    private String requestCountResettedAt;

    @JsonProperty("ExpiredAt")
    private String expiredAt;

    @JsonProperty("LastUsedAt")
    private String lastUsedAt;

    @JsonProperty("IsActive")
    private Boolean isActive;

    @JsonProperty("CreatedAt")
    private String createdAt;

    @JsonProperty("UpdatedAt")
    private String updatedAt;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvInvoiceItemDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;
import java.math.BigDecimal;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceItemDto {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("LineNumber")
    private Integer lineNumber;

    @JsonProperty("IsFree")
    private Boolean isFree;

    @JsonProperty("ProductCode")
    private String productCode;

    @JsonProperty("ProductName")
    private String productName;

    @JsonProperty("UnitName")
    private String unitName;

    @JsonProperty("Quantity")
    private BigDecimal quantity;

    @JsonProperty("UnitPrice")
    private BigDecimal unitPrice;

    @JsonProperty("GrossAmount")
    private BigDecimal grossAmount;

    @JsonProperty("DiscountRate")
    private BigDecimal discountRate;

    @JsonProperty("DiscountAmount")
    private BigDecimal discountAmount;

    @JsonProperty("TaxRate")
    private BigDecimal taxRate;

    @JsonProperty("TaxAmount")
    private BigDecimal taxAmount;

    @JsonProperty("TotalAmount")
    private BigDecimal totalAmount;

    @JsonProperty("Notes")
    private String notes;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvInvoicePayloadDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoicePayloadDto {
    @JsonProperty("InvoiceID")
    private Long invoiceId;

    @JsonProperty("RawData")
    private String rawData;

    @JsonProperty("XmlContent")
    private String xmlContent;

    @JsonProperty("JsonContent")
    private String jsonContent;

    @JsonProperty("SignedXml")
    private String signedXml;

    @JsonProperty("PdfData")
    private String pdfData;

    @JsonProperty("ExtraData")
    private String extraData;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvInvoiceRegistrationRequest.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import jakarta.validation.constraints.*;
import lombok.*;
import java.time.LocalDate;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceRegistrationRequest {

    @NotNull(message = "Merchant ID l√† b·∫Øt bu·ªôc")
    @JsonProperty("MerchantID")
    private Long merchantId;

    @NotBlank(message = "S·ªë quy·∫øt ƒë·ªãnh/ph√™ duy·ªát kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @Size(max = 50)
    @JsonProperty("RegistrationNumber")
    private String registrationNumber;

    @NotNull(message = "S·ªë b·∫Øt ƒë·∫ßu l√† b·∫Øt bu·ªôc")
    @Min(value = 1)
    @JsonProperty("FromNumber")
    private Long fromNumber;

    @NotNull(message = "S·ªë k·∫øt th√∫c l√† b·∫Øt bu·ªôc")
    @Min(value = 1)
    @JsonProperty("ToNumber")
    private Long toNumber;

    @NotNull(message = "S·ªë l∆∞·ª£ng h√≥a ƒë∆°n l√† b·∫Øt bu·ªôc")
    @Positive
    @JsonProperty("Quantity")
    private Long quantity;

    @NotNull(message = "Ng√†y hi·ªáu l·ª±c l√† b·∫Øt bu·ªôc")
    @JsonProperty("EffectiveDate")
    private LocalDate effectiveDate;

    @JsonProperty("ExpirationDate")
    private LocalDate expirationDate;

    @NotNull(message = "ID tr·∫°ng th√°i l√† b·∫Øt bu·ªôc")
    @JsonProperty("StatusID")
    private Integer statusId;

    @JsonProperty("IssuedBy")
    private String issuedBy;

    @JsonProperty("Note")
    private String note;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvInvoiceRegistrationResponse.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;
import java.time.LocalDate;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceRegistrationResponse {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("MerchantID")
    private Long merchantId;

    @JsonProperty("MerchantName")
    private String merchantName;

    @JsonProperty("RegistrationNumber")
    private String registrationNumber;

    @JsonProperty("FromNumber")
    private Long fromNumber;

    @JsonProperty("ToNumber")
    private Long toNumber;

    @JsonProperty("Quantity")
    private Long quantity;

    @JsonProperty("CurrentNumber")
    private Long currentNumber;

    @JsonProperty("EffectiveDate")
    private LocalDate effectiveDate;

    @JsonProperty("ExpirationDate")
    private LocalDate expirationDate;

    // --- Flattened Status Info ---
    @JsonProperty("StatusID")
    private Integer statusId;

    @JsonProperty("StatusName")
    private String statusName;

    @JsonProperty("IssuedBy")
    private String issuedBy;

    @JsonProperty("CreatedAt")
    private LocalDateTime createdAt;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvInvoiceStatusDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceStatusDto {
    @JsonProperty("ID")
    private Integer id;

    @JsonProperty("Name")
    private String name;

    @JsonProperty("Description")
    private String description;

    @JsonProperty("Note")
    private String note;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvInvoiceTaxBreakdownDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;
import java.math.BigDecimal;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceTaxBreakdownDto {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("VatRateCode")
    private String vatRateCode;

    @JsonProperty("VatRatePercent")
    private BigDecimal vatRatePercent;

    @JsonProperty("SubtotalAmount")
    private BigDecimal subtotalAmount;

    @JsonProperty("TaxableAmount")
    private BigDecimal taxableAmount;

    @JsonProperty("TaxAmount")
    private BigDecimal taxAmount;

    @JsonProperty("TotalAmount")
    private BigDecimal totalAmount;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvInvoiceTemplateRequest.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import jakarta.validation.constraints.*;
import lombok.*;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceTemplateRequest {

    @NotNull(message = "Merchant ID l√† b·∫Øt bu·ªôc")
    @JsonProperty("MerchantID")
    private Long merchantId;

    @NotNull(message = "Lo·∫°i h√≥a ƒë∆°n ID l√† b·∫Øt bu·ªôc")
    @JsonProperty("InvoiceTypeID")
    private Long invoiceTypeId;

    @JsonProperty("RegistrationID")
    private Long registrationId;

    @NotBlank(message = "M·∫´u h√≥a ƒë∆°n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @Size(max = 20)
    @JsonProperty("TemplateCode")
    private String templateCode;

    @NotBlank(message = "K√Ω hi·ªáu h√≥a ƒë∆°n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @Size(max = 10)
    @JsonProperty("SymbolCode")
    private String symbolCode;

    @JsonProperty("MinNumber")
    private Integer minNumber;

    @JsonProperty("MaxNumber")
    private Integer maxNumber;

    @JsonProperty("StartDate")
    private LocalDateTime startDate;

    @JsonProperty("IsActive")
    private Boolean isActive;

    @JsonProperty("ProviderID")
    private String providerId;

    @JsonProperty("ProviderSerialID")
    private String providerSerialId;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvInvoiceTemplateResponse.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceTemplateResponse {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("MerchantID")
    private Long merchantId;

    @JsonProperty("MerchantName")
    private String merchantName;

    @JsonProperty("InvoiceTypeID")
    private Long invoiceTypeId;

    @JsonProperty("InvoiceTypeName")
    private String invoiceTypeName;

    @JsonProperty("RegistrationID")
    private Long registrationId;

    @JsonProperty("RegistrationNumber")
    private String registrationNumber;

    @JsonProperty("TemplateCode")
    private String templateCode;

    @JsonProperty("SymbolCode")
    private String symbolCode;

    @JsonProperty("CurrentNumber")
    private Integer currentNumber;

    @JsonProperty("MinNumber")
    private Integer minNumber;

    @JsonProperty("MaxNumber")
    private Integer maxNumber;

    @JsonProperty("IsActive")
    private Boolean isActive;

    @JsonProperty("ProviderID")
    private String providerId;

    @JsonProperty("CreatedAt")
    private LocalDateTime createdAt;

    @JsonProperty("UpdatedAt")
    private LocalDateTime updatedAt;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvInvoiceTypeDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceTypeDto {
    @JsonProperty("ID")
    private Long id;

    @JsonProperty("TypeCode")
    private String typeCode;

    @JsonProperty("TypeName")
    private String typeName;

    @JsonProperty("Description")
    private String description;

    @JsonProperty("IsActive")
    private Boolean isActive;

    @JsonProperty("DisplayOrder")
    private Integer displayOrder;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvMerchantProviderConfigRequest.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Size;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvMerchantProviderConfigRequest {

    @NotNull(message = "Merchant ID l√† b·∫Øt bu·ªôc")
    @JsonProperty("MerchantID")
    private Long merchantId;

    @NotNull(message = "Provider ID l√† b·∫Øt bu·ªôc")
    @JsonProperty("ProviderID")
    private Long providerId;

    @JsonProperty("PartnerID")
    private String partnerId;

    @JsonProperty("PartnerToken")
    private String partnerToken;

    @NotBlank(message = "M√£ s·ªë thu·∫ø k·∫øt n·ªëi kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @Size(max = 20)
    @JsonProperty("TaxCode")
    private String taxCode;

    @JsonProperty("IntegrationUrl")
    private String integrationUrl;

    @NotBlank(message = "T√†i kho·∫£n d·ªãch v·ª• (Username) kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @JsonProperty("UsernameService")
    private String usernameService;

    @NotBlank(message = "M·∫≠t kh·∫©u d·ªãch v·ª• kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @JsonProperty("PasswordService")
    private String passwordService; // M·∫≠t kh·∫©u th√¥ ƒë·ªÉ Service x·ª≠ l√Ω m√£ h√≥a

    @JsonProperty("IsTestMode")
    private Boolean isTestMode;

    @JsonProperty("IsActive")
    private Boolean isActive;

    @JsonProperty("IsDefault")
    private Boolean isDefault;

    @JsonProperty("ExtraConfig")
    private String extraConfig; // D·ªØ li·ªáu JSON ƒë·ªÉ config
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvMerchantProviderConfigResponse.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvMerchantProviderConfigResponse {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("MerchantID")
    private Long merchantId;

    @JsonProperty("MerchantName")
    private String merchantName;

    @JsonProperty("MerchantTaxCode")
    private String merchantTaxCode;

    @JsonProperty("ProviderID")
    private Long providerId;

    @JsonProperty("ProviderCode")
    private String providerCode; // MISA, BKAV, MOBIFONE...

    @JsonProperty("ProviderName")
    private String providerName;

    @JsonProperty("PartnerID")
    private String partnerId;

    @JsonProperty("TaxCode")
    private String taxCode;

    @JsonProperty("IntegrationUrl")
    private String integrationUrl;

    @JsonProperty("UsernameService")
    private String usernameService;

    @JsonProperty("IsTestMode")
    private Boolean isTestMode;

    @JsonProperty("IsActive")
    private Boolean isActive;

    @JsonProperty("IsDefault")
    private Boolean isDefault;

    @JsonProperty("LastSyncAt")
    private LocalDateTime lastSyncAt;

    @JsonProperty("CreatedAt")
    private LocalDateTime createdAt;

    @JsonProperty("UpdatedAt")
    private LocalDateTime updatedAt;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvMerchantRequest.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import jakarta.validation.constraints.*;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvMerchantRequest {

    @NotBlank(message = "M√£ s·ªë thu·∫ø kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @Size(max = 20, message = "M√£ s·ªë thu·∫ø kh√¥ng qu√° 20 k√Ω t·ª±")
    @JsonProperty("TaxCode")
    private String taxCode;

    @NotBlank(message = "T√™n c√¥ng ty kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @Size(max = 255, message = "T√™n c√¥ng ty kh√¥ng qu√° 255 k√Ω t·ª±")
    @JsonProperty("CompanyName")
    private String companyName;

    @Size(max = 100)
    @JsonProperty("ShortName")
    private String shortName;

    @JsonProperty("Address")
    private String address;

    @Size(max = 100)
    @JsonProperty("District")
    private String district;

    @Size(max = 100)
    @JsonProperty("City")
    private String city;

    @Email(message = "Email kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng")
    @JsonProperty("Email")
    private String email;

    @Size(max = 20)
    @JsonProperty("Phone")
    private String phone;

    @JsonProperty("RepresentativeName")
    private String representativeName;

    @JsonProperty("RepresentativeTitle")
    private String representativeTitle;

    @Size(max = 10)
    @JsonProperty("TaxAuthorityCode")
    private String taxAuthorityCode;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvMerchantResponse.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvMerchantResponse {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("TaxCode")
    private String taxCode;

    @JsonProperty("CompanyName")
    private String companyName;

    @JsonProperty("ShortName")
    private String shortName;

    @JsonProperty("Address")
    private String address;

    @JsonProperty("City")
    private String city;

    @JsonProperty("Email")
    private String email;

    @JsonProperty("Phone")
    private String phone;

    @JsonProperty("RepresentativeName")
    private String representativeName;

    // --- Enterprise Shell Fields (SaaS Info) ---
    @JsonProperty("SubscriptionPlan")
    private String subscriptionPlan;

    @JsonProperty("InvoiceQuota")
    private Integer invoiceQuota;

    @JsonProperty("InvoiceUsed")
    private Integer invoiceUsed;

    @JsonProperty("IsUsingHsm")
    private Boolean isUsingHsm;

    @JsonProperty("CreatedAt")
    private String createdAt;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvMerchantUserRequest.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import jakarta.validation.constraints.*;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvMerchantUserRequest {

    @NotNull(message = "Merchant ID l√† b·∫Øt bu·ªôc")
    @JsonProperty("MerchantID")
    private Long merchantId;

    @NotBlank(message = "Username kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @Size(min = 4, max = 50)
    @JsonProperty("Username")
    private String username;

    @NotBlank(message = "Email kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @Email
    @JsonProperty("Email")
    private String email;

    /**
     * Trong Request g·ª≠i l√™n l√† m·∫≠t kh·∫©u th√¥ (Plain text),
     * sau ƒë√≥ Service s·∫Ω m√£ h√≥a th√†nh password_hash ƒë·ªÉ l∆∞u.
     */
    @NotBlank(message = "M·∫≠t kh·∫©u kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @Size(min = 8, message = "M·∫≠t kh·∫©u t·ªëi thi·ªÉu 8 k√Ω t·ª±")
    @JsonProperty("Password")
    private String password;

    @JsonProperty("FullName")
    private String fullName;

    @JsonProperty("Phone")
    private String phone;

    @JsonProperty("Role")
    private String role; // ADMIN, MANAGER, STAFF,VIEWER

    @JsonProperty("IsPrimary")
    private Boolean isPrimary;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvMerchantUserResponse.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvMerchantUserResponse {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("Username")
    private String username;

    @JsonProperty("Email")
    private String email;

    @JsonProperty("FullName")
    private String fullName;

    @JsonProperty("Phone")
    private String phone;

    @JsonProperty("Role")
    private String role;

    @JsonProperty("IsActive")
    private Boolean isActive;

    @JsonProperty("LastLoginAt")
    private String lastLoginAt;

    @JsonProperty("MerchantID")
    private Long merchantId;

    @JsonProperty("MerchantName")
    private String merchantName;

    @JsonProperty("MerchantTaxCode")
    private String merchantTaxCode;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvoiceHubRequest.java">
package com.einvoicehub.core.dto;

import jakarta.validation.Valid;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvoiceHubRequest<T> {

    private String requestDateTime;
    private String requestId;
    private String userAgent;
    @Valid
    private T data;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvoiceHubResponse.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonInclude;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvoiceHubResponse<T> {

    private String responseCode;
    private String requestId;
    private Integer status;

    @JsonInclude(JsonInclude.Include.NON_NULL)
    private String responseDesc;

    @JsonInclude(JsonInclude.Include.NON_NULL)
    private T data;

    public static <T> EinvoiceHubResponse<T> success(String requestId, T data) {
        return EinvoiceHubResponse.<T>builder()
                .responseCode("200")
                .requestId(requestId)
                .status(0)
                .data(data)
                .build();
    }

    public static <T> EinvoiceHubResponse<T> error(String requestId, String code, String message) {
        return EinvoiceHubResponse.<T>builder()
                .responseCode(code)
                .requestId(requestId)
                .status(1)
                .responseDesc(message)
                .build();
    }

    public static <T> EinvoiceHubResponse<T> badRequest(String requestId, String message) {
        return error(requestId, "400", message);
    }

    public static <T> EinvoiceHubResponse<T> internalError(String requestId, String message) {
        return error(requestId, "500", message);
    }

    public static <T> EinvoiceHubResponse<T> providerError(String requestId, String message) {
        return error(requestId, "502", message);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvPaymentMethodDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvPaymentMethodDto {
    @JsonProperty("ID")
    private Long id;

    @JsonProperty("MethodCode")
    private String methodCode;

    @JsonProperty("MethodName")
    private String methodName;

    @JsonProperty("Description")
    private String description;

    @JsonProperty("IsActive")
    private Boolean isActive;

    @JsonProperty("DisplayOrder")
    private Integer displayOrder;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvRegistrationStatusDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvRegistrationStatusDto {
    @JsonProperty("ID")
    private Integer id;

    @JsonProperty("Name")
    private String name;

    @JsonProperty("Description")
    private String description;

    @JsonProperty("Note")
    private String note;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvServiceProviderDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvServiceProviderDto {
    @JsonProperty("ID")
    private Long id;

    @JsonProperty("ProviderCode")
    private String providerCode; // MISA, BKAV, MOBIFONE...

    @JsonProperty("ProviderName")
    private String providerName;

    @JsonProperty("OfficialApiUrl")
    private String officialApiUrl;

    @JsonProperty("LookupUrl")
    private String lookupUrl;

    @JsonProperty("SupportEmail")
    private String supportEmail;

    @JsonProperty("SupportPhone")
    private String supportPhone;

    @JsonProperty("IsActive")
    private Boolean isActive;

    @JsonProperty("IsDefault")
    private Boolean isDefault;

    @JsonProperty("DisplayOrder")
    private Integer displayOrder;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvSystemConfigDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data @Builder @NoArgsConstructor @AllArgsConstructor
public class EinvSystemConfigDto {
    @JsonProperty("ID") private Long id;
    @JsonProperty("ConfigKey") private String configKey;
    @JsonProperty("ConfigValue") private String configValue;
    @JsonProperty("ConfigType") private String configType;
    @JsonProperty("Description") private String description;
    @JsonProperty("IsEncrypted") private Boolean isEncrypted;
    @JsonProperty("IsEditable") private Boolean isEditable;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvTaxAuthorityResponseDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;
import java.time.LocalDateTime;

@Data @Builder @NoArgsConstructor @AllArgsConstructor
public class EinvTaxAuthorityResponseDto {
    @JsonProperty("ID") private Long id;
    @JsonProperty("InvoiceID") private Long invoiceId;
    @JsonProperty("CqtCode") private String cqtCode;
    @JsonProperty("StatusFromCqt") private String statusFromCqt;
    @JsonProperty("ProcessingCode") private String processingCode;
    @JsonProperty("SignatureData") private String signatureData;
    @JsonProperty("RawResponse") private String rawResponse;
    @JsonProperty("ErrorCode") private String errorCode;
    @JsonProperty("ErrorMessage") private String errorMessage;
    @JsonProperty("ReceivedAt") private LocalDateTime receivedAt;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvVatRateDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;
import java.math.BigDecimal;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvVatRateDto {
    @JsonProperty("ID")
    private Long id;

    @JsonProperty("RateCode")
    private String rateCode;

    @JsonProperty("RatePercent")
    private BigDecimal ratePercent;

    @JsonProperty("RateName")
    private String rateName;

    @JsonProperty("Description")
    private String description;

    @JsonProperty("IsActive")
    private Boolean isActive;

    @JsonProperty("DisplayOrder")
    private Integer displayOrder;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/PaginationRequestDto.java">
package com.einvoicehub.core.dto;

import lombok.*;
import java.util.HashMap;
import java.util.Map;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class PaginationRequestDto {

    @Builder.Default
    private Integer offset = 0;
    @Builder.Default
    private Integer limit = 20;
    @Builder.Default
    private Map<String, Object> filters = new HashMap<>();
    private String sortField;
    @Builder.Default
    private String sortDirection = "desc";
    public int getPageNumber() {
        return limit == 0 ? 0 : (offset / limit);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/PaginationResponseDto.java">
package com.einvoicehub.core.dto;

import lombok.*;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class PaginationResponseDto<T> {
    private long offset;
    private long limit;
    private long total;
    private long count;
    private List<T> items;
}
</file>

<file path="src/main/java/com/einvoicehub/core/exception/AppException.java">
package com.einvoicehub.core.exception;

import lombok.Getter;
import java.util.Collections;
import java.util.Map;

@Getter
public class AppException extends RuntimeException {

    private final ErrorCode errorCode;
    private final Map<String, Object> details;

    public AppException(ErrorCode errorCode) {
        this(errorCode, errorCode.getMessage(), Collections.emptyMap());
    }

    public AppException(ErrorCode errorCode, String customMessage) {
        this(errorCode, customMessage, Collections.emptyMap());
    }

    public AppException(ErrorCode errorCode, Map<String, Object> details) {
        this(errorCode, errorCode.getMessage(), details);
    }

    public AppException(ErrorCode errorCode, String customMessage, Map<String, Object> details) {
        super(customMessage);
        this.errorCode = errorCode;
        this.details = details != null ? details : Collections.emptyMap();
    }

    /* Exception chaining support */
    public AppException(ErrorCode errorCode, Throwable cause) {
        super(errorCode.getMessage(), cause);
        this.errorCode = errorCode;
        this.details = Collections.emptyMap();
    }

    @Override
    public String toString() {
        return String.format("AppException[errorCode=%s, code=%d, message='%s']",
                errorCode.name(), errorCode.getCode(), getMessage());
    }


}
</file>

<file path="src/main/java/com/einvoicehub/core/exception/ErrorCode.java">
package com.einvoicehub.core.exception;

import com.fasterxml.jackson.annotation.JsonValue;
import lombok.Getter;
import org.springframework.http.HttpStatus;

import java.util.Map;
import java.util.Optional;
import java.util.function.Function;
import java.util.stream.Collectors;
import java.util.stream.Stream;

@Getter
public enum ErrorCode {
    SUCCESS(1000, "Th√†nh c√¥ng", HttpStatus.OK),
    UNCATEGORIZED_EXCEPTION(9999, "L·ªói h·ªá th·ªëng kh√¥ng x√°c ƒë·ªãnh", HttpStatus.INTERNAL_SERVER_ERROR),

    // Auth & Access
    UNAUTHORIZED(403, "Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p", HttpStatus.FORBIDDEN),
    UNAUTHENTICATED(401, "Ch∆∞a x√°c th·ª±c t√†i kho·∫£n", HttpStatus.UNAUTHORIZED),
    API_KEY_INVALID(1005, "API Key kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n", HttpStatus.UNAUTHORIZED),

    // Merchant Errors
    MERCHANT_NOT_FOUND(1001, "Kh√¥ng t√¨m th·∫•y doanh nghi·ªáp", HttpStatus.NOT_FOUND),
    INSUFFICIENT_QUOTA(1002, "Doanh nghi·ªáp ƒë√£ h·∫øt h·∫°n m·ª©c h√≥a ƒë∆°n", HttpStatus.FORBIDDEN),

    // Validation & Data Errors
    VALIDATION_ERROR(1003, "D·ªØ li·ªáu ƒë·∫ßu v√†o kh√¥ng h·ª£p l·ªá", HttpStatus.BAD_REQUEST),
    INVALID_DATA(1006, "D·ªØ li·ªáu nghi·ªáp v·ª• kh√¥ng h·ª£p l·ªá", HttpStatus.BAD_REQUEST), // Th√™m cho InvalidDataException

    // Invoice Business Errors
    TEMPLATE_NOT_FOUND(2001, "Kh√¥ng t√¨m th·∫•y m·∫´u h√≥a ƒë∆°n", HttpStatus.NOT_FOUND),
    REGISTRATION_EXPIRED(2002, "D·∫£i s·ªë h√≥a ƒë∆°n ƒë√£ h·∫øt h·∫°n", HttpStatus.BAD_REQUEST),
    REGISTRATION_EXHAUSTED(2003, "D·∫£i s·ªë h√≥a ƒë∆°n ƒë√£ d√πng h·∫øt", HttpStatus.BAD_REQUEST),

    PROVIDER_ERROR(1004, "L·ªói k·∫øt n·ªëi t·ª´ nh√† cung c·∫•p d·ªãch v·ª• (Provider)", HttpStatus.BAD_GATEWAY);

    private static final Map<Integer, ErrorCode> CACHE = Stream.of(values())
            .collect(Collectors.toMap(ErrorCode::getCode, Function.identity()));

    @JsonValue
    private final int code;
    private final String message;
    private final HttpStatus statusCode;

    ErrorCode(int code, String message, HttpStatus statusCode) {
        this.code = code;
        this.message = message;
        this.statusCode = statusCode;
    }

    public static Optional<ErrorCode> findByCode(int code) {
        return Optional.ofNullable(CACHE.get(code));
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/exception/GlobalExceptionHandler.java">
package com.einvoicehub.core.exception;

import com.einvoicehub.core.provider.exception.ProviderException;
import jakarta.validation.ConstraintViolationException;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.ResponseEntity;
import com.einvoicehub.core.dto.ApiResponse;
import org.springframework.http.converter.HttpMessageNotReadableException;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.web.HttpRequestMethodNotSupportedException;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.web.method.annotation.MethodArgumentTypeMismatchException;
import org.springframework.web.servlet.NoHandlerFoundException;

import java.util.LinkedHashMap;
import java.util.Map;

@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(AppException.class)
    public ResponseEntity<ApiResponse<?>> handleAppException(AppException ex) {
        log.warn("Business Exception: [{}] - {}", ex.getErrorCode().getCode(), ex.getMessage());
        return buildResponse(ex.getErrorCode(), ex.getMessage(), ex.getDetails());
    }

    @ExceptionHandler(ProviderException.class)
    public ResponseEntity<ApiResponse<?>> handleProviderException(ProviderException ex) {
        log.error("Provider Error [{}]: {} - Status: {}", ex.getProviderCode(), ex.getMessage(), ex.getStatusCode());

        ApiResponse<Map<String, Object>> response = ApiResponse.<Map<String, Object>>builder()
                .code(ErrorCode.PROVIDER_ERROR)
                .message(ex.getMessage())
                .result(ex.getDetails())
                .build();
        return ResponseEntity.status(ex.getStatusCode()).body(response);
    }

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ApiResponse<?>> handleValidation(MethodArgumentNotValidException ex) {
        Map<String, String> errors = new LinkedHashMap<>();
        ex.getBindingResult().getFieldErrors().forEach(error ->
                errors.put(error.getField(), error.getDefaultMessage())
        );

        ErrorCode errorCode = ErrorCode.VALIDATION_ERROR;
        try {
            String firstMsg = ex.getBindingResult().getFieldError().getDefaultMessage();
            if (firstMsg != null) errorCode = ErrorCode.valueOf(firstMsg);
        } catch (Exception ignored) {}

        log.warn("Validation Failed: {}", errors);
        return buildResponse(errorCode, errorCode.getMessage(), errors);
    }

    @ExceptionHandler(ConstraintViolationException.class)
    public ResponseEntity<ApiResponse<?>> handleConstraintViolation(ConstraintViolationException ex) {
        return buildResponse(ErrorCode.VALIDATION_ERROR, "Invalid parameter: " + ex.getMessage(), null);
    }

    @ExceptionHandler(AccessDeniedException.class)
    public ResponseEntity<ApiResponse<?>> handleAccessDenied(AccessDeniedException ex) {
        return buildResponse(ErrorCode.UNAUTHORIZED, "Access denied", null);
    }

    @ExceptionHandler(HttpMessageNotReadableException.class)
    public ResponseEntity<ApiResponse<?>> handleInvalidJson(HttpMessageNotReadableException ex) {
        return buildResponse(ErrorCode.VALIDATION_ERROR, "Invalid JSON format", null);
    }

    @ExceptionHandler(MethodArgumentTypeMismatchException.class)
    public ResponseEntity<ApiResponse<?>> handleTypeMismatch(MethodArgumentTypeMismatchException ex) {
        String msg = String.format("Parameter '%s' has an invalid data type", ex.getName());
        return buildResponse(ErrorCode.VALIDATION_ERROR, msg, null);
    }

    @ExceptionHandler(NoHandlerFoundException.class)
    public ResponseEntity<ApiResponse<?>> handleNotFound(NoHandlerFoundException ex) {
        return buildResponse(ErrorCode.VALIDATION_ERROR, "API endpoint not found: " + ex.getRequestURL(), null);
    }

    @ExceptionHandler(HttpRequestMethodNotSupportedException.class)
    public ResponseEntity<ApiResponse<?>> handleMethodNotAllowed(HttpRequestMethodNotSupportedException ex) {
        return buildResponse(ErrorCode.VALIDATION_ERROR, "HTTP method not supported", null);
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<ApiResponse<?>> handleGenericException(Exception ex) {
        log.error("CRITICAL SYSTEM ERROR: ", ex);
        return buildResponse(ErrorCode.UNCATEGORIZED_EXCEPTION, ErrorCode.UNCATEGORIZED_EXCEPTION.getMessage(), null);
    }

    private ResponseEntity<ApiResponse<?>> buildResponse(ErrorCode errorCode, String message, Object result) {
        ApiResponse<?> response = ApiResponse.builder()
                .code(errorCode)
                .message(message)
                .result(result)
                .build();
        return ResponseEntity.status(errorCode.getStatusCode()).body(response);
    }


}
</file>

<file path="src/main/java/com/einvoicehub/core/exception/InsufficientQuotaException.java">
package com.einvoicehub.core.exception;

import lombok.Getter;


@Getter
public class InsufficientQuotaException extends AppException {
    public InsufficientQuotaException(String message) {
        super(ErrorCode.INSUFFICIENT_QUOTA);
    }

}
</file>

<file path="src/main/java/com/einvoicehub/core/exception/InvalidDataException.java">
package com.einvoicehub.core.exception;

import lombok.Getter;

@Getter
public class InvalidDataException extends AppException {

    public InvalidDataException(String message) {
        super(ErrorCode.INVALID_DATA, message);
    }

    public InvalidDataException(ErrorCode errorCode) {
        super(errorCode);
    }

    public InvalidDataException(ErrorCode errorCode, String customMessage) {
        super(errorCode, customMessage);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/exception/MerchantNotFoundException.java">
package com.einvoicehub.core.exception;

import lombok.Getter;
import org.springframework.http.HttpStatus;

/**
 * Exception khi kh√¥ng t√¨m th·∫•y Merchant.
 */
@Getter
public class MerchantNotFoundException extends AppException {
    private final String errorCode = "MERCHANT_NOT_FOUND";
    private final HttpStatus status = HttpStatus.NOT_FOUND;

    public MerchantNotFoundException(String merchantCode) {
        super(ErrorCode.MERCHANT_NOT_FOUND);     }
}
</file>

<file path="src/main/java/com/einvoicehub/core/mapper/EinvHubMapper.java">
package com.einvoicehub.core.mapper;

import com.einvoicehub.core.domain.entity.*;
import com.einvoicehub.core.dto.*;
import com.einvoicehub.core.dto.request.*;
import com.einvoicehub.core.dto.response.*;
import org.mapstruct.*;

import java.util.List;

@Mapper(componentModel = "spring", unmappedTargetPolicy = ReportingPolicy.IGNORE)
public interface EinvHubMapper {

    //  1. Catalog
    EinvInvoiceTypeDto toDto(EinvInvoiceTypeEntity entity);
    EinvInvoiceTypeEntity toEntity(EinvInvoiceTypeDto dto);
    EinvInvoiceStatusDto toDto(EinvInvoiceStatusEntity entity);
    EinvInvoiceStatusEntity toEntity(EinvInvoiceStatusDto dto);
    EinvPaymentMethodDto toDto(EinvPaymentMethodEntity entity);
    EinvPaymentMethodEntity toEntity(EinvPaymentMethodDto dto);
    EinvVatRateDto toDto(EinvVatRateEntity entity);
    EinvVatRateEntity toEntity(EinvVatRateDto dto);
    EinvRegistrationStatusDto toDto(EinvRegistrationStatusEntity entity);
    EinvRegistrationStatusEntity toEntity(EinvRegistrationStatusDto dto);
    EinvServiceProviderDto toDto(EinvServiceProviderEntity entity);
    EinvServiceProviderEntity toEntity(EinvServiceProviderDto dto);
    EinvInvoicePayloadDto toDto(EinvInvoicePayloadEntity entity);
    EinvInvoicePayloadEntity toEntity(EinvInvoicePayloadDto dto);
    EinvSystemConfigDto toDto(EinvSystemConfigEntity entity);
    EinvSystemConfigEntity toEntity(EinvSystemConfigDto dto);

    EinvTaxAuthorityResponseDto toDto(EinvTaxAuthorityResponseEntity entity);
    EinvTaxAuthorityResponseEntity toEntity(EinvTaxAuthorityResponseDto dto);
    EinvInvoiceSyncQueueResponse toDto(EinvInvoiceSyncQueueEntity entity);
    EinvInvoiceSyncQueueEntity toEntity(EinvInvoiceSyncQueueResponse dto);

    //  2. Merchant & User
    EinvMerchantEntity toEntity(EinvMerchantRequest request);
    EinvMerchantResponse toResponse(EinvMerchantEntity entity);
    EinvMerchantUserEntity toEntity(EinvMerchantUserRequest request);
    @Mapping(source = "merchant.id", target = "merchantId")
    @Mapping(source = "merchant.companyName", target = "merchantName")
    @Mapping(source = "merchant.taxCode", target = "merchantTaxCode")
    EinvMerchantUserResponse toResponse(EinvMerchantUserEntity entity);

    //  3. Config & Registration
    EinvMerchantProviderConfigEntity toEntity(EinvMerchantProviderConfigRequest request);
    @Mapping(source = "merchant.companyName", target = "merchantName")
    @Mapping(source = "provider.providerName", target = "providerName")
    @Mapping(source = "provider.providerCode", target = "providerCode")
    EinvMerchantProviderConfigResponse toResponse(EinvMerchantProviderConfigEntity entity);

    EinvInvoiceRegistrationEntity toEntity(EinvInvoiceRegistrationRequest request);
    @Mapping(source = "merchant.companyName", target = "merchantName")
    @Mapping(source = "status.name", target = "statusName")
    EinvInvoiceRegistrationResponse toResponse(EinvInvoiceRegistrationEntity entity);

    EinvInvoiceTemplateEntity toEntity(EinvInvoiceTemplateRequest request);
    @Mapping(source = "merchant.companyName", target = "merchantName")
    @Mapping(source = "invoiceType.typeName", target = "invoiceTypeName")
    @Mapping(source = "registration.registrationNumber", target = "registrationNumber")
    EinvInvoiceTemplateResponse toResponse(EinvInvoiceTemplateEntity entity);

    //  4. Transactions
    EinvInvoiceMetadataEntity toEntity(EinvSubmitInvoiceRequest request);
    EinvInvoiceItemEntity toEntity(EinvSubmitInvoiceDetailRequest request);
    EinvInvoiceItemEntity toEntity(EinvInvoiceItemDto dto);

    @Mapping(source = "merchant.companyName", target = "merchantName")
    @Mapping(source = "invoiceStatus.name", target = "statusName")
    @Mapping(source = "invoiceStatus.note", target = "statusMessage")
    @Mapping(source = "paymentMethodEntity.methodName", target = "paymentMethod")
    EinvInvoiceMetadataResponse toResponse(EinvInvoiceMetadataEntity entity);

    EinvInvoiceItemDto toDto(EinvInvoiceItemEntity entity);
    List<EinvInvoiceItemDto> toItemDtoList(List<EinvInvoiceItemEntity> entities);

    EinvInvoiceTaxBreakdownDto toDto(EinvInvoiceTaxBreakDownEntity entity);
    List<EinvInvoiceTaxBreakdownDto> toTaxDtoList(List<EinvInvoiceTaxBreakDownEntity> entities);

    //  5. Adjustment & Operationss
    EinvInvoiceAdjustmentsEntity toEntity(EinvInvoiceAdjustmentRequest request);
    @Mapping(source = "originalInvoice.invoiceNumber", target = "originalInvoiceNumber")
    @Mapping(source = "originalInvoice.symbolCode", target = "originalSymbolCode")
    EinvInvoiceAdjustmentResponse toResponse(EinvInvoiceAdjustmentsEntity entity);

    @Mapping(source = "merchant.companyName", target = "merchantName")
    @Mapping(source = "user.username", target = "userName")
    EinvAuditLogResponse toResponse(EinvAuditLogsEntity entity);

    @Mapping(source = "invoice.invoiceNumber", target = "invoiceNumber")
    EinvInvoiceSyncQueueResponse toResponse(EinvInvoiceSyncQueueEntity entity);

    @Mapping(source = "merchant.companyName", target = "merchantName")
    EinvApiCredentialDto toDto(EinvApiCredentialsEntity entity);
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/bkav/BkavAdapter.java">
package com.einvoicehub.core.provider.bkav;

import com.einvoicehub.core.domain.enums.InvoiceStatus;
import com.einvoicehub.core.provider.*;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;
import org.springframework.web.reactive.function.client.WebClient;

import javax.crypto.Cipher;
import javax.crypto.spec.GCMParameterSpec;
import javax.crypto.spec.SecretKeySpec;
import java.nio.charset.StandardCharsets;
import java.security.SecureRandom;
import java.time.Duration;
import java.util.*;

@Slf4j
@Service("BKAV")
public class BkavAdapter implements InvoiceProvider {

    private final WebClient webClient;
    private final BkavApiMapper apiMapper;
    private final ObjectMapper objectMapper;

    @Value("${provider.bkav.timeout-ms:30000}")
    private int timeoutMs;

    @Value("${provider.bkav.encryption-key:}")
    private String encryptionKey;

    public BkavAdapter(WebClient.Builder webClientBuilder,
                       BkavApiMapper apiMapper,
                       ObjectMapper objectMapper,
                       @Value("${provider.bkav.base-url:https://einvoice.bkav.com/api/v1}") String baseUrl) {
        this.webClient = webClientBuilder.baseUrl(baseUrl)
                .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)
                .build();
        this.apiMapper = apiMapper;
        this.objectMapper = objectMapper;
    }

    @Override public String getProviderCode() { return "BKAV"; }
    @Override public String getProviderName() { return "Bkav eInvoice"; }
    @Override public boolean isAvailable() { return true; }

    @Override
    public InvoiceResponse issueInvoice(InvoiceRequest request, ProviderConfig config) {
        log.info("BKAV: Issuing invoice for ClientID: {}", request.getClientRequestId());
        try {
            BkavCommandPayload payload = apiMapper.toBkavPayload(request);
            String encryptedData = encryptPayload(payload);

            BkavApiResponse response = callBkavApi(encryptedData, config);
            return apiMapper.toHubResponse(response, request.getClientRequestId());
        } catch (Exception e) {
            log.error("BKAV Issuance failed: {}", e.getMessage());
            return InvoiceResponse.builder()
                    .status(InvoiceResponse.ResponseStatus.FAILED)
                    .errorMessage("Issuance error: " + e.getMessage())
                    .build();
        }
    }

    @Override
    public InvoiceStatus getInvoiceStatus(String invoiceNumber, ProviderConfig config) {
        try {
            BkavCommandPayload payload = BkavCommandPayload.builder()
                    .cmdType(850)
                    .commandObject(invoiceNumber)
                    .build();

            BkavApiResponse response = callBkavApi(encryptPayload(payload), config);
            return (response != null) ? apiMapper.mapBkavStatus(response) : InvoiceStatus.FAILED;
        } catch (Exception e) {
            log.error("BKAV status check failed for {}: {}", invoiceNumber, e.getMessage());
            return InvoiceStatus.FAILED;
        }
    }

    @Override
    public InvoiceResponse cancelInvoice(String invoiceNumber, String reason, ProviderConfig config) {
        try {
            BkavCommandPayload payload = BkavCommandPayload.builder()
                    .cmdType(201)
                    .commandObject(List.of(Map.of("InvoiceGUID", invoiceNumber, "Reason", reason)))
                    .build();

            BkavApiResponse response = callBkavApi(encryptPayload(payload), config);
            return apiMapper.toHubResponse(response, null);
        } catch (Exception e) {
            return InvoiceResponse.builder()
                    .status(InvoiceResponse.ResponseStatus.FAILED)
                    .errorMessage(e.getMessage())
                    .build();
        }
    }

    @Override
    public InvoiceResponse replaceInvoice(String oldNo, InvoiceRequest newReq, ProviderConfig config) {
        try {
            BkavCommandPayload payload = apiMapper.toBkavPayload(newReq);
            payload.setCmdType(120);

            if (payload.getCommandObject() instanceof List<?> list && !list.isEmpty()) {
                Map<String, Object> invoice = (Map<String, Object>) list.get(0);
                invoice.put("OriginalInvoiceIdentify", String.format("[1]_[%s]_[%s]",
                        invoice.getOrDefault("InvoiceSerial", ""), formatInvoiceNo(oldNo)));
            }

            BkavApiResponse response = callBkavApi(encryptPayload(payload), config);
            return apiMapper.toHubResponse(response, newReq.getClientRequestId());
        } catch (Exception e) {
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage(e.getMessage()).build();
        }
    }

    @Override
    public String getInvoicePdf(String invoiceNumber, ProviderConfig config) {
        try {
            BkavCommandPayload payload = BkavCommandPayload.builder()
                    .cmdType(816)
                    .commandObject(List.of(Map.of("PartnerInvoiceID", invoiceNumber, "PartnerInvoiceStringID", "")))
                    .build();

            BkavApiResponse response = callBkavApi(encryptPayload(payload), config);
            return (response != null) ? response.getCode() : null;
        } catch (Exception e) { return null; }
    }

    @Override
    public String getInvoiceXml(String invoiceNumber, ProviderConfig config) {
        try {
            BkavCommandPayload payload = BkavCommandPayload.builder()
                    .cmdType(817)
                    .commandObject(List.of(Map.of("PartnerInvoiceID", invoiceNumber, "PartnerInvoiceStringID", "")))
                    .build();

            BkavApiResponse response = callBkavApi(encryptPayload(payload), config);
            return (response != null && response.getObject() != null) ? response.getObject().toString() : null;
        } catch (Exception e) {
            log.error("BKAV: Failed to fetch XML for {}", invoiceNumber);
            return null;
        }
    }

    @Override public String authenticate(ProviderConfig config) { return config.getUsername(); }
    @Override public boolean testConnection(ProviderConfig config) { return true; }

    /* Helper to call BKAV API with standardized headers */
    private BkavApiResponse callBkavApi(String encryptedData, ProviderConfig config) {
        return webClient.post().uri("/exec-command")
                .header("PartnerGUID", config.getUsername())
                .header("PartnerToken", config.getPassword())
                .bodyValue(Map.of("CommandData", encryptedData))
                .retrieve()
                .bodyToMono(BkavApiResponse.class)
                .timeout(Duration.ofMillis(timeoutMs))
                .block();
    }

    private String encryptPayload(BkavCommandPayload payload) throws Exception {
        String jsonData = objectMapper.writeValueAsString(payload);
        if (!StringUtils.hasText(encryptionKey)) return jsonData;

        SecretKeySpec secretKey = new SecretKeySpec(encryptionKey.getBytes(StandardCharsets.UTF_8), "AES");
        byte[] iv = new byte[12];
        new SecureRandom().nextBytes(iv);

        Cipher cipher = Cipher.getInstance("AES/GCM/NoPadding");
        cipher.init(Cipher.ENCRYPT_MODE, secretKey, new GCMParameterSpec(128, iv));
        byte[] encrypted = cipher.doFinal(jsonData.getBytes(StandardCharsets.UTF_8));

        return Base64.getEncoder().encodeToString(iv) + ":" + Base64.getEncoder().encodeToString(encrypted);
    }

    private String formatInvoiceNo(String no) {
        try { return String.format("%08d", Integer.parseInt(no)); } catch (Exception e) { return no; }
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class BkavCommandPayload { private int cmdType; private Object commandObject; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class BkavApiResponse {
        private int status;
        private Object object;
        private boolean isOk, isError;
        private String code;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/bkav/BkavApiMapper.java">
package com.einvoicehub.core.provider.bkav;

import com.einvoicehub.core.domain.enums.InvoiceStatus;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;

@Slf4j
@Component
@RequiredArgsConstructor
public class BkavApiMapper {

    private final ObjectMapper objectMapper;

    public BkavAdapter.BkavCommandPayload toBkavPayload(InvoiceRequest request) {
        List<Map<String, Object>> details = request.getItems().stream()
                .map(this::convertToBkavDetail)
                .toList();

        Map<String, Object> invoice = new LinkedHashMap<>();
        invoice.put("InvoiceTypeID", getInvoiceTypeId(request));

        LocalDateTime issueTime = request.getIssueDate() != null ?
                request.getIssueDate().atStartOfDay() : LocalDateTime.now();
        invoice.put("InvoiceDate", issueTime.format(DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ss.SSSXXX")));

        invoice.put("BuyerName", request.getBuyer() != null ? request.getBuyer().getName() : "");
        invoice.put("BuyerTaxCode", (request.getBuyer() != null && StringUtils.hasText(request.getBuyer().getTaxCode())) ?
                request.getBuyer().getTaxCode() : "");
        invoice.put("BuyerUnitName", request.getBuyer() != null ? request.getBuyer().getName() : "");
        invoice.put("BuyerAddress", request.getBuyer() != null ? request.getBuyer().getAddress() : "");
        invoice.put("PayMethodID", 3);
        invoice.put("ReceiveTypeID", 3);
        invoice.put("ReceiverEmail", request.getBuyer() != null ? request.getBuyer().getEmail() : "");
        invoice.put("CurrencyID", (request.getSummary() != null && StringUtils.hasText(request.getSummary().getCurrencyCode())) ?
                request.getSummary().getCurrencyCode() : "VND");
        invoice.put("ExchangeRate", 1.0);

        if (request.getExtraConfig() != null) {
            Optional.ofNullable(request.getExtraConfig().get("InvoiceForm")).ifPresent(v -> invoice.put("InvoiceForm", v));
            Optional.ofNullable(request.getExtraConfig().get("InvoiceSerial")).ifPresent(v -> invoice.put("InvoiceSerial", v));
        }

        invoice.put("InvoiceNo", 0);

        Map<String, Object> wrapper = new LinkedHashMap<>();
        wrapper.put("Invoice", invoice);
        wrapper.put("ListInvoiceDetailsWS", details);
        wrapper.put("ListInvoiceAttachFileWS", Collections.emptyList());
        wrapper.put("PartnerInvoiceID", request.getInvoiceMetadataId() != null ? request.getInvoiceMetadataId() : System.currentTimeMillis());

        int cmdType = (request.getExtraConfig() != null && request.getExtraConfig().containsKey("CmdType")) ?
                (Integer) request.getExtraConfig().get("CmdType") : 111;

        return BkavAdapter.BkavCommandPayload.builder()
                .cmdType(cmdType)
                .commandObject(List.of(wrapper))
                .build();
    }

    private Map<String, Object> convertToBkavDetail(InvoiceRequest.InvoiceItem item) {
        Map<String, Object> detail = new LinkedHashMap<>();
        detail.put("ItemName", item.getItemName());
        detail.put("UnitName", item.getUnitName() != null ? item.getUnitName() : "");
        detail.put("Qty", item.getQuantity());
        detail.put("Price", item.getUnitPrice());
        detail.put("Amount", item.getAmount());
        detail.put("TaxRateID", mapTaxRateToBkavId(item.getTaxRate()));
        detail.put("TaxRate", item.getTaxRate());
        detail.put("TaxAmount", item.getTaxAmount() != null ? item.getTaxAmount() : BigDecimal.ZERO);
        detail.put("ItemTypeID", 0);
        return detail;
    }

    public InvoiceResponse toHubResponse(BkavAdapter.BkavApiResponse response, String clientRequestId) {
        if (response == null) {
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage("No response from provider").build();
        }

        boolean isSuccess = response.isOk() && !response.isError();
        return InvoiceResponse.builder()
                .clientRequestId(clientRequestId)
                .status(isSuccess ? InvoiceResponse.ResponseStatus.SUCCESS : InvoiceResponse.ResponseStatus.FAILED)
                .errorCode(String.valueOf(response.getStatus()))
                .errorMessage(isSuccess ? null : extractField(response, "MessLog"))
                .transactionCode(extractField(response, "InvoiceGUID"))
                .invoiceNumber(extractField(response, "InvoiceNo"))
                .symbolCode(extractField(response, "InvoiceSerial"))
                .lookupCode(extractField(response, "MTC"))
                .pdfUrl(extractField(response, "MessLog"))
                .responseTime(LocalDateTime.now())
                .rawResponse(response)
                .build();
    }

    public InvoiceStatus mapBkavStatus(BkavAdapter.BkavApiResponse response) {
        try {
            JsonNode node = objectMapper.readTree(objectMapper.writeValueAsString(response.getObject()));
            if (node.isArray() && !node.isEmpty()) {
                int bkavStatus = node.get(0).path("BkavStatus").asInt();
                int taxStatus = node.get(0).path("TaxStatus").asInt();

                return switch (bkavStatus) {
                    case 1, 11 -> InvoiceStatus.SIGNING;
                    case 2 -> (taxStatus == 33) ? InvoiceStatus.SUCCESS : InvoiceStatus.SENT_TO_PROVIDER;
                    case 3 -> InvoiceStatus.CANCELLED;
                    case 6 -> InvoiceStatus.REPLACED;
                    case 8 -> InvoiceStatus.SUCCESS;
                    default -> InvoiceStatus.FAILED;
                };
            }
        } catch (Exception e) { log.error("BKAV status mapping failed"); }
        return InvoiceStatus.FAILED;
    }

    private String extractField(BkavAdapter.BkavApiResponse response, String field) {
        try {
            JsonNode node = objectMapper.readTree(objectMapper.writeValueAsString(response.getObject()));
            if (node.isArray() && !node.isEmpty()) return node.get(0).path(field).asText();
        } catch (Exception ignored) {}
        return null;
    }

    private int getInvoiceTypeId(InvoiceRequest request) {
        return (request.getExtraConfig() != null && request.getExtraConfig().get("InvoiceTypeID") instanceof Integer id) ? id : 1;
    }

    private int mapTaxRateToBkavId(BigDecimal taxRate) {
        if (taxRate == null) return 1;
        double rate = taxRate.doubleValue();
        if (rate == 5) return 2;
        if (rate == 10) return 3;
        if (rate == -1) return 4;
        return 1;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/exception/ProviderException.java">
package com.einvoicehub.core.provider.exception;

import lombok.Getter;
import java.time.LocalDateTime;
import java.util.Collections;
import java.util.Map;

@Getter
public class ProviderException extends RuntimeException {
    private final String providerCode;
    private final String errorCode;
    private final int statusCode;
    private final boolean retryable;
    private final LocalDateTime timestamp;
    private final Map<String, Object> details;

    public ProviderException(String message, String providerCode, String errorCode) {
        this(message, providerCode, errorCode, 500, false, null, null);
    }

    public ProviderException(String message, String providerCode, String errorCode, int statusCode) {
        this(message, providerCode, errorCode, statusCode, false, null, null);
    }

    public ProviderException(String message, String providerCode, String errorCode,
                             int statusCode, boolean retryable,
                             Map<String, Object> details, Throwable cause) {
        super(message, cause);
        this.providerCode = providerCode;
        this.errorCode = errorCode;
        this.statusCode = statusCode;
        this.retryable = retryable;
        this.details = details != null ? details : Collections.emptyMap();
        this.timestamp = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/misa/MisaAdapter.java">
package com.einvoicehub.core.provider.misa;

import com.einvoicehub.core.domain.enums.InvoiceStatus;
import com.einvoicehub.core.provider.*;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.reactive.function.client.WebClient;

import java.math.BigDecimal;
import java.time.Duration;
import java.time.LocalDateTime;
import java.util.*;

@Slf4j
@Service("MISA")
public class MisaAdapter implements InvoiceProvider {

    private final WebClient webClient;
    private final MisaApiMapper apiMapper;
    private final ObjectMapper objectMapper;

    @Value("${provider.misa.base-url:https://api.meinvoice.vn/api/integration}")
    private String baseUrl;

    private String cachedToken;
    private LocalDateTime tokenExpiry;

    public MisaAdapter(WebClient.Builder webClientBuilder, MisaApiMapper apiMapper, ObjectMapper objectMapper) {
        this.webClient = webClientBuilder.build();
        this.apiMapper = apiMapper;
        this.objectMapper = objectMapper;
    }

    @Override public String getProviderCode() { return "MISA"; }
    @Override public String getProviderName() { return "MISA MeInvoice"; }

    @Override
    public InvoiceResponse issueInvoice(InvoiceRequest request, ProviderConfig config) {
        log.info("MISA: Processing issuance for ClientRequestID: {}", request.getClientRequestId());
        try {
            String token = getOrRefreshToken(config);
            MisaInvoicePayload payload = apiMapper.toMisaPayload(request);

            /* Default SignType: 2 (HSM) */
            Map<String, Object> body = Map.of("SignType", 2, "InvoiceData", List.of(payload));

            MisaApiResponse response = webClient.post()
                    .uri(config.getCustomApiUrl() != null ? config.getCustomApiUrl() + "/invoice" : baseUrl + "/invoice")
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + token)
                    .bodyValue(body)
                    .retrieve()
                    .bodyToMono(MisaApiResponse.class)
                    .timeout(Duration.ofSeconds(30))
                    .block();

            return apiMapper.toHubResponse(response, request.getClientRequestId());
        } catch (Exception e) {
            log.error("MISA: Issuance failed: {}", e.getMessage());
            return InvoiceResponse.builder()
                    .status(InvoiceResponse.ResponseStatus.FAILED)
                    .errorMessage("MISA issuance error: " + e.getMessage())
                    .build();
        }
    }

    @Override
    public InvoiceStatus getInvoiceStatus(String transactionId, ProviderConfig config) {
        try {
            String token = getOrRefreshToken(config);
            MultiValueMap<String, String> params = new LinkedMultiValueMap<>();
            params.add("invoiceWithCode", "true");
            params.add("inputType", "1");

            MisaApiResponse response = webClient.post()
                    .uri(uriBuilder -> uriBuilder.path(baseUrl + "/invoice/status").queryParams(params).build())
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + token)
                    .bodyValue(List.of(transactionId))
                    .retrieve()
                    .bodyToMono(MisaApiResponse.class)
                    .block();

            if (response != null && response.getData() instanceof List<?> dataList && !dataList.isEmpty()) {
                Map<?, ?> dataMap = (Map<?, ?>) dataList.get(0);
                return apiMapper.mapMisaStatus((Integer) dataMap.get("EInvoiceStatus"));
            }
        } catch (Exception e) {
            log.error("MISA: Status check failed for TransactionID {}: {}", transactionId, e.getMessage());
        }
        return InvoiceStatus.FAILED;
    }

    @Override
    public String getInvoiceXml(String invoiceGuid, ProviderConfig config) {
        log.info("MISA: Requesting XML for InvoiceGUID: {}", invoiceGuid);
        try {
            String token = getOrRefreshToken(config);
            MisaApiResponse response = webClient.post()
                    .uri(baseUrl + "/invoice/export-xml")
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + token)
                    .bodyValue(Map.of("InvoiceGUID", invoiceGuid))
                    .retrieve()
                    .bodyToMono(MisaApiResponse.class)
                    .block();

            return (response != null && response.getData() != null) ? response.getData().toString() : null;
        } catch (Exception e) {
            log.error("MISA: XML export failed: {}", e.getMessage());
            return null;
        }
    }

    @Override
    public String authenticate(ProviderConfig config) {
        Map<String, Object> authReq = Map.of(
                "appid", config.getAppId() != null ? config.getAppId() : config.getUsername(),
                "taxcode", config.getUsername(),
                "username", config.getUsername(),
                "password", config.getPassword()
        );
        try {
            Map<?, ?> res = webClient.post()
                    .uri(baseUrl + "/auth/token")
                    .bodyValue(authReq)
                    .retrieve()
                    .bodyToMono(Map.class)
                    .block();

            return (res != null && res.get("Data") != null) ? res.get("Data").toString() : null;
        } catch (Exception e) {
            log.error("MISA: Authentication failed for taxcode {}: {}", config.getUsername(), e.getMessage());
            return null;
        }
    }

    private synchronized String getOrRefreshToken(ProviderConfig config) {
        if (cachedToken != null && tokenExpiry != null && tokenExpiry.isAfter(LocalDateTime.now().plusMinutes(5))) {
            return cachedToken;
        }
        String token = authenticate(config);
        if (token != null) {
            cachedToken = token;
            tokenExpiry = LocalDateTime.now().plusDays(7);
            return token;
        }
        throw new RuntimeException("MISA: Unable to obtain access token");
    }

    @Override public InvoiceResponse cancelInvoice(String no, String r, ProviderConfig c) { return null; }
    @Override public InvoiceResponse replaceInvoice(String o, InvoiceRequest n, ProviderConfig c) { return null; }
    @Override public String getInvoicePdf(String n, ProviderConfig c) { return null; }
    @Override public boolean isAvailable() { return true; }
    @Override public boolean testConnection(ProviderConfig c) { return authenticate(c) != null; }

    /* MISA Specific Data Models */
    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class MisaInvoicePayload {
        private String refId, invSeries, invDate, currencyCode, paymentMethodName, buyerLegalName, buyerTaxCode, buyerAddress, buyerFullName, buyerPhoneNumber, buyerEmail, totalAmountInWords;
        private BigDecimal exchangeRate, totalSaleAmountOC, totalSaleAmount, totalAmountOC, totalAmount, totalVATAmountOC;
        private boolean isInvoiceSummary;
        private List<MisaInvoiceDetail> originalInvoiceDetail;
        private List<MisaTaxRateInfo> taxRateInfo;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class MisaInvoiceDetail {
        private Integer itemType, sortOrder, lineNumber;
        private String itemName, unitName, vatRateName;
        private BigDecimal quantity, unitPrice, amountOC, amount, discountAmountOC, discountAmount, vatAmountOC, vatAmount;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class MisaTaxRateInfo {
        private String vatRateName;
        private BigDecimal amountWithoutVATOC, vatAmountOC;
    }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class MisaApiResponse {
        private Boolean success;
        private String errorCode, descriptionErrorCode;
        private List<Map<String, Object>> publishInvoiceResult;
        private Object data;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/misa/MisaApiMapper.java">
package com.einvoicehub.core.provider.misa;

import com.einvoicehub.core.domain.enums.InvoiceStatus;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;

@Slf4j
@Component
@RequiredArgsConstructor
public class MisaApiMapper {

    public MisaAdapter.MisaInvoicePayload toMisaPayload(InvoiceRequest request) {
        List<MisaAdapter.MisaInvoiceDetail> details = request.getItems().stream()
                .map(this::convertToMisaDetail)
                .toList();

        MisaAdapter.MisaInvoicePayload payload = MisaAdapter.MisaInvoicePayload.builder()
                .refId(UUID.randomUUID().toString())
                .invSeries(getInvSeries(request))
                .invDate(request.getIssueDate() != null ?
                        request.getIssueDate().format(DateTimeFormatter.ISO_DATE) :
                        LocalDateTime.now().format(DateTimeFormatter.ISO_DATE))
                .currencyCode(StringUtils.hasText(getCurrency(request)) ? getCurrency(request) : "VND")
                .exchangeRate(BigDecimal.ONE)
                .paymentMethodName("TM/CK")
                .isInvoiceSummary(false)
                .buyerLegalName(request.getBuyer() != null ? request.getBuyer().getName() : "")
                .buyerTaxCode(request.getBuyer() != null ? request.getBuyer().getTaxCode() : "")
                .buyerAddress(request.getBuyer() != null ? request.getBuyer().getAddress() : "")
                .buyerFullName(request.getBuyer() != null ? request.getBuyer().getName() : "")
                .buyerPhoneNumber(request.getBuyer() != null ? request.getBuyer().getPhone() : "")
                .buyerEmail(request.getBuyer() != null ? request.getBuyer().getEmail() : "")
                .originalInvoiceDetail(details)
                .taxRateInfo(buildTaxRateInfo(details))
                .build();

        calculateTotals(payload);
        return payload;
    }

    private void calculateTotals(MisaAdapter.MisaInvoicePayload payload) {
        BigDecimal totalSaleAmount = BigDecimal.ZERO;
        BigDecimal totalVatAmount = BigDecimal.ZERO;

        for (MisaAdapter.MisaInvoiceDetail detail : payload.getOriginalInvoiceDetail()) {
            totalSaleAmount = totalSaleAmount.add(detail.getAmountOC() != null ? detail.getAmountOC() : BigDecimal.ZERO);
            totalVatAmount = totalVatAmount.add(detail.getVatAmountOC() != null ? detail.getVatAmountOC() : BigDecimal.ZERO);
        }

        BigDecimal totalAmount = totalSaleAmount.add(totalVatAmount);

        payload.setTotalSaleAmountOC(totalSaleAmount.setScale(2, RoundingMode.HALF_UP));
        payload.setTotalSaleAmount(totalSaleAmount.setScale(2, RoundingMode.HALF_UP));
        payload.setTotalAmountOC(totalAmount.setScale(2, RoundingMode.HALF_UP));
        payload.setTotalAmount(totalAmount.setScale(2, RoundingMode.HALF_UP));
        payload.setTotalVATAmountOC(totalVatAmount.setScale(2, RoundingMode.HALF_UP));
        payload.setTotalAmountInWords(convertNumberToWords(totalAmount));
    }

    private MisaAdapter.MisaInvoiceDetail convertToMisaDetail(InvoiceRequest.InvoiceItem item) {
        BigDecimal qty = item.getQuantity() != null ? item.getQuantity() : BigDecimal.ONE;
        BigDecimal price = item.getUnitPrice() != null ? item.getUnitPrice() : BigDecimal.ZERO;
        BigDecimal amount = qty.multiply(price).setScale(2, RoundingMode.HALF_UP);
        BigDecimal taxRate = item.getTaxRate() != null ? item.getTaxRate() : BigDecimal.ZERO;
        BigDecimal vatAmount = amount.multiply(taxRate).divide(BigDecimal.valueOf(100), 2, RoundingMode.HALF_UP);

        return MisaAdapter.MisaInvoiceDetail.builder()
                .itemType(1).sortOrder(1).lineNumber(1)
                .itemName(item.getItemName())
                .unitName(item.getUnitName() != null ? item.getUnitName() : "")
                .quantity(qty.setScale(2, RoundingMode.HALF_UP))
                .unitPrice(price.setScale(2, RoundingMode.HALF_UP))
                .amountOC(amount).amount(amount)
                .vatAmountOC(vatAmount).vatAmount(vatAmount)
                .vatRateName(taxRate.stripTrailingZeros().toPlainString() + "%")
                .discountAmountOC(BigDecimal.ZERO).discountAmount(BigDecimal.ZERO)
                .build();
    }

    private List<MisaAdapter.MisaTaxRateInfo> buildTaxRateInfo(List<MisaAdapter.MisaInvoiceDetail> details) {
        Map<String, MisaAdapter.MisaTaxRateInfo> taxMap = new LinkedHashMap<>();
        for (MisaAdapter.MisaInvoiceDetail detail : details) {
            taxMap.computeIfAbsent(detail.getVatRateName(), k -> MisaAdapter.MisaTaxRateInfo.builder()
                    .vatRateName(k).amountWithoutVATOC(BigDecimal.ZERO).vatAmountOC(BigDecimal.ZERO).build());
            MisaAdapter.MisaTaxRateInfo info = taxMap.get(detail.getVatRateName());
            info.setAmountWithoutVATOC(info.getAmountWithoutVATOC().add(detail.getAmountOC()));
            info.setVatAmountOC(info.getVatAmountOC().add(detail.getVatAmountOC()));
        }
        return new ArrayList<>(taxMap.values());
    }

    /* Vietnamese Number-to-Words for invoice legality */
    public String convertNumberToWords(BigDecimal amount) {
        try {
            long wholePart = amount.longValue();
            if (wholePart == 0) return "Kh√¥ng ƒë·ªìng.";
            return convertWholeNumberToWords(wholePart) + " ƒë·ªìng.";
        } catch (Exception e) { return "Invalid amount"; }
    }

    private String convertWholeNumberToWords(long number) {
        String[] units = {"", "ngh√¨n", "tri·ªáu", "t·ª∑"};
        String result = "";
        int idx = 0;
        while (number > 0) {
            long group = number % 1000;
            if (group > 0) result = convertGroupToWords((int) group) + " " + units[idx] + " " + result;
            number /= 1000;
            idx++;
        }
        return result.trim();
    }

    private String convertGroupToWords(int n) {
        String[] digits = {"kh√¥ng", "m·ªôt", "hai", "ba", "b·ªën", "nƒÉm", "s√°u", "b·∫£y", "t√°m", "ch√≠n"};
        String[] tens = {"", "m∆∞·ªùi", "hai m∆∞∆°i", "ba m∆∞∆°i", "b·ªën m∆∞∆°i", "nƒÉm m∆∞∆°i", "s√°u m∆∞∆°i", "b·∫£y m∆∞∆°i", "t√°m m∆∞∆°i", "ch√≠n m∆∞∆°i"};
        int h = n / 100, r = n % 100;
        String res = (h > 0) ? digits[h] + " trƒÉm " : "";
        if (r > 0) {
            if (r < 10) res += "l·∫ª " + digits[r];
            else if (r < 20) res += "m∆∞·ªùi " + (r % 10 == 5 ? "lƒÉm" : digits[r % 10]);
            else res += tens[r / 10] + (r % 10 == 5 ? " lƒÉm" : (r % 10 > 0 ? " " + digits[r % 10] : ""));
        }
        return res.trim();
    }

    public InvoiceResponse toHubResponse(MisaAdapter.MisaApiResponse misaResponse, String requestId) {
        if (misaResponse == null) return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage("Provider timeout").build();

        boolean isSuccess = Boolean.TRUE.equals(misaResponse.getSuccess());
        InvoiceResponse.InvoiceResponseBuilder builder = InvoiceResponse.builder()
                .clientRequestId(requestId)
                .status(isSuccess ? InvoiceResponse.ResponseStatus.SUCCESS : InvoiceResponse.ResponseStatus.FAILED)
                .errorCode(misaResponse.getErrorCode())
                .errorMessage(misaResponse.getDescriptionErrorCode())
                .responseTime(LocalDateTime.now())
                .rawResponse(misaResponse);

        if (isSuccess && misaResponse.getPublishInvoiceResult() != null && !misaResponse.getPublishInvoiceResult().isEmpty()) {
            Map<String, Object> res = misaResponse.getPublishInvoiceResult().get(0);
            builder.transactionCode((String) res.get("TransactionID"))
                    .invoiceNumber((String) res.get("InvNo"))
                    .symbolCode((String) res.get("InvSeries"))
                    .lookupCode((String) res.get("TransactionID"));
        }
        return builder.build();
    }

    public InvoiceStatus mapMisaStatus(int status) {
        return switch (status) {
            case 1 -> InvoiceStatus.SUCCESS;
            case 2 -> InvoiceStatus.CANCELLED;
            case 3, 7 -> InvoiceStatus.REPLACED;
            default -> InvoiceStatus.FAILED;
        };
    }

    private String getInvSeries(InvoiceRequest r) { return (r.getExtraConfig() != null) ? (String) r.getExtraConfig().getOrDefault("InvSeries", "") : ""; }
    private String getCurrency(InvoiceRequest r) { return (r.getSummary() != null) ? r.getSummary().getCurrencyCode() : "VND"; }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/constant/MobifoneApiEndpoints.java">
package vn.softz.app.einvoicehub.provider.mobifone.constant;

public class MobifoneApiEndpoints {
    
    // Authentication
    public static final String LOGIN = "/api/Account/Login";
    
    // System
    public static final String GET_DATA_REFERENCES = "/api/System/GetDataReferencesByRefId";
    
    // Invoice - Create/Update
    public static final String SAVE_INVOICE = "/api/Invoice68/SaveListHoadon78";
    public static final String SAVE_INVOICE_MTT = "/api/Invoice68/SaveListHoadon78MTT";
    public static final String SAVE_AND_SIGN_INVOICE = "/api/Invoice68/SaveAndSignHoadon78";
    
    // Invoice - Sign
    public static final String SIGN_INVOICE = "/api/Invoice68/SignInvoiceCertFile68";
    public static final String SIGN_INVOICE_HSM = "/api/Invoice68/SignListInvoiceCertFile_HSM";
    public static final String SEND_TO_CQT = "/api/Invoice68/SendInvoiceToCQT68";
    public static final String GET_CERTIFICATES = "/api/Invoice68/GetListCertificatesFile68";
    
    // Invoice - Query
    public static final String GET_INVOICE_BY_ID = "/api/Invoice68/GetById";
    public static final String GET_INVOICE_BY_FKEY = "/api/Invoice68/GetHoadonFkey";
    public static final String GET_INVOICE_PDF = "/api/Invoice68/inHoadon";
    public static final String GET_INVOICE_XML = "/api/Invoice68/ExportXMLHoadon";
    public static final String GET_INVOICE_LIST_BY_DATE = "/api/Invoice68/GetInvoiceFromdateTodate";
    public static final String GET_INVOICE_LIST_BY_TIME_UNIT = "/api/Invoice68/GetInvoiceByTimeAndUnit";
    public static final String GET_INVOICE_IDS_BY_DATE = "/api/Invoice68/GetListInvoiceIdFromdateTodate";
    public static final String GET_INVOICE_HISTORY = "/api/Invoice68/GetHistoryInvoice";
    public static final String GET_PENDING_INVOICES = "/api/Invoice68/GetDataInvoiceListChoKy";
    
    // Invoice - Delete
    public static final String DELETE_UNSIGNED_INVOICE = "/api/Invoice68/hoadonXoaNhieu";
    public static final String CANCEL_NO_CODE_INVOICE = "/api/Invoice68/uploadCanceledInv";
    
    // Error Notification (TBSS)
    public static final String SAVE_ERROR_NOTIFICATION = "/api/Invoice68/huyhoadonSave";
    public static final String DELETE_ERROR_NOTIFICATION = "/api/Invoice68/deleteMau04";
    public static final String SIGN_ERROR_NOTIFICATION = "/api/Invoice/huyhoadonSign";
    public static final String GET_ERROR_NOTIFICATION_PDF = "/api/Invoice68/inMau04";
    public static final String GET_ERROR_NOTIFICATION_XML = "/api/Invoice68/XmlMau0405";
    public static final String SAVE_ERROR_NOTIFICATION_XML = "/api/Invoice68/SaveXmlMau0405";
    
    // Plugin Sign
    public static final String EXPORT_XML_PRETREATMENT = "/api/Invoice68/ExportInvoiceXmlPretreatment";
    public static final String SAVE_XML_PRETREATMENT = "/api/Invoice68/SaveXmlPretreatment";
    
    // Email
    public static final String SEND_EMAIL = "/api/Invoice68/AutoSendInvoiceByEmail";
    
    // Print Multiple
    public static final String PRINT_INVOICES = "/api/Invoice68/InDanhSachHoaDon";
    
    // Reports
    public static final String GET_SALES_REPORT = "/api/Invoice/GetDSHoaDonBangKeBanRa";
    public static final String GET_DETAIL_REPORT = "/api/Invoice/GetDSHoaDonBangKeBanRaChiTiet";
    
    // Response messages
    public static final String GET_RESPONSE_MESSAGE = "/api/Invoice68/GetResponseMessage";
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/constant/MobifoneInvoiceStatus.java">
package vn.softz.app.einvoicehub.provider.mobifone.constant;

public class MobifoneInvoiceStatus {
    
    // Invoice status (tthdon)
    public static final int ORIGINAL = 0;
    public static final int EXPLANATION = 1;
    public static final int REPLACEMENT = 2;
    public static final int CANCELLED = 3;
    public static final int REVIEW = 4;
    public static final int ADJUSTMENT = 5;
    public static final int PENDING_ADJUSTMENT = 7;
    public static final int ADJUSTED = 11;
    public static final int PENDING_CANCEL = 13;
    public static final int PENDING_REPLACEMENT = 15;
    public static final int REPLACED = 17;
    public static final int ADJUSTMENT_INCREASE = 19;
    public static final int ADJUSTMENT_DECREASE = 21;
    public static final int ADJUSTMENT_INFO = 23;
    
    // CQT status (tthai)
    public static final String STATUS_WAITING_SIGN = "Ch·ªù k√Ω";
    public static final String STATUS_SIGNED = "ƒê√£ k√Ω";
    public static final String STATUS_WAITING_CODE = "Ch·ªù c·∫•p m√£";
    public static final String STATUS_INVALID_FORMAT = "TBSS sai ƒë·ªãnh d·∫°ng";
    public static final String STATUS_CODE_DENIED = "CQT Kh√¥ng c·∫•p m√£";
    public static final String STATUS_WAITING_RESPONSE = "Ch·ªù ph·∫£n h·ªìi";
    public static final String STATUS_NOT_ACCEPTED = "CQT kh√¥ng ti·∫øp nh·∫≠n Hƒê";
    public static final String STATUS_ACCEPT_TBSS = "Ch·∫•p nh·∫≠n TBSS";
    public static final String STATUS_SENT = "ƒê√£ g·ª≠i";
    public static final String STATUS_RECEIVED = "CQT ƒë√£ nh·∫≠n";
    public static final String STATUS_CODE_GRANTED = "ƒê√£ c·∫•p m√£";
    public static final String STATUS_REJECT_TBSS = "Kh√¥ng ch·∫•p nh·∫≠n TBSS";
    
    // Item type (kmai)
    public static final int ITEM_GOODS_SERVICE = 1;
    public static final int ITEM_PROMOTION = 2;
    public static final int ITEM_DISCOUNT = 3;
    public static final int ITEM_NOTE = 4;
    public static final int ITEM_SPECIAL = 5;
    
    // Tax rate (tsuat)
    public static final String TAX_RATE_10 = "10";
    public static final String TAX_RATE_8 = "8";
    public static final String TAX_RATE_5 = "5";
    public static final String TAX_RATE_0 = "0";
    public static final String TAX_RATE_NOT_SUBJECT = "-1";
    public static final String TAX_RATE_NOT_DECLARED = "-2";
    
    // Edit mode
    public static final int EDIT_MODE_CREATE = 1;
    public static final int EDIT_MODE_UPDATE = 2;
    public static final int EDIT_MODE_DELETE = 3;
    
    // Type command (type_cmd)
    public static final String TYPE_CMD_WITH_CODE = "200";
    public static final String TYPE_CMD_NO_CODE = "203";
    public static final String TYPE_CMD_MTT = "206";
    
    // Error notification type (tctbao)
    public static final String TBSS_CANCEL = "1";
    public static final String TBSS_REPLACE = "3";
    public static final String TBSS_EXPLANATION = "4";
    public static final String TBSS_ADJUST_INCREASE = "5";
    public static final String TBSS_ADJUST_DECREASE = "6";
    public static final String TBSS_ADJUST_OTHER = "7";
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/mapper/MobifoneDataMapper.java">
package vn.softz.app.einvoicehub.provider.mobifone.mapper;

import org.springframework.stereotype.Component;
import vn.softz.app.einvoicehub.domain.entity.EinvStoreProviderEntity;
import vn.softz.app.einvoicehub.domain.repository.EinvStoreProviderRepository;
import vn.softz.app.einvoicehub.provider.mobifone.constant.MobifoneInvoiceStatus;
import vn.softz.app.einvoicehub.provider.mobifone.model.*;
import vn.softz.app.einvoicehub.provider.model.InvoiceData;
import vn.softz.app.einvoicehub.provider.model.InvoiceDetailData;
import vn.softz.app.einvoicehub.provider.model.InvoiceResult;
import vn.softz.core.common.Common;

import java.math.BigDecimal;
import java.time.Instant;
import java.time.ZoneId;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;

@Component
public class MobifoneDataMapper {
    
    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd")
            .withZone(ZoneId.systemDefault());
    
    private final EinvStoreProviderRepository storeProviderRepository;
    
    public MobifoneDataMapper(EinvStoreProviderRepository storeProviderRepository) {
        this.storeProviderRepository = storeProviderRepository;
    }

    private EinvStoreProviderEntity getConfig() {
        String storeId = Common.getCurrentUser().map(u -> u.getLocId()).orElse(null);
        return storeProviderRepository.findByStoreId(storeId)
                .orElseThrow(() -> new RuntimeException("Ch∆∞a c·∫•u h√¨nh HƒêƒêT cho c·ª≠a h√†ng n√†y"));
    }
    
    public MobifoneInvoiceRequest toMobifoneInvoiceRequest(InvoiceData invoiceData) {
        return MobifoneInvoiceRequest.builder()
                .editmode(MobifoneInvoiceStatus.EDIT_MODE_CREATE)
                .taxCode(getConfig().getTaxCode())
                .data(List.of(toMobifoneInvoiceData(invoiceData)))
                .build();
    }
    
    public MobifoneInvoiceData toMobifoneInvoiceData(InvoiceData invoiceData) {
        var config = getConfig();
        
        return MobifoneInvoiceData.builder()
                .cctbaoId(invoiceData.getProviderSerialId()) 
                .nlap(formatDate(invoiceData.getInvoiceDate()))
                .dvtte(invoiceData.getCurrencyCode() != null ? invoiceData.getCurrencyCode() : "VND")
                .tgia(invoiceData.getExchangeRate() != null ? invoiceData.getExchangeRate() : BigDecimal.ONE)
                .htttoan(truncate(getPaymentMethodName(invoiceData.getPayMethodId()), 50))
                .mnmua(truncate(invoiceData.getPartnerInvoiceStringId(), 30))
                .mst(hasText(invoiceData.getBuyerTaxCode()) ? truncate(invoiceData.getBuyerTaxCode(), 20) : null)
                .tnmua(truncate(invoiceData.getBuyerName(), 200))
                .ten(truncate(invoiceData.getBuyerUnitName(), 200))
                .dchi(truncate(invoiceData.getBuyerAddress(), 255))
                .email(truncate(invoiceData.getReceiverEmail(), 100))
                .sdtnmua(truncate(invoiceData.getReceiverMobile(), 20))
                .stknmua(truncate(invoiceData.getBuyerBankAccount(), 50))
                .tgtcthue(n(invoiceData.getGrossAmount()))
                .tgtthue(n(invoiceData.getTaxAmount()))
                .tgtttbso(n(invoiceData.getTotalAmount()))
                .tgtttbsoLast(n(invoiceData.getTotalAmount()))
                .sdhang(truncate(
                        invoiceData.getBillCode() != null ? invoiceData.getBillCode() : 
                        (invoiceData.getPartnerInvoiceId() != null ? invoiceData.getPartnerInvoiceId() : ""), 
                        30))
                .tthdon(MobifoneInvoiceStatus.ORIGINAL)
                .details(List.of(toMobifoneDetailWrapper(invoiceData.getDetails())))
                .build();
    }
    
    public InvoiceResult toInvoiceResult(MobifoneInvoiceResponse response) {
        if (response == null) {
            return InvoiceResult.error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ MobiFone");
        }
        
        if (!response.isSuccess()) {
            return InvoiceResult.builder()
                    .success(false)
                    .message(response.getMessage() != null ? response.getMessage() : "L·ªói t·ª´ MobiFone")
                    .object(response)
                    .build();
        }
        
        InvoiceResult.InvoiceResultBuilder builder = InvoiceResult.builder()
                .success(true)
                .message("T·∫°o h√≥a ƒë∆°n th√†nh c√¥ng")
                .object(response);
        
        if (response.getData() != null) {
            var data = response.getData();

            builder.invoiceId(data.getHdonId() != null ? data.getHdonId() : data.getId())
                   .invoiceForm(extractInvoiceForm(data.getKhieu()))
                   .invoiceSerial(extractInvoiceSerial(data.getKhieu()))
                   .invoiceNo(data.getShdon())
                   .invoiceReferenceCode(data.getSbmat())
                   .taxAuthorityCode(data.getMccqthue())
                   .statusMessage(data.getTthai());
        }
        
        if (response.getLstHdonIdSuccess() != null && !response.getLstHdonIdSuccess().isEmpty()) {
            builder.invoiceId(response.getLstHdonIdSuccess().get(0));
        }
        if (response.getTthai() != null) {
            builder.statusMessage(response.getTthai());
        }
        
        return builder.build();
    }
    
    public InvoiceResult toInvoiceResultFromList(List<MobifoneInvoiceResponse> responses) {
        if (responses == null || responses.isEmpty()) {
            return InvoiceResult.error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ MobiFone");
        }
        return toInvoiceResult(responses.get(0));
    }
    
    private MobifoneInvoiceDetailWrapper toMobifoneDetailWrapper(List<InvoiceDetailData> details) {
        List<MobifoneInvoiceDetail> mobifoneDetails = new ArrayList<>();
        
        if (details != null) {
            for (int i = 0; i < details.size(); i++) {
                mobifoneDetails.add(toMobifoneInvoiceDetail(details.get(i), i + 1));
            }
        }
        
        return MobifoneInvoiceDetailWrapper.builder()
                .data(mobifoneDetails)
                .build();
    }
    
    private MobifoneInvoiceDetail toMobifoneInvoiceDetail(InvoiceDetailData detail, int lineNo) {
        return MobifoneInvoiceDetail.builder()
                .stt(lineNo)
                .ma(truncate(detail.getItemCode(), 30))
                .ten(truncate(detail.getItemName(), 255))
                .dvtinh(truncate(detail.getUnitName(), 20))
                .sluong(n(detail.getQuantity()))
                .dgia(n(detail.getPrice()))
                .thtien(n(detail.getAmount()))
                .tlckhau(n(detail.getDiscountRate()))
                .stckhau(n(detail.getDiscountAmount()))
                .tsuat(getTaxRateString(detail.getTaxRate()))
                .tthue(n(detail.getTaxAmount()))
                .tgtien(n(detail.getAmount()).add(n(detail.getTaxAmount())))
                .kmai(Boolean.TRUE.equals(detail.getIsDiscount()) 
                        ? MobifoneInvoiceStatus.ITEM_PROMOTION 
                        : MobifoneInvoiceStatus.ITEM_GOODS_SERVICE)
                .build();
    }
    
    private String formatDate(Instant instant) {
        return DATE_FORMATTER.format(instant != null ? instant : Instant.now());
    }
    
    private String getPaymentMethodName(Integer payMethodId) {
        if (payMethodId == null) return "Ti·ªÅn m·∫∑t/Chuy·ªÉn kho·∫£n";
        return switch (payMethodId) {
            case 1 -> "Ti·ªÅn m·∫∑t";
            case 2 -> "Chuy·ªÉn kho·∫£n";
            default -> "Ti·ªÅn m·∫∑t/Chuy·ªÉn kho·∫£n";
        };
    }
    
    private String getTaxRateString(BigDecimal taxRate) {
        if (taxRate == null) return "10";
        return String.valueOf(taxRate.intValue());
    }
    
    private BigDecimal n(BigDecimal value) {
        return value != null ? value : BigDecimal.ZERO;
    }
    
    private String truncate(String value, int maxLength) {
        if (value == null) return null;
        return value.length() > maxLength ? value.substring(0, maxLength) : value;
    }
    
    private boolean hasText(String value) {
        return value != null && !value.trim().isEmpty();
    }

    private String extractInvoiceForm(String khieu) {
        return (khieu != null && khieu.length() > 1) ? khieu.substring(0, 1) : null;
    }

    private String extractInvoiceSerial(String khieu) {
        return (khieu != null && khieu.length() > 1) ? khieu.substring(1) : khieu;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/model/MobifoneCancelInvoiceRequest.java">
package vn.softz.app.einvoicehub.provider.mobifone.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class MobifoneCancelInvoiceRequest {
    
    @JsonProperty("editmode")
    @Builder.Default
    private Integer editmode = 0;
    
    @JsonProperty("mst")
    private String mst;
    
    @JsonProperty("hdon_id")
    private String hdonId;
    
    @JsonProperty("tctbao")
    @Builder.Default
    private String tctbao = "1";
    
    @JsonProperty("ldo")
    private String ldo;
    
    @JsonProperty("khieu")
    private String khieu;
    
    @JsonProperty("shdon")
    private String shdon;
    
    @JsonProperty("nlap")
    private String nlap;
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/model/MobifoneInvoiceData.java">
package vn.softz.app.einvoicehub.provider.mobifone.model;

import com.fasterxml.jackson.annotation.JsonInclude;
import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.math.BigDecimal;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class MobifoneInvoiceData {
    
    @JsonProperty("cctbao_id")
    private String cctbaoId;
    
    @JsonProperty("nlap")
    private String nlap;
    
    @JsonProperty("dvtte")
    @Builder.Default
    private String dvtte = "VND";
    
    @JsonProperty("tgia")
    @Builder.Default
    private BigDecimal tgia = BigDecimal.ONE;
    
    @JsonProperty("htttoan")
    private String htttoan;
    
    @JsonProperty("mdvi")
    @JsonInclude(JsonInclude.Include.NON_EMPTY)
    private String mdvi;
    
    @JsonProperty("is_hdcma")
    @Builder.Default
    private Integer isHdcma = 1;
    
    // Buyer
    @JsonProperty("mnmua")
    private String mnmua;
    
    @JsonProperty("mst")
    private String mst;
    
    @JsonProperty("tnmua")
    private String tnmua;
    
    @JsonProperty("ten")
    private String ten;
    
    @JsonProperty("dchi")
    private String dchi;
    
    @JsonProperty("email")
    private String email;
    
    @JsonProperty("sdtnmua")
    private String sdtnmua;
    
    @JsonProperty("stknmua")
    private String stknmua;
    
    @JsonProperty("tnhmua")
    private String tnhmua;
    
    @JsonProperty("cmndmua")
    private String cmndmua;
    
    // Seller
    @JsonProperty("sdtnban")
    private String sdtnban;
    
    @JsonProperty("stknban")
    private String stknban;
    
    @JsonProperty("tnhban")
    private String tnhban;
    
    // Amounts
    @JsonProperty("tgtcthue")
    private BigDecimal tgtcthue;
    
    @JsonProperty("tgtthue")
    private BigDecimal tgtthue;
    
    @JsonProperty("tgtttbso")
    private BigDecimal tgtttbso;
    
    @JsonProperty("tgtttbso_last")
    private BigDecimal tgtttbsoLast;
    
    @JsonProperty("TGTKCThue")
    private BigDecimal tgtkcthue;
    
    @JsonProperty("tkcktmn")
    private BigDecimal tkcktmn;
    
    @JsonProperty("TGTKhac")
    private BigDecimal tgtkhac;
    
    @JsonProperty("tgtphi")
    private BigDecimal tgtphi;
    
    // Status & Result
    @JsonProperty("hdon_id")
    @JsonInclude(JsonInclude.Include.NON_EMPTY)
    private String hdonId;
    
    @JsonProperty("khieu")
    private String khieu;
    
    @JsonProperty("shdon")
    private String shdon;
    
    @JsonProperty("sdhang")
    private String sdhang;
    
    @JsonProperty("tthdon")
    private Integer tthdon;
    
    @JsonProperty("tthai")
    private String tthai;
    
    @JsonProperty("sbmat")
    private String sbmat;
    
    @JsonProperty("mccqthue")
    private String mccqthue;
    
    // Replacement/Adjustment
    @JsonProperty("hdon_id_old")
    @JsonInclude(JsonInclude.Include.NON_EMPTY)
    private String hdonIdOld;
    
    @JsonProperty("lhdclquan")
    private Integer lhdclquan;
    
    @JsonProperty("khmshdclquan")
    private String khmshdclquan;
    
    @JsonProperty("khhdclquan")
    private String khhdclquan;
    
    @JsonProperty("shdclquan")
    private String shdclquan;
    
    @JsonProperty("nlhdclquan")
    private String nlhdclquan;
    
    // Store
    @JsonProperty("tchang")
    private String tchang;
    
    @JsonProperty("mchang")
    private String mchang;
    
    // Details
    @JsonProperty("details")
    private List<MobifoneInvoiceDetailWrapper> details;
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/model/MobifoneInvoiceDetail.java">
package vn.softz.app.einvoicehub.provider.mobifone.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.math.BigDecimal;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class MobifoneInvoiceDetail {
    
    @JsonProperty("stt")
    private Integer stt;
    
    @JsonProperty("ma")
    private String ma;
    
    @JsonProperty("ten")
    private String ten;
    
    @JsonProperty("mdvtinh")
    private String mdvtinh;
    
    @JsonProperty("dvtinh")
    private String dvtinh;
    
    @JsonProperty("sluong")
    private BigDecimal sluong;
    
    @JsonProperty("dgia")
    private BigDecimal dgia;
    
    @JsonProperty("thtien")
    private BigDecimal thtien;
    
    @JsonProperty("tlckhau")
    private BigDecimal tlckhau;
    
    @JsonProperty("stckhau")
    private BigDecimal stckhau;
    
    @JsonProperty("tsuat")
    private String tsuat;
    
    @JsonProperty("tthue")
    private BigDecimal tthue;
    
    @JsonProperty("tgtien")
    private BigDecimal tgtien;
    
    @JsonProperty("kmai")
    private Integer kmai;
    
    @JsonProperty("lhhdthu")
    private Integer lhhdthu;
    
    @JsonProperty("skhung")
    private String skhung;
    
    @JsonProperty("smay")
    private String smay;
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/model/MobifoneInvoiceDetailWrapper.java">
package vn.softz.app.einvoicehub.provider.mobifone.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class MobifoneInvoiceDetailWrapper {
    
    @JsonProperty("data")
    private List<MobifoneInvoiceDetail> data;
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/model/MobifoneInvoiceRequest.java">
package vn.softz.app.einvoicehub.provider.mobifone.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class MobifoneInvoiceRequest {
    
    @JsonProperty("editmode")
    @Builder.Default
    private Integer editmode = 1;
    
    @JsonProperty("tax_code")
    private String taxCode;
    
    @JsonProperty("data")
    private List<MobifoneInvoiceData> data;
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/model/MobifoneInvoiceResponse.java">
package vn.softz.app.einvoicehub.provider.mobifone.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class MobifoneInvoiceResponse {
    
    @JsonProperty("data")
    private MobifoneInvoiceResponseData data;
    
    @JsonProperty("ok")
    private String ok;
    
    @JsonProperty("tthai")
    private String tthai;
    
    @JsonProperty("trang_thai")
    private String trangThai;
    
    @JsonProperty("lst_hdon_id_success")
    private List<String> lstHdonIdSuccess;
    
    @JsonProperty("message")
    private String message;
    
    @JsonProperty("error_code")
    private String errorCode;
    
    @JsonProperty("error")
    private String error;
    
    public boolean isSuccess() {
        if (error != null && !error.isEmpty()) {
            return false;
        }
        return "true".equalsIgnoreCase(ok) || (tthai != null && !tthai.isEmpty()) || data != null;
    }
    
    public String getErrorMessage() {
        if (error != null && !error.isEmpty()) return error;
        if (message != null && !message.isEmpty()) return message;
        return null;
    }
    
    @Data
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    public static class MobifoneInvoiceResponseData {
        
        @JsonProperty("id")
        private String id;
        
        @JsonProperty("hdon_id")
        private String hdonId;
        
        @JsonProperty("tthai")
        private String tthai;
        
        @JsonProperty("tthdon")
        private Integer tthdon;
        
        @JsonProperty("khieu")
        private String khieu;
        
        @JsonProperty("shdon")
        private String shdon;
        
        @JsonProperty("sbmat")
        private String sbmat;
        
        @JsonProperty("mccqthue")
        private String mccqthue;
        
        @JsonProperty("tgtttbchu")
        private String tgtttbchu;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/model/MobifoneLoginRequest.java">
package vn.softz.app.einvoicehub.provider.mobifone.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class MobifoneLoginRequest {
    
    @JsonProperty("username")
    private String username;
    
    @JsonProperty("password")
    private String password;
    
    @JsonProperty("tax_code")
    private String taxCode;
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/model/MobifoneLoginResponse.java">
package vn.softz.app.einvoicehub.provider.mobifone.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class MobifoneLoginResponse {
    
    @JsonProperty("isWeakPass")
    private Boolean isWeakPass;
    
    @JsonProperty("token")
    private String token;
    
    @JsonProperty("refresh_token")
    private String refreshToken;
    
    @JsonProperty("ma_dvcs")
    private String maDvcs;
    
    @JsonProperty("wb_user_id")
    private String wbUserId;
    
    @JsonProperty("noti_sso")
    private String notiSso;
    
    @JsonProperty("notes_sso")
    private String notesSso;
    
    @JsonProperty("notify")
    private String notify;
    
    @JsonProperty("is_link_sso")
    private Boolean isLinkSso;
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/MobifoneEInvoiceProvider.java">
package vn.softz.app.einvoicehub.provider.mobifone;

import com.fasterxml.jackson.core.type.TypeReference;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import vn.softz.app.einvoicehub.domain.entity.EinvStoreProviderEntity;
import vn.softz.app.einvoicehub.domain.repository.EinvStoreProviderRepository;
import vn.softz.app.einvoicehub.provider.EInvoiceProvider;
import vn.softz.app.einvoicehub.provider.mobifone.constant.MobifoneApiEndpoints;
import vn.softz.app.einvoicehub.provider.mobifone.constant.MobifoneInvoiceStatus;
import vn.softz.app.einvoicehub.provider.mobifone.mapper.MobifoneDataMapper;
import vn.softz.app.einvoicehub.provider.mobifone.model.*;
import vn.softz.app.einvoicehub.provider.model.InvoiceData;
import vn.softz.app.einvoicehub.provider.model.InvoiceResult;
import vn.softz.core.common.Common;

import java.util.Base64;
import java.util.List;
import java.util.Map;

@Component
@Slf4j
@RequiredArgsConstructor
public class MobifoneEInvoiceProvider implements EInvoiceProvider {
    
    private final MobifoneHttpClient httpClient;
    private final MobifoneDataMapper dataMapper;
    private final EinvStoreProviderRepository storeProviderRepository;

    private EinvStoreProviderEntity getConfig() {
        String storeId = Common.getCurrentUser().map(u -> u.getLocId()).orElse(null);
        return storeProviderRepository.findByStoreId(storeId)
                .orElseThrow(() -> new RuntimeException("Ch∆∞a c·∫•u h√¨nh HƒêƒêT cho c·ª≠a h√†ng n√†y"));
    }
    
    @Override
    public String getProviderType() {
        return "MOBI";
    }
    
    @Override
    public InvoiceResult createInvoice(int commandType, InvoiceData invoiceData) {
        try {
            log.info("MobiFone createInvoice - partnerInvoiceId: {}", invoiceData.getPartnerInvoiceId());
            
            MobifoneInvoiceRequest request = dataMapper.toMobifoneInvoiceRequest(invoiceData);
            
            List<MobifoneInvoiceResponse> responses = httpClient.postForList(
                    MobifoneApiEndpoints.SAVE_INVOICE,
                    request,
                    new TypeReference<>() {}
            );
            
            InvoiceResult result = dataMapper.toInvoiceResultFromList(responses);
            
            if (result.isSuccess()) {
                log.info("MobiFone createInvoice success - hdon_id: {}, khieu: {}, shdon: {}", 
                        result.getInvoiceId(), result.getInvoiceSerial(), result.getInvoiceNo());
            } else {
                log.error("MobiFone createInvoice failed: {}", result.getMessage());
            }
            
            return result;
            
        } catch (Exception e) {
            log.error("MobiFone createInvoice error", e);
            return InvoiceResult.error("L·ªói t·∫°o h√≥a ƒë∆°n MobiFone: " + e.getMessage());
        }
    }
    
    @Override
    public InvoiceResult signInvoiceByHsm(String invoiceGuid) {
        try {
            log.info("MobiFone signInvoiceByHsm - invoiceId: {}", invoiceGuid);
            
            var config = getConfig();
            
            Map<String, Object> signRequest = Map.of(
                    "data", List.of(Map.of(
                            "branch_code", httpClient.getMaDvcs(),
                            "username", config.getPartnerUsr(),
                            "lsthdon_id", List.of(invoiceGuid),
                            "cer_serial", "",
                            "type_cmd", MobifoneInvoiceStatus.TYPE_CMD_WITH_CODE,
                            "is_api", "1"
                    ))
            );
            
            MobifoneInvoiceResponse response = httpClient.post(
                    MobifoneApiEndpoints.SIGN_INVOICE,
                    signRequest,
                    MobifoneInvoiceResponse.class
            );
            
            InvoiceResult result = dataMapper.toInvoiceResult(response);
            
            if (result.isSuccess()) {
                log.info("MobiFone signInvoiceByHsm success - status: {}", response.getTthai());
            } else {
                log.error("MobiFone signInvoiceByHsm failed: {}", result.getMessage());
            }
            
            return result;
            
        } catch (Exception e) {
            log.error("MobiFone signInvoiceByHsm error", e);
            return InvoiceResult.error("L·ªói k√Ω h√≥a ƒë∆°n MobiFone: " + e.getMessage());
        }
    }
    
    @Override
    public InvoiceResult getInvoiceData(String invoiceGuid) {
        try {
            log.info("MobiFone getInvoiceData - invoiceId: {}", invoiceGuid);
            
            Object response = httpClient.get(
                    MobifoneApiEndpoints.GET_INVOICE_BY_ID + "?id=" + invoiceGuid, 
                    Object.class
            );
            
            return InvoiceResult.builder()
                    .success(true)
                    .message("L·∫•y th√¥ng tin h√≥a ƒë∆°n th√†nh c√¥ng")
                    .object(response)
                    .build();
            
        } catch (Exception e) {
            log.error("MobiFone getInvoiceData error", e);
            return InvoiceResult.error("L·ªói l·∫•y th√¥ng tin h√≥a ƒë∆°n: " + e.getMessage());
        }
    }
    
    @Override
    public Object getInvoiceStatus(String invoiceGuid) {
        try {
            log.info("MobiFone getInvoiceStatus - invoiceId: {}", invoiceGuid);
            return httpClient.get(MobifoneApiEndpoints.GET_INVOICE_BY_ID + "?id=" + invoiceGuid, Object.class);
        } catch (Exception e) {
            log.error("MobiFone getInvoiceStatus error", e);
            throw new RuntimeException("L·ªói l·∫•y tr·∫°ng th√°i h√≥a ƒë∆°n: " + e.getMessage());
        }
    }
    
    @Override
    public String getInvoicePdf(String docId) {
        try {
            log.info("MobiFone getInvoicePdf - docId: {}", docId);
            
            String endpoint = MobifoneApiEndpoints.GET_INVOICE_PDF + "?id=" + docId + "&type=PDF&inchuyendoi=false";
            byte[] pdfBytes = httpClient.getBytes(endpoint);
            
            return Base64.getEncoder().encodeToString(pdfBytes);
            
        } catch (Exception e) {
            log.error("MobiFone getInvoicePdf error", e);
            throw new RuntimeException("L·ªói l·∫•y PDF h√≥a ƒë∆°n: " + e.getMessage());
        }
    }
    
    @Override
    public String getInvoiceXml(String docId) {
        try {
            log.info("MobiFone getInvoiceXml - docId: {}", docId);
            return httpClient.getString(MobifoneApiEndpoints.GET_INVOICE_XML + "?id=" + docId);
        } catch (Exception e) {
            log.error("MobiFone getInvoiceXml error", e);
            throw new RuntimeException("L·ªói l·∫•y XML h√≥a ƒë∆°n: " + e.getMessage());
        }
    }
    
    @Override
    public InvoiceResult cancelInvoiceByGuid(String invoiceGuid, String reason) {
        try {
            log.info("MobiFone cancelInvoice - invoiceId: {}, reason: {}", invoiceGuid, reason);
            
            MobifoneCancelInvoiceRequest cancelRequest = MobifoneCancelInvoiceRequest.builder()
                    .editmode(MobifoneInvoiceStatus.EDIT_MODE_CREATE)
                    .mst(getConfig().getTaxCode())
                    .hdonId(invoiceGuid)
                    .tctbao(MobifoneInvoiceStatus.TBSS_CANCEL)
                    .ldo(reason)
                    .build();
            
            Object response = httpClient.post(MobifoneApiEndpoints.SAVE_ERROR_NOTIFICATION, cancelRequest, Object.class);
            
            log.info("MobiFone cancelInvoice response: {}", response);
            
            return InvoiceResult.builder()
                    .success(true)
                    .message("H·ªßy h√≥a ƒë∆°n th√†nh c√¥ng")
                    .object(response)
                    .build();
            
        } catch (Exception e) {
            log.error("MobiFone cancelInvoice error", e);
            return InvoiceResult.error("L·ªói h·ªßy h√≥a ƒë∆°n: " + e.getMessage());
        }
    }
    
    @Override
    public InvoiceResult deleteInvoiceByGuid(String invoiceGuid) {
        try {
            log.info("MobiFone deleteInvoice - invoiceId: {}", invoiceGuid);
            
            Map<String, Object> deleteRequest = Map.of(
                    "editmode", MobifoneInvoiceStatus.EDIT_MODE_DELETE,
                    "data", List.of(Map.of("hdon_id", invoiceGuid))
            );
            
            Object response = httpClient.post(MobifoneApiEndpoints.DELETE_UNSIGNED_INVOICE, deleteRequest, Object.class);
            
            return InvoiceResult.builder()
                    .success(true)
                    .message("X√≥a h√≥a ƒë∆°n th√†nh c√¥ng")
                    .object(response)
                    .build();
            
        } catch (Exception e) {
            log.error("MobiFone deleteInvoice error", e);
            return InvoiceResult.error("L·ªói x√≥a h√≥a ƒë∆°n: " + e.getMessage());
        }
    }
    
    @Override
    public InvoiceResult createReplacementInvoice(InvoiceData invoiceData) {
        try {
            log.info("MobiFone createReplacementInvoice - originalInvoiceId: {}", invoiceData.getOriginalInvoiceIdentify());
            
            MobifoneInvoiceRequest request = dataMapper.toMobifoneInvoiceRequest(invoiceData);
            
            if (!request.getData().isEmpty()) {
                MobifoneInvoiceData data = request.getData().get(0);
                data.setHdonIdOld(invoiceData.getOriginalInvoiceIdentify());
                data.setTthdon(MobifoneInvoiceStatus.REPLACEMENT);
                data.setLhdclquan(1);
            }
            
            List<MobifoneInvoiceResponse> responses = httpClient.postForList(
                    MobifoneApiEndpoints.SAVE_INVOICE,
                    request,
                    new TypeReference<>() {}
            );
            
            return dataMapper.toInvoiceResultFromList(responses);
            
        } catch (Exception e) {
            log.error("MobiFone createReplacementInvoice error", e);
            return InvoiceResult.error("L·ªói t·∫°o h√≥a ƒë∆°n thay th·∫ø: " + e.getMessage());
        }
    }
    
    @Override
    public InvoiceResult createAdjustmentInvoice(InvoiceData invoiceData) {
        try {
            log.info("MobiFone createAdjustmentInvoice - originalInvoiceId: {}", invoiceData.getOriginalInvoiceIdentify());
            
            MobifoneInvoiceRequest request = dataMapper.toMobifoneInvoiceRequest(invoiceData);
            
            if (!request.getData().isEmpty()) {
                MobifoneInvoiceData data = request.getData().get(0);
                data.setHdonIdOld(invoiceData.getOriginalInvoiceIdentify());
                data.setLhdclquan(1);
                
                Integer adjustType = invoiceData.getTypeCreateInvoice();
                data.setTthdon(adjustType != null ? switch (adjustType) {
                    case 3 -> MobifoneInvoiceStatus.ADJUSTMENT_INCREASE;
                    case 4 -> MobifoneInvoiceStatus.ADJUSTMENT_DECREASE;
                    case 2 -> MobifoneInvoiceStatus.ADJUSTMENT_INFO;
                    default -> MobifoneInvoiceStatus.ADJUSTMENT;
                } : MobifoneInvoiceStatus.ADJUSTMENT);
            }
            
            List<MobifoneInvoiceResponse> responses = httpClient.postForList(
                    MobifoneApiEndpoints.SAVE_INVOICE,
                    request,
                    new TypeReference<>() {}
            );
            
            return dataMapper.toInvoiceResultFromList(responses);
            
        } catch (Exception e) {
            log.error("MobiFone createAdjustmentInvoice error", e);
            return InvoiceResult.error("L·ªói t·∫°o h√≥a ƒë∆°n ƒëi·ªÅu ch·ªânh: " + e.getMessage());
        }
    }
    
    @Override
    public Object lookupCompany(String taxCode) {
        log.warn("MobiFone lookupCompany not implemented - taxCode: {}", taxCode);
        return Map.of("success", false, "message", "Ch·ª©c nƒÉng tra c·ª©u doanh nghi·ªáp kh√¥ng kh·∫£ d·ª•ng v·ªõi MobiFone");
    }
    
    @Override
    public String getInvoiceLink(String partnerInvoiceId) {
        throw new UnsupportedOperationException("MobiFone kh√¥ng h·ªó tr·ª£ l·∫•y link, s·ª≠ d·ª•ng getInvoicePdf thay th·∫ø");
    }
    
    @Override
    public InvoiceResult updateInvoiceByGuid(String invoiceGuid, InvoiceData invoiceData) {
        throw new UnsupportedOperationException("Ch∆∞a implement");
    }
    
    @Override
    public InvoiceResult updateInvoiceByPartnerId(String partnerInvoiceId, InvoiceData invoiceData) {
        throw new UnsupportedOperationException("Ch∆∞a implement");
    }
    
    @Override
    public InvoiceResult cancelInvoiceByPartnerId(String partnerInvoiceId, String reason) {
        throw new UnsupportedOperationException("Ch∆∞a implement");
    }
    
    @Override
    public InvoiceResult deleteInvoiceByPartnerId(String partnerInvoiceId) {
        throw new UnsupportedOperationException("Ch∆∞a implement");
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/MobifoneHttpClient.java">
package vn.softz.app.einvoicehub.provider.mobifone;

import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.*;
import org.springframework.stereotype.Component;
import org.springframework.web.client.HttpStatusCodeException;
import org.springframework.web.client.RestTemplate;
import vn.softz.app.einvoicehub.domain.entity.EinvProviderEntity;
import vn.softz.app.einvoicehub.domain.entity.EinvStoreProviderEntity;
import vn.softz.app.einvoicehub.domain.repository.EinvProviderRepository;
import vn.softz.app.einvoicehub.domain.repository.EinvStoreProviderRepository;
import vn.softz.app.einvoicehub.provider.mobifone.constant.MobifoneApiEndpoints;
import vn.softz.app.einvoicehub.provider.mobifone.model.MobifoneLoginRequest;
import vn.softz.app.einvoicehub.provider.mobifone.model.MobifoneLoginResponse;
import vn.softz.core.common.Common;

import java.time.Instant;
import java.util.List;
import java.util.Map;

@Component
@Slf4j
public class MobifoneHttpClient {
    
    private static final long TOKEN_VALIDITY_SECONDS = 3600;
    private static final String MOBI_PROVIDER_ID = "MOBI";
    private static final String DEFAULT_BASE_URL = "http://mobiinvoice.vn:9000";
    
    private final EinvStoreProviderRepository storeProviderRepository;
    private final EinvProviderRepository providerRepository;
    private final RestTemplate restTemplate;
    private final ObjectMapper objectMapper;
    
    private String cachedToken;
    private String cachedMaDvcs;
    private Instant tokenExpiry;
    
    public MobifoneHttpClient(EinvStoreProviderRepository storeProviderRepository, EinvProviderRepository providerRepository) {
        this.storeProviderRepository = storeProviderRepository;
        this.providerRepository = providerRepository;
        this.restTemplate = new RestTemplate();
        this.objectMapper = new ObjectMapper()
                .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
    }

    private String getBaseUrl() {
        return providerRepository.findById(MOBI_PROVIDER_ID)
                .map(EinvProviderEntity::getIntegrationUrl)
                .orElse(DEFAULT_BASE_URL);
    }

    private EinvStoreProviderEntity getConfig() {
        String storeId = Common.getCurrentUser().map(u -> u.getLocId()).orElse(null);
        return storeProviderRepository.findByStoreId(storeId)
                .orElseThrow(() -> new RuntimeException("Ch∆∞a c·∫•u h√¨nh HƒêƒêT cho c·ª≠a h√†ng n√†y"));
    }
    
    public MobifoneLoginResponse login() {
        try {
            var config = getConfig();
            String url = getBaseUrl() + MobifoneApiEndpoints.LOGIN;
            
            MobifoneLoginRequest request = MobifoneLoginRequest.builder()
                    .username(config.getPartnerUsr())
                    .password(config.getPartnerPwd())
                    .taxCode(config.getTaxCode())
                    .build();
            
            HttpEntity<MobifoneLoginRequest> entity = new HttpEntity<>(request, createJsonHeaders());
            
            log.info("MobiFone login - URL: {}, TaxCode: {}", url, config.getTaxCode());
            
            ResponseEntity<String> response = restTemplate.exchange(url, HttpMethod.POST, entity, String.class);
            MobifoneLoginResponse loginResponse = objectMapper.readValue(response.getBody(), MobifoneLoginResponse.class);
            
            this.cachedToken = loginResponse.getToken();
            this.cachedMaDvcs = loginResponse.getMaDvcs();
            this.tokenExpiry = Instant.now().plusSeconds(TOKEN_VALIDITY_SECONDS);
            
            log.info("MobiFone login successful - ma_dvcs: {}", loginResponse.getMaDvcs());
            return loginResponse;
            
        } catch (HttpStatusCodeException e) {
            log.error("MobiFone login failed - Status: {}, Body: {}", e.getStatusCode(), e.getResponseBodyAsString());
            throw new RuntimeException("Login th·∫•t b·∫°i: " + e.getResponseBodyAsString());
        } catch (Exception e) {
            log.error("MobiFone login error", e);
            throw new RuntimeException("L·ªói k·∫øt n·ªëi MobiFone: " + e.getMessage());
        }
    }

    public MobifoneLoginResponse loginWithCredentials(String username, String password, String taxCode) {
        try {
            String url = getBaseUrl() + MobifoneApiEndpoints.LOGIN;
            
            MobifoneLoginRequest request = MobifoneLoginRequest.builder()
                    .username(username)
                    .password(password)
                    .taxCode(taxCode)
                    .build();
            
            HttpEntity<MobifoneLoginRequest> entity = new HttpEntity<>(request, createJsonHeaders());
            
            log.info("MobiFone loginWithCredentials - URL: {}, Username: {}", url, username);
            
            ResponseEntity<String> response = restTemplate.exchange(url, HttpMethod.POST, entity, String.class);
            return objectMapper.readValue(response.getBody(), MobifoneLoginResponse.class);
            
        } catch (HttpStatusCodeException e) {
            log.error("MobiFone login failed - Status: {}, Body: {}", e.getStatusCode(), e.getResponseBodyAsString());
            throw new RuntimeException("Login th·∫•t b·∫°i: " + e.getResponseBodyAsString());
        } catch (Exception e) {
            log.error("MobiFone login error", e);
            throw new RuntimeException("L·ªói k·∫øt n·ªëi MobiFone: " + e.getMessage());
        }
    }
    
    @SuppressWarnings("unchecked")
    public Object loginRaw() {
        try {
            var config = getConfig();
            String url = getBaseUrl() + MobifoneApiEndpoints.LOGIN;
            
            MobifoneLoginRequest request = MobifoneLoginRequest.builder()
                    .username(config.getPartnerUsr())
                    .password(config.getPartnerPwd())
                    .taxCode(config.getTaxCode())
                    .build();
            
            HttpEntity<MobifoneLoginRequest> entity = new HttpEntity<>(request, createJsonHeaders());
            
            log.info("MobiFone loginRaw - URL: {}, TaxCode: {}", url, config.getTaxCode());
            
            ResponseEntity<String> response = restTemplate.exchange(url, HttpMethod.POST, entity, String.class);
            Object rawResponse = objectMapper.readValue(response.getBody(), Object.class);
            
            if (rawResponse instanceof Map) {
                Map<String, Object> map = (Map<String, Object>) rawResponse;
                if (map.containsKey("token")) {
                    this.cachedToken = (String) map.get("token");
                    this.cachedMaDvcs = (String) map.get("ma_dvcs");
                    this.tokenExpiry = Instant.now().plusSeconds(TOKEN_VALIDITY_SECONDS);
                    log.info("MobiFone loginRaw successful - ma_dvcs: {}", this.cachedMaDvcs);
                }
            }
            
            return rawResponse;
            
        } catch (HttpStatusCodeException e) {
            log.error("MobiFone loginRaw failed - Status: {}, Body: {}", e.getStatusCode(), e.getResponseBodyAsString());
            throw new RuntimeException("Login th·∫•t b·∫°i: " + e.getResponseBodyAsString());
        } catch (Exception e) {
            log.error("MobiFone loginRaw error", e);
            throw new RuntimeException("L·ªói k·∫øt n·ªëi MobiFone: " + e.getMessage());
        }
    }
    
    public String getToken() {
        if (cachedToken == null || tokenExpiry == null || Instant.now().isAfter(tokenExpiry)) {
            log.debug("Token expired or not available, refreshing...");
            login();
        }
        return cachedToken;
    }
    
    public String getMaDvcs() {
        if (cachedMaDvcs == null) {
            login();
        }
        return cachedMaDvcs;
    }
    
    public <T> T post(String endpoint, Object requestBody, Class<T> responseType) {
        return executeWithRetry(() -> {
            String url = getBaseUrl() + endpoint;
            HttpEntity<Object> entity = new HttpEntity<>(requestBody, buildAuthHeaders());
            
            log.debug("MobiFone POST - URL: {}", url);
            
            ResponseEntity<String> response = restTemplate.exchange(url, HttpMethod.POST, entity, String.class);
            log.debug("MobiFone Response: {}", response.getBody());
            
            return objectMapper.readValue(response.getBody(), responseType);
        });
    }
    
    public <T> List<T> postForList(String endpoint, Object requestBody, TypeReference<List<T>> typeRef) {
        return executeWithRetry(() -> {
            String url = getBaseUrl() + endpoint;
            HttpEntity<Object> entity = new HttpEntity<>(requestBody, buildAuthHeaders());
            
            log.debug("MobiFone POST - URL: {}", url);
            
            ResponseEntity<String> response = restTemplate.exchange(url, HttpMethod.POST, entity, String.class);
            log.debug("MobiFone Response: {}", response.getBody());
            
            return objectMapper.readValue(response.getBody(), typeRef);
        });
    }
    
    public <T> T get(String endpoint, Class<T> responseType) {
        return executeWithRetry(() -> {
            String url = buildUrlWithTaxCode(getBaseUrl() + endpoint);
            HttpEntity<Void> entity = new HttpEntity<>(buildAuthHeaders());
            
            log.debug("MobiFone GET - URL: {}", url);
            
            ResponseEntity<String> response = restTemplate.exchange(url, HttpMethod.GET, entity, String.class);
            log.debug("MobiFone Response: {}", response.getBody());
            
            return objectMapper.readValue(response.getBody(), responseType);
        });
    }
    
    public byte[] getBytes(String endpoint) {
        return executeWithRetry(() -> {
            String url = buildUrlWithTaxCode(getBaseUrl() + endpoint);
            
            HttpHeaders headers = buildAuthHeaders();
            headers.setAccept(List.of(MediaType.APPLICATION_OCTET_STREAM, MediaType.APPLICATION_PDF));
            HttpEntity<Void> entity = new HttpEntity<>(headers);
            
            log.debug("MobiFone GET bytes - URL: {}", url);
            
            ResponseEntity<byte[]> response = restTemplate.exchange(url, HttpMethod.GET, entity, byte[].class);
            return response.getBody();
        });
    }
    
    public String getString(String endpoint) {
        return executeWithRetry(() -> {
            String url = buildUrlWithTaxCode(getBaseUrl() + endpoint);
            HttpEntity<Void> entity = new HttpEntity<>(buildAuthHeaders());
            
            log.debug("MobiFone GET string - URL: {}", url);
            
            ResponseEntity<String> response = restTemplate.exchange(url, HttpMethod.GET, entity, String.class);
            return response.getBody();
        });
    }
    
    private HttpHeaders createJsonHeaders() {
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        return headers;
    }
    
    private HttpHeaders buildAuthHeaders() {
        HttpHeaders headers = createJsonHeaders();
        headers.set("Authorization", "Bearer " + getToken() + ";" + getMaDvcs());
        return headers;
    }

    public Object getInvoiceSeries() {
        log.info("Getting MobiFone invoice series");
        return get(MobifoneApiEndpoints.GET_DATA_REFERENCES + "?refId=RF00059", Object.class);
    }
    
    private String buildUrlWithTaxCode(String url) {
        String separator = url.contains("?") ? "&" : "?";
        return url + separator + "tax_code=" + getConfig().getTaxCode();
    }
    
    private <T> T executeWithRetry(SupplierWithException<T> action) {
        try {
            return action.get();
        } catch (HttpStatusCodeException e) {
            if (e.getStatusCode() == HttpStatus.UNAUTHORIZED) {
                log.warn("MobiFone token expired, refreshing and retrying...");
                this.cachedToken = null;
                this.tokenExpiry = null;
                try {
                    return action.get();
                } catch (Exception retryEx) {
                    log.error("MobiFone retry failed", retryEx);
                    throw new RuntimeException("L·ªói MobiFone sau khi retry: " + retryEx.getMessage());
                }
            }
            log.error("MobiFone HTTP error - Status: {}, Body: {}", e.getStatusCode(), e.getResponseBodyAsString());
            throw new RuntimeException("L·ªói MobiFone: " + e.getResponseBodyAsString());
        } catch (Exception e) {
            log.error("MobiFone error", e);
            throw new RuntimeException("L·ªói k·∫øt n·ªëi MobiFone: " + e.getMessage());
        }
    }
    
    @FunctionalInterface
    private interface SupplierWithException<T> {
        T get() throws Exception;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/model/InvoiceRequest.java">
package com.einvoicehub.core.provider.model;

import lombok.*;
import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.List;
import java.util.Map;

/**
 * DTO ƒë·∫°i di·ªán cho y√™u c·∫ßu ph√°t h√†nh h√≥a ƒë∆°n n·ªôi b·ªô.
 * ƒê√£ t·ªëi ∆∞u cho vi·ªác mapping sang m·ªçi Provider (VNPT, MISA, BKAV, Viettel).
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class InvoiceRequest {

    private Long invoiceMetadataId;
    private String clientRequestId;
    private String providerCode;
    private String invoiceType; // VD: 01GTKT, 02GTTT

    /** C·∫ßn thi·∫øt cho h·∫ßu h·∫øt Provider Vi·ªát Nam */
    private String templateCode; // M·∫´u s·ªë (VD: 1/001)
    private String symbolCode;   // K√Ω hi·ªáu (VD: C23TBA)

    private SellerInfo seller;
    private BuyerInfo buyer;
    private List<InvoiceItem> items;
    private InvoiceSummary summary;

    private LocalDate issueDate;
    private PaymentTerm paymentTerm;

    /** Ch·ª©a c√°c tham s·ªë ƒë·∫∑c th√π kh√¥ng n·∫±m trong chu·∫©n chung */
    private Map<String, Object> extraConfig;

    @Data @Builder @NoArgsConstructor @AllArgsConstructor
    public static class SellerInfo {
        private String name;
        private String taxCode;
        private String address;
        private String phone;
        private String email;
        private String bankAccount;
        private String bankName;
        private String representativeName;
    }

    @Data @Builder @NoArgsConstructor @AllArgsConstructor
    public static class BuyerInfo {
        private String name;
        private String taxCode;
        private String address;
        private String phone;
        private String email;
        private String bankAccount;
        private String bankName;
        private String customerCode; // M√£ kh√°ch h√†ng n·ªôi b·ªô
    }

    @Data @Builder @NoArgsConstructor @AllArgsConstructor
    public static class InvoiceItem {
        private String itemCode;
        private String itemName;
        private String unitName;
        private BigDecimal quantity;
        private BigDecimal unitPrice;
        private BigDecimal amount; // Th√†nh ti·ªÅn tr∆∞·ªõc thu·∫ø
        private BigDecimal discountAmount;
        private BigDecimal discountPercent; // Th√™m ƒë·ªÉ h·ªó tr·ª£ t√≠nh to√°n chi·∫øt kh·∫•u %
        private BigDecimal taxRate; // Thu·∫ø su·∫•t (0, 5, 8, 10...)
        private BigDecimal taxAmount;
        private String taxCategory; // Lo·∫°i thu·∫ø (theo quy ƒë·ªãnh c·ªßa t·ª´ng h√£ng)
        private String description;
    }

    @Data @Builder @NoArgsConstructor @AllArgsConstructor
    public static class InvoiceSummary {
        private BigDecimal subtotalAmount;
        private BigDecimal totalDiscountAmount;
        private BigDecimal totalTaxAmount;
        private BigDecimal totalAmount; // T·ªïng ti·ªÅn thanh to√°n cu·ªëi c√πng
        private String currencyCode;
        private BigDecimal exchangeRate; // Th√™m ƒë·ªÉ h·ªó tr·ª£ h√≥a ƒë∆°n ngo·∫°i t·ªá
        private String amountInWords;
    }

    @Data @Builder @NoArgsConstructor @AllArgsConstructor
    public static class PaymentTerm {
        private String method; // TM, CK, TM/CK
        private LocalDate dueDate;
        private String description;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/model/InvoiceResponse.java">
package com.einvoicehub.core.provider.model;

import lombok.*;
import lombok.Getter;
import lombok.Setter;
import lombok.ToString;
import java.time.LocalDateTime;

/**
 * DTO ph·∫£n h·ªìi t·ª´ Provider - ƒê√£ chu·∫©n h√≥a d·ªØ li·ªáu tr·∫£ v·ªÅ.
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class InvoiceResponse {

    private String clientRequestId;
    private Long invoiceMetadataId;
    private ResponseStatus status;

    private String errorCode;
    private String errorMessage;

    /** M√£ ƒë·ªãnh danh giao d·ªãch ph√≠a Provider */
    private String transactionCode;
    private String invoiceNumber;
    private String symbolCode;
    private String templateCode;

    /** ƒê·ªìng b·ªô ki·ªÉu LocalDateTime ƒë·ªÉ x·ª≠ l√Ω m√∫i gi·ªù ch√≠nh x√°c */
    private LocalDateTime issueDate;

    private String lookupCode;   // M√£ tra c·ª©u
    private String securityCode; // M√£ x√°c th·ª±c/ch·ªØ k√Ω s·ªë

    private String pdfUrl;
    private String xmlData;      // D·ªØ li·ªáu XML g·ªëc (ph√°p l√Ω)
    private String portalUrl;    // Link tra c·ª©u h√≥a ƒë∆°n tr·ª±c ti·∫øp c·ªßa h√£ng

    private String cqtCode;
    private String xmlUrl;
    private String jsonUrl;
    private boolean successful;

    private LocalDateTime responseTime;
    private Object rawResponse;  // D·ªØ li·ªáu th√¥ d√πng cho debug/audit

    public enum ResponseStatus {
        SUCCESS, PENDING, FAILED, TIMEOUT
    }

    public boolean isSuccessful() { return status == ResponseStatus.SUCCESS; }
    public boolean isFailed() { return status == ResponseStatus.FAILED; }
    public boolean isPending() { return status == ResponseStatus.PENDING; }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/viettel/ViettelAdapter.java">
package com.einvoicehub.core.provider.viettel;

import com.einvoicehub.core.domain.enums.InvoiceStatus;
import com.einvoicehub.core.provider.*;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.reactive.function.client.WebClientResponseException;

import java.math.BigDecimal;
import java.time.Duration;
import java.util.*;

@Slf4j
@Service("VIETTEL")
public class ViettelAdapter implements InvoiceProvider {

    private final WebClient webClient;
    private final ViettelApiMapper apiMapper;
    private final ObjectMapper objectMapper;

    @Value("${provider.viettel.timeout-ms:30000}")
    private int timeoutMs;

    public ViettelAdapter(WebClient.Builder webClientBuilder,
                          ViettelApiMapper apiMapper,
                          ObjectMapper objectMapper,
                          @Value("${provider.viettel.base-url:https://ebill.vietteltelecom.vn/api/v1}") String baseUrl) {
        this.webClient = webClientBuilder
                .baseUrl(baseUrl)
                .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)
                .defaultHeader("X-Client-Id", "EInvoiceHub")
                .build();
        this.apiMapper = apiMapper;
        this.objectMapper = objectMapper;
    }

    @Override public String getProviderCode() { return "VIETTEL"; }
    @Override public String getProviderName() { return "Viettel Business Invoice"; }
    @Override public boolean isAvailable() { return true; }

    @Override
    public InvoiceResponse issueInvoice(InvoiceRequest request, ProviderConfig config) {
        log.info("Viettel: Issuing invoice for ClientRequestID: {}", request.getClientRequestId());
        try {
            ViettelInvoicePayload payload = apiMapper.toViettelPayload(request);
            ViettelApiResponse response = webClient.post().uri("/invoices/create")
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .bodyValue(payload)
                    .retrieve()
                    .bodyToMono(ViettelApiResponse.class)
                    .timeout(Duration.ofMillis(timeoutMs))
                    .block();

            return apiMapper.toHubResponse(response, request.getClientRequestId());
        } catch (WebClientResponseException e) {
            return apiMapper.toHubResponse(parseError(e.getResponseBodyAsString()), request.getClientRequestId());
        } catch (Exception e) {
            log.error("Viettel: Issuance failed: {}", e.getMessage());
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage(e.getMessage()).build();
        }
    }

    @Override
    public InvoiceStatus getInvoiceStatus(String invoiceNumber, ProviderConfig config) {
        try {
            ViettelApiResponse response = webClient.get()
                    .uri(uri -> uri.path("/invoices/{id}").queryParam("includeDetails", false).build(invoiceNumber))
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .retrieve()
                    .bodyToMono(ViettelApiResponse.class)
                    .block();
            return apiMapper.mapViettelStatus(response);
        } catch (Exception e) {
            log.error("Viettel: Status check failed for {}: {}", invoiceNumber, e.getMessage());
            return InvoiceStatus.FAILED;
        }
    }

    @Override
    public InvoiceResponse cancelInvoice(String invoiceNumber, String reason, ProviderConfig config) {
        try {
            ViettelCancelRequest body = ViettelCancelRequest.builder().invoiceCode(invoiceNumber).note(reason).build();
            ViettelApiResponse response = webClient.post().uri("/invoices/cancel")
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .bodyValue(body)
                    .retrieve().bodyToMono(ViettelApiResponse.class).block();
            return apiMapper.toHubResponse(response, null);
        } catch (Exception e) {
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage(e.getMessage()).build();
        }
    }

    @Override
    public InvoiceResponse replaceInvoice(String oldNo, InvoiceRequest newReq, ProviderConfig config) {
        try {
            ViettelReplaceRequest body = ViettelReplaceRequest.builder()
                    .oldInvoiceCode(oldNo)
                    .newInvoice(apiMapper.toViettelPayload(newReq))
                    .reason("Invoice replacement")
                    .build();
            ViettelApiResponse response = webClient.post().uri("/invoices/replace")
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .bodyValue(body)
                    .retrieve().bodyToMono(ViettelApiResponse.class).block();
            return apiMapper.toHubResponse(response, newReq.getClientRequestId());
        } catch (Exception e) {
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage(e.getMessage()).build();
        }
    }

    @Override
    public String getInvoicePdf(String invoiceNumber, ProviderConfig config) {
        try {
            ViettelPdfResponse res = webClient.get().uri("/invoices/{id}/pdf", invoiceNumber)
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .retrieve().bodyToMono(ViettelPdfResponse.class).block();
            return res != null ? res.getDownloadUrl() : null;
        } catch (Exception e) { return null; }
    }

    @Override
    public String getInvoiceXml(String invoiceNumber, ProviderConfig config) {
        try {
            ViettelXmlResponse res = webClient.get().uri("/invoices/{id}/xml", invoiceNumber)
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .retrieve().bodyToMono(ViettelXmlResponse.class).block();
            return res != null ? res.getXmlData() : null;
        } catch (Exception e) {
            log.error("Viettel: XML retrieval failed: {}", e.getMessage());
            return null;
        }
    }

    @Override
    public String authenticate(ProviderConfig config) {
        try {
            ViettelAuthRequest auth = ViettelAuthRequest.builder()
                    .username(config.getUsername()).password(config.getPassword()).grantType("password").build();
            Map<?, ?> res = webClient.post().uri("/auth/token").bodyValue(auth).retrieve().bodyToMono(Map.class).block();
            return res != null ? (String) res.get("access_token") : null;
        } catch (Exception e) { return null; }
    }

    @Override public boolean testConnection(ProviderConfig config) { return authenticate(config) != null; }

    private ViettelApiResponse parseError(String body) {
        try { return objectMapper.readValue(body, ViettelApiResponse.class); } catch (Exception e) { return null; }
    }

    /* Inner Data Models */
    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelInvoicePayload {
        private String invoiceType, templateCode, issueDate;
        private ViettelParty seller, buyer;
        private List<ViettelInvoiceItem> items;
        private ViettelPayment payment;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelParty {
        private String taxCode, name, address, phone, email, bankAccount, bankName, contactName;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelInvoiceItem {
        private String name, unit, description;
        private BigDecimal quantity, unitPrice, amount, discountAmount, vatRate, vatAmount;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelPayment { private String method, currency; private BigDecimal totalAmount; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelApiResponse { private String code, message, transactionId; private ViettelInvoiceData data; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelInvoiceData { private String invoiceCode, invoiceNo, checkSum, pdfUrl, status; }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelCancelRequest { private String invoiceCode, note; }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelReplaceRequest { private String oldInvoiceCode; private ViettelInvoicePayload newInvoice; private String reason; }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelAuthRequest { private String username, password, grantType; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelPdfResponse { private String downloadUrl; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelXmlResponse { private String xmlData; }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/viettel/ViettelApiMapper.java">
package com.einvoicehub.core.provider.viettel;

import com.einvoicehub.core.domain.enums.InvoiceStatus;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;

@Slf4j
@Component
@RequiredArgsConstructor
public class ViettelApiMapper {

    public ViettelAdapter.ViettelInvoicePayload toViettelPayload(InvoiceRequest request) {
        List<ViettelAdapter.ViettelInvoiceItem> items = request.getItems().stream()
                .map(this::convertToViettelItem)
                .toList();

        return ViettelAdapter.ViettelInvoicePayload.builder()
                .invoiceType(getInvoiceTypeCode(request))
                .templateCode(getTemplateCode(request))
                .issueDate(request.getIssueDate() != null ?
                        request.getIssueDate().format(DateTimeFormatter.ISO_DATE) :
                        LocalDateTime.now().format(DateTimeFormatter.ISO_DATE))
                .seller(ViettelAdapter.ViettelParty.builder()
                        .taxCode(request.getSeller().getTaxCode())
                        .name(request.getSeller().getName())
                        .address(request.getSeller().getAddress())
                        .phone(request.getSeller().getPhone())
                        .email(request.getSeller().getEmail())
                        .bankAccount(request.getSeller().getBankAccount())
                        .bankName(request.getSeller().getBankName())
                        .contactName(request.getSeller().getRepresentativeName())
                        .build())
                .buyer(ViettelAdapter.ViettelParty.builder()
                        .taxCode(request.getBuyer().getTaxCode())
                        .name(request.getBuyer().getName())
                        .address(request.getBuyer().getAddress())
                        .phone(request.getBuyer().getPhone())
                        .email(request.getBuyer().getEmail())
                        .build())
                .items(items)
                .payment(ViettelAdapter.ViettelPayment.builder()
                        .method(request.getPaymentTerm() != null ? request.getPaymentTerm().getMethod() : "TM/CK")
                        .totalAmount(request.getSummary().getTotalAmount())
                        .currency(request.getSummary().getCurrencyCode())
                        .build())
                .build();
    }

    private ViettelAdapter.ViettelInvoiceItem convertToViettelItem(InvoiceRequest.InvoiceItem item) {
        return ViettelAdapter.ViettelInvoiceItem.builder()
                .name(item.getItemName())
                .unit(item.getUnitName())
                .quantity(item.getQuantity())
                .unitPrice(item.getUnitPrice())
                .amount(item.getAmount())
                .discountAmount(item.getDiscountAmount() != null ? item.getDiscountAmount() : BigDecimal.ZERO)
                .vatRate(item.getTaxRate())
                .vatAmount(item.getTaxAmount() != null ? item.getTaxAmount() : BigDecimal.ZERO)
                .description(item.getDescription())
                .build();
    }

    private String getInvoiceTypeCode(InvoiceRequest request) {
        if (request.getInvoiceType() != null) return request.getInvoiceType();
        return (request.getExtraConfig() != null && request.getExtraConfig().containsKey("invoiceType")) ?
                (String) request.getExtraConfig().get("invoiceType") : "01";
    }

    private String getTemplateCode(InvoiceRequest request) {
        return (request.getExtraConfig() != null && request.getExtraConfig().containsKey("templateCode")) ?
                (String) request.getExtraConfig().get("templateCode") : "01GTKT0/001";
    }

    public InvoiceResponse toHubResponse(ViettelAdapter.ViettelApiResponse res, String requestId) {
        if (res == null) {
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage("Provider timeout").build();
        }

        boolean success = "200".equals(res.getCode());
        return InvoiceResponse.builder()
                .clientRequestId(requestId)
                .status(success ? InvoiceResponse.ResponseStatus.SUCCESS : InvoiceResponse.ResponseStatus.FAILED)
                .errorCode(res.getCode())
                .errorMessage(res.getMessage())
                .transactionCode(res.getTransactionId())
                .invoiceNumber(res.getData() != null ? res.getData().getInvoiceCode() : null)
                .symbolCode(res.getData() != null ? res.getData().getInvoiceNo() : null)
                .lookupCode(res.getData() != null ? res.getData().getCheckSum() : null)
                .pdfUrl(res.getData() != null ? res.getData().getPdfUrl() : null)
                .responseTime(LocalDateTime.now())
                .rawResponse(res)
                .build();
    }

    public InvoiceStatus mapViettelStatus(ViettelAdapter.ViettelApiResponse response) {
        String status = (response != null && response.getData() != null) ? response.getData().getStatus() : null;
        if (status == null) return InvoiceStatus.FAILED;

        return switch (status.toUpperCase()) {
            case "DA_PHAT_HANH", "SIGNED" -> InvoiceStatus.SUCCESS;
            case "DA_HUY" -> InvoiceStatus.CANCELLED;
            default -> InvoiceStatus.FAILED;
        };
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/vnpt/VnptAdapter.java">
package com.einvoicehub.core.provider.vnpt;

import com.einvoicehub.core.domain.enums.InvoiceStatus;
import com.einvoicehub.core.provider.*;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.reactive.function.client.WebClientResponseException;

import java.math.BigDecimal;
import java.time.Duration;
import java.util.*;

@Slf4j
@Service("VNPT")
public class VnptAdapter implements InvoiceProvider {

    private final WebClient webClient;
    private final VnptApiMapper apiMapper;
    private final ObjectMapper objectMapper;

    @Value("${provider.vnpt.timeout-ms:30000}")
    private int timeoutMs;

    public VnptAdapter(WebClient.Builder webClientBuilder,
                       VnptApiMapper apiMapper,
                       ObjectMapper objectMapper,
                       @Value("${provider.vnpt.base-url:https://api.vnptinvoice.com.vn/v1}") String baseUrl) {
        this.webClient = webClientBuilder
                .baseUrl(baseUrl)
                .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)
                .build();
        this.apiMapper = apiMapper;
        this.objectMapper = objectMapper;
    }

    @Override public String getProviderCode() { return "VNPT"; }
    @Override public String getProviderName() { return "VNPT Invoice"; }
    @Override public boolean isAvailable() { return true; }

    @Override
    public InvoiceResponse issueInvoice(InvoiceRequest request, ProviderConfig config) {
        log.info("VNPT: Issuing invoice for ClientRequestID: {}", request.getClientRequestId());
        try {
            VnptInvoicePayload payload = apiMapper.toVnptPayload(request);
            VnptApiResponse response = webClient.post().uri("/invoices/publish")
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .bodyValue(payload)
                    .retrieve().bodyToMono(VnptApiResponse.class)
                    .timeout(Duration.ofMillis(timeoutMs)).block();

            return apiMapper.toHubResponse(response, request.getClientRequestId());
        } catch (WebClientResponseException e) {
            return apiMapper.toHubResponse(parseError(e.getResponseBodyAsString()), request.getClientRequestId());
        } catch (Exception e) {
            log.error("VNPT: Issuance failed: {}", e.getMessage());
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage(e.getMessage()).build();
        }
    }

    @Override
    public InvoiceStatus getInvoiceStatus(String invoiceNumber, ProviderConfig config) {
        try {
            VnptStatusResponse response = webClient.get()
                    .uri(uri -> uri.path("/invoices/status").queryParam("invoiceNumber", invoiceNumber).build())
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .retrieve().bodyToMono(VnptStatusResponse.class).block();
            return (response != null) ? apiMapper.mapVnptStatus(response.getStatus()) : InvoiceStatus.FAILED;
        } catch (Exception e) {
            log.error("VNPT: Status check failed for {}: {}", invoiceNumber, e.getMessage());
            return InvoiceStatus.FAILED;
        }
    }

    @Override
    public InvoiceResponse cancelInvoice(String invoiceNumber, String reason, ProviderConfig config) {
        try {
            VnptCancelRequest req = VnptCancelRequest.builder().invoiceNumber(invoiceNumber).reason(reason).build();
            VnptApiResponse response = webClient.post().uri("/invoices/cancel")
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .bodyValue(req)
                    .retrieve().bodyToMono(VnptApiResponse.class).block();
            return apiMapper.toHubResponse(response, null);
        } catch (Exception e) {
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage(e.getMessage()).build();
        }
    }

    @Override
    public InvoiceResponse replaceInvoice(String oldNo, InvoiceRequest newReq, ProviderConfig config) {
        /* Standard VNPT flow: Cancel old and issue new */
        InvoiceResponse cancelRes = cancelInvoice(oldNo, "Replaced by new invoice", config);
        if (cancelRes.isFailed()) return cancelRes;
        return issueInvoice(newReq, config);
    }

    @Override
    public String getInvoicePdf(String invoiceNumber, ProviderConfig config) {
        try {
            VnptPdfResponse res = webClient.get().uri("/invoices/{id}/pdf", invoiceNumber)
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .retrieve().bodyToMono(VnptPdfResponse.class).block();
            return res != null ? res.getPdfUrl() : null;
        } catch (Exception e) { return null; }
    }

    @Override
    public String getInvoiceXml(String invoiceNumber, ProviderConfig config) {
        try {
            VnptXmlResponse res = webClient.get().uri("/invoices/{id}/xml", invoiceNumber)
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .retrieve().bodyToMono(VnptXmlResponse.class).block();
            return res != null ? res.getXmlData() : null;
        } catch (Exception e) {
            log.error("VNPT: XML retrieval failed: {}", e.getMessage());
            return null;
        }
    }

    @Override
    public String authenticate(ProviderConfig config) {
        try {
            VnptAuthRequest req = VnptAuthRequest.builder().username(config.getUsername()).password(config.getPassword()).build();
            VnptAuthResponse res = webClient.post().uri("/auth/login").bodyValue(req).retrieve().bodyToMono(VnptAuthResponse.class).block();
            return (res != null) ? res.getAccessToken() : null;
        } catch (Exception e) { return null; }
    }

    @Override public boolean testConnection(ProviderConfig config) { return authenticate(config) != null; }

    private VnptApiResponse parseError(String body) {
        try { return objectMapper.readValue(body, VnptApiResponse.class); } catch (Exception e) { return null; }
    }

    /* Inner Models */
    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptInvoicePayload {
        private String invoiceType, templateCode, issueDate;
        private VnptParty seller, buyer;
        private List<VnptInvoiceDetail> details;
        private VnptSummary summary;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptParty {
        private String taxCode, companyName, address, phone, email, bankAccount, bankName, representativeName;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptInvoiceDetail {
        private String itemName, unitName, taxCategory, description;
        private BigDecimal quantity, unitPrice, amount, discountAmount, taxRate;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptSummary {
        private BigDecimal subtotalAmount, totalDiscountAmount, totalTaxAmount, totalAmount;
    }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptApiResponse {
        private boolean success;
        private String errorCode, message, transactionId, invoiceNumber, fkey, lookupCode, securityCode, pdfUrl;
    }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptStatusResponse { private String status, invoiceNumber; }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptCancelRequest { private String invoiceNumber, reason; }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptAuthRequest { private String username, password; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptAuthResponse { private String accessToken, refreshToken; private long expiresIn; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptPdfResponse { private String pdfUrl; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptXmlResponse { private String xmlData; }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/vnpt/VnptApiMapper.java">
package com.einvoicehub.core.provider.vnpt;

import com.einvoicehub.core.domain.enums.InvoiceStatus;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;

@Slf4j
@Component
@RequiredArgsConstructor
public class VnptApiMapper {

    public InvoiceResponse toHubResponse(VnptAdapter.VnptApiResponse res, String requestId) {
        if (res == null) {
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage("No response from provider").build();
        }

        return InvoiceResponse.builder()
                .clientRequestId(requestId)
                .status(res.isSuccess() ? InvoiceResponse.ResponseStatus.SUCCESS : InvoiceResponse.ResponseStatus.FAILED)
                .errorCode(res.getErrorCode())
                .errorMessage(res.getMessage())
                .transactionCode(res.getTransactionId())
                .invoiceNumber(res.getInvoiceNumber())
                /* VNPT fkey typically contains series and template info */
                .symbolCode(res.getFkey() != null && res.getFkey().length() > 10 ? res.getFkey().substring(0, 10) : res.getFkey())
                .templateCode(res.getFkey())
                .lookupCode(res.getLookupCode())
                .securityCode(res.getSecurityCode())
                .pdfUrl(res.getPdfUrl())
                .responseTime(LocalDateTime.now())
                .rawResponse(res)
                .build();
    }

    public VnptAdapter.VnptInvoicePayload toVnptPayload(InvoiceRequest request) {
        List<VnptAdapter.VnptInvoiceDetail> details = request.getItems().stream()
                .map(this::convertToVnptDetail)
                .toList();

        return VnptAdapter.VnptInvoicePayload.builder()
                .invoiceType(request.getInvoiceType() != null ? request.getInvoiceType() : "01GTKT")
                .templateCode(request.getExtraConfig() != null ?
                        (String) request.getExtraConfig().getOrDefault("templateCode", "01GTKT0/001") : "01GTKT0/001")
                .issueDate(request.getIssueDate() != null ?
                        request.getIssueDate().format(DateTimeFormatter.ISO_DATE) :
                        LocalDateTime.now().format(DateTimeFormatter.ISO_DATE))
                .seller(VnptAdapter.VnptParty.builder()
                        .taxCode(request.getSeller().getTaxCode())
                        .companyName(request.getSeller().getName())
                        .address(request.getSeller().getAddress())
                        .phone(request.getSeller().getPhone())
                        .email(request.getSeller().getEmail())
                        .build())
                .buyer(VnptAdapter.VnptParty.builder()
                        .taxCode(request.getBuyer().getTaxCode())
                        .companyName(request.getBuyer().getName())
                        .address(request.getBuyer().getAddress())
                        .phone(request.getBuyer().getPhone())
                        .email(request.getBuyer().getEmail())
                        .build())
                .details(details)
                .summary(VnptAdapter.VnptSummary.builder()
                        .subtotalAmount(request.getSummary().getSubtotalAmount())
                        .totalDiscountAmount(request.getSummary().getTotalDiscountAmount())
                        .totalTaxAmount(request.getSummary().getTotalTaxAmount())
                        .totalAmount(request.getSummary().getTotalAmount())
                        .build())
                .build();
    }

    private VnptAdapter.VnptInvoiceDetail convertToVnptDetail(InvoiceRequest.InvoiceItem item) {
        return VnptAdapter.VnptInvoiceDetail.builder()
                .itemName(item.getItemName())
                .unitName(item.getUnitName())
                .quantity(item.getQuantity())
                .unitPrice(item.getUnitPrice())
                .amount(item.getAmount())
                .discountAmount(item.getDiscountAmount())
                .taxRate(item.getTaxRate())
                .taxCategory(item.getTaxCategory() != null ? item.getTaxCategory() : "5")
                .description(item.getDescription())
                .build();
    }

    public InvoiceStatus mapVnptStatus(String vnptStatus) {
        if (vnptStatus == null) return InvoiceStatus.FAILED;
        return switch (vnptStatus.toUpperCase()) {
            case "ISSUED", "SUCCESS" -> InvoiceStatus.SUCCESS;
            case "CANCELLED" -> InvoiceStatus.CANCELLED;
            case "REPLACED" -> InvoiceStatus.REPLACED;
            default -> InvoiceStatus.FAILED;
        };
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/InvoiceProvider.java">
package com.einvoicehub.core.provider;

import com.einvoicehub.core.domain.enums.InvoiceStatus;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;

public interface InvoiceProvider {
    String getProviderCode();
    String getProviderName();
    boolean isAvailable();

    InvoiceResponse issueInvoice(InvoiceRequest request, ProviderConfig config);
    InvoiceStatus getInvoiceStatus(String invoiceNumber, ProviderConfig config);
    InvoiceResponse cancelInvoice(String invoiceNumber, String reason, ProviderConfig config);
    InvoiceResponse replaceInvoice(String oldInvoiceNumber, InvoiceRequest newRequest, ProviderConfig config);

    /* Returns PDF content as Base64 or URL */
    String getInvoicePdf(String invoiceNumber, ProviderConfig config);

    /* Returns legal XML content as Base64 or String */
    String getInvoiceXml(String invoiceNumber, ProviderConfig config);

    String authenticate(ProviderConfig config);
    boolean testConnection(ProviderConfig config);
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/ProviderConfig.java">
package com.einvoicehub.core.provider;

import lombok.*;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ProviderConfig {
    private Long configId;
    private String providerCode;
    private String providerName;
    private String username;

    @ToString.Exclude
    private String password;

    private String appId;

    @ToString.Exclude
    private String secretKey;

    private String customApiUrl;
    private String certificateSerial;

    @ToString.Exclude
    private String certificateData;
    private LocalDateTime certificateExpiredAt;

    private String extraConfigJson;

    @ToString.Exclude
    private String accessToken;
    private LocalDateTime tokenExpiredAt;

    public boolean hasValidCertificate() {
        return certificateData != null && !certificateData.isEmpty() &&
                (certificateExpiredAt == null || certificateExpiredAt.isAfter(LocalDateTime.now()));
    }

    /* Check if token is valid with a 5-minute safety buffer */
    public boolean hasValidToken() {
        return accessToken != null && !accessToken.isEmpty() &&
                (tokenExpiredAt == null || tokenExpiredAt.isAfter(LocalDateTime.now().plusMinutes(5)));
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/ProviderFactory.java">
package com.einvoicehub.core.provider;

import com.einvoicehub.core.provider.exception.ProviderException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.Map;
import java.util.function.Function;
import java.util.stream.Collectors;

@Component
public class ProviderFactory {
    private final Map<String, InvoiceProvider> providerMap;

    @Autowired
    public ProviderFactory(List<InvoiceProvider> providers) {
        this.providerMap = providers.stream()
                .collect(Collectors.toUnmodifiableMap(
                        p -> p.getProviderCode().toUpperCase(),
                        Function.identity()
                ));
    }

    public InvoiceProvider getProvider(String providerCode) {
        if (providerCode == null) throw new ProviderException("Provider code cannot be null", "SYSTEM", "NULL_CODE");

        InvoiceProvider provider = providerMap.get(providerCode.toUpperCase());
        if (provider == null) {
            throw new ProviderException("Unsupported provider: " + providerCode, providerCode, "PROVIDER_NOT_FOUND");
        }
        return provider;
    }

    public boolean hasProvider(String providerCode) {
        return providerCode != null && providerMap.containsKey(providerCode.toUpperCase());
    }

    public List<String> getAvailableProviders() {
        return providerMap.values().stream()
                .filter(InvoiceProvider::isAvailable)
                .map(InvoiceProvider::getProviderCode)
                .collect(Collectors.toList());
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/security/ApiKeyAuthenticationToken.java">
package com.einvoicehub.core.security;

import com.einvoicehub.core.domain.entity.ApiCredential;
import com.einvoicehub.core.domain.entity.MerchantEntity;
import lombok.Getter;
import org.springframework.security.authentication.AbstractAuthenticationToken;
import org.springframework.security.core.GrantedAuthority;

import java.util.Collection;

@Getter
public class ApiKeyAuthenticationToken extends AbstractAuthenticationToken {

    private final String clientId;
    private final String apiKey;
    private final ApiCredential credential;
    private final MerchantEntity merchant;

    public ApiKeyAuthenticationToken(String clientId, String apiKey,
                                     ApiCredential credential, MerchantEntity merchant,
                                     Collection<? extends GrantedAuthority> authorities) {
        super(authorities);
        this.clientId = clientId;
        this.apiKey = apiKey;
        this.credential = credential;
        this.merchant = merchant;
        setAuthenticated(authorities != null && !authorities.isEmpty());
    }

    @Override
    public Object getCredentials() {
        return apiKey;
    }

    @Override
    public Object getPrincipal() {
        return clientId;
    }

    public Long getMerchantId() {
        return merchant != null ? merchant.getId() : null;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/security/ApiKeyFilter.java">
package com.einvoicehub.core.security;

import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.domain.entity.MerchantEntity;
import com.einvoicehub.core.domain.enums.EntityStatus;
import com.einvoicehub.core.domain.entity.ApiCredential;
import com.fasterxml.jackson.databind.ObjectMapper;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.MediaType;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.util.AntPathMatcher;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.*;

@Slf4j
@Component
@RequiredArgsConstructor
public class ApiKeyFilter extends OncePerRequestFilter {

    private static final String API_KEY_HEADER = "X-API-KEY";
    private static final String CLIENT_ID_HEADER = "X-CLIENT-ID";

    private final ApiCredentialRepository apiCredentialRepository;
    private final ObjectMapper objectMapper;
    private final AntPathMatcher pathMatcher = new AntPathMatcher();

    private static final Set<String> PUBLIC_PATHS = Set.of(
            "/api/v1/auth/**",
            "/api/v1/health/**",
            "/api/v1/public/**",
            "/actuator/**"
    );

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response,
                                    FilterChain filterChain) throws ServletException, IOException {

        if (isPublicPath(request.getRequestURI())) {
            filterChain.doFilter(request, response);
            return;
        }

        String clientId = request.getHeader(CLIENT_ID_HEADER);
        String apiKey = request.getHeader(API_KEY_HEADER);

        if (clientId == null || apiKey == null) {
            writeErrorResponse(response, ErrorCode.UNAUTHENTICATED, "Missing security headers");
            return;
        }

        ApiCredential credential = apiCredentialRepository
                .findByClientIdAndIsActiveTrue(clientId)
                .orElse(null);

        if (credential == null || !hashApiKey(apiKey).equals(credential.getApiKeyHash())) {
            writeErrorResponse(response, ErrorCode.API_KEY_INVALID, "Invalid credentials");
            return;
        }

        if (!credential.isValid()) {
            writeErrorResponse(response, ErrorCode.API_KEY_INVALID, "Credential expired or inactive");
            return;
        }

        /* IP Whitelist validation */
        if (credential.getIpWhitelist() != null && !credential.getIpWhitelist().isBlank()) {
            String clientIp = getClientIp(request);
            if (!isIpAllowed(clientIp, credential.getIpWhitelist())) {
                writeErrorResponse(response, ErrorCode.UNAUTHORIZED, "IP address not whitelisted");
                return;
            }
        }

        /* Rate limit validation */
        if (!credential.canMakeRequest()) {
            writeErrorResponse(response, ErrorCode.VALIDATION_ERROR, "Rate limit exceeded");
            return;
        }

        MerchantEntity merchant = credential.getMerchant();
        if (merchant == null || merchant.getIsDeleted() || merchant.getStatus() != EntityStatus.ACTIVE) {
            writeErrorResponse(response, ErrorCode.UNAUTHORIZED, "Merchant account is inactive");
            return;
        }

        List<SimpleGrantedAuthority> authorities = buildAuthorities(credential.getScopes());
        ApiKeyAuthenticationToken auth = new ApiKeyAuthenticationToken(clientId, apiKey, credential, merchant, authorities);

        credential.incrementRequestCount();
        apiCredentialRepository.save(credential);

        SecurityContextHolder.getContext().setAuthentication(auth);
        filterChain.doFilter(request, response);
    }

    private boolean isPublicPath(String path) {
        return PUBLIC_PATHS.stream().anyMatch(pattern -> pathMatcher.match(pattern, path));
    }

    private String hashApiKey(String apiKey) {
        try {
            MessageDigest digest = MessageDigest.getInstance("SHA-256");
            byte[] hash = digest.digest(apiKey.getBytes(StandardCharsets.UTF_8));
            return HexFormat.of().formatHex(hash);
        } catch (NoSuchAlgorithmException e) {
            throw new RuntimeException("SHA-256 not available", e);
        }
    }

    private String getClientIp(HttpServletRequest request) {
        String xf = request.getHeader("X-Forwarded-For");
        return (xf != null) ? xf.split(",")[0].trim() : request.getRemoteAddr();
    }

    private boolean isIpAllowed(String clientIp, String whitelist) {
        return Arrays.stream(whitelist.split(","))
                .map(String::trim)
                .anyMatch(allowed -> allowed.equals(clientIp));
    }

    private List<SimpleGrantedAuthority> buildAuthorities(String scopes) {
        if (scopes == null || scopes.isBlank()) return List.of(new SimpleGrantedAuthority("ROLE_API"));
        return Arrays.stream(scopes.split(","))
                .map(s -> new SimpleGrantedAuthority("SCOPE_" + s.trim().toUpperCase().replace(".", "_")))
                .toList();
    }

    private void writeErrorResponse(HttpServletResponse response, ErrorCode errorCode, String message) throws IOException {
        response.setStatus(errorCode.getStatusCode().value());
        response.setContentType(MediaType.APPLICATION_JSON_VALUE);
        ApiResponse<?> apiResponse = ApiResponse.error(errorCode, message);
        response.getWriter().write(objectMapper.writeValueAsString(apiResponse));
    }

    @Override
    protected boolean shouldNotFilter(HttpServletRequest request) {
        return !request.getRequestURI().startsWith("/api/");
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/security/JwtAuthenticationFilter.java">
package com.einvoicehub.core.security;

import com.einvoicehub.core.domain.entity.MerchantUserEntity;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.List;

@Slf4j
@Component
@RequiredArgsConstructor
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    private static final String AUTHORIZATION_HEADER = "Authorization";
    private static final String BEARER_PREFIX = "Bearer ";

    private final JwtTokenProvider jwtTokenProvider;
    private final MerchantUserRepository userRepository;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response,
                                    FilterChain filterChain) throws ServletException, IOException {
        try {
            String jwt = extractJwt(request);

            if (StringUtils.hasText(jwt) && jwtTokenProvider.validateToken(jwt)) {
                String username = jwtTokenProvider.getUsernameFromToken(jwt);

                MerchantUserEntity user = userRepository.findByUsernameAndIsActiveTrue(username).orElse(null);

                if (user != null && !user.isLocked()) {
                    List<SimpleGrantedAuthority> authorities = List.of(
                            new SimpleGrantedAuthority("ROLE_" + user.getRole().name())
                    );

                    UsernamePasswordAuthenticationToken auth = new UsernamePasswordAuthenticationToken(user, null, authorities);
                    auth.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));

                    SecurityContextHolder.getContext().setAuthentication(auth);
                    log.debug("Authenticated user: {} via JWT", username);
                }
            }
        } catch (Exception e) {
            log.error("Failed to set user authentication: {}", e.getMessage());
        }

        filterChain.doFilter(request, response);
    }

    private String extractJwt(HttpServletRequest request) {
        String bearerToken = request.getHeader(AUTHORIZATION_HEADER);
        if (StringUtils.hasText(bearerToken) && bearerToken.startsWith(BEARER_PREFIX)) {
            return bearerToken.substring(BEARER_PREFIX.length());
        }
        return null;
    }

    @Override
    protected boolean shouldNotFilter(HttpServletRequest request) {
        String path = request.getRequestURI();
        return !path.startsWith("/api/v1/admin/") && !path.startsWith("/api/v1/auth/");
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/security/JwtTokenProvider.java">
package com.einvoicehub.core.security;

import io.jsonwebtoken.*;
import io.jsonwebtoken.security.Keys;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import javax.crypto.SecretKey;
import java.nio.charset.StandardCharsets;
import java.util.Date;

@Slf4j
@Component
public class JwtTokenProvider {

    private final SecretKey signingKey;
    private final long expirationMs;

    public JwtTokenProvider(@Value("${app.jwt.secret}") String secret,
                            @Value("${app.jwt.expiration-ms:86400000}") long expirationMs) {
        this.signingKey = Keys.hmacShaKeyFor(secret.getBytes(StandardCharsets.UTF_8));
        this.expirationMs = expirationMs;
    }

    public String generateToken(String username, String role) {
        Date now = new Date();
        Date expiryDate = new Date(now.getTime() + expirationMs);

        return Jwts.builder()
                .subject(username)
                .claim("role", role)
                .issuedAt(now)
                .expiration(expiryDate)
                .signWith(signingKey)
                .compact();
    }

    public String getUsernameFromToken(String token) {
        return Jwts.parser()
                .verifyWith(signingKey)
                .build()
                .parseSignedClaims(token)
                .getPayload()
                .getSubject();
    }

    public boolean validateToken(String token) {
        try {
            Jwts.parser().verifyWith(signingKey).build().parseSignedClaims(token);
            return true;
        } catch (MalformedJwtException e) {
            log.error("Invalid JWT token structure");
        } catch (ExpiredJwtException e) {
            log.error("JWT token has expired");
        } catch (UnsupportedJwtException e) {
            log.error("JWT token type is unsupported");
        } catch (IllegalArgumentException e) {
            log.error("JWT claims string is empty");
        } catch (JwtException e) {
            log.error("JWT validation error: {}", e.getMessage());
        }
        return false;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/security/SecurityConfig.java">
package com.einvoicehub.core.security;

import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.annotation.Order;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
@EnableWebSecurity
@EnableMethodSecurity
@RequiredArgsConstructor
public class SecurityConfig {

    private final ApiKeyFilter apiKeyFilter;
    private final JwtAuthenticationFilter jwtAuthenticationFilter;

    @Bean
    @Order(1)
    public SecurityFilterChain apiSecurityFilterChain(HttpSecurity http) throws Exception {
        http
                .securityMatcher("/api/v1/invoices/**", "/api/v1/merchants/**", "/api/v1/configs/**")
                .csrf(AbstractHttpConfigurer::disable)
                .sessionManagement(s -> s.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(auth -> auth.anyRequest().authenticated())
                .addFilterBefore(apiKeyFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    @Bean
    @Order(2)
    public SecurityFilterChain adminSecurityFilterChain(HttpSecurity http) throws Exception {
        http
                .securityMatcher("/api/v1/admin/**", "/api/v1/portal/**")
                .csrf(AbstractHttpConfigurer::disable)
                .sessionManagement(s -> s.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/api/v1/auth/login").permitAll()
                        .requestMatchers("/api/v1/admin/users/**").hasRole("ADMIN")
                        .anyRequest().authenticated())
                .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    @Bean
    @Order(3)
    public SecurityFilterChain defaultSecurityFilterChain(HttpSecurity http) throws Exception {
        http
                .csrf(AbstractHttpConfigurer::disable)
                .sessionManagement(s -> s.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/actuator/**", "/api/v1/public/**").permitAll()
                        .anyRequest().denyAll());

        return http.build();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvApiCredentialService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.domain.entity.EinvApiCredentialsEntity;
import com.einvoicehub.core.domain.entity.EinvMerchantEntity;
import com.einvoicehub.core.domain.repository.EinvApiCredentialRepository;
import com.einvoicehub.core.domain.repository.EinvMerchantRepository;
import com.einvoicehub.core.dto.EinvApiCredentialDto;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvApiCredentialService {

    private final EinvApiCredentialRepository repository;
    private final EinvMerchantRepository merchantRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvApiCredentialDto> getByMerchant(Long merchantId) {
        log.info("[API] Truy v·∫•n danh s√°ch API Key cho Merchant ID: {}", merchantId);
        // L∆∞u √Ω: Repository findByFilters tr·∫£ v·ªÅ Page, ·ªü ƒë√¢y l·ªçc ƒë∆°n gi·∫£n
        return repository.findAll().stream()
                .filter(c -> c.getMerchant().getId().equals(merchantId))
                .map(mapper::toDto)
                .collect(Collectors.toList());
    }

    @Transactional
    public EinvApiCredentialDto create(Long merchantId, String scopeJson) {
        log.info("[API] T·∫°o m·ªõi API Key cho Merchant ID: {}", merchantId);

        EinvMerchantEntity merchant = merchantRepository.findById(merchantId)
                .filter(m -> !m.getIsDeleted())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND));

        // Sinh ClientID v√† API Key th√¥ (Logic SOFTZ cho t√≠ch h·ª£p)
        String clientId = UUID.randomUUID().toString().replace("-", "").substring(0, 20);
        String rawApiKey = UUID.randomUUID().toString().replace("-", "");

        EinvApiCredentialsEntity entity = EinvApiCredentialsEntity.builder()
                .merchant(merchant)
                .clientId(clientId)
                .apiKeyPrefix(rawApiKey.substring(0, 8))
                .apiKeyHash("SHA256_HASH_OF_" + rawApiKey) // Th·ª±c t·∫ø d√πng hashing chu·∫©n
                .scopes(scopeJson != null ? scopeJson : "[\"invoice:read\", \"invoice:create\"]")
                .isActive(true)
                .rateLimitPerHour(1000)
                .rateLimitPerDay(10000)
                .build();

        log.info("[API] ƒê√£ c·∫•p m·ªõi API Key v·ªõi ClientID: {}", clientId);
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[API] Thu h·ªìi API Key ID: {}", id);
        if (!repository.existsById(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√≥a API kh√¥ng t·ªìn t·∫°i");
        }
        repository.deleteById(id);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvAuditLogService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.EinvAuditLogsEntity;
import com.einvoicehub.core.domain.repository.EinvAuditLogRepository;
import com.einvoicehub.core.dto.response.EinvAuditLogResponse;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvAuditLogService {

    private final EinvAuditLogRepository repository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvAuditLogResponse> getAll() {
        log.info("[Audit] L·∫•y danh s√°ch to√†n b·ªô nh·∫≠t k√Ω h·ªá th·ªëng");
        return repository.findAll().stream()
                .map(mapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvAuditLogResponse getById(Long id) {
        return repository.findById(id)
                .map(mapper::toResponse)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y b·∫£n ghi nh·∫≠t k√Ω"));
    }

    @Transactional
    public void log(EinvAuditLogsEntity entity) {
        log.debug("[Audit] L∆∞u v·∫øt h√†nh ƒë·ªông: {} tr√™n ƒë·ªëi t∆∞·ª£ng {}", entity.getAction(), entity.getEntityType());

        if (entity.getEntityType() == null || entity.getEntityId() == null) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "D·ªØ li·ªáu nh·∫≠t k√Ω thi·∫øu th√¥ng tin ƒë·ªãnh danh");
        }

        repository.save(entity);
    }

    @Transactional
    public EinvAuditLogResponse update(Long id, String extraNote) {
        log.warn("[Audit] C·∫≠p nh·∫≠t th√¥ng tin b·ªï sung cho log ID: {}", id);
        EinvAuditLogsEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Nh·∫≠t k√Ω kh√¥ng t·ªìn t·∫°i"));

        entity.setUserAgent(entity.getUserAgent() + " | Supplement: " + extraNote);

        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.error("[Audit] C·∫¢NH B√ÅO: Thao t√°c x√≥a b·∫£n ghi nh·∫≠t k√Ω ID: {}", id);
        if (!repository.existsById(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i ƒë·ªÉ x√≥a");
        }
        // Trong h·ªá th·ªëng t√†i ch√≠nh,log ch·ªâ ƒë∆∞·ª£c x√≥a sau 10 nƒÉm .·ªû ƒë√¢y ta tri·ªÉn khai h√†m x√≥a c∆° b·∫£n cho Admin.
        repository.deleteById(id);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvInvoiceAdjustmentService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.EinvInvoiceAdjustmentsEntity;
import com.einvoicehub.core.domain.entity.EinvInvoiceMetadataEntity;
import com.einvoicehub.core.domain.repository.EinvInvoiceAdjustmentRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.dto.request.EinvInvoiceAdjustmentRequest;
import com.einvoicehub.core.dto.response.EinvInvoiceAdjustmentResponse;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvInvoiceAdjustmentService {

    private final EinvInvoiceAdjustmentRepository repository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvInvoiceAdjustmentResponse> getAll() {
        log.info("[Adjustment] Truy v·∫•n danh s√°ch bi√™n b·∫£n ƒëi·ªÅu ch·ªânh");
        return repository.findAll().stream()
                .map(mapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvInvoiceAdjustmentResponse getById(Long id) {
        log.info("[Adjustment] T√¨m ki·∫øm bi√™n b·∫£n ID: {}", id);
        return repository.findById(id).map(mapper::toResponse)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y bi√™n b·∫£n"));
    }

    @Transactional
    public EinvInvoiceAdjustmentResponse create(EinvInvoiceAdjustmentRequest request) {
        log.info("[Adjustment] L·∫≠p bi√™n b·∫£n {} cho h√≥a ƒë∆°n g·ªëc ID: {}",
                request.getAdjustmentType(), request.getOriginalInvoiceId());
        EinvInvoiceMetadataEntity originalInvoice = metadataRepository.findById(request.getOriginalInvoiceId())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n g·ªëc kh√¥ng t·ªìn t·∫°i"));

        if (originalInvoice.getInvoiceStatus().getId() != 5) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Ch·ªâ ƒë∆∞·ª£c ph√©p l·∫≠p bi√™n b·∫£n cho h√≥a ƒë∆°n ƒë√£ g·ª≠i CQT th√†nh c√¥ng");
        }

        if (Boolean.TRUE.equals(originalInvoice.getMerchant().getIsDeleted())) {
            throw new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND, "Doanh nghi·ªáp ƒë√£ b·ªã kh√≥a");
        }

        EinvInvoiceAdjustmentsEntity entity = mapper.toEntity(request);
        entity.setOriginalInvoice(originalInvoice);

        BigDecimal difference = request.getNewTotalAmount().subtract(request.getOldTotalAmount());
        entity.setDifferenceAmount(difference);

        entity = repository.save(entity);
        log.info("[Adjustment] ƒê√£ l∆∞u bi√™n b·∫£n ƒëi·ªÅu ch·ªânh ID: {}", entity.getId());
        return mapper.toResponse(entity);
    }

    @Transactional
    public EinvInvoiceAdjustmentResponse update(Long id, EinvInvoiceAdjustmentRequest request) {
        log.info("[Adjustment] C·∫≠p nh·∫≠t bi√™n b·∫£n ID: {}", id);
        EinvInvoiceAdjustmentsEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Bi√™n b·∫£n kh√¥ng t·ªìn t·∫°i"));

        if (!"PENDING".equals(entity.getStatus().name())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Bi√™n b·∫£n ƒë√£ ƒë∆∞·ª£c duy·ªát ho·∫∑c g·ª≠i ƒëi, kh√¥ng th·ªÉ s·ª≠a");
        }

        entity.setAgreementNumber(request.getAgreementNumber());
        entity.setAgreementDate(request.getAgreementDate());
        entity.setReasonDescription(request.getReasonDescription());
        entity.setNewTotalAmount(request.getNewTotalAmount());
        entity.setDifferenceAmount(request.getNewTotalAmount().subtract(entity.getOldTotalAmount()));

        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Adjustment] Y√™u c·∫ßu x√≥a bi√™n b·∫£n ID: {}", id);
        EinvInvoiceAdjustmentsEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i"));

        if (Boolean.TRUE.equals(entity.getSubmittedToCqt())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Bi√™n b·∫£n ƒë√£ ƒë∆∞·ª£c g·ª≠i cho C∆° quan Thu·∫ø, kh√¥ng th·ªÉ x√≥a");
        }

        repository.delete(entity);
        log.info("[Adjustment] ƒê√£ x√≥a bi√™n b·∫£n ID: {}", id);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvInvoiceItemService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.*;
import com.einvoicehub.core.domain.repository.*;
import com.einvoicehub.core.dto.EinvInvoiceItemDto;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvInvoiceItemService {

    private final EinvInvoiceItemRepository repository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvVatRateRepository vatRateRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvInvoiceItemDto> getByInvoiceId(Long invoiceId) {
        log.info("[Item] L·∫•y danh s√°ch h√†ng h√≥a cho h√≥a ƒë∆°n ID: {}", invoiceId);
        return repository.findByInvoiceIdOrderByLineNumberAsc(invoiceId).stream()
                .map(mapper::toDto)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvInvoiceItemDto getById(Long id) {
        return repository.findById(id).map(mapper::toDto)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "D√≤ng h√†ng kh√¥ng t·ªìn t·∫°i"));
    }


    @Transactional
    public EinvInvoiceItemDto create(Long invoiceId, EinvInvoiceItemDto dto) {
        log.info("[Item] Th√™m h√†ng h√≥a m·ªõi v√†o h√≥a ƒë∆°n ID: {}", invoiceId);

        EinvInvoiceMetadataEntity invoice = metadataRepository.findById(invoiceId)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n cha kh√¥ng t·ªìn t·∫°i"));
        if (invoice.getInvoiceStatus().getId() != 1) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n ƒë√£ ch·ªët, kh√¥ng ƒë∆∞·ª£c th√™m d√≤ng h√†ng");
        }

        EinvInvoiceItemEntity entity = mapper.toEntity(dto);
        entity.setInvoice(invoice);
        calculateItemAmounts(entity);
        entity = repository.save(entity);
        updateInvoiceTotals(invoice);

        return mapper.toDto(entity);
    }

    @Transactional
    public EinvInvoiceItemDto update(Long id, EinvInvoiceItemDto dto) {
        log.info("[Item] C·∫≠p nh·∫≠t d√≤ng h√†ng ID: {}", id);
        EinvInvoiceItemEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i"));

        if (entity.getInvoice().getInvoiceStatus().getId() != 1) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n ƒë√£ ch·ªët, kh√¥ng ƒë∆∞·ª£c s·ª≠a d√≤ng h√†ng");
        }

        entity.setProductName(dto.getProductName());
        entity.setQuantity(dto.getQuantity());
        entity.setUnitPrice(dto.getUnitPrice());
        entity.setDiscountAmount(dto.getDiscountAmount());

        calculateItemAmounts(entity);
        entity = repository.save(entity);

        updateInvoiceTotals(entity.getInvoice());
        return mapper.toDto(entity);
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Item] X√≥a d√≤ng h√†ng ID: {}", id);
        EinvInvoiceItemEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i"));

        EinvInvoiceMetadataEntity invoice = entity.getInvoice();
        if (invoice.getInvoiceStatus().getId() != 1) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n ƒë√£ ph√°t h√†nh, kh√¥ng th·ªÉ x√≥a chi ti·∫øt");
        }

        repository.delete(entity);
        updateInvoiceTotals(invoice);
    }

    private void calculateItemAmounts(EinvInvoiceItemEntity entity) {
        BigDecimal qty = entity.getQuantity() != null ? entity.getQuantity() : BigDecimal.ZERO;
        BigDecimal price = entity.getUnitPrice() != null ? entity.getUnitPrice() : BigDecimal.ZERO;
        BigDecimal discount = entity.getDiscountAmount() != null ? entity.getDiscountAmount() : BigDecimal.ZERO;

        BigDecimal gross = qty.multiply(price).setScale(2, RoundingMode.HALF_UP);
        entity.setGrossAmount(gross);

        BigDecimal net = gross.subtract(discount);
        entity.setNetAmount(net);

        if (entity.getVatRate() != null) {
            BigDecimal taxRate = entity.getVatRate().getRatePercent().divide(new BigDecimal("100"), 4, RoundingMode.HALF_UP);
            BigDecimal taxAmount = net.multiply(taxRate).setScale(2, RoundingMode.HALF_UP);
            entity.setTaxAmount(taxAmount);
            entity.setTaxRate(entity.getVatRate().getRatePercent());
        }
        entity.setTotalAmount(net.add(entity.getTaxAmount() != null ? entity.getTaxAmount() : BigDecimal.ZERO));
    }

    private void updateInvoiceTotals(EinvInvoiceMetadataEntity invoice) {
        List<EinvInvoiceItemEntity> items = repository.findByInvoiceIdOrderByLineNumberAsc(invoice.getId());

        BigDecimal subtotal = items.stream().map(EinvInvoiceItemEntity::getNetAmount).reduce(BigDecimal.ZERO, BigDecimal::add);
        BigDecimal tax = items.stream().map(i -> i.getTaxAmount() != null ? i.getTaxAmount() : BigDecimal.ZERO).reduce(BigDecimal.ZERO, BigDecimal::add);

        invoice.setSubtotalAmount(subtotal);
        invoice.setTaxAmount(tax);
        invoice.setTotalAmount(subtotal.add(tax));

        metadataRepository.save(invoice);
        log.debug("[Transaction] ƒê√£ c·∫≠p nh·∫≠t l·∫°i t·ªïng ti·ªÅn cho h√≥a ƒë∆°n ID: {}. T·ªïng c·ªông: {}", invoice.getId(), invoice.getTotalAmount());
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvInvoiceMetadataService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.*;
import com.einvoicehub.core.domain.repository.*;
import com.einvoicehub.core.dto.request.EinvSubmitInvoiceRequest;
import com.einvoicehub.core.dto.response.EinvInvoiceMetadataResponse;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvInvoiceMetadataService {

    private final EinvInvoiceMetadataRepository repository;
    private final EinvMerchantRepository merchantRepository;
    private final EinvInvoiceTemplateRepository templateRepository;
    private final EinvInvoiceStatusRepository statusRepository;
    private final EinvInvoiceItemRepository itemRepository;
    private final EinvInvoiceAdjustmentRepository adjustmentRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvInvoiceMetadataResponse> getAll() {
        log.info("[Transaction] ƒêang l·∫•y danh s√°ch to√†n b·ªô h√≥a ƒë∆°n");
        return repository.findAll().stream()
                .map(mapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvInvoiceMetadataResponse getById(Long id) {
        log.info("[Transaction] T√¨m ki·∫øm h√≥a ƒë∆°n ID: {}", id);
        return repository.findById(id)
                .map(mapper::toResponse)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n kh√¥ng t·ªìn t·∫°i"));
    }

    @Transactional
    public EinvInvoiceMetadataResponse create(EinvSubmitInvoiceRequest request) {
        log.info("[Transaction] B·∫Øt ƒë·∫ßu t·∫°o h√≥a ƒë∆°n cho Merchant ID: {}", request.getInvoiceTypeId());

        EinvInvoiceTemplateEntity template = templateRepository.findById(request.getInvoiceTypeId())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "M·∫´u h√≥a ƒë∆°n kh√¥ng t·ªìn t·∫°i"));

        EinvMerchantEntity merchant = template.getMerchant();
        // Requirement 4: Ki·ªÉm tra tr·∫°ng th√°i ho·∫°t ƒë·ªông c·ªßa Merchant
        if (Boolean.TRUE.equals(merchant.getIsDeleted())) {
            log.error("[Transaction] Merchant {} ƒë√£ ng·ª´ng ho·∫°t ƒë·ªông", merchant.getTaxCode());
            throw new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND, "Doanh nghi·ªáp ƒë√£ ng·ª´ng ho·∫°t ƒë·ªông tr√™n h·ªá th·ªëng");
        }

        synchronized (this) {
            Integer nextNumber = template.getCurrentNumber() + 1;
            if (nextNumber > template.getMaxNumber()) {
                log.error("[Transaction] M·∫´u {} ƒë√£ s·ª≠ d·ª•ng h·∫øt d·∫£i s·ªë (%d/%d)",
                        template.getSymbolCode(), nextNumber, template.getMaxNumber());
                throw new InvalidDataException(ErrorCode.INVALID_DATA, "D·∫£i s·ªë h√≥a ƒë∆°n ƒë√£ h·∫øt, vui l√≤ng th√¥ng b√°o ph√°t h√†nh d·∫£i s·ªë m·ªõi");
            }

            template.setCurrentNumber(nextNumber);
            templateRepository.save(template);

            EinvInvoiceMetadataEntity entity = mapper.toEntity(request);
            entity.setMerchant(merchant);
            entity.setInvoiceTemplate(template);
            entity.setInvoiceNumber(String.format("%08d", nextNumber)); // Format 8 ch·ªØ s·ªë chu·∫©n CQT
            entity.setSymbolCode(template.getSymbolCode());
            entity.setTemplateCode(template.getTemplateCode());

            statusRepository.findById(1).ifPresent(entity::setInvoiceStatus);

            entity.setIsDeleted(false);
            entity = repository.save(entity);

            log.info("[Transaction] ƒê√£ t·∫°o th√†nh c√¥ng h√≥a ƒë∆°n s·ªë: {} (ID: {})", entity.getInvoiceNumber(), entity.getId());
            return mapper.toResponse(entity);
        }
    }

    @Transactional
    public EinvInvoiceMetadataResponse update(Long id, EinvSubmitInvoiceRequest request) {
        log.info("[Transaction] C·∫≠p nh·∫≠t th√¥ng tin h√≥a ƒë∆°n ID: {}", id);
        EinvInvoiceMetadataEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n"));

        if (entity.getInvoiceStatus().getId() != 1) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n ƒë√£ ch·ªët tr·∫°ng th√°i, kh√¥ng th·ªÉ ch·ªânh s·ª≠a");
        }

        entity.setBuyerFullName(request.getBuyerName());
        entity.setBuyerEmail(request.getReceiverEmail());
        entity.setBuyerAddress(request.getBuyerAddress());
        entity.setBuyerTaxCode(request.getBuyerTaxCode());
        entity.setCurrencyCode(request.getCurrencyCode());
        entity.setExchangeRate(request.getExchangeRate());

        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Transaction] ƒêang th·ª±c hi·ªán x√≥a m·ªÅm h√≥a ƒë∆°n ID: {}", id);
        EinvInvoiceMetadataEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n kh√¥ng t·ªìn t·∫°i"));

        if (entity.getInvoiceStatus().getId() != 1) {
            log.error("[Transaction] X√≥a m·ªÅm th·∫•t b·∫°i: H√≥a ƒë∆°n ID {} ƒë√£ ch·ªët tr·∫°ng th√°i", id);
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Ch·ªâ ƒë∆∞·ª£c ph√©p x√≥a h√≥a ƒë∆°n ·ªü tr·∫°ng th√°i Nh√°p");
        }
        if (adjustmentRepository.existsByOriginalInvoiceId(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n n√†y ƒë√£ c√≥ bi√™n b·∫£n li√™n quan, kh√¥ng th·ªÉ x√≥a");
        }

        entity.setIsDeleted(true);
        entity.setDeletedAt(java.time.LocalDateTime.now());
        // entity.setDeletedByUser(currentUser); // N·∫øu c√≥ SecurityContext
        repository.save(entity);
        log.info("[Transaction] ƒê√£ x√≥a m·ªÅm th√†nh c√¥ng h√≥a ƒë∆°n ID: {}", id);
    }

    @Transactional
    public void hardDelete(Long id) {
        log.warn("[Transaction] C·∫¢NH B√ÅO: Th·ª±c hi·ªán x√≥a c·ª©ng h√≥a ƒë∆°n ID: {}", id);
        EinvInvoiceMetadataEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng"));

        if (entity.getInvoiceStatus().getId() != 1) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "L·ªánh x√≥a c·ª©ng b·ªã ch·∫∑n: H√≥a ƒë∆°n kh√¥ng ph·∫£i tr·∫°ng th√°i Nh√°p");
        }

        if (adjustmentRepository.existsByOriginalInvoiceId(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Vi ph·∫°m r√†ng bu·ªôc: H√≥a ƒë∆°n ƒëang c√≥ bi√™n b·∫£n thay th·∫ø/ƒëi·ªÅu ch·ªânh");
        }
        itemRepository.deleteByInvoiceId(id);
        log.debug("[Transaction] ƒê√£ d·ªçn d·∫πp chi ti·∫øt h√†ng h√≥a c·ªßa h√≥a ƒë∆°n ID: {}", id);
        repository.delete(entity);
        log.info("[Transaction] ƒê√£ x√≥a vƒ©nh vi·ªÖn h√≥a ƒë∆°n ID: {} kh·ªèi Database", id);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvInvoicePayloadService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.EinvInvoiceMetadataEntity;
import com.einvoicehub.core.domain.entity.EinvInvoicePayloadEntity;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.domain.repository.EinvInvoicePayloadRepository;
import com.einvoicehub.core.dto.EinvInvoicePayloadDto;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvInvoicePayloadService {

    private final EinvInvoicePayloadRepository repository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvInvoicePayloadDto> getAll() {
        log.info("[Infra] Truy v·∫•n danh s√°ch payload k·ªπ thu·∫≠t");
        return repository.findAll().stream()
                .map(mapper::toDto)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvInvoicePayloadDto getById(Long invoiceId) {
        log.info("[Infra] L·∫•y d·ªØ li·ªáu payload cho h√≥a ƒë∆°n ID: {}", invoiceId);
        return repository.findByInvoiceId(invoiceId)
                .map(mapper::toDto)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n ch∆∞a c√≥ d·ªØ li·ªáu k·ªπ thu·∫≠t"));
    }

    @Transactional
    public EinvInvoicePayloadDto create(EinvInvoicePayloadDto dto) {
        log.info("[Infra] ƒêang kh·ªüi t·∫°o Payload cho h√≥a ƒë∆°n ID: {}", dto.getInvoiceId());
        EinvInvoiceMetadataEntity invoice = metadataRepository.findById(dto.getInvoiceId())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n g·ªëc kh√¥ng t·ªìn t·∫°i"));

        if (Boolean.TRUE.equals(invoice.getMerchant().getIsDeleted())) {
            throw new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND, "Doanh nghi·ªáp ƒë√£ b·ªã kh√≥a, kh√¥ng th·ªÉ t·∫°o d·ªØ li·ªáu");
        }

        if (repository.existsById(dto.getInvoiceId())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Payload cho h√≥a ƒë∆°n n√†y ƒë√£ t·ªìn t·∫°i");
        }

        EinvInvoicePayloadEntity entity = mapper.toEntity(dto);
        entity.setInvoice(invoice);

        entity = repository.save(entity);
        log.info("[Infra] ƒê√£ l∆∞u th√†nh c√¥ng Payload cho h√≥a ƒë∆°n ID: {}", entity.getInvoiceId());
        return mapper.toDto(entity);
    }

    @Transactional
    public EinvInvoicePayloadDto update(Long invoiceId, EinvInvoicePayloadDto dto) {
        log.info("[Infra] C·∫≠p nh·∫≠t n·ªôi dung k√Ω s·ªë cho h√≥a ƒë∆°n ID: {}", invoiceId);

        EinvInvoicePayloadEntity entity = repository.findByInvoiceId(invoiceId)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y payload ƒë·ªÉ c·∫≠p nh·∫≠t"));

        if (entity.getInvoice().getInvoiceStatus().getId() == 5) {
            log.error("[Infra] Ch·∫∑n thao t√°c s·ª≠a d·ªØ li·ªáu h√≥a ƒë∆°n ƒë√£ ph√°t h√†nh th√†nh c√¥ng: {}", invoiceId);
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n ƒë√£ ho√†n t·∫•t, kh√¥ng ƒë∆∞·ª£c ph√©p thay ƒë·ªïi n·ªôi dung k·ªπ thu·∫≠t");
        }
        entity.setSignedXml(dto.getSignedXml());
        entity.setPdfData(dto.getPdfData());
        entity.setJsonContent(dto.getJsonContent());

        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Long invoiceId) {
        log.warn("[Infra] Y√™u c·∫ßu x√≥a vƒ©nh vi·ªÖn Payload h√≥a ƒë∆°n ID: {}", invoiceId);

        EinvInvoicePayloadEntity entity = repository.findByInvoiceId(invoiceId)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i"));

        if (entity.getInvoice().getInvoiceStatus().getId() != 1) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Ch·ªâ ƒë∆∞·ª£c ph√©p x√≥a d·ªØ li·ªáu k·ªπ thu·∫≠t c·ªßa h√≥a ƒë∆°n Nh√°p");
        }
        repository.delete(entity);
        log.info("[Infra] ƒê√£ x√≥a th√†nh c√¥ng Payload c·ªßa h√≥a ƒë∆°n ID: {}", invoiceId);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvInvoiceRegistrationService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.EinvInvoiceRegistrationEntity;
import com.einvoicehub.core.domain.entity.EinvMerchantEntity;
import com.einvoicehub.core.domain.entity.EinvRegistrationStatusEntity;
import com.einvoicehub.core.domain.repository.EinvInvoiceRegistrationRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceTemplateRepository;
import com.einvoicehub.core.domain.repository.EinvMerchantRepository;
import com.einvoicehub.core.domain.repository.EinvRegistrationStatusRepository;
import com.einvoicehub.core.dto.EinvInvoiceRegistrationRequest;
import com.einvoicehub.core.dto.EinvInvoiceRegistrationResponse;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvInvoiceRegistrationService {

    private final EinvInvoiceRegistrationRepository repository;
    private final EinvMerchantRepository merchantRepository;
    private final EinvRegistrationStatusRepository statusRepository;
    private final EinvInvoiceTemplateRepository templateRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvInvoiceRegistrationResponse> getAll() {
        log.info("[Registration] L·∫•y danh s√°ch to√†n b·ªô c√°c d·∫£i s·ªë ƒë√£ ƒëƒÉng k√Ω");
        return repository.findAll().stream()
                .map(mapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvInvoiceRegistrationResponse getById(Long id) {
        log.info("[Registration] Truy v·∫•n chi ti·∫øt ƒëƒÉng k√Ω ID: {}", id);
        return repository.findById(id)
                .map(mapper::toResponse)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y d·∫£i s·ªë ƒëƒÉng k√Ω"));
    }

    @Transactional
    public EinvInvoiceRegistrationResponse create(EinvInvoiceRegistrationRequest request) {
        log.info("[Registration] ƒêang t·∫°o ƒëƒÉng k√Ω m·ªõi cho Merchant ID: {}, S·ªë TB: {}",
                request.getMerchantId(), request.getRegistrationNumber());

        // 1. Ki·ªÉm tra tr·∫°ng th√°i Merchant (Ph·∫£i c√≤n ho·∫°t ƒë·ªông)
        EinvMerchantEntity merchant = merchantRepository.findById(request.getMerchantId())
                .filter(m -> !m.getIsDeleted())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND));

        // 2. Validate d·∫£i s·ªë: From <= To v√† Quantity kh·ªõp
        validateRange(request.getFromNumber(), request.getToNumber(), request.getQuantity());

        // 3. Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng k√Ω
        EinvRegistrationStatusEntity status = statusRepository.findById(request.getStatusId())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Tr·∫°ng th√°i ƒëƒÉng k√Ω kh√¥ng h·ª£p l·ªá"));

        EinvInvoiceRegistrationEntity entity = mapper.toEntity(request);
        entity.setMerchant(merchant);
        entity.setStatus(status);
        entity.setCurrentNumber(0L); // Kh·ªüi t·∫°o s·ªë ƒë√£ d√πng l√† 0

        entity = repository.save(entity);
        log.info("[Registration] ƒê√£ l∆∞u th√†nh c√¥ng d·∫£i s·ªë ID: {}", entity.getId());
        return mapper.toResponse(entity);
    }

    @Transactional
    public EinvInvoiceRegistrationResponse update(Long id, EinvInvoiceRegistrationRequest request) {
        log.info("[Registration] C·∫≠p nh·∫≠t ƒëƒÉng k√Ω ID: {}", id);

        EinvInvoiceRegistrationEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "D·ªØ li·ªáu kh√¥ng t·ªìn t·∫°i"));

        if (Boolean.TRUE.equals(entity.getMerchant().getIsDeleted())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Doanh nghi·ªáp ƒë√£ ng·ª´ng ho·∫°t ƒë·ªông, kh√¥ng th·ªÉ s·ª≠a");
        }

        validateRange(request.getFromNumber(), request.getToNumber(), request.getQuantity());

        entity.setRegistrationNumber(request.getRegistrationNumber());
        entity.setFromNumber(request.getFromNumber());
        entity.setToNumber(request.getToNumber());
        entity.setQuantity(request.getQuantity());
        entity.setEffectiveDate(request.getEffectiveDate());
        entity.setExpirationDate(request.getExpirationDate());
        entity.setIssuedBy(request.getIssuedBy());
        entity.setNote(request.getNote());

        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Registration] Y√™u c·∫ßu x√≥a d·∫£i s·ªë ID: {}", id);

        if (!repository.existsById(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i");
        }

        // Ki·ªÉm tra r√†ng bu·ªôc tham chi·∫øu t·ª´ b·∫£ng invoice_template
        if (templateRepository.existsByRegistrationId(id)) {
            log.error("[Registration] X√≥a th·∫•t b·∫°i: D·∫£i s·ªë ID {} ƒëang ƒë∆∞·ª£c d√πng trong M·∫´u h√≥a ƒë∆°n", id);
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "D·∫£i s·ªë n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ c·∫•u h√¨nh m·∫´u h√≥a ƒë∆°n, kh√¥ng th·ªÉ x√≥a");
        }

        repository.deleteById(id);
        log.info("[Registration] ƒê√£ x√≥a th√†nh c√¥ng d·∫£i s·ªë ID: {}", id);
    }

    private void validateRange(Long from, Long to, Long qty) {
        if (from == null || to == null || from > to) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "D·∫£i s·ªë kh√¥ng h·ª£p l·ªá (S·ªë b·∫Øt ƒë·∫ßu ph·∫£i nh·ªè h∆°n ho·∫∑c b·∫±ng s·ªë k·∫øt th√∫c)");
        }
        if (qty != null && (to - from + 1) != qty) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "S·ªë l∆∞·ª£ng kh√¥ng kh·ªõp v·ªõi d·∫£i s·ªë (To - From + 1 != Quantity)");
        }
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvInvoiceStatusService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.domain.entity.EinvInvoiceStatusEntity;
import com.einvoicehub.core.domain.repository.EinvInvoiceStatusRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.dto.EinvInvoiceStatusDto;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvInvoiceStatusService {

    private final EinvInvoiceStatusRepository repository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvInvoiceStatusDto> getAll() {
        log.info("[Catalog] L·∫•y danh m·ª•c tr·∫°ng th√°i h√≥a ƒë∆°n");
        return repository.findAll().stream().map(mapper::toDto).collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvInvoiceStatusDto getById(Integer id) {
        log.info("[Catalog] T√¨m tr·∫°ng th√°i ID: {}", id);
        return repository.findById(id).map(mapper::toDto)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Tr·∫°ng th√°i kh√¥ng t·ªìn t·∫°i"));
    }

    @Transactional
    public EinvInvoiceStatusDto create(EinvInvoiceStatusDto dto) {
        log.info("[Catalog] Th√™m m·ªõi tr·∫°ng th√°i: {}", dto.getName());
        if (repository.findByName(dto.getName()).isPresent()) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "T√™n tr·∫°ng th√°i ƒë√£ t·ªìn t·∫°i");
        }
        EinvInvoiceStatusEntity entity = mapper.toEntity(dto);
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public EinvInvoiceStatusDto update(Integer id, EinvInvoiceStatusDto dto) {
        log.info("[Catalog] C·∫≠p nh·∫≠t tr·∫°ng th√°i ID: {}", id);
        EinvInvoiceStatusEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y tr·∫°ng th√°i"));
        entity.setName(dto.getName());
        entity.setDescription(dto.getDescription());
        entity.setNote(dto.getNote());
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Integer id) {
        log.warn("[Catalog] X√≥a tr·∫°ng th√°i ID: {}", id);
        if (metadataRepository.existsByStatusId(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "D·ªØ li·ªáu ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng trong Metadata h√≥a ƒë∆°n");
        }
        repository.deleteById(id);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvInvoiceSyncQueueService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.EinvInvoiceMetadataEntity;
import com.einvoicehub.core.domain.entity.EinvInvoiceSyncQueueEntity;
import com.einvoicehub.core.domain.entity.enums.SyncStatus;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceSyncQueueRepository;
import com.einvoicehub.core.dto.response.EinvInvoiceSyncQueueResponse;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvInvoiceSyncQueueService {

    private final EinvInvoiceSyncQueueRepository repository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvInvoiceSyncQueueResponse> getAll() {
        log.info("[Queue] L·∫•y danh s√°ch h√†ng ƒë·ª£i ƒë·ªìng b·ªô");
        return repository.findAll().stream()
                .map(mapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvInvoiceSyncQueueResponse getById(Long id) {
        log.info("[Queue] Truy v·∫•n y√™u c·∫ßu ƒë·ªìng b·ªô ID: {}", id);
        return repository.findById(id).map(mapper::toResponse)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Y√™u c·∫ßu ƒë·ªìng b·ªô kh√¥ng t·ªìn t·∫°i"));
    }

    @Transactional
    public EinvInvoiceSyncQueueResponse create(EinvInvoiceSyncQueueResponse dto) {
        log.info("[Queue] Th√™m m·ªõi y√™u c·∫ßu ƒë·ªìng b·ªô cho h√≥a ƒë∆°n ID: {}", dto.getInvoiceId());

        EinvInvoiceMetadataEntity invoice = metadataRepository.findById(dto.getInvoiceId())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n g·ªëc kh√¥ng t·ªìn t·∫°i"));

        //Ki·ªÉm tra doanh nghi·ªáp ph·∫£i c√≤n ho·∫°t ƒë·ªông m·ªõi ƒë∆∞·ª£c ƒë·ªìng b·ªô
        if (Boolean.TRUE.equals(invoice.getMerchant().getIsDeleted())) {
            throw new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND, "Doanh nghi·ªáp ƒë√£ ng·ª´ng ho·∫°t ƒë·ªông");
        }

        EinvInvoiceSyncQueueEntity entity = mapper.toEntity(dto);
        entity.setInvoice(invoice);
        entity.setAttemptCount(0); // Kh·ªüi t·∫°o s·ªë l·∫ßn th·ª≠ l·∫°i l√† 0

        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public EinvInvoiceSyncQueueResponse update(Long id, EinvInvoiceSyncQueueResponse dto) {
        log.info("[Queue] C·∫≠p nh·∫≠t tr·∫°ng th√°i x·ª≠ l√Ω y√™u c·∫ßu ID: {}", id);
        EinvInvoiceSyncQueueEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i"));

        entity.setStatus(SyncStatus.valueOf(dto.getStatus()));
        entity.setErrorMessage(dto.getErrorMessage());
        entity.setAttemptCount(dto.getAttemptCount());
        entity.setProcessedBy(dto.getProcessedBy());

        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Queue] Y√™u c·∫ßu x√≥a kh·ªèi h√†ng ƒë·ª£i ID: {}", id);
        EinvInvoiceSyncQueueEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i"));

        // R√†ng bu·ªôc:kh√¥ng x√≥a y√™u c·∫ßu ƒëang ƒë∆∞·ª£c worker x·ª≠ l√Ω
        if (SyncStatus.PROCESSING.equals(entity.getStatus())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Y√™u c·∫ßu ƒëang trong ti·∫øn tr√¨nh x·ª≠ l√Ω, kh√¥ng th·ªÉ x√≥a");
        }

        repository.delete(entity);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvInvoiceTaxBreakdownService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.EinvInvoiceMetadataEntity;
import com.einvoicehub.core.domain.entity.EinvInvoiceTaxBreakDownEntity;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceTaxBreakdownRepository;
import com.einvoicehub.core.dto.EinvInvoiceTaxBreakdownDto;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvInvoiceTaxBreakdownService {

    private final EinvInvoiceTaxBreakdownRepository repository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvInvoiceTaxBreakdownDto> getAllByInvoiceId(Long invoiceId) {
        log.info("[TaxBreakdown] Truy v·∫•n danh s√°ch ph√¢n r√£ thu·∫ø cho h√≥a ƒë∆°n ID: {}", invoiceId);
        return repository.findByInvoiceId(invoiceId).stream()
                .map(mapper::toDto)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvInvoiceTaxBreakdownDto getById(Long id) {
        log.info("[TaxBreakdown] L·∫•y chi ti·∫øt ph√¢n r√£ thu·∫ø ID: {}", id);
        return repository.findById(id).map(mapper::toDto)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "D·ªØ li·ªáu thu·∫ø kh√¥ng t·ªìn t·∫°i"));
    }

    @Transactional
    public EinvInvoiceTaxBreakdownDto create(Long invoiceId, EinvInvoiceTaxBreakdownDto dto) {
        log.info("[TaxBreakdown] T·∫°o m·ªõi ph√¢n r√£ thu·∫ø cho h√≥a ƒë∆°n ID: {}", invoiceId);
        EinvInvoiceMetadataEntity invoice = metadataRepository.findById(invoiceId)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n g·ªëc kh√¥ng t·ªìn t·∫°i"));

        if (Boolean.TRUE.equals(invoice.getMerchant().getIsDeleted())) {
            throw new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND, "Doanh nghi·ªáp ƒë√£ ng·ª´ng ho·∫°t ƒë·ªông");
        }
        if (invoice.getInvoiceStatus().getId() != 1) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng th·ªÉ s·ª≠a ƒë·ªïi th√¥ng tin thu·∫ø c·ªßa h√≥a ƒë∆°n ƒë√£ ch·ªët");
        }

        EinvInvoiceTaxBreakDownEntity entity = new EinvInvoiceTaxBreakDownEntity();
        entity.setInvoice(invoice);
        entity.setVatRateCode(dto.getVatRateCode());
        entity.setVatRatePercent(dto.getVatRatePercent());

        calculateBreakdownAmounts(entity, dto);

        entity = repository.save(entity);
        return mapper.toDto(entity);
    }

    @Transactional
    public EinvInvoiceTaxBreakdownDto update(Long id, EinvInvoiceTaxBreakdownDto dto) {
        log.info("[TaxBreakdown] C·∫≠p nh·∫≠t ph√¢n r√£ thu·∫ø ID: {}", id);
        EinvInvoiceTaxBreakDownEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i"));

        if (entity.getInvoice().getInvoiceStatus().getId() != 1) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng ƒë∆∞·ª£c ph√©p c·∫≠p nh·∫≠t thu·∫ø cho h√≥a ƒë∆°n ƒë√£ ph√°t h√†nh");
        }

        entity.setVatRateCode(dto.getVatRateCode());
        entity.setVatRatePercent(dto.getVatRatePercent());
        calculateBreakdownAmounts(entity, dto);

        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[TaxBreakdown] Y√™u c·∫ßu x√≥a ph√¢n r√£ thu·∫ø ID: {}", id);
        EinvInvoiceTaxBreakDownEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë·ªÉ x√≥a"));

        if (entity.getInvoice().getInvoiceStatus().getId() != 1) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng th·ªÉ x√≥a d√≤ng thu·∫ø c·ªßa h√≥a ƒë∆°n ƒë√£ ho√†n t·∫•t");
        }

        repository.delete(entity);
    }

    private void calculateBreakdownAmounts(EinvInvoiceTaxBreakDownEntity entity, EinvInvoiceTaxBreakdownDto dto) {
        BigDecimal taxable = dto.getTaxableAmount() != null ? dto.getTaxableAmount() : BigDecimal.ZERO;
        BigDecimal taxRate = entity.getVatRatePercent().divide(new BigDecimal("100"), 4, RoundingMode.HALF_UP);

        BigDecimal taxAmount = taxable.multiply(taxRate).setScale(2, RoundingMode.HALF_UP);
        entity.setTaxableAmount(taxable);
        entity.setTaxAmount(taxAmount);
        entity.setTotalAmount(taxable.add(taxAmount));
        entity.setSubtotalAmount(taxable);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvInvoiceTemplateService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.*;
import com.einvoicehub.core.domain.repository.*;
import com.einvoicehub.core.dto.EinvInvoiceTemplateRequest;
import com.einvoicehub.core.dto.EinvInvoiceTemplateResponse;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvInvoiceTemplateService {

    private final EinvInvoiceTemplateRepository repository;
    private final EinvMerchantRepository merchantRepository;
    private final EinvInvoiceTypeRepository typeRepository;
    private final EinvInvoiceRegistrationRepository registrationRepository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvInvoiceTemplateResponse> getAllByMerchant(Long merchantId) {
        log.info("[Template] L·∫•y danh s√°ch m·∫´u h√≥a ƒë∆°n cho Merchant ID: {}", merchantId);
        return repository.searchTemplates(merchantId, null).stream()
                .map(mapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvInvoiceTemplateResponse getById(Long id) {
        return repository.findWithDetailsById(id)
                .map(mapper::toResponse)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh m·∫´u h√≥a ƒë∆°n"));
    }

    @Transactional
    public EinvInvoiceTemplateResponse create(EinvInvoiceTemplateRequest request) {
        log.info("[Template] ƒêang c·∫•u h√¨nh m·∫´u m·ªõi cho Merchant ID: {}, K√Ω hi·ªáu: {}",
                request.getMerchantId(), request.getSymbolCode());

        EinvMerchantEntity merchant = merchantRepository.findById(request.getMerchantId())
                .filter(m -> !m.getIsDeleted())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND));

        EinvInvoiceTypeEntity type = typeRepository.findById(request.getInvoiceTypeId())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Lo·∫°i h√≥a ƒë∆°n kh√¥ng t·ªìn t·∫°i"));

        EinvInvoiceRegistrationEntity registration = null;
        if (request.getRegistrationId() != null) {
            registration = registrationRepository.findById(request.getRegistrationId())
                    .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "D·∫£i s·ªë ƒëƒÉng k√Ω kh√¥ng t·ªìn t·∫°i"));

            validateTemplateRangeAgainstRegistration(request.getMinNumber(), request.getMaxNumber(), registration);
        }

        EinvInvoiceTemplateEntity entity = mapper.toEntity(request);
        entity.setMerchant(merchant);
        entity.setInvoiceType(type);
        entity.setRegistration(registration);
        entity.setCurrentNumber(0);

        entity = repository.save(entity);
        log.info("[Template] ƒê√£ t·∫°o th√†nh c√¥ng m·∫´u h√≥a ƒë∆°n ID: {}", entity.getId());
        return mapper.toResponse(entity);
    }

    @Transactional
    public EinvInvoiceTemplateResponse update(Long id, EinvInvoiceTemplateRequest request) {
        log.info("[Template] C·∫≠p nh·∫≠t m·∫´u h√≥a ƒë∆°n ID: {}", id);

        EinvInvoiceTemplateEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "D·ªØ li·ªáu kh√¥ng t·ªìn t·∫°i"));

        if (Boolean.TRUE.equals(entity.getMerchant().getIsDeleted())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Merchant ƒë√£ b·ªã kh√≥a");
        }

        entity.setTemplateCode(request.getTemplateCode());
        entity.setSymbolCode(request.getSymbolCode());
        entity.setIsActive(request.getIsActive());
        entity.setStartDate(request.getStartDate());
        entity.setProviderId(request.getProviderId());
        entity.setProviderSerialId(request.getProviderSerialId());

        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Template] Y√™u c·∫ßu x√≥a m·∫´u h√≥a ƒë∆°n ID: {}", id);

        if (!repository.existsById(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i");
        }

        if (metadataRepository.existsByTemplateId(id)) {
            log.error("[Template] X√≥a th·∫•t b·∫°i: M·∫´u ID {} ƒë√£ ph√°t sinh d·ªØ li·ªáu h√≥a ƒë∆°n", id);
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "M·∫´u h√≥a ƒë∆°n n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ ph√°t h√†nh h√≥a ƒë∆°n, kh√¥ng th·ªÉ x√≥a");
        }

        repository.deleteById(id);
        log.info("[Template] ƒê√£ x√≥a th√†nh c√¥ng m·∫´u h√≥a ƒë∆°n ID: {}", id);
    }

    private void validateTemplateRangeAgainstRegistration(Integer min, Integer max, EinvInvoiceRegistrationEntity reg) {
        if (min == null || max == null || min > max) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Gi·ªõi h·∫°n s·ªë h√≥a ƒë∆°n kh√¥ng h·ª£p l·ªá");
        }
        if (min < reg.getFromNumber() || max > reg.getToNumber()) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA,
                    String.format("D·∫£i s·ªë c·ªßa m·∫´u (%d-%d) ph·∫£i n·∫±m trong d·∫£i s·ªë ƒë√£ ƒëƒÉng k√Ω (%d-%d)",
                            min, max, reg.getFromNumber(), reg.getToNumber()));
        }
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvInvoiceTypeService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.domain.entity.EinvInvoiceTypeEntity;
import com.einvoicehub.core.domain.repository.EinvInvoiceTypeRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceTemplateRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.dto.EinvInvoiceTypeDto;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvInvoiceTypeService {

    private final EinvInvoiceTypeRepository repository;
    private final EinvInvoiceTemplateRepository templateRepository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvInvoiceTypeDto> getAll() {
        log.info("[Catalog] L·∫•y to√†n b·ªô danh m·ª•c lo·∫°i h√≥a ƒë∆°n");
        return repository.findAll().stream().map(mapper::toDto).collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvInvoiceTypeDto getById(Long id) {
        log.info("[Catalog] L·∫•y chi ti·∫øt lo·∫°i h√≥a ƒë∆°n ID: {}", id);
        return repository.findById(id).map(mapper::toDto)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Lo·∫°i h√≥a ƒë∆°n kh√¥ng t·ªìn t·∫°i"));
    }

    @Transactional
    public EinvInvoiceTypeDto create(EinvInvoiceTypeDto dto) {
        log.info("[Catalog] T·∫°o m·ªõi lo·∫°i h√≥a ƒë∆°n: {}", dto.getTypeCode());
        if (repository.findByTypeCode(dto.getTypeCode()).isPresent()) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "M√£ lo·∫°i h√≥a ƒë∆°n " + dto.getTypeCode() + " ƒë√£ t·ªìn t·∫°i");
        }
        EinvInvoiceTypeEntity entity = mapper.toEntity(dto);
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public EinvInvoiceTypeDto update(Long id, EinvInvoiceTypeDto dto) {
        log.info("[Catalog] C·∫≠p nh·∫≠t lo·∫°i h√≥a ƒë∆°n ID: {}", id);
        EinvInvoiceTypeEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "D·ªØ li·ªáu kh√¥ng t·ªìn t·∫°i"));

        entity.setTypeName(dto.getTypeName());
        entity.setDescription(dto.getDescription());
        entity.setIsActive(dto.getIsActive());
        entity.setDisplayOrder(dto.getDisplayOrder());
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Catalog] Y√™u c·∫ßu x√≥a lo·∫°i h√≥a ƒë∆°n ID: {}", id);
        EinvInvoiceTypeEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i"));

        if (templateRepository.existsByInvoiceTypeId(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng th·ªÉ x√≥a v√¨ ƒë√£ c√≥ M·∫´u h√≥a ƒë∆°n tham chi·∫øu");
        }
        if (metadataRepository.existsByInvoiceTypeCode(entity.getTypeCode())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng th·ªÉ x√≥a v√¨ ƒë√£ c√≥ H√≥a ƒë∆°n ph√°t sinh m√£ n√†y");
        }

        repository.delete(entity);
        log.info("[Catalog] ƒê√£ x√≥a lo·∫°i h√≥a ƒë∆°n: {}", entity.getTypeCode());
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvMerchantProviderConfigService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.EinvMerchantEntity;
import com.einvoicehub.core.domain.entity.EinvMerchantProviderConfigEntity;
import com.einvoicehub.core.domain.entity.EinvServiceProviderEntity;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.domain.repository.EinvMerchantProviderConfigRepository;
import com.einvoicehub.core.domain.repository.EinvMerchantRepository;
import com.einvoicehub.core.domain.repository.EinvServiceProviderRepository;
import com.einvoicehub.core.dto.EinvMerchantProviderConfigRequest;
import com.einvoicehub.core.dto.EinvMerchantProviderConfigResponse;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvMerchantProviderConfigService {

    private final EinvMerchantProviderConfigRepository repository;
    private final EinvMerchantRepository merchantRepository;
    private final EinvServiceProviderRepository providerRepository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvMerchantProviderConfigResponse> getAll() {
        log.info("[Config] ƒêang truy v·∫•n danh s√°ch to√†n b·ªô c·∫•u h√¨nh k·∫øt n·ªëi h·ªá th·ªëng");
        return repository.findAll().stream()
                .map(mapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public List<EinvMerchantProviderConfigResponse> getByMerchantId(Long merchantId) {
        log.info("[Config] ƒêang truy v·∫•n danh s√°ch c·∫•u h√¨nh k·∫øt n·ªëi cho Merchant ID: {}", merchantId);
        return repository.searchConfigs(merchantId, null).stream()
                .map(mapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvMerchantProviderConfigResponse getById(Long id) {
        log.info("[Config] Truy v·∫•n chi ti·∫øt c·∫•u h√¨nh ID: {}", id);
        return repository.findById(id)
                .map(mapper::toResponse)
                .orElseThrow(() -> {
                    log.error("[Config] Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh v·ªõi ID: {}", id);
                    return new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh k·∫øt n·ªëi");
                });
    }

    @Transactional
    public EinvMerchantProviderConfigResponse create(EinvMerchantProviderConfigRequest request) {
        log.info("[Config] ƒêang t·∫°o c·∫•u h√¨nh m·ªõi cho Merchant {} v·ªõi Provider {}",
                request.getMerchantId(), request.getProviderId());

        EinvMerchantEntity merchant = merchantRepository.findById(request.getMerchantId())
                .filter(m -> !m.getIsDeleted())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND));

        EinvServiceProviderEntity provider = providerRepository.findById(request.getProviderId())
                .filter(EinvServiceProviderEntity::getIsActive)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Nh√† cung c·∫•p kh√¥ng t·ªìn t·∫°i ho·∫∑c ng·ª´ng h·ªó tr·ª£"));

        if (repository.existsByMerchantIdAndProviderId(request.getMerchantId(), request.getProviderId())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Doanh nghi·ªáp ƒë√£ c·∫•u h√¨nh t√†i kho·∫£n cho nh√† cung c·∫•p n√†y");
        }

        EinvMerchantProviderConfigEntity entity = mapper.toEntity(request);
        entity.setMerchant(merchant);
        entity.setProvider(provider);

        entity.setPasswordServiceEncrypted("ENC_" + request.getPasswordService());

        handleDefaultConfigLogic(merchant.getId(), request.getIsDefault(), entity);

        entity = repository.save(entity);
        log.info("[Config] ƒê√£ t·∫°o th√†nh c√¥ng c·∫•u h√¨nh k·∫øt n·ªëi ID: {}", entity.getId());
        return mapper.toResponse(entity);
    }

    @Transactional
    public EinvMerchantProviderConfigResponse update(Long id, EinvMerchantProviderConfigRequest request) {
        log.info("[Config] ƒêang c·∫≠p nh·∫≠t c·∫•u h√¨nh ID: {}", id);

        EinvMerchantProviderConfigEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "D·ªØ li·ªáu kh√¥ng t·ªìn t·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t"));

        if (Boolean.TRUE.equals(entity.getMerchant().getIsDeleted())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Doanh nghi·ªáp ƒë√£ ng·ª´ng ho·∫°t ƒë·ªông, kh√¥ng ƒë∆∞·ª£c s·ª≠a c·∫•u h√¨nh");
        }

        entity.setPartnerId(request.getPartnerId());
        entity.setPartnerToken(request.getPartnerToken());
        entity.setTaxCode(request.getTaxCode());
        entity.setIntegrationUrl(request.getIntegrationUrl());
        entity.setUsernameService(request.getUsernameService());
        entity.setIsTestMode(request.getIsTestMode());
        entity.setIsActive(request.getIsActive());
        entity.setExtraConfig(request.getExtraConfig());

        if (request.getPasswordService() != null && !request.getPasswordService().isBlank()) {
            entity.setPasswordServiceEncrypted("ENC_UPDATED_" + request.getPasswordService());
        }

        handleDefaultConfigLogic(entity.getMerchant().getId(), request.getIsDefault(), entity);

        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Config] ƒêang th·ª±c hi·ªán y√™u c·∫ßu x√≥a c·∫•u h√¨nh ID: {}", id);

        if (!repository.existsById(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i");
        }

       if (metadataRepository.existsByProviderConfigId(id)) {
            log.error("[Config] X√≥a th·∫•t b·∫°i: C·∫•u h√¨nh ID {} ƒë√£ ph√°t sinh d·ªØ li·ªáu h√≥a ƒë∆°n", id);
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng th·ªÉ x√≥a c·∫•u h√¨nh ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ ph√°t h√†nh h√≥a ƒë∆°n");
        }

        repository.deleteById(id);
        log.info("[Config] ƒê√£ x√≥a th√†nh c√¥ng c·∫•u h√¨nh ID: {}", id);
    }

    /**
     * Logic n·ªôi b·ªô ƒë·∫£m b·∫£o t·∫°i m·ªói th·ªùi ƒëi·ªÉm ch·ªâ c√≥ 1 c·∫•u h√¨nh m·∫∑c ƒë·ªãnh duy nh·∫•t cho m·ªói Merchant.
     */
    private void handleDefaultConfigLogic(Long merchantId, Boolean isNewDefault, EinvMerchantProviderConfigEntity currentEntity) {
        if (Boolean.TRUE.equals(isNewDefault)) {
            // T√¨m c·∫•u h√¨nh m·∫∑c ƒë·ªãnh c≈© v√† g·ª° b·ªè
            repository.findByMerchantIdAndIsDefaultTrueAndIsActiveTrue(merchantId).ifPresent(oldDefault -> {
                if (!oldDefault.getId().equals(currentEntity.getId())) {
                    oldDefault.setIsDefault(false);
                    repository.save(oldDefault);
                    log.debug("[Config] ƒê√£ t·∫Øt tr·∫°ng th√°i m·∫∑c ƒë·ªãnh c·ªßa c·∫•u h√¨nh c≈© ID: {}", oldDefault.getId());
                }
            });
            currentEntity.setIsDefault(true);
        } else {
            currentEntity.setIsDefault(false);
        }
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvMerchantService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.domain.entity.EinvMerchantEntity;
import com.einvoicehub.core.domain.repository.EinvMerchantRepository;
import com.einvoicehub.core.domain.repository.EinvMerchantUserRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.dto.EinvMerchantRequest;
import com.einvoicehub.core.dto.EinvMerchantResponse;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvMerchantService {

    private final EinvMerchantRepository repository;
    private final EinvMerchantUserRepository userRepository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvMerchantResponse> getAll() {
        log.info("[Merchant] L·∫•y danh s√°ch doanh nghi·ªáp ƒëang ho·∫°t ƒë·ªông");
        return repository.findAll().stream()
                .filter(m -> !m.getIsDeleted())
                .map(mapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvMerchantResponse getById(Long id) {
        log.info("[Merchant] Truy v·∫•n th√¥ng tin doanh nghi·ªáp ID: {}", id);
        return repository.findById(id)
                .filter(m -> !m.getIsDeleted())
                .map(mapper::toResponse)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND));
    }

    @Transactional
    public EinvMerchantResponse create(EinvMerchantRequest request) {
        log.info("[Merchant] ƒêƒÉng k√Ω doanh nghi·ªáp m·ªõi v·ªõi MST: {}", request.getTaxCode());

        // 1. Ki·ªÉm tra MST ƒë√£ t·ªìn t·∫°i v√† ch∆∞a b·ªã x√≥a
        if (repository.existsByTaxCodeAndIsDeletedFalse(request.getTaxCode())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "M√£ s·ªë thu·∫ø n√†y ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω tr√™n h·ªá th·ªëng");
        }

        EinvMerchantEntity entity = mapper.toEntity(request);
        // Thi·∫øt l·∫≠p c√°c gi√° tr·ªã m·∫∑c ƒë·ªãnh theo SOFTZ
        entity.setIsDeleted(false);
        entity = repository.save(entity);

        return mapper.toResponse(entity);
    }

    @Transactional
    public EinvMerchantResponse update(Long id, EinvMerchantRequest request) {
        log.info("[Merchant] C·∫≠p nh·∫≠t th√¥ng tin doanh nghi·ªáp ID: {}", id);
        EinvMerchantEntity entity = repository.findById(id)
                .filter(m -> !m.getIsDeleted())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND));

        // 2. C·∫≠p nh·∫≠t c√°c tr∆∞·ªùng th√¥ng tin c∆° b·∫£n
        entity.setCompanyName(request.getCompanyName());
        entity.setShortName(request.getShortName());
        entity.setAddress(request.getAddress());
        entity.setEmail(request.getEmail());
        entity.setPhone(request.getPhone());
        entity.setRepresentativeName(request.getRepresentativeName());
        entity.setTaxAuthorityCode(request.getTaxAuthorityCode());

        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Merchant] Y√™u c·∫ßu x√≥a doanh nghi·ªáp ID: {}", id);
        EinvMerchantEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND));
        // 3. Ki·ªÉm tra r√†ng bu·ªôc giao d·ªãch tr∆∞·ªõc khi x√≥a
        if (metadataRepository.existsByMerchantId(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng th·ªÉ x√≥a doanh nghi·ªáp ƒë√£ ph√°t sinh h√≥a ƒë∆°n");
        }
        // 4. Soft Delete
        entity.setIsDeleted(true);
        entity.setDeletedAt(LocalDateTime.now());
        repository.save(entity);
        log.info("[Merchant] ƒê√£ th·ª±c hi·ªán x√≥a m·ªÅm doanh nghi·ªáp ID: {}", id);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvMerchantUserService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.domain.entity.EinvMerchantEntity;
import com.einvoicehub.core.domain.entity.EinvMerchantUserEntity;
import com.einvoicehub.core.domain.repository.EinvMerchantRepository;
import com.einvoicehub.core.domain.repository.EinvMerchantUserRepository;
import com.einvoicehub.core.dto.EinvMerchantUserRequest;
import com.einvoicehub.core.dto.EinvMerchantUserResponse;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvMerchantUserService {

    private final EinvMerchantUserRepository repository;
    private final EinvMerchantRepository merchantRepository;
    private final EinvHubMapper mapper;

    // L∆∞u √Ω: Trong th·ª±c t·∫ø h√£y Inject PasswordEncoder t·ª´ Spring Security
    // private final PasswordEncoder passwordEncoder;

    @Transactional(readOnly = true)
    public List<EinvMerchantUserResponse> getAllByMerchant(Long merchantId) {
        log.info("[User] L·∫•y danh s√°ch nh√¢n s·ª± cho Merchant ID: {}", merchantId);
        return repository.findAll().stream()
                .filter(u -> u.getMerchant().getId().equals(merchantId))
                .map(mapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvMerchantUserResponse getById(Long id) {
        return repository.findById(id)
                .map(mapper::toResponse)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Ng∆∞·ªùi d√πng kh√¥ng t·ªìn t·∫°i"));
    }

    @Transactional
    public EinvMerchantUserResponse create(EinvMerchantUserRequest request) {
        log.info("[User] T·∫°o t√†i kho·∫£n m·ªõi: {} cho Merchant ID: {}", request.getUsername(), request.getMerchantId());

        // 1. Ki·ªÉm tra tr·∫°ng th√°i Merchant (Logic SOFTZ)
        EinvMerchantEntity merchant = merchantRepository.findById(request.getMerchantId())
                .filter(m -> !m.getIsDeleted())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND));

        // 2. Ki·ªÉm tra tr√πng l·∫∑p t√†i kho·∫£n
        if (repository.findByUsername(request.getUsername()).isPresent()) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i");
        }

        EinvMerchantUserEntity entity = mapper.toEntity(request);
        entity.setMerchant(merchant);

        // 3. Logic SOFTZ: M√£ h√≥a m·∫≠t kh·∫©u (Gi·∫£ ƒë·ªãnh hash m·∫≠t kh·∫©u ·ªü ƒë√¢y)
        // entity.setPasswordHash(passwordEncoder.encode(request.getPassword()));
        entity.setPasswordHash("HASHED_" + request.getPassword());

        entity.setIsActive(true);
        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public EinvMerchantUserResponse update(Long id, EinvMerchantUserRequest request) {
        log.info("[User] C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng ID: {}", id);
        EinvMerchantUserEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i"));

        entity.setFullName(request.getFullName());
        entity.setPhone(request.getPhone());
        entity.setRole(com.einvoicehub.core.domain.entity.enums.UserRole.valueOf(request.getRole()));

        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[User] X√≥a t√†i kho·∫£n ID: {}", id);
        EinvMerchantUserEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i"));

        if (entity.getIsPrimary()) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng th·ªÉ x√≥a t√†i kho·∫£n ch·ªß c·ªßa doanh nghi·ªáp");
        }

        repository.delete(entity);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvPaymentMethodService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.domain.entity.EinvPaymentMethodEntity;
import com.einvoicehub.core.domain.repository.EinvPaymentMethodRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.dto.EinvPaymentMethodDto;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvPaymentMethodService {

    private final EinvPaymentMethodRepository repository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvPaymentMethodDto> getAll() {
        log.info("[Catalog] L·∫•y danh m·ª•c ph∆∞∆°ng th·ª©c thanh to√°n");
        return repository.findAll().stream().map(mapper::toDto).collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvPaymentMethodDto getById(Long id) {
        return repository.findById(id).map(mapper::toDto)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "D·ªØ li·ªáu kh√¥ng t·ªìn t·∫°i"));
    }

    @Transactional
    public EinvPaymentMethodDto create(EinvPaymentMethodDto dto) {
        log.info("[Catalog] T·∫°o m·ªõi PTTT: {}", dto.getMethodCode());
        if (repository.findByMethodCode(dto.getMethodCode()).isPresent()) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "M√£ thanh to√°n ƒë√£ t·ªìn t·∫°i");
        }
        EinvPaymentMethodEntity entity = mapper.toEntity(dto);
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public EinvPaymentMethodDto update(Long id, EinvPaymentMethodDto dto) {
        log.info("[Catalog] C·∫≠p nh·∫≠t PTTT ID: {}", id);
        EinvPaymentMethodEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu"));
        entity.setMethodName(dto.getMethodName());
        entity.setIsActive(dto.getIsActive());
        entity.setDisplayOrder(dto.getDisplayOrder());
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        EinvPaymentMethodEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i"));

        // Theo SQL: Tham chi·∫øu qua method_code
        if (metadataRepository.existsByPaymentMethod(entity.getMethodCode())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "PTTT n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng trong h√≥a ƒë∆°n");
        }
        repository.delete(entity);
        log.info("[Catalog] ƒê√£ x√≥a PTTT: {}", entity.getMethodCode());
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvRegistrationStatusService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.domain.entity.EinvRegistrationStatusEntity;
import com.einvoicehub.core.domain.repository.EinvRegistrationStatusRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceRegistrationRepository;
import com.einvoicehub.core.dto.EinvRegistrationStatusDto;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvRegistrationStatusService {

    private final EinvRegistrationStatusRepository repository;
    private final EinvInvoiceRegistrationRepository registrationRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvRegistrationStatusDto> getAll() {
        log.info("[Catalog] L·∫•y danh m·ª•c tr·∫°ng th√°i ƒëƒÉng k√Ω");
        return repository.findAll().stream().map(mapper::toDto).collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvRegistrationStatusDto getById(Integer id) {
        return repository.findById(id).map(mapper::toDto)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Tr·∫°ng th√°i kh√¥ng t·ªìn t·∫°i"));
    }

    @Transactional
    public EinvRegistrationStatusDto create(EinvRegistrationStatusDto dto) {
        log.info("[Catalog] T·∫°o tr·∫°ng th√°i ƒëƒÉng k√Ω: {}", dto.getName());
        if (repository.findByName(dto.getName()).isPresent()) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "T√™n tr·∫°ng th√°i ƒë√£ t·ªìn t·∫°i");
        }
        EinvRegistrationStatusEntity entity = mapper.toEntity(dto);
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public EinvRegistrationStatusDto update(Integer id, EinvRegistrationStatusDto dto) {
        EinvRegistrationStatusEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu"));
        entity.setName(dto.getName());
        entity.setDescription(dto.getDescription());
        entity.setNote(dto.getNote());
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Integer id) {
        log.warn("[Catalog] X√≥a tr·∫°ng th√°i ƒëƒÉng k√Ω ID: {}", id);
        if (registrationRepository.existsByStatusId(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Tr·∫°ng th√°i n√†y ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng cho d·∫£i s·ªë h√≥a ƒë∆°n");
        }
        repository.deleteById(id);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvServiceProviderService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.EinvServiceProviderEntity;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.domain.repository.EinvMerchantProviderConfigRepository;
import com.einvoicehub.core.domain.repository.EinvServiceProviderRepository;
import com.einvoicehub.core.dto.EinvServiceProviderDto;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvServiceProviderService {

    private final EinvServiceProviderRepository repository;
    private final EinvMerchantProviderConfigRepository providerConfigRepository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;


    @Transactional(readOnly = true)
    public List<EinvServiceProviderDto> getAll() {
        log.info("[Config] ƒêang truy v·∫•n danh s√°ch to√†n b·ªô nh√† cung c·∫•p d·ªãch v·ª•");
        return repository.findAll().stream()
                .map(mapper::toDto)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvServiceProviderDto getById(Long id) {
        log.info("[Config] ƒêang t√¨m ki·∫øm nh√† cung c·∫•p ID: {}", id);
        return repository.findById(id)
                .map(mapper::toDto)
                .orElseThrow(() -> {
                    log.error("[Config] Kh√¥ng t√¨m th·∫•y nh√† cung c·∫•p v·ªõi ID: {}", id);
                    return new InvalidDataException(ErrorCode.INVALID_DATA, "Nh√† cung c·∫•p kh√¥ng t·ªìn t·∫°i tr√™n h·ªá th·ªëng");
                });
    }

    @Transactional
    public EinvServiceProviderDto create(EinvServiceProviderDto dto) {
        log.info("[Config] ƒêang t·∫°o m·ªõi nh√† cung c·∫•p v·ªõi m√£: {}", dto.getProviderCode());

        if (repository.findByProviderCodeAndIsActiveTrue(dto.getProviderCode()).isPresent()) {
            log.warn("[Config] M√£ nh√† cung c·∫•p {} ƒë√£ t·ªìn t·∫°i", dto.getProviderCode());
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "M√£ nh√† cung c·∫•p ƒë√£ t·ªìn t·∫°i trong danh m·ª•c");
        }

        if (Boolean.TRUE.equals(dto.getIsDefault())) {
            repository.findByIsDefaultTrue().ifPresent(oldDefault -> {
                oldDefault.setIsDefault(false);
                repository.save(oldDefault);
            });
        }

        EinvServiceProviderEntity entity = mapper.toEntity(dto);
        entity = repository.save(entity);

        log.info("[Config] ƒê√£ t·∫°o th√†nh c√¥ng nh√† cung c·∫•p: {} (ID: {})", entity.getProviderName(), entity.getId());
        return mapper.toDto(entity);
    }

    @Transactional
    public EinvServiceProviderDto update(Long id, EinvServiceProviderDto dto) {
        log.info("[Config] ƒêang c·∫≠p nh·∫≠t th√¥ng tin nh√† cung c·∫•p ID: {}", id);

        EinvServiceProviderEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "D·ªØ li·ªáu kh√¥ng t·ªìn t·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t"));

        entity.setProviderName(dto.getProviderName());
        entity.setOfficialApiUrl(dto.getOfficialApiUrl());
        entity.setLookupUrl(dto.getLookupUrl());
        entity.setSupportEmail(dto.getSupportEmail());
        entity.setSupportPhone(dto.getSupportPhone());
        entity.setIsActive(dto.getIsActive());
        entity.setDisplayOrder(dto.getDisplayOrder());

        // X·ª≠ l√Ω logic ƒë·ªïi Provider m·∫∑c ƒë·ªãnh
        if (Boolean.TRUE.equals(dto.getIsDefault()) && !entity.getIsDefault()) {
            repository.findByIsDefaultTrue().ifPresent(oldDefault -> {
                oldDefault.setIsDefault(false);
                repository.save(oldDefault);
            });
            entity.setIsDefault(true);
        }

        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Config] ƒêang th·ª±c hi·ªán y√™u c·∫ßu x√≥a nh√† cung c·∫•p ID: {}", id);
        if (!repository.existsById(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i");
        }
        if (providerConfigRepository.existsByProviderId(id)) {
            log.error("[Config] X√≥a th·∫•t b·∫°i: Nh√† cung c·∫•p ID {} ƒëang ƒë∆∞·ª£c d√πng trong c·∫•u h√¨nh Merchant", id);
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng th·ªÉ x√≥a nh√† cung c·∫•p ƒëang c√≥ doanh nghi·ªáp li√™n k·∫øt");
        }
        if (metadataRepository.existsByProviderId(id)) {
            log.error("[Config] X√≥a th·∫•t b·∫°i: Nh√† cung c·∫•p ID {} ƒë√£ ph√°t sinh d·ªØ li·ªáu h√≥a ƒë∆°n", id);
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "H·ªá th·ªëng ƒë√£ ph√°t sinh h√≥a ƒë∆°n th√¥ng qua nh√† cung c·∫•p n√†y, kh√¥ng ƒë∆∞·ª£c x√≥a");
        }
        repository.deleteById(id);
        log.info("[Config] ƒê√£ x√≥a th√†nh c√¥ng nh√† cung c·∫•p ID: {}", id);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvSystemConfigService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.EinvSystemConfigEntity;
import com.einvoicehub.core.domain.repository.EinvSystemConfigRepository;
import com.einvoicehub.core.dto.EinvSystemConfigDto;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvSystemConfigService {

    private final EinvSystemConfigRepository repository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvSystemConfigDto> getAll() {
        log.info("[Config] L·∫•y danh s√°ch tham s·ªë h·ªá th·ªëng");
        return repository.findAll().stream().map(mapper::toDto).collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvSystemConfigDto getById(Long id) {
        return repository.findById(id).map(mapper::toDto)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "C·∫•u h√¨nh kh√¥ng t·ªìn t·∫°i"));
    }

    @Transactional
    public EinvSystemConfigDto create(EinvSystemConfigDto dto) {
        log.info("[Config] Th√™m m·ªõi tham s·ªë: {}", dto.getConfigKey());

        if (repository.findByConfigKey(dto.getConfigKey()).isPresent()) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√≥a c·∫•u h√¨nh ƒë√£ t·ªìn t·∫°i");
        }

        EinvSystemConfigEntity entity = mapper.toEntity(dto);
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public EinvSystemConfigDto update(Long id, EinvSystemConfigDto dto) {
        log.info("[Config] Thay ƒë·ªïi tham s·ªë h·ªá th·ªëng: {}", dto.getConfigKey());
        EinvSystemConfigEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y tham s·ªë"));

        // R√†ng bu·ªôc:N·∫øu c·∫•u h√¨nh ƒë∆∞·ª£c ƒë√°nh d·∫•u l√† kh√¥ng ƒë∆∞·ª£c s·ª≠a (is_editable = 0)
        if (Boolean.FALSE.equals(entity.getIsEditable())) {
            log.error("[Config] Ch·∫∑n thao t√°c s·ª≠a c·∫•u h√¨nh h·ªá th·ªëng c·ªë ƒë·ªãnh: {}", entity.getConfigKey());
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Tham s·ªë n√†y thu·ªôc h·ªá th·ªëng l√µi, kh√¥ng ƒë∆∞·ª£c ph√©p ch·ªânh s·ª≠a");
        }

        entity.setConfigValue(dto.getConfigValue());
        entity.setDescription(dto.getDescription());

        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Config] Y√™u c·∫ßu x√≥a c·∫•u h√¨nh ID: {}", id);
        EinvSystemConfigEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i"));
        if (Boolean.FALSE.equals(entity.getIsEditable())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng th·ªÉ x√≥a c·∫•u h√¨nh b·∫Øt bu·ªôc c·ªßa h·ªá th·ªëng");
        }

        repository.delete(entity);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvTaxAuthorityResponseService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.EinvInvoiceMetadataEntity;
import com.einvoicehub.core.domain.entity.EinvTaxAuthorityResponseEntity;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.domain.repository.EinvTaxAuthorityResponseRepository;
import com.einvoicehub.core.dto.EinvTaxAuthorityResponseDto;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvTaxAuthorityResponseService {

    private final EinvTaxAuthorityResponseRepository repository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvTaxAuthorityResponseDto> getAll() {
        log.info("[CQT] L·∫•y danh s√°ch to√†n b·ªô ph·∫£n h·ªìi t·ª´ Thu·∫ø");
        return repository.findAll().stream().map(mapper::toDto).collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvTaxAuthorityResponseDto getById(Long id) {
        return repository.findById(id).map(mapper::toDto)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y ph·∫£n h·ªìi ph√°p l√Ω"));
    }

    @Transactional
    public EinvTaxAuthorityResponseDto create(EinvTaxAuthorityResponseDto dto) {
        log.info("[CQT] Ti·∫øp nh·∫≠n m√£ CQT cho h√≥a ƒë∆°n ID: {}", dto.getInvoiceId());

        EinvInvoiceMetadataEntity invoice = metadataRepository.findById(dto.getInvoiceId())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n ƒë√≠ch kh√¥ng t·ªìn t·∫°i"));

        EinvTaxAuthorityResponseEntity entity = mapper.toEntity(dto);
        entity.setInvoice(invoice);

        entity = repository.save(entity);

        // C·∫≠p nh·∫≠t ng∆∞·ª£c l·∫°i m√£ CQT (tax_authority_code) v√†o metadata h√≥a ƒë∆°n
        if (entity.getCqtCode() != null) {
            invoice.setTaxAuthorityCode(entity.getCqtCode());
            metadataRepository.save(invoice);
            log.info("[CQT] ƒê√£ ƒë·ªìng b·ªô m√£ CQT {} v√†o Metadata h√≥a ƒë∆°n", entity.getCqtCode());
        }

        return mapper.toDto(entity);
    }

    @Transactional
    public EinvTaxAuthorityResponseDto update(Long id, EinvTaxAuthorityResponseDto dto) {
        log.info("[CQT] C·∫≠p nh·∫≠t di·ªÖn gi·∫£i ph·∫£n h·ªìi ID: {}", id);
        EinvTaxAuthorityResponseEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "D·ªØ li·ªáu kh√¥ng t·ªìn t·∫°i"));

        entity.setErrorMessage(dto.getErrorMessage());
        entity.setStatusFromCqt(dto.getStatusFromCqt());

        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.error("[CQT] C·∫¢NH B√ÅO: Thao t√°c x√≥a ph·∫£n h·ªìi Thu·∫ø nh·∫°y c·∫£m ID: {}", id);
        if (!repository.existsById(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i");
        }
        //logs n√†y ch·ªâ Admin m·ªõi ƒë∆∞·ª£c x√≥a
        repository.deleteById(id);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvVatRateService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.domain.entity.EinvVatRateEntity;
import com.einvoicehub.core.domain.repository.EinvVatRateRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceItemRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceTaxBreakdownRepository;
import com.einvoicehub.core.dto.EinvVatRateDto;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvVatRateService {

    private final EinvVatRateRepository repository;
    private final EinvInvoiceItemRepository itemRepository;
    private final EinvInvoiceTaxBreakdownRepository taxRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvVatRateDto> getAll() {
        log.info("[Catalog] L·∫•y danh m·ª•c thu·∫ø su·∫•t GTGT");
        return repository.findAll().stream().map(mapper::toDto).collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvVatRateDto getById(Long id) {
        return repository.findById(id).map(mapper::toDto)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Thu·∫ø su·∫•t kh√¥ng t·ªìn t·∫°i"));
    }

    @Transactional
    public EinvVatRateDto create(EinvVatRateDto dto) {
        log.info("[Catalog] T·∫°o m·ªõi thu·∫ø su·∫•t: {}", dto.getRateCode());
        if (repository.findByRateCode(dto.getRateCode()).isPresent()) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "M√£ thu·∫ø su·∫•t ƒë√£ t·ªìn t·∫°i");
        }
        if (dto.getRatePercent() != null && dto.getRatePercent().compareTo(BigDecimal.ZERO) < 0) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "T·ª∑ l·ªá thu·∫ø su·∫•t kh√¥ng ƒë∆∞·ª£c √¢m");
        }
        EinvVatRateEntity entity = mapper.toEntity(dto);
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public EinvVatRateDto update(Long id, EinvVatRateDto dto) {
        EinvVatRateEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu"));
        entity.setRateName(dto.getRateName());
        entity.setRatePercent(dto.getRatePercent());
        entity.setIsActive(dto.getIsActive());
        entity.setDisplayOrder(dto.getDisplayOrder());
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Catalog] X√≥a thu·∫ø su·∫•t ID: {}", id);
        if (itemRepository.existsByVatRateId(id) || taxRepository.existsByVatRateId(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Thu·∫ø su·∫•t ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng trong chi ti·∫øt h√≥a ƒë∆°n");
        }
        repository.deleteById(id);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/util/IdGenerator.java">
package com.einvoicehub.core.util;

import org.springframework.stereotype.Component;
import java.security.SecureRandom;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

/**
 * ID Generator Utility - C·∫≠p nh·∫≠t theo chu·∫©n EInvoiceHub
 * * Th√†nh ph·∫ßn h·ªó tr·ª£ t·∫°o c√°c ƒë·ªãnh danh c√≥ c·∫•u tr√∫c, gi√∫p ƒë·ªëi so√°t d·ªØ li·ªáu
 * gi·ªØa MySQL v√† MongoDB d·ªÖ d√†ng h∆°n so v·ªõi UUID th√¥ng th∆∞·ªùng.
 */
@Component
public class IdGenerator {

    private static final String CHARS = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    private final SecureRandom random = new SecureRandom();
    private final DateTimeFormatter timestampFormatter = DateTimeFormatter.ofPattern("yyyyMMdd-HHmmss");
    private final DateTimeFormatter dateFormatter = DateTimeFormatter.ofPattern("yyyyMMdd");

    /**
     * T·∫°o ID ƒë·ªãnh danh duy nh·∫•t cho m·ªói y√™u c·∫ßu khi ti·∫øp nh·∫≠n v√†o Hub.
     * Kh·∫Øc ph·ª•c: ƒê·ªïi t√™n t·ª´ generateClientRequestId ƒë·ªÉ ph√¢n bi·ªát v·ªõi ID c·ªßa Merchant truy·ªÅn l√™n.
     * Format: HUB-YYYYMMDD-HHMMSS-XXXXXX
     */
    public String generateHubRequestId() {
        String timestamp = LocalDateTime.now().format(timestampFormatter);
        return String.format("HUB-%s-%s", timestamp, generateRandom(6));
    }

    /**
     * T·∫°o m√£ giao d·ªãch n·ªôi b·ªô ƒë·ªÉ li√™n k·∫øt Metadata (MySQL) v√† Payload (MongoDB).
     * Format: TXN-YYYYMMDD-HHMMSS-XXXXXXXX
     */
    public String generateTransactionId() {
        String timestamp = LocalDateTime.now().format(timestampFormatter);
        return String.format("TXN-%s-%s", timestamp, generateRandom(8));
    }

    /**
     * T·∫°o s·ªë h√≥a ƒë∆°n n·ªôi b·ªô (Ch·ªâ d√πng cho b·∫£n nh√°p DRAFT ho·∫∑c tra c·ª©u n·ªôi b·ªô).
     * C·∫£nh b√°o: S·ªë h√≥a ƒë∆°n ph√°p l√Ω s·∫Ω do Provider (MISA, VNPT...) c·∫•p sau khi ph√°t h√†nh.
     * Format: DRAFT-YYYYMMDD-XXXXXX
     */
    public String generateInternalDraftNumber() {
        String date = LocalDateTime.now().format(dateFormatter);
        return String.format("DRAFT-%s-%s", date, generateRandom(6));
    }

    /**
     * Sinh chu·ªói ng·∫´u nhi√™n an to√†n (Alphanumeric)
     * S·ª≠ d·ª•ng SecureRandom ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh b·∫£o m·∫≠t v√† tr√°nh tr√πng l·∫∑p.
     */
    private String generateRandom(int length) {
        StringBuilder sb = new StringBuilder(length);
        for (int i = 0; i < length; i++) {
            sb.append(CHARS.charAt(random.nextInt(CHARS.length())));
        }
        return sb.toString();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/EinvoiceCoreApplication.java">
package com.einvoicehub.core;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class EinvoiceCoreApplication {

	public static void main(String[] args) {
		SpringApplication.run(EinvoiceCoreApplication.class, args);
	}

}
</file>

<file path="src/main/resources/db/migration/Initial_Schema_Ver01.sql">
-- EInvoiceHub Database Schema [MySQL - MongoDB]

--Table
-- merchants , merchant_users,
-- api_credentials, service_providers,merchant_provider_configs
-- invoices_metadata,
-- audit_logs, system_config

-- 1. ENUM Types Definition
-- Subscription Plan: Trial, Basic, Premium
DROP TYPE IF EXISTS subscription_plan;
CREATE TYPE subscription_plan AS ENUM ('TRIAL', 'BASIC', 'PREMIUM');

-- Entity Status: Active, Inactive, Suspended
DROP TYPE IF EXISTS entity_status;
CREATE TYPE entity_status AS ENUM ('ACTIVE', 'INACTIVE', 'SUSPENDED');

-- Invoice Status: Workflow states
DROP TYPE IF EXISTS invoice_status;
CREATE TYPE invoice_status AS ENUM ('DRAFT', 'PENDING', 'SIGNING', 'SENT_TO_PROVIDER', 'SUCCESS', 'FAILED', 'CANCELLED', 'REPLACED');

-- User Role: Ph√¢n quy·ªÅn trong Merchant
DROP TYPE IF EXISTS user_role;
CREATE TYPE user_role AS ENUM ('ADMIN', 'MANAGER', 'STAFF', 'VIEWER');


-- 2. Merchants Table - Qu·∫£n l√Ω doanh nghi·ªáp
CREATE TABLE merchants (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    tax_code VARCHAR(20) NOT NULL UNIQUE COMMENT 'M√£ s·ªë thu·∫ø - ƒë·ªãnh danh doanh nghi·ªáp',
    company_name VARCHAR(255) NOT NULL COMMENT 'T√™n c√¥ng ty ƒë·∫ßy ƒë·ªß',
    short_name VARCHAR(100) COMMENT 'T√™n vi·∫øt t·∫Øt',
    address TEXT COMMENT 'ƒê·ªãa ch·ªâ tr·ª• s·ªü ch√≠nh',
    district VARCHAR(100) COMMENT 'Qu·∫≠n/Huy·ªán',
    city VARCHAR(100) COMMENT 'T·ªânh/Th√†nh ph·ªë',
    email VARCHAR(255) COMMENT 'Email li√™n h·ªá',
    phone VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    representative_name VARCHAR(100) COMMENT 'T√™n ng∆∞·ªùi ƒë·∫°i di·ªán',
    representative_title VARCHAR(100) COMMENT 'Ch·ª©c danh ng∆∞·ªùi ƒë·∫°i di·ªán',
    subscription_plan subscription_plan NOT NULL DEFAULT 'TRIAL' COMMENT 'G√≥i d·ªãch v·ª•',
    invoice_quota INT NOT NULL DEFAULT 100 COMMENT 'H·∫°n m·ª©c h√≥a ƒë∆°n/th√°ng',
    invoice_used INT NOT NULL DEFAULT 0 COMMENT 'H√≥a ƒë∆°n ƒë√£ s·ª≠ d·ª•ng trong th√°ng',
    status entity_status NOT NULL DEFAULT 'ACTIVE' COMMENT 'Tr·∫°ng th√°i ho·∫°t ƒë·ªông',
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'Soft delete flag',
    deleted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    INDEX idx_tax_code (tax_code),
    INDEX idx_status (status),
    INDEX idx_subscription_plan (subscription_plan),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω doanh nghi·ªáp s·ª≠ d·ª•ng d·ªãch v·ª•';


-- 3. Merchant Users - T√†i kho·∫£n ng∆∞·ªùi d√πng c·ªßa Merchant
CREATE TABLE merchant_users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Li√™n k·∫øt v·ªõi doanh nghi·ªáp',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT 'T√™n ƒëƒÉng nh·∫≠p',
    email VARCHAR(255) NOT NULL UNIQUE COMMENT 'Email ng∆∞·ªùi d√πng',
    password_hash VARCHAR(255) NOT NULL COMMENT 'M·∫≠t kh·∫©u ƒë√£ m√£ h√≥a BCrypt',
    full_name VARCHAR(100) COMMENT 'H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß',
    phone VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    avatar_url VARCHAR(500) COMMENT 'URL ·∫£nh ƒë·∫°i di·ªán',
    role user_role NOT NULL DEFAULT 'STAFF' COMMENT 'Vai tr√≤ trong h·ªá th·ªëng',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'K√≠ch ho·∫°t t√†i kho·∫£n',
    is_primary BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'T√†i kho·∫£n ch√≠nh c·ªßa doanh nghi·ªáp',
    last_login_at TIMESTAMP NULL COMMENT 'ƒêƒÉng nh·∫≠p l·∫ßn cu·ªëi',
    failed_login_attempts INT NOT NULL DEFAULT 0 COMMENT 'S·ªë l·∫ßn ƒëƒÉng nh·∫≠p sai',
    locked_until TIMESTAMP NULL COMMENT 'Kh√≥a t√†i kho·∫£n ƒë·∫øn th·ªùi ƒëi·ªÉm',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_merchant_users_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_role (role),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='T√†i kho·∫£n ng∆∞·ªùi d√πng thu·ªôc Merchant';


-- 4. API Credentials - B·∫£o m·∫≠t v√† t√≠ch h·ª£p API
CREATE TABLE api_credentials (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu credential',
    client_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'ID c√¥ng khai c·ªßa ·ª©ng d·ª•ng',
    api_key_hash VARCHAR(255) NOT NULL COMMENT 'Hash c·ªßa API Key (SHA-256)',
    api_key_prefix VARCHAR(8) NOT NULL COMMENT '8 k√Ω t·ª± ƒë·∫ßu c·ªßa API Key (hi·ªÉn th·ªã)',
    scopes TEXT NOT NULL COMMENT 'Quy·ªÅn h·∫°n - JSON array: [invoice.create, invoice.view]',
    ip_whitelist TEXT NULL COMMENT 'Danh s√°ch IP ƒë∆∞·ª£c ph√©p - JSON array ho·∫∑c NULL',
    rate_limit_per_hour INT NOT NULL DEFAULT 1000 COMMENT 'Gi·ªõi h·∫°n request/gi·ªù',
    rate_limit_per_day INT NOT NULL DEFAULT 10000 COMMENT 'Gi·ªõi h·∫°n request/ng√†y',
    request_count_hour INT NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong gi·ªù',
    request_count_day INT NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong ng√†y',
    request_count_resetted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm reset counter',
    expired_at TIMESTAMP NULL COMMENT 'Ng√†y h·∫øt h·∫°n - NULL l√† kh√¥ng gi·ªõi h·∫°n',
    last_used_at TIMESTAMP NULL COMMENT 'L·∫ßn s·ª≠ d·ª•ng cu·ªëi',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_by BIGINT NULL COMMENT 'Ng∆∞·ªùi t·∫°o - merchant_users.id',
    
    CONSTRAINT fk_api_credentials_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    CONSTRAINT fk_api_credentials_created_by FOREIGN KEY (created_by) 
        REFERENCES merchant_users(id) ON DELETE SET NULL,
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_client_id (client_id),
    INDEX idx_api_key_hash (api_key_hash),
    INDEX idx_expired_at (expired_at),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Credentials cho API access';


-- 5. Service Providers - Nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠
CREATE TABLE service_providers (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    provider_code VARCHAR(20) NOT NULL UNIQUE COMMENT 'M√£ provider: VNPT, VIETTEL, MISA, BKAV',
    provider_name VARCHAR(100) NOT NULL COMMENT 'T√™n ƒë·∫ßy ƒë·ªß nh√† cung c·∫•p',
    official_api_url VARCHAR(500) NOT NULL COMMENT 'URL API ch√≠nh th·ª©c',
    documentation_url VARCHAR(500) NULL COMMENT 'Link t√†i li·ªáu API',
    support_email VARCHAR(255) NULL COMMENT 'Email h·ªó tr·ª£',
    support_phone VARCHAR(20) NULL COMMENT 'Hotline h·ªó tr·ª£',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'Provider c√≤n ho·∫°t ƒë·ªông',
    is_default BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh c·ªßa h·ªá th·ªëng',
    display_order INT NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
    extra_config_schema JSON NULL COMMENT 'Schema c·∫•u h√¨nh b·ªï sung cho provider',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_provider_code (provider_code),
    INDEX idx_is_active (is_active),
    INDEX idx_is_default (is_default),
    INDEX idx_display_order (display_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠';

-- Insert default providers
INSERT INTO service_providers (provider_code, provider_name, official_api_url, is_active, is_default, display_order) VALUES
('VNPT', 'VNPT Invoice', 'https://api.vnptinvoice.com.vn/v1', TRUE, FALSE, 1),
('VIETTEL', 'Viettel Business Invoice', 'https://ebill.vietteltelecom.vn/api/v1', TRUE, FALSE, 2),
('MISA', 'MISA Mimosa', 'https://api.misa.com.vn/einvoice/v1', FALSE, FALSE, 3),
('BKAV', 'BKAV eInvoice', 'https://einvoice.bkav.com/api/v1', FALSE, FALSE, 4);


-- 6. Merchant Provider Configs - C·∫•u h√¨nh ri√™ng c·ªßa Merchant
CREATE TABLE merchant_provider_configs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu',
    provider_id BIGINT NOT NULL COMMENT 'Nh√† cung c·∫•p ƒë∆∞·ª£c ch·ªçn',
    username_service VARCHAR(100) NOT NULL COMMENT 'T√†i kho·∫£n API do Provider c·∫•p',
    password_service_encrypted VARCHAR(500) NOT NULL COMMENT 'M·∫≠t kh·∫©u API - ƒë√£ m√£ h√≥a AES-256',
    certificate_serial VARCHAR(100) NULL COMMENT 'Serial number c·ªßa ch·ªØ k√Ω s·ªë',
    certificate_data TEXT NULL COMMENT 'Ch·ª©ng th∆∞ s·ªë - ƒë√£ m√£ h√≥a',
    certificate_expired_at TIMESTAMP NULL COMMENT 'H·∫°n ch·ª©ng th∆∞ s·ªë',
    extra_config JSON NULL COMMENT 'C·∫•u h√¨nh b·ªï sung: pattern, serial, template',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C·∫•u h√¨nh c√≤n hi·ªáu l·ª±c',
    is_default BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh c·ªßa Merchant',
    last_sync_at TIMESTAMP NULL COMMENT 'L·∫ßn ƒë·ªìng b·ªô cu·ªëi v·ªõi Provider',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_mpc_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    CONSTRAINT fk_mpc_provider FOREIGN KEY (provider_id) 
        REFERENCES service_providers(id) ON DELETE RESTRICT,
    CONSTRAINT uq_merchant_provider UNIQUE (merchant_id, provider_id),
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_provider_id (provider_id),
    INDEX idx_is_active (is_active),
    INDEX idx_is_default (is_default)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='C·∫•u h√¨nh k·∫øt n·ªëi Provider cho t·ª´ng Merchant';


-- 7. Invoice Metadata - Th√¥ng tin t√≥m t·∫Øt h√≥a ƒë∆°n
CREATE TABLE invoices_metadata (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp ph√°t h√†nh',
    provider_id BIGINT NULL COMMENT 'Provider x·ª≠ l√Ω h√≥a ƒë∆°n',
    provider_config_id BIGINT NULL COMMENT 'C·∫•u h√¨nh Provider ƒë∆∞·ª£c s·ª≠ d·ª•ng',
    client_request_id VARCHAR(100) NULL COMMENT 'ID request t·ª´ Merchant',
    
    -- Th√¥ng tin h√≥a ƒë∆°n
    invoice_number VARCHAR(20) NULL COMMENT 'S·ªë h√≥a ƒë∆°n t·ª´ Provider tr·∫£ v·ªÅ',
    symbol_code VARCHAR(10) NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n ',
    invoice_type_code VARCHAR(10) NULL COMMENT 'M√£ lo·∫°i h√≥a ƒë∆°n: 01GTKT, 02GTTT, 07KPTQ...',
    template_code VARCHAR(20) NULL COMMENT 'M·∫´u h√≥a ƒë∆°n: 01GTKT0/001, 02GTTT0/001...',
    
    -- Th√¥ng tin ng∆∞·ªùi b√°n (t·ª´ merchant data)
    seller_name VARCHAR(255) NULL COMMENT 'T√™n ng∆∞·ªùi b√°n',
    seller_tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi b√°n',
    seller_address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi b√°n',
    
    -- Th√¥ng tin ng∆∞·ªùi mua
    buyer_name VARCHAR(255) NULL COMMENT 'T√™n ng∆∞·ªùi mua',
    buyer_tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi mua',
    buyer_email VARCHAR(255) NULL COMMENT 'Email ng∆∞·ªùi mua (nh·∫≠n h√≥a ƒë∆°n)',
    buyer_phone VARCHAR(20) NULL COMMENT 'ƒêi·ªán tho·∫°i ng∆∞·ªùi mua',
    buyer_address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi mua',
    
    -- Th√¥ng tin t√†i ch√≠nh
    subtotal_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø',
    tax_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ø',
    discount_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng chi·∫øt kh·∫•u',
    total_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thanh to√°n',
    currency_code VARCHAR(3) NOT NULL DEFAULT 'VND' COMMENT 'ƒê∆°n v·ªã ti·ªÅn t·ªá',
    exchange_rate DECIMAL(10,4) NOT NULL DEFAULT 1.0000 COMMENT 'T·ª∑ gi√° v·ªõi VND',
    
    -- Th√¥ng tin th·ªùi gian
    issue_date DATE NULL COMMENT 'Ng√†y l·∫≠p h√≥a ƒë∆°n',
    accounting_date DATE NULL COMMENT 'Ng√†y h·∫°ch to√°n',
    due_date DATE NULL COMMENT 'Ng√†y thanh to√°n ƒë·∫øn h·∫°n',
    
    -- Tr·∫°ng th√°i v√† ƒëi·ªÅu kho·∫£n
    status invoice_status NOT NULL DEFAULT 'DRAFT' COMMENT 'Tr·∫°ng th√°i x·ª≠ l√Ω',
    status_message TEXT NULL COMMENT 'Th√¥ng b√°o tr·∫°ng th√°i chi ti·∫øt',
    cancellation_reason VARCHAR(500) NULL COMMENT 'L√Ω do h·ªßy/thay th·∫ø',
    replaced_by_invoice_id BIGINT NULL COMMENT 'ID h√≥a ƒë∆°n thay th·∫ø',
    
    -- Li√™n k·∫øt MongoDB
    mongo_payload_id VARCHAR(50) NULL COMMENT 'ObjectId trong collection invoice_payloads',
    mongo_transaction_id VARCHAR(50) NULL COMMENT 'ObjectId trong collection provider_transactions',
    
    -- Tracking
    signed_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm k√Ω ƒëi·ªán t·ª≠',
    sent_to_provider_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i sang Provider',
    received_from_provider_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
    delivered_to_buyer_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i h√≥a ƒë∆°n cho ng∆∞·ªùi mua',
    
    -- Provider response reference
    provider_transaction_code VARCHAR(100) NULL COMMENT 'M√£ giao d·ªãch t·ª´ Provider',
    provider_error_code VARCHAR(50) NULL COMMENT 'M√£ l·ªói t·ª´ Provider',
    provider_error_message TEXT NULL COMMENT 'Chi ti·∫øt l·ªói t·ª´ Provider',
    
    -- Soft delete
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'H√≥a ƒë∆°n ƒë√£ b·ªã x√≥a',
    deleted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
    deleted_by BIGINT NULL COMMENT 'Ng∆∞·ªùi x√≥a - merchant_users.id',
    
    -- Timestamps
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    -- Foreign Keys
    CONSTRAINT fk_invoice_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE RESTRICT,
    CONSTRAINT fk_invoice_provider FOREIGN KEY (provider_id) 
        REFERENCES service_providers(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_config FOREIGN KEY (provider_config_id) 
        REFERENCES merchant_provider_configs(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_replaced_by FOREIGN KEY (replaced_by_invoice_id) 
        REFERENCES invoices_metadata(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_deleted_by FOREIGN KEY (deleted_by) 
        REFERENCES merchant_users(id) ON DELETE SET NULL,
    
    -- Indexes for performance
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_provider_id (provider_id),
    INDEX idx_invoice_number (invoice_number),
    INDEX idx_symbol_code (symbol_code),
    INDEX idx_buyer_tax_code (buyer_tax_code),
    INDEX idx_status (status),
    INDEX idx_issue_date (issue_date),
    INDEX idx_created_at (created_at),
    INDEX idx_client_request_id (client_request_id),
    INDEX idx_merchant_status (merchant_id, status),
    INDEX idx_merchant_created (merchant_id, created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Metadata h√≥a ƒë∆°n - ph·ª•c v·ª• tra c·ª©u nhanh';


-- 8. Audit Log - Nh·∫≠t k√Ω thao t√°c
CREATE TABLE audit_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NULL COMMENT 'Doanh nghi·ªáp li√™n quan',
    user_id BIGINT NULL COMMENT 'Ng∆∞·ªùi th·ª±c hi·ªán',
    entity_type VARCHAR(50) NOT NULL COMMENT 'Lo·∫°i entity: Invoice, Merchant, Config...',
    entity_id BIGINT NOT NULL COMMENT 'ID c·ªßa entity',
    action VARCHAR(50) NOT NULL COMMENT 'H√†nh ƒë·ªông: CREATE, UPDATE, DELETE, STATUS_CHANGE',
    old_value JSON NULL COMMENT 'Gi√° tr·ªã c≈©',
    new_value JSON NULL COMMENT 'Gi√° tr·ªã m·ªõi',
    ip_address VARCHAR(45) NULL COMMENT 'IP th·ª±c hi·ªán',
    user_agent VARCHAR(500) NULL COMMENT 'User Agent c·ªßa browser/client',
    request_id VARCHAR(100) NULL COMMENT 'ID request t·ª´ frontend',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm x·∫£y ra',
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_user_id (user_id),
    INDEX idx_entity (entity_type, entity_id),
    INDEX idx_action (action),
    INDEX idx_created_at (created_at),
    INDEX idx_merchant_entity (merchant_id, entity_type, entity_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Nh·∫≠t k√Ω thay ƒë·ªïi h·ªá th·ªëng';


-- 9. System Configuration - C·∫•u h√¨nh h·ªá th·ªëng
CREATE TABLE system_config (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    config_key VARCHAR(100) NOT NULL UNIQUE COMMENT 'Kh√≥a c·∫•u h√¨nh',
    config_value TEXT NOT NULL COMMENT 'Gi√° tr·ªã c·∫•u h√¨nh',
    config_type VARCHAR(20) NOT NULL DEFAULT 'STRING' COMMENT 'Lo·∫°i: STRING, NUMBER, BOOLEAN, JSON',
    description VARCHAR(500) NULL COMMENT 'M√¥ t·∫£ c·∫•u h√¨nh',
    is_encrypted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'C√≥ c·∫ßn m√£ h√≥a kh√¥ng',
    is_editable BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≥ th·ªÉ ch·ªânh s·ª≠a kh√¥ng',
    updated_by BIGINT NULL COMMENT 'Ng∆∞·ªùi c·∫≠p nh·∫≠t cu·ªëi',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_config_updated_by FOREIGN KEY (updated_by) 
        REFERENCES merchant_users(id) ON DELETE SET NULL,
    
    INDEX idx_config_key (config_key)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='C·∫•u h√¨nh h·ªá th·ªëng';

-- Insert default configurations
INSERT INTO system_config (config_key, config_value, config_type, description) VALUES
('SYSTEM_NAME', 'EInvoiceHub', 'STRING', 'T√™n hi·ªÉn th·ªã c·ªßa h·ªá th·ªëng'),
('INVOICE_EXPIRY_DAYS', '30', 'NUMBER', 'S·ªë ng√†y h√≥a ƒë∆°n c√≥ hi·ªáu l·ª±c sau khi ph√°t h√†nh'),
('MAX_RETRY_ATTEMPTS', '3', 'NUMBER', 'S·ªë l·∫ßn th·ª≠ l·∫°i khi g·ªçi Provider th·∫•t b·∫°i'),
('RETRY_DELAY_MS', '1000', 'NUMBER', 'Th·ªùi gian ch·ªù gi·ªØa c√°c l·∫ßn th·ª≠ l·∫°i (milliseconds)'),
('SESSION_TIMEOUT_MINUTES', '60', 'NUMBER', 'Th·ªùi gian timeout c·ªßa session'),
('PASSWORD_MIN_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i t·ªëi thi·ªÉu c·ªßa m·∫≠t kh·∫©u'),
('API_KEY_PREFIX_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i prefix hi·ªÉn th·ªã c·ªßa API Key'),
('DEFAULT_CURRENCY', 'VND', 'STRING', 'ƒê∆°n v·ªã ti·ªÅn t·ªá m·∫∑c ƒë·ªãnh'),
('TAX_DEFAULT_RATE', '10.00', 'NUMBER', 'Thu·∫ø su·∫•t m·∫∑c ƒë·ªãnh (%)');


/* TRIGGER VERSION 3
-- PH·∫¶N 3: TRIGGERS
-- Trigger 1: T·ª± ƒë·ªông c·∫≠p nh·∫≠t merchants.invoice_used khi h√≥a ƒë∆°n chuy·ªÉn sang SUCCESS
DELIMITER //

CREATE TRIGGER trg_invoice_status_success
    AFTER UPDATE ON invoices_metadata
    FOR EACH ROW
BEGIN
    -- Ki·ªÉm tra n·∫øu tr·∫°ng th√°i chuy·ªÉn sang SUCCESS v√† merchant_id t·ªìn t·∫°i
    IF NEW.status = 'SUCCESS' AND OLD.status != 'SUCCESS' AND NEW.merchant_id IS NOT NULL THEN
    UPDATE merchants
    SET invoice_used = invoice_used + 1,
        updated_at = NOW()
    WHERE id = NEW.merchant_id;

    -- Ghi audit log
    INSERT INTO audit_logs (merchant_id, user_id, entity_type, entity_id, action, old_value, new_value)
    VALUES (
               NEW.merchant_id,
               NULL,
               'Invoice',
               NEW.id,
               'STATUS_CHANGE',
               CONCAT('{"status": "', OLD.status, '"}'),
               CONCAT('{"status": "', NEW.status, '", "invoice_used_incremented": true}')
           );
END IF;

-- X·ª≠ l√Ω tr∆∞·ªùng h·ª£p h·ªßy h√≥a ƒë∆°n: gi·∫£m invoice_used
IF NEW.status = 'CANCELLED' AND OLD.status = 'SUCCESS' AND NEW.merchant_id IS NOT NULL THEN
UPDATE merchants
SET invoice_used = GREATEST(0, invoice_used - 1),
    updated_at = NOW()
WHERE id = NEW.merchant_id;
END IF;
END //

DELIMITER ;


-- Trigger 2: T·ª± ƒë·ªông t√≠nh to√°n total_amount t·ª´ invoice_items
DELIMITER //

CREATE TRIGGER trg_calculate_invoice_totals
    AFTER INSERT ON invoice_items
    FOR EACH ROW
BEGIN
    -- T√≠nh to√°n l·∫°i c√°c t·ªïng ti·ªÅn cho h√≥a ƒë∆°n
    UPDATE invoices_metadata SET
                                 subtotal_amount = (
                                     SELECT COALESCE(SUM(amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 tax_amount = (
                                     SELECT COALESCE(SUM(tax_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 discount_amount = (
                                     SELECT COALESCE(SUM(discount_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 total_amount = (
                                     SELECT COALESCE(SUM(total_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 updated_at = NOW()
    WHERE id = NEW.invoice_id;
END //

DELIMITER ;


-- Trigger 3: T·ª± ƒë·ªông c·∫≠p nh·∫≠t totals khi invoice_items ƒë∆∞·ª£c c·∫≠p nh·∫≠t
DELIMITER //

CREATE TRIGGER trg_update_invoice_totals
    AFTER UPDATE ON invoice_items
    FOR EACH ROW
BEGIN
    UPDATE invoices_metadata SET
                                 subtotal_amount = (
                                     SELECT COALESCE(SUM(amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 tax_amount = (
                                     SELECT COALESCE(SUM(tax_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 discount_amount = (
                                     SELECT COALESCE(SUM(discount_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 total_amount = (
                                     SELECT COALESCE(SUM(total_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 updated_at = NOW()
    WHERE id = NEW.invoice_id;
END //

DELIMITER ;


-- Trigger 4: T·ª± ƒë·ªông c·∫≠p nh·∫≠t totals khi invoice_items b·ªã x√≥a
DELIMITER //

CREATE TRIGGER trg_delete_invoice_totals
    AFTER DELETE ON invoice_items
    FOR EACH ROW
BEGIN
    UPDATE invoices_metadata SET
                                 subtotal_amount = (
                                     SELECT COALESCE(SUM(amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = OLD.invoice_id
                                 ),
                                 tax_amount = (
                                     SELECT COALESCE(SUM(tax_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = OLD.invoice_id
                                 ),
                                 discount_amount = (
                                     SELECT COALESCE(SUM(discount_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = OLD.invoice_id
                                 ),
                                 total_amount = (
                                     SELECT COALESCE(SUM(total_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = OLD.invoice_id
                                 ),
                                 updated_at = NOW()
    WHERE id = OLD.invoice_id;
END //

DELIMITER ;


-- Trigger 5: T·ª± ƒë·ªông t·∫°o invoice_tax_breakdowns khi invoice ƒë∆∞·ª£c t·∫°o
DELIMITER //

CREATE TRIGGER trg_create_tax_breakdowns
    AFTER INSERT ON invoice_items
    FOR EACH ROW
BEGIN
    -- Ch·ªâ ch·∫°y m·ªôt l·∫ßn sau khi t·∫•t c·∫£ items ƒë∆∞·ª£c insert (ki·ªÉm tra b·∫±ng count)
    INSERT INTO invoice_tax_breakdowns
    (invoice_id, vat_rate_id, vat_rate_code, vat_rate_percent,
     subtotal_amount, discount_amount, taxable_amount, tax_amount, total_amount)
    SELECT
        NEW.invoice_id,
        vr.id,
        vr.rate_code,
        vr.rate_percent,
        COALESCE(SUM(ii.amount), 0) AS subtotal_amount,
        COALESCE(SUM(ii.discount_amount), 0) AS discount_amount,
        COALESCE(SUM(ii.amount - ii.discount_amount), 0) AS taxable_amount,
        COALESCE(SUM(ii.tax_amount), 0) AS tax_amount,
        COALESCE(SUM(ii.total_amount), 0) AS total_amount
    FROM invoice_items ii
             INNER JOIN vat_rates vr ON vr.id = NEW.vat_rate_id
    WHERE ii.invoice_id = NEW.invoice_id
        ON DUPLICATE KEY UPDATE
                             subtotal_amount = VALUES(subtotal_amount),
                             discount_amount = VALUES(discount_amount),
                             taxable_amount = VALUES(taxable_amount),
                             tax_amount = VALUES(tax_amount),
                             total_amount = VALUES(total_amount);
END //

DELIMITER ;


-- Trigger 6: T·ª± ƒë·ªông c·∫≠p nh·∫≠t current_number trong invoice_registrations
DELIMITER //

CREATE TRIGGER trg_update_registration_number
    AFTER INSERT ON invoices_metadata
    FOR EACH ROW
BEGIN
    IF NEW.invoice_registration_id IS NOT NULL AND NEW.status = 'SUCCESS' THEN
    UPDATE invoice_registrations SET
                                     current_number = current_number + 1,
                                     status = CASE
                                                  WHEN current_number + 1 >= to_number THEN 'EXHAUSTED'
                                                  ELSE 'ACTIVE'
                                         END,
                                     updated_at = NOW()
    WHERE id = NEW.invoice_registration_id;
END IF;
END //

DELIMITER ;


-- Trigger 7: T·ª± ƒë·ªông t·∫°o lookup_code khi h√≥a ƒë∆°n ƒë∆∞·ª£c t·∫°o
DELIMITER //

CREATE TRIGGER trg_generate_lookup_code
    BEFORE INSERT ON invoices_metadata
    FOR EACH ROW
BEGIN
    -- T·ª± ƒë·ªông t·∫°o lookup_code n·∫øu ch∆∞a c√≥
    IF NEW.lookup_code IS NULL AND NEW.invoice_number IS NOT NULL THEN
        SET NEW.lookup_code = CONCAT(
            NEW.invoice_number,
            '-',
            LPAD(FLOOR(RAND() * 1000000), 6, '0')
        );
END IF;
END //

DELIMITER ;


-- View: T·ªïng h·ª£p th√¥ng tin h√≥a ƒë∆°n ƒë·∫ßy ƒë·ªß
CREATE VIEW v_invoices_full AS
SELECT
    im.id AS invoice_id,
    im.invoice_number,
    im.symbol_code,
    im.template_code,
    im.cqt_code,
    im.status,
    im.issue_date,
    im.total_amount,
    im.tax_amount,
    im.subtotal_amount,
    im.discount_amount,
    im.currency_code,
    im.payment_method,
    im.issuance_method,
    m.tax_code AS merchant_tax_code,
    m.company_name AS merchant_name,
    im.seller_name,
    im.seller_tax_code,
    im.buyer_name,
    im.buyer_tax_code,
    im.buyer_email,
    im.created_at,
    im.provider_transaction_code
FROM invoices_metadata im
         INNER JOIN merchants m ON m.id = im.merchant_id;


-- View: T·ªïng h·ª£p tax breakdown theo h√≥a ƒë∆°n
CREATE VIEW v_invoice_tax_summary AS
SELECT
    itb.invoice_id,
    im.invoice_number,
    im.symbol_code,
    itb.vat_rate_code,
    itb.vat_rate_percent,
    itb.subtotal_amount,
    itb.taxable_amount,
    itb.tax_amount,
    itb.total_amount
FROM invoice_tax_breakdowns itb
         INNER JOIN invoices_metadata im ON im.id = itb.invoice_id
ORDER BY im.invoice_number, itb.vat_rate_percent DESC;


-- View: Th·ªëng k√™ s·ªë l∆∞·ª£ng h√≥a ƒë∆°n theo tr·∫°ng th√°i
CREATE VIEW v_invoice_stats_by_status AS
SELECT
    m.id AS merchant_id,
    m.tax_code AS merchant_tax_code,
    m.company_name AS merchant_name,
    im.status,
    COUNT(*) AS invoice_count,
    COALESCE(SUM(im.total_amount), 0) AS total_amount,
    COALESCE(SUM(im.tax_amount), 0) AS total_tax_amount
FROM invoices_metadata im
         INNER JOIN merchants m ON m.id = im.merchant_id
WHERE im.is_deleted = FALSE
GROUP BY m.id, m.tax_code, m.company_name, im.status;


-- View: Danh s√°ch pending sync jobs
CREATE VIEW v_pending_sync_jobs AS
SELECT
    isq.id AS queue_id,
    isq.invoice_id,
    im.invoice_number,
    im.symbol_code,
    m.tax_code AS merchant_tax_code,
    sp.provider_code,
    isq.sync_type,
    isq.priority,
    isq.attempt_count,
    isq.max_attempts,
    isq.status,
    isq.error_message,
    isq.next_retry_at
FROM invoice_sync_queue isq
         INNER JOIN invoices_metadata im ON im.id = isq.invoice_id
         INNER JOIN merchants m ON m.id = isq.merchant_id
         LEFT JOIN service_providers sp ON sp.id = isq.provider_id
WHERE isq.status IN ('PENDING', 'RETRYING')
ORDER BY isq.priority ASC, isq.next_retry_at ASC;


-- ============================================================================
-- PH·∫¶N 5: STORED PROCEDURES (TH·ª¶ T·ª§C TH∆Ø·ªúNG D√ôNG)
-- ============================================================================

-- Procedure: C·∫≠p nh·∫≠t invoice_registration khi s·ª≠ d·ª•ng s·ªë h√≥a ƒë∆°n
DELIMITER //

CREATE PROCEDURE sp_use_invoice_number(
    IN p_registration_id BIGINT,
    OUT p_new_number BIGINT
)
BEGIN
    DECLARE v_current_number BIGINT;
    DECLARE v_max_number BIGINT;

    -- L·∫•y s·ªë hi·ªán t·∫°i v√† max
SELECT current_number, max_number INTO v_current_number, v_max_number
FROM invoice_registrations
WHERE id = p_registration_id
    FOR UPDATE;

-- Ki·ªÉm tra c√≤n s·ªë kh√¥ng
IF v_current_number < v_max_number THEN
        -- TƒÉng s·ªë hi·ªán t·∫°i
UPDATE invoice_registrations SET
                                 current_number = current_number + 1,
                                 updated_at = NOW()
WHERE id = p_registration_id;

SET p_new_number = v_current_number + 1;
ELSE
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'D·∫£i s·ªë h√≥a ƒë∆°n ƒë√£ h·∫øt';
END IF;
END //

DELIMITER ;


-- Procedure: Reset invoice_used ƒë·∫ßu th√°ng cho t·∫•t c·∫£ merchants
DELIMITER //

CREATE PROCEDURE sp_reset_monthly_invoice_usage()
BEGIN
UPDATE merchants SET
                     invoice_used = 0,
                     updated_at = NOW()
WHERE status = 'ACTIVE';

SELECT ROW_COUNT() AS merchants_reset;
END //

DELIMITER ;


-- Procedure: T·∫°o adjustment cho h√≥a ƒë∆°n ƒëi·ªÅu ch·ªânh
DELIMITER //

CREATE PROCEDURE sp_create_adjustment(
    IN p_original_invoice_id BIGINT,
    IN p_adjustment_type ENUM('ADJUSTMENT', 'REPLACEMENT', 'CANCELLATION'),
    IN p_agreement_number VARCHAR(50),
    IN p_agreement_date DATE,
    IN p_agreement_content TEXT,
    IN p_reason_code VARCHAR(50),
    IN p_reason_description VARCHAR(500),
    OUT p_adjustment_id BIGINT
        )
BEGIN
    DECLARE v_old_subtotal DECIMAL(18,2);
    DECLARE v_old_tax DECIMAL(18,2);
    DECLARE v_old_total DECIMAL(18,2);

    -- L·∫•y th√¥ng tin h√≥a ƒë∆°n g·ªëc
SELECT subtotal_amount, tax_amount, total_amount
INTO v_old_subtotal, v_old_tax, v_old_total
FROM invoices_metadata
WHERE id = p_original_invoice_id;

-- T·∫°o b·∫£n ghi adjustment
INSERT INTO invoice_adjustments (
    original_invoice_id,
    adjustment_type,
    agreement_number,
    agreement_date,
    agreement_content,
    reason_code,
    reason_description,
    old_subtotal_amount,
    old_tax_amount,
    old_total_amount,
    status,
    created_at
) VALUES (
             p_original_invoice_id,
             p_adjustment_type,
             p_agreement_number,
             p_agreement_date,
             p_agreement_content,
             p_reason_code,
             p_reason_description,
             v_old_subtotal,
             v_old_tax,
             v_old_total,
             'PENDING',
             NOW()
         );

SET p_adjustment_id = LAST_INSERT_ID();
END //

DELIMITER ;


-- Procedure: Retry failed sync jobs
DELIMITER //

CREATE PROCEDURE sp_retry_failed_sync_jobs(
    IN p_limit INT
)
BEGIN
    -- C·∫≠p nh·∫≠t c√°c job failed ƒë·ªÉ retry
UPDATE invoice_sync_queue SET
                              status = 'RETRYING',
                              next_retry_at = DATE_ADD(NOW(), INTERVAL 5 MINUTE),
                              updated_at = NOW()
WHERE status = 'FAILED'
  AND attempt_count < max_attempts
  AND next_retry_at <= NOW()
    LIMIT p_limit;

SELECT ROW_COUNT() AS jobs_requeued;
END //

DELIMITER ;
*/

-- End of Database Schema Version 3
</file>

<file path="src/main/resources/db/migration/Initial_Schema_Ver02.sql">
-- EInvoiceHub Database Schema - Version 2 (Optimized)
-- Database: MariaDB 

-- 1. Merchants Table - Qu·∫£n l√Ω doanh nghi·ªáp
CREATE TABLE merchants (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    tax_code VARCHAR(20) NOT NULL UNIQUE COMMENT 'M√£ s·ªë thu·∫ø - ƒë·ªãnh danh doanh nghi·ªáp',
    company_name VARCHAR(255) NOT NULL COMMENT 'T√™n c√¥ng ty ƒë·∫ßy ƒë·ªß',
    short_name VARCHAR(100) COMMENT 'T√™n vi·∫øt t·∫Øt',
    address TEXT COMMENT 'ƒê·ªãa ch·ªâ tr·ª• s·ªü ch√≠nh',
    district VARCHAR(100) COMMENT 'Qu·∫≠n/Huy·ªán',
    city VARCHAR(100) COMMENT 'T·ªânh/Th√†nh ph·ªë',
    email VARCHAR(255) COMMENT 'Email li√™n h·ªá',
    phone VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    representative_name VARCHAR(100) COMMENT 'T√™n ng∆∞·ªùi ƒë·∫°i di·ªán',
    representative_title VARCHAR(100) COMMENT 'Ch·ª©c danh ng∆∞·ªùi ƒë·∫°i di·ªán',
    subscription_plan ENUM('TRIAL', 'BASIC', 'PREMIUM') NOT NULL DEFAULT 'TRIAL' COMMENT 'G√≥i d·ªãch v·ª•: TRIAL, BASIC, PREMIUM',
    invoice_quota INT NOT NULL DEFAULT 100 COMMENT 'H·∫°n m·ª©c h√≥a ƒë∆°n/th√°ng',
    invoice_used INT NOT NULL DEFAULT 0 COMMENT 'H√≥a ƒë∆°n ƒë√£ s·ª≠ d·ª•ng trong th√°ng',
    is_using_hsm BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'S·ª≠ d·ª•ng HSM hay USB Token ƒë·ªÉ k√Ω ƒëi·ªán t·ª≠',
    status ENUM('ACTIVE', 'INACTIVE', 'SUSPENDED') NOT NULL DEFAULT 'ACTIVE' COMMENT 'Tr·∫°ng th√°i ho·∫°t ƒë·ªông',
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'C·ªù x√≥a m·ªÅm',
    deleted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    INDEX idx_tax_code (tax_code),
    INDEX idx_status (status),
    INDEX idx_subscription_plan (subscription_plan),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω doanh nghi·ªáp s·ª≠ d·ª•ng d·ªãch v·ª• h√≥a ƒë∆°n ƒëi·ªán t·ª≠';


-- 2. Merchant Users - T√†i kho·∫£n ng∆∞·ªùi d√πng c·ªßa Merchant
CREATE TABLE merchant_users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Li√™n k·∫øt v·ªõi doanh nghi·ªáp',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT 'T√™n ƒëƒÉng nh·∫≠p',
    email VARCHAR(255) NOT NULL UNIQUE COMMENT 'Email ng∆∞·ªùi d√πng',
    password_hash VARCHAR(255) NOT NULL COMMENT 'M·∫≠t kh·∫©u ƒë√£ m√£ h√≥a BCrypt',
    full_name VARCHAR(100) COMMENT 'H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß',
    phone VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    avatar_url VARCHAR(500) COMMENT 'URL ·∫£nh ƒë·∫°i di·ªán',
    role ENUM('ADMIN', 'MANAGER', 'STAFF', 'VIEWER') NOT NULL DEFAULT 'STAFF' COMMENT 'Vai tr√≤ trong h·ªá th·ªëng: ADMIN, MANAGER, STAFF, VIEWER',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'K√≠ch ho·∫°t t√†i kho·∫£n',
    is_primary BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'T√†i kho·∫£n ch√≠nh c·ªßa doanh nghi·ªáp',
    last_login_at TIMESTAMP NULL COMMENT 'ƒêƒÉng nh·∫≠p l·∫ßn cu·ªëi',
    failed_login_attempts INT NOT NULL DEFAULT 0 COMMENT 'S·ªë l·∫ßn ƒëƒÉng nh·∫≠p sai',
    locked_until TIMESTAMP NULL COMMENT 'Kh√≥a t√†i kho·∫£n ƒë·∫øn th·ªùi ƒëi·ªÉm',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    CONSTRAINT fk_merchant_users_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_role (role),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='T√†i kho·∫£n ng∆∞·ªùi d√πng thu·ªôc Merchant';


-- 3. API Credentials - B·∫£o m·∫≠t v√† t√≠ch h·ª£p API


CREATE TABLE api_credentials (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu credential',
    client_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'ID c√¥ng khai c·ªßa ·ª©ng d·ª•ng',
    api_key_hash VARCHAR(255) NOT NULL COMMENT 'Hash c·ªßa API Key (SHA-256)',
    api_key_prefix VARCHAR(8) NOT NULL COMMENT '8 k√Ω t·ª± ƒë·∫ßu c·ªßa API Key (hi·ªÉn th·ªã)',
    scopes TEXT NOT NULL COMMENT 'Quy·ªÅn h·∫°n - JSON array: [invoice.create, invoice.view]',
    ip_whitelist TEXT NULL COMMENT 'Danh s√°ch IP ƒë∆∞·ª£c ph√©p - JSON array ho·∫∑c NULL',
    rate_limit_per_hour INT NOT NULL DEFAULT 1000 COMMENT 'Gi·ªõi h·∫°n request/gi·ªù',
    rate_limit_per_day INT NOT NULL DEFAULT 10000 COMMENT 'Gi·ªõi h·∫°n request/ng√†y',
    request_count_hour INT NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong gi·ªù',
    request_count_day INT NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong ng√†y',
    request_count_resetted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm reset counter',
    expired_at TIMESTAMP NULL COMMENT 'Ng√†y h·∫øt h·∫°n - NULL l√† kh√¥ng gi·ªõi h·∫°n',
    last_used_at TIMESTAMP NULL COMMENT 'L·∫ßn s·ª≠ d·ª•ng cu·ªëi',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    created_by BIGINT NULL COMMENT 'Ng∆∞·ªùi t·∫°o - merchant_users.id',
    
    CONSTRAINT fk_api_credentials_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    CONSTRAINT fk_api_credentials_created_by FOREIGN KEY (created_by) 
        REFERENCES merchant_users(id) ON DELETE SET NULL,
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_client_id (client_id),
    INDEX idx_api_key_hash (api_key_hash),
    INDEX idx_expired_at (expired_at),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Credentials cho API access';


-- 4. Service Providers - Nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠
CREATE TABLE service_providers (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    provider_code VARCHAR(20) NOT NULL UNIQUE COMMENT 'M√£ provider: VNPT, VIETTEL, MISA, BKAV',
    provider_name VARCHAR(100) NOT NULL COMMENT 'T√™n ƒë·∫ßy ƒë·ªß nh√† cung c·∫•p',
    official_api_url VARCHAR(500) NOT NULL COMMENT 'URL API ch√≠nh th·ª©c',
    documentation_url VARCHAR(500) NULL COMMENT 'Link t√†i li·ªáu API',
    support_email VARCHAR(255) NULL COMMENT 'Email h·ªó tr·ª£',
    support_phone VARCHAR(20) NULL COMMENT 'Hotline h·ªó tr·ª£',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'Provider c√≤n ho·∫°t ƒë·ªông',
    is_default BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh c·ªßa h·ªá th·ªëng',
    display_order INT NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
    extra_config_schema JSON NULL COMMENT 'Schema c·∫•u h√¨nh b·ªï sung cho provider',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    INDEX idx_provider_code (provider_code),
    INDEX idx_is_active (is_active),
    INDEX idx_is_default (is_default),
    INDEX idx_display_order (display_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠';

-- Insert default providers
INSERT INTO service_providers (provider_code, provider_name, official_api_url, is_active, is_default, display_order) VALUES
('VNPT', 'VNPT Invoice', 'https://api.vnptinvoice.com.vn/v1', TRUE, FALSE, 1),
('VIETTEL', 'Viettel Business Invoice', 'https://ebill.vietteltelecom.vn/api/v1', TRUE, FALSE, 2),
('MISA', 'MISA Mimosa', 'https://api.misa.com.vn/einvoice/v1', FALSE, FALSE, 3),
('BKAV', 'BKAV eInvoice', 'https://einvoice.bkav.com/api/v1', FALSE, FALSE, 4);


-- 5. Merchant Provider Configs - C·∫•u h√¨nh ri√™ng c·ªßa Merchant
CREATE TABLE merchant_provider_configs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu',
    provider_id BIGINT NOT NULL COMMENT 'Nh√† cung c·∫•p ƒë∆∞·ª£c ch·ªçn',
    username_service VARCHAR(100) NOT NULL COMMENT 'T√†i kho·∫£n API do Provider c·∫•p',
    password_service_encrypted VARCHAR(500) NOT NULL COMMENT 'M·∫≠t kh·∫©u API - ƒë√£ m√£ h√≥a AES-256',
    certificate_serial VARCHAR(100) NULL COMMENT 'Serial number c·ªßa ch·ª©ng th∆∞ s·ªë',
    certificate_data TEXT NULL COMMENT 'Ch·ª©ng th∆∞ s·ªë - ƒë√£ m√£ h√≥a',
    certificate_chain LONGTEXT NULL COMMENT 'Chu·ªói ch·ª©ng th∆∞ s·ªë ƒë·∫ßy ƒë·ªß (Certificate Chain)',
    certificate_expired_at TIMESTAMP NULL COMMENT 'H·∫°n ch·ª©ng th∆∞ s·ªë',
    extra_config JSON NULL COMMENT 'C·∫•u h√¨nh b·ªï sung: pattern, serial, template',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C·∫•u h√¨nh c√≤n hi·ªáu l·ª±c',
    is_default BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh c·ªßa Merchant',
    last_sync_at TIMESTAMP NULL COMMENT 'L·∫ßn ƒë·ªìng b·ªô cu·ªëi v·ªõi Provider',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    CONSTRAINT fk_mpc_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    CONSTRAINT fk_mpc_provider FOREIGN KEY (provider_id) 
        REFERENCES service_providers(id) ON DELETE RESTRICT,
    CONSTRAINT uq_merchant_provider UNIQUE (merchant_id, provider_id),
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_provider_id (provider_id),
    INDEX idx_is_active (is_active),
    INDEX idx_is_default (is_default)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='C·∫•u h√¨nh k·∫øt n·ªëi Provider cho t·ª´ng Merchant';


-- 6. Invoice Templates - Qu·∫£n l√Ω M·∫´u s·ªë & K√Ω hi·ªáu h√≥a ƒë∆°n
CREATE TABLE invoice_templates (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu m·∫´u',
    provider_id BIGINT NOT NULL COMMENT 'Nh√† cung c·∫•p h√≥a ƒë∆°n',
    invoice_type_code VARCHAR(10) NOT NULL COMMENT 'Lo·∫°i h√≥a ƒë∆°n: 01GTKT, 02GTTT, 07KPTQ, 03KPTQ...',
    template_code VARCHAR(20) NOT NULL COMMENT 'M·∫´u h√≥a ƒë∆°n: 01GTKT0/001, 02GTTT0/001...',
    symbol_code VARCHAR(10) NOT NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n: AA/22E, AB/23T...',
    current_number INT NOT NULL DEFAULT 0 COMMENT 'S·ªë hi·ªán h√≥a ƒë∆°n hi·ªán t·∫°i',
    prefix VARCHAR(20) NULL COMMENT 'Ti·ªÅn t·ªë s·ªë h√≥a ƒë∆°n',
    suffix VARCHAR(20) NULL COMMENT 'H·∫≠u t·ªë s·ªë h√≥a ƒë∆°n',
    min_number INT NOT NULL DEFAULT 1 COMMENT 'S·ªë b·∫Øt ƒë·∫ßu',
    max_number INT NOT NULL DEFAULT 99999 COMMENT 'S·ªë k·∫øt th√∫c',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'M·∫´u c√≤n hi·ªáu l·ª±c',
    is_sequential BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'S·ª≠ d·ª•ng s·ªë th·ª© t·ª± li√™n t·ª•c',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    CONSTRAINT fk_invoice_template_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    CONSTRAINT fk_invoice_template_provider FOREIGN KEY (provider_id) 
        REFERENCES service_providers(id) ON DELETE RESTRICT,
    CONSTRAINT uq_merchant_template UNIQUE (merchant_id, template_code, symbol_code),
    
    INDEX idx_template_merchant (merchant_id),
    INDEX idx_template_code (template_code),
    INDEX idx_symbol_code (symbol_code),
    INDEX idx_invoice_type (invoice_type_code),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω m·∫´u s·ªë v√† k√Ω hi·ªáu h√≥a ƒë∆°n theo quy ƒë·ªãnh';


-- 7. Customers - Danh m·ª•c kh√°ch h√†ng c·ªßa Merchant
CREATE TABLE customers (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu kh√°ch h√†ng',
    customer_code VARCHAR(50) NULL COMMENT 'M√£ kh√°ch h√†ng n·ªôi b·ªô',
    tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø kh√°ch h√†ng',
    name VARCHAR(255) NOT NULL COMMENT 'T√™n kh√°ch h√†ng/ƒë∆°n v·ªã',
    address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ',
    email VARCHAR(255) NULL COMMENT 'Email nh·∫≠n h√≥a ƒë∆°n',
    phone VARCHAR(20) NULL COMMENT 'ƒêi·ªán tho·∫°i',
    contact_person VARCHAR(100) NULL COMMENT 'Ng∆∞·ªùi li√™n h·ªá',
    bank_account VARCHAR(50) NULL COMMENT 'T√†i kho·∫£n ng√¢n h√†ng',
    bank_name VARCHAR(100) NULL COMMENT 'T√™n ng√¢n h√†ng',
    note TEXT NULL COMMENT 'Ghi ch√∫',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n ho·∫°t ƒë·ªông',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    CONSTRAINT fk_customer_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    
    INDEX idx_customer_merchant (merchant_id),
    INDEX idx_customer_code (customer_code),
    INDEX idx_tax_code (tax_code),
    INDEX idx_name (name),
    INDEX idx_email (email),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c kh√°ch h√†ng th∆∞·ªùng xuy√™n c·ªßa Merchant';


-- 8. Invoices Metadata - Th√¥ng tin t√≥m t·∫Øt h√≥a ƒë∆°n
CREATE TABLE invoices_metadata (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp ph√°t h√†nh',
    provider_id BIGINT NULL COMMENT 'Provider x·ª≠ l√Ω h√≥a ƒë∆°n',
    provider_config_id BIGINT NULL COMMENT 'C·∫•u h√¨nh Provider ƒë∆∞·ª£c s·ª≠ d·ª•ng',
    invoice_template_id BIGINT NULL COMMENT 'M·∫´u h√≥a ƒë∆°n ƒë∆∞·ª£c s·ª≠ d·ª•ng',
    client_request_id VARCHAR(100) NULL COMMENT 'ID request t·ª´ Merchant',
    
    -- Th√¥ng tin h√≥a ƒë∆°n
    invoice_number VARCHAR(20) NULL COMMENT 'S·ªë h√≥a ƒë∆°n t·ª´ Provider tr·∫£ v·ªÅ',
    symbol_code VARCHAR(10) NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n (VD: 1C23TML)',
    invoice_type_code VARCHAR(10) NULL COMMENT 'M√£ lo·∫°i h√≥a ƒë∆°n: 01GTKT, 02GTTT, 07KPTQ...',
    template_code VARCHAR(20) NULL COMMENT 'M·∫´u h√≥a ƒë∆°n: 01GTKT0/001, 02GTTT0/001...',
    is_summary_invoice BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'H√≥a ƒë∆°n t·ªïng h·ª£p hay h√≥a ƒë∆°n chi ti·∫øt',
    
    -- Th√¥ng tin C∆° quan Thu·∫ø
    cqt_code VARCHAR(50) NULL COMMENT 'M√£ C∆° quan Thu·∫ø qu·∫£n l√Ω',
    
    -- Th√¥ng tin ng∆∞·ªùi b√°n (t·ª´ merchant data)
    seller_name VARCHAR(255) NULL COMMENT 'T√™n ng∆∞·ªùi b√°n',
    seller_tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi b√°n',
    seller_address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi b√°n',
    
    -- Th√¥ng tin ng∆∞·ªùi mua
    buyer_name VARCHAR(255) NULL COMMENT 'T√™n ng∆∞·ªùi mua',
    buyer_tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi mua',
    buyer_email VARCHAR(255) NULL COMMENT 'Email ng∆∞·ªùi mua (nh·∫≠n h√≥a ƒë∆°n)',
    buyer_phone VARCHAR(20) NULL COMMENT 'ƒêi·ªán tho·∫°i ng∆∞·ªùi mua',
    buyer_address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi mua',
    customer_id BIGINT NULL COMMENT 'Li√™n k·∫øt v·ªõi b·∫£ng customers',
    
    -- Th√¥ng tin t√†i ch√≠nh
    subtotal_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø',
    tax_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ø',
    discount_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng chi·∫øt kh·∫•u',
    total_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thanh to√°n',
    currency_code VARCHAR(3) NOT NULL DEFAULT 'VND' COMMENT 'ƒê∆°n v·ªã ti·ªÅn t·ªá',
    exchange_rate DECIMAL(10,4) NOT NULL DEFAULT 1.0000 COMMENT 'T·ª∑ gi√° v·ªõi VND',
    
    -- Th√¥ng tin th·ªùi gian
    issue_date DATE NULL COMMENT 'Ng√†y l·∫≠p h√≥a ƒë∆°n',
    accounting_date DATE NULL COMMENT 'Ng√†y h·∫°ch to√°n',
    due_date DATE NULL COMMENT 'Ng√†y thanh to√°n ƒë·∫øn h·∫°n',
    
    -- Tr·∫°ng th√°i v√† ƒëi·ªÅu kho·∫£n
    status ENUM('DRAFT', 'PENDING', 'SIGNING', 'SENT_TO_PROVIDER', 'SUCCESS', 'FAILED', 'CANCELLED', 'REPLACED') NOT NULL DEFAULT 'DRAFT' COMMENT 'Tr·∫°ng th√°i x·ª≠ l√Ω h√≥a ƒë∆°n',
    status_message TEXT NULL COMMENT 'Th√¥ng b√°o tr·∫°ng th√°i chi ti·∫øt',
    cancellation_reason VARCHAR(500) NULL COMMENT 'L√Ω do h·ªßy/thay th·∫ø',
    replaced_by_invoice_id BIGINT NULL COMMENT 'ID h√≥a ƒë∆°n thay th·∫ø',
    
    -- Tracking
    signed_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm k√Ω ƒëi·ªán t·ª≠',
    sent_to_provider_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i sang Provider',
    received_from_provider_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
    delivered_to_buyer_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i h√≥a ƒë∆°n cho ng∆∞·ªùi mua',
    
    -- Provider response reference
    provider_transaction_code VARCHAR(100) NULL COMMENT 'M√£ giao d·ªãch t·ª´ Provider',
    provider_error_code VARCHAR(50) NULL COMMENT 'M√£ l·ªói t·ª´ Provider',
    provider_error_message TEXT NULL COMMENT 'Chi ti·∫øt l·ªói t·ª´ Provider',
    
    -- Soft delete
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'H√≥a ƒë∆°n ƒë√£ b·ªã x√≥a',
    deleted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
    deleted_by BIGINT NULL COMMENT 'Ng∆∞·ªùi x√≥a - merchant_users.id',
    
    -- Timestamps
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    -- Foreign Keys
    CONSTRAINT fk_invoice_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE RESTRICT,
    CONSTRAINT fk_invoice_provider FOREIGN KEY (provider_id) 
        REFERENCES service_providers(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_config FOREIGN KEY (provider_config_id) 
        REFERENCES merchant_provider_configs(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_template FOREIGN KEY (invoice_template_id) 
        REFERENCES invoice_templates(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_customer FOREIGN KEY (customer_id) 
        REFERENCES customers(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_replaced_by FOREIGN KEY (replaced_by_invoice_id) 
        REFERENCES invoices_metadata(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_deleted_by FOREIGN KEY (deleted_by) 
        REFERENCES merchant_users(id) ON DELETE SET NULL,
    
    -- Indexes for performance
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_provider_id (provider_id),
    INDEX idx_invoice_number (invoice_number),
    INDEX idx_symbol_code (symbol_code),
    INDEX idx_buyer_tax_code (buyer_tax_code),
    INDEX idx_status (status),
    INDEX idx_issue_date (issue_date),
    INDEX idx_created_at (created_at),
    INDEX idx_client_request_id (client_request_id),
    INDEX idx_merchant_status (merchant_id, status),
    INDEX idx_merchant_created (merchant_id, created_at),
    INDEX idx_cqt_code (cqt_code),
    INDEX idx_invoice_template (invoice_template_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Metadata h√≥a ƒë∆°n - ph·ª•c v·ª• tra c·ª©u nhanh';


-- 9. Invoice Items - Chi ti·∫øt h√†ng h√≥a/d·ªãch v·ª• trong h√≥a ƒë∆°n
CREATE TABLE invoice_items (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    invoice_id BIGINT NOT NULL COMMENT 'ID h√≥a ƒë∆°n cha',
    line_number INT NOT NULL DEFAULT 1 COMMENT 'S·ªë th·ª© t·ª± d√≤ng',
    product_name VARCHAR(500) NOT NULL COMMENT 'T√™n s·∫£n ph·∫©m/d·ªãch v·ª•',
    product_code VARCHAR(100) NULL COMMENT 'M√£ s·∫£n ph·∫©m theo danh m·ª•c',
    unit_name VARCHAR(50) NOT NULL COMMENT 'ƒê∆°n v·ªã t√≠nh: c√°i, kg, chi·∫øc...',
    quantity DECIMAL(18,4) NOT NULL DEFAULT 0 COMMENT 'S·ªë l∆∞·ª£ng',
    unit_price DECIMAL(18,4) NOT NULL DEFAULT 0 COMMENT 'ƒê∆°n gi√° tr∆∞·ªõc thu·∫ø',
    amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Th√†nh ti·ªÅn = quantity * unit_price',
    discount_rate DECIMAL(5,2) NOT NULL DEFAULT 0 COMMENT 'T·ª∑ l·ªá chi·∫øt kh·∫•u (%)',
    discount_amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Ti·ªÅn chi·∫øt kh·∫•u',
    tax_rate DECIMAL(5,2) NOT NULL DEFAULT 0 COMMENT 'Thu·∫ø su·∫•t GTGT (%)',
    tax_amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Ti·ªÅn thu·∫ø GTGT',
    total_amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Th√†nh ti·ªÅn bao g·ªìm thu·∫ø',
    description TEXT NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt s·∫£n ph·∫©m',
    tax_category_code VARCHAR(20) NULL COMMENT 'M√£ nh√≥m h√†ng h√≥a theo thu·∫ø',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    
    CONSTRAINT fk_invoice_item_invoice FOREIGN KEY (invoice_id) 
        REFERENCES invoices_metadata(id) ON DELETE CASCADE,
    
    INDEX idx_item_invoice (invoice_id),
    INDEX idx_line_number (line_number)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Chi ti·∫øt t·ª´ng d√≤ng h√†ng h√≥a/d·ªãch v·ª• trong h√≥a ƒë∆°n';


-- 10. Invoice Payloads - L∆∞u tr·ªØ n·ªôi dung XML/JSON g·ªëc (Thay th·∫ø MongoDB)
CREATE TABLE invoice_payloads (
    invoice_id BIGINT NOT NULL PRIMARY KEY COMMENT 'ID h√≥a ƒë∆°n - kh√≥a ch√≠nh v√† kh√≥a ngo·∫°i',
    raw_data JSON NULL COMMENT 'D·ªØ li·ªáu th√¥ request/response d·∫°ng JSON',
    xml_content LONGTEXT NULL COMMENT 'N·ªôi dung XML g·ªëc c·ªßa h√≥a ƒë∆°n (ph·ª•c v·ª• in ·∫•n)',
    json_content LONGTEXT NULL COMMENT 'N·ªôi dung JSON ƒë·∫ßy ƒë·ªß c·ªßa h√≥a ƒë∆°n',
    signed_xml LONGTEXT NULL COMMENT 'XML ƒë√£ k√Ω ƒëi·ªán t·ª≠ (ch·ªØ k√Ω s·ªë)',
    pdf_data LONGTEXT NULL COMMENT 'D·ªØ li·ªáu PDF ƒë√£ t·∫°o (base64)',
    extra_data JSON NULL COMMENT 'D·ªØ li·ªáu b·ªï sung kh√°c',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm l∆∞u',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    CONSTRAINT fk_invoice_payload_invoice FOREIGN KEY (invoice_id) 
        REFERENCES invoices_metadata(id) ON DELETE CASCADE,
    
    INDEX idx_payload_created (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u tr·ªØ n·ªôi dung XML/JSON g·ªëc h√≥a ƒë∆°n - thay th·∫ø MongoDB';


-- 11. Tax Authority Responses - Ph·∫£n h·ªìi t·ª´ C∆° quan Thu·∫ø
CREATE TABLE tax_authority_responses (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    invoice_id BIGINT NOT NULL COMMENT 'H√≥a ƒë∆°n li√™n quan',
    cqt_code VARCHAR(50) NOT NULL COMMENT 'M√£ C∆° quan Thu·∫ø',
    status_from_cqt VARCHAR(50) NOT NULL COMMENT 'Tr·∫°ng th√°i t·ª´ C∆° quan Thu·∫ø: APPROVED, REJECTED, PENDING',
    processing_code VARCHAR(100) NULL COMMENT 'M√£ x·ª≠ l√Ω t·ª´ C∆° quan Thu·∫ø',
    signature_data TEXT NULL COMMENT 'D·ªØ li·ªáu ch·ªØ k√Ω t·ª´ C∆° quan Thu·∫ø',
    raw_response JSON NULL COMMENT 'Response th√¥ t·ª´ C∆° quan Thu·∫ø',
    error_code VARCHAR(50) NULL COMMENT 'M√£ l·ªói t·ª´ C∆° quan Thu·∫ø',
    error_message TEXT NULL COMMENT 'Th√¥ng b√°o l·ªói t·ª´ C∆° quan Thu·∫ø',
    received_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
    processed_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x·ª≠ l√Ω ho√†n t·∫•t',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o b·∫£n ghi',
    
    CONSTRAINT fk_tax_response_invoice FOREIGN KEY (invoice_id) 
        REFERENCES invoices_metadata(id) ON DELETE CASCADE,
    
    INDEX idx_tax_response_invoice (invoice_id),
    INDEX idx_cqt_code (cqt_code),
    INDEX idx_status_cqt (status_from_cqt),
    INDEX idx_received_at (received_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u v·∫øt t∆∞∆°ng t√°c v·ªõi C∆° quan Thu·∫ø';


-- 12. Audit Log - Nh·∫≠t k√Ω thao t√°c
CREATE TABLE audit_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NULL COMMENT 'Doanh nghi·ªáp li√™n quan',
    user_id BIGINT NULL COMMENT 'Ng∆∞·ªùi th·ª±c hi·ªán',
    entity_type VARCHAR(50) NOT NULL COMMENT 'Lo·∫°i entity: Invoice, Merchant, Config...',
    entity_id BIGINT NOT NULL COMMENT 'ID c·ªßa entity',
    action VARCHAR(50) NOT NULL COMMENT 'H√†nh ƒë·ªông: CREATE, UPDATE, DELETE, STATUS_CHANGE',
    old_value JSON NULL COMMENT 'Gi√° tr·ªã c≈©',
    new_value JSON NULL COMMENT 'Gi√° tr·ªã m·ªõi',
    ip_address VARCHAR(45) NULL COMMENT 'IP th·ª±c hi·ªán',
    user_agent VARCHAR(500) NULL COMMENT 'User Agent c·ªßa browser/client',
    request_id VARCHAR(100) NULL COMMENT 'ID request t·ª´ frontend',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm x·∫£y ra',
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_user_id (user_id),
    INDEX idx_entity (entity_type, entity_id),
    INDEX idx_action (action),
    INDEX idx_created_at (created_at),
    INDEX idx_merchant_entity (merchant_id, entity_type, entity_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Nh·∫≠t k√Ω thay ƒë·ªïi h·ªá th·ªëng';


-- 13. System Configuration - C·∫•u h√¨nh h·ªá th·ªëng
CREATE TABLE system_config (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    config_key VARCHAR(100) NOT NULL UNIQUE COMMENT 'Kh√≥a c·∫•u h√¨nh',
    config_value TEXT NOT NULL COMMENT 'Gi√° tr·ªã c·∫•u h√¨nh',
    config_type VARCHAR(20) NOT NULL DEFAULT 'STRING' COMMENT 'Lo·∫°i: STRING, NUMBER, BOOLEAN, JSON',
    description VARCHAR(500) NULL COMMENT 'M√¥ t·∫£ c·∫•u h√¨nh',
    is_encrypted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'C√≥ c·∫ßn m√£ h√≥a kh√¥ng',
    is_editable BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≥ th·ªÉ ch·ªânh s·ª≠a kh√¥ng',
    updated_by BIGINT NULL COMMENT 'Ng∆∞·ªùi c·∫≠p nh·∫≠t cu·ªëi',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    CONSTRAINT fk_config_updated_by FOREIGN KEY (updated_by) 
        REFERENCES merchant_users(id) ON DELETE SET NULL,
    
    INDEX idx_config_key (config_key)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='C·∫•u h√¨nh h·ªá th·ªëng';

-- Insert default configurations
INSERT INTO system_config (config_key, config_value, config_type, description) VALUES
('SYSTEM_NAME', 'EInvoiceHub', 'STRING', 'T√™n hi·ªÉn th·ªã c·ªßa h·ªá th·ªëng'),
('INVOICE_EXPIRY_DAYS', '30', 'NUMBER', 'S·ªë ng√†y h√≥a ƒë∆°n c√≥ hi·ªáu l·ª±c sau khi ph√°t h√†nh'),
('MAX_RETRY_ATTEMPTS', '3', 'NUMBER', 'S·ªë l·∫ßn th·ª≠ l·∫°i khi g·ªçi Provider th·∫•t b·∫°i'),
('RETRY_DELAY_MS', '1000', 'NUMBER', 'Th·ªùi gian ch·ªù gi·ªØa c√°c l·∫ßn th·ª≠ l·∫°i (milliseconds)'),
('SESSION_TIMEOUT_MINUTES', '60', 'NUMBER', 'Th·ªùi gian timeout c·ªßa session'),
('PASSWORD_MIN_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i t·ªëi thi·ªÉu c·ªßa m·∫≠t kh·∫©u'),
('API_KEY_PREFIX_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i prefix hi·ªÉn th·ªã c·ªßa API Key'),
('DEFAULT_CURRENCY', 'VND', 'STRING', 'ƒê∆°n v·ªã ti·ªÅn t·ªá m·∫∑c ƒë·ªãnh'),
('TAX_DEFAULT_RATE', '10.00', 'NUMBER', 'Thu·∫ø su·∫•t m·∫∑c ƒë·ªãnh (%)'),
('INVOICE_NUMBER_FORMAT', 'PREFIX + NUMBER + SUFFIX', 'STRING', 'C·∫•u tr√∫c s·ªë h√≥a ƒë∆°n m·∫∑c ƒë·ªãnh');

-- End of Migration V1
</file>

<file path="src/main/resources/db/migration/Initial_Schema_Ver03.sql">
-- EInvoiceHub Database Schema
-- Database: MariaDB   |   Character Set: utf8mb4_unicode_ci

--  I: NH√ìM DANH M·ª§C
-- 1. Invoice Types - Danh m·ª•c lo·∫°i h√≥a ƒë∆°n
CREATE TABLE invoice_types
(
    id         BIGINT AUTO_INCREMENT PRIMARY KEY,
    type_code  VARCHAR(10)  NOT NULL UNIQUE COMMENT 'M√£ lo·∫°i (VD: 01GTKT)',
    type_name  VARCHAR(100) NOT NULL COMMENT 'T√™n lo·∫°i h√≥a ƒë∆°n',
    is_active  BOOLEAN      NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP             DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2. Invoice Status - Tr·∫°ng th√°i h√≥a ƒë∆°n
CREATE TABLE invoice_status
(
    id          INT PRIMARY KEY,
    name        VARCHAR(100) NOT NULL UNIQUE COMMENT 'DRAFT, SUCCESS, FAILED...',
    description VARCHAR(255) NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 3. Payment Method - Ph∆∞∆°ng th·ª©c thanh to√°n
CREATE TABLE payment_method
(
    id          BIGINT AUTO_INCREMENT PRIMARY KEY,
    method_code VARCHAR(10)  NOT NULL UNIQUE COMMENT 'TM, CK...',
    method_name VARCHAR(100) NOT NULL,
    is_active   BOOLEAN      NOT NULL DEFAULT TRUE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- II: NH√ìM QU·∫¢N TR·ªä DOANH NGHI·ªÜP
-- 4. Merchants - Th√¥ng tin doanh nghi·ªáp
CREATE TABLE merchants
(
    id           BIGINT AUTO_INCREMENT PRIMARY KEY,
    tax_code     VARCHAR(20)  NOT NULL UNIQUE,
    company_name VARCHAR(255) NOT NULL,
    address      TEXT,
    email        VARCHAR(255),
    phone        VARCHAR(20),
    is_active    BOOLEAN   DEFAULT TRUE,
    created_at   TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 5. Merchant User - Ng∆∞·ªùi d√πng (UserAuthor)
CREATE TABLE merchant_user
(
    id            BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id   BIGINT       NOT NULL,
    username      VARCHAR(50)  NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    full_name     VARCHAR(100),
    role          VARCHAR(20) DEFAULT 'STAFF',
    CONSTRAINT fk_user_merchant FOREIGN KEY (merchant_id) REFERENCES merchants (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 6. Merchant Provider Configs - C·∫•u h√¨nh k·∫øt n·ªëi NCC (StoreProvider)
CREATE TABLE merchant_provider_configs
(
    id                         BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id                BIGINT       NOT NULL,
    provider_code              VARCHAR(20)  NOT NULL COMMENT 'VNPT, VIETTEL, BKAV...',
    username_service           VARCHAR(100) NOT NULL,
    password_service_encrypted VARCHAR(500) NOT NULL,
    is_active                  BOOLEAN DEFAULT TRUE,
    CONSTRAINT fk_config_merchant FOREIGN KEY (merchant_id) REFERENCES merchants (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- III.NH√ìM NGHI·ªÜP V·ª§ H√ìA ƒê∆†N
-- 7. Invoice Template - M·∫´u s·ªë & K√Ω hi·ªáu (StoreSerial)
CREATE TABLE invoice_template
(
    id             BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id    BIGINT      NOT NULL,
    config_id      BIGINT      NOT NULL COMMENT 'Li√™n k·∫øt StoreProvider',
    template_code  VARCHAR(20) NOT NULL COMMENT 'M·∫´u: 01GTKT0/001',
    symbol_code    VARCHAR(10) NOT NULL COMMENT 'K√Ω hi·ªáu: 1C23TML',
    current_number INT DEFAULT 0,
    CONSTRAINT fk_template_merchant FOREIGN KEY (merchant_id) REFERENCES merchants (id),
    CONSTRAINT fk_template_config FOREIGN KEY (config_id) REFERENCES merchant_provider_configs (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 8. Invoices Metadata - Th√¥ng tin t·ªïng qu√°t h√≥a ƒë∆°n
CREATE TABLE invoice_metadata
(
    id                BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id       BIGINT NOT NULL,
    user_author_id    BIGINT NOT NULL,
    template_id       BIGINT NOT NULL,
    type_id           BIGINT NOT NULL,
    status_id         INT    NOT NULL,
    payment_method_id BIGINT NOT NULL,

    invoice_number    VARCHAR(20),
    issue_date        DATE,

    -- Th√¥ng tin ng∆∞·ªùi mua (Flattened t·ª´ b·∫£ng Customers c≈©)
    buyer_name        VARCHAR(255),
    buyer_tax_code    VARCHAR(20),
    buyer_email       VARCHAR(255),
    buyer_address     TEXT,

    -- Ti·ªÅn b·∫°c
    subtotal_amount   DECIMAL(18, 2) DEFAULT 0,
    tax_amount        DECIMAL(18, 2) DEFAULT 0,
    total_amount      DECIMAL(18, 2) DEFAULT 0,

    created_at        TIMESTAMP      DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT fk_inv_merchant FOREIGN KEY (merchant_id) REFERENCES merchants (id),
    CONSTRAINT fk_inv_user FOREIGN KEY (user_author_id) REFERENCES merchant_user (id),
    CONSTRAINT fk_inv_template FOREIGN KEY (template_id) REFERENCES invoice_template (id),
    CONSTRAINT fk_inv_type FOREIGN KEY (type_id) REFERENCES invoice_types (id),
    CONSTRAINT fk_inv_status FOREIGN KEY (status_id) REFERENCES invoice_status (id),
    CONSTRAINT fk_inv_payment FOREIGN KEY (payment_method_id) REFERENCES payment_method (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 9. Invoice Items - Chi ti·∫øt d√≤ng h√†ng
CREATE TABLE invoice_items
(
    id           BIGINT AUTO_INCREMENT PRIMARY KEY,
    invoice_id   BIGINT       NOT NULL,
    line_number  INT          NOT NULL,
    product_name VARCHAR(500) NOT NULL,
    quantity     DECIMAL(18, 4) DEFAULT 0,
    unit_price   DECIMAL(18, 4) DEFAULT 0,
    tax_rate     DECIMAL(5, 2)  DEFAULT 0,
    total_amount DECIMAL(18, 2) DEFAULT 0,
    CONSTRAINT fk_items_invoice FOREIGN KEY (invoice_id) REFERENCES invoice_metadata (id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
</file>

<file path="src/main/resources/db/migration/Initial_Schema_Ver04.sql">
-- EInvoiceHub Database Schema - Version 3
-- Database: MariaDB   |   Character Set: utf8mb4_unicode_ci

--  I: C√ÅC B·∫¢NG DANH M·ª§C (CATALOG TABLES)
-- 1. Invoice Types - Danh m·ª•c lo·∫°i h√≥a ƒë∆°n chu·∫©n TCT
CREATE TABLE invoice_types (
       id BIGINT AUTO_INCREMENT PRIMARY KEY,
       type_code VARCHAR(10) NOT NULL UNIQUE COMMENT 'M√£ lo·∫°i h√≥a ƒë∆°n: 01GTKT, 02GTTT, 07KPTQ, 03KPTQ...',
       type_name VARCHAR(100) NOT NULL COMMENT 'T√™n lo·∫°i h√≥a ƒë∆°n',
       description TEXT NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
       is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
       display_order INT NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
       created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
       updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
       INDEX idx_type_code (type_code),
       INDEX idx_is_active (is_active),
       INDEX idx_display_order (display_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c lo·∫°i h√≥a ƒë∆°n theo quy ƒë·ªãnh TCT';

-- Insert danh m·ª•c lo·∫°i h√≥a ƒë∆°n chu·∫©n
INSERT INTO invoice_types (type_code, type_name, description, display_order) VALUES
     ('01GTKT', 'H√≥a ƒë∆°n gi√° tr·ªã gia tƒÉng', 'H√≥a ƒë∆°n GTGT m·∫´u 01GTKT theo Th√¥ng t∆∞ 78/2021/TT-BTC', 1),
     ('02GTTT', 'H√≥a ƒë∆°n b√°n h√†ng', 'H√≥a ƒë∆°n b√°n h√†ng m·∫´u 02GTTT theo Th√¥ng t∆∞ 78/2021/TT-BTC', 2),
     ('07KPTQ', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ ki·ªÉm so√°t', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ ki·ªÉm so√°t theo Ngh·ªã ƒë·ªãnh 123/2020/Nƒê-CP', 3),
     ('03KPTQ', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ kh√¥ng ki·ªÉm so√°t', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ kh√¥ng ki·ªÉm so√°t theo Ngh·ªã ƒë·ªãnh 123/2020/Nƒê-CP', 4),
     ('04HGDL', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ h√†ng kh√¥ng', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ cho d·ªãch v·ª• h√†ng kh√¥ng', 5),
     ('01TTDN', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ t√†i ch√≠nh', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ cho t·ªï ch·ª©c t√≠n d·ª•ng', 6);


-- 2. Payment Methods - Danh m·ª•c ph∆∞∆°ng th·ª©c thanh to√°n chu·∫©n
CREATE TABLE payment_methods (
     id BIGINT AUTO_INCREMENT PRIMARY KEY,
     method_code VARCHAR(10) NOT NULL UNIQUE COMMENT 'M√£ ph∆∞∆°ng th·ª©c: TM (Ti·ªÅn m·∫∑t), CK (Chuy·ªÉn kho·∫£n), TM/CK...',
     method_name VARCHAR(100) NOT NULL COMMENT 'T√™n ph∆∞∆°ng th·ª©c thanh to√°n',
     description TEXT NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
     is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
     display_order INT NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
     created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
     updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

     INDEX idx_method_code (method_code),
     INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c ph∆∞∆°ng th·ª©c thanh to√°n chu·∫©n';

-- Insert danh m·ª•c ph∆∞∆°ng th·ª©c thanh to√°n
INSERT INTO payment_methods (method_code, method_name, description, display_order) VALUES
   ('TM', 'Ti·ªÅn m·∫∑t', 'Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t tr·ª±c ti·∫øp', 1),
   ('CK', 'Chuy·ªÉn kho·∫£n', 'Thanh to√°n qua chuy·ªÉn kho·∫£n ng√¢n h√†ng', 2),
   ('TM/CK', 'Ti·ªÅn m·∫∑t/Chuy·ªÉn kho·∫£n', 'K·∫øt h·ª£p c·∫£ hai h√¨nh th·ª©c', 3),
   ('POS', 'Th·∫ª POS', 'Thanh to√°n qua m√°y POS', 4),
   ('V√ç ƒêI·ªÜN T·ª¨', 'V√≠ ƒëi·ªán t·ª≠', 'Thanh to√°n qua v√≠ ƒëi·ªán t·ª≠ (MoMo, ZaloPay, VNPay...)', 5),
   ('TH·∫∫', 'Th·∫ª ng√¢n h√†ng', 'Thanh to√°n b·∫±ng th·∫ª t√≠n d·ª•ng/ghi n·ª£', 6);


-- 3. VAT Rates - Danh m·ª•c thu·∫ø su·∫•t GTGT
CREATE TABLE vat_rates (
   id BIGINT AUTO_INCREMENT PRIMARY KEY,
   rate_code VARCHAR(10) NOT NULL UNIQUE COMMENT 'M√£ thu·∫ø su·∫•t: 0, 5, 8, 10, KCT, KKKNT',
   rate_percent DECIMAL(5,2) NOT NULL COMMENT 'Gi√° tr·ªã ph·∫ßn trƒÉm thu·∫ø su·∫•t',
   rate_name VARCHAR(100) NOT NULL COMMENT 'T√™n thu·∫ø su·∫•t',
   description TEXT NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
   is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
   display_order INT NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
   created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
   updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
   CONSTRAINT chk_vat_rate_percent CHECK (rate_percent >= 0),
   INDEX idx_rate_code (rate_code),
   INDEX idx_rate_percent (rate_percent),
   INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c thu·∫ø su·∫•t GTGT theo quy ƒë·ªãnh';

-- Insert danh m·ª•c thu·∫ø su·∫•t
INSERT INTO vat_rates (rate_code, rate_percent, rate_name, description, display_order) VALUES
   ('0', 0.00, 'Thu·∫ø su·∫•t 0%', '√Åp d·ª•ng cho h√†ng h√≥a, d·ªãch v·ª• xu·∫•t kh·∫©u', 1),
   ('5', 5.00, 'Thu·∫ø su·∫•t 5%', '√Åp d·ª•ng cho h√†ng h√≥a, d·ªãch v·ª• thi·∫øt y·∫øu', 2),
   ('8', 8.00, 'Thu·∫ø su·∫•t 8%', 'Gi·∫£m thu·∫ø theo Ngh·ªã quy·∫øt 43/2022/QH15', 3),
   ('10', 10.00, 'Thu·∫ø su·∫•t 10%', 'Thu·∫ø su·∫•t th√¥ng th∆∞·ªùng GTGT', 4),
   ('KCT', 0.00, 'Kh√¥ng ch·ªãu thu·∫ø', 'H√†ng h√≥a, d·ªãch v·ª• kh√¥ng ch·ªãu thu·∫ø GTGT', 5),
   ('KKKNT', 0.00, 'Kh√¥ng k√™ khai, t√≠nh n·ªôp', 'H√†ng h√≥a, d·ªãch v·ª• kh√¥ng k√™ khai n·ªôp thu·∫ø GTGT', 6);


-- II: C√ÅC B·∫¢NG NGHI·ªÜP V·ª§ CH√çNH (CORE BUSINESS TABLES)
-- 4. Merchants Table - Qu·∫£n l√Ω doanh nghi·ªáp (ƒê√£ c·∫≠p nh·∫≠t)
CREATE TABLE merchants (
   id BIGINT AUTO_INCREMENT PRIMARY KEY,
   tax_code VARCHAR(20) NOT NULL UNIQUE COMMENT 'M√£ s·ªë thu·∫ø - ƒë·ªãnh danh doanh nghi·ªáp',
   company_name VARCHAR(255) NOT NULL COMMENT 'T√™n c√¥ng ty ƒë·∫ßy ƒë·ªß',
   short_name VARCHAR(100) COMMENT 'T√™n vi·∫øt t·∫Øt',
   address TEXT COMMENT 'ƒê·ªãa ch·ªâ tr·ª• s·ªü ch√≠nh',
   district VARCHAR(100) COMMENT 'Qu·∫≠n/Huy·ªán',
   city VARCHAR(100) COMMENT 'T·ªânh/Th√†nh ph·ªë',
   email VARCHAR(255) COMMENT 'Email li√™n h·ªá',
   phone VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
   representative_name VARCHAR(100) COMMENT 'T√™n ng∆∞·ªùi ƒë·∫°i di·ªán',
   representative_title VARCHAR(100) COMMENT 'Ch·ª©c danh ng∆∞·ªùi ƒë·∫°i di·ªán',
   tax_authority_code VARCHAR(10) NULL COMMENT 'M√£ c∆° quan thu·∫ø qu·∫£n l√Ω (VD: 01GD, 02HT...)',

   subscription_plan ENUM('TRIAL', 'BASIC', 'PREMIUM') NOT NULL DEFAULT 'TRIAL' COMMENT 'G√≥i d·ªãch v·ª•: TRIAL, BASIC, PREMIUM',
   invoice_quota INT NOT NULL DEFAULT 100 COMMENT 'H·∫°n m·ª©c h√≥a ƒë∆°n/th√°ng',
   invoice_used INT NOT NULL DEFAULT 0 COMMENT 'H√≥a ƒë∆°n ƒë√£ s·ª≠ d·ª•ng trong th√°ng',
   is_using_hsm BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'S·ª≠ d·ª•ng HSM hay USB Token ƒë·ªÉ k√Ω ƒëi·ªán t·ª≠',
   status ENUM('ACTIVE', 'INACTIVE', 'SUSPENDED') NOT NULL DEFAULT 'ACTIVE' COMMENT 'Tr·∫°ng th√°i ho·∫°t ƒë·ªông',
   is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'C·ªù x√≥a m·ªÅm',
   deleted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
   created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
   updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

   INDEX idx_tax_code (tax_code),
   INDEX idx_status (status),
   INDEX idx_subscription_plan (subscription_plan),
   INDEX idx_created_at (created_at),
   INDEX idx_tax_authority (tax_authority_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω doanh nghi·ªáp s·ª≠ d·ª•ng d·ªãch v·ª• h√≥a ƒë∆°n ƒëi·ªán t·ª≠';


-- 5. Merchant Users - T√†i kho·∫£n ng∆∞·ªùi d√πng c·ªßa Merchant
CREATE TABLE merchant_users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Li√™n k·∫øt v·ªõi doanh nghi·ªáp',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT 'T√™n ƒëƒÉng nh·∫≠p',
    email VARCHAR(255) NOT NULL UNIQUE COMMENT 'Email ng∆∞·ªùi d√πng',
    password_hash VARCHAR(255) NOT NULL COMMENT 'M·∫≠t kh·∫©u ƒë√£ m√£ h√≥a BCrypt',
    full_name VARCHAR(100) COMMENT 'H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß',
    phone VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    avatar_url VARCHAR(500) COMMENT 'URL ·∫£nh ƒë·∫°i di·ªán',
    role ENUM('ADMIN', 'MANAGER', 'STAFF', 'VIEWER') NOT NULL DEFAULT 'STAFF' COMMENT 'Vai tr√≤ trong h·ªá th·ªëng: ADMIN, MANAGER, STAFF, VIEWER',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'K√≠ch ho·∫°t t√†i kho·∫£n',
    is_primary BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'T√†i kho·∫£n ch√≠nh c·ªßa doanh nghi·ªáp',
    last_login_at TIMESTAMP NULL COMMENT 'ƒêƒÉng nh·∫≠p l·∫ßn cu·ªëi',
    failed_login_attempts INT NOT NULL DEFAULT 0 COMMENT 'S·ªë l·∫ßn ƒëƒÉng nh·∫≠p sai',
    locked_until TIMESTAMP NULL COMMENT 'Kh√≥a t√†i kho·∫£n ƒë·∫øn th·ªùi ƒëi·ªÉm',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT fk_merchant_users_merchant FOREIGN KEY (merchant_id)
        REFERENCES merchants(id) ON DELETE CASCADE,

    INDEX idx_merchant_id (merchant_id),
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_role (role),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='T√†i kho·∫£n ng∆∞·ªùi d√πng thu·ªôc Merchant';

-- 6. API Credentials - B·∫£o m·∫≠t v√† t√≠ch h·ª£p API
CREATE TABLE api_credentials (
     id BIGINT AUTO_INCREMENT PRIMARY KEY,
     merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu credential',
     client_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'ID c√¥ng khai c·ªßa ·ª©ng d·ª•ng',
     api_key_hash VARCHAR(255) NOT NULL COMMENT 'Hash c·ªßa API Key (SHA-256)',
     api_key_prefix VARCHAR(8) NOT NULL COMMENT '8 k√Ω t·ª± ƒë·∫ßu c·ªßa API Key (hi·ªÉn th·ªã)',
     scopes TEXT NOT NULL COMMENT 'Quy·ªÅn h·∫°n - JSON array: [invoice.create, invoice.view]',
     ip_whitelist TEXT NULL COMMENT 'Danh s√°ch IP ƒë∆∞·ª£c ph√©p - JSON array ho·∫∑c NULL',
     rate_limit_per_hour INT NOT NULL DEFAULT 1000 COMMENT 'Gi·ªõi h·∫°n request/gi·ªù',
     rate_limit_per_day INT NOT NULL DEFAULT 10000 COMMENT 'Gi·ªõi h·∫°n request/ng√†y',
     request_count_hour INT NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong gi·ªù',
     request_count_day INT NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong ng√†y',
     request_count_resetted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm reset counter',
     expired_at TIMESTAMP NULL COMMENT 'Ng√†y h·∫øt h·∫°n - NULL l√† kh√¥ng gi·ªõi h·∫°n',
     last_used_at TIMESTAMP NULL COMMENT 'L·∫ßn s·ª≠ d·ª•ng cu·ªëi',
     is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
     created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
     updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

     CONSTRAINT fk_api_credentials_merchant FOREIGN KEY (merchant_id)
         REFERENCES merchants(id) ON DELETE CASCADE,

     INDEX idx_merchant_id (merchant_id),
     INDEX idx_client_id (client_id),
     INDEX idx_api_key_hash (api_key_hash),
     INDEX idx_expired_at (expired_at),
     INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Credentials cho API access';


-- 7. Service Providers - Nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠
CREATE TABLE service_providers (
       id BIGINT AUTO_INCREMENT PRIMARY KEY,
       provider_code VARCHAR(20) NOT NULL UNIQUE COMMENT 'M√£ provider: VNPT, VIETTEL, MISA, BKAV',
       provider_name VARCHAR(100) NOT NULL COMMENT 'T√™n ƒë·∫ßy ƒë·ªß nh√† cung c·∫•p',
       official_api_url VARCHAR(500) NOT NULL COMMENT 'URL API ch√≠nh th·ª©c',
       documentation_url VARCHAR(500) NULL COMMENT 'Link t√†i li·ªáu API',
       support_email VARCHAR(255) NULL COMMENT 'Email h·ªó tr·ª£',
       support_phone VARCHAR(20) NULL COMMENT 'Hotline h·ªó tr·ª£',
       is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'Provider c√≤n ho·∫°t ƒë·ªông',
       is_default BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh c·ªßa h·ªá th·ªëng',
       display_order INT NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
       extra_config_schema JSON NULL COMMENT 'Schema c·∫•u h√¨nh b·ªï sung cho provider',
       created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
       updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

       INDEX idx_provider_code (provider_code),
       INDEX idx_is_active (is_active),
       INDEX idx_is_default (is_default),
       INDEX idx_display_order (display_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠';

-- Insert default providers
INSERT INTO service_providers (provider_code, provider_name, official_api_url, is_active, is_default, display_order) VALUES
                                                                                                               ('BKAV', 'BKAV eInvoice', 'https://einvoice.bkav.com/api/v1', FALSE, FALSE, 4);
-- 8. Merchant Provider Configs - C·∫•u h√¨nh ri√™ng c·ªßa Merchant
CREATE TABLE merchant_provider_configs (
       id BIGINT AUTO_INCREMENT PRIMARY KEY,
       merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu',
       provider_id BIGINT NOT NULL COMMENT 'Nh√† cung c·∫•p ƒë∆∞·ª£c ch·ªçn',
       username_service VARCHAR(100) NOT NULL COMMENT 'T√†i kho·∫£n API do Provider c·∫•p',
       password_service_encrypted VARCHAR(500) NOT NULL COMMENT 'M·∫≠t kh·∫©u API - ƒë√£ m√£ h√≥a AES-256',
       certificate_serial VARCHAR(100) NULL COMMENT 'Serial number c·ªßa ch·ª©ng th∆∞ s·ªë',
       certificate_data TEXT NULL COMMENT 'Ch·ª©ng th∆∞ s·ªë - ƒë√£ m√£ h√≥a',
       certificate_chain LONGTEXT NULL COMMENT 'Chu·ªói ch·ª©ng th∆∞ s·ªë ƒë·∫ßy ƒë·ªß (Certificate Chain)',
       certificate_expired_at TIMESTAMP NULL COMMENT 'H·∫°n ch·ª©ng th∆∞ s·ªë',
       extra_config JSON NULL COMMENT 'C·∫•u h√¨nh b·ªï sung: pattern, serial, template',
       is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C·∫•u h√¨nh c√≤n hi·ªáu l·ª±c',
       is_default BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh c·ªßa Merchant',
       last_sync_at TIMESTAMP NULL COMMENT 'L·∫ßn ƒë·ªìng b·ªô cu·ªëi v·ªõi Provider',
       created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
       updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

       CONSTRAINT fk_mpc_merchant FOREIGN KEY (merchant_id)
           REFERENCES merchants(id) ON DELETE CASCADE,
       CONSTRAINT fk_mpc_provider FOREIGN KEY (provider_id)
           REFERENCES service_providers(id) ON DELETE RESTRICT,
       CONSTRAINT uq_merchant_provider UNIQUE (merchant_id, provider_id),

       INDEX idx_merchant_id (merchant_id),
       INDEX idx_provider_id (provider_id),
       INDEX idx_is_active (is_active),
       INDEX idx_is_default (is_default)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='C·∫•u h√¨nh k·∫øt n·ªëi Provider cho t·ª´ng Merchant';


-- 9. Invoice Registrations - Qu·∫£n l√Ω ƒëƒÉng k√Ω d·∫£i s·ªë h√≥a ƒë∆°n v·ªõi CQT
CREATE TABLE invoice_registrations (
   id BIGINT AUTO_INCREMENT PRIMARY KEY,
   registration_number VARCHAR(50) NULL COMMENT 'S·ªë quy·∫øt ƒë·ªãnh/ph√™ duy·ªát c·ªßa CQT',
   from_number BIGINT NOT NULL COMMENT 'S·ªë b·∫Øt ƒë·∫ßu c·ªßa d·∫£i (VD: 0000001)',
   to_number BIGINT NOT NULL COMMENT 'S·ªë k·∫øt th√∫c c·ªßa d·∫£i (VD: 0001000)',
   quantity BIGINT NOT NULL COMMENT 'S·ªë l∆∞·ª£ng h√≥a ƒë∆°n trong d·∫£i',
   current_number BIGINT NOT NULL DEFAULT 0 COMMENT 'S·ªë hi·ªán t·∫°i ƒë√£ s·ª≠ d·ª•ng',

   effective_date DATE NOT NULL COMMENT 'Ng√†y c√≥ hi·ªáu l·ª±c',
   expiration_date DATE NULL COMMENT 'Ng√†y h·∫øt h·∫°n (n·∫øu c√≥)',

   status ENUM('ACTIVE', 'EXHAUSTED', 'EXPIRED', 'CANCELLED') NOT NULL DEFAULT 'ACTIVE' COMMENT 'Tr·∫°ng th√°i ƒëƒÉng k√Ω',
   issued_by VARCHAR(255) NULL COMMENT 'Ng∆∞·ªùi ph√™ duy·ªát/CQT',
   note TEXT NULL COMMENT 'Ghi ch√∫ b·ªï sung',

   created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
   updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

   CONSTRAINT chk_registration_range CHECK (from_number <= to_number),
   CONSTRAINT chk_registration_quantity CHECK (quantity = (to_number - from_number + 1)),

   INDEX idx_registration_merchant (merchant_id),
   INDEX idx_registration_status (status),
   INDEX idx_registration_effective (effective_date),
   INDEX idx_registration_expiration (expiration_date),
   INDEX idx_registration_number (registration_number)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω l·ªãch s·ª≠ ƒëƒÉng k√Ω d·∫£i s·ªë h√≥a ƒë∆°n v·ªõi C∆° quan Thu·∫ø';


-- 10. Invoice Templates - Qu·∫£n l√Ω M·∫´u s·ªë & K√Ω hi·ªáu h√≥a ƒë∆°n
CREATE TABLE invoice_templates (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu m·∫´u',
    invoice_type_id BIGINT NULL COMMENT 'Lo·∫°i h√≥a ƒë∆°n (li√™n k·∫øt b·∫£ng invoice_types)',
    invoice_registration_id BIGINT NULL COMMENT 'ƒêƒÉng k√Ω d·∫£i s·ªë li√™n k·∫øt',

    template_code VARCHAR(20) NOT NULL COMMENT 'M·∫´u h√≥a ƒë∆°n: 01GTKT0/001, 02GTTT0/001...',
    symbol_code VARCHAR(10) NOT NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n: AA/22E, AB/23T...',
    current_number INT NOT NULL DEFAULT 0 COMMENT 'S·ªë hi·ªán h√≥a ƒë∆°n hi·ªán t·∫°i',
    prefix VARCHAR(20) NULL COMMENT 'Ti·ªÅn t·ªë s·ªë h√≥a ƒë∆°n',
    suffix VARCHAR(20) NULL COMMENT 'H·∫≠u t·ªë s·ªë h√≥a ƒë∆°n',
    min_number INT NOT NULL DEFAULT 1 COMMENT 'S·ªë b·∫Øt ƒë·∫ßu',
    max_number INT NOT NULL DEFAULT 99999 COMMENT 'S·ªë k·∫øt th√∫c',

    CONSTRAINT chk_symbol_code_format CHECK (symbol_code REGEXP '^[A-Z0-9]{2,7}/[0-9]{2,4}[A-Z0-9]*$'),

    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'M·∫´u c√≤n hi·ªáu l·ª±c',
    is_sequential BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'S·ª≠ d·ª•ng s·ªë th·ª© t·ª± li√™n t·ª•c',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT fk_invoice_template_merchant FOREIGN KEY (merchant_id)
        REFERENCES merchants(id) ON DELETE CASCADE,
    CONSTRAINT fk_invoice_template_type FOREIGN KEY (invoice_type_id)
        REFERENCES invoice_types(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_template_registration FOREIGN KEY (invoice_registration_id)
        REFERENCES invoice_registrations(id) ON DELETE SET NULL,
    CONSTRAINT uq_merchant_template_symbol UNIQUE (merchant_id, template_code, symbol_code),

    INDEX idx_template_merchant (merchant_id),
    INDEX idx_template_code (template_code),
    INDEX idx_symbol_code (symbol_code),
    INDEX idx_invoice_type (invoice_type_id),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω m·∫´u s·ªë v√† k√Ω hi·ªáu h√≥a ƒë∆°n theo quy ƒë·ªãnh';


-- 11. Customers - Danh m·ª•c kh√°ch h√†ng c·ªßa Merchant
CREATE TABLE customers (
   id BIGINT AUTO_INCREMENT PRIMARY KEY,
   merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu kh√°ch h√†ng',
   customer_code VARCHAR(50) NULL COMMENT 'M√£ kh√°ch h√†ng n·ªôi b·ªô',
   tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø kh√°ch h√†ng',
   name VARCHAR(255) NOT NULL COMMENT 'T√™n kh√°ch h√†ng/ƒë∆°n v·ªã',
   address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ',
   email VARCHAR(255) NULL COMMENT 'Email nh·∫≠n h√≥a ƒë∆°n',
   phone VARCHAR(20) NULL COMMENT 'ƒêi·ªán tho·∫°i',
   contact_person VARCHAR(100) NULL COMMENT 'Ng∆∞·ªùi li√™n h·ªá',
   bank_account VARCHAR(50) NULL COMMENT 'T√†i kho·∫£n ng√¢n h√†ng',
   bank_name VARCHAR(100) NULL COMMENT 'T√™n ng√¢n h√†ng',
   note TEXT NULL COMMENT 'Ghi ch√∫',
   is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n ho·∫°t ƒë·ªông',
   created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
   updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

   CONSTRAINT fk_customer_merchant FOREIGN KEY (merchant_id)
       REFERENCES merchants(id) ON DELETE CASCADE,

   INDEX idx_customer_merchant (merchant_id),
   INDEX idx_customer_code (customer_code),
   INDEX idx_tax_code (tax_code),
   INDEX idx_name (name),
   INDEX idx_email (email),
   INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c kh√°ch h√†ng th∆∞·ªùng xuy√™n c·ªßa Merchant';


-- 12. Invoices Metadata - Th√¥ng tin t√≥m t·∫Øt h√≥a ƒë∆°n
CREATE TABLE invoices_metadata (
   id BIGINT AUTO_INCREMENT PRIMARY KEY,
   provider_config_id BIGINT NULL COMMENT 'C·∫•u h√¨nh Provider ƒë∆∞·ª£c s·ª≠ d·ª•ng',
   invoice_template_id BIGINT NULL COMMENT 'M·∫´u h√≥a ƒë∆°n ƒë∆∞·ª£c s·ª≠ d·ª•ng',
   client_request_id VARCHAR(100) NULL COMMENT 'ID request t·ª´ Merchant',

   invoice_number VARCHAR(20) NULL COMMENT 'S·ªë h√≥a ƒë∆°n t·ª´ Provider tr·∫£ v·ªÅ',
   symbol_code VARCHAR(10) NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n (VD: 1C23TML)',
   template_code VARCHAR(20) NULL COMMENT 'M·∫´u h√≥a ƒë∆°n: 01GTKT0/001, 02GTTT0/001...',
   is_summary_invoice BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'H√≥a ƒë∆°n t·ªïng h·ª£p hay h√≥a ƒë∆°n chi ti·∫øt',

   cqt_code VARCHAR(50) NULL COMMENT 'M√£ C∆° quan Thu·∫ø qu·∫£n l√Ω',

   payment_method VARCHAR(10) NULL COMMENT 'M√£ ph∆∞∆°ng th·ª©c thanh to√°n (li√™n k·∫øt b·∫£ng payment_methods)',
   lookup_code VARCHAR(50) NULL COMMENT 'M√£ tra c·ª©u h√≥a ƒë∆°n cho kh√°ch l·∫ª (pattern: S·ªë h√≥a ƒë∆°n + M√£ tra c·ª©u)',
   issuance_method ENUM('STANDARD', 'POS') NOT NULL DEFAULT 'STANDARD' COMMENT 'Ph∆∞∆°ng th·ª©c ph√°t h√†nh: STANDARD (th√¥ng th∆∞·ªùng), POS (m√°y t√≠nh ti·ªÅn)',

   seller_name VARCHAR(255) NULL COMMENT 'T√™n ng∆∞·ªùi b√°n',
   seller_tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi b√°n',
   seller_address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi b√°n',

   buyer_name VARCHAR(255) NULL COMMENT 'T√™n ng∆∞·ªùi mua',
   buyer_tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi mua',
   buyer_email VARCHAR(255) NULL COMMENT 'Email ng∆∞·ªùi mua (nh·∫≠n h√≥a ƒë∆°n)',
   buyer_phone VARCHAR(20) NULL COMMENT 'ƒêi·ªán tho·∫°i ng∆∞·ªùi mua',
   buyer_address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi mua',
   customer_id BIGINT NULL COMMENT 'Li√™n k·∫øt v·ªõi b·∫£ng customers',

   subtotal_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø',
   tax_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ø',
   discount_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng chi·∫øt kh·∫•u',
   total_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thanh to√°n',
   currency_code VARCHAR(3) NOT NULL DEFAULT 'VND' COMMENT 'ƒê∆°n v·ªã ti·ªÅn t·ªá',
   exchange_rate DECIMAL(10,4) NOT NULL DEFAULT 1.0000 COMMENT 'T·ª∑ gi√° v·ªõi VND',

   issue_date DATE NULL COMMENT 'Ng√†y l·∫≠p h√≥a ƒë∆°n',
   accounting_date DATE NULL COMMENT 'Ng√†y h·∫°ch to√°n',
   due_date DATE NULL COMMENT 'Ng√†y thanh to√°n ƒë·∫øn h·∫°n',

   status ENUM('DRAFT', 'PENDING', 'SIGNING', 'SENT_TO_PROVIDER', 'SUCCESS', 'FAILED', 'CANCELLED', 'REPLACED') NOT NULL DEFAULT 'DRAFT' COMMENT 'Tr·∫°ng th√°i x·ª≠ l√Ω h√≥a ƒë∆°n',
   status_message TEXT NULL COMMENT 'Th√¥ng b√°o tr·∫°ng th√°i chi ti·∫øt',
   cancellation_reason VARCHAR(500) NULL COMMENT 'L√Ω do h·ªßy/thay th·∫ø',
   replaced_by_invoice_id BIGINT NULL COMMENT 'ID h√≥a ƒë∆°n thay th·∫ø',
   adjustment_type ENUM('ADJUSTMENT', 'REPLACEMENT', 'CANCELLATION') NULL COMMENT 'Lo·∫°i ƒëi·ªÅu ch·ªânh/thay th·∫ø/h·ªßy',

   signed_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm k√Ω ƒëi·ªán t·ª≠',
   sent_to_provider_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i sang Provider',
   received_from_provider_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
   delivered_to_buyer_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i h√≥a ƒë∆°n cho ng∆∞·ªùi mua',

   provider_transaction_code VARCHAR(100) NULL COMMENT 'M√£ giao d·ªãch t·ª´ Provider',
   provider_error_code VARCHAR(50) NULL COMMENT 'M√£ l·ªói t·ª´ Provider',
   provider_error_message TEXT NULL COMMENT 'Chi ti·∫øt l·ªói t·ª´ Provider',

   is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'H√≥a ƒë∆°n ƒë√£ b·ªã x√≥a',
   deleted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
   deleted_by BIGINT NULL COMMENT 'Ng∆∞·ªùi x√≥a - merchant_users.id',

   created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
   updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

   CONSTRAINT fk_invoice_template FOREIGN KEY (invoice_template_id)
       REFERENCES invoice_templates(id) ON DELETE SET NULL,
   CONSTRAINT fk_invoice_config FOREIGN KEY (provider_config_id)
       REFERENCES merchant_provider_configs(id) ON DELETE SET NULL,
   CONSTRAINT fk_invoice_customer FOREIGN KEY (customer_id)
       REFERENCES customers(id) ON DELETE SET NULL,
   CONSTRAINT fk_invoice_payment_method FOREIGN KEY (payment_method)
       REFERENCES payment_methods(method_code) ON DELETE SET NULL,
   CONSTRAINT fk_invoice_replaced_by FOREIGN KEY (replaced_by_invoice_id)
       REFERENCES invoices_metadata(id) ON DELETE SET NULL,
   CONSTRAINT fk_invoice_deleted_by FOREIGN KEY (deleted_by)
       REFERENCES merchant_users(id) ON DELETE SET NULL,
   CONSTRAINT uq_invoice_lookup_code UNIQUE (lookup_code) COMMENT 'M√£ tra c·ª©u ph·∫£i duy nh·∫•t',

   INDEX idx_merchant_id (merchant_id),
   INDEX idx_provider_id (provider_id),
   INDEX idx_invoice_number (invoice_number),
   INDEX idx_symbol_code (symbol_code),
   INDEX idx_buyer_tax_code (buyer_tax_code),
   INDEX idx_status (status),
   INDEX idx_issue_date (issue_date),
   INDEX idx_created_at (created_at),
   INDEX idx_client_request_id (client_request_id),
   INDEX idx_merchant_status (merchant_id, status),
   INDEX idx_merchant_created (merchant_id, created_at),
   INDEX idx_cqt_code (cqt_code),
   INDEX idx_invoice_template (invoice_template_id),
   INDEX idx_lookup_code (lookup_code),
   INDEX idx_payment_method (payment_method)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Metadata h√≥a ƒë∆°n - ph·ª•c v·ª• tra c·ª©u nhanh';


-- 13. Invoice Items - Chi ti·∫øt h√†ng h√≥a/d·ªãch v·ª• trong h√≥a ƒë∆°n (ƒê√£ c·∫≠p nh·∫≠t)
CREATE TABLE invoice_items (
   id BIGINT AUTO_INCREMENT PRIMARY KEY,
   invoice_id BIGINT NOT NULL COMMENT 'ID h√≥a ƒë∆°n cha',
   line_number INT NOT NULL DEFAULT 1 COMMENT 'S·ªë th·ª© t·ª± d√≤ng',
   product_name VARCHAR(500) NOT NULL COMMENT 'T√™n s·∫£n ph·∫©m/d·ªãch v·ª•',
   product_code VARCHAR(100) NULL COMMENT 'M√£ s·∫£n ph·∫©m theo danh m·ª•c',
   unit_name VARCHAR(50) NOT NULL COMMENT 'ƒê∆°n v·ªã t√≠nh: c√°i, kg, chi·∫øc...',
   quantity DECIMAL(18,4) NOT NULL DEFAULT 0 COMMENT 'S·ªë l∆∞·ª£ng',
   unit_price DECIMAL(18,4) NOT NULL DEFAULT 0 COMMENT 'ƒê∆°n gi√° tr∆∞·ªõc thu·∫ø',
   amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Th√†nh ti·ªÅn = quantity * unit_price',
   discount_rate DECIMAL(5,2) NOT NULL DEFAULT 0 COMMENT 'T·ª∑ l·ªá chi·∫øt kh·∫•u (%)',
   discount_amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Ti·ªÅn chi·∫øt kh·∫•u',
   tax_rate DECIMAL(5,2) NOT NULL DEFAULT 0 COMMENT 'Thu·∫ø su·∫•t GTGT (%)',
   tax_amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Ti·ªÅn thu·∫ø GTGT',
   total_amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Th√†nh ti·ªÅn bao g·ªìm thu·∫ø',
   description TEXT NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt s·∫£n ph·∫©m',

   tax_category_code VARCHAR(20) NULL COMMENT 'M√£ nh√≥m h√†ng h√≥a theo thu·∫ø',
   vat_rate_id BIGINT NULL COMMENT 'Li√™n k·∫øt v·ªõi danh m·ª•c thu·∫ø su·∫•t (vat_rates)',
   is_promotion BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'H√†ng khuy·∫øn m√£i (TRUE) hay h√†ng th∆∞·ªùng (FALSE)',

   created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',

   CONSTRAINT fk_invoice_item_invoice FOREIGN KEY (invoice_id)
       REFERENCES invoices_metadata(id) ON DELETE CASCADE,
   CONSTRAINT fk_invoice_item_vat_rate FOREIGN KEY (vat_rate_id)
       REFERENCES vat_rates(id) ON DELETE SET NULL,

   INDEX idx_item_invoice (invoice_id),
   INDEX idx_line_number (line_number),
   INDEX idx_vat_rate (vat_rate_id),
   INDEX idx_is_promotion (is_promotion)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Chi ti·∫øt t·ª´ng d√≤ng h√†ng h√≥a/d·ªãch v·ª• trong h√≥a ƒë∆°n';


-- 14. Invoice Tax Breakdowns - Ph√¢n r√£ thu·∫ø su·∫•t tr√™n t·ª´ng h√≥a ƒë∆°n
CREATE TABLE invoice_tax_breakdowns (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    invoice_id BIGINT NOT NULL COMMENT 'ID h√≥a ƒë∆°n cha',
    vat_rate_id BIGINT NOT NULL COMMENT 'Li√™n k·∫øt v·ªõi danh m·ª•c thu·∫ø su·∫•t',
    vat_rate_code VARCHAR(10) NOT NULL COMMENT 'M√£ thu·∫ø su·∫•t (0, 5, 8, 10, KCT, KKKNT)',
    vat_rate_percent DECIMAL(5,2) NOT NULL COMMENT 'Gi√° tr·ªã ph·∫ßn trƒÉm thu·∫ø su·∫•t',

    subtotal_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø v·ªõi thu·∫ø su·∫•t n√†y',
    discount_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn chi·∫øt kh·∫•u',
    taxable_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn ch·ªãu thu·∫ø (sau chi·∫øt kh·∫•u)',
    tax_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ø GTGT',
    total_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn bao g·ªìm thu·∫ø',

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',

    CONSTRAINT fk_tax_breakdown_invoice FOREIGN KEY (invoice_id)
        REFERENCES invoices_metadata(id) ON DELETE CASCADE,
    CONSTRAINT fk_tax_breakdown_vat_rate FOREIGN KEY (vat_rate_id)
        REFERENCES vat_rates(id) ON DELETE RESTRICT,
    CONSTRAINT uq_invoice_vat_rate UNIQUE (invoice_id, vat_rate_id),

    INDEX idx_breakdown_invoice (invoice_id),
    INDEX idx_breakdown_vat_rate (vat_rate_id),
    INDEX idx_vat_rate_code (vat_rate_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u t·ªïng ti·ªÅn t√≥m t·∫Øt theo t·ª´ng lo·∫°i thu·∫ø su·∫•t ph·ª•c v·ª• in ·∫•n h√≥a ƒë∆°n';


CREATE TABLE invoice_adjustments (
     id BIGINT AUTO_INCREMENT PRIMARY KEY,
     original_invoice_id BIGINT NOT NULL COMMENT 'H√≥a ƒë∆°n g·ªëc b·ªã ƒëi·ªÅu ch·ªânh/thay th·∫ø/h·ªßy',
     adjustment_type ENUM('ADJUSTMENT', 'REPLACEMENT', 'CANCELLATION') NOT NULL COMMENT 'Lo·∫°i ƒëi·ªÅu ch·ªânh',

     agreement_number VARCHAR(50) NULL COMMENT 'S·ªë bi√™n b·∫£n th·ªèa thu·∫≠n',
     agreement_date DATE NULL COMMENT 'Ng√†y l·∫≠p bi√™n b·∫£n',
     agreement_content TEXT NULL COMMENT 'N·ªôi dung bi√™n b·∫£n th·ªèa thu·∫≠n',
     signers TEXT NULL COMMENT 'Ng∆∞·ªùi k√Ω bi√™n b·∫£n (JSON array)',

     reason_code VARCHAR(50) NULL COMMENT 'M√£ l√Ω do (theo quy ƒë·ªãnh)',
     reason_description VARCHAR(500) NULL COMMENT 'M√¥ t·∫£ l√Ω do chi ti·∫øt',

     old_subtotal_amount DECIMAL(18,2) NULL COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø c≈©',
     old_tax_amount DECIMAL(18,2) NULL COMMENT 'Ti·ªÅn thu·∫ø c≈©',
     old_total_amount DECIMAL(18,2) NULL COMMENT 'T·ªïng ti·ªÅn c≈©',
     new_subtotal_amount DECIMAL(18,2) NULL COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø m·ªõi',
     new_tax_amount DECIMAL(18,2) NULL COMMENT 'Ti·ªÅn thu·∫ø m·ªõi',
     new_total_amount DECIMAL(18,2) NULL COMMENT 'T·ªïng ti·ªÅn m·ªõi',
     difference_amount DECIMAL(18,2) NULL COMMENT 'Ch√™nh l·ªách ti·ªÅn',

     status ENUM('PENDING', 'APPROVED', 'REJECTED', 'CANCELLED') NOT NULL DEFAULT 'PENDING' COMMENT 'Tr·∫°ng th√°i duy·ªát',
     approved_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm duy·ªát',

    -- Th√¥ng tin g·ª≠i CQT
     submitted_to_cqt BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'ƒê√£ g·ª≠i C∆° quan Thu·∫ø',
     cqt_response_code VARCHAR(50) NULL COMMENT 'M√£ ph·∫£n h·ªìi t·ª´ CQT',
     cqt_response_message TEXT NULL COMMENT 'N·ªôi dung ph·∫£n h·ªìi t·ª´ CQT',

     created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
     updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

     CONSTRAINT fk_adjustment_original_invoice FOREIGN KEY (original_invoice_id)
         REFERENCES invoices_metadata(id) ON DELETE RESTRICT,


     INDEX idx_adjustment_original (original_invoice_id),
     INDEX idx_adjustment_type (adjustment_type),
     INDEX idx_adjustment_status (status),
     INDEX idx_agreement_date (agreement_date),
     INDEX idx_submitted_cqt (submitted_to_cqt)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u th√¥ng tin bi√™n b·∫£n th·ªèa thu·∫≠n cho h√≥a ƒë∆°n ƒëi·ªÅu ch·ªânh/thay th·∫ø/h·ªßy';


CREATE TABLE invoice_sync_queue (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    invoice_id BIGINT NOT NULL COMMENT 'ID h√≥a ƒë∆°n c·∫ßn ƒë·ªìng b·ªô',
    sync_type ENUM('SEND_TO_PROVIDER', 'SEND_TO_CQT', 'CANCEL_INVOICE', 'REPLACE_INVOICE') NOT NULL COMMENT 'Lo·∫°i thao t√°c ƒë·ªìng b·ªô',
    priority INT NOT NULL DEFAULT 5 COMMENT 'ƒê·ªô ∆∞u ti√™n (1=cao nh·∫•t, 10=th·∫•p nh·∫•t)',

    status ENUM('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED', 'RETRYING') NOT NULL DEFAULT 'PENDING' COMMENT 'Tr·∫°ng th√°i x·ª≠ l√Ω',
    attempt_count INT NOT NULL DEFAULT 0 COMMENT 'S·ªë l·∫ßn th·ª≠',
    max_attempts INT NOT NULL DEFAULT 3 COMMENT 'S·ªë l·∫ßn th·ª≠ t·ªëi ƒëa',
    last_attempt_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm th·ª≠ l·∫ßn cu·ªëi',
    next_retry_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm th·ª≠ ti·∫øp theo',

    request_data JSON NULL COMMENT 'D·ªØ li·ªáu request g·ª≠i ƒëi',
    response_data JSON NULL COMMENT 'D·ªØ li·ªáu response nh·∫≠n v·ªÅ',
    error_code VARCHAR(50) NULL COMMENT 'M√£ l·ªói',
    error_message TEXT NULL COMMENT 'Chi ti·∫øt l·ªói',

    processed_by VARCHAR(100) NULL COMMENT 'Worker x·ª≠ l√Ω',
    processing_started_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu x·ª≠ l√Ω',
    processing_completed_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm ho√†n th√†nh',

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT fk_sync_queue_invoice FOREIGN KEY (invoice_id)
        REFERENCES invoices_metadata(id) ON DELETE CASCADE,

    CONSTRAINT chk_sync_attempt_count CHECK (attempt_count <= max_attempts),

    INDEX idx_sync_queue_status (status),
    INDEX idx_sync_queue_invoice (invoice_id),
    INDEX idx_sync_queue_merchant (merchant_id),
    INDEX idx_sync_queue_priority (priority),
    INDEX idx_sync_queue_next_retry (next_retry_at),
    INDEX idx_sync_queue_created (created_at),
    INDEX idx_sync_queue_status_priority (status, priority, next_retry_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='H√†ng ƒë·ª£i g·ª≠i h√≥a ƒë∆°n sang Provider/CQT v·ªõi c∆° ch·∫ø Retry';


-- 17. Invoice Payloads - L∆∞u tr·ªØ n·ªôi dung XML/JSON g·ªëc
CREATE TABLE invoice_payloads (
      invoice_id BIGINT NOT NULL PRIMARY KEY COMMENT 'ID h√≥a ƒë∆°n - kh√≥a ch√≠nh v√† kh√≥a ngo·∫°i',
      raw_data JSON NULL COMMENT 'D·ªØ li·ªáu th√¥ request/response d·∫°ng JSON',
      xml_content LONGTEXT NULL COMMENT 'N·ªôi dung XML g·ªëc c·ªßa h√≥a ƒë∆°n (ph·ª•c v·ª• in ·∫•n)',
      json_content LONGTEXT NULL COMMENT 'N·ªôi dung JSON ƒë·∫ßy ƒë·ªß c·ªßa h√≥a ƒë∆°n',
      signed_xml LONGTEXT NULL COMMENT 'XML ƒë√£ k√Ω ƒëi·ªán t·ª≠ (ch·ªØ k√Ω s·ªë)',
      pdf_data LONGTEXT NULL COMMENT 'D·ªØ li·ªáu PDF ƒë√£ t·∫°o (base64)',
      extra_data JSON NULL COMMENT 'D·ªØ li·ªáu b·ªï sung kh√°c',
      created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm l∆∞u',
      updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

      CONSTRAINT fk_invoice_payload_invoice FOREIGN KEY (invoice_id)
          REFERENCES invoices_metadata(id) ON DELETE CASCADE,

      INDEX idx_payload_created (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u tr·ªØ n·ªôi dung XML/JSON g·ªëc h√≥a ƒë∆°n';


-- 18. Tax Authority Responses - Ph·∫£n h·ªìi t·ª´ C∆° quan Thu·∫ø
CREATE TABLE tax_authority_responses (
     id BIGINT AUTO_INCREMENT PRIMARY KEY,
     invoice_id BIGINT NOT NULL COMMENT 'H√≥a ƒë∆°n li√™n quan',
     cqt_code VARCHAR(50) NOT NULL COMMENT 'M√£ C∆° quan Thu·∫ø',
     status_from_cqt VARCHAR(50) NOT NULL COMMENT 'Tr·∫°ng th√°i t·ª´ C∆° quan Thu·∫ø: APPROVED, REJECTED, PENDING',
     processing_code VARCHAR(100) NULL COMMENT 'M√£ x·ª≠ l√Ω t·ª´ C∆° quan Thu·∫ø',
     signature_data TEXT NULL COMMENT 'D·ªØ li·ªáu ch·ªØ k√Ω t·ª´ C∆° quan Thu·∫ø',
     raw_response JSON NULL COMMENT 'Response th√¥ t·ª´ C∆° quan Thu·∫ø',
     error_code VARCHAR(50) NULL COMMENT 'M√£ l·ªói t·ª´ C∆° quan Thu·∫ø',
     error_message TEXT NULL COMMENT 'Th√¥ng b√°o l·ªói t·ª´ C∆° quan Thu·∫ø',
     received_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
     processed_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x·ª≠ l√Ω ho√†n t·∫•t',
     created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o b·∫£n ghi',

     CONSTRAINT fk_tax_response_invoice FOREIGN KEY (invoice_id)
         REFERENCES invoices_metadata(id) ON DELETE CASCADE,

     INDEX idx_tax_response_invoice (invoice_id),
     INDEX idx_cqt_code (cqt_code),
     INDEX idx_status_cqt (status_from_cqt),
     INDEX idx_received_at (received_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u v·∫øt t∆∞∆°ng t√°c v·ªõi C∆° quan Thu·∫ø';


-- 19. Audit Log - Nh·∫≠t k√Ω thao t√°c
CREATE TABLE audit_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchantuser_id BIGINT NULL COMMENT 'Doanh nghi·ªáp li√™n quan',
    user_id BIGINT NULL COMMENT 'Ng∆∞·ªùi th·ª±c hi·ªán',
    entity_type VARCHAR(50) NOT NULL COMMENT 'Lo·∫°i entity: Invoice, Merchant, Config...',
    entity_id BIGINT NOT NULL COMMENT 'ID c·ªßa entity',
    action VARCHAR(50) NOT NULL COMMENT 'H√†nh ƒë·ªông: CREATE, UPDATE, DELETE, STATUS_CHANGE',
    old_value JSON NULL COMMENT 'Gi√° tr·ªã c≈©',
    new_value JSON NULL COMMENT 'Gi√° tr·ªã m·ªõi',
    ip_address VARCHAR(45) NULL COMMENT 'IP th·ª±c hi·ªán',
    user_agent VARCHAR(500) NULL COMMENT 'User Agent c·ªßa browser/client',
    request_id VARCHAR(100) NULL COMMENT 'ID request t·ª´ frontend',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm x·∫£y ra',

    CONSTRAINT fk_merchant_user FOREIGN KEY (merchantuser_id)
        REFERENCES merchant_users(id) ON DELETE CASCADE,

    INDEX idx_merchant_id (merchant_id),
    INDEX idx_user_id (user_id),
    INDEX idx_entity (entity_type, entity_id),
    INDEX idx_action (action),
    INDEX idx_created_at (created_at),
    INDEX idx_merchant_entity (merchant_id, entity_type, entity_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Nh·∫≠t k√Ω thay ƒë·ªïi h·ªá th·ªëng';


-- 20. System Configuration - C·∫•u h√¨nh h·ªá th·ªëng
CREATE TABLE system_config (
   id BIGINT AUTO_INCREMENT PRIMARY KEY,
   config_key VARCHAR(100) NOT NULL UNIQUE COMMENT 'Kh√≥a c·∫•u h√¨nh',
   config_value TEXT NOT NULL COMMENT 'Gi√° tr·ªã c·∫•u h√¨nh',
   config_type VARCHAR(20) NOT NULL DEFAULT 'STRING' COMMENT 'Lo·∫°i: STRING, NUMBER, BOOLEAN, JSON',
   description VARCHAR(500) NULL COMMENT 'M√¥ t·∫£ c·∫•u h√¨nh',
   is_encrypted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'C√≥ c·∫ßn m√£ h√≥a kh√¥ng',
   is_editable BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≥ th·ªÉ ch·ªânh s·ª≠a kh√¥ng',
   updated_by BIGINT NULL COMMENT 'Ng∆∞·ªùi c·∫≠p nh·∫≠t cu·ªëi',
   updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

   CONSTRAINT fk_config_updated_by FOREIGN KEY (updated_by)
       REFERENCES merchant_users(id) ON DELETE SET NULL,

   INDEX idx_config_key (config_key)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='C·∫•u h√¨nh h·ªá th·ªëng';

-- Insert default configurations
INSERT INTO system_config (config_key, config_value, config_type, description) VALUES
('SYSTEM_NAME', 'EInvoiceHub', 'STRING', 'T√™n hi·ªÉn th·ªã c·ªßa h·ªá th·ªëng'),
('INVOICE_EXPIRY_DAYS', '30', 'NUMBER', 'S·ªë ng√†y h√≥a ƒë∆°n c√≥ hi·ªáu l·ª±c sau khi ph√°t h√†nh'),
('MAX_RETRY_ATTEMPTS', '3', 'NUMBER', 'S·ªë l·∫ßn th·ª≠ l·∫°i khi g·ªçi Provider th·∫•t b·∫°i'),
('RETRY_DELAY_MS', '1000', 'NUMBER', 'Th·ªùi gian ch·ªù gi·ªØa c√°c l·∫ßn th·ª≠ l·∫°i (milliseconds)'),
('SESSION_TIMEOUT_MINUTES', '60', 'NUMBER', 'Th·ªùi gian timeout c·ªßa session'),
('PASSWORD_MIN_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i t·ªëi thi·ªÉu c·ªßa m·∫≠t kh·∫©u'),
('API_KEY_PREFIX_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i prefix hi·ªÉn th·ªã c·ªßa API Key'),
('DEFAULT_CURRENCY', 'VND', 'STRING', 'ƒê∆°n v·ªã ti·ªÅn t·ªá m·∫∑c ƒë·ªãnh'),
('TAX_DEFAULT_RATE', '10.00', 'NUMBER', 'Thu·∫ø su·∫•t m·∫∑c ƒë·ªãnh (%)'),
('INVOICE_NUMBER_FORMAT', 'PREFIX + NUMBER + SUFFIX', 'STRING', 'C·∫•u tr√∫c s·ªë h√≥a ƒë∆°n m·∫∑c ƒë·ªãnh'),
('BACKGROUND_JOB_ENABLED', 'true', 'BOOLEAN', 'K√≠ch ho·∫°t x·ª≠ l√Ω background jobs'),
('INVOICE_LOOKUP_CODE_LENGTH', '6', 'NUMBER', 'ƒê·ªô d√†i m√£ tra c·ª©u h√≥a ƒë∆°n ng·∫´u nhi√™n');
</file>

<file path="src/main/resources/db/migration/V1__Initial_Schema.sql">
-- =============================================================================
-- EInvoiceHub Database Schema - Core + Shell Strategy
-- Database: MariaDB | Character Set: utf8mb4_unicode_ci
-- =============================================================================

SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- SECTION 1: CATALOG TABLES (Reference Data)
-- 1. Invoice Types - Danh m·ª•c lo·∫°i h√≥a ƒë∆°n
CREATE TABLE `invoice_types`
(
    `id`            BIGINT AUTO_INCREMENT PRIMARY KEY,
    `type_code`     VARCHAR(10)  NOT NULL UNIQUE COMMENT 'M√£ lo·∫°i h√≥a ƒë∆°n (VD: 01GTKT)',
    `type_name`     VARCHAR(100) NOT NULL COMMENT 'T√™n lo·∫°i h√≥a ƒë∆°n',
    `description`   TEXT         NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
    `is_active`     BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    `display_order` INT          NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
    `created_at`    TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`    TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX `idx_type_code` (`type_code`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Danh m·ª•c lo·∫°i h√≥a ƒë∆°n';
INSERT INTO invoice_types (type_code, type_name, description, display_order)
VALUES ('01GTKT', 'H√≥a ƒë∆°n gi√° tr·ªã gia tƒÉng', 'H√≥a ƒë∆°n GTGT m·∫´u 01GTKT theo Th√¥ng t∆∞ 78/2021/TT-BTC', 1),
       ('02GTTT', 'H√≥a ƒë∆°n b√°n h√†ng', 'H√≥a ƒë∆°n b√°n h√†ng m·∫´u 02GTTT theo Th√¥ng t∆∞ 78/2021/TT-BTC', 2),
       ('07KPTQ', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ ki·ªÉm so√°t', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ ki·ªÉm so√°t theo Ngh·ªã ƒë·ªãnh 123/2020/Nƒê-CP', 3),
       ('03KPTQ', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ kh√¥ng ki·ªÉm so√°t', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ kh√¥ng ki·ªÉm so√°t theo Ngh·ªã ƒë·ªãnh 123/2020/Nƒê-CP',
        4);

-- 2. Invoice Statuses - Danh m·ª•c tr·∫°ng th√°i h√≥a ƒë∆°n
CREATE TABLE `invoice_statuses`
(
    `id`          INT PRIMARY KEY COMMENT 'ID tr·∫°ng th√°i',
    `name`        VARCHAR(100) NOT NULL UNIQUE COMMENT 'T√™n tr·∫°ng th√°i',
    `description` VARCHAR(255) NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt tr·∫°ng th√°i',
    `note`        VARCHAR(500) NULL COMMENT 'Ghi ch√∫ nghi·ªáp v·ª•',
    `created_at`  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    `updated_at`  TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='B·∫£ng danh m·ª•c tr·∫°ng th√°i h√≥a ƒë∆°n';
INSERT INTO invoice_statuses (id, name, description, note)
VALUES (1, 'DRAFT', 'H√≥a ƒë∆°n nh√°p', 'M·ªõi t·∫°o, ch∆∞a k√Ω'),
       (2, 'PENDING', 'ƒêang x·ª≠ l√Ω', 'ƒêang ch·ªù g·ª≠i sang Provider'),
       (3, 'SIGNING', 'ƒêang k√Ω s·ªë', 'ƒêang th·ª±c hi·ªán k√Ω ƒëi·ªán t·ª≠'),
       (4, 'SENT_TO_PROVIDER', 'ƒê√£ g·ª≠i Provider', 'ƒê√£ g·ª≠i nh∆∞ng ch∆∞a c√≥ k·∫øt qu·∫£ t·ª´ CQT'),
       (5, 'SUCCESS', 'Th√†nh c√¥ng', 'H√≥a ƒë∆°n ƒë√£ h·ª£p l·ªá v√† c√≥ m√£ CQT'),
       (6, 'FAILED', 'Th·∫•t b·∫°i', 'L·ªói t·ª´ Provider ho·∫∑c CQT'),
       (7, 'CANCELLED', 'ƒê√£ h·ªßy', 'H√≥a ƒë∆°n ƒë√£ b·ªã h·ªßy b·ªè'),
       (8, 'REPLACED', 'ƒê√£ thay th·∫ø', 'ƒê√£ c√≥ h√≥a ƒë∆°n kh√°c thay th·∫ø cho h√≥a ƒë∆°n n√†y');

-- 3. Payment Methods - Danh m·ª•c ph∆∞∆°ng th·ª©c thanh to√°n
CREATE TABLE `payment_methods`
(
    `id`            BIGINT AUTO_INCREMENT PRIMARY KEY,
    `method_code`   VARCHAR(10)  NOT NULL UNIQUE COMMENT 'M√£ ph∆∞∆°ng th·ª©c: TM, CK...',
    `method_name`   VARCHAR(100) NOT NULL COMMENT 'T√™n ph∆∞∆°ng th·ª©c',
    `description`   TEXT         NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
    `is_active`     BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    `display_order` INT          NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
    `created_at`    TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`    TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX `idx_method_code` (`method_code`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Danh m·ª•c ph∆∞∆°ng th·ª©c thanh to√°n';
INSERT INTO payment_methods (method_code, method_name, description, display_order)
VALUES ('TM', 'Ti·ªÅn m·∫∑t', 'Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t tr·ª±c ti·∫øp', 1),
       ('CK', 'Chuy·ªÉn kho·∫£n', 'Thanh to√°n qua chuy·ªÉn kho·∫£n ng√¢n h√†ng', 2),
       ('TM/CK', 'Ti·ªÅn m·∫∑t/Chuy·ªÉn kho·∫£n', 'K·∫øt h·ª£p c·∫£ hai h√¨nh th·ª©c', 3),
       ('POS', 'Th·∫ª POS', 'Thanh to√°n qua m√°y POS', 4),
       ('V√ç ƒêI·ªÜN T·ª¨', 'V√≠ ƒëi·ªán t·ª≠', 'Thanh to√°n qua v√≠ ƒëi·ªán t·ª≠', 5),
       ('TH·∫∫', 'Th·∫ª ng√¢n h√†ng', 'Thanh to√°n b·∫±ng th·∫ª t√≠n d·ª•ng/ghi n·ª£', 6);

-- 4. VAT Rates - Danh m·ª•c thu·∫ø su·∫•t GTGT
CREATE TABLE `vat_rates`
(
    `id`            BIGINT AUTO_INCREMENT PRIMARY KEY,
    `rate_code`     VARCHAR(10)   NOT NULL UNIQUE COMMENT 'M√£ thu·∫ø su·∫•t: 0, 5, 8, 10, KCT',
    `rate_percent`  DECIMAL(5, 2) NOT NULL COMMENT 'Gi√° tr·ªã ph·∫ßn trƒÉm thu·∫ø su·∫•t',
    `rate_name`     VARCHAR(100)  NOT NULL COMMENT 'T√™n thu·∫ø su·∫•t',
    `description`   TEXT          NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
    `is_active`     BOOLEAN       NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    `display_order` INT           NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
    `created_at`    TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`    TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    CONSTRAINT `chk_vat_rate_percent` CHECK (rate_percent >= 0),
    INDEX `idx_rate_code` (`rate_code`),
    INDEX `idx_rate_percent` (`rate_percent`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Danh m·ª•c thu·∫ø su·∫•t GTGT';
INSERT INTO vat_rates (rate_code, rate_percent, rate_name, description, display_order)
VALUES ('0', 0.00, 'Thu·∫ø su·∫•t 0%', '√Åp d·ª•ng cho h√†ng h√≥a, d·ªãch v·ª• xu·∫•t kh·∫©u', 1),
       ('5', 5.00, 'Thu·∫ø su·∫•t 5%', '√Åp d·ª•ng cho h√†ng h√≥a, d·ªãch v·ª• thi·∫øt y·∫øu', 2),
       ('8', 8.00, 'Thu·∫ø su·∫•t 8%', 'Gi·∫£m thu·∫ø theo Ngh·ªã quy·∫øt 43/2022/QH15', 3),
       ('10', 10.00, 'Thu·∫ø su·∫•t 10%', 'Thu·∫ø su·∫•t th√¥ng th∆∞·ªùng GTGT', 4),
       ('KCT', 0.00, 'Kh√¥ng ch·ªãu thu·∫ø', 'H√†ng h√≥a, d·ªãch v·ª• kh√¥ng ch·ªãu thu·∫ø GTGT', 5);

-- 5. Service Providers - Danh m·ª•c nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠
CREATE TABLE `service_providers`
(
    `id`                  BIGINT AUTO_INCREMENT PRIMARY KEY,
    `provider_code`       VARCHAR(20)  NOT NULL UNIQUE COMMENT 'M√£ ƒë·ªãnh danh (VNPT, VIETTEL...)',
    `provider_name`       VARCHAR(100) NOT NULL COMMENT 'T√™n nh√† cung c·∫•p',
    `official_api_url`    VARCHAR(500) NOT NULL COMMENT 'URL t√≠ch h·ª£p',
    `lookup_url`          VARCHAR(500) NULL COMMENT 'URL tra c·ª©u h√≥a ƒë∆°n',
    `documentation_url`   VARCHAR(500) NULL COMMENT 'Link t√†i li·ªáu API',
    `support_email`       VARCHAR(255) NULL,
    `support_phone`       VARCHAR(20)  NULL,
    `is_active`           BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'Ki·ªÉm tra c√≤n ho·∫°t ƒë·ªông kh√¥ng',
    `is_default`          BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh h·ªá th·ªëng',
    `display_order`       INT          NOT NULL DEFAULT 0,
    `extra_config_schema` JSON         NULL COMMENT 'C·∫•u h√¨nh ƒë·∫∑c th√π c·ªßa t·ª´ng h√£ng',
    `created_at`          TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`          TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX `idx_provider_code` (`provider_code`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Danh m·ª•c nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠';
INSERT INTO service_providers (provider_code, provider_name, official_api_url, lookup_url, is_active, display_order)
VALUES ('VNPT', 'VNPT e-Invoice', 'https://api-itg.vnpt.vn', 'https://tracuu.vnpt.vn', TRUE, 1),
       ('VIETTEL', 'SInvoice Viettel', 'https://sinvoice.viettel.vn/api', 'https://sinvoice.viettel.vn/tracuu', TRUE,
        2),
       ('BKAV', 'BKAV eInvoice', 'https://einvoice.bkav.com/api', 'https://tracuuhdon.bkav.com', TRUE, 3),
       ('MOBIFONE', 'MobiFone Invoice', 'https://thongke.mobifoneinvoice.vn/api/v1',
        'https://mobifoneinvoice.vn/tracuu', TRUE, 4);



-- SECTION 2: CORE JPA TABLES (Business Logic Foundation)
-- CORE TABLE 1: Merchants (Root Entity)
CREATE TABLE `merchants`
(
    -- Core Fields (Required for JPA compatibility)
    `id`                   BIGINT AUTO_INCREMENT PRIMARY KEY,
    `tax_code`             VARCHAR(20)                        NOT NULL UNIQUE COMMENT 'M√£ s·ªë thu·∫ø - ƒë·ªãnh danh doanh nghi·ªáp',
    `company_name`         VARCHAR(255)                       NOT NULL COMMENT 'T√™n c√¥ng ty ƒë·∫ßy ƒë·ªß',
    `short_name`           VARCHAR(100) COMMENT 'T√™n vi·∫øt t·∫Øt',
    `address`              TEXT COMMENT 'ƒê·ªãa ch·ªâ tr·ª• s·ªü ch√≠nh',
    `district`             VARCHAR(100) COMMENT 'Qu·∫≠n/Huy·ªán',
    `city`                 VARCHAR(100) COMMENT 'T·ªânh/Th√†nh ph·ªë',
    `email`                VARCHAR(255) COMMENT 'Email li√™n h·ªá',
    `phone`                VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    `representative_name`  VARCHAR(100) COMMENT 'T√™n ng∆∞·ªùi ƒë·∫°i di·ªán',
    `representative_title` VARCHAR(100) COMMENT 'Ch·ª©c danh ng∆∞·ªùi ƒë·∫°i di·ªán',
    `tax_authority_code`   VARCHAR(10)                        NULL COMMENT 'M√£ c∆° quan thu·∫ø qu·∫£n l√Ω (VD: 01GD, 02HT...)',

    -- Enterprise Shell Fields (SaaS Extensions - NULLABLE for JPA compatibility)
    `subscription_plan`    ENUM ('TRIAL', 'BASIC', 'PREMIUM') NOT NULL DEFAULT 'TRIAL' COMMENT 'G√≥i d·ªãch v·ª•: TRIAL, BASIC, PREMIUM',
    `invoice_quota`        INT                                NOT NULL DEFAULT 100 COMMENT 'H·∫°n m·ª©c h√≥a ƒë∆°n/th√°ng',
    `invoice_used`         INT                                NOT NULL DEFAULT 0 COMMENT 'H√≥a ƒë∆°n ƒë√£ s·ª≠ d·ª•ng trong th√°ng',
    `is_using_hsm`         BOOLEAN                            NOT NULL DEFAULT FALSE COMMENT 'S·ª≠ d·ª•ng HSM hay USB Token ƒë·ªÉ k√Ω ƒëi·ªán t·ª≠',
    `is_deleted`           BOOLEAN                            NOT NULL DEFAULT FALSE COMMENT 'C·ªù x√≥a m·ªÅm',
    `deleted_at`           TIMESTAMP                          NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
    `created_at`           TIMESTAMP                          NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`           TIMESTAMP                          NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    INDEX `idx_tax_code` (`tax_code`),
    INDEX `idx_subscription_plan` (`subscription_plan`),
    INDEX `idx_created_at` (`created_at`),
    INDEX `idx_tax_authority` (`tax_authority_code`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Qu·∫£n l√Ω doanh nghi·ªáp s·ª≠ d·ª•ng d·ªãch v·ª• h√≥a ƒë∆°n ƒëi·ªán t·ª≠';

-- CORE TABLE 2: Merchant User (Child of Merchant)
CREATE TABLE `merchant_user`
(
    `id`                    BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`           BIGINT                                       NOT NULL COMMENT 'Li√™n k·∫øt v·ªõi doanh nghi·ªáp',
    `username`              VARCHAR(50)                                  NOT NULL UNIQUE COMMENT 'T√™n ƒëƒÉng nh·∫≠p',
    `email`                 VARCHAR(255)                                 NOT NULL UNIQUE COMMENT 'Email ng∆∞·ªùi d√πng',
    `password_hash`         VARCHAR(255)                                 NOT NULL COMMENT 'M·∫≠t kh·∫©u ƒë√£ m√£ h√≥a BCrypt',
    `full_name`             VARCHAR(100) COMMENT 'H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß',
    `phone`                 VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    `avatar_url`            VARCHAR(500) COMMENT 'URL ·∫£nh ƒë·∫°i di·ªán',
    `role`                  ENUM ('ADMIN', 'MANAGER', 'STAFF', 'VIEWER') NOT NULL DEFAULT 'STAFF' COMMENT 'Vai tr√≤ trong h·ªá th·ªëng',
    `is_active`             BOOLEAN                                      NOT NULL DEFAULT TRUE COMMENT 'K√≠ch ho·∫°t t√†i kho·∫£n',
    `is_primary`            BOOLEAN                                      NOT NULL DEFAULT FALSE COMMENT 'T√†i kho·∫£n ch√≠nh c·ªßa doanh nghi·ªáp',
    `last_login_at`         TIMESTAMP                                    NULL COMMENT 'ƒêƒÉng nh·∫≠p l·∫ßn cu·ªëi',
    `failed_login_attempts` INT                                          NOT NULL DEFAULT 0 COMMENT 'S·ªë l·∫ßn ƒëƒÉng nh·∫≠p sai',
    `locked_until`          TIMESTAMP                                    NULL COMMENT 'Kh√≥a t√†i kho·∫£n ƒë·∫øn th·ªùi ƒëi·ªÉm',
    `created_at`            TIMESTAMP                                    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`            TIMESTAMP                                    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT `fk_merchant_user_merchant` FOREIGN KEY (`merchant_id`)
        REFERENCES `merchants` (`id`) ON DELETE CASCADE,

    INDEX `idx_merchant_id` (`merchant_id`),
    INDEX `idx_username` (`username`),
    INDEX `idx_email` (`email`),
    INDEX `idx_role` (`role`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='T√†i kho·∫£n ng∆∞·ªùi d√πng thu·ªôc Merchant';

-- CORE TABLE 3: Merchant Provider Configs (Child of Merchant)
CREATE TABLE `merchant_provider_configs`
(
    -- Core Fields
    `id`                         BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`                BIGINT       NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu',
    `provider_id`                BIGINT       NOT NULL COMMENT 'Nh√† cung c·∫•p ƒë∆∞·ª£c ch·ªçn',

    -- Connection Credentials
    `partner_id`                 VARCHAR(50)  NULL COMMENT 'ID ƒë·ªëi t√°c (partner_id)',
    `partner_token`              VARCHAR(500) NULL COMMENT 'Token truy c·∫≠p (partner_token)',
    `tax_code`                   VARCHAR(20)  NULL COMMENT 'M√£ s·ªë thu·∫ø k·∫øt n·ªëi',
    `integration_url`            VARCHAR(500) NULL COMMENT 'URL t√≠ch h·ª£p ri√™ng',
    `integrated_date`            TIMESTAMP    NULL COMMENT 'Ng√†y t√≠ch h·ª£p',

    -- Service Account
    `username_service`           VARCHAR(100) NOT NULL COMMENT 'T√†i kho·∫£n API',
    `password_service_encrypted` VARCHAR(500) NOT NULL COMMENT 'M·∫≠t kh·∫©u API (ƒë√£ m√£ h√≥a)',

    -- Digital Certificate
    `certificate_serial`         VARCHAR(100) NULL,
    `certificate_data`           TEXT         NULL,
    `certificate_chain`          LONGTEXT     NULL,
    `certificate_expired_at`     TIMESTAMP    NULL,

    -- Extra Configuration
    `extra_config`               JSON         NULL COMMENT 'C·∫•u h√¨nh b·ªï sung (pattern, serial...)',

    -- Enterprise Shell Fields (NULLABLE for JPA compatibility)
    `is_test_mode`               BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'Ch·∫ø ƒë·ªô ki·ªÉm th·ª≠ (Sandbox)',
    `encrypted_password_storage` VARCHAR(500) NULL COMMENT 'L∆∞u tr·ªØ m·∫≠t kh·∫©u ƒë√£ m√£ h√≥a (AES256)',

    -- Status & Timestamps
    `is_active`                  BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'Tr·∫°ng th√°i k√≠ch ho·∫°t',
    `is_default`                 BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'C·∫•u h√¨nh m·∫∑c ƒë·ªãnh',
    `last_sync_at`               TIMESTAMP    NULL COMMENT 'Th·ªùi ƒëi·ªÉm ƒë·ªìng b·ªô cu·ªëi',
    `created_at`                 TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`                 TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT `fk_mpc_merchant` FOREIGN KEY (`merchant_id`) REFERENCES `merchants` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_mpc_provider` FOREIGN KEY (`provider_id`) REFERENCES `service_providers` (`id`) ON DELETE RESTRICT,
    CONSTRAINT `uq_merchant_provider` UNIQUE (`merchant_id`, `provider_id`),

    INDEX `idx_merchant_provider` (`merchant_id`, `provider_id`),
    INDEX `idx_is_active` (`is_active`),
    INDEX `idx_is_test_mode` (`is_test_mode`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='B·∫£ng c·∫•u h√¨nh chi ti·∫øt NCC cho t·ª´ng Merchant';

-- CORE TABLE 4: Invoice Template (Child of Merchant)
CREATE TABLE `invoice_template`
(
    `id`                      BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`             BIGINT      NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu',
    `invoice_type_id`         BIGINT      NULL COMMENT 'Lo·∫°i h√≥a ƒë∆°n',
    `invoice_registration_id` BIGINT      NULL COMMENT 'Li√™n k·∫øt ƒëƒÉng k√Ω d·∫£i s·ªë',
    `provider_id`             VARCHAR(36) NULL COMMENT 'M√£ NCC',
    `provider_serial_id`      VARCHAR(50) NULL COMMENT 'ID d·∫£i s·ªë ph√≠a NCC',

    -- Template Configuration
    `template_code`           VARCHAR(20) NOT NULL COMMENT 'M·∫´u h√≥a ƒë∆°n: 01GTKT0/001',
    `symbol_code`             VARCHAR(10) NOT NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n: AA/22E',

    -- Serial Number Management
    `current_number`          INT         NOT NULL DEFAULT 0 COMMENT 'S·ªë hi·ªán t·∫°i',
    `min_number`              INT         NOT NULL DEFAULT 1,
    `max_number`              INT         NOT NULL DEFAULT 99999999,
    `start_date`              TIMESTAMP   NULL COMMENT 'Ng√†y b·∫Øt ƒë·∫ßu hi·ªáu l·ª±c',

    -- Status
    `status_id`               INT         NULL COMMENT 'ID tr·∫°ng th√°i',
    `is_active`               BOOLEAN     NOT NULL DEFAULT TRUE,

    -- Timestamps
    `created_at`              TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`              TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT `fk_template_merchant` FOREIGN KEY (`merchant_id`) REFERENCES `merchants` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_template_type` FOREIGN KEY (`invoice_type_id`) REFERENCES `invoice_types` (`id`) ON DELETE SET NULL,
    CONSTRAINT `uq_merchant_template_symbol` UNIQUE (`merchant_id`, `template_code`, `symbol_code`),

    INDEX `idx_template_codes` (`template_code`, `symbol_code`),
    INDEX `idx_is_active` (`is_active`),
    INDEX `idx_merchant_id` (`merchant_id`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Qu·∫£n l√Ω m·∫´u s·ªë v√† k√Ω hi·ªáu h√≥a ƒë∆°n';

-- CORE TABLE 5: Invoice Registrations (Supporting Core Table)
-- Registration Statuses
CREATE TABLE `registration_statuses`
(
    `id`          INT PRIMARY KEY COMMENT 'ID tr·∫°ng th√°i',
    `name`        VARCHAR(100) NOT NULL UNIQUE COMMENT 'T√™n tr·∫°ng th√°i',
    `description` VARCHAR(255) NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
    `note`        VARCHAR(500) NULL COMMENT 'Ghi ch√∫ nghi·ªáp v·ª•',
    `created_at`  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    `updated_at`  TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Danh m·ª•c tr·∫°ng th√°i ƒëƒÉng k√Ω d·∫£i s·ªë';
INSERT INTO registration_statuses (id, name, description, note)
VALUES (1, 'ACTIVE', 'ƒêang hi·ªáu l·ª±c', 'D·∫£i s·ªë ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng'),
       (2, 'EXHAUSTED', 'ƒê√£ d√πng h·∫øt', 'To√†n b·ªô s·ªë trong d·∫£i ƒë√£ ph√°t h√†nh'),
       (3, 'EXPIRED', 'ƒê√£ h·∫øt h·∫°n', 'D·∫£i s·ªë ƒë√£ qu√° ng√†y hi·ªáu l·ª±c'),
       (4, 'CANCELLED', 'ƒê√£ h·ªßy', 'D·∫£i s·ªë b·ªã h·ªßy b·ªè');

CREATE TABLE `invoice_registrations`
(
    `id`                  BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`         BIGINT       NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu d·∫£i s·ªë',
    `registration_number` VARCHAR(50)  NULL COMMENT 'S·ªë quy·∫øt ƒë·ªãnh/ph√™ duy·ªát c·ªßa CQT',
    `from_number`         BIGINT       NOT NULL COMMENT 'S·ªë b·∫Øt ƒë·∫ßu c·ªßa d·∫£i',
    `to_number`           BIGINT       NOT NULL COMMENT 'S·ªë k·∫øt th√∫c c·ªßa d·∫£i',
    `quantity`            BIGINT       NOT NULL COMMENT 'S·ªë l∆∞·ª£ng h√≥a ƒë∆°n trong d·∫£i',
    `current_number`      BIGINT       NOT NULL DEFAULT 0 COMMENT 'S·ªë hi·ªán t·∫°i ƒë√£ s·ª≠ d·ª•ng',
    `effective_date`      DATE         NOT NULL COMMENT 'Ng√†y c√≥ hi·ªáu l·ª±c',
    `expiration_date`     DATE         NULL COMMENT 'Ng√†y h·∫øt h·∫°n',
    `status_id`           INT          NOT NULL DEFAULT 1 COMMENT 'Tr·∫°ng th√°i ƒëƒÉng k√Ω',
    `issued_by`           VARCHAR(255) NULL COMMENT 'Ng∆∞·ªùi ph√™ duy·ªát/C∆° quan Thu·∫ø',
    `note`                TEXT         NULL COMMENT 'Ghi ch√∫ b·ªï sung',
    `created_at`          TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`          TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    CONSTRAINT `fk_invoice_registrations_registration_statuses` FOREIGN KEY (`status_id`) REFERENCES `registration_statuses` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_registration_merchant` FOREIGN KEY (`merchant_id`) REFERENCES `merchants` (`id`) ON DELETE CASCADE,
    CONSTRAINT `chk_registration_range` CHECK (`from_number` <= `to_number`),

    INDEX `idx_registration_merchant` (`merchant_id`),
    INDEX `idx_registration_status` (`status_id`),
    INDEX `idx_registration_effective` (`effective_date`),
    INDEX `idx_registration_number` (`registration_number`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Qu·∫£n l√Ω ƒëƒÉng k√Ω d·∫£i s·ªë h√≥a ƒë∆°n v·ªõi C∆° quan Thu·∫ø';

-- CORE TABLE 6: Invoice Metadata (Central Transaction Table)
CREATE TABLE `invoice_metadata`
(
    -- Primary Key
    `id`                        BIGINT AUTO_INCREMENT PRIMARY KEY,

    -- Foreign Keys (Hierarchical references)
    `merchant_id`               BIGINT                                             NOT NULL COMMENT 'Li√™n k·∫øt doanh nghi·ªáp s·ªü h·ªØu',
    `provider_id`               BIGINT                                             NULL COMMENT 'Li√™n k·∫øt nh√† cung c·∫•p d·ªãch v·ª•',
    `provider_config_id`        BIGINT                                             NULL COMMENT 'C·∫•u h√¨nh Provider ƒë∆∞·ª£c s·ª≠ d·ª•ng',
    `invoice_template_id`       BIGINT                                             NULL COMMENT 'M·∫´u h√≥a ƒë∆°n ƒë∆∞·ª£c s·ª≠ d·ª•ng',
    `payment_method`            VARCHAR(10)                                        NULL COMMENT 'M√£ ph∆∞∆°ng th·ª©c thanh to√°n',

    -- Identifiers & References
    `client_request_id`         VARCHAR(100)                                       NULL COMMENT 'ID request t·ª´ h·ªá th·ªëng Merchant',
    `partner_invoice_id`        VARCHAR(50)                                        NULL COMMENT 'ID ƒë·ªãnh danh t·ª´ ƒë·ªëi t√°c',

    -- Invoice Information
    `invoice_number`            VARCHAR(20)                                        NULL COMMENT 'S·ªë h√≥a ƒë∆°n t·ª´ Provider tr·∫£ v·ªÅ',
    `symbol_code`               VARCHAR(10)                                        NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n',
    `template_code`             VARCHAR(20)                                        NULL COMMENT 'M·∫´u h√≥a ƒë∆°n',
    `invoice_type_code`         VARCHAR(10)                                        NULL COMMENT 'M√£ lo·∫°i h√≥a ƒë∆°n',
    `is_summary_invoice`        BOOLEAN                                            NOT NULL DEFAULT FALSE COMMENT 'H√≥a ƒë∆°n t·ªïng h·ª£p',
    `issuance_method`           ENUM ('STANDARD', 'POS')                           NOT NULL DEFAULT 'STANDARD' COMMENT 'Ph∆∞∆°ng th·ª©c ph√°t h√†nh',

    -- Enterprise Shell Fields (NULLABLE for JPA compatibility)
    `lookup_code`               VARCHAR(50)                                        NULL COMMENT 'M√£ tra c·ª©u h√≥a ƒë∆°n (Unique)',
    `cqt_code`                  VARCHAR(50)                                        NULL COMMENT 'M√£ C∆° quan Thu·∫ø c·∫•p',
    `provider_transaction_id`   VARCHAR(100)                                       NULL COMMENT 'ID giao d·ªãch t·ª´ Provider',

    -- Seller Information (Flattened from Merchant)
    `seller_name`               VARCHAR(255)                                       NULL COMMENT 'T√™n ng∆∞·ªùi b√°n',
    `seller_tax_code`           VARCHAR(20)                                        NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi b√°n',
    `seller_address`            TEXT                                               NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi b√°n',

    -- Buyer Information (FLATTENED - No Customer FK to prevent circular dependencies)
    `buyer_name`                VARCHAR(255)                                       NULL COMMENT 'T√™n ƒë∆°n v·ªã ng∆∞·ªùi mua',
    `buyer_tax_code`            VARCHAR(20)                                        NULL COMMENT 'MST ng∆∞·ªùi mua',
    `buyer_id_no`               VARCHAR(20)                                        NULL COMMENT 'S·ªë CMND/CCCD/H·ªô chi·∫øu',
    `buyer_full_name`           VARCHAR(200)                                       NULL COMMENT 'H·ªç t√™n ng∆∞·ªùi mua h√†ng',
    `buyer_email`               VARCHAR(255)                                       NULL COMMENT 'Email ng∆∞·ªùi mua',
    `buyer_phone`               VARCHAR(20)                                        NULL COMMENT 'ƒêi·ªán tho·∫°i ng∆∞·ªùi mua',
    `buyer_mobile`              VARCHAR(50)                                        NULL COMMENT 'Di ƒë·ªông ng∆∞·ªùi mua',
    `buyer_address`             TEXT                                               NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi mua',
    `buyer_bank_account`        VARCHAR(50)                                        NULL COMMENT 'T√†i kho·∫£n ng√¢n h√†ng',
    `buyer_bank_name`           VARCHAR(200)                                       NULL COMMENT 'T√™n ng√¢n h√†ng',
    `buyer_budget_code`         VARCHAR(20)                                        NULL COMMENT 'M√£ ch∆∞∆°ng/NSNN',

    -- Amounts & Currency (DECIMAL(18,2) for precision)
    `subtotal_amount`           DECIMAL(18, 2)                                     NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø',
    `tax_amount`                DECIMAL(18, 2)                                     NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ø',
    `discount_amount`           DECIMAL(18, 2)                                     NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng chi·∫øt kh·∫•u',
    `total_amount`              DECIMAL(18, 2)                                     NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thanh to√°n',
    `gross_amount`              DECIMAL(18, 2)                                              DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn th√¥',
    `net_amount`                DECIMAL(18, 2)                                              DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ßn',
    `currency_code`             VARCHAR(3)                                         NOT NULL DEFAULT 'VND' COMMENT 'ƒê∆°n v·ªã ti·ªÅn t·ªá',
    `exchange_rate`             DECIMAL(10, 4)                                     NOT NULL DEFAULT 1.0000 COMMENT 'T·ª∑ gi√°',

    -- Adjustment / Original Invoice Info
    `org_invoice_id`            VARCHAR(36)                                        NULL COMMENT 'ID h√≥a ƒë∆°n g·ªëc',
    `org_invoice_form`          VARCHAR(50)                                        NULL COMMENT 'M·∫´u h√≥a ƒë∆°n g·ªëc',
    `org_invoice_series`        VARCHAR(50)                                        NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n g·ªëc',
    `org_invoice_no`            VARCHAR(50)                                        NULL COMMENT 'S·ªë h√≥a ƒë∆°n g·ªëc',
    `org_invoice_date`          TIMESTAMP                                          NULL COMMENT 'Ng√†y h√≥a ƒë∆°n g·ªëc',
    `org_invoice_reason`        VARCHAR(500)                                       NULL COMMENT 'L√Ω do ƒëi·ªÅu ch·ªânh',
    `adjustment_type`           ENUM ('ADJUSTMENT', 'REPLACEMENT', 'CANCELLATION') NULL COMMENT 'Lo·∫°i ƒëi·ªÅu ch·ªânh',
    `cancellation_reason`       VARCHAR(500)                                       NULL COMMENT 'L√Ω do h·ªßy',
    `replaced_by_invoice_id`    BIGINT                                             NULL COMMENT 'H√≥a ƒë∆°n thay th·∫ø',

    -- Status & Dates
    `status_id`                 INT                                                NOT NULL DEFAULT 1 COMMENT 'Tr·∫°ng th√°i h√≥a ƒë∆°n',
    `status_message`            TEXT                                               NULL COMMENT 'Th√¥ng b√°o l·ªói ho·∫∑c tr·∫°ng th√°i chi ti·∫øt',
    `issue_date`                DATE                                               NULL COMMENT 'Ng√†y l·∫≠p h√≥a ƒë∆°n',
    `accounting_date`           DATE                                               NULL COMMENT 'Ng√†y h·∫°ch to√°n',
    `due_date`                  DATE                                               NULL COMMENT 'Ng√†y h·∫°n thanh to√°n',

    -- Timestamps for Audit Trail
    `signed_at`                 TIMESTAMP                                          NULL COMMENT 'Th·ªùi ƒëi·ªÉm k√Ω s·ªë',
    `sent_to_provider_at`       TIMESTAMP                                          NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i NCC',
    `received_from_provider_at` TIMESTAMP                                          NULL COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
    `delivered_to_buyer_at`     TIMESTAMP                                          NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i kh√°ch h√†ng',

    -- Provider Feedback
    `provider_error_code`       VARCHAR(50)                                        NULL COMMENT 'M√£ l·ªói t·ª´ Provider',
    `provider_error_message`    TEXT                                               NULL COMMENT 'Chi ti·∫øt l·ªói t·ª´ Provider',

    -- Soft Delete
    `is_deleted`                BOOLEAN                                            NOT NULL DEFAULT FALSE,
    `deleted_at`                TIMESTAMP                                          NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
    `deleted_by`                BIGINT                                             NULL COMMENT 'Ng∆∞·ªùi x√≥a',

    -- System Audit Timestamps
    `created_at`                TIMESTAMP                                          NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`                TIMESTAMP                                          NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t cu·ªëi',

    -- Constraints
    CONSTRAINT `fk_invoice_merchant` FOREIGN KEY (`merchant_id`) REFERENCES `merchants` (`id`),
    CONSTRAINT `fk_invoice_status` FOREIGN KEY (`status_id`) REFERENCES `invoice_statuses` (`id`),
    CONSTRAINT `fk_invoice_provider` FOREIGN KEY (`provider_id`) REFERENCES `service_providers` (`id`),
    CONSTRAINT `fk_invoice_template` FOREIGN KEY (`invoice_template_id`) REFERENCES `invoice_template` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_invoice_config` FOREIGN KEY (`provider_config_id`) REFERENCES `merchant_provider_configs` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_invoice_payment_method` FOREIGN KEY (`payment_method`) REFERENCES `payment_methods` (`method_code`) ON DELETE SET NULL,
    CONSTRAINT `fk_invoice_replaced_by` FOREIGN KEY (`replaced_by_invoice_id`) REFERENCES `invoice_metadata` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_invoice_deleted_by` FOREIGN KEY (`deleted_by`) REFERENCES `merchant_user` (`id`) ON DELETE SET NULL,
    CONSTRAINT `uq_invoice_lookup_code` UNIQUE (`lookup_code`),

    -- Indexes for Search Optimization
    INDEX `idx_merchant_status` (`merchant_id`, `status_id`),
    INDEX `idx_invoice_number` (`invoice_number`),
    INDEX `idx_client_request_id` (`client_request_id`),
    INDEX `idx_partner_invoice` (`partner_invoice_id`),
    INDEX `idx_buyer_tax_code` (`buyer_tax_code`),
    INDEX `idx_issue_date` (`issue_date`),
    INDEX `idx_created_at` (`created_at`),
    INDEX `idx_cqt_code` (`cqt_code`),
    INDEX `idx_template_code` (`template_code`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='B·∫£ng l∆∞u tr·ªØ Metadata h√≥a ƒë∆°n t·ªïng h·ª£p';

-- CORE TABLE 7: Invoice Items (Child of Invoice)
CREATE TABLE `invoice_items`
(
    `id`              BIGINT AUTO_INCREMENT PRIMARY KEY,
    `invoice_id`      BIGINT         NOT NULL COMMENT 'ID h√≥a ƒë∆°n cha',
    `line_number`     INT            NOT NULL DEFAULT 1 COMMENT 'S·ªë th·ª© t·ª± d√≤ng',

    -- Product Information
    `is_free`         BOOLEAN                 DEFAULT FALSE COMMENT 'H√†ng khuy·∫øn m√£i/bi·∫øu t·∫∑ng',
    `product_type_id` INT            NULL COMMENT 'Lo·∫°i h√†ng h√≥a/d·ªãch v·ª•',
    `product_code`    VARCHAR(100)   NULL COMMENT 'M√£ s·∫£n ph·∫©m',
    `product_name`    VARCHAR(500)   NOT NULL COMMENT 'T√™n h√†ng h√≥a/d·ªãch v·ª•',
    `unit_name`       VARCHAR(50)    NULL COMMENT 'ƒê∆°n v·ªã t√≠nh',

    -- Quantity & Unit Price
    `quantity`        DECIMAL(18, 4) NOT NULL DEFAULT 0 COMMENT 'S·ªë l∆∞·ª£ng',
    `unit_price`      DECIMAL(18, 4) NOT NULL DEFAULT 0 COMMENT 'ƒê∆°n gi√° ch∆∞a thu·∫ø',

    -- Amount Calculations
    `gross_amount`    DECIMAL(18, 2)          DEFAULT 0 COMMENT 'Th√†nh ti·ªÅn th√¥',
    `discount_rate`   DECIMAL(5, 2)           DEFAULT 0 COMMENT 'T·ª∑ l·ªá chi·∫øt kh·∫•u (%)',
    `discount_amount` DECIMAL(18, 2)          DEFAULT 0 COMMENT 'Ti·ªÅn chi·∫øt kh·∫•u',
    `net_price`       DECIMAL(18, 4)          DEFAULT 0 COMMENT 'Gi√° sau chi·∫øt kh·∫•u ch∆∞a thu·∫ø',
    `net_amount`      DECIMAL(18, 2)          DEFAULT 0 COMMENT 'Th√†nh ti·ªÅn sau chi·∫øt kh·∫•u tr∆∞·ªõc thu·∫ø',

    -- Tax Information
    `vat_rate_id`     BIGINT                  NULL COMMENT 'Ph√¢n lo·∫°i thu·∫ø',
    `tax_rate`        DECIMAL(5, 2)           DEFAULT 0 COMMENT 'M·ª©c thu·∫ø su·∫•t (%)',
    `tax_amount`      DECIMAL(18, 2)          DEFAULT 0 COMMENT 'Ti·ªÅn thu·∫ø GTGT',

    -- Total
    `total_amount`    DECIMAL(18, 2) NOT NULL DEFAULT 0 COMMENT 'T·ªïng thanh to√°n d√≤ng',

    -- Description
    `description`     TEXT           NULL COMMENT 'M√¥ t·∫£ s·∫£n ph·∫©m',
    `notes`           VARCHAR(500)   NULL COMMENT 'Ghi ch√∫ th√™m',

    `created_at`      TIMESTAMP      NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT `fk_item_invoice` FOREIGN KEY (`invoice_id`) REFERENCES `invoice_metadata` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_item_vat_rate` FOREIGN KEY (`vat_rate_id`) REFERENCES `vat_rates` (`id`) ON DELETE CASCADE,

    INDEX `idx_item_invoice` (`invoice_id`),
    INDEX `idx_product_code` (`product_code`),
    INDEX `idx_line_number` (`line_number`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Chi ti·∫øt t·ª´ng d√≤ng h√†ng h√≥a/d·ªãch v·ª• trong h√≥a ƒë∆°n';

-- CORE TABLE 8: Invoice Tax Breakdowns (Supporting Core Table)
CREATE TABLE `invoice_tax_breakdowns`
(
    `id`               BIGINT AUTO_INCREMENT PRIMARY KEY,
    `invoice_id`       BIGINT         NOT NULL COMMENT 'ID h√≥a ƒë∆°n cha',
    `vat_rate_id`      BIGINT         NOT NULL COMMENT 'Li√™n k·∫øt v·ªõi danh m·ª•c thu·∫ø su·∫•t',
    `vat_rate_code`    VARCHAR(10)    NOT NULL COMMENT 'M√£ thu·∫ø su·∫•t',
    `vat_rate_percent` DECIMAL(5, 2)  NOT NULL COMMENT 'Gi√° tr·ªã ph·∫ßn trƒÉm thu·∫ø su·∫•t',

    `subtotal_amount`  DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø',
    `discount_amount`  DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn chi·∫øt kh·∫•u',
    `taxable_amount`   DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn ch·ªãu thu·∫ø',
    `tax_amount`       DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ø GTGT',
    `total_amount`     DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn bao g·ªìm thu·∫ø',

    `created_at`       TIMESTAMP      NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',

    CONSTRAINT `fk_tax_breakdown_invoice` FOREIGN KEY (`invoice_id`)
        REFERENCES `invoice_metadata` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_tax_breakdown_vat_rate` FOREIGN KEY (`vat_rate_id`)
        REFERENCES `vat_rates` (`id`) ON DELETE RESTRICT,
    CONSTRAINT `uq_invoice_vat_rate` UNIQUE (`invoice_id`, `vat_rate_id`),

    INDEX `idx_breakdown_invoice` (`invoice_id`),
    INDEX `idx_breakdown_vat_rate` (`vat_rate_id`),
    INDEX `idx_vat_rate_code` (`vat_rate_code`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Ph√¢n r√£ thu·∫ø su·∫•t tr√™n t·ª´ng h√≥a ƒë∆°n';

-- CORE TABLE 9: Invoice Adjustments (Supporting Core Table)
CREATE TABLE `invoice_adjustments`
(
    `id`                   BIGINT AUTO_INCREMENT PRIMARY KEY,
    `original_invoice_id`  BIGINT                                                NOT NULL COMMENT 'H√≥a ƒë∆°n g·ªëc b·ªã ƒëi·ªÅu ch·ªânh/thay th·∫ø/h·ªßy',
    `adjustment_type`      ENUM ('ADJUSTMENT', 'REPLACEMENT', 'CANCELLATION')    NOT NULL COMMENT 'Lo·∫°i ƒëi·ªÅu ch·ªânh',

    `agreement_number`     VARCHAR(50)                                           NULL COMMENT 'S·ªë bi√™n b·∫£n th·ªèa thu·∫≠n',
    `agreement_date`       DATE                                                  NULL COMMENT 'Ng√†y l·∫≠p bi√™n b·∫£n',
    `agreement_content`    TEXT                                                  NULL COMMENT 'N·ªôi dung bi√™n b·∫£n th·ªèa thu·∫≠n',
    `signers`              TEXT                                                  NULL COMMENT 'Ng∆∞·ªùi k√Ω bi√™n b·∫£n (JSON array)',

    `reason_code`          VARCHAR(50)                                           NULL COMMENT 'M√£ l√Ω do',
    `reason_description`   VARCHAR(500)                                          NULL COMMENT 'M√¥ t·∫£ l√Ω do chi ti·∫øt',

    `old_subtotal_amount`  DECIMAL(18, 2)                                        NULL COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø c≈©',
    `old_tax_amount`       DECIMAL(18, 2)                                        NULL COMMENT 'Ti·ªÅn thu·∫ø c≈©',
    `old_total_amount`     DECIMAL(18, 2)                                        NULL COMMENT 'T·ªïng ti·ªÅn c≈©',
    `new_subtotal_amount`  DECIMAL(18, 2)                                        NULL COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø m·ªõi',
    `new_tax_amount`       DECIMAL(18, 2)                                        NULL COMMENT 'Ti·ªÅn thu·∫ø m·ªõi',
    `new_total_amount`     DECIMAL(18, 2)                                        NULL COMMENT 'T·ªïng ti·ªÅn m·ªõi',
    `difference_amount`    DECIMAL(18, 2)                                        NULL COMMENT 'Ch√™nh l·ªách ti·ªÅn',

    `status`               ENUM ('PENDING', 'APPROVED', 'REJECTED', 'CANCELLED') NOT NULL DEFAULT 'PENDING' COMMENT 'Tr·∫°ng th√°i duy·ªát',
    `approved_at`          TIMESTAMP                                             NULL COMMENT 'Th·ªùi ƒëi·ªÉm duy·ªát',

    `submitted_to_cqt`     BOOLEAN                                               NOT NULL DEFAULT FALSE COMMENT 'ƒê√£ g·ª≠i C∆° quan Thu·∫ø',
    `cqt_response_code`    VARCHAR(50)                                           NULL COMMENT 'M√£ ph·∫£n h·ªìi t·ª´ CQT',
    `cqt_response_message` TEXT                                                  NULL COMMENT 'N·ªôi dung ph·∫£n h·ªìi t·ª´ CQT',

    `created_at`           TIMESTAMP                                             NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`           TIMESTAMP                                             NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT `fk_adjustment_original_invoice` FOREIGN KEY (`original_invoice_id`)
        REFERENCES `invoice_metadata` (`id`) ON DELETE RESTRICT,

    INDEX `idx_adjustment_original` (`original_invoice_id`),
    INDEX `idx_adjustment_type` (`adjustment_type`),
    INDEX `idx_adjustment_status` (`status`),
    INDEX `idx_agreement_date` (`agreement_date`),
    INDEX `idx_submitted_cqt` (`submitted_to_cqt`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Th√¥ng tin bi√™n b·∫£n th·ªèa thu·∫≠n cho h√≥a ƒë∆°n ƒëi·ªÅu ch·ªânh/thay th·∫ø/h·ªßy';


-- SECTION 3: ENTERPRISE SHELL MODULES (Management & Auxiliary Tables)
-- MANAGEMENT TABLE 1: Invoice Payloads (One-to-One with Metadata)
CREATE TABLE `invoice_payloads`
(
    `invoice_id`   BIGINT    NOT NULL PRIMARY KEY COMMENT 'ID h√≥a ƒë∆°n - kh√≥a ch√≠nh v√† kh√≥a ngo·∫°i',
    `raw_data`     JSON      NULL COMMENT 'D·ªØ li·ªáu th√¥ request/response d·∫°ng JSON',
    `xml_content`  LONGTEXT  NULL COMMENT 'N·ªôi dung XML g·ªëc c·ªßa h√≥a ƒë∆°n',
    `json_content` LONGTEXT  NULL COMMENT 'N·ªôi dung JSON ƒë·∫ßy ƒë·ªß c·ªßa h√≥a ƒë∆°n',
    `signed_xml`   LONGTEXT  NULL COMMENT 'XML ƒë√£ k√Ω ƒëi·ªán t·ª≠',
    `pdf_data`     LONGTEXT  NULL COMMENT 'D·ªØ li·ªáu PDF ƒë√£ t·∫°o (base64)',
    `extra_data`   JSON      NULL COMMENT 'D·ªØ li·ªáu b·ªï sung kh√°c',
    `created_at`   TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm l∆∞u',
    `updated_at`   TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT `fk_invoice_payload_invoice` FOREIGN KEY (`invoice_id`)
        REFERENCES `invoice_metadata` (`id`) ON DELETE CASCADE,

    INDEX `idx_payload_created` (`created_at`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='L∆∞u tr·ªØ n·ªôi dung XML/JSON g·ªëc h√≥a ƒë∆°n';

-- MANAGEMENT TABLE 2: API Credentials
CREATE TABLE `api_credentials`
(
    `id`                        BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`               BIGINT       NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu credential',
    `client_id`                 VARCHAR(50)  NOT NULL UNIQUE COMMENT 'ID c√¥ng khai c·ªßa ·ª©ng d·ª•ng',
    `api_key_hash`              VARCHAR(255) NOT NULL COMMENT 'Hash c·ªßa API Key (SHA-256)',
    `api_key_prefix`            VARCHAR(8)   NOT NULL COMMENT '8 k√Ω t·ª± ƒë·∫ßu c·ªßa API Key',
    `scopes`                    TEXT         NOT NULL COMMENT 'Quy·ªÅn h·∫°n - JSON array',
    `ip_whitelist`              TEXT         NULL COMMENT 'Danh s√°ch IP ƒë∆∞·ª£c ph√©p - JSON array',
    `rate_limit_per_hour`       INT          NOT NULL DEFAULT 1000 COMMENT 'Gi·ªõi h·∫°n request/gi·ªù',
    `rate_limit_per_day`        INT          NOT NULL DEFAULT 10000 COMMENT 'Gi·ªõi h·∫°n request/ng√†y',
    `request_count_hour`        INT          NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong gi·ªù',
    `request_count_day`         INT          NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong ng√†y',
    `request_count_resetted_at` TIMESTAMP    NULL COMMENT 'Th·ªùi ƒëi·ªÉm reset counter',
    `expired_at`                TIMESTAMP    NULL COMMENT 'Ng√†y h·∫øt h·∫°n - NULL kh√¥ng gi·ªõi h·∫°n',
    `last_used_at`              TIMESTAMP    NULL COMMENT 'L·∫ßn s·ª≠ d·ª•ng cu·ªëi',
    `is_active`                 BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    `created_at`                TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`                TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    -- Using INDEX instead of FK for performance (decoupled from merchant table)
    INDEX `idx_merchant_id` (`merchant_id`),
    INDEX `idx_client_id` (`client_id`),
    INDEX `idx_api_key_hash` (`api_key_hash`),
    INDEX `idx_expired_at` (`expired_at`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Credentials cho API access';

-- MANAGEMENT TABLE 3: Audit Logs
CREATE TABLE `audit_logs`
(
    `id`          BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id` BIGINT       NULL COMMENT 'Doanh nghi·ªáp li√™n quan',
    `user_id`     BIGINT       NULL COMMENT 'Ng∆∞·ªùi th·ª±c hi·ªán',
    `entity_type` VARCHAR(50)  NOT NULL COMMENT 'Lo·∫°i entity: Invoice, Merchant, Config...',
    `entity_id`   BIGINT       NOT NULL COMMENT 'ID c·ªßa entity',
    `action`      VARCHAR(50)  NOT NULL COMMENT 'H√†nh ƒë·ªông: CREATE, UPDATE, DELETE, STATUS_CHANGE',
    `old_value`   JSON         NULL COMMENT 'Gi√° tr·ªã c≈©',
    `new_value`   JSON         NULL COMMENT 'Gi√° tr·ªã m·ªõi',
    `ip_address`  VARCHAR(45)  NULL COMMENT 'IP th·ª±c hi·ªán',
    `user_agent`  VARCHAR(500) NULL COMMENT 'User Agent c·ªßa browser/client',
    `request_id`  VARCHAR(100) NULL COMMENT 'ID request t·ª´ frontend',
    `created_at`  TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm x·∫£y ra',

    -- Using INDEX instead of FK for high-performance logging
    INDEX `idx_merchant_id` (`merchant_id`),
    INDEX `idx_user_id` (`user_id`),
    INDEX `idx_entity` (`entity_type`, `entity_id`),
    INDEX `idx_action` (`action`),
    INDEX `idx_created_at` (`created_at`),
    INDEX `idx_merchant_entity` (`merchant_id`, `entity_type`, `entity_id`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Nh·∫≠t k√Ω thay ƒë·ªïi h·ªá th·ªëng';

-- MANAGEMENT TABLE 4: Invoice Sync Queue
CREATE TABLE `invoice_sync_queue`
(
    `id`                      BIGINT AUTO_INCREMENT PRIMARY KEY,
    `invoice_id`              BIGINT                                                                        NOT NULL COMMENT 'ID h√≥a ƒë∆°n c·∫ßn ƒë·ªìng b·ªô',
    `sync_type`               ENUM ('SEND_TO_PROVIDER', 'SEND_TO_CQT', 'CANCEL_INVOICE', 'REPLACE_INVOICE') NOT NULL COMMENT 'Lo·∫°i thao t√°c ƒë·ªìng b·ªô',
    `priority`                INT                                                                           NOT NULL DEFAULT 5 COMMENT 'ƒê·ªô ∆∞u ti√™n (1=cao nh·∫•t, 10=th·∫•p nh·∫•t)',

    `status`                  ENUM ('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED', 'RETRYING')             NOT NULL DEFAULT 'PENDING' COMMENT 'Tr·∫°ng th√°i x·ª≠ l√Ω',
    `attempt_count`           INT                                                                           NOT NULL DEFAULT 0 COMMENT 'S·ªë l·∫ßn th·ª≠',
    `max_attempts`            INT                                                                           NOT NULL DEFAULT 3 COMMENT 'S·ªë l·∫ßn th·ª≠ t·ªëi ƒëa',
    `last_attempt_at`         TIMESTAMP                                                                     NULL COMMENT 'Th·ªùi ƒëi·ªÉm th·ª≠ l·∫ßn cu·ªëi',
    `next_retry_at`           TIMESTAMP                                                                     NULL COMMENT 'Th·ªùi ƒëi·ªÉm th·ª≠ ti·∫øp theo',

    `request_data`            JSON                                                                          NULL COMMENT 'D·ªØ li·ªáu request g·ª≠i ƒëi',
    `response_data`           JSON                                                                          NULL COMMENT 'D·ªØ li·ªáu response nh·∫≠n v·ªÅ',
    `error_code`              VARCHAR(50)                                                                   NULL COMMENT 'M√£ l·ªói',
    `error_message`           TEXT                                                                          NULL COMMENT 'Chi ti·∫øt l·ªói',

    `processed_by`            VARCHAR(100)                                                                  NULL COMMENT 'Worker x·ª≠ l√Ω',
    `processing_started_at`   TIMESTAMP                                                                     NULL COMMENT 'Th·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu x·ª≠ l√Ω',
    `processing_completed_at` TIMESTAMP                                                                     NULL COMMENT 'Th·ªùi ƒëi·ªÉm ho√†n th√†nh',

    `created_at`              TIMESTAMP                                                                     NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`              TIMESTAMP                                                                     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT `fk_sync_queue_invoice` FOREIGN KEY (`invoice_id`)
        REFERENCES `invoice_metadata` (`id`) ON DELETE CASCADE,

    CONSTRAINT `chk_sync_attempt_count` CHECK (`attempt_count` <= `max_attempts`),

    INDEX `idx_sync_queue_status` (`status`),
    INDEX `idx_sync_queue_invoice` (`invoice_id`),
    INDEX `idx_sync_queue_merchant` (`invoice_id`),
    INDEX `idx_sync_queue_priority` (`priority`),
    INDEX `idx_sync_queue_next_retry` (`next_retry_at`),
    INDEX `idx_sync_queue_created` (`created_at`),
    INDEX `idx_sync_queue_status_priority` (`status`, `priority`, `next_retry_at`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='H√†ng ƒë·ª£i g·ª≠i h√≥a ƒë∆°n sang Provider/CQT';

-- MANAGEMENT TABLE 5: Tax Authority Responses
CREATE TABLE `tax_authority_responses`
(
    `id`              BIGINT AUTO_INCREMENT PRIMARY KEY,
    `invoice_id`      BIGINT       NOT NULL COMMENT 'H√≥a ƒë∆°n li√™n quan',
    `cqt_code`        VARCHAR(50)  NOT NULL COMMENT 'M√£ C∆° quan Thu·∫ø',
    `status_from_cqt` VARCHAR(50)  NOT NULL COMMENT 'Tr·∫°ng th√°i t·ª´ C∆° quan Thu·∫ø',
    `processing_code` VARCHAR(100) NULL COMMENT 'M√£ x·ª≠ l√Ω t·ª´ C∆° quan Thu·∫ø',
    `signature_data`  TEXT         NULL COMMENT 'D·ªØ li·ªáu ch·ªØ k√Ω t·ª´ C∆° quan Thu·∫ø',
    `raw_response`    JSON         NULL COMMENT 'Response th√¥ t·ª´ C∆° quan Thu·∫ø',
    `error_code`      VARCHAR(50)  NULL COMMENT 'M√£ l·ªói t·ª´ C∆° quan Thu·∫ø',
    `error_message`   TEXT         NULL COMMENT 'Th√¥ng b√°o l·ªói t·ª´ C∆° quan Thu·∫ø',
    `received_at`     TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
    `processed_at`    TIMESTAMP    NULL COMMENT 'Th·ªùi ƒëi·ªÉm x·ª≠ l√Ω ho√†n t·∫•t',
    `created_at`      TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o b·∫£n ghi',

    CONSTRAINT `fk_tax_response_invoice` FOREIGN KEY (`invoice_id`)
        REFERENCES `invoice_metadata` (`id`) ON DELETE CASCADE,

    INDEX `idx_tax_response_invoice` (`invoice_id`),
    INDEX `idx_cqt_code` (`cqt_code`),
    INDEX `idx_status_cqt` (`status_from_cqt`),
    INDEX `idx_received_at` (`received_at`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='L∆∞u v·∫øt t∆∞∆°ng t√°c v·ªõi C∆° quan Thu·∫ø';

-- MANAGEMENT TABLE 6: System Configuration
CREATE TABLE `system_config`
(
    `id`           BIGINT AUTO_INCREMENT PRIMARY KEY,
    `config_key`   VARCHAR(100) NOT NULL UNIQUE COMMENT 'Kh√≥a c·∫•u h√¨nh',
    `config_value` TEXT         NOT NULL COMMENT 'Gi√° tr·ªã c·∫•u h√¨nh',
    `config_type`  VARCHAR(20)  NOT NULL DEFAULT 'STRING' COMMENT 'Lo·∫°i: STRING, NUMBER, BOOLEAN, JSON',
    `description`  VARCHAR(500) NULL COMMENT 'M√¥ t·∫£ c·∫•u h√¨nh',
    `is_encrypted` BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'C√≥ c·∫ßn m√£ h√≥a kh√¥ng',
    `is_editable`  BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'C√≥ th·ªÉ ch·ªânh s·ª≠a kh√¥ng',
    `updated_by`   BIGINT       NULL COMMENT 'Ng∆∞·ªùi c·∫≠p nh·∫≠t cu·ªëi',
    `updated_at`   TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    INDEX `idx_config_key` (`config_key`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='C·∫•u h√¨nh h·ªá th·ªëng';
INSERT INTO system_config (config_key, config_value, config_type, description)
VALUES ('SYSTEM_NAME', 'EInvoiceHub', 'STRING', 'T√™n hi·ªÉn th·ªã c·ªßa h·ªá th·ªëng'),
       ('INVOICE_EXPIRY_DAYS', '30', 'NUMBER', 'S·ªë ng√†y h√≥a ƒë∆°n c√≥ hi·ªáu l·ª±c sau khi ph√°t h√†nh'),
       ('MAX_RETRY_ATTEMPTS', '3', 'NUMBER', 'S·ªë l·∫ßn th·ª≠ l·∫°i khi g·ªçi Provider th·∫•t b·∫°i'),
       ('RETRY_DELAY_MS', '1000', 'NUMBER', 'Th·ªùi gian ch·ªù gi·ªØa c√°c l·∫ßn th·ª≠ l·∫°i (milliseconds)'),
       ('SESSION_TIMEOUT_MINUTES', '60', 'NUMBER', 'Th·ªùi gian timeout c·ªßa session'),
       ('PASSWORD_MIN_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i t·ªëi thi·ªÉu c·ªßa m·∫≠t kh·∫©u'),
       ('API_KEY_PREFIX_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i prefix hi·ªÉn th·ªã c·ªßa API Key'),
       ('DEFAULT_CURRENCY', 'VND', 'STRING', 'ƒê∆°n v·ªã ti·ªÅn t·ªá m·∫∑c ƒë·ªãnh'),
       ('TAX_DEFAULT_RATE', '10.00', 'NUMBER', 'Thu·∫ø su·∫•t m·∫∑c ƒë·ªãnh (%)'),
       ('BACKGROUND_JOB_ENABLED', 'true', 'BOOLEAN', 'K√≠ch ho·∫°t x·ª≠ l√Ω background jobs'),
       ('INVOICE_LOOKUP_CODE_LENGTH', '6', 'NUMBER', 'ƒê·ªô d√†i m√£ tra c·ª©u h√≥a ƒë∆°n ng·∫´u nhi√™n');

-- SECTION 4: SYSTEM VIEWS
-- View for user authorization
CREATE OR REPLACE VIEW `vw_sys_user_author` AS
SELECT CAST(id AS CHAR) AS id,
       username         AS name,
       full_name        AS full_name
FROM merchant_user
WHERE is_active = TRUE;

SET FOREIGN_KEY_CHECKS = 1;










-- SCHEMA SUMMARY
/*
Architecture Overview:
======================

CORE JPA TABLES (9 tables - Hierarchical Flow):
-------------------------------------------------
1. merchants              -> Root entity (contains Shell fields: subscription_plan, invoice_quota, updated_at)
2. merchant_user         -> Child of merchants
3. merchant_provider_configs -> Child of merchants (contains Shell fields: is_test_mode, encrypted_password_storage)
4. invoice_template      -> Child of merchants
5. invoice_registrations -> Child of merchants
6. invoice_metadata      -> Central transaction (contains Shell fields: lookup_code, cqt_code, provider_transaction_id)
7. invoice_items         -> Child of invoice_metadata
8. invoice_tax_breakdowns -> Child of invoice_metadata
9. invoice_adjustments   -> Related to invoice_metadata

ENTERPRISE SHELL MODULES (Management Tables):
----------------------------------------------
- invoice_payloads       -> One-to-One with invoice_metadata
- api_credentials        -> INDEX-based (decoupled)
- audit_logs             -> INDEX-based (high-performance)
- invoice_sync_queue     -> Background processing
- tax_authority_responses -> External system integration
- system_config          -> Key-value configuration

Data Flow (Hierarchical - No Reverse Dependencies):
---------------------------------------------------
Merchants -> ProviderConfigs -> Templates -> Invoices -> InvoiceItems
     |
     +-> Users
     +-> Registrations

Key Design Decisions:
---------------------
1. Flat Metadata Strategy: Buyer information stored directly in invoice_metadata
   to prevent circular dependencies when generating historical reports.

2. Hard FK for Core Relations: Ensures data integrity for business-critical
   relationships (Invoice->Items, Invoice->Template, etc.)

3. INDEX for Auxiliary Tables: audit_logs and system_config use INDEX instead
   of FK to maintain high performance and prevent locking issues.

4. NULLABLE Shell Fields: All new enterprise fields are NULLABLE to maintain
   JPA compatibility with existing Spring Boot save() methods.

5. DECIMAL(18,2): Used for all monetary values to ensure precision.

6. utf8mb4_unicode_ci: Full Unicode support including emojis.
*/
</file>

<file path="src/main/resources/application-dev.yaml">
# Development Profile - Optimized for Hybrid Workflow (IDE + Docker DB)
spring:
  datasource:
    url: jdbc:mariadb://localhost:3306/einvoicehub?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
    username: einvoice_user
    password: einvoice_pass
    driver-class-name: org.mariadb.jdbc.Driver

  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        highlight_sql: true

  flyway:
    enabled: true
    clean-disabled: false

app:
  encryption:
    secret-key: "dev-secret-key-32-chars-long-abc"
  jwt:
    secret: "dev-jwt-secret-key-very-long-and-secure-for-testing"
    expiration-ms: 36000000

  provider:
    bkav:
      base-url: https://demo.ehoadon.vn/api/v1
    misa:
      base-url: https://testapi.meinvoice.vn/api/integration

logging:
  level:
    com.einvoicehub: DEBUG
    org.springframework.security: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.orm.results: TRACE
</file>

<file path="src/main/resources/application.yaml">
spring:
  threads:
    virtual:
      enabled: true

  application:
    name: einvoice-core

  # =============================================================================
  # MariaDB Database Configuration
  # =============================================================================
  datasource:
    url: jdbc:mariadb://localhost:3306/einvoicehub?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
    username: root
    password: ${DB_PASSWORD:root}
    driver-class-name: org.mariadb.jdbc.Driver

    hikari:
      minimum-idle: 5
      maximum-pool-size: 20
      idle-timeout: 300000
      max-lifetime: 1200000
      connection-timeout: 20000

  # JPA/Hibernate Configuration - S·ª≠ d·ª•ng MariaDBDialect
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.MariaDBDialect
        jdbc:
          batch_size: 50
        order_inserts: true
        order_updates: true

  # =============================================================================
  # Flyway Migration
  # =============================================================================
  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true
    validate-on-migrate: true
    baseline-version: 0
    out-of-order: false

# Server Configuration
server:
  port: 8080
  servlet:
    context-path: /api

# Application Custom Properties
app:
  # Encryption
  encryption:
    secret-key: ${ENCRYPTION_SECRET_KEY: CH∆ØA C√ì!}

  # JWT Configuration
  jwt:
    secret: ${JWT_SECRET: CH∆ØA C√ì!}
    expiration-ms: 86400000  # 24 hours

  # API Key Configuration
  api-key:
    prefix-length: 8
    default-rate-limit-per-hour: 1000
    default-rate-limit-per-day: 10000

  # Provider Configuration
  provider:
    default-timeout-ms: 30000
    max-retry-attempts: 3
    retry-delay-ms: 1000
    vnpt:
      base-url: https://api.vnptinvoice.com.vn/v1
      timeout-ms: 30000
    viettel:
      base-url: https://ebill.vietteltelecom.vn/api/v1
      timeout-ms: 30000
    bkav:
      base-url: https://einvoice.bkav.com/api/v1
      test-base-url: https://demo.ehoadon.vn/api/v1
      timeout-ms: 30000
      encryption-key: ${BKAV_ENCRYPTION_KEY: CH∆ØA C√ì }  # AES-256 key t·ª´ BKAV
    misa:
      base-url: https://api.meinvoice.vn/api/integration
      test-base-url: https://testapi.meinvoice.vn/api/integration
      timeout-ms: 30000

# Logging Configuration
logging:
  level:
    root: INFO
    com.einvoicehub: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# Management/Actuator
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
</file>

<file path="src/test/java/com/einvoicehub/core/EinvoiceCoreApplicationTests.java">
package com.einvoicehub.core;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class EinvoiceCoreApplicationTests {

	@Test
	void contextLoads() {
	}

}
</file>

<file path="terraform/main.tf">
# EInvoiceHub Infrastructure as Code (Terraform)

terraform {
  required_version = ">= 1.5.0"

  required_providers {
    kubernetes = {
      source  = "hashicorp/kubernetes"
      version = "~> 2.24"
    }

    helm = {
      source  = "hashicorp/helm"
      version = "~> 2.12"
    }

    random = {
      source  = "hashicorp/random"
      version = "~> 3.6"
    }

    kubectl = {
      source  = "gavinbunney/kubectl"
      version = "~> 1.14"
    }
  }

  # Configure backend (modify for production)
  backend "local" {
    path = "terraform.tfstate"
  }
}

# Kubernetes Provider Configuration

provider "kubernetes" {
  config_path    = "~/.kube/config"
  config_context = var.kubernetes_context
}

provider "helm" {
  kubernetes {
    config_path    = "~/.kube/config"
    config_context = var.kubernetes_context
  }
}

provider "kubectl" {
  config_path    = "~/.kube/config"
  config_context = var.kubernetes_context
}

# Random Resources for Password Generation

resource "random_string" "mysql_password" {
  length  = 32
  special = false
}

resource "random_string" "mongodb_password" {
  length  = 32
  special = false
}

resource "random_string" "redis_password" {
  length  = 32
  special = false
}

resource "random_string" "grafana_password" {
  length  = 32
  special = false
}

resource "random_id" "session_id" {
  byte_length = 4
}

# Namespace Creation

resource "kubernetes_namespace" "einvoice_namespace" {
  metadata {
    name        = var.namespace
    labels = {
      environment = var.environment
      project     = "einvoicehub"
      managed_by  = "terraform"
    }
  }
}

# ConfigMap for Application Configuration

resource "kubernetes_config_map" "app_config" {
  metadata {
    name      = "${var.app_name}-config"
    namespace = kubernetes_namespace.einvoice_namespace.metadata[0].name
    labels = {
      app = var.app_name
    }
  }

  data = {
    # Application Settings
    APP_NAME                = var.app_name
    APP_VERSION             = var.app_version
    SERVER_PORT             = var.server_port
    SPRING_PROFILES_ACTIVE  = var.environment

    # Logging Configuration
    LOG_LEVEL               = var.log_level
    LOG_FORMAT              = "json"

    # Database Configuration (placeholders - use secrets for actual values)
    SPRING_DATASOURCE_URL   = "jdbc:mysql://${var.mysql_host}:${var.mysql_port}/${var.mysql_database}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC"
    SPRING_JPA_HIBERNATE_DDL_AUTO = "update"

    # MongoDB Configuration
    SPRING_DATA_MONGODB_URI = "mongodb://${var.mongo_host}:${var.mongo_port}/${var.mongo_database}?authSource=admin"

    # Redis Configuration
    SPRING_REDIS_HOST       = var.redis_host
    SPRING_REDIS_PORT       = var.redis_port

    # Actuator Endpoints
    MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE = "health,info,metrics,prometheus"
    MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS    = "when_authorized"

    # Virtual Threads (Java 21)
    JAVA_THREADS_VIRTUAL_ENABLED = "true"
  }
}

# Secrets for Sensitive Data
resource "kubernetes_secret" "database_secrets" {
  metadata {
    name      = "${var.app_name}-db-secrets"
    namespace = kubernetes_namespace.einvoice_namespace.metadata[0].name
    labels = {
      app = var.app_name
    }
  }

  type = "Opaque"

  data = {
    # Base64 encoded values
    SPRING_DATASOURCE_USERNAME = base64encode(var.mysql_username)
    SPRING_DATASOURCE_PASSWORD = base64encode(random_string.mysql_password.result)
    SPRING_DATA_MONGODB_USERNAME = base64encode(var.mongo_username)
    SPRING_DATA_MONGODB_PASSWORD = base64encode(random_string.mongodb_password.result)
    SPRING_REDIS_PASSWORD = base64encode(random_string.redis_password.result)
  }
}

resource "kubernetes_secret" "api_secrets" {
  metadata {
    name      = "${var.app_name}-api-secrets"
    namespace = kubernetes_namespace.einvoice_namespace.metadata[0].name
    labels = {
      app = var.app_name
    }
  }

  type = "Opaque"

  data = {
    # API Key encryption key (should be rotated regularly)
    ENCRYPTION_KEY_AES256 = base64encode(var.encryption_key)
    ENCRYPTION_KEY_IV     = base64encode(var.encryption_iv)

    # JWT Configuration
    JWT_SECRET_KEY        = base64encode(var.jwt_secret)
    JWT_EXPIRATION_MS     = base64encode(var.jwt_expiration_ms)
  }
}

resource "kubernetes_secret" "provider_secrets" {
  metadata {
    name      = "${var.app_name}-provider-secrets"
    namespace = kubernetes_namespace.einvoice_namespace.metadata[0].name
    labels = {
      app = var.app_name
    }
  }

  type = "Opaque"

  data = {
    # Provider-specific API keys (encrypted)
    VIETTEL_API_KEY      = base64encode(var.viettel_api_key)
    VIETTEL_CLIENT_ID    = base64encode(var.viettel_client_id)

    BKAV_API_KEY         = base64encode(var.bkav_api_key)
    BKAV_CLIENT_ID       = base64encode(var.bkav_client_id)

    MISA_API_KEY         = base64encode(var.misa_api_key)
    MISA_CLIENT_ID       = base64encode(var.misa_client_id)
    MISA_CLIENT_SECRET   = base64encode(var.misa_client_secret)
  }
}

# =============================================================================
# Resource Quotas
# =============================================================================

resource "kubernetes_resource_quota" "namespace_quota" {
  metadata {
    name      = "${var.app_name}-quota"
    namespace = kubernetes_namespace.einvoice_namespace.metadata[0].name
  }

  spec {
    hard = {
      "limits.cpu"    = var.resource_quota.cpu_limit
      "limits.memory" = var.resource_quota.memory_limit
      "pods"          = "20"
      "services"      = "10"
      "secrets"       = "20"
      "configmaps"    = "20"
      "persistentvolumeclaims" = "10"
    }
  }
}

# Limit Ranges

resource "kubernetes_limit_range" "namespace_limits" {
  metadata {
    name      = "${var.app_name}-limits"
    namespace = kubernetes_namespace.einvoice_namespace.metadata[0].name
  }

  spec {
    limit {
      type = "Container"

      default_request = {
        cpu    = var.limit_range.cpu_request
        memory = var.limit_range.memory_request
      }

      default = {
        cpu    = var.limit_range.cpu_limit
        memory = var.limit_range.memory_limit
      }

      min = {
        cpu    = var.limit_range.cpu_min
        memory = var.limit_range.memory_min
      }

      max = {
        cpu    = var.limit_range.cpu_max
        memory = var.limit_range.memory_max
      }
    }
  }
}

# Network Policy

resource "kubernetes_network_policy" "einvoice_network_policy" {
  metadata {
    name      = "${var.app_name}-network-policy"
    namespace = kubernetes_namespace.einvoice_namespace.metadata[0].name
  }

  spec {
    pod_selector {
      match_labels = {
        app = var.app_name
      }
    }

    policy_types = ["Ingress", "Egress"]

    ingress {
      from {
        namespace_selector {
          match_labels = {
            name = "ingress-nginx"
          }
        }
      }

      from {
        pod_selector {
          match_labels = {
            app = var.app_name
          }
        }
      }

      ports {
        protocol = "TCP"
        port     = var.server_port
      }

      ports {
        protocol = "TCP"
        port     = 9090
      }
    }

    egress {
      # Allow DNS resolution
      to {
        namespace_selector {
          match_labels = {
            name = "kube-system"
          }
        }
      }

      # Allow traffic to MySQL
      to {
        pod_selector {
          match_labels = {
            tier = "database"
          }
        }
        ports {
          protocol = "TCP"
          port     = 3306
        }
      }

      # Allow traffic to MongoDB
      to {
        pod_selector {
          match_labels = {
            tier = "database"
          }
        }
        ports {
          protocol = "TCP"
          port     = 27017
        }
      }

      # Allow traffic to Redis
      to {
        pod_selector {
          match_labels = {
            tier = "cache"
          }
        }
        ports {
          protocol = "TCP"
          port     = 6379
        }
      }

      # Allow external API calls
      to {
        ip_block {
          cidr = "0.0.0.0/0"
          except = [
            "10.0.0.0/8",
            "172.16.0.0/12",
            "192.168.0.0/16"
          ]
        }
      }
    }
  }
}
</file>

<file path="terraform/outputs.tf">
# EInvoiceHub Terraform Outputs
output "namespace_name" {
  description = "Kubernetes namespace name"
  value       = kubernetes_namespace.einvoice_namespace.metadata[0].name
}

output "namespace_creation_timestamp" {
  description = "Namespace creation timestamp"
  value       = kubernetes_namespace.einvoice_namespace.metadata[0].creation_timestamp
}

# Application Configuration Outputs
output "app_name" {
  description = "Application name"
  value       = var.app_name
}

output "app_version" {
  description = "Application version"
  value       = var.app_version
}

output "environment" {
  description = "Deployment environment"
  value       = var.environment
}

output "server_port" {
  description = "Application server port"
  value       = var.server_port
}

# Resource Outputs
output "replica_count" {
  description = "Number of pod replicas configured"
  value       = var.replicas
}

output "cpu_limit" {
  description = "CPU limit per pod"
  value       = var.limit_range.cpu_limit
}

output "memory_limit" {
  description = "Memory limit per pod"
  value       = var.limit_range.memory_limit
}

# Database Configuration Outputs

output "mysql_host" {
  description = "MySQL hostname"
  value       = var.mysql_host
}

output "mysql_port" {
  description = "MySQL port"
  value       = var.mysql_port
}

output "mysql_database" {
  description = "MySQL database name"
  value       = var.mysql_database
}

output "mongodb_uri" {
  description = "MongoDB connection URI"
  value       = "mongodb://${var.mongo_host}:${var.mongo_port}/${var.mongo_database}"
  sensitive   = false
}

output "redis_host" {
  description = "Redis hostname"
  value       = var.redis_host
}

output "redis_port" {
  description = "Redis port"
  value       = var.redis_port
}

# Secret Names (not values)
output "database_secret_name" {
  description = "Kubernetes secret name for database credentials"
  value       = kubernetes_secret.database_secrets.metadata[0].name
}

output "api_secret_name" {
  description = "Kubernetes secret name for API credentials"
  value       = kubernetes_secret.api_secrets.metadata[0].name
}

output "provider_secret_name" {
  description = "Kubernetes secret name for provider credentials"
  value       = kubernetes_secret.provider_secrets.metadata[0].name
}

output "configmap_name" {
  description = "Kubernetes ConfigMap name for application configuration"
  value       = kubernetes_config_map.app_config.metadata[0].name
}

# Network Policy Outputs
output "network_policy_name" {
  description = "Kubernetes NetworkPolicy name"
  value       = kubernetes_network_policy.einvoice_network_policy.metadata[0].name
}

# Resource Quota Outputs
output "resource_quota_name" {
  description = "ResourceQuota name"
  value       = kubernetes_resource_quota.namespace_quota.metadata[0].name
}

# Connection Information
output "application_url" {
  description = "Application URL (if ingress is enabled)"
  value       = var.ingress_enabled ? "http://${var.ingress_host}" : "http://localhost:${var.server_port}"
}

output "health_endpoint" {
  description = "Application health check endpoint"
  value       = var.ingress_enabled ? "http://${var.ingress_host}/actuator/health" : "http://localhost:${var.server_port}/actuator/health"
}

output "metrics_endpoint" {
  description = "Prometheus metrics endpoint"
  value       = var.ingress_enabled ? "http://${var.ingress_host}/actuator/prometheus" : "http://localhost:${var.server_port}/actuator/prometheus"
}

# Monitoring Endpoints (if enabled)
output "grafana_url" {
  description = "Grafana dashboard URL"
  value       = var.monitoring_enabled ? "http://${var.ingress_host}:3000" : "Grafana not enabled"
}

output "prometheus_url" {
  description = "Prometheus URL"
  value       = var.monitoring_enabled ? "http://${var.ingress_host}:9090" : "Prometheus not enabled"
}

output "jaeger_url" {
  description = "Jaeger tracing UI URL"
  value       = var.tracing_enabled ? "http://${var.ingress_host}:16686" : "Jaeger not enabled"
}

# Kubernetes Context Information
output "kubernetes_context" {
  description = "Kubernetes context used"
  value       = var.kubernetes_context
}

output "kubectl_command" {
  description = "Example kubectl command to access the application"
  value       = "kubectl port-forward -n ${kubernetes_namespace.einvoice_namespace.metadata[0].name} svc/${var.app_name} ${var.server_port}:${var.server_port}"
}

# Image Information
output "image_repository" {
  description = "Container image repository"
  value       = var.image_repository
}

output "image_tag" {
  description = "Container image tag"
  value       = var.image_tag
}

output "full_image_name" {
  description = "Full container image name with tag"
  value       = "${var.image_repository}:${var.image_tag}"
}

# Autoscaling Information
output "hpa_min_replicas" {
  description = "HPA minimum replicas"
  value       = var.autoscaling.min_replicas
}

output "hpa_max_replicas" {
  description = "HPA maximum replicas"
  value       = var.autoscaling.max_replicas
}

output "hpa_cpu_target" {
  description = "HPA CPU target utilization percentage"
  value       = var.autoscaling.cpu_target
}

output "hpa_memory_target" {
  description = "HPA memory target utilization percentage"
  value       = var.autoscaling.memory_target
}

# Security Information

output "encryption_enabled" {
  description = "Whether encryption is enabled"
  value       = var.encryption_key != ""
}

output "tls_enabled" {
  description = "Whether TLS is enabled"
  value       = var.tls_enabled
}

output "ingress_enabled" {
  description = "Whether ingress is enabled"
  value       = var.ingress_enabled
}

# Provider Information

output "providers_configured" {
  description = "List of invoice providers configured"
  value       = ["viettel", "bkav", "misa", "vnpt"]
}

# Summary Message

output "deployment_summary" {
  description = "Summary of deployment configuration"
  value       = <<-EOT
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                  EInvoiceHub Deployment Summary                   ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë Application: ${var.app_name} v${var.app_version}
‚ïë Environment: ${var.environment}
‚ïë Namespace: ${kubernetes_namespace.einvoice_namespace.metadata[0].name}
‚ïë Replicas: ${var.replicas}
‚ïë
‚ïë Database: ${var.mysql_host}:${var.mysql_port}/${var.mysql_database}
‚ïë Cache: ${var.redis_host}:${var.redis_port}
‚ïë MongoDB: ${var.mongo_host}:${var.mongo_port}/${var.mongo_database}
‚ïë
‚ïë Access: ${var.ingress_enabled ? "http://${var.ingress_host}" : "http://localhost:${var.server_port}"}
‚ïë Health: ${var.ingress_enabled ? "http://${var.ingress_host}/actuator/health" : "http://localhost:${var.server_port}/actuator/health"}
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOT
}
</file>

<file path="terraform/variables.tf">
# EInvoiceHub Terraform Variables

# Environment Configuration

variable "environment" {
  description = "Deployment environment (dev, staging, prod)"
  type        = string
  default     = "dev"
}

variable "app_name" {
  description = "Application name"
  type        = string
  default     = "einvoicehub"
}

variable "app_version" {
  description = "Application version"
  type        = string
  default     = "1.0.0"
}

# Kubernetes Configuration

variable "kubernetes_context" {
  description = "Kubernetes context to use"
  type        = string
  default     = "k3d-einvoice"
}

variable "namespace" {
  description = "Kubernetes namespace"
  type        = string
  default     = "einvoice-dev"
}

variable "replicas" {
  description = "Number of pod replicas"
  type        = number
  default     = 2
}

variable "server_port" {
  description = "Application server port"
  type        = number
  default     = 8080
}

# Resource Configuration

variable "resource_quota" {
  description = "Resource quota configuration"
  type = object({
    cpu_limit    = string
    memory_limit = string
  })
  default = {
    cpu_limit    = "8"
    memory_limit = "8Gi"
  }
}

variable "limit_range" {
  description = "Container limit range configuration"
  type = object({
    cpu_request  = string
    memory_request = string
    cpu_limit    = string
    memory_limit = string
    cpu_min      = string
    memory_min   = string
    cpu_max      = string
    memory_max   = string
  })
  default = {
    cpu_request    = "250m"
    memory_request = "256Mi"
    cpu_limit      = "1000m"
    memory_limit   = "1Gi"
    cpu_min        = "100m"
    memory_min     = "128Mi"
    cpu_max        = "2000m"
    memory_max     = "2Gi"
  }
}

variable "autoscaling" {
  description = "Horizontal Pod Autoscaler configuration"
  type = object({
    min_replicas = number
    max_replicas = number
    cpu_target   = number
    memory_target = number
  })
  default = {
    min_replicas = 2
    max_replicas = 10
    cpu_target   = 70
    memory_target = 80
  }
}

# Logging Configuration

variable "log_level" {
  description = "Application log level"
  type        = string
  default     = "INFO"
}

# Database Configuration (for ConfigMap - use secrets for actual values)

variable "mysql_host" {
  description = "MySQL hostname"
  type        = string
  default     = "mysql"
}

variable "mysql_port" {
  description = "MySQL port"
  type        = number
  default     = 3306
}

variable "mysql_database" {
  description = "MySQL database name"
  type        = string
  default     = "einvoicehub"
}

variable "mysql_username" {
  description = "MySQL username"
  type        = string
  default     = "einvoice_user"
}

# MongoDB Configuration

variable "mongo_host" {
  description = "MongoDB hostname"
  type        = string
  default     = "mongodb"
}

variable "mongo_port" {
  description = "MongoDB port"
  type        = number
  default     = 27017
}

variable "mongo_database" {
  description = "MongoDB database name"
  type        = string
  default     = "einvoicehub"
}

variable "mongo_username" {
  description = "MongoDB username"
  type        = string
  default     = "admin"
}

# Redis Configuration

variable "redis_host" {
  description = "Redis hostname"
  type        = string
  default     = "redis"
}

variable "redis_port" {
  description = "Redis port"
  type        = number
  default     = 6379
}

# Security Variables (use environment variables or secret management)

variable "encryption_key" {
  description = "AES-256 encryption key (32 bytes)"
  type        = string
  default     = ""
  sensitive   = true
}

variable "encryption_iv" {
  description = "AES encryption initialization vector (16 bytes)"
  type        = string
  default     = ""
  sensitive   = true
}

variable "jwt_secret" {
  description = "JWT secret key"
  type        = string
  default     = ""
  sensitive   = true
}

variable "jwt_expiration_ms" {
  description = "JWT expiration time in milliseconds"
  type        = string
  default     = "86400000"
}

# Provider API Credentials (use secrets for actual values)

variable "viettel_api_key" {
  description = "Viettel API Key"
  type        = string
  default     = ""
  sensitive   = true
}

variable "viettel_client_id" {
  description = "Viettel Client ID"
  type        = string
  default     = ""
  sensitive   = true
}

variable "bkav_api_key" {
  description = "BKAV API Key"
  type        = string
  default     = ""
  sensitive   = true
}

variable "bkav_client_id" {
  description = "BKAV Client ID"
  type        = string
  default     = ""
  sensitive   = true
}

variable "misa_api_key" {
  description = "MISA API Key"
  type        = string
  default     = ""
  sensitive   = true
}

variable "misa_client_id" {
  description = "MISA Client ID"
  type        = string
  default     = ""
  sensitive   = true
}

variable "misa_client_secret" {
  description = "MISA Client Secret"
  type        = string
  default     = ""
  sensitive   = true
}

# Image Configuration

variable "image_repository" {
  description = "Container image repository"
  type        = string
  default     = "einvoicehub/backend"
}

variable "image_tag" {
  description = "Container image tag"
  type        = string
  default     = "latest"
}

variable "image_pull_policy" {
  description = "Image pull policy (Always, Never, IfNotPresent)"
  type        = string
  default     = "IfNotPresent"
}

# Persistence Configuration

variable "persistence" {
  description = "Persistence configuration"
  type = object({
    enabled  = bool
    size     = string
    storage  = string
  })
  default = {
    enabled  = true
    size     = "10Gi"
    storage  = "standard"
  }
}

# Monitoring Configuration

variable "monitoring_enabled" {
  description = "Enable monitoring stack"
  type        = bool
  default     = true
}

variable "metrics_port" {
  description = "Port for Prometheus metrics"
  type        = number
  default     = 9090
}

# Tracing Configuration

variable "tracing_enabled" {
  description = "Enable distributed tracing"
  type        = bool
  default     = true
}

variable "jaeger_endpoint" {
  description = "Jaeger collector endpoint"
  type        = string
  default     = "http://jaeger:4317"
}

# Ingress Configuration

variable "ingress_enabled" {
  description = "Enable ingress controller"
  type        = bool
  default     = true
}

variable "ingress_host" {
  description = "Ingress hostname"
  type        = string
  default     = "einvoice.local"
}

variable "ingress_class" {
  description = "Ingress class name"
  type        = string
  default     = "nginx"
}

# Certificate Configuration

variable "tls_enabled" {
  description = "Enable TLS for ingress"
  type        = bool
  default     = false
}

variable "tls_secret_name" {
  description = "TLS secret name"
  type        = string
  default     = "einvoice-tls"
}
</file>

<file path=".gitattributes">
/mvnw text eol=lf
*.cmd text eol=crlf
</file>

<file path=".gitignore">
HELP.md
target/
.mvn/wrapper/maven-wrapper.jar
!**/src/main/**/target/
!**/src/test/**/target/

### STS ###
.apt_generated
.classpath
.factorypath
.project
.settings
.springBeans
.sts4-cache

### IntelliJ IDEA ###
.idea
*.iws
*.iml
*.ipr

### NetBeans ###
/nbproject/private/
/nbbuild/
/dist/
/nbdist/
/.nb-gradle/
build/
!**/src/main/**/build/
!**/src/test/**/build/

### VS Code ###
.vscode/
/bin/
</file>

<file path="config.yaml">
spring:
  application:
    name: einvoicehub-core
    
  # MySQL Configuration
  datasource:
    url: jdbc:mysql://${DATABASE_HOST:localhost}:${DATABASE_PORT:3306}/${DATABASE_NAME:einvoicehub}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
    username: ${DATABASE_USERNAME:root}
    password: ${DATABASE_PASSWORD:password}
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      minimum-idle: 5
      maximum-pool-size: 20
      idle-timeout: 300000
      pool-name: EInvoiceHubHikariCP
      max-lifetime: 1200000
      connection-timeout: 20000
      register-mbeans: true
      
  # JPA Configuration
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQLDialect
        format_sql: true
        jdbc:
          time_zone: UTC
          
  # MongoDB Configuration
  data:
    mongodb:
      uri: mongodb://${MONGODB_USERNAME:admin}:${MONGODB_PASSWORD:password}@${MONGODB_HOST:localhost}:${MONGODB_PORT:27017}/${MONGODB_DATABASE:einvoicehub}?authSource=admin
      auto-index-creation: true
      
# Server Configuration
server:
  port: ${SERVER_PORT:8080}
  servlet:
    context-path: /api/v1
  tomcat:
    threads:
      max: 200
      min-spare: 10
    accept-count: 100
    max-connections: 10000
    
# Application Custom Configuration
app:
  name: EInvoiceHub
  version: 1.0.0
  
  # Virtual Threads Configuration
  virtual-threads:
    enabled: true
    
  # Security Configuration
  security:
    api-key:
      header-name: X-API-KEY
      client-id-header: X-CLIENT-ID
      
# Provider Configuration
providers:
  vnpt:
    base-url: ${VNPT_BASE_URL:https://api.vnpt-invoice.vn}
    timeout: 30000
    retry-count: 3
    
  viettel:
    base-url: ${VIETTEL_BASE_URL:https://einvoice.viettel.vn}
    timeout: 30000
    retry-count: 3
    
  bkav:
    base-url: ${BKAV_BASE_URL:https://bkav-invoice.com}
    timeout: 30000
    retry-count: 3
    encryption-key: ${BKAV_ENCRYPTION_KEY:your-256-bit-key}
    
  misa:
    base-url: ${MISA_BASE_URL:https://api.meinvoice.vn}
    timeout: 30000
    retry-count: 3
    app-id: ${MISA_APP_ID:your-app-id}
    
# Actuator & Monitoring
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: when-authorized
  metrics:
    tags:
      application: ${spring.application.name}
      
# Logging Configuration
logging:
  level:
    root: INFO
    com.einvoicehub: DEBUG
    org.springframework.security: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    
# OpenAPI Configuration
springdoc:
  api-docs:
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
    operations-sorter: method
    tags-sorter: alpha
  show-actuator: true
</file>

<file path="docker-compose.yml">
# Docker Compose configuration for EInvoiceHub local development environment
services:
  # MariaDB Database - Primary relational database
  mariadb:
    image: mariadb:10.11
    container_name: einvoice-mariadb
    hostname: mariadb
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD:-einvoice_root_pass}
      MARIADB_DATABASE: einvoicehub
      MARIADB_USER: einvoice_user
      MARIADB_PASSWORD: ${MARIADB_PASSWORD:-einvoice_pass}
    ports:
      - "3306:3306"
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./sql/init:/docker-entrypoint-initdb.d
      - ./sql/config/my.cnf:/etc/mysql/conf.d/my.cnf:ro
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "localhost", "-u", "root", "-p${MARIADB_ROOT_PASSWORD:-einvoice_root_pass}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - einvoice-network
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
  
  # Prometheus - Metrics collection
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: einvoice-prometheus
    hostname: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/rules:/etc/prometheus/rules:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
    networks:
      - einvoice-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  
  # Grafana - Metrics visualization 
  grafana:
    image: grafana/grafana:10.2.0
    container_name: einvoice-grafana
    hostname: grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-einvoice_grafana}
      - GF_USERS_ALLOW_SIGN_UP=false
    ports:
      - "3000:3000"
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards
      - grafana_data:/var/lib/grafana
    depends_on:
      prometheus:
        condition: service_started
    networks:
      - einvoice-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  
  # EInvoiceHub Application - Main backend service
  backend:
    build:
      context: .
      dockerfile: dockerfile-temp.txt
      target: runtime
    container_name: einvoice-backend
    hostname: backend
    ports:
      - "8080:8080"
      - "5005:5005"
    environment:
      # Spring Boot Configuration
      - SPRING_PROFILES_ACTIVE=dev
      - SERVER_PORT=8080

      # Database Configuration - Thay ƒë·ªïi sang MariaDB
      - SPRING_DATASOURCE_URL=jdbc:mariadb://mariadb:3306/einvoicehub?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      - SPRING_DATASOURCE_USERNAME=einvoice_user
      - SPRING_DATASOURCE_PASSWORD=einvoice_pass
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update

      # Application Specific
      - APP_NAME=einvoicehub
      - LOG_LEVEL=INFO

      # Java VM Options
      - JAVA_OPTS=-XX:+UseG1GC -XX:MaxGCPauseMillis=200 -Xms256m -Xmx512m
    depends_on:
      mariadb:
        condition: service_healthy
    volumes:
      - ./logs:/app/logs:rw
      - ./config:/app/config:ro
    networks:
      - einvoice-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    restart: unless-stopped


# Networks Configuration
networks:
  einvoice-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16


# Volumes Configuration
volumes:
  mariadb_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
</file>

<file path="Dockerfile">
# Stage 1: Builder Stage
FROM maven:3.9.6-eclipse-temurin-21-alpine AS builder
WORKDIR /build

COPY pom.xml .

RUN --mount=type=cache,target=/root/.m2 mvn dependency:go-offline -B

COPY src ./src
RUN --mount=type=cache,target=/root/.m2 mvn clean package -DskipTests -B

FROM eclipse-temurin:21-jre-alpine AS runtime
LABEL maintainer="EInvoiceHub Team" \
      project="EInvoiceHub"
ENV JAVA_OPTS="-XX:+UseG1GC -XX:MaxRAMPercentage=75.0 -Djdk.tracePinnedThreads=short"

RUN addgroup -g 1000 appgroup && \
    adduser -u 1000 -G appgroup -s /bin/sh -D appuser

WORKDIR /app

COPY --from=builder /build/target/*.jar app.jar
RUN mkdir -p /app/logs && chown -R appuser:appgroup /app
USER appuser

EXPOSE 8080

HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
CMD ["--spring.profiles.active=prod"]


FROM builder AS dev
WORKDIR /build
EXPOSE 5005

ENV JAVA_TOOL_OPTIONS="-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005"
ENTRYPOINT ["mvn", "spring-boot:run", "-Dspring-boot.run.profiles=dev"]
</file>

<file path="dockerfile-temp.txt">
# Multi-stage Dockerfile for EInvoiceHub Spring Boot Application
# Optimized for Java 21 with Virtual Threads support



# Stage 1: Builder Stage - Compile and package the application
FROM maven:3.9-eclipse-temurin-21-alpine AS builder
# Set working directory
WORKDIR /build

# Copy pom.xml first for dependency caching
COPY pom.xml ./

# Download dependencies (this layer will be cached unless pom.xml changes)
RUN mvn dependency:go-offline -B

# Copy source code
COPY src ./src

# Build the application with Spring Boot thin launcher for smaller image
RUN mvn package -DskipTests -B


# Stage 2: Runtime Stage - Minimal JRE image for production

FROM eclipse-temurin:21-jre-alpine AS runtime

# Labels for container metadata
LABEL maintainer="EInvoiceHub Team" \
      version="1.0.0" \
      description="EInvoiceHub - Electronic Invoice Hub Service" \
      org.opencontainers.image.source="https://github.com/hkhuang07/EInvoiceHub-SpringBoot-Angular-GitOps-Kubernetes/tree/main/backend-springboot"

# Set environment variables
ENV JAVA_OPTS="-XX:+EnableDynamicAgentLoading -XX:+UseG1GC" \
    APP_NAME="einvoicehub" \
    APP_VERSION="1.0.0"

# Create non-root user for security
RUN addgroup -g 1000 appgroup && \
    adduser -u 1000 -G appgroup -s /bin/sh -D appuser

# Set working directory
WORKDIR /app

# Copy the built artifact from builder stage
COPY --from=builder /build/target/*.jar app.jar

# Create directories for logs and config
RUN mkdir -p /app/logs /app/config && \
    chown -R appuser:appgroup /app

# Switch to non-root user
USER appuser

# Expose application port (default Spring Boot port)
EXPOSE 8080

# Health check configuration
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1

# Entrypoint and CMD
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -Djava.security.egd=file:/dev/./urandom -jar /app/app.jar"]
CMD ["--spring.profiles.active=prod"]


# Stage 3: Development Stage - For local development with debug support

FROM builder AS dev

# Expose debug port
EXPOSE 5005

# Debug JVM options
ENV JAVA_TOOL_OPTIONS="-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005"

# Entrypoint for development with debug
ENTRYPOINT ["sh", "-c", "java $JAVA_TOOL_OPTIONS -Djava.security.egd=file:/dev/./urandom -jar /app/target/*.jar"]


# Alternative: Native Build Stage (Optional - for GraalVM)

# Uncomment this section and comment out the runtime stage for native image
# FROM ghcr.io/graalvm/native-image:21-ol8 AS native-builder

# WORKDIR /build
# COPY --from=builder /build/target/*.jar application.jar
# COPY --from=builder /build/src src

# RUN native-image \
#     -J-Xmx8g \
#     -H:Class=com.einvoicehub.EinvoicehubApplication \
#     -H:Name=einvoicehub-native \
#     -H:+ReportExceptionStackTraces \
#     --no-fallback \
#     -H:+StaticExecutableWithDynamicLibC \
#     -cp application.jar

# FROM ubuntu:22.04 AS native-runtime
# COPY --from=native-builder /build/einvoicehub-native /app/einvoicehub
# RUN chmod +x /app/einvoicehub
# EXPOSE 8080
# ENTRYPOINT ["/app/einvoicehub"]
</file>

<file path="einvoicehub-full-source.txt">
This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: **/*
- Files matching these patterns are excluded: **/bin/**, **/target/**, **/*.class, **/*.exe, **/*.jar, mvnw, mvnw.cmd, **/HELP.md, **/.git/**, **/.idea/**, **/.vscode/**, **/node_modules/**, **/dist/**
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.mvn/
  wrapper/
    maven-wrapper.properties
helm/
  einvoicehub/
    Chart.yaml
    values.yaml
kubernetes/
  deployment.yaml
  ingress.yaml
  service.yaml
monitoring/
  alertmanager/
    alertmanager.yml
  grafana/
    dashboards/
      einvoicehub/
        einvoicehub-overview.json
    provisioning/
      dashboards/
        default.yaml
      datasources/
        prometheus.yaml
  prometheus/
    prometheus.yml
sql/
  init/
    V1__Initial_Schema.sql
src/
  main/
    java/
      com/
        einvoicehub/
          core/
            config/
              SecurityConfig.java
              VirtualThreadConfig.java
              WebClientConfig.java
            converter/
              EncryptionConverter.java
              JsonAttributeConverter.java
            domain/
              entity/
                enums/
                  AdjustmentStatus.java
                  AdjustmentType.java
                  AuditAction.java
                  IssuanceMethod.java
                  SubscriptionPlan.java
                  SyncStatus.java
                  SyncType.java
                  UserRole.java
                EinvApiCredentialsEntity.java
                EinvAuditLogsEntity.java
                EinvInvoiceAdjustmentsEntity.java
                EinvInvoiceItemEntity.java
                EinvInvoiceMetadataEntity.java
                EinvInvoicePayloadEntity.java
                EinvInvoiceRegistrationEntity.java
                EinvInvoiceStatusEntity.java
                EinvInvoiceSyncQueueEntity.java
                EinvInvoiceTaxBreakDownEntity.java
                EinvInvoiceTemplateEntity.java
                EinvInvoiceTypeEntity.java
                EinvMerchantEntity.java
                EinvMerchantProviderConfigEntity.java
                EinvMerchantUserEntity.java
                EinvPaymentMethodEntity.java
                EinvRegistrationStatusEntity.java
                EinvServiceProviderEntity.java
                EinvSystemConfigEntity.java
                EinvTaxAuthorityResponseEntity.java
                EinvUserAuthorEntity.java
                EinvVatRateEntity.java
              repository/
                EinvApiCredentialRepository.java
                EinvAuditLogRepository.java
                EinvInvoiceAdjustmentRepository.java
                EinvInvoiceItemRepository.java
                EinvInvoiceMetadataRepository.java
                EinvInvoicePayloadRepository.java
                EinvInvoiceRegistrationRepository.java
                EinvInvoiceStatusRepository.java
                EinvInvoiceSyncQueueRepository.java
                EinvInvoiceTaxBreakdownRepository.java
                EinvInvoiceTemplateRepository.java
                EinvInvoiceTypeRepository.java
                EinvMerchantProviderConfigRepository.java
                EinvMerchantRepository.java
                EinvMerchantUserRepository.java
                EinvPaymentMethodRepository.java
                EinvRegistrationStatusRepository.java
                EinvServiceProviderRepository.java
                EinvSystemConfigRepository.java
                EinvTaxAuthorityResponseRepository.java
                EinvVatRateRepository.java
            dto/
              request/
                EinvInvoiceAdjustmentRequest.java
                EinvSubmitInvoiceDetailRequest.java
                EinvSubmitInvoiceRequest.java
              response/
                EinvAuditLogResponse.java
                EinvInvoiceAdjustmentResponse.java
                EinvInvoiceMetadataResponse.java
                EinvInvoiceSyncQueueResponse.java
              ApiResponse.java
              EinvApiCredentialDto.java
              EinvInvoiceItemDto.java
              EinvInvoicePayloadDto.java
              EinvInvoiceRegistrationRequest.java
              EinvInvoiceRegistrationResponse.java
              EinvInvoiceStatusDto.java
              EinvInvoiceTaxBreakdownDto.java
              EinvInvoiceTemplateRequest.java
              EinvInvoiceTemplateResponse.java
              EinvInvoiceTypeDto.java
              EinvMerchantProviderConfigRequest.java
              EinvMerchantProviderConfigResponse.java
              EinvMerchantRequest.java
              EinvMerchantResponse.java
              EinvMerchantUserRequest.java
              EinvMerchantUserResponse.java
              EinvoiceHubRequest.java
              EinvoiceHubResponse.java
              EinvPaymentMethodDto.java
              EinvRegistrationStatusDto.java
              EinvServiceProviderDto.java
              EinvSystemConfigDto.java
              EinvTaxAuthorityResponseDto.java
              EinvVatRateDto.java
              PaginationRequestDto.java
              PaginationResponseDto.java
            exception/
              AppException.java
              ErrorCode.java
              GlobalExceptionHandler.java
              InsufficientQuotaException.java
              InvalidDataException.java
              MerchantNotFoundException.java
            mapper/
              EinvHubMapper.java
            provider/
              bkav/
                BkavAdapter.java
                BkavApiMapper.java
              exception/
                ProviderException.java
              misa/
                MisaAdapter.java
                MisaApiMapper.java
              mobifone/
                constant/
                  MobifoneApiEndpoints.java
                  MobifoneInvoiceStatus.java
                mapper/
                  MobifoneDataMapper.java
                model/
                  MobifoneCancelInvoiceRequest.java
                  MobifoneInvoiceData.java
                  MobifoneInvoiceDetail.java
                  MobifoneInvoiceDetailWrapper.java
                  MobifoneInvoiceRequest.java
                  MobifoneInvoiceResponse.java
                  MobifoneLoginRequest.java
                  MobifoneLoginResponse.java
                MobifoneEInvoiceProvider.java
                MobifoneHttpClient.java
              model/
                InvoiceRequest.java
                InvoiceResponse.java
              viettel/
                ViettelAdapter.java
                ViettelApiMapper.java
              vnpt/
                VnptAdapter.java
                VnptApiMapper.java
              InvoiceProvider.java
              ProviderConfig.java
              ProviderFactory.java
            security/
              ApiKeyAuthenticationToken.java
              ApiKeyFilter.java
              JwtAuthenticationFilter.java
              JwtTokenProvider.java
              SecurityConfig.java
            service/
              EinvApiCredentialService.java
              EinvAuditLogService.java
              EinvInvoiceAdjustmentService.java
              EinvInvoiceItemService.java
              EinvInvoiceMetadataService.java
              EinvInvoicePayloadService.java
              EinvInvoiceRegistrationService.java
              EinvInvoiceStatusService.java
              EinvInvoiceSyncQueueService.java
              EinvInvoiceTaxBreakdownService.java
              EinvInvoiceTemplateService.java
              EinvInvoiceTypeService.java
              EinvMerchantProviderConfigService.java
              EinvMerchantService.java
              EinvMerchantUserService.java
              EinvPaymentMethodService.java
              EinvRegistrationStatusService.java
              EinvServiceProviderService.java
              EinvSystemConfigService.java
              EinvTaxAuthorityResponseService.java
              EinvVatRateService.java
            util/
              IdGenerator.java
            EinvoiceCoreApplication.java
    resources/
      db/
        migration/
          Initial_Schema_Ver01.sql
          Initial_Schema_Ver02.sql
          Initial_Schema_Ver03.sql
          Initial_Schema_Ver04.sql
          V1__Initial_Schema.sql
      application-dev.yaml
      application.yaml
  test/
    java/
      com/
        einvoicehub/
          core/
            EinvoiceCoreApplicationTests.java
terraform/
  main.tf
  outputs.tf
  variables.tf
.gitattributes
.gitignore
config.yaml
docker-compose.yml
Dockerfile
dockerfile-temp.txt
Jenkinsfile.txt
Makefile
pom.xml
purge-data.sh
repomix.config.json
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".mvn/wrapper/maven-wrapper.properties">
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.12/apache-maven-3.9.12-bin.zip
</file>

<file path="helm/einvoicehub/Chart.yaml">
# EInvoiceHub Helm Chart

apiVersion: v2
name: einvoicehub
description: A Helm chart for EInvoiceHub - Electronic Invoice Hub Service

# Application version
version: 1.0.0
appVersion: "1.0.0"

# Maintainers
maintainers:
  - name:  EInvoiceHub SoftZ
    email: softz@einvoicehub.io

# Dependencies
dependencies:
  - name: mysql
    version: "9.x.x"
    repository: "https://charts.bitnami.com/bitnami"
    condition: mysql.enabled
    alias: mysql

  - name: mongodb
    version: "13.x.x"
    repository: "https://charts.bitnami.com/bitnami"
    condition: mongodb.enabled
    alias: mongodb

  - name: redis
    version: "17.x.x"
    repository: "https://charts.bitnami.com/bitnami"
    condition: redis.enabled
    alias: redis

  - name: prometheus
    version: "45.x.x"
    repository: "https://prometheus-community.github.io/helm-charts"
    condition: prometheus.enabled
    alias: prometheus

  - name: grafana
    version: "6.x.x"
    repository: "https://grafana.github.io/helm-charts"
    condition: grafana.enabled
    alias: grafana

  - name: jaeger
    version: "0.x.x"
    repository: "https://jaegertracing.github.io/helm-charts"
    condition: jaeger.enabled
    alias: jaeger

# Keywords
keywords:
  - einvoicehub
  - electronic-invoice
  - invoicing
  - spring-boot
  - java
  - kubernetes

# Home page home: https://einvoicehub.io

# Icon icon: https://einvoicehub.io/logo.svg

# License
license: Apache-2.0

# Annotations
annotations:
  category: Application
  licenses: Apache-2.0
</file>

<file path="helm/einvoicehub/values.yaml">
# EInvoiceHub Helm Chart Values

# Global Settings

global:
  imageRegistry: registry.einvoicehub.io
  imagePullSecrets:
    - name: registry-credentials
  storageClass: standard
  timezone: Asia/Ho_Chi_Minh

# EInvoiceHub Application Configuration
replicaCount: 2

image:
  repository: einvoicehub/backend
  tag: 1.0.0
  pullPolicy: IfNotPresent

imagePullSecrets:
  - name: registry-credentials

nameOverride: ""
fullnameOverride: ""

# Service Account
serviceAccount:
  create: true
  name: einvoicehub
  annotations: {}

# Pod Security Context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000

# Container Security Context
securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

# Service Configuration
service:
  type: ClusterIP
  port: 80
  targetPort: 8080

# Ingress Configuration
ingress:
  enabled: true
  className: nginx
  hosts:
    - host: einvoice.local
      paths:
        - path: /api
          pathType: ImplementationSpecific
        - path: /actuator
          pathType: ImplementationSpecific
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"

# Resources Configuration
resources:
  requests:
    cpu: 250m
    memory: 256Mi
  limits:
    cpu: 1000m
    memory: 1Gi

# Autoscaling Configuration
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# Node Selection
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app: einvoicehub
          topologyKey: kubernetes.io/hostname

# Liveness Probe
livenessProbe:
  httpGet:
    path: /actuator/health/liveness
    port: http
  initialDelaySeconds: 60
  periodSeconds: 30
  timeoutSeconds: 10
  failureThreshold: 3
  successThreshold: 1

# Readiness Probe
readinessProbe:
  httpGet:
    path: /actuator/health/readiness
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

# Startup Probe
startupProbe:
  httpGet:
    path: /actuator/health
    port: http
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 30
  successThreshold: 1

# Application Environment Variables
env:
  # Application Settings
  APP_NAME: einvoicehub
  APP_VERSION: 1.0.0
  SPRING_PROFILES_ACTIVE: prod

  # Logging
  LOG_LEVEL: INFO
  LOG_FORMAT: json

  # JVM Options
  JAVA_OPTS: "-XX:+UseG1GC -XX:MaxGCPauseMillis=200 -Xms256m -Xmx512m"
  JAVA_THREADS_VIRTUAL_ENABLED: "true"

# Environment Variables from Secrets
envFrom:
  - configMapRef:
      name: einvoicehub-config
  - secretRef:
      name: einvoicehub-secrets
  - secretRef:
      name: einvoicehub-provider-secrets


# Database Configuration
mysql:
  enabled: true
  architecture: standalone
  auth:
    database: einvoicehub
    existingSecret: einvoicehub-mysql-secret
    secretKeys:
      rootPasswordKey: mysql-root-password
      userPasswordKey: mysql-password
  primary:
    persistence:
      enabled: true
      size: 10Gi
      storageClass: standard
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1Gi
    livenessProbe:
      enabled: true
      initialDelaySeconds: 120
    readinessProbe:
      enabled: true
      initialDelaySeconds: 30

mongodb:
  enabled: true
  architecture: standalone
  auth:
    database: einvoicehub
    existingSecret: einvoicehub-mongodb-secret
    secretKeys:
      mongodbPasswordKey: mongodb-password
      mongodbRootPasswordKey: mongodb-root-password
  persistence:
    enabled: true
    size: 10Gi
    storageClass: standard
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi

redis:
  enabled: true
  architecture: standalone
  auth:
    existingSecret: einvoicehub-redis-secret
    secretKeys:
      redisPasswordKey: redis-password
  master:
    persistence:
      enabled: false
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 256Mi

# Monitoring Configuration
prometheus:
  enabled: true
  prometheus:
    prometheusSpec:
      retention: 15d
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: standard
            resources:
              requests:
                storage: 20Gi
      ruleSelector:
        matchLabels:
          prometheus: einvoicehub
      serviceMonitorSelector:
        matchLabels:
          release: prometheus

grafana:
  enabled: true
  adminUser: admin
  adminPassword: einvoicehub_grafana_admin
  persistence:
    enabled: true
    storageClassName: standard
    size: 5Gi
  dashboardsProvider: true
  dashboardProviders:
    dashboardproviders.yaml:
      providers:
        - name: einvoicehub
          orgId: 1
          folder: EInvoiceHub
          type: file
          disableDeletion: false
          options:
            path: /var/lib/grafana/dashboards/einvoicehub
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          url: http://einvoicehub-prometheus:9090
          isDefault: true

jaeger:
  enabled: true
  collector:
    replicaCount: 1
    options:
      collector:
        zipkin:
          host-port: 9411
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
  query:
    replicaCount: 1
    options:
      query:
        base-path: /jaeger
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
  storage:
    type: memory

# Init Containers Configuration
initContainers:
  waitForMysql:
    enabled: true
    image: busybox:1.36
    resources:
      requests:
        cpu: 10m
        memory: 16Mi
      limits:
        cpu: 50m
        memory: 32Mi

  waitForMongodb:
    enabled: true
    image: busybox:1.36
    resources:
      requests:
        cpu: 10m
        memory: 16Mi
      limits:
        cpu: 50m
        memory: 32Mi

  waitForRedis:
    enabled: true
    image: busybox:1.36
    resources:
      requests:
        cpu: 10m
        memory: 16Mi
      limits:
        cpu: 50m
        memory: 32Mi

# Volume Configuration
volumes:
  logs:
    enabled: true
    type: emptyDir
  config:
    enabled: true
    type: configmap
    name: einvoicehub-config

# Topology Spread Configuration
topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: kubernetes.io/hostname
    whenUnsatisfiable: DoNotSchedule
    labelSelector:
      matchLabels:
        app: einvoicehub

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Network Policy
networkPolicy:
  enabled: true
  ingressRules:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - port: 8080
  egressRules:
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - port: 53
          protocol: UDP


# Rollout Strategy
rollingUpdate:
  maxSurge: 1
  maxUnavailable: 0


# Termination Grace Period
terminationGracePeriodSeconds: 30
</file>

<file path="kubernetes/ingress.yaml">
# EInvoiceHub Kubernetes Ingress Manifest

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: einvoicehub-ingress
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    version: v1
  annotations:
    # NGINX Ingress Controller Annotations
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"

    # Rate Limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"
    nginx.ingress.kubernetes.io/limit-connections: "50"

    # CORS Configuration
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "*"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "Content-Type, Authorization, X-API-KEY, X-CLIENT-ID"

    # Security Headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      add_header X-Frame-Options "SAMEORIGIN" always;
      add_header X-Content-Type-Options "nosniff" always;
      add_header X-XSS-Protection "1; mode=block" always;
      add_header Referrer-Policy "strict-origin-when-cross-origin" always;
      add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Custom Error Pages
    nginx.ingress.kubernetes.io/custom-http-errors: "404,500,503";

    # Rewrite Target for API
    nginx.ingress.kubernetes.io/rewrite-target: /$2

    # App Root
    nginx.ingress.kubernetes.io/app-root: "/actuator/health"

spec:
  ingressClassName: nginx
  rules:
    - host: einvoice.local
      http:
        paths:
          # API Routes
          - path: /api(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: einvoicehub
                port:
                  number: 80

          # Actuator Endpoints
          - path: /actuator(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: einvoicehub
                port:
                  number: 80

          # Prometheus Metrics (for scraping)
          - path: /metrics
            pathType: Exact
            backend:
              service:
                name: einvoicehub-prometheus
                port:
                  number: 9090

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: einvoicehub-monitoring-ingress
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: monitoring
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
spec:
  ingressClassName: nginx
  rules:
    - host: monitoring.einvoice.local
      http:
        paths:
          # Grafana Dashboard
          - path: /
            pathType: Prefix
            backend:
              service:
                name: einvoicehub-grafana
                port:
                  number: 3000

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: einvoicehub-tracing-ingress
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: tracing
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
spec:
  ingressClassName: nginx
  rules:
    - host: tracing.einvoice.local
      http:
        paths:
          # Jaeger UI
          - path: /
            pathType: Prefix
            backend:
              service:
                name: einvoicehub-jaeger
                port:
                  number: 16686

---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: einvoicehub-network-policy
  namespace: einvoice-dev
  labels:
    app: einvoicehub
spec:
  podSelector:
    matchLabels:
      app: einvoicehub
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow traffic from Ingress Controller
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8080

    # Allow traffic from same namespace
    - from:
        - podSelector:
            matchLabels:
              app: einvoicehub
      ports:
        - protocol: TCP
          port: 8080

  egress:
    # Allow DNS resolution
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53

    # Allow traffic to MySQL
    - to:
        - podSelector:
            matchLabels:
              app: mysql
      ports:
        - protocol: TCP
          port: 3306

    # Allow traffic to MongoDB
    - to:
        - podSelector:
            matchLabels:
              app: mongodb
      ports:
        - protocol: TCP
          port: 27017

    # Allow traffic to Redis
    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379

    # Allow external API calls
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443

---
apiVersion: v1
kind: LimitRange
metadata:
  name: einvoicehub-limit-range
  namespace: einvoice-dev
spec:
  limits:
    - default:
        cpu: 1000m
        memory: 1Gi
      defaultRequest:
        cpu: 250m
        memory: 256Mi
      type: Container

---
apiVersion: v1
kind: ResourceQuota
metadata:
  name: einvoicehub-resource-quota
  namespace: einvoice-dev
spec:
  hard:
    pods: "20"
    services: "10"
    secrets: "20"
    configmaps: "20"
    persistentvolumeclaims: "10"
    "limits.cpu": "8"
    "limits.memory": "8Gi"

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: einvoicehub
  namespace: einvoice-dev
  labels:
    app: einvoicehub
automountServiceAccountToken: false

---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: einvoicehub-role
  namespace: einvoice-dev
  labels:
    app: einvoicehub
rules:
  - apiGroups: [""]
    resources: ["pods", "pods/log"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["pods/exec"]
    verbs: ["create"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: einvoicehub-rolebinding
  namespace: einvoice-dev
  labels:
    app: einvoicehub
subjects:
  - kind: ServiceAccount
    name: einvoicehub
    namespace: einvoice-dev
roleRef:
  kind: Role
  name: einvoicehub-role
  apiGroup: rbac.authorization.k8s.io
</file>

<file path="kubernetes/service.yaml">
# EInvoiceHub Kubernetes Service Manifest

---
apiVersion: v1
kind: Service
metadata:
  name: einvoicehub
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    version: v1
    tier: backend
  annotations:
    description: "EInvoiceHub Backend Service"
    prometheus.io/scrape: "true"
    prometheus.io/port: "9090"
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: 8080
      protocol: TCP
    - name: metrics
      port: 9090
      targetPort: 9090
      protocol: TCP
  selector:
    app: einvoicehub
    version: v1

---
apiVersion: v1
kind: Service
metadata:
  name: einvoicehub-mysql
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: database
  annotations:
    description: "MySQL Database Service"
spec:
  type: ClusterIP
  ports:
    - port: 3306
      targetPort: 3306
      protocol: TCP
  selector:
    app: mysql
    tier: database

---
apiVersion: v1
kind: Service
metadata:
  name: einvoicehub-mongodb
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: database
  annotations:
    description: "MongoDB Database Service"
spec:
  type: ClusterIP
  ports:
    - port: 27017
      targetPort: 27017
      protocol: TCP
  selector:
    app: mongodb
    tier: database

---
apiVersion: v1
kind: Service
metadata:
  name: einvoicehub-redis
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: cache
  annotations:
    description: "Redis Cache Service"
spec:
  type: ClusterIP
  ports:
    - port: 6379
      targetPort: 6379
      protocol: TCP
  selector:
    app: redis
    tier: cache

---
apiVersion: v1
kind: Service
metadata:
  name: einvoicehub-prometheus
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: monitoring
  annotations:
    description: "Prometheus Metrics Service"
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 9090
      targetPort: 9090
      protocol: TCP
  selector:
    app: prometheus
    tier: monitoring

---
apiVersion: v1
kind: Service
metadata:
  name: einvoicehub-grafana
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: monitoring
  annotations:
    description: "Grafana Dashboard Service"
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 3000
      targetPort: 3000
      protocol: TCP
  selector:
    app: grafana
    tier: monitoring

---
apiVersion: v1
kind: Service
metadata:
  name: einvoicehub-jaeger
  namespace: einvoice-dev
  labels:
    app: einvoicehub
    tier: tracing
  annotations:
    description: "Jaeger Tracing Service"
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 16686
      targetPort: 16686
      protocol: TCP
    - name: otlp
      port: 4317
      targetPort: 4317
      protocol: TCP
    - name: otlp-http
      port: 4318
      targetPort: 4318
      protocol: TCP
  selector:
    app: jaeger
    tier: tracing

---
apiVersion: v1
kind: Endpoints
metadata:
  name: einvoicehub-headless
  namespace: einvoice-dev
  labels:
    app: einvoicehub
subsets:
  - addresses:
      - ip: 10.0.0.1
        targetRef:
          kind: Pod
          name: einvoicehub-0
          namespace: einvoice-dev
      - ip: 10.0.0.2
        targetRef:
          kind: Pod
          name: einvoicehub-1
          namespace: einvoice-dev
    ports:
      - port: 8080
        protocol: TCP
        name: http
</file>

<file path="monitoring/alertmanager/alertmanager.yml">
# EInvoiceHub Alertmanager Configuration

global:
  resolve_timeout: 5m
  slack_api_url: 'https://hooks.slack.com/services/xxx/yyy/zzz'

# Route defines a routing tree for processing alerts
route:
  group_by: ['alertname', 'severity']
  receiver: 'default-receiver'
  group_interval: 5m
  group_wait: 30s
  repeat_interval: 4h

  # Child routes for specific severities
  routes:
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 1h

    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 1m
      repeat_interval: 6h

    - match:
        alertname: 'HighErrorRate'
      receiver: 'urgent-alerts'
      continue: true

# Receivers define notification destinations
receivers:
  - name: 'default-receiver'
    slack_configs:
      - channel: '#alerts'
        send_resolved: true
        title: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ end }}'
        text: |
          {{ range .Alerts }}
          **{{ .Labels.severity | upper }}** - {{ .Labels.alertname }}
          Description: {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          Start: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        color:
          critical: '#ff0000'
          warning: '#ffa500'
          info: '#00ff00'

  - name: 'critical-alerts'
    slack_configs:
      - channel: '#critical-alerts'
        send_resolved: true
        title: 'üö® CRITICAL ALERT: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        text: |
          {{ range .Alerts }}
          **Severity:** {{ .Labels.severity | upper }}
          **Alert:** {{ .Labels.alertname }}
          **Description:** {{ .Annotations.description }}
          **Namespace:** {{ .Labels.namespace }}
          **Pod:** {{ .Labels.pod }}
          **Value:** {{ .Annotations.current_value }}
          **Started:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  - name: 'warning-alerts'
    slack_configs:
      - channel: '#warning-alerts'
        send_resolved: true
        title: '‚ö†Ô∏è WARNING: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        text: |
          {{ range .Alerts }}
          **Alert:** {{ .Labels.alertname }}
          **Description:** {{ .Annotations.description }}
          **Value:** {{ .Annotations.current_value }}
          {{ end }}

  - name: 'urgent-alerts'
    slack_configs:
      - channel: '#urgent-alerts'
        send_resolved: true
        mention_users: '@oncall'
        title: 'üî• URGENT: High Error Rate Detected'
        text: |
          **Alert:** High Error Rate Detected
          **Error Rate:** {{ range .Alerts }}{{ .Annotations.current_value }}{{ end }}
          **Endpoint:** {{ range .Alerts }}{{ .Annotations.endpoint }}{{ end }}
          **Action Required:** Immediate investigation needed!

  - name: 'pagerduty'
    pagerduty_configs:
      - service_key: 'pagerduty-service-key'
        severity: critical
        description: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
        source: 'EInvoiceHub'
        custom_details:
          environment: '{{ env "ENVIRONMENT" }}'
          cluster: '{{ env "CLUSTER_NAME" }}'

  - name: 'email'
    email_configs:
      - to: 'alerts@einvoicehub.io'
        send_resolved: true
        html: |
          <html>
          <body>
          <h2>Alert: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}</h2>
          <p><strong>Severity:</strong> {{ range .Alerts }}{{ .Labels.severity }}{{ end }}</p>
          <p><strong>Description:</strong> {{ range .Alerts }}{{ .Annotations.description }}{{ end }}</p>
          <p><strong>Value:</strong> {{ range .Alerts }}{{ .Annotations.current_value }}{{ end }}</p>
          <p><strong>Started:</strong> {{ range .Alerts }}{{ .StartsAt.Format "2006-01-02 15:04:05" }}{{ end }}</p>
          </body>
          </html>

# Inhibition rules
inhibit_rules:
  # Inhibit warning alerts if the same alert is already firing as critical
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'namespace', 'pod']

  # Inhibit info alerts if warning or critical for same alert
  - source_match:
      severity: 'warning'
    target_match:
      severity: 'info'
    equal: ['alertname', 'namespace']

# Time intervals for notification routing
time_intervals:
  - name: 'business-hours'
    time_intervals:
      - times:
          - start_time: '09:00'
            end_time: '17:00'
        weekdays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday']
        months: ['january', 'february', 'march', 'april', 'may', 'june',
                 'july', 'august', 'september', 'october', 'november', 'december']
        location: 'Asia/Ho_Chi_Minh'

  - name: 'off-hours'
    time_intervals:
      - times:
          - start_time: '17:00'
            end_time: '09:00'
        weekdays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday']
        months: ['january', 'february', 'march', 'april', 'may', 'june',
                 'july', 'august', 'september', 'october', 'november', 'december']
        location: 'Asia/Ho_Chi_Minh'
      - times:
          - start_time: '00:00'
            end_time: '23:59'
        weekdays: ['saturday', 'sunday']
        months: ['january', 'february', 'march', 'april', 'may', 'june',
                 'july', 'august', 'september', 'october', 'november', 'december']
        location: 'Asia/Ho_Chi_Minh'
</file>

<file path="monitoring/grafana/dashboards/einvoicehub/einvoicehub-overview.json">
{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": {
          "type": "grafana",
          "uid": "-- Grafana --"
        },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "description": "EInvoiceHub Application Overview Dashboard",
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": null,
  "links": [],
  "liveNow": false,
  "panels": [
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 0
      },
      "id": 1,
      "panels": [],
      "title": "Application Overview",
      "type": "row"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 0,
        "y": 1
      },
      "id": 2,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.2.0",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "up{job=\"einvoicehub\", namespace=\"einvoice-dev\"}",
          "refId": "A"
        }
      ],
      "title": "Application Status",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 1
              },
              {
                "color": "red",
                "value": 2
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 6,
        "y": 1
      },
      "id": 3,
      "options": {
        "colorMode": "value",
        "graphMode": "none",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["lastNotNull"],
          "fields": "",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.2.0",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "count(kube_pod_container_status_ready{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"})",
          "refId": "A"
        }
      ],
      "title": "Running Pods",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 70
              },
              {
                "color": "red",
                "value": 90
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 12,
        "y": 1
      },
      "id": 4,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["mean"],
          "fields": "",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.2.0",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "sum(rate(container_cpu_usage_seconds_total{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}[5m])) / sum(kube_pod_container_resource_requests{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\", resource=\"cpu\"}) * 100",
          "refId": "A"
        }
      ],
      "title": "CPU Usage",
      "type": "stat"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "thresholds"
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              },
              {
                "color": "yellow",
                "value": 70
              },
              {
                "color": "red",
                "value": 90
              }
            ]
          },
          "unit": "percent"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 4,
        "w": 6,
        "x": 18,
        "y": 1
      },
      "id": 5,
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto",
        "orientation": "auto",
        "reduceOptions": {
          "calcs": ["mean"],
          "fields": "",
          "values": false
        },
        "textMode": "auto"
      },
      "pluginVersion": "10.2.0",
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "sum(container_memory_working_set_bytes{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}) / sum(kube_pod_container_resource_requests{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\", resource=\"memory\"}) * 100",
          "refId": "A"
        }
      ],
      "title": "Memory Usage",
      "type": "stat"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 5
      },
      "id": 6,
      "panels": [],
      "title": "HTTP Metrics",
      "type": "row"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "reqps"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 6
      },
      "id": 7,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "sum(rate(http_server_requests_seconds_count{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}[5m])) by (uri, method)",
          "legendFormat": "{{method}} {{uri}}",
          "refId": "A"
        }
      ],
      "title": "Request Rate by URI",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "s"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 6
      },
      "id": 8,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "histogram_quantile(0.50, sum(rate(http_server_requests_seconds_bucket{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}[5m])) by (le, uri))",
          "legendFormat": "p50 - {{uri}}",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "histogram_quantile(0.90, sum(rate(http_server_requests_seconds_bucket{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}[5m])) by (le, uri))",
          "legendFormat": "p90 - {{uri}}",
          "refId": "B"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "histogram_quantile(0.99, sum(rate(http_server_requests_seconds_bucket{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}[5m])) by (le, uri))",
          "legendFormat": "p99 - {{uri}}",
          "refId": "C"
        }
      ],
      "title": "Response Time Percentiles",
      "type": "timeseries"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 14
      },
      "id": 9,
      "panels": [],
      "title": "JVM Metrics",
      "type": "row"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "bytes"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 15
      },
      "id": 10,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "jvm_memory_used_bytes{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\", area=\"heap\"}",
          "legendFormat": "{{pod}} - {{area}}",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "jvm_memory_max_bytes{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\", area=\"heap\"}",
          "legendFormat": "{{pod}} - max {{area}}",
          "refId": "B"
        }
      ],
      "title": "JVM Heap Memory",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 15
      },
      "id": 11,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "jvm_threads_live{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}",
          "legendFormat": "{{pod}} - live threads",
          "refId": "A"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "jvm_threads_daemon{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}",
          "legendFormat": "{{pod}} - daemon threads",
          "refId": "B"
        }
      ],
      "title": "JVM Threads",
      "type": "timeseries"
    },
    {
      "collapsed": false,
      "gridPos": {
        "h": 1,
        "w": 24,
        "x": 0,
        "y": 23
      },
      "id": 12,
      "panels": [],
      "title": "Database & Cache Metrics",
      "type": "row"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "reqps"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 24
      },
      "id": 13,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "rate(hikaricp_connections_usage_seconds_count{namespace=\"einvoice-dev\", pod=~\"einvoicehub.*\"}[5m])",
          "legendFormat": "{{pod}} - connections",
          "refId": "A"
        }
      ],
      "title": "HikariCP Connection Usage",
      "type": "timeseries"
    },
    {
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "fieldConfig": {
        "defaults": {
          "color": {
            "mode": "palette-classic"
          },
          "custom": {
            "axisCenteredZero": false,
            "axisColorMode": "text",
            "axisLabel": "",
            "axisPlacement": "auto",
            "barAlignment": 0,
            "drawStyle": "line",
            "fillOpacity": 10,
            "gradientMode": "none",
            "hideFrom": {
              "legend": false,
              "tooltip": false,
              "viz": false
            },
            "lineInterpolation": "linear",
            "lineWidth": 1,
            "pointSize": 5,
            "scaleDistribution": {
              "type": "linear"
            },
            "showPoints": "never",
            "spanNulls": false,
            "stacking": {
              "group": "A",
              "mode": "none"
            },
            "thresholdsStyle": {
              "mode": "off"
            }
          },
          "mappings": [],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              {
                "color": "green",
                "value": null
              }
            ]
          },
          "unit": "reqps"
        },
        "overrides": []
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 24
      },
      "id": 14,
      "options": {
        "legend": {
          "calcs": [],
          "displayMode": "list",
          "placement": "bottom",
          "showLegend": true
        },
        "tooltip": {
          "mode": "multi",
          "sort": "none"
        }
      },
      "targets": [
        {
          "datasource": {
            "type": "prometheus",
            "uid": "prometheus"
          },
          "expr": "redis_keyspace_hits_total / (redis_keyspace_hits_total + redis_keyspace_misses_total)",
          "legendFormat": "hit ratio",
          "refId": "A"
        }
      ],
      "title": "Redis Cache Hit Ratio",
      "type": "timeseries"
    }
  ],
  "refresh": "30s",
  "schemaVersion": 38,
  "style": "dark",
  "tags": ["einvoicehub", "spring-boot", "java", "kubernetes"],
  "templating": {
    "list": []
  },
  "time": {
    "from": "now-1h",
    "to": "now"
  },
  "timepicker": {},
  "timezone": "browser",
  "title": "EInvoiceHub Overview",
  "uid": "einvoicehub-overview",
  "version": 1,
  "weekStart": ""
}
</file>

<file path="monitoring/grafana/provisioning/dashboards/default.yaml">
# EInvoiceHub Grafana Dashboards Configuration

apiVersion: 1

# Dashboard providers
providers:
  - name: 'einvoicehub'
    orgId: 1
    folder: 'EInvoiceHub'
    type: file
    disableDeletion: false
    updateIntervalSeconds: 10
    options:
      path: /var/lib/grafana/dashboards/einvoicehub
      foldersFromFilesStructure: true

  - name: 'kubernetes'
    orgId: 1
    folder: 'Kubernetes'
    type: file
    disableDeletion: false
    updateIntervalSeconds: 10
    options:
      path: /var/lib/grafana/dashboards/kubernetes
      foldersFromFilesStructure: true

  - name: 'infrastructure'
    orgId: 1
    folder: 'Infrastructure'
    type: file
    disableDeletion: false
    updateIntervalSeconds: 10
    options:
      path: /var/lib/grafana/dashboards/infrastructure
      foldersFromFilesStructure: true
</file>

<file path="monitoring/grafana/provisioning/datasources/prometheus.yaml">
# EInvoiceHub Grafana Datasource Configuration

apiVersion: 1

# Delete all datasources before inserting new ones
deleteDatasources:
  - name: Prometheus
    orgId: 1

# Insert/update datasources
datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    orgId: 1
    url: http://prometheus:9090
    isDefault: true
    version: 1
    editable: false
    jsonData:
      httpMethod: GET
      manageAlerts: true
      prometheusType: Prometheus
      prometheusVersion: 2.48.0
      enableLoGS: true
      loGSRequestToken: ''
      loGSStartTimeParam: start
      loGSEndTimeParam: end
      loGSTimeFormat: RFC3339Nano
      loGSTimeZone: UTC
      apiVersion: 1
      cachedResponseTTLMinutes: 60
    secureJsonData:
      httpHeaderValue1: ''
    cacheTimeout: 30

  - name: Loki
    type: loki
    access: proxy
    orgId: 1
    url: http://loki:3100
    isDefault: false
    version: 1
    editable: false
    jsonData:
      maxLines: 5000
      derivedFields:
        - matcherRegex: '(?:apikey|client)[=\\s]+([A-Za-z0-9_=-]+)'
          name: apikey
          datasourceUid:grafana
        - matcherRegex: 'trace_id=([A-Za-z0-9_=-]+)'
          name: trace_id
          datasourceUid: jaeger
    secureJsonData:
      httpHeaderValue1: ''

  - name: Jaeger
    type: jaeger
    access: proxy
    orgId: 1
    url: http://jaeger:16686
    isDefault: false
    version: 1
    editable: false
    jsonData:
      tracesToLogs:
        datasourceUid: Loki
      nodeGraph:
        enabled: true
    secureJsonData: {}

  - name: Elasticsearch
    type: elasticsearch
    access: proxy
    orgId: 1
    url: http://elasticsearch:9200
    isDefault: false
    version: 1
    editable: false
    jsonData:
      interval: Daily
      timeField: '@timestamp'
      logMessageField: message
      logLevelField: level
      database: 'einvoicehub-logs'
    secureJsonData:
      basicAuthPassword: ''

  - name: MySQL
    type: mysql
    access: proxy
    orgId: 1
    url: mysql:3306/einvoicehub
    isDefault: false
    version: 1
    editable: false
    jsonData:
      database: einvoicehub
      user: grafana
    secureJsonData:
      basicAuthPassword: ''
</file>

<file path="monitoring/prometheus/prometheus.yml">
# EInvoiceHub Prometheus Configuration
global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'einvoice-cluster'
    environment: 'dev'

# Alertmanager configuration (optional)
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  - '/etc/prometheus/rules/*.yml'

# A scrape configuration containing exactly one endpoint to scrape:
# Here it's Prometheus itself.
scrape_configs:
    # Prometheus Self-Monitoring

  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']

  # =====================================================================
  # EInvoiceHub Application Metrics
  # =====================================================================
  - job_name: 'einvoicehub'
    kubernetes_sd_configs:
      - role: pod
        namespaces:
          names:
            - einvoice-dev
            - einvoice-staging
            - einvoice-prod
    relabel_configs:
      # Only scrape pods with the prometheus.io/scrape annotation
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true

      # Use the prometheus.io/path annotation to scrape a specific path
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
        action: replace
        target_label: __metrics_path__
        regex: (.+)

      # Use the prometheus.io/port annotation to scrape a specific port
      - source_labels: [
          __address__,
          __meta_kubernetes_pod_annotation_prometheus_io_port
        ]
        action: replace
        regex: ([^:]+)(?::\\d+)?;(\\d+)
        replacement: $1:$2
        target_label: __address__

      # Add environment label
      - source_labels: [__meta_kubernetes_namespace]
        action: replace
        target_label: namespace

      # Add pod name label
      - source_labels: [__meta_kubernetes_pod_name]
        action: replace
        target_label: pod

      # Add app name label
      - source_labels: [__meta_kubernetes_pod_label_app]
        action: replace
        target_label: app

  # =====================================================================
  # Kubernetes Node Exporter (infrastructure metrics)
  # =====================================================================
  - job_name: 'node-exporter'
    kubernetes_sd_configs:
      - role: node
    relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)

  # =====================================================================
  # MySQL Exporter (database metrics)
  # =====================================================================
  - job_name: 'mysql-exporter'
    static_configs:
      - targets: ['mysql-exporter:9104']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'mysql-primary'

  # =====================================================================
  # MongoDB Exporter (database metrics)
  # =====================================================================
  - job_name: 'mongodb-exporter'
    static_configs:
      - targets: ['mongodb-exporter:9216']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'mongodb-primary'

  # =====================================================================
  # Redis Exporter (cache metrics)
  # =====================================================================
  - job_name: 'redis-exporter'
    static_configs:
      - targets: ['redis-exporter:9121']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'redis-primary'

  # =====================================================================
  # Spring Boot Actuator Metrics (via HTTP)
  # =====================================================================
  - job_name: 'spring-actuator'
    metrics_path: '/actuator/prometheus'
    scrape_interval: 5s
    static_configs:
      - targets: ['einvoicehub:8080']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        replacement: 'einvoicehub-backend'

# Remote write configuration (for long-term storage)
remote_write:
  - url: 'https://prometheus-remote-write.einvoicehub.io/api/v1/write'
    basic_auth:
      username: 'prometheus'
      password_file: '/etc/prometheus/remote_write_password'
    queue_config:
      max_samples_per_send: 10000
      batch_send_deadline: 30s
      capacity: 20000
      max_shards: 30
    tls_config:
      insecure_skip_verify: false
</file>

<file path="sql/init/V1__Initial_Schema.sql">
-- =============================================================================
-- EInvoiceHub Database Schema - Core + Shell Strategy
-- Database: MariaDB | Character Set: utf8mb4_unicode_ci
-- =============================================================================

SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- =============================================================================
-- SECTION 1: CATALOG TABLES (Reference Data)
-- =============================================================================

-- 1. Invoice Types - Danh m·ª•c lo·∫°i h√≥a ƒë∆°n
CREATE TABLE `invoice_types` (
    `id`            BIGINT AUTO_INCREMENT PRIMARY KEY,
    `type_code`     VARCHAR(10)  NOT NULL UNIQUE COMMENT 'M√£ lo·∫°i h√≥a ƒë∆°n (VD: 01GTKT)',
    `type_name`     VARCHAR(100) NOT NULL COMMENT 'T√™n lo·∫°i h√≥a ƒë∆°n',
    `description`   TEXT NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
    `is_active`     BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    `display_order` INT          NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
    `created_at`    TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`    TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX `idx_type_code` (`type_code`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c lo·∫°i h√≥a ƒë∆°n';

-- Insert standard invoice types
INSERT INTO invoice_types (type_code, type_name, description, display_order) VALUES
('01GTKT', 'H√≥a ƒë∆°n gi√° tr·ªã gia tƒÉng', 'H√≥a ƒë∆°n GTGT m·∫´u 01GTKT theo Th√¥ng t∆∞ 78/2021/TT-BTC', 1),
('02GTTT', 'H√≥a ƒë∆°n b√°n h√†ng', 'H√≥a ƒë∆°n b√°n h√†ng m·∫´u 02GTTT theo Th√¥ng t∆∞ 78/2021/TT-BTC', 2),
('07KPTQ', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ ki·ªÉm so√°t', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ ki·ªÉm so√°t theo Ngh·ªã ƒë·ªãnh 123/2020/Nƒê-CP', 3),
('03KPTQ', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ kh√¥ng ki·ªÉm so√°t', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ kh√¥ng ki·ªÉm so√°t theo Ngh·ªã ƒë·ªãnh 123/2020/Nƒê-CP', 4);

-- 2. Invoice Statuses - Danh m·ª•c tr·∫°ng th√°i h√≥a ƒë∆°n
CREATE TABLE `invoice_statuses` (
    `id`          INT PRIMARY KEY COMMENT 'ID tr·∫°ng th√°i',
    `name`        VARCHAR(100) NOT NULL UNIQUE COMMENT 'T√™n tr·∫°ng th√°i',
    `description` VARCHAR(255) NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt tr·∫°ng th√°i',
    `note`        VARCHAR(500) NULL COMMENT 'Ghi ch√∫ nghi·ªáp v·ª•',
    `created_at`  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    `updated_at`  TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='B·∫£ng danh m·ª•c tr·∫°ng th√°i h√≥a ƒë∆°n';

INSERT INTO invoice_statuses (id, name, description, note) VALUES
(1, 'DRAFT', 'H√≥a ƒë∆°n nh√°p', 'M·ªõi t·∫°o, ch∆∞a k√Ω'),
(2, 'PENDING', 'ƒêang x·ª≠ l√Ω', 'ƒêang ch·ªù g·ª≠i sang Provider'),
(3, 'SIGNING', 'ƒêang k√Ω s·ªë', 'ƒêang th·ª±c hi·ªán k√Ω ƒëi·ªán t·ª≠'),
(4, 'SENT_TO_PROVIDER', 'ƒê√£ g·ª≠i Provider', 'ƒê√£ g·ª≠i nh∆∞ng ch∆∞a c√≥ k·∫øt qu·∫£ t·ª´ CQT'),
(5, 'SUCCESS', 'Th√†nh c√¥ng', 'H√≥a ƒë∆°n ƒë√£ h·ª£p l·ªá v√† c√≥ m√£ CQT'),
(6, 'FAILED', 'Th·∫•t b·∫°i', 'L·ªói t·ª´ Provider ho·∫∑c CQT'),
(7, 'CANCELLED', 'ƒê√£ h·ªßy', 'H√≥a ƒë∆°n ƒë√£ b·ªã h·ªßy b·ªè'),
(8, 'REPLACED', 'ƒê√£ thay th·∫ø', 'ƒê√£ c√≥ h√≥a ƒë∆°n kh√°c thay th·∫ø cho h√≥a ƒë∆°n n√†y');

-- 3. Payment Methods - Danh m·ª•c ph∆∞∆°ng th·ª©c thanh to√°n
CREATE TABLE `payment_methods` (
    `id`            BIGINT AUTO_INCREMENT PRIMARY KEY,
    `method_code`   VARCHAR(10)  NOT NULL UNIQUE COMMENT 'M√£ ph∆∞∆°ng th·ª©c: TM, CK...',
    `method_name`   VARCHAR(100) NOT NULL COMMENT 'T√™n ph∆∞∆°ng th·ª©c',
    `description`   TEXT NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
    `is_active`     BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    `display_order` INT          NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
    `created_at`    TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`    TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX `idx_method_code` (`method_code`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c ph∆∞∆°ng th·ª©c thanh to√°n';

INSERT INTO payment_methods (method_code, method_name, description, display_order) VALUES
('TM', 'Ti·ªÅn m·∫∑t', 'Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t tr·ª±c ti·∫øp', 1),
('CK', 'Chuy·ªÉn kho·∫£n', 'Thanh to√°n qua chuy·ªÉn kho·∫£n ng√¢n h√†ng', 2),
('TM/CK', 'Ti·ªÅn m·∫∑t/Chuy·ªÉn kho·∫£n', 'K·∫øt h·ª£p c·∫£ hai h√¨nh th·ª©c', 3),
('POS', 'Th·∫ª POS', 'Thanh to√°n qua m√°y POS', 4),
('V√ç ƒêI·ªÜN T·ª¨', 'V√≠ ƒëi·ªán t·ª≠', 'Thanh to√°n qua v√≠ ƒëi·ªán t·ª≠', 5),
('TH·∫∫', 'Th·∫ª ng√¢n h√†ng', 'Thanh to√°n b·∫±ng th·∫ª t√≠n d·ª•ng/ghi n·ª£', 6);

-- 4. VAT Rates - Danh m·ª•c thu·∫ø su·∫•t GTGT
CREATE TABLE `vat_rates` (
    `id`            BIGINT AUTO_INCREMENT PRIMARY KEY,
    `rate_code`     VARCHAR(10)   NOT NULL UNIQUE COMMENT 'M√£ thu·∫ø su·∫•t: 0, 5, 8, 10, KCT',
    `rate_percent`  DECIMAL(5, 2) NOT NULL COMMENT 'Gi√° tr·ªã ph·∫ßn trƒÉm thu·∫ø su·∫•t',
    `rate_name`     VARCHAR(100)  NOT NULL COMMENT 'T√™n thu·∫ø su·∫•t',
    `description`   TEXT NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
    `is_active`     BOOLEAN       NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    `display_order` INT           NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
    `created_at`    TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`    TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    CONSTRAINT `chk_vat_rate_percent` CHECK (rate_percent >= 0),
    INDEX `idx_rate_code` (`rate_code`),
    INDEX `idx_rate_percent` (`rate_percent`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c thu·∫ø su·∫•t GTGT';

INSERT INTO vat_rates (rate_code, rate_percent, rate_name, description, display_order) VALUES
('0', 0.00, 'Thu·∫ø su·∫•t 0%', '√Åp d·ª•ng cho h√†ng h√≥a, d·ªãch v·ª• xu·∫•t kh·∫©u', 1),
('5', 5.00, 'Thu·∫ø su·∫•t 5%', '√Åp d·ª•ng cho h√†ng h√≥a, d·ªãch v·ª• thi·∫øt y·∫øu', 2),
('8', 8.00, 'Thu·∫ø su·∫•t 8%', 'Gi·∫£m thu·∫ø theo Ngh·ªã quy·∫øt 43/2022/QH15', 3),
('10', 10.00, 'Thu·∫ø su·∫•t 10%', 'Thu·∫ø su·∫•t th√¥ng th∆∞·ªùng GTGT', 4),
('KCT', 0.00, 'Kh√¥ng ch·ªãu thu·∫ø', 'H√†ng h√≥a, d·ªãch v·ª• kh√¥ng ch·ªãu thu·∫ø GTGT', 5);

-- 5. Service Providers - Danh m·ª•c nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠
CREATE TABLE `service_providers` (
    `id`                  BIGINT AUTO_INCREMENT PRIMARY KEY,
    `provider_code`       VARCHAR(20)  NOT NULL UNIQUE COMMENT 'M√£ ƒë·ªãnh danh (VNPT, VIETTEL...)',
    `provider_name`       VARCHAR(100) NOT NULL COMMENT 'T√™n nh√† cung c·∫•p',
    `official_api_url`    VARCHAR(500) NOT NULL COMMENT 'URL t√≠ch h·ª£p',
    `lookup_url`          VARCHAR(500) NULL COMMENT 'URL tra c·ª©u h√≥a ƒë∆°n',
    `documentation_url`   VARCHAR(500) NULL COMMENT 'Link t√†i li·ªáu API',
    `support_email`       VARCHAR(255) NULL,
    `support_phone`       VARCHAR(20) NULL,
    `is_active`           BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'Ki·ªÉm tra c√≤n ho·∫°t ƒë·ªông kh√¥ng',
    `is_default`          BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh h·ªá th·ªëng',
    `display_order`       INT          NOT NULL DEFAULT 0,
    `extra_config_schema` JSON NULL COMMENT 'C·∫•u h√¨nh ƒë·∫∑c th√π c·ªßa t·ª´ng h√£ng',
    `created_at`          TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`          TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX `idx_provider_code` (`provider_code`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠';

INSERT INTO service_providers (provider_code, provider_name, official_api_url, lookup_url, is_active, display_order) VALUES
('VNPT', 'VNPT e-Invoice', 'https://api-itg.vnpt.vn', 'https://tracuu.vnpt.vn', TRUE, 1),
('VIETTEL', 'SInvoice Viettel', 'https://sinvoice.viettel.vn/api', 'https://sinvoice.viettel.vn/tracuu', TRUE, 2),
('BKAV', 'BKAV eInvoice', 'https://einvoice.bkav.com/api', 'https://tracuuhdon.bkav.com', TRUE, 3),
('MOBIFONE', 'MobiFone Invoice', 'https://thongke.mobifoneinvoice.vn/api/v1', 'https://mobifoneinvoice.vn/tracuu', TRUE, 4);

-- =============================================================================
-- SECTION 2: CORE JPA TABLES (Business Logic Foundation)
-- Hierarchical Flow: Merchants -> ProviderConfigs -> Templates -> Invoices -> Items
-- =============================================================================

-- =============================================================================
-- CORE TABLE 1: Merchants (Root Entity)
-- Core: Identity & Tax Information
-- Shell: SaaS Subscription Fields
-- =============================================================================
CREATE TABLE `merchants` (
    -- Core Fields (Required for JPA compatibility)
    `id`                   BIGINT AUTO_INCREMENT PRIMARY KEY,
    `tax_code`             VARCHAR(20)  NOT NULL UNIQUE COMMENT 'M√£ s·ªë thu·∫ø - ƒë·ªãnh danh doanh nghi·ªáp',
    `company_name`         VARCHAR(255) NOT NULL COMMENT 'T√™n c√¥ng ty ƒë·∫ßy ƒë·ªß',
    `short_name`           VARCHAR(100) COMMENT 'T√™n vi·∫øt t·∫Øt',
    `address`              TEXT COMMENT 'ƒê·ªãa ch·ªâ tr·ª• s·ªü ch√≠nh',
    `district`             VARCHAR(100) COMMENT 'Qu·∫≠n/Huy·ªán',
    `city`                 VARCHAR(100) COMMENT 'T·ªânh/Th√†nh ph·ªë',
    `email`                VARCHAR(255) COMMENT 'Email li√™n h·ªá',
    `phone`                VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    `representative_name`  VARCHAR(100) COMMENT 'T√™n ng∆∞·ªùi ƒë·∫°i di·ªán',
    `representative_title` VARCHAR(100) COMMENT 'Ch·ª©c danh ng∆∞·ªùi ƒë·∫°i di·ªán',
    `tax_authority_code`   VARCHAR(10) NULL COMMENT 'M√£ c∆° quan thu·∫ø qu·∫£n l√Ω (VD: 01GD, 02HT...)',

    -- Enterprise Shell Fields (SaaS Extensions - NULLABLE for JPA compatibility)
    `subscription_plan`    ENUM('TRIAL', 'BASIC', 'PREMIUM') NOT NULL DEFAULT 'TRIAL' COMMENT 'G√≥i d·ªãch v·ª•: TRIAL, BASIC, PREMIUM',
    `invoice_quota`        INT          NOT NULL DEFAULT 100 COMMENT 'H·∫°n m·ª©c h√≥a ƒë∆°n/th√°ng',
    `invoice_used`         INT          NOT NULL DEFAULT 0 COMMENT 'H√≥a ƒë∆°n ƒë√£ s·ª≠ d·ª•ng trong th√°ng',
    `is_using_hsm`         BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'S·ª≠ d·ª•ng HSM hay USB Token ƒë·ªÉ k√Ω ƒëi·ªán t·ª≠',
    `is_deleted`           BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'C·ªù x√≥a m·ªÅm',
    `deleted_at`           TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
    `created_at`           TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`           TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    INDEX `idx_tax_code` (`tax_code`),
    INDEX `idx_subscription_plan` (`subscription_plan`),
    INDEX `idx_created_at` (`created_at`),
    INDEX `idx_tax_authority` (`tax_authority_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω doanh nghi·ªáp s·ª≠ d·ª•ng d·ªãch v·ª• h√≥a ƒë∆°n ƒëi·ªán t·ª≠';

-- =============================================================================
-- CORE TABLE 2: Merchant User (Child of Merchant)
-- Users who belong to and are managed by a Merchant
-- =============================================================================
CREATE TABLE `merchant_user` (
    `id`                    BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`           BIGINT       NOT NULL COMMENT 'Li√™n k·∫øt v·ªõi doanh nghi·ªáp',
    `username`              VARCHAR(50)  NOT NULL UNIQUE COMMENT 'T√™n ƒëƒÉng nh·∫≠p',
    `email`                 VARCHAR(255) NOT NULL UNIQUE COMMENT 'Email ng∆∞·ªùi d√πng',
    `password_hash`         VARCHAR(255) NOT NULL COMMENT 'M·∫≠t kh·∫©u ƒë√£ m√£ h√≥a BCrypt',
    `full_name`             VARCHAR(100) COMMENT 'H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß',
    `phone`                 VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    `avatar_url`            VARCHAR(500) COMMENT 'URL ·∫£nh ƒë·∫°i di·ªán',
    `role`                  ENUM('ADMIN', 'MANAGER', 'STAFF', 'VIEWER') NOT NULL DEFAULT 'STAFF' COMMENT 'Vai tr√≤ trong h·ªá th·ªëng',
    `is_active`             BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'K√≠ch ho·∫°t t√†i kho·∫£n',
    `is_primary`            BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'T√†i kho·∫£n ch√≠nh c·ªßa doanh nghi·ªáp',
    `last_login_at`         TIMESTAMP NULL COMMENT 'ƒêƒÉng nh·∫≠p l·∫ßn cu·ªëi',
    `failed_login_attempts` INT          NOT NULL DEFAULT 0 COMMENT 'S·ªë l·∫ßn ƒëƒÉng nh·∫≠p sai',
    `locked_until`          TIMESTAMP NULL COMMENT 'Kh√≥a t√†i kho·∫£n ƒë·∫øn th·ªùi ƒëi·ªÉm',
    `created_at`            TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`            TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT `fk_merchant_user_merchant` FOREIGN KEY (`merchant_id`)
        REFERENCES `merchants` (`id`) ON DELETE CASCADE,

    INDEX `idx_merchant_id` (`merchant_id`),
    INDEX `idx_username` (`username`),
    INDEX `idx_email` (`email`),
    INDEX `idx_role` (`role`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='T√†i kho·∫£n ng∆∞·ªùi d√πng thu·ªôc Merchant';

-- =============================================================================
-- CORE TABLE 3: Merchant Provider Configs (Child of Merchant)
-- Configuration for external invoice service providers
-- Core: Connection credentials
-- Shell: Test mode and encrypted storage
-- =============================================================================
CREATE TABLE `merchant_provider_configs` (
    -- Core Fields
    `id`                         BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`                BIGINT       NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu',
    `provider_id`                BIGINT       NOT NULL COMMENT 'Nh√† cung c·∫•p ƒë∆∞·ª£c ch·ªçn',

    -- Connection Credentials
    `partner_id`                 VARCHAR(50) NULL COMMENT 'ID ƒë·ªëi t√°c (partner_id)',
    `partner_token`              VARCHAR(500) NULL COMMENT 'Token truy c·∫≠p (partner_token)',
    `tax_code`                   VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø k·∫øt n·ªëi',
    `integration_url`            VARCHAR(500) NULL COMMENT 'URL t√≠ch h·ª£p ri√™ng',
    `integrated_date`            TIMESTAMP NULL COMMENT 'Ng√†y t√≠ch h·ª£p',

    -- Service Account
    `username_service`           VARCHAR(100) NOT NULL COMMENT 'T√†i kho·∫£n API',
    `password_service_encrypted` VARCHAR(500) NOT NULL COMMENT 'M·∫≠t kh·∫©u API (ƒë√£ m√£ h√≥a)',

    -- Digital Certificate
    `certificate_serial`         VARCHAR(100) NULL,
    `certificate_data`          TEXT NULL,
    `certificate_chain`         LONGTEXT NULL,
    `certificate_expired_at`    TIMESTAMP NULL,

    -- Extra Configuration
    `extra_config`               JSON NULL COMMENT 'C·∫•u h√¨nh b·ªï sung (pattern, serial...)',

    -- Enterprise Shell Fields (NULLABLE for JPA compatibility)
    `is_test_mode`               BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'Ch·∫ø ƒë·ªô ki·ªÉm th·ª≠ (Sandbox)',
    `encrypted_password_storage` VARCHAR(500) NULL COMMENT 'L∆∞u tr·ªØ m·∫≠t kh·∫©u ƒë√£ m√£ h√≥a (AES256)',

    -- Status & Timestamps
    `is_active`                  BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'Tr·∫°ng th√°i k√≠ch ho·∫°t',
    `is_default`                 BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'C·∫•u h√¨nh m·∫∑c ƒë·ªãnh',
    `last_sync_at`               TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm ƒë·ªìng b·ªô cu·ªëi',
    `created_at`                 TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`                 TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT `fk_mpc_merchant` FOREIGN KEY (`merchant_id`) REFERENCES `merchants` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_mpc_provider` FOREIGN KEY (`provider_id`) REFERENCES `service_providers` (`id`) ON DELETE RESTRICT,
    CONSTRAINT `uq_merchant_provider` UNIQUE (`merchant_id`, `provider_id`),

    INDEX `idx_merchant_provider` (`merchant_id`, `provider_id`),
    INDEX `idx_is_active` (`is_active`),
    INDEX `idx_is_test_mode` (`is_test_mode`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='B·∫£ng c·∫•u h√¨nh chi ti·∫øt NCC cho t·ª´ng Merchant';

-- =============================================================================
-- CORE TABLE 4: Invoice Template (Child of Merchant)
-- Template configuration with serial number management
-- =============================================================================
CREATE TABLE `invoice_template` (
    `id`                      BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`             BIGINT      NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu',
    `invoice_type_id`         BIGINT NULL COMMENT 'Lo·∫°i h√≥a ƒë∆°n',
    `invoice_registration_id` BIGINT NULL COMMENT 'Li√™n k·∫øt ƒëƒÉng k√Ω d·∫£i s·ªë',
    `provider_id`             VARCHAR(36) NULL COMMENT 'M√£ NCC',
    `provider_serial_id`      VARCHAR(50) NULL COMMENT 'ID d·∫£i s·ªë ph√≠a NCC',

    -- Template Configuration
    `template_code`           VARCHAR(20) NOT NULL COMMENT 'M·∫´u h√≥a ƒë∆°n: 01GTKT0/001',
    `symbol_code`            VARCHAR(10) NOT NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n: AA/22E',

    -- Serial Number Management
    `current_number`          INT         NOT NULL DEFAULT 0 COMMENT 'S·ªë hi·ªán t·∫°i',
    `min_number`              INT         NOT NULL DEFAULT 1,
    `max_number`              INT         NOT NULL DEFAULT 99999999,
    `start_date`              TIMESTAMP NULL COMMENT 'Ng√†y b·∫Øt ƒë·∫ßu hi·ªáu l·ª±c',

    -- Status
    `status_id`               INT NULL COMMENT 'ID tr·∫°ng th√°i',
    `is_active`               BOOLEAN     NOT NULL DEFAULT TRUE,

    -- Timestamps
    `created_at`              TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`              TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT `fk_template_merchant` FOREIGN KEY (`merchant_id`) REFERENCES `merchants` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_template_type` FOREIGN KEY (`invoice_type_id`) REFERENCES `invoice_types` (`id`) ON DELETE SET NULL,
    CONSTRAINT `uq_merchant_template_symbol` UNIQUE (`merchant_id`, `template_code`, `symbol_code`),

    INDEX `idx_template_codes` (`template_code`, `symbol_code`),
    INDEX `idx_is_active` (`is_active`),
    INDEX `idx_merchant_id` (`merchant_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω m·∫´u s·ªë v√† k√Ω hi·ªáu h√≥a ƒë∆°n';

-- =============================================================================
-- CORE TABLE 5: Invoice Registrations (Supporting Core Table)
-- Registration of invoice number ranges with tax authorities
-- =============================================================================
CREATE TABLE `invoice_registrations` (
    `id`                  BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`         BIGINT       NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu d·∫£i s·ªë',
    `registration_number` VARCHAR(50)  NULL COMMENT 'S·ªë quy·∫øt ƒë·ªãnh/ph√™ duy·ªát c·ªßa CQT',
    `from_number`         BIGINT       NOT NULL COMMENT 'S·ªë b·∫Øt ƒë·∫ßu c·ªßa d·∫£i',
    `to_number`           BIGINT       NOT NULL COMMENT 'S·ªë k·∫øt th√∫c c·ªßa d·∫£i',
    `quantity`            BIGINT       NOT NULL COMMENT 'S·ªë l∆∞·ª£ng h√≥a ƒë∆°n trong d·∫£i',
    `current_number`      BIGINT       NOT NULL DEFAULT 0 COMMENT 'S·ªë hi·ªán t·∫°i ƒë√£ s·ª≠ d·ª•ng',
    `effective_date`      DATE         NOT NULL COMMENT 'Ng√†y c√≥ hi·ªáu l·ª±c',
    `expiration_date`    DATE         NULL COMMENT 'Ng√†y h·∫øt h·∫°n',
    `status_id`           INT          NOT NULL DEFAULT 1 COMMENT 'Tr·∫°ng th√°i ƒëƒÉng k√Ω',
    `issued_by`           VARCHAR(255) NULL COMMENT 'Ng∆∞·ªùi ph√™ duy·ªát/C∆° quan Thu·∫ø',
    `note`                TEXT         NULL COMMENT 'Ghi ch√∫ b·ªï sung',
    `created_at`          TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`          TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT `fk_registration_merchant` FOREIGN KEY (`merchant_id`) REFERENCES `merchants` (`id`) ON DELETE CASCADE,
    CONSTRAINT `chk_registration_range` CHECK (`from_number` <= `to_number`),

    INDEX `idx_registration_merchant` (`merchant_id`),
    INDEX `idx_registration_status` (`status_id`),
    INDEX `idx_registration_effective` (`effective_date`),
    INDEX `idx_registration_number` (`registration_number`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω ƒëƒÉng k√Ω d·∫£i s·ªë h√≥a ƒë∆°n v·ªõi C∆° quan Thu·∫ø';

-- Registration Statuses
CREATE TABLE `registration_statuses` (
    `id`          INT PRIMARY KEY COMMENT 'ID tr·∫°ng th√°i',
    `name`        VARCHAR(100) NOT NULL UNIQUE COMMENT 'T√™n tr·∫°ng th√°i',
    `description` VARCHAR(255) NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
    `note`        VARCHAR(500) NULL COMMENT 'Ghi ch√∫ nghi·ªáp v·ª•',
    `created_at`  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    `updated_at`  TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c tr·∫°ng th√°i ƒëƒÉng k√Ω d·∫£i s·ªë';

INSERT INTO registration_statuses (id, name, description, note) VALUES
(1, 'ACTIVE', 'ƒêang hi·ªáu l·ª±c', 'D·∫£i s·ªë ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng'),
(2, 'EXHAUSTED', 'ƒê√£ d√πng h·∫øt', 'To√†n b·ªô s·ªë trong d·∫£i ƒë√£ ph√°t h√†nh'),
(3, 'EXPIRED', 'ƒê√£ h·∫øt h·∫°n', 'D·∫£i s·ªë ƒë√£ qu√° ng√†y hi·ªáu l·ª±c'),
(4, 'CANCELLED', 'ƒê√£ h·ªßy', 'D·∫£i s·ªë b·ªã h·ªßy b·ªè');

-- =============================================================================
-- CORE TABLE 6: Invoice Metadata (Central Transaction Table)
-- Flat Metadata Strategy: Buyer information copied directly (no Customer FK)
-- Core: Invoice business data
-- Shell: Enterprise fields (lookup_code, cqt_code, provider_transaction_id)
-- =============================================================================
CREATE TABLE `invoice_metadata` (
    -- Primary Key
    `id`                        BIGINT AUTO_INCREMENT PRIMARY KEY,

    -- Foreign Keys (Hierarchical references)
    `merchant_id`               BIGINT         NOT NULL COMMENT 'Li√™n k·∫øt doanh nghi·ªáp s·ªü h·ªØu',
    `provider_id`               BIGINT NULL COMMENT 'Li√™n k·∫øt nh√† cung c·∫•p d·ªãch v·ª•',
    `provider_config_id`        BIGINT NULL COMMENT 'C·∫•u h√¨nh Provider ƒë∆∞·ª£c s·ª≠ d·ª•ng',
    `invoice_template_id`       BIGINT NULL COMMENT 'M·∫´u h√≥a ƒë∆°n ƒë∆∞·ª£c s·ª≠ d·ª•ng',
    `payment_method`            VARCHAR(10) NULL COMMENT 'M√£ ph∆∞∆°ng th·ª©c thanh to√°n',

    -- Identifiers & References
    `client_request_id`         VARCHAR(100) NULL COMMENT 'ID request t·ª´ h·ªá th·ªëng Merchant',
    `partner_invoice_id`        VARCHAR(50) NULL COMMENT 'ID ƒë·ªãnh danh t·ª´ ƒë·ªëi t√°c',

    -- Invoice Information
    `invoice_number`            VARCHAR(20) NULL COMMENT 'S·ªë h√≥a ƒë∆°n t·ª´ Provider tr·∫£ v·ªÅ',
    `symbol_code`               VARCHAR(10) NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n',
    `template_code`             VARCHAR(20) NULL COMMENT 'M·∫´u h√≥a ƒë∆°n',
    `invoice_type_code`         VARCHAR(10) NULL COMMENT 'M√£ lo·∫°i h√≥a ƒë∆°n',
    `is_summary_invoice`        BOOLEAN        NOT NULL DEFAULT FALSE COMMENT 'H√≥a ƒë∆°n t·ªïng h·ª£p',
    `issuance_method`           ENUM('STANDARD', 'POS') NOT NULL DEFAULT 'STANDARD' COMMENT 'Ph∆∞∆°ng th·ª©c ph√°t h√†nh',

    -- Enterprise Shell Fields (NULLABLE for JPA compatibility)
    `lookup_code`               VARCHAR(50) NULL COMMENT 'M√£ tra c·ª©u h√≥a ƒë∆°n (Unique)',
    `cqt_code`                  VARCHAR(50) NULL COMMENT 'M√£ C∆° quan Thu·∫ø c·∫•p',
    `provider_transaction_id`   VARCHAR(100) NULL COMMENT 'ID giao d·ªãch t·ª´ Provider',

    -- Seller Information (Flattened from Merchant)
    `seller_name`               VARCHAR(255) NULL COMMENT 'T√™n ng∆∞·ªùi b√°n',
    `seller_tax_code`           VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi b√°n',
    `seller_address`            TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi b√°n',

    -- Buyer Information (FLATTENED - No Customer FK to prevent circular dependencies)
    `buyer_name`                VARCHAR(255) NULL COMMENT 'T√™n ƒë∆°n v·ªã ng∆∞·ªùi mua',
    `buyer_tax_code`            VARCHAR(20) NULL COMMENT 'MST ng∆∞·ªùi mua',
    `buyer_id_no`               VARCHAR(20) NULL COMMENT 'S·ªë CMND/CCCD/H·ªô chi·∫øu',
    `buyer_full_name`           VARCHAR(200) NULL COMMENT 'H·ªç t√™n ng∆∞·ªùi mua h√†ng',
    `buyer_email`               VARCHAR(255) NULL COMMENT 'Email ng∆∞·ªùi mua',
    `buyer_phone`               VARCHAR(20) NULL COMMENT 'ƒêi·ªán tho·∫°i ng∆∞·ªùi mua',
    `buyer_mobile`              VARCHAR(50) NULL COMMENT 'Di ƒë·ªông ng∆∞·ªùi mua',
    `buyer_address`             TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi mua',
    `buyer_bank_account`        VARCHAR(50) NULL COMMENT 'T√†i kho·∫£n ng√¢n h√†ng',
    `buyer_bank_name`           VARCHAR(200) NULL COMMENT 'T√™n ng√¢n h√†ng',
    `buyer_budget_code`        VARCHAR(20) NULL COMMENT 'M√£ ch∆∞∆°ng/NSNN',

    -- Amounts & Currency (DECIMAL(18,2) for precision)
    `subtotal_amount`           DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø',
    `tax_amount`                DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ø',
    `discount_amount`           DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng chi·∫øt kh·∫•u',
    `total_amount`              DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thanh to√°n',
    `gross_amount`              DECIMAL(18, 2)          DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn th√¥',
    `net_amount`                DECIMAL(18, 2)          DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ßn',
    `currency_code`             VARCHAR(3)     NOT NULL DEFAULT 'VND' COMMENT 'ƒê∆°n v·ªã ti·ªÅn t·ªá',
    `exchange_rate`            DECIMAL(10, 4) NOT NULL DEFAULT 1.0000 COMMENT 'T·ª∑ gi√°',

    -- Adjustment / Original Invoice Info
    `org_invoice_id`            VARCHAR(36) NULL COMMENT 'ID h√≥a ƒë∆°n g·ªëc',
    `org_invoice_form`          VARCHAR(50) NULL COMMENT 'M·∫´u h√≥a ƒë∆°n g·ªëc',
    `org_invoice_series`        VARCHAR(50) NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n g·ªëc',
    `org_invoice_no`            VARCHAR(50) NULL COMMENT 'S·ªë h√≥a ƒë∆°n g·ªëc',
    `org_invoice_date`          TIMESTAMP NULL COMMENT 'Ng√†y h√≥a ƒë∆°n g·ªëc',
    `org_invoice_reason`        VARCHAR(500) NULL COMMENT 'L√Ω do ƒëi·ªÅu ch·ªânh',
    `adjustment_type`           ENUM('ADJUSTMENT', 'REPLACEMENT', 'CANCELLATION') NULL COMMENT 'Lo·∫°i ƒëi·ªÅu ch·ªânh',
    `cancellation_reason`       VARCHAR(500) NULL COMMENT 'L√Ω do h·ªßy',
    `replaced_by_invoice_id`    BIGINT NULL COMMENT 'H√≥a ƒë∆°n thay th·∫ø',

    -- Status & Dates
    `status_id`                 INT            NOT NULL DEFAULT 1 COMMENT 'Tr·∫°ng th√°i h√≥a ƒë∆°n',
    `status_message`            TEXT NULL COMMENT 'Th√¥ng b√°o l·ªói ho·∫∑c tr·∫°ng th√°i chi ti·∫øt',
    `issue_date`                DATE NULL COMMENT 'Ng√†y l·∫≠p h√≥a ƒë∆°n',
    `accounting_date`           DATE NULL COMMENT 'Ng√†y h·∫°ch to√°n',
    `due_date`                  DATE NULL COMMENT 'Ng√†y h·∫°n thanh to√°n',

    -- Timestamps for Audit Trail
    `signed_at`                 TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm k√Ω s·ªë',
    `sent_to_provider_at`       TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i NCC',
    `received_from_provider_at` TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
    `delivered_to_buyer_at`     TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i kh√°ch h√†ng',

    -- Provider Feedback
    `provider_error_code`       VARCHAR(50) NULL COMMENT 'M√£ l·ªói t·ª´ Provider',
    `provider_error_message`    TEXT NULL COMMENT 'Chi ti·∫øt l·ªói t·ª´ Provider',

    -- Soft Delete
    `is_deleted`                BOOLEAN        NOT NULL DEFAULT FALSE,
    `deleted_at`                TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
    `deleted_by`                BIGINT NULL COMMENT 'Ng∆∞·ªùi x√≥a',

    -- System Audit Timestamps
    `created_at`                TIMESTAMP      NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`                TIMESTAMP      NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t cu·ªëi',

    -- Constraints
    CONSTRAINT `fk_invoice_merchant` FOREIGN KEY (`merchant_id`) REFERENCES `merchants` (`id`),
    CONSTRAINT `fk_invoice_status` FOREIGN KEY (`status_id`) REFERENCES `invoice_statuses` (`id`),
    CONSTRAINT `fk_invoice_provider` FOREIGN KEY (`provider_id`) REFERENCES `service_providers` (`id`),
    CONSTRAINT `fk_invoice_template` FOREIGN KEY (`invoice_template_id`) REFERENCES `invoice_template` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_invoice_config` FOREIGN KEY (`provider_config_id`) REFERENCES `merchant_provider_configs` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_invoice_payment_method` FOREIGN KEY (`payment_method`) REFERENCES `payment_methods` (`method_code`) ON DELETE SET NULL,
    CONSTRAINT `fk_invoice_replaced_by` FOREIGN KEY (`replaced_by_invoice_id`) REFERENCES `invoice_metadata` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_invoice_deleted_by` FOREIGN KEY (`deleted_by`) REFERENCES `merchant_user` (`id`) ON DELETE SET NULL,
    CONSTRAINT `uq_invoice_lookup_code` UNIQUE (`lookup_code`),

    -- Indexes for Search Optimization
    INDEX `idx_merchant_status` (`merchant_id`, `status_id`),
    INDEX `idx_invoice_number` (`invoice_number`),
    INDEX `idx_client_request_id` (`client_request_id`),
    INDEX `idx_partner_invoice` (`partner_invoice_id`),
    INDEX `idx_buyer_tax_code` (`buyer_tax_code`),
    INDEX `idx_issue_date` (`issue_date`),
    INDEX `idx_created_at` (`created_at`),
    INDEX `idx_cqt_code` (`cqt_code`),
    INDEX `idx_template_code` (`template_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='B·∫£ng l∆∞u tr·ªØ Metadata h√≥a ƒë∆°n t·ªïng h·ª£p';

-- =============================================================================
-- CORE TABLE 7: Invoice Items (Child of Invoice)
-- Line items belonging to a specific invoice
-- =============================================================================
CREATE TABLE `invoice_items` (
    `id`              BIGINT AUTO_INCREMENT PRIMARY KEY,
    `invoice_id`      BIGINT         NOT NULL COMMENT 'ID h√≥a ƒë∆°n cha',
    `line_number`     INT            NOT NULL DEFAULT 1 COMMENT 'S·ªë th·ª© t·ª± d√≤ng',

    -- Product Information
    `is_free`         BOOLEAN                 DEFAULT FALSE COMMENT 'H√†ng khuy·∫øn m√£i/bi·∫øu t·∫∑ng',
    `product_type_id` INT NULL COMMENT 'Lo·∫°i h√†ng h√≥a/d·ªãch v·ª•',
    `product_code`    VARCHAR(100) NULL COMMENT 'M√£ s·∫£n ph·∫©m',
    `product_name`    VARCHAR(500)   NOT NULL COMMENT 'T√™n h√†ng h√≥a/d·ªãch v·ª•',
    `unit_name`       VARCHAR(50) NULL COMMENT 'ƒê∆°n v·ªã t√≠nh',

    -- Quantity & Unit Price
    `quantity`        DECIMAL(18, 4) NOT NULL DEFAULT 0 COMMENT 'S·ªë l∆∞·ª£ng',
    `unit_price`      DECIMAL(18, 4) NOT NULL DEFAULT 0 COMMENT 'ƒê∆°n gi√° ch∆∞a thu·∫ø',

    -- Amount Calculations
    `gross_amount`    DECIMAL(18, 2)          DEFAULT 0 COMMENT 'Th√†nh ti·ªÅn th√¥',
    `discount_rate`   DECIMAL(5, 2)           DEFAULT 0 COMMENT 'T·ª∑ l·ªá chi·∫øt kh·∫•u (%)',
    `discount_amount` DECIMAL(18, 2)          DEFAULT 0 COMMENT 'Ti·ªÅn chi·∫øt kh·∫•u',
    `net_price`       DECIMAL(18, 4)          DEFAULT 0 COMMENT 'Gi√° sau chi·∫øt kh·∫•u ch∆∞a thu·∫ø',
    `net_amount`      DECIMAL(18, 2)          DEFAULT 0 COMMENT 'Th√†nh ti·ªÅn sau chi·∫øt kh·∫•u tr∆∞·ªõc thu·∫ø',

    -- Tax Information
    `tax_type_id`     VARCHAR(36) NULL COMMENT 'Ph√¢n lo·∫°i thu·∫ø',
    `tax_rate`        DECIMAL(5, 2)           DEFAULT 0 COMMENT 'M·ª©c thu·∫ø su·∫•t (%)',
    `tax_amount`      DECIMAL(18, 2)          DEFAULT 0 COMMENT 'Ti·ªÅn thu·∫ø GTGT',

    -- Total
    `total_amount`    DECIMAL(18, 2) NOT NULL DEFAULT 0 COMMENT 'T·ªïng thanh to√°n d√≤ng',

    -- Description
    `description`     TEXT NULL COMMENT 'M√¥ t·∫£ s·∫£n ph·∫©m',
    `notes`          VARCHAR(500) NULL COMMENT 'Ghi ch√∫ th√™m',

    `created_at`      TIMESTAMP      NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT `fk_item_invoice` FOREIGN KEY (`invoice_id`) REFERENCES `invoice_metadata` (`id`) ON DELETE CASCADE,
    INDEX `idx_item_invoice` (`invoice_id`),
    INDEX `idx_product_code` (`product_code`),
    INDEX `idx_line_number` (`line_number`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Chi ti·∫øt t·ª´ng d√≤ng h√†ng h√≥a/d·ªãch v·ª• trong h√≥a ƒë∆°n';

-- =============================================================================
-- CORE TABLE 8: Invoice Tax Breakdowns (Supporting Core Table)
-- Summary of tax amounts by rate for each invoice
-- =============================================================================
CREATE TABLE `invoice_tax_breakdowns` (
    `id`               BIGINT AUTO_INCREMENT PRIMARY KEY,
    `invoice_id`       BIGINT         NOT NULL COMMENT 'ID h√≥a ƒë∆°n cha',
    `vat_rate_id`      BIGINT         NOT NULL COMMENT 'Li√™n k·∫øt v·ªõi danh m·ª•c thu·∫ø su·∫•t',
    `vat_rate_code`    VARCHAR(10)    NOT NULL COMMENT 'M√£ thu·∫ø su·∫•t',
    `vat_rate_percent` DECIMAL(5, 2)  NOT NULL COMMENT 'Gi√° tr·ªã ph·∫ßn trƒÉm thu·∫ø su·∫•t',

    `subtotal_amount`  DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø',
    `discount_amount`  DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn chi·∫øt kh·∫•u',
    `taxable_amount`   DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn ch·ªãu thu·∫ø',
    `tax_amount`       DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ø GTGT',
    `total_amount`     DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn bao g·ªìm thu·∫ø',

    `created_at`       TIMESTAMP      NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',

    CONSTRAINT `fk_tax_breakdown_invoice` FOREIGN KEY (`invoice_id`)
        REFERENCES `invoice_metadata` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_tax_breakdown_vat_rate` FOREIGN KEY (`vat_rate_id`)
        REFERENCES `vat_rates` (`id`) ON DELETE RESTRICT,
    CONSTRAINT `uq_invoice_vat_rate` UNIQUE (`invoice_id`, `vat_rate_id`),

    INDEX `idx_breakdown_invoice` (`invoice_id`),
    INDEX `idx_breakdown_vat_rate` (`vat_rate_id`),
    INDEX `idx_vat_rate_code` (`vat_rate_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Ph√¢n r√£ thu·∫ø su·∫•t tr√™n t·ª´ng h√≥a ƒë∆°n';

-- =============================================================================
-- CORE TABLE 9: Invoice Adjustments (Supporting Core Table)
-- Track adjustment, replacement, and cancellation requests
-- =============================================================================
CREATE TABLE `invoice_adjustments` (
    `id`                   BIGINT AUTO_INCREMENT PRIMARY KEY,
    `original_invoice_id` BIGINT    NOT NULL COMMENT 'H√≥a ƒë∆°n g·ªëc b·ªã ƒëi·ªÅu ch·ªânh/thay th·∫ø/h·ªßy',
    `adjustment_type`      ENUM('ADJUSTMENT', 'REPLACEMENT', 'CANCELLATION') NOT NULL COMMENT 'Lo·∫°i ƒëi·ªÅu ch·ªânh',

    `agreement_number`     VARCHAR(50) NULL COMMENT 'S·ªë bi√™n b·∫£n th·ªèa thu·∫≠n',
    `agreement_date`       DATE NULL COMMENT 'Ng√†y l·∫≠p bi√™n b·∫£n',
    `agreement_content`    TEXT NULL COMMENT 'N·ªôi dung bi√™n b·∫£n th·ªèa thu·∫≠n',
    `signers`              TEXT NULL COMMENT 'Ng∆∞·ªùi k√Ω bi√™n b·∫£n (JSON array)',

    `reason_code`          VARCHAR(50) NULL COMMENT 'M√£ l√Ω do',
    `reason_description`   VARCHAR(500) NULL COMMENT 'M√¥ t·∫£ l√Ω do chi ti·∫øt',

    `old_subtotal_amount`  DECIMAL(18, 2) NULL COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø c≈©',
    `old_tax_amount`       DECIMAL(18, 2) NULL COMMENT 'Ti·ªÅn thu·∫ø c≈©',
    `old_total_amount`     DECIMAL(18, 2) NULL COMMENT 'T·ªïng ti·ªÅn c≈©',
    `new_subtotal_amount`  DECIMAL(18, 2) NULL COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø m·ªõi',
    `new_tax_amount`       DECIMAL(18, 2) NULL COMMENT 'Ti·ªÅn thu·∫ø m·ªõi',
    `new_total_amount`     DECIMAL(18, 2) NULL COMMENT 'T·ªïng ti·ªÅn m·ªõi',
    `difference_amount`    DECIMAL(18, 2) NULL COMMENT 'Ch√™nh l·ªách ti·ªÅn',

    `status`               ENUM('PENDING', 'APPROVED', 'REJECTED', 'CANCELLED') NOT NULL DEFAULT 'PENDING' COMMENT 'Tr·∫°ng th√°i duy·ªát',
    `approved_at`          TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm duy·ªát',

    `submitted_to_cqt`     BOOLEAN   NOT NULL DEFAULT FALSE COMMENT 'ƒê√£ g·ª≠i C∆° quan Thu·∫ø',
    `cqt_response_code`    VARCHAR(50) NULL COMMENT 'M√£ ph·∫£n h·ªìi t·ª´ CQT',
    `cqt_response_message` TEXT NULL COMMENT 'N·ªôi dung ph·∫£n h·ªìi t·ª´ CQT',

    `created_at`           TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`           TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT `fk_adjustment_original_invoice` FOREIGN KEY (`original_invoice_id`)
        REFERENCES `invoice_metadata` (`id`) ON DELETE RESTRICT,

    INDEX `idx_adjustment_original` (`original_invoice_id`),
    INDEX `idx_adjustment_type` (`adjustment_type`),
    INDEX `idx_adjustment_status` (`status`),
    INDEX `idx_agreement_date` (`agreement_date`),
    INDEX `idx_submitted_cqt` (`submitted_to_cqt`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Th√¥ng tin bi√™n b·∫£n th·ªèa thu·∫≠n cho h√≥a ƒë∆°n ƒëi·ªÅu ch·ªânh/thay th·∫ø/h·ªßy';

-- =============================================================================
-- SECTION 3: ENTERPRISE SHELL MODULES (Management & Auxiliary Tables)
-- Strategy: Use INDEX instead of FK for performance and decoupling
-- =============================================================================

-- =============================================================================
-- MANAGEMENT TABLE 1: Invoice Payloads (One-to-One with Metadata)
-- Stores raw XML/JSON data for audit and reprint purposes
-- =============================================================================
CREATE TABLE `invoice_payloads` (
    `invoice_id`   BIGINT    NOT NULL PRIMARY KEY COMMENT 'ID h√≥a ƒë∆°n - kh√≥a ch√≠nh v√† kh√≥a ngo·∫°i',
    `raw_data`     JSON NULL COMMENT 'D·ªØ li·ªáu th√¥ request/response d·∫°ng JSON',
    `xml_content`  LONGTEXT NULL COMMENT 'N·ªôi dung XML g·ªëc c·ªßa h√≥a ƒë∆°n',
    `json_content` LONGTEXT NULL COMMENT 'N·ªôi dung JSON ƒë·∫ßy ƒë·ªß c·ªßa h√≥a ƒë∆°n',
    `signed_xml`   LONGTEXT NULL COMMENT 'XML ƒë√£ k√Ω ƒëi·ªán t·ª≠',
    `pdf_data`     LONGTEXT NULL COMMENT 'D·ªØ li·ªáu PDF ƒë√£ t·∫°o (base64)',
    `extra_data`   JSON NULL COMMENT 'D·ªØ li·ªáu b·ªï sung kh√°c',
    `created_at`   TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm l∆∞u',
    `updated_at`   TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT `fk_invoice_payload_invoice` FOREIGN KEY (`invoice_id`)
        REFERENCES `invoice_metadata` (`id`) ON DELETE CASCADE,

    INDEX `idx_payload_created` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u tr·ªØ n·ªôi dung XML/JSON g·ªëc h√≥a ƒë∆°n';

-- =============================================================================
-- MANAGEMENT TABLE 2: API Credentials
-- For external systems accessing the API (uses INDEX instead of FK)
-- =============================================================================
CREATE TABLE `api_credentials` (
    `id`                        BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`               BIGINT       NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu credential',
    `client_id`                 VARCHAR(50)  NOT NULL UNIQUE COMMENT 'ID c√¥ng khai c·ªßa ·ª©ng d·ª•ng',
    `api_key_hash`              VARCHAR(255) NOT NULL COMMENT 'Hash c·ªßa API Key (SHA-256)',
    `api_key_prefix`            VARCHAR(8)   NOT NULL COMMENT '8 k√Ω t·ª± ƒë·∫ßu c·ªßa API Key',
    `scopes`                    TEXT         NOT NULL COMMENT 'Quy·ªÅn h·∫°n - JSON array',
    `ip_whitelist`              TEXT NULL COMMENT 'Danh s√°ch IP ƒë∆∞·ª£c ph√©p - JSON array',
    `rate_limit_per_hour`       INT          NOT NULL DEFAULT 1000 COMMENT 'Gi·ªõi h·∫°n request/gi·ªù',
    `rate_limit_per_day`        INT          NOT NULL DEFAULT 10000 COMMENT 'Gi·ªõi h·∫°n request/ng√†y',
    `request_count_hour`        INT          NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong gi·ªù',
    `request_count_day`         INT          NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong ng√†y',
    `request_count_resetted_at` TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm reset counter',
    `expired_at`                TIMESTAMP NULL COMMENT 'Ng√†y h·∫øt h·∫°n - NULL kh√¥ng gi·ªõi h·∫°n',
    `last_used_at`              TIMESTAMP NULL COMMENT 'L·∫ßn s·ª≠ d·ª•ng cu·ªëi',
    `is_active`                 BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    `created_at`                TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`                TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    -- Using INDEX instead of FK for performance (decoupled from merchant table)
    INDEX `idx_merchant_id` (`merchant_id`),
    INDEX `idx_client_id` (`client_id`),
    INDEX `idx_api_key_hash` (`api_key_hash`),
    INDEX `idx_expired_at` (`expired_at`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Credentials cho API access';

-- =============================================================================
-- MANAGEMENT TABLE 3: Audit Logs
-- System-wide immutable log (No FKs to prevent locking/blocking)
-- =============================================================================
CREATE TABLE `audit_logs` (
    `id`              BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`     BIGINT NULL COMMENT 'Doanh nghi·ªáp li√™n quan',
    `user_id`         BIGINT NULL COMMENT 'Ng∆∞·ªùi th·ª±c hi·ªán',
    `entity_type`     VARCHAR(50) NOT NULL COMMENT 'Lo·∫°i entity: Invoice, Merchant, Config...',
    `entity_id`       BIGINT      NOT NULL COMMENT 'ID c·ªßa entity',
    `action`          VARCHAR(50) NOT NULL COMMENT 'H√†nh ƒë·ªông: CREATE, UPDATE, DELETE, STATUS_CHANGE',
    `old_value`       JSON NULL COMMENT 'Gi√° tr·ªã c≈©',
    `new_value`       JSON NULL COMMENT 'Gi√° tr·ªã m·ªõi',
    `ip_address`      VARCHAR(45) NULL COMMENT 'IP th·ª±c hi·ªán',
    `user_agent`      VARCHAR(500) NULL COMMENT 'User Agent c·ªßa browser/client',
    `request_id`      VARCHAR(100) NULL COMMENT 'ID request t·ª´ frontend',
    `created_at`      TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm x·∫£y ra',

    -- Using INDEX instead of FK for high-performance logging
    INDEX `idx_merchant_id` (`merchant_id`),
    INDEX `idx_user_id` (`user_id`),
    INDEX `idx_entity` (`entity_type`, `entity_id`),
    INDEX `idx_action` (`action`),
    INDEX `idx_created_at` (`created_at`),
    INDEX `idx_merchant_entity` (`merchant_id`, `entity_type`, `entity_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Nh·∫≠t k√Ω thay ƒë·ªïi h·ªá th·ªëng';

-- =============================================================================
-- MANAGEMENT TABLE 4: Invoice Sync Queue
-- Background job queue for processing invoices
-- =============================================================================
CREATE TABLE `invoice_sync_queue` (
    `id`                      BIGINT AUTO_INCREMENT PRIMARY KEY,
    `invoice_id`              BIGINT    NOT NULL COMMENT 'ID h√≥a ƒë∆°n c·∫ßn ƒë·ªìng b·ªô',
    `sync_type`               ENUM('SEND_TO_PROVIDER', 'SEND_TO_CQT', 'CANCEL_INVOICE', 'REPLACE_INVOICE') NOT NULL COMMENT 'Lo·∫°i thao t√°c ƒë·ªìng b·ªô',
    `priority`                INT       NOT NULL DEFAULT 5 COMMENT 'ƒê·ªô ∆∞u ti√™n (1=cao nh·∫•t, 10=th·∫•p nh·∫•t)',

    `status`                  ENUM('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED', 'RETRYING') NOT NULL DEFAULT 'PENDING' COMMENT 'Tr·∫°ng th√°i x·ª≠ l√Ω',
    `attempt_count`           INT       NOT NULL DEFAULT 0 COMMENT 'S·ªë l·∫ßn th·ª≠',
    `max_attempts`            INT       NOT NULL DEFAULT 3 COMMENT 'S·ªë l·∫ßn th·ª≠ t·ªëi ƒëa',
    `last_attempt_at`         TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm th·ª≠ l·∫ßn cu·ªëi',
    `next_retry_at`           TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm th·ª≠ ti·∫øp theo',

    `request_data`            JSON NULL COMMENT 'D·ªØ li·ªáu request g·ª≠i ƒëi',
    `response_data`           JSON NULL COMMENT 'D·ªØ li·ªáu response nh·∫≠n v·ªÅ',
    `error_code`              VARCHAR(50) NULL COMMENT 'M√£ l·ªói',
    `error_message`           TEXT NULL COMMENT 'Chi ti·∫øt l·ªói',

    `processed_by`            VARCHAR(100) NULL COMMENT 'Worker x·ª≠ l√Ω',
    `processing_started_at`   TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu x·ª≠ l√Ω',
    `processing_completed_at` TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm ho√†n th√†nh',

    `created_at`              TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`              TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT `fk_sync_queue_invoice` FOREIGN KEY (`invoice_id`)
        REFERENCES `invoice_metadata` (`id`) ON DELETE CASCADE,

    CONSTRAINT `chk_sync_attempt_count` CHECK (`attempt_count` <= `max_attempts`),

    INDEX `idx_sync_queue_status` (`status`),
    INDEX `idx_sync_queue_invoice` (`invoice_id`),
    INDEX `idx_sync_queue_merchant` (`invoice_id`),
    INDEX `idx_sync_queue_priority` (`priority`),
    INDEX `idx_sync_queue_next_retry` (`next_retry_at`),
    INDEX `idx_sync_queue_created` (`created_at`),
    INDEX `idx_sync_queue_status_priority` (`status`, `priority`, `next_retry_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='H√†ng ƒë·ª£i g·ª≠i h√≥a ƒë∆°n sang Provider/CQT';

-- =============================================================================
-- MANAGEMENT TABLE 5: Tax Authority Responses
-- Store responses from tax authorities
-- =============================================================================
CREATE TABLE `tax_authority_responses` (
    `id`              BIGINT AUTO_INCREMENT PRIMARY KEY,
    `invoice_id`      BIGINT      NOT NULL COMMENT 'H√≥a ƒë∆°n li√™n quan',
    `cqt_code`        VARCHAR(50) NOT NULL COMMENT 'M√£ C∆° quan Thu·∫ø',
    `status_from_cqt` VARCHAR(50) NOT NULL COMMENT 'Tr·∫°ng th√°i t·ª´ C∆° quan Thu·∫ø',
    `processing_code` VARCHAR(100) NULL COMMENT 'M√£ x·ª≠ l√Ω t·ª´ C∆° quan Thu·∫ø',
    `signature_data`  TEXT NULL COMMENT 'D·ªØ li·ªáu ch·ªØ k√Ω t·ª´ C∆° quan Thu·∫ø',
    `raw_response`    JSON NULL COMMENT 'Response th√¥ t·ª´ C∆° quan Thu·∫ø',
    `error_code`      VARCHAR(50) NULL COMMENT 'M√£ l·ªói t·ª´ C∆° quan Thu·∫ø',
    `error_message`   TEXT NULL COMMENT 'Th√¥ng b√°o l·ªói t·ª´ C∆° quan Thu·∫ø',
    `received_at`    TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
    `processed_at`   TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x·ª≠ l√Ω ho√†n t·∫•t',
    `created_at`     TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o b·∫£n ghi',

    CONSTRAINT `fk_tax_response_invoice` FOREIGN KEY (`invoice_id`)
        REFERENCES `invoice_metadata` (`id`) ON DELETE CASCADE,

    INDEX `idx_tax_response_invoice` (`invoice_id`),
    INDEX `idx_cqt_code` (`cqt_code`),
    INDEX `idx_status_cqt` (`status_from_cqt`),
    INDEX `idx_received_at` (`received_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u v·∫øt t∆∞∆°ng t√°c v·ªõi C∆° quan Thu·∫ø';

-- =============================================================================
-- MANAGEMENT TABLE 6: System Configuration
-- Key-value configuration storage (No FKs)
-- =============================================================================
CREATE TABLE `system_config` (
    `id`           BIGINT AUTO_INCREMENT PRIMARY KEY,
    `config_key`   VARCHAR(100) NOT NULL UNIQUE COMMENT 'Kh√≥a c·∫•u h√¨nh',
    `config_value` TEXT         NOT NULL COMMENT 'Gi√° tr·ªã c·∫•u h√¨nh',
    `config_type`  VARCHAR(20)  NOT NULL DEFAULT 'STRING' COMMENT 'Lo·∫°i: STRING, NUMBER, BOOLEAN, JSON',
    `description` VARCHAR(500) NULL COMMENT 'M√¥ t·∫£ c·∫•u h√¨nh',
    `is_encrypted` BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'C√≥ c·∫ßn m√£ h√≥a kh√¥ng',
    `is_editable`  BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'C√≥ th·ªÉ ch·ªânh s·ª≠a kh√¥ng',
    `updated_by`   BIGINT NULL COMMENT 'Ng∆∞·ªùi c·∫≠p nh·∫≠t cu·ªëi',
    `updated_at`   TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    INDEX `idx_config_key` (`config_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='C·∫•u h√¨nh h·ªá th·ªëng';

-- Insert default system configurations
INSERT INTO system_config (config_key, config_value, config_type, description) VALUES
('SYSTEM_NAME', 'EInvoiceHub', 'STRING', 'T√™n hi·ªÉn th·ªã c·ªßa h·ªá th·ªëng'),
('INVOICE_EXPIRY_DAYS', '30', 'NUMBER', 'S·ªë ng√†y h√≥a ƒë∆°n c√≥ hi·ªáu l·ª±c sau khi ph√°t h√†nh'),
('MAX_RETRY_ATTEMPTS', '3', 'NUMBER', 'S·ªë l·∫ßn th·ª≠ l·∫°i khi g·ªçi Provider th·∫•t b·∫°i'),
('RETRY_DELAY_MS', '1000', 'NUMBER', 'Th·ªùi gian ch·ªù gi·ªØa c√°c l·∫ßn th·ª≠ l·∫°i (milliseconds)'),
('SESSION_TIMEOUT_MINUTES', '60', 'NUMBER', 'Th·ªùi gian timeout c·ªßa session'),
('PASSWORD_MIN_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i t·ªëi thi·ªÉu c·ªßa m·∫≠t kh·∫©u'),
('API_KEY_PREFIX_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i prefix hi·ªÉn th·ªã c·ªßa API Key'),
('DEFAULT_CURRENCY', 'VND', 'STRING', 'ƒê∆°n v·ªã ti·ªÅn t·ªá m·∫∑c ƒë·ªãnh'),
('TAX_DEFAULT_RATE', '10.00', 'NUMBER', 'Thu·∫ø su·∫•t m·∫∑c ƒë·ªãnh (%)'),
('BACKGROUND_JOB_ENABLED', 'true', 'BOOLEAN', 'K√≠ch ho·∫°t x·ª≠ l√Ω background jobs'),
('INVOICE_LOOKUP_CODE_LENGTH', '6', 'NUMBER', 'ƒê·ªô d√†i m√£ tra c·ª©u h√≥a ƒë∆°n ng·∫´u nhi√™n');

-- =============================================================================
-- SECTION 4: SYSTEM VIEWS
-- =============================================================================

-- View for user authorization
CREATE OR REPLACE VIEW `vw_sys_user_author` AS
SELECT
    CAST(id AS CHAR) AS id,
    username         AS name,
    full_name        AS full_name
FROM merchant_user
WHERE is_active = TRUE;

SET FOREIGN_KEY_CHECKS = 1;

-- =============================================================================
-- SCHEMA SUMMARY
-- =============================================================================
/*
Architecture Overview:
======================

CORE JPA TABLES (9 tables - Hierarchical Flow):
-------------------------------------------------
1. merchants              -> Root entity (contains Shell fields: subscription_plan, invoice_quota, updated_at)
2. merchant_user         -> Child of merchants
3. merchant_provider_configs -> Child of merchants (contains Shell fields: is_test_mode, encrypted_password_storage)
4. invoice_template      -> Child of merchants
5. invoice_registrations -> Child of merchants
6. invoice_metadata      -> Central transaction (contains Shell fields: lookup_code, cqt_code, provider_transaction_id)
7. invoice_items         -> Child of invoice_metadata
8. invoice_tax_breakdowns -> Child of invoice_metadata
9. invoice_adjustments   -> Related to invoice_metadata

ENTERPRISE SHELL MODULES (Management Tables):
----------------------------------------------
- invoice_payloads       -> One-to-One with invoice_metadata
- api_credentials        -> INDEX-based (decoupled)
- audit_logs             -> INDEX-based (high-performance)
- invoice_sync_queue     -> Background processing
- tax_authority_responses -> External system integration
- system_config          -> Key-value configuration

Data Flow (Hierarchical - No Reverse Dependencies):
---------------------------------------------------
Merchants -> ProviderConfigs -> Templates -> Invoices -> InvoiceItems
     |
     +-> Users
     +-> Registrations

Key Design Decisions:
---------------------
1. Flat Metadata Strategy: Buyer information stored directly in invoice_metadata
   to prevent circular dependencies when generating historical reports.

2. Hard FK for Core Relations: Ensures data integrity for business-critical
   relationships (Invoice->Items, Invoice->Template, etc.)

3. INDEX for Auxiliary Tables: audit_logs and system_config use INDEX instead
   of FK to maintain high performance and prevent locking issues.

4. NULLABLE Shell Fields: All new enterprise fields are NULLABLE to maintain
   JPA compatibility with existing Spring Boot save() methods.

5. DECIMAL(18,2): Used for all monetary values to ensure precision.

6. utf8mb4_unicode_ci: Full Unicode support including emojis.
*/
</file>

<file path="src/main/java/com/einvoicehub/core/config/SecurityConfig.java">
package com.einvoicehub.core.config;

import com.einvoicehub.core.security.ApiKeyFilter;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfig {

    private final ApiKeyFilter apiKeyFilter;

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
                .csrf(AbstractHttpConfigurer::disable)
                .sessionManagement(session ->
                        session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers(
                                "/api/actuator/**",
                                "/api/v3/api-docs/**",
                                "/api/swagger-ui/**",
                                "/api/health/**"
                        ).permitAll()
                        .anyRequest().authenticated())
                .addFilterBefore(apiKeyFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/config/VirtualThreadConfig.java">
package com.einvoicehub.core.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

@Configuration
public class VirtualThreadConfig {

    /* Use Java 21 Virtual Threads to handle high-concurrency Provider API calls efficiently */
    @Bean
    public ExecutorService virtualThreadExecutorService() {
        return Executors.newVirtualThreadPerTaskExecutor();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/config/WebClientConfig.java">
package com.einvoicehub.core.config;

import io.netty.channel.ChannelOption;
import io.netty.handler.timeout.ReadTimeoutHandler;
import io.netty.handler.timeout.WriteTimeoutHandler;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;
import org.springframework.http.client.reactive.ReactorClientHttpConnector;
import org.springframework.web.reactive.function.client.ExchangeStrategies;
import org.springframework.web.reactive.function.client.WebClient;
import reactor.netty.http.client.HttpClient;

import java.time.Duration;
import java.util.concurrent.TimeUnit;

@Configuration
public class WebClientConfig {

    @Value("${app.provider.timeout-ms:30000}")
    private int defaultTimeout;

    @Value("${provider.vnpt.timeout-ms:30000}")
    private int vnptTimeout;

    @Value("${provider.viettel.timeout-ms:30000}")
    private int viettelTimeout;

    @Value("${provider.bkav.timeout-ms:30000}")
    private int bkavTimeout;

    @Value("${provider.misa.timeout-ms:30000}")
    private int misaTimeout;

    @Bean
    @Primary
    public WebClient.Builder webClientBuilder() {
        /* Increase memory buffer to 16MB for large XML/PDF invoice processing */
        ExchangeStrategies strategies = ExchangeStrategies.builder()
                .codecs(configurer -> configurer.defaultCodecs().maxInMemorySize(16 * 1024 * 1024))
                .build();

        return WebClient.builder()
                .exchangeStrategies(strategies)
                .clientConnector(new ReactorClientHttpConnector(createHttpClient(defaultTimeout, defaultTimeout * 2)));
    }

    @Bean(name = "vnptWebClient")
    public WebClient vnptWebClient(WebClient.Builder builder, @Value("${provider.vnpt.base-url:}") String url) {
        return createWebClient(builder, url, vnptTimeout);
    }

    @Bean(name = "viettelWebClient")
    public WebClient viettelWebClient(WebClient.Builder builder, @Value("${provider.viettel.base-url:}") String url) {
        return createWebClient(builder, url, viettelTimeout);
    }

    @Bean(name = "bkavWebClient")
    public WebClient bkavWebClient(WebClient.Builder builder, @Value("${provider.bkav.base-url:}") String url) {
        return createWebClient(builder, url, bkavTimeout);
    }

    @Bean(name = "misaWebClient")
    public WebClient misaWebClient(WebClient.Builder builder, @Value("${provider.misa.base-url:}") String url) {
        return createWebClient(builder, url, misaTimeout);
    }

    private WebClient createWebClient(WebClient.Builder builder, String baseUrl, int timeout) {
        return builder.clone()
                .baseUrl(baseUrl)
                .clientConnector(new ReactorClientHttpConnector(createHttpClient(timeout, timeout * 2)))
                .build();
    }

    private HttpClient createHttpClient(int connectTimeout, int readWriteTimeout) {
        return HttpClient.create()
                .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, connectTimeout)
                .responseTimeout(Duration.ofMillis(readWriteTimeout))
                .doOnConnected(conn -> conn
                        .addHandlerLast(new ReadTimeoutHandler(readWriteTimeout, TimeUnit.MILLISECONDS))
                        .addHandlerLast(new WriteTimeoutHandler(readWriteTimeout, TimeUnit.MILLISECONDS)));
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/converter/EncryptionConverter.java">
package com.einvoicehub.core.converter;

import jakarta.persistence.AttributeConverter;
import jakarta.persistence.Converter;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import javax.crypto.Cipher;
import javax.crypto.spec.GCMParameterSpec;
import javax.crypto.spec.SecretKeySpec;
import java.nio.ByteBuffer;
import java.nio.charset.StandardCharsets;
import java.security.SecureRandom;
import java.util.Base64;

@Converter
@Component
public class EncryptionConverter implements AttributeConverter<String, String> {

    private static final String ALGORITHM = "AES/GCM/NoPadding";
    private static final int IV_LENGTH = 12;
    private static final int TAG_LENGTH = 128;

    @Value("${app.security.encryption.key}")
    private String secretKey;

    private SecretKeySpec getSecretKey() {
        byte[] keyBytes = secretKey.getBytes(StandardCharsets.UTF_8);
        byte[] adjustedKey = new byte[32];
        System.arraycopy(keyBytes, 0, adjustedKey, 0, Math.min(keyBytes.length, 32));
        return new SecretKeySpec(adjustedKey, "AES");
    }

    @Override
    public String convertToDatabaseColumn(String attribute) {
        if (attribute == null || attribute.isEmpty()) return null;
        try {
            Cipher cipher = Cipher.getInstance(ALGORITHM);
            byte[] iv = new byte[IV_LENGTH];
            new SecureRandom().nextBytes(iv);

            cipher.init(Cipher.ENCRYPT_MODE, getSecretKey(), new GCMParameterSpec(TAG_LENGTH, iv));
            byte[] encrypted = cipher.doFinal(attribute.getBytes(StandardCharsets.UTF_8));

            ByteBuffer buffer = ByteBuffer.allocate(iv.length + encrypted.length);
            buffer.put(iv).put(encrypted);
            return Base64.getEncoder().encodeToString(buffer.array());
        } catch (Exception e) {
            throw new IllegalStateException("Encryption failure: " + e.getMessage());
        }
    }

    @Override
    public String convertToEntityAttribute(String dbData) {
        if (dbData == null || dbData.isEmpty()) return null;
        try {
            byte[] decoded = Base64.getDecoder().decode(dbData);
            ByteBuffer buffer = ByteBuffer.wrap(decoded);

            byte[] iv = new byte[IV_LENGTH];
            buffer.get(iv);
            byte[] encrypted = new byte[buffer.remaining()];
            buffer.get(encrypted);

            Cipher cipher = Cipher.getInstance(ALGORITHM);
            cipher.init(Cipher.DECRYPT_MODE, getSecretKey(), new GCMParameterSpec(TAG_LENGTH, iv));
            return new String(cipher.doFinal(encrypted), StandardCharsets.UTF_8);
        } catch (Exception e) {
            throw new IllegalStateException("Decryption failure: " + e.getMessage());
        }
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/converter/JsonAttributeConverter.java">
package com.einvoicehub.core.converter;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import jakarta.persistence.AttributeConverter;
import jakarta.persistence.Converter;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.Map;

@Converter
@Component
public class JsonAttributeConverter implements AttributeConverter<Object, String> {

    private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();

    @Override
    public String convertToDatabaseColumn(Object attribute) {
        if (attribute == null) return null;
        try {
            return OBJECT_MAPPER.writeValueAsString(attribute);
        } catch (JsonProcessingException e) {
            throw new IllegalArgumentException("JSON serialization error: " + e.getMessage());
        }
    }

    @Override
    public Object convertToEntityAttribute(String dbData) {
        if (dbData == null || dbData.isEmpty()) return null;
        try {
            return OBJECT_MAPPER.readValue(dbData, Object.class);
        } catch (JsonProcessingException e) {
            throw new IllegalArgumentException("JSON deserialization error: " + e.getMessage());
        }
    }

    public static List<String> fromJsonToList(String json) {
        if (json == null || json.isEmpty()) return List.of();
        try {
            return OBJECT_MAPPER.readValue(json, new TypeReference<List<String>>() {});
        } catch (JsonProcessingException e) {
            throw new IllegalArgumentException("JSON to List conversion error");
        }
    }

    public static Map<String, Object> fromJsonToMap(String json) {
        if (json == null || json.isEmpty()) return Map.of();
        try {
            return OBJECT_MAPPER.readValue(json, new TypeReference<Map<String, Object>>() {});
        } catch (JsonProcessingException e) {
            throw new IllegalArgumentException("JSON to Map conversion error");
        }
    }

    public static String toJson(Object obj) {
        if (obj == null) return null;
        try {
            return OBJECT_MAPPER.writeValueAsString(obj);
        } catch (JsonProcessingException e) {
            throw new IllegalArgumentException("Object to JSON conversion error");
        }
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/enums/AdjustmentStatus.java">
package com.einvoicehub.core.domain.entity.enums;

public enum AdjustmentStatus {
    PENDING, APPROVED, REJECTED, CANCELLED
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/enums/AdjustmentType.java">
package com.einvoicehub.core.domain.entity.enums;

public enum AdjustmentType {
    ADJUSTMENT, REPLACEMENT, CANCELLATION
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/enums/AuditAction.java">
package com.einvoicehub.core.domain.entity.enums;

public enum AuditAction {
    CREATE, UPDATE, DELETE, STATUS_CHANGE
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/enums/IssuanceMethod.java">
package com.einvoicehub.core.domain.entity.enums;

public enum IssuanceMethod {
    STANDARD, POS
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/enums/SubscriptionPlan.java">
package com.einvoicehub.core.domain.entity.enums;

public enum SubscriptionPlan {
    TRIAL, BASIC, PREMIUM
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/enums/SyncStatus.java">
package com.einvoicehub.core.domain.entity.enums;

public enum SyncStatus {
    PENDING,    // Ch·ªù x·ª≠ l√Ω
    PROCESSING, // ƒêang x·ª≠ l√Ω
    COMPLETED,  // ƒê√£ ho√†n th√†nh th√†nh c√¥ng
    FAILED,     // Th·∫•t b·∫°i sau khi ƒë√£ th·ª≠ ƒë·ªß s·ªë l·∫ßn
    RETRYING    // ƒêang ch·ªù ƒë·ªÉ th·ª≠ l·∫°i
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/enums/SyncType.java">
package com.einvoicehub.core.domain.entity.enums;

public enum SyncType {
    SEND_TO_PROVIDER,   // G·ª≠i h√≥a ƒë∆°n sang nh√† cung c·∫•p d·ªãch v·ª•
    SEND_TO_CQT,        // G·ª≠i th√¥ng tin sang C∆° quan Thu·∫ø
    CANCEL_INVOICE,     // H·ªßy h√≥a ƒë∆°n tr√™n h·ªá th·ªëng Provider
    REPLACE_INVOICE     // Thay th·∫ø h√≥a ƒë∆°n tr√™n h·ªá th·ªëng Provider
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/enums/UserRole.java">
package com.einvoicehub.core.domain.entity.enums;

public enum UserRole {
    ADMIN, MANAGER, STAFF, VIEWER
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvApiCredentialsEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "api_credentials")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = "merchant")
public class EinvApiCredentialsEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "merchant_id", nullable = false)
    private EinvMerchantEntity merchant;

    @Column(name = "client_id", length = 50, nullable = false, unique = true)
    private String clientId;

    @Column(name = "api_key_hash", length = 255, nullable = false)
    private String apiKeyHash;

    @Column(name = "api_key_prefix", length = 8, nullable = false)
    private String apiKeyPrefix;

    @Column(name = "scopes", columnDefinition = "TEXT", nullable = false)
    private String scopes; // L∆∞u danh s√°ch quy·ªÅn d·∫°ng JSON array

    // --- Enterprise Shell Fields (H·∫° t·∫ßng b·∫£o m·∫≠t & Gi·ªõi h·∫°n t·∫£i) ---
    @Column(name = "ip_whitelist", columnDefinition = "TEXT")
    private String ipWhitelist;

    @Builder.Default
    @Column(name = "rate_limit_per_hour", nullable = false)
    private Integer rateLimitPerHour = 1000;

    @Builder.Default
    @Column(name = "rate_limit_per_day", nullable = false)
    private Integer rateLimitPerDay = 10000;

    @Builder.Default
    @Column(name = "request_count_hour", nullable = false)
    private Integer requestCountHour = 0;

    @Builder.Default
    @Column(name = "request_count_day", nullable = false)
    private Integer requestCountDay = 0;

    @Column(name = "request_count_resetted_at")
    private LocalDateTime requestCountResettedAt;

    @Column(name = "expired_at")
    private LocalDateTime expiredAt;

    @Column(name = "last_used_at")
    private LocalDateTime lastUsedAt;

    @Builder.Default
    @Column(name = "is_active", nullable = false)
    private Boolean isActive = true;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvAuditLogsEntity.java">
package com.einvoicehub.core.domain.entity;

import com.einvoicehub.core.domain.entity.enums.AuditAction;
import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "audit_logs")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = {"merchant", "user"})
public class EinvAuditLogsEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "merchant_id")
    private EinvMerchantEntity merchant; // Doanh nghi·ªáp li√™n quan

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "user_id")
    private EinvMerchantUserEntity user; // Ng∆∞·ªùi th·ª±c hi·ªán

    @Column(name = "entity_type", length = 50, nullable = false)
    private String entityType; // Lo·∫°i ƒë·ªëi t∆∞·ª£ng (Invoice, Config...)

    @Column(name = "entity_id", nullable = false)
    private Long entityId;

    @Enumerated(EnumType.STRING)
    @Column(name = "action", length = 50, nullable = false)
    private AuditAction action;

    // --- Core Management Fields (D·ªØ li·ªáu ph·ª•c v·ª• ƒë·ªëi so√°t) ---
    @Column(name = "old_value", columnDefinition = "JSON")
    private String oldValue;

    @Column(name = "new_value", columnDefinition = "JSON")
    private String newValue;

    // --- Enterprise Shell Fields (L∆∞u v·∫øt h·∫° t·∫ßng) ---
    @Column(name = "ip_address", length = 45)
    private String ipAddress;

    @Column(name = "user_agent", length = 500)
    private String userAgent;

    @Column(name = "request_id", length = 100)
    private String requestId;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvInvoiceAdjustmentsEntity.java">
package com.einvoicehub.core.domain.entity;

import com.einvoicehub.core.domain.entity.enums.AdjustmentType;
import com.einvoicehub.core.domain.entity.enums.AdjustmentStatus;
import jakarta.persistence.*;
import lombok.*;
import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoice_adjustments")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = "originalInvoice")
public class EinvInvoiceAdjustmentsEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "original_invoice_id", nullable = false)
    private EinvInvoiceMetadataEntity originalInvoice;

    @Enumerated(EnumType.STRING)
    @Column(name = "adjustment_type", nullable = false)
    private AdjustmentType adjustmentType;

    // --- Agreement Information ---
    @Column(name = "agreement_number", length = 50)
    private String agreementNumber;

    @Column(name = "agreement_date")
    private LocalDate agreementDate;

    @Column(name = "agreement_content", columnDefinition = "TEXT")
    private String agreementContent;

    @Column(name = "signers", columnDefinition = "TEXT")
    private String signers; // JSON list of signers

    @Column(name = "reason_code", length = 50)
    private String reasonCode;

    @Column(name = "reason_description", length = 500)
    private String reasonDescription;

    // --- Financial Comparison (Precision 18,2) ---
    @Column(name = "old_subtotal_amount", precision = 18, scale = 2)
    private BigDecimal oldSubtotalAmount;

    @Column(name = "old_tax_amount", precision = 18, scale = 2)
    private BigDecimal oldTaxAmount;

    @Column(name = "old_total_amount", precision = 18, scale = 2)
    private BigDecimal oldTotalAmount;

    @Column(name = "new_subtotal_amount", precision = 18, scale = 2)
    private BigDecimal newSubtotalAmount;

    @Column(name = "new_tax_amount", precision = 18, scale = 2)
    private BigDecimal newTaxAmount;

    @Column(name = "new_total_amount", precision = 18, scale = 2)
    private BigDecimal newTotalAmount;

    @Column(name = "difference_amount", precision = 18, scale = 2)
    private BigDecimal differenceAmount;

    // --- Status & Workflow ---
    @Enumerated(EnumType.STRING)
    @Builder.Default
    @Column(name = "status", nullable = false)
    private AdjustmentStatus status = AdjustmentStatus.PENDING;

    @Column(name = "approved_at")
    private LocalDateTime approvedAt;

    // --- Shell Fields (CQT Integration) ---
    @Builder.Default
    @Column(name = "submitted_to_cqt", nullable = false)
    private Boolean submittedToCqt = false;

    @Column(name = "cqt_response_code", length = 50)
    private String cqtResponseCode;

    @Column(name = "cqt_response_message", columnDefinition = "TEXT")
    private String cqtResponseMessage;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvInvoiceItemEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.math.BigDecimal;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoice_items")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = {"invoice", "vatRate"})
public class EinvInvoiceItemEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "invoice_id", nullable = false)
    private EinvInvoiceMetadataEntity invoice; // Li√™n k·∫øt h√≥a ƒë∆°n cha

    @Column(name = "line_number", nullable = false)
    private Integer lineNumber; // S·ªë th·ª© t·ª± d√≤ng

    // --- Product Information ---
    @Builder.Default
    @Column(name = "is_free")
    private Boolean isFree = false; // H√†ng khuy·∫øn m√£i

    @Column(name = "product_type_id")
    private Integer productTypeId;

    @Column(name = "product_code", length = 100)
    private String productCode;

    @Column(name = "product_name", length = 500, nullable = false)
    private String productName;

    @Column(name = "unit_name", length = 50)
    private String unitName;

    // --- Quantity & Price (Precision 18,4) ---
    @Builder.Default
    @Column(name = "quantity", precision = 18, scale = 4, nullable = false)
    private BigDecimal quantity = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "unit_price", precision = 18, scale = 4, nullable = false)
    private BigDecimal unitPrice = BigDecimal.ZERO;

    // --- Calculations (Precision 18,2) ---
    @Builder.Default
    @Column(name = "gross_amount", precision = 18, scale = 2)
    private BigDecimal grossAmount = BigDecimal.ZERO; // quantity * unit_price

    @Builder.Default
    @Column(name = "discount_rate", precision = 5, scale = 2)
    private BigDecimal discountRate = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "discount_amount", precision = 18, scale = 2)
    private BigDecimal discountAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "net_price", precision = 18, scale = 4)
    private BigDecimal netPrice = BigDecimal.ZERO; // Gi√° sau chi·∫øt kh·∫•u

    @Builder.Default
    @Column(name = "net_amount", precision = 18, scale = 2)
    private BigDecimal netAmount = BigDecimal.ZERO; // Th√†nh ti·ªÅn sau chi·∫øt kh·∫•u

    // --- Tax Information ---
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "vat_rate_id")
    private EinvVatRateEntity vatRate; // FK t·ªõi danh m·ª•c thu·∫ø

    @Builder.Default
    @Column(name = "tax_rate", precision = 5, scale = 2)
    private BigDecimal taxRate = BigDecimal.ZERO; // Snapshot t·ª∑ l·ªá thu·∫ø (%)

    @Builder.Default
    @Column(name = "tax_amount", precision = 18, scale = 2)
    private BigDecimal taxAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "total_amount", precision = 18, scale = 2, nullable = false)
    private BigDecimal totalAmount = BigDecimal.ZERO; // Net + Tax

    // --- Shell Fields ---
    @Column(name = "description", columnDefinition = "TEXT")
    private String description;

    @Column(name = "notes", length = 500)
    private String notes;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvInvoiceMetadataEntity.java">
package com.einvoicehub.core.domain.entity;

import com.einvoicehub.core.domain.entity.*;
import com.einvoicehub.core.domain.entity.enums.IssuanceMethod;
import com.einvoicehub.core.domain.entity.enums.AdjustmentType;
import jakarta.persistence.*;
import lombok.*;
import java.math.BigDecimal;
import java.time.LocalDate;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoice_metadata")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = {"merchant", "provider", "providerConfig", "invoiceTemplate", "invoiceStatus", "paymentMethodEntity", "replacedBy", "deletedByUser"})
public class EinvInvoiceMetadataEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    // --- Relationships (Hierarchical Core) ---
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "merchant_id", nullable = false)
    private EinvMerchantEntity merchant;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "provider_id")
    private EinvServiceProviderEntity provider;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "provider_config_id")
    private EinvMerchantProviderConfigEntity providerConfig;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "invoice_template_id")
    private EinvInvoiceTemplateEntity invoiceTemplate;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "status_id", nullable = false)
    private EinvInvoiceStatusEntity invoiceStatus;

    // Li√™n k·∫øt v·ªõi b·∫£ng payment_methods qua tr∆∞·ªùng method_code
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "payment_method", referencedColumnName = "method_code")
    private EinvPaymentMethodEntity paymentMethodEntity;

    // --- Identifiers & References ---
    @Column(name = "client_request_id", length = 100)
    private String clientRequestId;

    @Column(name = "partner_invoice_id", length = 50)
    private String partnerInvoiceId;

    @Column(name = "invoice_number", length = 20)
    private String invoiceNumber;

    @Column(name = "symbol_code", length = 10)
    private String symbolCode;

    @Column(name = "template_code", length = 20)
    private String templateCode;

    @Column(name = "invoice_type_code", length = 10)
    private String invoiceTypeCode;

    @Builder.Default
    @Column(name = "is_summary_invoice", nullable = false)
    private Boolean isSummaryInvoice = false;

    @Enumerated(EnumType.STRING)
    @Builder.Default
    @Column(name = "issuance_method", nullable = false)
    private IssuanceMethod issuanceMethod = IssuanceMethod.STANDARD;

    @Column(name = "lookup_code", length = 50, unique = true)
    private String lookupCode; // M√£ tra c·ª©u h√≥a ƒë∆°n

    @Column(name = "tax_authority_code", length = 50)
    private String taxAuthorityCode;

    @Column(name = "cqt_code", length = 50)
    private String cqtCode; // M√£ C∆° quan Thu·∫ø c·∫•p

    @Column(name = "provider_transaction_id", length = 100)
    private String providerTransactionId;

    // --- Seller Information (Flattened) ---
    @Column(name = "seller_name")
    private String sellerName;

    @Column(name = "seller_tax_code", length = 20)
    private String sellerTaxCode;

    @Column(name = "seller_address", columnDefinition = "TEXT")
    private String sellerAddress;

    // --- Buyer Information (Flattened) ---
    @Column(name = "buyer_name")
    private String buyerName;

    @Column(name = "buyer_tax_code", length = 20)
    private String buyerTaxCode;

    @Column(name = "buyer_id_no", length = 20)
    private String buyerIdNo;

    @Column(name = "buyer_full_name", length = 200)
    private String buyerFullName;

    @Column(name = "buyer_email")
    private String buyerEmail;

    @Column(name = "buyer_phone", length = 20)
    private String buyerPhone;

    @Column(name = "buyer_mobile", length = 50)
    private String buyerMobile;

    @Column(name = "buyer_address", columnDefinition = "TEXT")
    private String buyerAddress;

    @Column(name = "buyer_bank_account", length = 50)
    private String buyerBankAccount;

    @Column(name = "buyer_bank_name", length = 200)
    private String buyerBankName;

    @Column(name = "buyer_budget_code", length = 20)
    private String buyerBudgetCode;

    // --- Financial Amounts (DECIMAL 18,2) ---
    @Builder.Default
    @Column(name = "subtotal_amount", precision = 18, scale = 2, nullable = false)
    private BigDecimal subtotalAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "tax_amount", precision = 18, scale = 2, nullable = false)
    private BigDecimal taxAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "discount_amount", precision = 18, scale = 2, nullable = false)
    private BigDecimal discountAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "total_amount", precision = 18, scale = 2, nullable = false)
    private BigDecimal totalAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "gross_amount", precision = 18, scale = 2)
    private BigDecimal grossAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "net_amount", precision = 18, scale = 2)
    private BigDecimal netAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "currency_code", length = 3, nullable = false)
    private String currencyCode = "VND";

    @Builder.Default
    @Column(name = "exchange_rate", precision = 10, scale = 4, nullable = false)
    private BigDecimal exchangeRate = BigDecimal.ONE;

    // --- Adjustment / History ---
    @Column(name = "org_invoice_id", length = 36)
    private String originalInvoiceId;

    @Column(name = "org_invoice_form", length = 50)
    private String originalInvoiceForm;

    @Column(name = "org_invoice_series", length = 50)
    private String originalInvoiceSeries;

    @Column(name = "org_invoice_no", length = 50)
    private String originalInvoiceNo;

    @Column(name = "org_invoice_date")
    private LocalDateTime originalInvoiceDate;

    @Column(name = "org_invoice_reason", length = 500)
    private String originalInvoiceReason;

    @Enumerated(EnumType.STRING)
    @Column(name = "adjustment_type")
    private AdjustmentType adjustmentType;

    @Column(name = "cancellation_reason", length = 500)
    private String cancellationReason;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "replaced_by_invoice_id")
    private EinvInvoiceMetadataEntity replacedBy;

    // --- Dates & Status ---
    @Column(name = "status_message", columnDefinition = "TEXT")
    private String statusMessage;

    @Column(name = "issue_date")
    private LocalDate issueDate;

    @Column(name = "accounting_date")
    private LocalDate accountingDate;

    @Column(name = "due_date")
    private LocalDate dueDate;

    // --- Timestamps Shell Fields ---
    @Column(name = "signed_at")
    private LocalDateTime signedAt;

    @Column(name = "sent_to_provider_at")
    private LocalDateTime sentToProviderAt;

    @Column(name = "received_from_provider_at")
    private LocalDateTime receivedFromProviderAt;

    @Column(name = "delivered_to_buyer_at")
    private LocalDateTime deliveredToBuyerAt;

    @Column(name = "provider_error_code", length = 50)
    private String providerErrorCode;

    @Column(name = "provider_error_message", columnDefinition = "TEXT")
    private String providerErrorMessage;

    // --- System Audit Shell Fields ---
    @Builder.Default
    @Column(name = "is_deleted", nullable = false)
    private Boolean isDeleted = false;

    @Column(name = "deleted_at")
    private LocalDateTime deletedAt;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "deleted_by")
    private EinvMerchantUserEntity deletedByUser;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvInvoicePayloadEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoice_payloads")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = "invoice")
public class EinvInvoicePayloadEntity {

    @Id
    @Column(name = "invoice_id")
    private Long invoiceId;

    @OneToOne(fetch = FetchType.LAZY)
    @MapsId
    @JoinColumn(name = "invoice_id")
    private EinvInvoiceMetadataEntity invoice;

    @Column(name = "raw_data", columnDefinition = "JSON")
    private String rawData;

    @Column(name = "xml_content", columnDefinition = "LONGTEXT")
    private String xmlContent;

    @Column(name = "json_content", columnDefinition = "LONGTEXT")
    private String jsonContent;

    @Column(name = "signed_xml", columnDefinition = "LONGTEXT")
    private String signedXml;

    @Column(name = "pdf_data", columnDefinition = "LONGTEXT")
    private String pdfData;

    @Column(name = "extra_data", columnDefinition = "JSON")
    private String extraData;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvInvoiceRegistrationEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDate;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoice_registrations")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = {"merchant", "status"})
public class EinvInvoiceRegistrationEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "merchant_id", nullable = false)
    private EinvMerchantEntity merchant; // Li√™n k·∫øt doanh nghi·ªáp s·ªü h·ªØu

    @Column(name = "registration_number", length = 50)
    private String registrationNumber; // S·ªë quy·∫øt ƒë·ªãnh c·ªßa CQT

    @Column(name = "from_number", nullable = false)
    private Long fromNumber;

    @Column(name = "to_number", nullable = false)
    private Long toNumber;

    @Column(name = "quantity", nullable = false)
    private Long quantity;

    @Builder.Default
    @Column(name = "current_number", nullable = false)
    private Long currentNumber = 0L; // S·ªë hi·ªán t·∫°i ƒë√£ s·ª≠ d·ª•ng

    @Column(name = "effective_date", nullable = false)
    private LocalDate effectiveDate; // Ng√†y c√≥ hi·ªáu l·ª±c (SQL DATE)

    @Column(name = "expiration_date")
    private LocalDate expirationDate;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "status_id", nullable = false)
    private EinvRegistrationStatusEntity status; // Quan h·ªá v·ªõi registration_statuses

    // --- Enterprise Shell Fields ---
    @Column(name = "issued_by", length = 255)
    private String issuedBy; // C∆° quan Thu·∫ø ph√™ duy·ªát

    @Column(name = "note", columnDefinition = "TEXT")
    private String note;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvInvoiceStatusEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoice_statuses")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString
public class EinvInvoiceStatusEntity {
    @Id
    private Integer id; // ID ƒë·ªãnh danh c·ªë ƒë·ªãnh: 1-DRAFT, 5-SUCCESS...

    @Column(name = "name", length = 100, nullable = false, unique = true)
    private String name;

    // --- Enterprise Shell Fields ---
    @Column(name = "description", length = 255)
    private String description;

    @Column(name = "note", length = 500)
    private String note; // Ghi ch√∫ nghi·ªáp v·ª• m·ªü r·ªông

    @Column(name = "created_at")
    private LocalDateTime createdAt;

    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvInvoiceSyncQueueEntity.java">
package com.einvoicehub.core.domain.entity;

import com.einvoicehub.core.domain.entity.enums.SyncType;
import com.einvoicehub.core.domain.entity.enums.SyncStatus;
import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoice_sync_queue")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = "invoice")
public class EinvInvoiceSyncQueueEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "invoice_id", nullable = false)
    private EinvInvoiceMetadataEntity invoice;

    @Enumerated(EnumType.STRING)
    @Column(name = "sync_type", nullable = false)
    private SyncType syncType;

    @Builder.Default
    @Column(name = "priority", nullable = false)
    private Integer priority = 5; // ƒê·ªô ∆∞u ti√™n: 1-Cao nh·∫•t, 10-Th·∫•p nh·∫•t

    @Enumerated(EnumType.STRING)
    @Builder.Default
    @Column(name = "status", nullable = false)
    private SyncStatus status = SyncStatus.PENDING;

    @Builder.Default
    @Column(name = "attempt_count", nullable = false)
    private Integer attemptCount = 0;

    @Builder.Default
    @Column(name = "max_attempts", nullable = false)
    private Integer maxAttempts = 3;

    @Column(name = "last_attempt_at")
    private LocalDateTime lastAttemptAt;

    @Column(name = "next_retry_at")
    private LocalDateTime nextRetryAt;

    // --- Core Management Fields (D·ªØ li·ªáu ph·ª•c v·ª• x·ª≠ l√Ω l·∫°i) ---
    @Column(name = "request_data", columnDefinition = "JSON")
    private String requestData; // D·ªØ li·ªáu g·ª≠i ƒëi d·∫°ng JSON

    @Column(name = "response_data", columnDefinition = "JSON")
    private String responseData; // D·ªØ li·ªáu nh·∫≠n v·ªÅ t·ª´ API

    @Column(name = "error_code", length = 50)
    private String errorCode;

    @Column(name = "error_message", columnDefinition = "TEXT")
    private String errorMessage;

    // --- Enterprise Shell Fields (L∆∞u v·∫øt worker x·ª≠ l√Ω) ---
    @Column(name = "processed_by", length = 100)
    private String processedBy; // T√™n m√°y ho·∫∑c ID worker x·ª≠ l√Ω

    @Column(name = "processing_started_at")
    private LocalDateTime processingStartedAt;

    @Column(name = "processing_completed_at")
    private LocalDateTime processingCompletedAt;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvInvoiceTaxBreakDownEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.math.BigDecimal;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoice_tax_breakdowns")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = {"invoice", "vatRate"})
public class EinvInvoiceTaxBreakDownEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "invoice_id", nullable = false)
    private EinvInvoiceMetadataEntity invoice;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "vat_rate_id", nullable = false)
    private EinvVatRateEntity vatRate;

    @Column(name = "vat_rate_code", length = 10, nullable = false)
    private String vatRateCode;

    @Column(name = "vat_rate_percent", precision = 5, scale = 2, nullable = false)
    private BigDecimal vatRatePercent;

    @Builder.Default
    @Column(name = "subtotal_amount", precision = 18, scale = 2, nullable = false)
    private BigDecimal subtotalAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "discount_amount", precision = 18, scale = 2, nullable = false)
    private BigDecimal discountAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "taxable_amount", precision = 18, scale = 2, nullable = false)
    private BigDecimal taxableAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "tax_amount", precision = 18, scale = 2, nullable = false)
    private BigDecimal taxAmount = BigDecimal.ZERO;

    @Builder.Default
    @Column(name = "total_amount", precision = 18, scale = 2, nullable = false)
    private BigDecimal totalAmount = BigDecimal.ZERO;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvInvoiceTemplateEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoice_template")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = {"merchant", "invoiceType", "registration"})
public class EinvInvoiceTemplateEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "merchant_id", nullable = false)
    private EinvMerchantEntity merchant;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "invoice_type_id")
    private EinvInvoiceTypeEntity invoiceType;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "invoice_registration_id")
    private EinvInvoiceRegistrationEntity registration;

    @Column(name = "template_code", length = 20, nullable = false)
    private String templateCode;
    @Column(name = "symbol_code", length = 10, nullable = false)

    private String symbolCode;

    @Builder.Default
    @Column(name = "current_number", nullable = false)
    private Integer currentNumber = 0;

    @Builder.Default
    @Column(name = "min_number", nullable = false)
    private Integer minNumber = 1;

    @Builder.Default
    @Column(name = "max_number", nullable = false)
    private Integer maxNumber = 99999999;

    @Column(name = "start_date")
    private LocalDateTime startDate;

    @Column(name = "status_id")
    private Integer statusId; // ID tr·∫°ng th√°i m·ªü r·ªông

    @Builder.Default
    @Column(name = "is_active", nullable = false)
    private Boolean isActive = true;

    // --- Enterprise Shell Fields ---
    @Column(name = "provider_id", length = 36)
    private String providerId;

    @Column(name = "provider_serial_id", length = 50)
    private String providerSerialId;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvInvoiceTypeEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "invoice_types")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString
public class EinvInvoiceTypeEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "type_code", length = 10, nullable = false, unique = true)
    private String typeCode;

    @Column(name = "type_name", length = 100, nullable = false)
    private String typeName;

    @Column(name = "description", columnDefinition = "TEXT")
    private String description;

    @Builder.Default
    @Column(name = "is_active", nullable = false)
    private Boolean isActive = true;

    @Builder.Default
    @Column(name = "display_order", nullable = false)
    private Integer displayOrder = 0;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvMerchantEntity.java">
package com.einvoicehub.core.domain.entity;
import com.einvoicehub.core.domain.entity.enums.SubscriptionPlan;
import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "merchants")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString
public class EinvMerchantEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "tax_code", length = 20, nullable = false, unique = true)
    private String taxCode;

    @Column(name = "company_name", length = 255, nullable = false)
    private String companyName;

    @Column(name = "short_name", length = 100)
    private String shortName;

    @Column(name = "address", columnDefinition = "TEXT")
    private String address;

    @Column(name = "district", length = 100)
    private String district;

    @Column(name = "city", length = 100)
    private String city;

    @Column(name = "email", length = 255)
    private String email;

    @Column(name = "phone", length = 20)
    private String phone;

    @Column(name = "representative_name", length = 100)
    private String representativeName;

    @Column(name = "representative_title", length = 100)
    private String representativeTitle;

    @Column(name = "tax_authority_code", length = 10)
    private String taxAuthorityCode;

    // --- Enterprise Shell Fields ---
    @Enumerated(EnumType.STRING)
    @Builder.Default
    @Column(name = "subscription_plan", nullable = false)
    private SubscriptionPlan subscriptionPlan = SubscriptionPlan.TRIAL;

    @Builder.Default
    @Column(name = "invoice_quota", nullable = false)
    private Integer invoiceQuota = 100;

    @Builder.Default
    @Column(name = "invoice_used", nullable = false)
    private Integer invoiceUsed = 0;

    @Builder.Default
    @Column(name = "is_using_hsm", nullable = false)
    private Boolean isUsingHsm = false;

    @Builder.Default
    @Column(name = "is_deleted", nullable = false)
    private Boolean isDeleted = false;

    @Column(name = "deleted_at")
    private LocalDateTime deletedAt;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvMerchantProviderConfigEntity.java">
package com.einvoicehub.core.domain.entity;
import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "merchant_provider_configs")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = {"merchant", "provider"})
public class EinvMerchantProviderConfigEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "merchant_id", nullable = false)
    private EinvMerchantEntity merchant;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "provider_id", nullable = false)
    private EinvServiceProviderEntity provider;

    @Column(name = "partner_id", length = 50)
    private String partnerId;

    @Column(name = "partner_token", length = 500)
    private String partnerToken;

    @Column(name = "tax_code", length = 20)
    private String taxCode;

    @Column(name = "integration_url", length = 500)
    private String integrationUrl;

    @Column(name = "integrated_date")
    private LocalDateTime integratedDate;

    @Column(name = "username_service", length = 100, nullable = false)
    private String usernameService;

    @Column(name = "password_service_encrypted", length = 500, nullable = false)
    private String passwordServiceEncrypted;

    @Column(name = "certificate_serial", length = 100)
    private String certificateSerial;

    @Column(name = "certificate_data", columnDefinition = "TEXT")
    private String certificateData;

    @Column(name = "certificate_chain", columnDefinition = "LONGTEXT")
    private String certificateChain;

    @Column(name = "certificate_expired_at")
    private LocalDateTime certificateExpiredAt;

    @Column(name = "extra_config", columnDefinition = "JSON")
    private String extraConfig;

    // --- Enterprise Shell Fields ---
    @Builder.Default
    @Column(name = "is_test_mode", nullable = false)
    private Boolean isTestMode = false;

    @Column(name = "encrypted_password_storage", length = 500)
    private String encryptedPasswordStorage;

    @Builder.Default
    @Column(name = "is_active", nullable = false)
    private Boolean isActive = true;

    @Builder.Default
    @Column(name = "is_default", nullable = false)
    private Boolean isDefault = false;

    @Column(name = "last_sync_at")
    private LocalDateTime lastSyncAt;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvMerchantUserEntity.java">
package com.einvoicehub.core.domain.entity;
import com.einvoicehub.core.domain.entity.enums.UserRole;
import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "merchant_user")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = "merchant")
public class EinvMerchantUserEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "merchant_id", nullable = false)
    private EinvMerchantEntity merchant;

    @Column(name = "username", length = 50, nullable = false, unique = true)
    private String username;

    @Column(name = "email", length = 255, nullable = false, unique = true)
    private String email;

    @Column(name = "password_hash", length = 255, nullable = false)
    private String passwordHash;

    @Column(name = "full_name", length = 100)
    private String fullName;

    @Column(name = "phone", length = 20)
    private String phone;

    @Column(name = "avatar_url", length = 500)
    private String avatarUrl;

    @Enumerated(EnumType.STRING)
    @Builder.Default
    @Column(name = "role", nullable = false)
    private UserRole role = UserRole.STAFF;

    @Builder.Default
    @Column(name = "is_active", nullable = false)
    private Boolean isActive = true;

    @Builder.Default
    @Column(name = "is_primary", nullable = false)
    private Boolean isPrimary = false;

    @Column(name = "last_login_at")
    private LocalDateTime lastLoginAt;

    @Builder.Default
    @Column(name = "failed_login_attempts", nullable = false)
    private Integer failedLoginAttempts = 0;

    @Column(name = "locked_until")
    private LocalDateTime lockedUntil;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvPaymentMethodEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "payment_methods")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString
public class EinvPaymentMethodEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "method_code", length = 10, nullable = false, unique = true)
    private String methodCode; // V√≠ d·ª•: TM, CK

    @Column(name = "method_name", length = 100, nullable = false)
    private String methodName;

    // --- Enterprise Shell Fields ---
    @Column(name = "description", columnDefinition = "TEXT")
    private String description; // M√¥ t·∫£ m·ªü r·ªông

    @Builder.Default
    @Column(name = "is_active", nullable = false)
    private Boolean isActive = true;

    @Builder.Default
    @Column(name = "display_order", nullable = false)
    private Integer displayOrder = 0;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvRegistrationStatusEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "registration_statuses")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString
public class EinvRegistrationStatusEntity {

    @Id
    private Integer id;

    @Column(name = "name", length = 100, nullable = false, unique = true)
    private String name;

    // --- Enterprise Shell Fields ---
    @Column(name = "description", length = 255)
    private String description;

    @Column(name = "note", length = 500)
    private String note; // Ghi ch√∫ nghi·ªáp v·ª• m·ªü r·ªông

    @Column(name = "created_at")
    private LocalDateTime createdAt;

    @Column(name = "updated_at")
    private LocalDateTime updatedAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvServiceProviderEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "service_providers")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString
public class EinvServiceProviderEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "provider_code", length = 20, nullable = false, unique = true)
    private String providerCode; // V√≠ d·ª•: VNPT, VIETTEL

    @Column(name = "provider_name", length = 100, nullable = false)
    private String providerName;

    @Column(name = "official_api_url", length = 500, nullable = false)
    private String officialApiUrl;

    // --- Enterprise Shell Fields ---
    @Column(name = "lookup_url", length = 500)
    private String lookupUrl; // URL tra c·ª©u h√≥a ƒë∆°n

    @Column(name = "documentation_url", length = 500)
    private String documentationUrl;

    @Column(name = "support_email", length = 255)
    private String supportEmail;

    @Column(name = "support_phone", length = 20)
    private String supportPhone;

    @Builder.Default
    @Column(name = "is_active", nullable = false)
    private Boolean isActive = true;

    @Builder.Default
    @Column(name = "is_default", nullable = false)
    private Boolean isDefault = false;

    @Builder.Default
    @Column(name = "display_order", nullable = false)
    private Integer displayOrder = 0;

    @Column(name = "extra_config_schema", columnDefinition = "JSON")
    private String extraConfigSchema; // C·∫•u h√¨nh ƒë·∫∑c th√π d·∫°ng JSON

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvSystemConfigEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "system_config")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString
public class EinvSystemConfigEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "config_key", length = 100, nullable = false, unique = true)
    private String configKey;

    @Column(name = "config_value", columnDefinition = "TEXT", nullable = false)
    private String configValue;

    @Column(name = "config_type", length = 20, nullable = false)
    private String configType; // STRING, NUMBER, BOOLEAN, JSON

    // --- Enterprise Shell Fields ---
    @Column(name = "description", length = 500)
    private String description;

    @Builder.Default
    @Column(name = "is_encrypted", nullable = false)
    private Boolean isEncrypted = false; // M√£ h√≥a d·ªØ li·ªáu nh·∫°y c·∫£m (VD: API Secret)

    @Builder.Default
    @Column(name = "is_editable", nullable = false)
    private Boolean isEditable = true;

    @Column(name = "updated_by")
    private Long updatedBy; // ID c·ªßa MerchantUser th·ª±c hi·ªán thay ƒë·ªïi (Decoupled)

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvTaxAuthorityResponseEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.time.LocalDateTime;

@Entity
@Table(name = "tax_authority_responses")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString(exclude = "invoice")
public class EinvTaxAuthorityResponseEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "invoice_id", nullable = false)
    private EinvInvoiceMetadataEntity invoice;

    @Column(name = "cqt_code", length = 50, nullable = false)
    private String cqtCode; // M√£ C∆° quan Thu·∫ø c·∫•p

    @Column(name = "status_from_cqt", length = 50, nullable = false)
    private String statusFromCqt; // APPROVED, REJECTED, ...

    @Column(name = "processing_code", length = 100)
    private String processingCode;

    @Column(name = "signature_data", columnDefinition = "TEXT")
    private String signatureData; // Ch·ªØ k√Ω s·ªë t·ª´ C∆° quan Thu·∫ø

    // --- Enterprise Shell Fields ---
    @Column(name = "raw_response", columnDefinition = "JSON")
    private String rawResponse; // N·ªôi dung ph·∫£n h·ªìi th√¥ d·∫°ng JSON

    @Column(name = "error_code", length = 50)
    private String errorCode;

    @Column(name = "error_message", columnDefinition = "TEXT")
    private String errorMessage;

    @Column(name = "received_at", nullable = false)
    private LocalDateTime receivedAt; // Th·ªùi ƒëi·ªÉm nh·∫≠n th·ª±c t·∫ø

    @Column(name = "processed_at")
    private LocalDateTime processedAt; // Th·ªùi ƒëi·ªÉm h·ªá th·ªëng x·ª≠ l√Ω xong

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        if (this.receivedAt == null) {
            this.receivedAt = LocalDateTime.now();
        }
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvUserAuthorEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import org.hibernate.annotations.Immutable;

@Entity
@Immutable
@Table(name = "vw_sys_user_author")
@Getter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString
public class EinvUserAuthorEntity {

    @Id
    @Column(name = "id")
    private String id;

    @Column(name = "name")
    private String name;

    @Column(name = "full_name")
    private String fullName;
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/entity/EinvVatRateEntity.java">
package com.einvoicehub.core.domain.entity;

import jakarta.persistence.*;
import lombok.*;
import java.math.BigDecimal;
import java.time.LocalDateTime;

@Entity
@Table(name = "vat_rates")
@Getter
@Setter
@NoArgsConstructor
@AllArgsConstructor
@Builder
@ToString
public class EinvVatRateEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "rate_code", length = 10, nullable = false, unique = true)
    private String rateCode; // V√≠ d·ª•: 0, 5, 10, KCT

    @Column(name = "rate_percent", precision = 5, scale = 2, nullable = false)
    private BigDecimal ratePercent;

    @Column(name = "rate_name", length = 100, nullable = false)
    private String rateName;

    // --- Enterprise Shell Fields ---
    @Column(name = "description", columnDefinition = "TEXT")
    private String description;

    @Builder.Default
    @Column(name = "is_active", nullable = false)
    private Boolean isActive = true;

    @Builder.Default
    @Column(name = "display_order", nullable = false)
    private Integer displayOrder = 0;

    @Column(name = "created_at", nullable = false, updatable = false)
    private LocalDateTime createdAt;

    @Column(name = "updated_at", nullable = false)
    private LocalDateTime updatedAt;
    // --------------------------------

    @PrePersist
    protected void onCreate() {
        this.createdAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    @PreUpdate
    protected void onUpdate() {
        this.updatedAt = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvApiCredentialRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvApiCredentialsEntity;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface EinvApiCredentialRepository extends JpaRepository<EinvApiCredentialsEntity, Long>,
        JpaSpecificationExecutor<EinvApiCredentialsEntity> {


     //T√¨m ki·∫øm th√¥ng tin x√°c th·ª±c b·∫±ng Client ID c√¥ng khai.
    Optional<EinvApiCredentialsEntity> findByClientIdAndIsActiveTrue(String clientId);

    @Query("SELECT c FROM EinvApiCredentialsEntity c WHERE " +
            "(:merchantId IS NULL OR c.merchant.id = :merchantId) AND " +
            "(:search IS NULL OR " +
            "    LOWER(c.clientId) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "    LOWER(c.apiKeyPrefix) LIKE LOWER(CONCAT('%', :search, '%'))" +
            ")")
    Page<EinvApiCredentialsEntity> findByFilters(
            @Param("merchantId") Long merchantId,
            @Param("search") String search,
            Pageable pageable);


     // Native Query: L·∫•y Prefix c·ªßa API Key m·ªõi nh·∫•t v·ª´a t·∫°o cho Merchant.
    @Query(value = "SELECT api_key_prefix FROM api_credentials " +
            "WHERE merchant_id = :merchantId ORDER BY created_at DESC LIMIT 1",
            nativeQuery = true)
    String findLatestApiKeyPrefix(@Param("merchantId") Long merchantId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvAuditLogRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvAuditLogsEntity;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

@Repository
public interface EinvAuditLogRepository extends JpaRepository<EinvAuditLogsEntity, Long>,
        JpaSpecificationExecutor<EinvAuditLogsEntity> {

    Page<EinvAuditLogsEntity> findByEntityTypeAndEntityIdOrderByCreatedAtDesc(
            String entityType, Long entityId, Pageable pageable);

    @Query("SELECT l FROM EinvAuditLogsEntity l WHERE " +
            "(:merchantId IS NULL OR l.merchant.id = :merchantId) AND " +
            "(:entityType IS NULL OR l.entityType = :entityType) AND " +
            "(:action IS NULL OR l.action = :action) AND " +
            "(:search IS NULL OR LOWER(l.requestId) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            " LOWER(l.ipAddress) LIKE LOWER(CONCAT('%', :search, '%')))")
    Page<EinvAuditLogsEntity> searchAuditLogs(
            @Param("merchantId") Long merchantId,
            @Param("entityType") String entityType,
            @Param("action") String action,
            @Param("search") String search,
            Pageable pageable);

    @Query(value = "SELECT COUNT(*) FROM audit_logs " +
            "WHERE ip_address = :ip AND created_at >= CURDATE()",
            nativeQuery = true)
    long countActionsTodayByIp(@Param("ip") String ipAddress);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvInvoiceAdjustmentRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvInvoiceAdjustmentsEntity;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface EinvInvoiceAdjustmentRepository extends JpaRepository<EinvInvoiceAdjustmentsEntity, Long>,
        JpaSpecificationExecutor<EinvInvoiceAdjustmentsEntity> {

    @EntityGraph(attributePaths = {"originalInvoice"})
    Optional<EinvInvoiceAdjustmentsEntity> findByOriginalInvoiceId(Long originalInvoiceId);

    @Query("SELECT a FROM EinvInvoiceAdjustmentsEntity a WHERE " +
            "(:merchantId IS NULL OR a.originalInvoice.merchant.id = :merchantId) AND " +
            "(:search IS NULL OR " +
            "    LOWER(a.agreementNumber) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "    LOWER(a.reasonDescription) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "    LOWER(a.originalInvoice.invoiceNumber) LIKE LOWER(CONCAT('%', :search, '%'))" +
            ") " +
            "AND (:status IS NULL OR a.status = :status)")
    Page<EinvInvoiceAdjustmentsEntity> findByFilters(
            @Param("merchantId") Long merchantId,
            @Param("search") String search,
            @Param("status") String status,
            Pageable pageable
    );

    @Query(value = "SELECT a.* FROM invoice_adjustments a " +
            "JOIN invoice_metadata m ON a.original_invoice_id = m.id " +
            "WHERE m.merchant_id = :merchantId " +
            "ORDER BY a.created_at DESC LIMIT 1", nativeQuery = true)
    Optional<EinvInvoiceAdjustmentsEntity> findLatestAdjustment(@Param("merchantId") Long merchantId);

    boolean existsByOriginalInvoiceId(Long originalInvoiceId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvInvoiceItemRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvInvoiceItemEntity;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface EinvInvoiceItemRepository extends JpaRepository<EinvInvoiceItemEntity, Long>,
        JpaSpecificationExecutor<EinvInvoiceItemEntity> {

    @EntityGraph(attributePaths = {"vatRate"})
    List<EinvInvoiceItemEntity> findByInvoiceIdOrderByLineNumberAsc(Long invoiceId);
    boolean existsByVatRateId(Long vatRateId);

    @Modifying
    @Query("DELETE FROM EinvInvoiceItemEntity i WHERE i.invoice.id = :invoiceId")
    void deleteByInvoiceId(@Param("invoiceId") Long invoiceId);

    @Query(value = "SELECT product_name, SUM(quantity) as total_qty FROM invoice_items i " +
            "JOIN invoice_metadata m ON i.invoice_id = m.id " +
            "WHERE m.merchant_id = :merchantId GROUP BY product_code, product_name " +
            "ORDER BY total_qty DESC LIMIT 10", nativeQuery = true)
    List<Object[]> findTopSellingProducts(@Param("merchantId") Long merchantId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvInvoiceMetadataRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvInvoiceMetadataEntity;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Optional;


@Repository
public interface EinvInvoiceMetadataRepository extends JpaRepository<EinvInvoiceMetadataEntity, Long>,
        JpaSpecificationExecutor<EinvInvoiceMetadataEntity> {

    Optional<EinvInvoiceMetadataEntity> findByPartnerInvoiceId(String partnerInvoiceId);

    Optional<EinvInvoiceMetadataEntity> findByLookupCode(String lookupCode);

    Optional<EinvInvoiceMetadataEntity> findByInvoiceNumber(String invoiceNumber);

    @EntityGraph(attributePaths = {"items", "invoiceStatus", "merchant"})
    Optional<EinvInvoiceMetadataEntity> findWithDetailsById(Long id);

    @EntityGraph(attributePaths = {"invoiceStatus"})
    Optional<EinvInvoiceMetadataEntity> findTopByPartnerInvoiceIdOrderByCreatedAtDesc(String partnerInvoiceId);

    @Query("SELECT i FROM EinvInvoiceMetadataEntity i WHERE " +
            "(:merchantId IS NULL OR i.merchant.id = :merchantId) AND " +
            "(:search IS NULL OR " +
            "    LOWER(CONCAT(COALESCE(i.templateCode,''), COALESCE(i.symbolCode,''))) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "    LOWER(i.invoiceNumber) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "    LOWER(i.buyerFullName) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "    LOWER(i.buyerTaxCode) LIKE LOWER(CONCAT('%', :search, '%'))" +
            ") " +
            "AND (:statusId IS NULL OR i.invoiceStatus.id = :statusId) " +
            "AND i.isDeleted = false")
    Page<EinvInvoiceMetadataEntity> findByFilters(
            @Param("merchantId") Long merchantId,
            @Param("search") String search,
            @Param("statusId") Integer statusId,
            Pageable pageable
    );

    @Query(value = "SELECT * FROM invoice_metadata " +
            "WHERE merchant_id = :merchantId AND status_id = 5 " +
            "ORDER BY issue_date DESC, created_at DESC LIMIT 1",
            nativeQuery = true)
    Optional<EinvInvoiceMetadataEntity> findLatestSuccessInvoice(@Param("merchantId") Long merchantId);

    boolean existsByLookupCode(String lookupCode);

    boolean existsByInvoiceTypeId(Long invoiceTypeId);
    boolean existsByInvoiceTypeCode(String invoiceTypeCode);

    boolean existsByStatusId(Integer statusId);

    boolean existsByPaymentMethodId(Long paymentMethodId);
    boolean existsByPaymentMethod(String paymentMethod);

    boolean existsByMerchantId(Long merchantId);
    boolean existsByProviderId(Long providerId);
    boolean existsByProviderConfigId(Long providerConfigId);

    boolean existsByTemplateId(Long templateId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvInvoicePayloadRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvInvoicePayloadEntity;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface EinvInvoicePayloadRepository extends JpaRepository<EinvInvoicePayloadEntity, Long>,
        JpaSpecificationExecutor<EinvInvoicePayloadEntity> {

    @EntityGraph(attributePaths = {"invoice"})
    Optional<EinvInvoicePayloadEntity> findByInvoiceId(Long invoiceId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvInvoiceRegistrationRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvInvoiceRegistrationEntity;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface EinvInvoiceRegistrationRepository extends JpaRepository<EinvInvoiceRegistrationEntity, Long>,
        JpaSpecificationExecutor<EinvInvoiceRegistrationEntity> {

    @EntityGraph(attributePaths = {"status"})
    List<EinvInvoiceRegistrationEntity> findByMerchantIdAndStatusIdOrderByEffectiveDateDesc(Long merchantId, Integer statusId);

    Optional<EinvInvoiceRegistrationEntity> findByRegistrationNumber(String registrationNumber);

    @Query(value = "SELECT * FROM invoice_registrations WHERE merchant_id = :merchantId " +
            "AND status_id = 1 ORDER BY effective_date DESC LIMIT 1", nativeQuery = true)
    Optional<EinvInvoiceRegistrationEntity> findLatestActiveRegistration(@Param("merchantId") Long merchantId);

    boolean existsByStatusId(Integer statusId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvInvoiceStatusRepository.java">
package com.einvoicehub.core.domain.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import com.einvoicehub.core.domain.entity.EinvInvoiceStatusEntity;

import java.util.Optional;
import java.util.List;

@Repository
public interface EinvInvoiceStatusRepository extends JpaRepository<EinvInvoiceStatusEntity, Integer>,
        JpaSpecificationExecutor<EinvInvoiceStatusEntity> {

    Optional<EinvInvoiceStatusEntity> findByName(String name);

    @Query("SELECT s FROM EinvInvoiceStatusEntity s WHERE " +
            "(:keyword IS NULL OR LOWER(s.name) LIKE LOWER(CONCAT('%', :keyword, '%')) OR " +
            "LOWER(s.description) LIKE LOWER(CONCAT('%', :keyword, '%')))")
    List<EinvInvoiceStatusEntity> searchByKeyword(@Param("keyword") String keyword);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvInvoiceSyncQueueRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvInvoiceSyncQueueEntity;
import com.einvoicehub.core.domain.entity.enums.SyncStatus;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface EinvInvoiceSyncQueueRepository extends JpaRepository<EinvInvoiceSyncQueueEntity, Long>,
        JpaSpecificationExecutor<EinvInvoiceSyncQueueEntity> {

    @EntityGraph(attributePaths = {"invoice"})
    Optional<EinvInvoiceSyncQueueEntity> findWithInvoiceById(Long id);

    List<EinvInvoiceSyncQueueEntity> findByStatusInOrderByPriorityAscCreatedAtAsc(List<SyncStatus> statuses);

    @Query("SELECT q FROM EinvInvoiceSyncQueueEntity q WHERE " +
            "(:status IS NULL OR q.status = :status) AND " +
            "(:search IS NULL OR LOWER(q.errorMessage) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "LOWER(q.processedBy) LIKE LOWER(CONCAT('%', :search, '%')))")
    Page<EinvInvoiceSyncQueueEntity> findByFilters(
            @Param("status") SyncStatus status,
            @Param("search") String search,
            Pageable pageable
    );

    @Query(value = "SELECT * FROM invoice_sync_queue " +
            "WHERE status = 'RETRYING' AND next_retry_at <= NOW() " +
            "ORDER BY priority ASC LIMIT :batchSize", nativeQuery = true)
    List<EinvInvoiceSyncQueueEntity> findReadyToRetry(@Param("batchSize") int batchSize);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvInvoiceTaxBreakdownRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvInvoiceTaxBreakDownEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface EinvInvoiceTaxBreakdownRepository extends JpaRepository<EinvInvoiceTaxBreakDownEntity, Long>,
        JpaSpecificationExecutor<EinvInvoiceTaxBreakDownEntity> {

    List<EinvInvoiceTaxBreakDownEntity> findByInvoiceId(Long invoiceId);

    @Modifying
    @Query("DELETE FROM EinvInvoiceTaxBreakDownEntity t WHERE t.invoice.id = :invoiceId")
    void deleteByInvoiceId(@Param("invoiceId") Long invoiceId);

    boolean existsByVatRateId(Long vateRateId);

}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvInvoiceTemplateRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvInvoiceTemplateEntity;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface EinvInvoiceTemplateRepository extends JpaRepository<EinvInvoiceTemplateEntity, Long>,
        JpaSpecificationExecutor<EinvInvoiceTemplateEntity> {

    @EntityGraph(attributePaths = {"invoiceType", "registration"})
    Optional<EinvInvoiceTemplateEntity> findWithDetailsById(Long id);

    Optional<EinvInvoiceTemplateEntity> findByMerchantIdAndTemplateCodeAndSymbolCode(Long merchantId, String templateCode, String symbolCode);

    @Query("SELECT t FROM EinvInvoiceTemplateEntity t WHERE t.merchant.id = :merchantId " +
            "AND t.isActive = true AND (:search IS NULL OR " +
            "LOWER(t.templateCode) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "LOWER(t.symbolCode) LIKE LOWER(CONCAT('%', :search, '%')))")
    List<EinvInvoiceTemplateEntity> searchTemplates(@Param("merchantId") Long merchantId, @Param("search") String search);

    @Query(value = "SELECT * FROM invoice_template WHERE merchant_id = :merchantId " +
            "AND is_active = 1 ORDER BY created_at DESC LIMIT 1", nativeQuery = true)
    Optional<EinvInvoiceTemplateEntity> findLatestTemplate(@Param("merchantId") Long merchantId);
    boolean existsByInvoiceTypeId(Long invoiceTypeId);
    boolean existsByRegistrationId(Long registrationId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvInvoiceTypeRepository.java">
package com.einvoicehub.core.domain.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import com.einvoicehub.core.domain.entity.EinvInvoiceTypeEntity;

import java.util.List;
import java.util.Optional;

@Repository
public interface EinvInvoiceTypeRepository extends JpaRepository<EinvInvoiceTypeEntity, Long>,
        JpaSpecificationExecutor<EinvInvoiceTypeEntity> {

    List<EinvInvoiceTypeEntity> findByIsActiveTrueOrderByDisplayOrderAsc();

    Optional<EinvInvoiceTypeEntity> findByTypeCode(String typeCode);

    @Query("SELECT t FROM EinvInvoiceTypeEntity t WHERE " +
            "(:search IS NULL OR LOWER(t.typeCode) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "LOWER(t.typeName) LIKE LOWER(CONCAT('%', :search, '%'))) " +
            "AND t.isActive = true " +
            "ORDER BY t.displayOrder ASC")
    List<EinvInvoiceTypeEntity> searchActiveTypes(@Param("search") String search);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvMerchantProviderConfigRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvMerchantProviderConfigEntity;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface EinvMerchantProviderConfigRepository extends JpaRepository<EinvMerchantProviderConfigEntity, Long>,
        JpaSpecificationExecutor<EinvMerchantProviderConfigEntity> {

    @EntityGraph(attributePaths = {"provider"})
    Optional<EinvMerchantProviderConfigEntity> findByMerchantIdAndIsDefaultTrueAndIsActiveTrue(Long merchantId);

    @Query("SELECT c FROM EinvMerchantProviderConfigEntity c WHERE " +
            "(:merchantId IS NULL OR c.merchant.id = :merchantId) AND " +
            "(:search IS NULL OR LOWER(c.taxCode) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "LOWER(c.partnerId) LIKE LOWER(CONCAT('%', :search, '%')))")
    List<EinvMerchantProviderConfigEntity> searchConfigs(@Param("merchantId") Long merchantId, @Param("search") String search);

    boolean existsByMerchantIdAndProviderId(Long merchantId, Long providerId);
    boolean existsByProviderId(Long providerId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvMerchantRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvMerchantEntity;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface EinvMerchantRepository extends JpaRepository<EinvMerchantEntity, Long>,
        JpaSpecificationExecutor<EinvMerchantEntity> {

    Optional<EinvMerchantEntity> findByTaxCode(String taxCode);

    boolean existsByTaxCodeAndIsDeletedFalse(String taxCode);

    @Query("SELECT m FROM EinvMerchantEntity m WHERE " +
            "(:search IS NULL OR LOWER(m.companyName) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "LOWER(m.taxCode) LIKE LOWER(CONCAT('%', :search, '%'))) " +
            "AND m.isDeleted = false")
    Page<EinvMerchantEntity> searchMerchants(@Param("search") String search, Pageable pageable);

    @Query(value = "SELECT * FROM merchants WHERE is_deleted = 0 ORDER BY created_at DESC LIMIT 1",
            nativeQuery = true)
    Optional<EinvMerchantEntity> findLatestMerchant();
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvMerchantUserRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvMerchantUserEntity;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface EinvMerchantUserRepository extends JpaRepository<EinvMerchantUserEntity, Long>,
        JpaSpecificationExecutor<EinvMerchantUserEntity> {

    @EntityGraph(attributePaths = {"merchant"})
    Optional<EinvMerchantUserEntity> findByUsername(String username);

    Optional<EinvMerchantUserEntity> findByEmail(String email);

    @Query("SELECT u FROM EinvMerchantUserEntity u WHERE u.merchant.id = :merchantId " +
            "AND (:search IS NULL OR LOWER(u.username) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "LOWER(u.fullName) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "LOWER(u.email) LIKE LOWER(CONCAT('%', :search, '%')))")
    Page<EinvMerchantUserEntity> findByMerchantAndFilters(
            @Param("merchantId") Long merchantId,
            @Param("search") String search,
            Pageable pageable);

    boolean existsByMerchantIdAndIsPrimaryTrue(Long merchantId);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvPaymentMethodRepository.java">
package com.einvoicehub.core.domain.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;
import com.einvoicehub.core.domain.entity.EinvPaymentMethodEntity;

import java.util.List;
import java.util.Optional;

@Repository
public interface EinvPaymentMethodRepository extends JpaRepository<EinvPaymentMethodEntity, Long>,
        JpaSpecificationExecutor<EinvPaymentMethodEntity> {

    List<EinvPaymentMethodEntity> findByIsActiveTrueOrderByDisplayOrderAsc();

    Optional<EinvPaymentMethodEntity> findByMethodCode(String methodCode);

    List<EinvPaymentMethodEntity> findAllByIdIn(List<Long> ids);

    @Query("SELECT p FROM EinvPaymentMethodEntity p WHERE " +
            "(:search IS NULL OR LOWER(p.methodCode) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "LOWER(p.methodName) LIKE LOWER(CONCAT('%', :search, '%'))) " +
            "AND p.isActive = true")
    List<EinvPaymentMethodEntity> searchActiveMethods(@Param("search") String search);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvRegistrationStatusRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvRegistrationStatusEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface EinvRegistrationStatusRepository extends JpaRepository<EinvRegistrationStatusEntity, Integer>,
        JpaSpecificationExecutor<EinvRegistrationStatusEntity> {

    Optional<EinvRegistrationStatusEntity> findByName(String name);

    @Query("SELECT r FROM EinvRegistrationStatusEntity r WHERE " +
            "(:keyword IS NULL OR LOWER(r.name) LIKE LOWER(CONCAT('%', :keyword, '%')) OR " +
            "LOWER(r.description) LIKE LOWER(CONCAT('%', :keyword, '%')))")
    List<EinvRegistrationStatusEntity> searchByKeyword(@Param("keyword") String keyword);

    boolean existsById(Integer id);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvServiceProviderRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvServiceProviderEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface EinvServiceProviderRepository extends JpaRepository<EinvServiceProviderEntity, Long>,
        JpaSpecificationExecutor<EinvServiceProviderEntity> {
    Optional<EinvServiceProviderEntity> findByProviderCodeAndIsActiveTrue(String providerCode);

    List<EinvServiceProviderEntity> findByIsActiveTrueOrderByDisplayOrderAsc();

    Optional<EinvServiceProviderEntity> findByIsDefaultTrue();
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvSystemConfigRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvSystemConfigEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface EinvSystemConfigRepository extends JpaRepository<EinvSystemConfigEntity, Long>,
        JpaSpecificationExecutor<EinvSystemConfigEntity> {

    Optional<EinvSystemConfigEntity> findByConfigKey(String configKey);

    @Query(value = "SELECT config_value FROM system_config WHERE config_key = :key", nativeQuery = true)
    String getValueByKey(@Param("key") String key);

    boolean existsByConfigKeyAndIsEditableTrue(String configKey);
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvTaxAuthorityResponseRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvTaxAuthorityResponseEntity;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.jpa.repository.EntityGraph;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.Optional;

@Repository
public interface EinvTaxAuthorityResponseRepository extends JpaRepository<EinvTaxAuthorityResponseEntity, Long>,
        JpaSpecificationExecutor<EinvTaxAuthorityResponseEntity> {

    Optional<EinvTaxAuthorityResponseEntity> findByCqtCode(String cqtCode);

     //L·∫•y th√¥ng tin ph·∫£n h·ªìi k√®m d·ªØ li·ªáu h√≥a ƒë∆°n cha.
    @EntityGraph(attributePaths = {"invoice"})
    Optional<EinvTaxAuthorityResponseEntity> findByInvoiceId(Long invoiceId);

    @Query("SELECT r FROM EinvTaxAuthorityResponseEntity r WHERE " +
            "(:cqtCode IS NULL OR r.cqtCode = :cqtCode) AND " +
            "(:search IS NULL OR LOWER(r.errorMessage) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "LOWER(r.statusFromCqt) LIKE LOWER(CONCAT('%', :search, '%')))")
    Page<EinvTaxAuthorityResponseEntity> searchResponses(
            @Param("cqtCode") String cqtCode,
            @Param("search") String search,
            Pageable pageable
    );
}
</file>

<file path="src/main/java/com/einvoicehub/core/domain/repository/EinvVatRateRepository.java">
package com.einvoicehub.core.domain.repository;

import com.einvoicehub.core.domain.entity.EinvVatRateEntity;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.JpaSpecificationExecutor;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import java.util.List;
import java.util.Optional;

@Repository
public interface EinvVatRateRepository extends JpaRepository<EinvVatRateEntity, Long>,
        JpaSpecificationExecutor<EinvVatRateEntity> {

    Optional<EinvVatRateEntity> findByRateCode(String rateCode);

    List<EinvVatRateEntity> findByIsActiveTrueOrderByDisplayOrderAsc();

    @Query("SELECT v FROM EinvVatRateEntity v WHERE " +
            "(:search IS NULL OR LOWER(v.rateCode) LIKE LOWER(CONCAT('%', :search, '%')) OR " +
            "LOWER(v.rateName) LIKE LOWER(CONCAT('%', :search, '%'))) " +
            "AND v.isActive = true " +
            "ORDER BY v.displayOrder ASC")
    List<EinvVatRateEntity> searchActiveVatRates(@Param("search") String search);

    @Query(value = "SELECT * FROM vat_rates v WHERE v.is_active = 1 " +
            "ORDER BY v.rate_percent DESC LIMIT 1", nativeQuery = true)
    Optional<EinvVatRateEntity> findDefaultMaxTaxRate();
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/request/EinvInvoiceAdjustmentRequest.java">
package com.einvoicehub.core.dto.request;

import com.fasterxml.jackson.annotation.JsonProperty;
import jakarta.validation.constraints.*;
import lombok.*;
import java.math.BigDecimal;
import java.time.LocalDate;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceAdjustmentRequest {

    @NotNull(message = "ID h√≥a ƒë∆°n g·ªëc l√† b·∫Øt bu·ªôc")
    @JsonProperty("OriginalInvoiceID")
    private Long originalInvoiceId;

    @NotBlank(message = "Lo·∫°i ƒëi·ªÅu ch·ªânh (ADJUSTMENT, REPLACEMENT, CANCELLATION) l√† b·∫Øt bu·ªôc")
    @JsonProperty("AdjustmentType")
    private String adjustmentType;

    @NotBlank(message = "S·ªë bi√™n b·∫£n th·ªèa thu·∫≠n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @JsonProperty("AgreementNumber")
    private String agreementNumber;

    @NotNull(message = "Ng√†y l·∫≠p bi√™n b·∫£n l√† b·∫Øt bu·ªôc")
    @JsonProperty("AgreementDate")
    private LocalDate agreementDate;

    @JsonProperty("AgreementContent")
    private String agreementContent;

    @JsonProperty("Signers")
    private String signers; // Danh s√°ch ng∆∞·ªùi k√Ω (JSON String)

    @JsonProperty("ReasonCode")
    private String reasonCode;

    @NotBlank(message = "L√Ω do ƒëi·ªÅu ch·ªânh kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @JsonProperty("ReasonDescription")
    private String reasonDescription;

    @JsonProperty("OldSubtotalAmount")
    private BigDecimal oldSubtotalAmount;

    @JsonProperty("OldTaxAmount")
    private BigDecimal oldTaxAmount;

    @JsonProperty("OldTotalAmount")
    private BigDecimal oldTotalAmount;

    @JsonProperty("NewSubtotalAmount")
    private BigDecimal newSubtotalAmount;

    @JsonProperty("NewTaxAmount")
    private BigDecimal newTaxAmount;

    @JsonProperty("NewTotalAmount")
    private BigDecimal newTotalAmount;

    @JsonProperty("DifferenceAmount")
    private BigDecimal differenceAmount;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/request/EinvSubmitInvoiceDetailRequest.java">
package com.einvoicehub.core.dto.request;

import com.fasterxml.jackson.annotation.JsonProperty;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.PositiveOrZero;
import lombok.*;
import java.math.BigDecimal;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvSubmitInvoiceDetailRequest {

    @JsonProperty("ItemTypeID")
    private Integer itemTypeId;

    @JsonProperty("ItemCode")
    private String itemCode;

    @NotBlank(message = "T√™n h√†ng h√≥a kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @JsonProperty("ItemName")
    private String itemName;

    @JsonProperty("UnitName")
    private String unitName;

    @NotNull(message = "S·ªë l∆∞·ª£ng l√† b·∫Øt bu·ªôc")
    @PositiveOrZero
    @JsonProperty("Quantity")
    private BigDecimal quantity;

    @NotNull(message = "ƒê∆°n gi√° l√† b·∫Øt bu·ªôc")
    @PositiveOrZero
    @JsonProperty("Price")
    private BigDecimal price;

    @JsonProperty("GrossAmount")
    private BigDecimal grossAmount; //Qty * Price

    @JsonProperty("DiscountRate")
    private BigDecimal discountRate;

    @JsonProperty("DiscountAmount")
    private BigDecimal discountAmount;

    @NotNull(message = "ID lo·∫°i thu·∫ø l√† b·∫Øt bu·ªôc")
    @JsonProperty("TaxTypeID")
    private Long taxTypeId; // Mapping t·ªõi vat_rate_id

    @JsonProperty("TaxRate")
    private BigDecimal taxRate;

    @JsonProperty("TaxAmount")
    private BigDecimal taxAmount;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/request/EinvSubmitInvoiceRequest.java">
package com.einvoicehub.core.dto.request;

import com.fasterxml.jackson.annotation.JsonProperty;
import jakarta.validation.Valid;
import jakarta.validation.constraints.Email;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotEmpty;
import jakarta.validation.constraints.NotNull;
import lombok.*;
import java.math.BigDecimal;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvSubmitInvoiceRequest {

    @NotBlank(message = "Lo·∫°i nghi·ªáp v·ª• (SubmitInvoiceType) l√† b·∫Øt bu·ªôc")
    @JsonProperty("SubmitInvoiceType")
    private String submitInvoiceType;

    @JsonProperty("PartnerInvoiceID")
    private String partnerInvoiceId;
    @NotNull(message = "ID lo·∫°i h√≥a ƒë∆°n l√† b·∫Øt bu·ªôc")
    @JsonProperty("InvoiceTypeID")
    private Long invoiceTypeId;

    @JsonProperty("InvoiceDate")
    private String invoiceDate;

    @JsonProperty("InvoiceForm")
    private String invoiceForm;

    @JsonProperty("InvoiceSeries")
    private String invoiceSeries;

    @NotNull(message = "Ph∆∞∆°ng th·ª©c thanh to√°n l√† b·∫Øt bu·ªôc")
    @JsonProperty("PaymentMethodID")
    private Long paymentMethodId; //

    @JsonProperty("BuyerTaxCode")
    private String buyerTaxCode;

    @JsonProperty("BuyerCompany")
    private String buyerCompany;

    @JsonProperty("BuyerName")
    private String buyerName;

    @JsonProperty("BuyerAddress")
    private String buyerAddress;

    @JsonProperty("BuyerIDNo")
    private String buyerIdNo;

    @JsonProperty("BuyerMobile")
    private String buyerMobile;

    @JsonProperty("BuyerBankAccount")
    private String buyerBankAccount;

    @JsonProperty("BuyerBankName")
    private String buyerBankName;

    @JsonProperty("BuyerBudgetCode")
    private String buyerBudgetCode;

    @Email(message = "Email nh·∫≠n h√≥a ƒë∆°n kh√¥ng h·ª£p l·ªá")
    @JsonProperty("ReceiverEmail")
    private String receiverEmail;

    @NotBlank(message = "M√£ ti·ªÅn t·ªá l√† b·∫Øt bu·ªôc")
    @JsonProperty("CurrencyCode")
    private String currencyCode;

    @NotNull(message = "T·ª∑ gi√° l√† b·∫Øt bu·ªôc")
    @JsonProperty("ExchangeRate")
    private BigDecimal exchangeRate;

    @JsonProperty("Notes")
    private String notes;

    @NotEmpty(message = "H√≥a ƒë∆°n ph·∫£i c√≥ √≠t nh·∫•t m·ªôt d√≤ng h√†ng")
    @Valid
    @JsonProperty("Details")
    private List<EinvSubmitInvoiceDetailRequest> details;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/response/EinvAuditLogResponse.java">
package com.einvoicehub.core.dto.response;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvAuditLogResponse {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("MerchantID")
    private Long merchantId;

    @JsonProperty("MerchantName")
    private String merchantName;

    @JsonProperty("UserID")
    private Long userId;

    @JsonProperty("UserName")
    private String userName;

    @JsonProperty("EntityType")
    private String entityType; // Invoice, Merchant, Config...

    @JsonProperty("EntityID")
    private Long entityId;

    @JsonProperty("Action")
    private String action;

    @JsonProperty("OldValue")
    private String oldValue; //old JSON

    @JsonProperty("NewValue")
    private String newValue; //new Json

    @JsonProperty("IpAddress")
    private String ipAddress;

    @JsonProperty("UserAgent")
    private String userAgent;

    @JsonProperty("RequestID")
    private String requestId;

    @JsonProperty("CreatedAt")
    private String createdAt;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/response/EinvInvoiceAdjustmentResponse.java">
package com.einvoicehub.core.dto.response;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;
import java.math.BigDecimal;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceAdjustmentResponse {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("OriginalInvoiceID")
    private Long originalInvoiceId;

    @JsonProperty("OriginalInvoiceNumber")
    private String originalInvoiceNumber;

    @JsonProperty("OriginalSymbolCode")
    private String originalSymbolCode;

    @JsonProperty("OriginalTemplateCode")
    private String originalTemplateCode;

    @JsonProperty("OriginalIssueDate")
    private String originalIssueDate;

    @JsonProperty("AdjustmentType")
    private String adjustmentType;

    @JsonProperty("AgreementNumber")
    private String agreementNumber;

    @JsonProperty("AgreementDate")
    private String agreementDate; // ƒê·ªãnh d·∫°ng dd/MM/yyyy theo SOFTZ

    @JsonProperty("ReasonDescription")
    private String reasonDescription;

    @JsonProperty("Status")
    private String status; // PENDING, APPROVED, REJECTED

    @JsonProperty("OldTotalAmount")
    private BigDecimal oldTotalAmount;

    @JsonProperty("NewTotalAmount")
    private BigDecimal newTotalAmount;

    @JsonProperty("DifferenceAmount")
    private BigDecimal differenceAmount;

    @JsonProperty("SubmittedToCqt")
    private Boolean submittedToCqt;

    @JsonProperty("CqtResponseCode")
    private String cqtResponseCode;

    @JsonProperty("CqtResponseMessage")
    private String cqtResponseMessage;

    @JsonProperty("ApprovedAt")
    private String approvedAt;

    @JsonProperty("CreatedAt")
    private String createdAt;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/response/EinvInvoiceMetadataResponse.java">
package com.einvoicehub.core.dto.response;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;
import java.math.BigDecimal;
import java.util.List;
import com.einvoicehub.core.dto.EinvInvoiceItemDto;
import com.einvoicehub.core.dto.EinvInvoiceTaxBreakdownDto;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceMetadataResponse {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("MerchantID")
    private Long merchantId;

    @JsonProperty("MerchantName")
    private String merchantName;

    @JsonProperty("StatusID")
    private Integer statusId;

    @JsonProperty("StatusName")
    private String statusName;

    @JsonProperty("StatusMessage")
    private String statusMessage;

    @JsonProperty("InvoiceNumber")
    private String invoiceNumber;

    @JsonProperty("SymbolCode")
    private String symbolCode;

    @JsonProperty("TemplateCode")
    private String templateCode;

    @JsonProperty("LookupCode")
    private String lookupCode;

    @JsonProperty("TaxAuthorityCode")
    private String taxAuthorityCode; // cqt_code trong SQL

    @JsonProperty("PartnerInvoiceID")
    private String partnerInvoiceId;

    @JsonProperty("PaymentMethod")
    private String paymentMethod;

    @JsonProperty("SellerName")
    private String sellerName;

    @JsonProperty("SellerTaxCode")
    private String sellerTaxCode;

    @JsonProperty("SellerAddress")
    private String sellerAddress;

    @JsonProperty("BuyerName")
    private String buyerName;

    @JsonProperty("BuyerTaxCode")
    private String buyerTaxCode;

    @JsonProperty("BuyerIdNo")
    private String buyerIdNo;

    @JsonProperty("BuyerFullName")
    private String buyerFullName;

    @JsonProperty("BuyerEmail")
    private String buyerEmail;

    @JsonProperty("BuyerPhone")
    private String buyerPhone;

    @JsonProperty("BuyerAddress")
    private String buyerAddress;

    @JsonProperty("BuyerBankAccount")
    private String buyerBankAccount;

    @JsonProperty("BuyerBankName")
    private String buyerBankName;

    @JsonProperty("SubtotalAmount")
    private BigDecimal subtotalAmount;

    @JsonProperty("TaxAmount")
    private BigDecimal taxAmount;

    @JsonProperty("DiscountAmount")
    private BigDecimal discountAmount;

    @JsonProperty("TotalAmount")
    private BigDecimal totalAmount;

    @JsonProperty("CurrencyCode")
    private String currencyCode;

    @JsonProperty("ExchangeRate")
    private BigDecimal exchangeRate;

    @JsonProperty("IssueDate")
    private String issueDate;

    @JsonProperty("SignedAt")
    private String signedAt;

    @JsonProperty("CreatedAt")
    private String createdAt;

    @JsonProperty("Items")
    private List<EinvInvoiceItemDto> items;

    @JsonProperty("TaxBreakdowns")
    private List<EinvInvoiceTaxBreakdownDto> taxBreakdowns;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/response/EinvInvoiceSyncQueueResponse.java">
package com.einvoicehub.core.dto.response;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceSyncQueueResponse {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("InvoiceID")
    private Long invoiceId;

    @JsonProperty("InvoiceNumber")
    private String invoiceNumber;

    @JsonProperty("SyncType")
    private String syncType;

    @JsonProperty("Priority")
    private Integer priority;

    @JsonProperty("Status")
    private String status; // PENDING, PROCESSING, COMPLETED, FAILED, RETRYING

    @JsonProperty("AttemptCount")
    private Integer attemptCount;

    @JsonProperty("MaxAttempts")
    private Integer maxAttempts;

    @JsonProperty("LastAttemptAt")
    private String lastAttemptAt;

    @JsonProperty("NextRetryAt")
    private String nextRetryAt;

    @JsonProperty("RequestData")
    private String requestData;

    @JsonProperty("ResponseData")
    private String responseData;

    @JsonProperty("ErrorCode")
    private String errorCode;

    @JsonProperty("ErrorMessage")
    private String errorMessage;

    @JsonProperty("ProcessedBy")
    private String processedBy;

    @JsonProperty("ProcessingStartedAt")
    private String processingStartedAt;

    @JsonProperty("ProcessingCompletedAt")
    private String processingCompletedAt;

    @JsonProperty("CreatedAt")
    private String createdAt;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/ApiResponse.java">
package com.einvoicehub.core.dto;

import com.einvoicehub.core.exception.ErrorCode;
import com.fasterxml.jackson.annotation.JsonInclude;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@JsonInclude(JsonInclude.Include.NON_NULL)
public class ApiResponse<T> {

    private ErrorCode code;

    private String message;

    private T result;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvApiCredentialDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvApiCredentialDto {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("MerchantID")
    private Long merchantId;

    @JsonProperty("MerchantName")
    private String merchantName;

    @JsonProperty("ClientID")
    private String clientId;

    @JsonProperty("ApiKeyPrefix")
    private String apiKeyPrefix;

    @JsonProperty("Scopes")
    private String scopes; // JSON array string

    @JsonProperty("IpWhitelist")
    private String ipWhitelist;

    @JsonProperty("RateLimitPerHour")
    private Integer rateLimitPerHour;

    @JsonProperty("RateLimitPerDay")
    private Integer rateLimitPerDay;

    @JsonProperty("RequestCountHour")
    private Integer requestCountHour;

    @JsonProperty("RequestCountDay")
    private Integer requestCountDay;

    @JsonProperty("RequestCountResettedAt")
    private String requestCountResettedAt;

    @JsonProperty("ExpiredAt")
    private String expiredAt;

    @JsonProperty("LastUsedAt")
    private String lastUsedAt;

    @JsonProperty("IsActive")
    private Boolean isActive;

    @JsonProperty("CreatedAt")
    private String createdAt;

    @JsonProperty("UpdatedAt")
    private String updatedAt;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvInvoiceItemDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;
import java.math.BigDecimal;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceItemDto {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("LineNumber")
    private Integer lineNumber;

    @JsonProperty("IsFree")
    private Boolean isFree;

    @JsonProperty("ProductCode")
    private String productCode;

    @JsonProperty("ProductName")
    private String productName;

    @JsonProperty("UnitName")
    private String unitName;

    @JsonProperty("Quantity")
    private BigDecimal quantity;

    @JsonProperty("UnitPrice")
    private BigDecimal unitPrice;

    @JsonProperty("GrossAmount")
    private BigDecimal grossAmount;

    @JsonProperty("DiscountRate")
    private BigDecimal discountRate;

    @JsonProperty("DiscountAmount")
    private BigDecimal discountAmount;

    @JsonProperty("TaxRate")
    private BigDecimal taxRate;

    @JsonProperty("TaxAmount")
    private BigDecimal taxAmount;

    @JsonProperty("TotalAmount")
    private BigDecimal totalAmount;

    @JsonProperty("Notes")
    private String notes;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvInvoicePayloadDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoicePayloadDto {
    @JsonProperty("InvoiceID")
    private Long invoiceId;

    @JsonProperty("RawData")
    private String rawData;

    @JsonProperty("XmlContent")
    private String xmlContent;

    @JsonProperty("JsonContent")
    private String jsonContent;

    @JsonProperty("SignedXml")
    private String signedXml;

    @JsonProperty("PdfData")
    private String pdfData;

    @JsonProperty("ExtraData")
    private String extraData;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvInvoiceRegistrationRequest.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import jakarta.validation.constraints.*;
import lombok.*;
import java.time.LocalDate;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceRegistrationRequest {

    @NotNull(message = "Merchant ID l√† b·∫Øt bu·ªôc")
    @JsonProperty("MerchantID")
    private Long merchantId;

    @NotBlank(message = "S·ªë quy·∫øt ƒë·ªãnh/ph√™ duy·ªát kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @Size(max = 50)
    @JsonProperty("RegistrationNumber")
    private String registrationNumber;

    @NotNull(message = "S·ªë b·∫Øt ƒë·∫ßu l√† b·∫Øt bu·ªôc")
    @Min(value = 1)
    @JsonProperty("FromNumber")
    private Long fromNumber;

    @NotNull(message = "S·ªë k·∫øt th√∫c l√† b·∫Øt bu·ªôc")
    @Min(value = 1)
    @JsonProperty("ToNumber")
    private Long toNumber;

    @NotNull(message = "S·ªë l∆∞·ª£ng h√≥a ƒë∆°n l√† b·∫Øt bu·ªôc")
    @Positive
    @JsonProperty("Quantity")
    private Long quantity;

    @NotNull(message = "Ng√†y hi·ªáu l·ª±c l√† b·∫Øt bu·ªôc")
    @JsonProperty("EffectiveDate")
    private LocalDate effectiveDate;

    @JsonProperty("ExpirationDate")
    private LocalDate expirationDate;

    @NotNull(message = "ID tr·∫°ng th√°i l√† b·∫Øt bu·ªôc")
    @JsonProperty("StatusID")
    private Integer statusId;

    @JsonProperty("IssuedBy")
    private String issuedBy;

    @JsonProperty("Note")
    private String note;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvInvoiceRegistrationResponse.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;
import java.time.LocalDate;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceRegistrationResponse {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("MerchantID")
    private Long merchantId;

    @JsonProperty("MerchantName")
    private String merchantName;

    @JsonProperty("RegistrationNumber")
    private String registrationNumber;

    @JsonProperty("FromNumber")
    private Long fromNumber;

    @JsonProperty("ToNumber")
    private Long toNumber;

    @JsonProperty("Quantity")
    private Long quantity;

    @JsonProperty("CurrentNumber")
    private Long currentNumber;

    @JsonProperty("EffectiveDate")
    private LocalDate effectiveDate;

    @JsonProperty("ExpirationDate")
    private LocalDate expirationDate;

    // --- Flattened Status Info ---
    @JsonProperty("StatusID")
    private Integer statusId;

    @JsonProperty("StatusName")
    private String statusName;

    @JsonProperty("IssuedBy")
    private String issuedBy;

    @JsonProperty("CreatedAt")
    private LocalDateTime createdAt;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvInvoiceStatusDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceStatusDto {
    @JsonProperty("ID")
    private Integer id;

    @JsonProperty("Name")
    private String name;

    @JsonProperty("Description")
    private String description;

    @JsonProperty("Note")
    private String note;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvInvoiceTaxBreakdownDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;
import java.math.BigDecimal;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceTaxBreakdownDto {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("VatRateCode")
    private String vatRateCode;

    @JsonProperty("VatRatePercent")
    private BigDecimal vatRatePercent;

    @JsonProperty("SubtotalAmount")
    private BigDecimal subtotalAmount;

    @JsonProperty("TaxableAmount")
    private BigDecimal taxableAmount;

    @JsonProperty("TaxAmount")
    private BigDecimal taxAmount;

    @JsonProperty("TotalAmount")
    private BigDecimal totalAmount;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvInvoiceTemplateRequest.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import jakarta.validation.constraints.*;
import lombok.*;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceTemplateRequest {

    @NotNull(message = "Merchant ID l√† b·∫Øt bu·ªôc")
    @JsonProperty("MerchantID")
    private Long merchantId;

    @NotNull(message = "Lo·∫°i h√≥a ƒë∆°n ID l√† b·∫Øt bu·ªôc")
    @JsonProperty("InvoiceTypeID")
    private Long invoiceTypeId;

    @JsonProperty("RegistrationID")
    private Long registrationId;

    @NotBlank(message = "M·∫´u h√≥a ƒë∆°n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @Size(max = 20)
    @JsonProperty("TemplateCode")
    private String templateCode;

    @NotBlank(message = "K√Ω hi·ªáu h√≥a ƒë∆°n kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @Size(max = 10)
    @JsonProperty("SymbolCode")
    private String symbolCode;

    @JsonProperty("MinNumber")
    private Integer minNumber;

    @JsonProperty("MaxNumber")
    private Integer maxNumber;

    @JsonProperty("StartDate")
    private LocalDateTime startDate;

    @JsonProperty("IsActive")
    private Boolean isActive;

    @JsonProperty("ProviderID")
    private String providerId;

    @JsonProperty("ProviderSerialID")
    private String providerSerialId;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvInvoiceTemplateResponse.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceTemplateResponse {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("MerchantID")
    private Long merchantId;

    @JsonProperty("MerchantName")
    private String merchantName;

    @JsonProperty("InvoiceTypeID")
    private Long invoiceTypeId;

    @JsonProperty("InvoiceTypeName")
    private String invoiceTypeName;

    @JsonProperty("RegistrationID")
    private Long registrationId;

    @JsonProperty("RegistrationNumber")
    private String registrationNumber;

    @JsonProperty("TemplateCode")
    private String templateCode;

    @JsonProperty("SymbolCode")
    private String symbolCode;

    @JsonProperty("CurrentNumber")
    private Integer currentNumber;

    @JsonProperty("MinNumber")
    private Integer minNumber;

    @JsonProperty("MaxNumber")
    private Integer maxNumber;

    @JsonProperty("IsActive")
    private Boolean isActive;

    @JsonProperty("ProviderID")
    private String providerId;

    @JsonProperty("CreatedAt")
    private LocalDateTime createdAt;

    @JsonProperty("UpdatedAt")
    private LocalDateTime updatedAt;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvInvoiceTypeDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvInvoiceTypeDto {
    @JsonProperty("ID")
    private Long id;

    @JsonProperty("TypeCode")
    private String typeCode;

    @JsonProperty("TypeName")
    private String typeName;

    @JsonProperty("Description")
    private String description;

    @JsonProperty("IsActive")
    private Boolean isActive;

    @JsonProperty("DisplayOrder")
    private Integer displayOrder;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvMerchantProviderConfigRequest.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import jakarta.validation.constraints.Size;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvMerchantProviderConfigRequest {

    @NotNull(message = "Merchant ID l√† b·∫Øt bu·ªôc")
    @JsonProperty("MerchantID")
    private Long merchantId;

    @NotNull(message = "Provider ID l√† b·∫Øt bu·ªôc")
    @JsonProperty("ProviderID")
    private Long providerId;

    @JsonProperty("PartnerID")
    private String partnerId;

    @JsonProperty("PartnerToken")
    private String partnerToken;

    @NotBlank(message = "M√£ s·ªë thu·∫ø k·∫øt n·ªëi kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @Size(max = 20)
    @JsonProperty("TaxCode")
    private String taxCode;

    @JsonProperty("IntegrationUrl")
    private String integrationUrl;

    @NotBlank(message = "T√†i kho·∫£n d·ªãch v·ª• (Username) kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @JsonProperty("UsernameService")
    private String usernameService;

    @NotBlank(message = "M·∫≠t kh·∫©u d·ªãch v·ª• kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @JsonProperty("PasswordService")
    private String passwordService; // M·∫≠t kh·∫©u th√¥ ƒë·ªÉ Service x·ª≠ l√Ω m√£ h√≥a

    @JsonProperty("IsTestMode")
    private Boolean isTestMode;

    @JsonProperty("IsActive")
    private Boolean isActive;

    @JsonProperty("IsDefault")
    private Boolean isDefault;

    @JsonProperty("ExtraConfig")
    private String extraConfig; // D·ªØ li·ªáu JSON ƒë·ªÉ config
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvMerchantProviderConfigResponse.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvMerchantProviderConfigResponse {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("MerchantID")
    private Long merchantId;

    @JsonProperty("MerchantName")
    private String merchantName;

    @JsonProperty("MerchantTaxCode")
    private String merchantTaxCode;

    @JsonProperty("ProviderID")
    private Long providerId;

    @JsonProperty("ProviderCode")
    private String providerCode; // MISA, BKAV, MOBIFONE...

    @JsonProperty("ProviderName")
    private String providerName;

    @JsonProperty("PartnerID")
    private String partnerId;

    @JsonProperty("TaxCode")
    private String taxCode;

    @JsonProperty("IntegrationUrl")
    private String integrationUrl;

    @JsonProperty("UsernameService")
    private String usernameService;

    @JsonProperty("IsTestMode")
    private Boolean isTestMode;

    @JsonProperty("IsActive")
    private Boolean isActive;

    @JsonProperty("IsDefault")
    private Boolean isDefault;

    @JsonProperty("LastSyncAt")
    private LocalDateTime lastSyncAt;

    @JsonProperty("CreatedAt")
    private LocalDateTime createdAt;

    @JsonProperty("UpdatedAt")
    private LocalDateTime updatedAt;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvMerchantRequest.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import jakarta.validation.constraints.*;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvMerchantRequest {

    @NotBlank(message = "M√£ s·ªë thu·∫ø kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @Size(max = 20, message = "M√£ s·ªë thu·∫ø kh√¥ng qu√° 20 k√Ω t·ª±")
    @JsonProperty("TaxCode")
    private String taxCode;

    @NotBlank(message = "T√™n c√¥ng ty kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @Size(max = 255, message = "T√™n c√¥ng ty kh√¥ng qu√° 255 k√Ω t·ª±")
    @JsonProperty("CompanyName")
    private String companyName;

    @Size(max = 100)
    @JsonProperty("ShortName")
    private String shortName;

    @JsonProperty("Address")
    private String address;

    @Size(max = 100)
    @JsonProperty("District")
    private String district;

    @Size(max = 100)
    @JsonProperty("City")
    private String city;

    @Email(message = "Email kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng")
    @JsonProperty("Email")
    private String email;

    @Size(max = 20)
    @JsonProperty("Phone")
    private String phone;

    @JsonProperty("RepresentativeName")
    private String representativeName;

    @JsonProperty("RepresentativeTitle")
    private String representativeTitle;

    @Size(max = 10)
    @JsonProperty("TaxAuthorityCode")
    private String taxAuthorityCode;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvMerchantResponse.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvMerchantResponse {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("TaxCode")
    private String taxCode;

    @JsonProperty("CompanyName")
    private String companyName;

    @JsonProperty("ShortName")
    private String shortName;

    @JsonProperty("Address")
    private String address;

    @JsonProperty("City")
    private String city;

    @JsonProperty("Email")
    private String email;

    @JsonProperty("Phone")
    private String phone;

    @JsonProperty("RepresentativeName")
    private String representativeName;

    // --- Enterprise Shell Fields (SaaS Info) ---
    @JsonProperty("SubscriptionPlan")
    private String subscriptionPlan;

    @JsonProperty("InvoiceQuota")
    private Integer invoiceQuota;

    @JsonProperty("InvoiceUsed")
    private Integer invoiceUsed;

    @JsonProperty("IsUsingHsm")
    private Boolean isUsingHsm;

    @JsonProperty("CreatedAt")
    private String createdAt;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvMerchantUserRequest.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import jakarta.validation.constraints.*;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvMerchantUserRequest {

    @NotNull(message = "Merchant ID l√† b·∫Øt bu·ªôc")
    @JsonProperty("MerchantID")
    private Long merchantId;

    @NotBlank(message = "Username kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @Size(min = 4, max = 50)
    @JsonProperty("Username")
    private String username;

    @NotBlank(message = "Email kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @Email
    @JsonProperty("Email")
    private String email;

    /**
     * Trong Request g·ª≠i l√™n l√† m·∫≠t kh·∫©u th√¥ (Plain text),
     * sau ƒë√≥ Service s·∫Ω m√£ h√≥a th√†nh password_hash ƒë·ªÉ l∆∞u.
     */
    @NotBlank(message = "M·∫≠t kh·∫©u kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng")
    @Size(min = 8, message = "M·∫≠t kh·∫©u t·ªëi thi·ªÉu 8 k√Ω t·ª±")
    @JsonProperty("Password")
    private String password;

    @JsonProperty("FullName")
    private String fullName;

    @JsonProperty("Phone")
    private String phone;

    @JsonProperty("Role")
    private String role; // ADMIN, MANAGER, STAFF,VIEWER

    @JsonProperty("IsPrimary")
    private Boolean isPrimary;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvMerchantUserResponse.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvMerchantUserResponse {

    @JsonProperty("ID")
    private Long id;

    @JsonProperty("Username")
    private String username;

    @JsonProperty("Email")
    private String email;

    @JsonProperty("FullName")
    private String fullName;

    @JsonProperty("Phone")
    private String phone;

    @JsonProperty("Role")
    private String role;

    @JsonProperty("IsActive")
    private Boolean isActive;

    @JsonProperty("LastLoginAt")
    private String lastLoginAt;

    @JsonProperty("MerchantID")
    private Long merchantId;

    @JsonProperty("MerchantName")
    private String merchantName;

    @JsonProperty("MerchantTaxCode")
    private String merchantTaxCode;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvoiceHubRequest.java">
package com.einvoicehub.core.dto;

import jakarta.validation.Valid;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvoiceHubRequest<T> {

    private String requestDateTime;
    private String requestId;
    private String userAgent;
    @Valid
    private T data;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvoiceHubResponse.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonInclude;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvoiceHubResponse<T> {

    private String responseCode;
    private String requestId;
    private Integer status;

    @JsonInclude(JsonInclude.Include.NON_NULL)
    private String responseDesc;

    @JsonInclude(JsonInclude.Include.NON_NULL)
    private T data;

    public static <T> EinvoiceHubResponse<T> success(String requestId, T data) {
        return EinvoiceHubResponse.<T>builder()
                .responseCode("200")
                .requestId(requestId)
                .status(0)
                .data(data)
                .build();
    }

    public static <T> EinvoiceHubResponse<T> error(String requestId, String code, String message) {
        return EinvoiceHubResponse.<T>builder()
                .responseCode(code)
                .requestId(requestId)
                .status(1)
                .responseDesc(message)
                .build();
    }

    public static <T> EinvoiceHubResponse<T> badRequest(String requestId, String message) {
        return error(requestId, "400", message);
    }

    public static <T> EinvoiceHubResponse<T> internalError(String requestId, String message) {
        return error(requestId, "500", message);
    }

    public static <T> EinvoiceHubResponse<T> providerError(String requestId, String message) {
        return error(requestId, "502", message);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvPaymentMethodDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvPaymentMethodDto {
    @JsonProperty("ID")
    private Long id;

    @JsonProperty("MethodCode")
    private String methodCode;

    @JsonProperty("MethodName")
    private String methodName;

    @JsonProperty("Description")
    private String description;

    @JsonProperty("IsActive")
    private Boolean isActive;

    @JsonProperty("DisplayOrder")
    private Integer displayOrder;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvRegistrationStatusDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvRegistrationStatusDto {
    @JsonProperty("ID")
    private Integer id;

    @JsonProperty("Name")
    private String name;

    @JsonProperty("Description")
    private String description;

    @JsonProperty("Note")
    private String note;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvServiceProviderDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvServiceProviderDto {
    @JsonProperty("ID")
    private Long id;

    @JsonProperty("ProviderCode")
    private String providerCode; // MISA, BKAV, MOBIFONE...

    @JsonProperty("ProviderName")
    private String providerName;

    @JsonProperty("OfficialApiUrl")
    private String officialApiUrl;

    @JsonProperty("LookupUrl")
    private String lookupUrl;

    @JsonProperty("SupportEmail")
    private String supportEmail;

    @JsonProperty("SupportPhone")
    private String supportPhone;

    @JsonProperty("IsActive")
    private Boolean isActive;

    @JsonProperty("IsDefault")
    private Boolean isDefault;

    @JsonProperty("DisplayOrder")
    private Integer displayOrder;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvSystemConfigDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

@Data @Builder @NoArgsConstructor @AllArgsConstructor
public class EinvSystemConfigDto {
    @JsonProperty("ID") private Long id;
    @JsonProperty("ConfigKey") private String configKey;
    @JsonProperty("ConfigValue") private String configValue;
    @JsonProperty("ConfigType") private String configType;
    @JsonProperty("Description") private String description;
    @JsonProperty("IsEncrypted") private Boolean isEncrypted;
    @JsonProperty("IsEditable") private Boolean isEditable;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvTaxAuthorityResponseDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;
import java.time.LocalDateTime;

@Data @Builder @NoArgsConstructor @AllArgsConstructor
public class EinvTaxAuthorityResponseDto {
    @JsonProperty("ID") private Long id;
    @JsonProperty("InvoiceID") private Long invoiceId;
    @JsonProperty("CqtCode") private String cqtCode;
    @JsonProperty("StatusFromCqt") private String statusFromCqt;
    @JsonProperty("ProcessingCode") private String processingCode;
    @JsonProperty("SignatureData") private String signatureData;
    @JsonProperty("RawResponse") private String rawResponse;
    @JsonProperty("ErrorCode") private String errorCode;
    @JsonProperty("ErrorMessage") private String errorMessage;
    @JsonProperty("ReceivedAt") private LocalDateTime receivedAt;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/EinvVatRateDto.java">
package com.einvoicehub.core.dto;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;
import java.math.BigDecimal;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class EinvVatRateDto {
    @JsonProperty("ID")
    private Long id;

    @JsonProperty("RateCode")
    private String rateCode;

    @JsonProperty("RatePercent")
    private BigDecimal ratePercent;

    @JsonProperty("RateName")
    private String rateName;

    @JsonProperty("Description")
    private String description;

    @JsonProperty("IsActive")
    private Boolean isActive;

    @JsonProperty("DisplayOrder")
    private Integer displayOrder;
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/PaginationRequestDto.java">
package com.einvoicehub.core.dto;

import lombok.*;
import java.util.HashMap;
import java.util.Map;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class PaginationRequestDto {

    @Builder.Default
    private Integer offset = 0;
    @Builder.Default
    private Integer limit = 20;
    @Builder.Default
    private Map<String, Object> filters = new HashMap<>();
    private String sortField;
    @Builder.Default
    private String sortDirection = "desc";
    public int getPageNumber() {
        return limit == 0 ? 0 : (offset / limit);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/dto/PaginationResponseDto.java">
package com.einvoicehub.core.dto;

import lombok.*;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class PaginationResponseDto<T> {
    private long offset;
    private long limit;
    private long total;
    private long count;
    private List<T> items;
}
</file>

<file path="src/main/java/com/einvoicehub/core/exception/AppException.java">
package com.einvoicehub.core.exception;

import lombok.Getter;
import java.util.Collections;
import java.util.Map;

@Getter
public class AppException extends RuntimeException {

    private final ErrorCode errorCode;
    private final Map<String, Object> details;

    public AppException(ErrorCode errorCode) {
        this(errorCode, errorCode.getMessage(), Collections.emptyMap());
    }

    public AppException(ErrorCode errorCode, String customMessage) {
        this(errorCode, customMessage, Collections.emptyMap());
    }

    public AppException(ErrorCode errorCode, Map<String, Object> details) {
        this(errorCode, errorCode.getMessage(), details);
    }

    public AppException(ErrorCode errorCode, String customMessage, Map<String, Object> details) {
        super(customMessage);
        this.errorCode = errorCode;
        this.details = details != null ? details : Collections.emptyMap();
    }

    /* Exception chaining support */
    public AppException(ErrorCode errorCode, Throwable cause) {
        super(errorCode.getMessage(), cause);
        this.errorCode = errorCode;
        this.details = Collections.emptyMap();
    }

    @Override
    public String toString() {
        return String.format("AppException[errorCode=%s, code=%d, message='%s']",
                errorCode.name(), errorCode.getCode(), getMessage());
    }


}
</file>

<file path="src/main/java/com/einvoicehub/core/exception/ErrorCode.java">
package com.einvoicehub.core.exception;

import com.fasterxml.jackson.annotation.JsonValue;
import lombok.Getter;
import org.springframework.http.HttpStatus;

import java.util.Map;
import java.util.Optional;
import java.util.function.Function;
import java.util.stream.Collectors;
import java.util.stream.Stream;

@Getter
public enum ErrorCode {
    SUCCESS(1000, "Th√†nh c√¥ng", HttpStatus.OK),
    UNCATEGORIZED_EXCEPTION(9999, "L·ªói h·ªá th·ªëng kh√¥ng x√°c ƒë·ªãnh", HttpStatus.INTERNAL_SERVER_ERROR),

    // Auth & Access
    UNAUTHORIZED(403, "Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p", HttpStatus.FORBIDDEN),
    UNAUTHENTICATED(401, "Ch∆∞a x√°c th·ª±c t√†i kho·∫£n", HttpStatus.UNAUTHORIZED),
    API_KEY_INVALID(1005, "API Key kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n", HttpStatus.UNAUTHORIZED),

    // Merchant Errors
    MERCHANT_NOT_FOUND(1001, "Kh√¥ng t√¨m th·∫•y doanh nghi·ªáp", HttpStatus.NOT_FOUND),
    INSUFFICIENT_QUOTA(1002, "Doanh nghi·ªáp ƒë√£ h·∫øt h·∫°n m·ª©c h√≥a ƒë∆°n", HttpStatus.FORBIDDEN),

    // Validation & Data Errors
    VALIDATION_ERROR(1003, "D·ªØ li·ªáu ƒë·∫ßu v√†o kh√¥ng h·ª£p l·ªá", HttpStatus.BAD_REQUEST),
    INVALID_DATA(1006, "D·ªØ li·ªáu nghi·ªáp v·ª• kh√¥ng h·ª£p l·ªá", HttpStatus.BAD_REQUEST), // Th√™m cho InvalidDataException

    // Invoice Business Errors
    TEMPLATE_NOT_FOUND(2001, "Kh√¥ng t√¨m th·∫•y m·∫´u h√≥a ƒë∆°n", HttpStatus.NOT_FOUND),
    REGISTRATION_EXPIRED(2002, "D·∫£i s·ªë h√≥a ƒë∆°n ƒë√£ h·∫øt h·∫°n", HttpStatus.BAD_REQUEST),
    REGISTRATION_EXHAUSTED(2003, "D·∫£i s·ªë h√≥a ƒë∆°n ƒë√£ d√πng h·∫øt", HttpStatus.BAD_REQUEST),

    PROVIDER_ERROR(1004, "L·ªói k·∫øt n·ªëi t·ª´ nh√† cung c·∫•p d·ªãch v·ª• (Provider)", HttpStatus.BAD_GATEWAY);

    private static final Map<Integer, ErrorCode> CACHE = Stream.of(values())
            .collect(Collectors.toMap(ErrorCode::getCode, Function.identity()));

    @JsonValue
    private final int code;
    private final String message;
    private final HttpStatus statusCode;

    ErrorCode(int code, String message, HttpStatus statusCode) {
        this.code = code;
        this.message = message;
        this.statusCode = statusCode;
    }

    public static Optional<ErrorCode> findByCode(int code) {
        return Optional.ofNullable(CACHE.get(code));
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/exception/GlobalExceptionHandler.java">
package com.einvoicehub.core.exception;

import com.einvoicehub.core.provider.exception.ProviderException;
import jakarta.validation.ConstraintViolationException;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.ResponseEntity;
import com.einvoicehub.core.dto.ApiResponse;
import org.springframework.http.converter.HttpMessageNotReadableException;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.web.HttpRequestMethodNotSupportedException;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.web.method.annotation.MethodArgumentTypeMismatchException;
import org.springframework.web.servlet.NoHandlerFoundException;

import java.util.LinkedHashMap;
import java.util.Map;

@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(AppException.class)
    public ResponseEntity<ApiResponse<?>> handleAppException(AppException ex) {
        log.warn("Business Exception: [{}] - {}", ex.getErrorCode().getCode(), ex.getMessage());
        return buildResponse(ex.getErrorCode(), ex.getMessage(), ex.getDetails());
    }

    @ExceptionHandler(ProviderException.class)
    public ResponseEntity<ApiResponse<?>> handleProviderException(ProviderException ex) {
        log.error("Provider Error [{}]: {} - Status: {}", ex.getProviderCode(), ex.getMessage(), ex.getStatusCode());

        ApiResponse<Map<String, Object>> response = ApiResponse.<Map<String, Object>>builder()
                .code(ErrorCode.PROVIDER_ERROR)
                .message(ex.getMessage())
                .result(ex.getDetails())
                .build();
        return ResponseEntity.status(ex.getStatusCode()).body(response);
    }

    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<ApiResponse<?>> handleValidation(MethodArgumentNotValidException ex) {
        Map<String, String> errors = new LinkedHashMap<>();
        ex.getBindingResult().getFieldErrors().forEach(error ->
                errors.put(error.getField(), error.getDefaultMessage())
        );

        ErrorCode errorCode = ErrorCode.VALIDATION_ERROR;
        try {
            String firstMsg = ex.getBindingResult().getFieldError().getDefaultMessage();
            if (firstMsg != null) errorCode = ErrorCode.valueOf(firstMsg);
        } catch (Exception ignored) {}

        log.warn("Validation Failed: {}", errors);
        return buildResponse(errorCode, errorCode.getMessage(), errors);
    }

    @ExceptionHandler(ConstraintViolationException.class)
    public ResponseEntity<ApiResponse<?>> handleConstraintViolation(ConstraintViolationException ex) {
        return buildResponse(ErrorCode.VALIDATION_ERROR, "Invalid parameter: " + ex.getMessage(), null);
    }

    @ExceptionHandler(AccessDeniedException.class)
    public ResponseEntity<ApiResponse<?>> handleAccessDenied(AccessDeniedException ex) {
        return buildResponse(ErrorCode.UNAUTHORIZED, "Access denied", null);
    }

    @ExceptionHandler(HttpMessageNotReadableException.class)
    public ResponseEntity<ApiResponse<?>> handleInvalidJson(HttpMessageNotReadableException ex) {
        return buildResponse(ErrorCode.VALIDATION_ERROR, "Invalid JSON format", null);
    }

    @ExceptionHandler(MethodArgumentTypeMismatchException.class)
    public ResponseEntity<ApiResponse<?>> handleTypeMismatch(MethodArgumentTypeMismatchException ex) {
        String msg = String.format("Parameter '%s' has an invalid data type", ex.getName());
        return buildResponse(ErrorCode.VALIDATION_ERROR, msg, null);
    }

    @ExceptionHandler(NoHandlerFoundException.class)
    public ResponseEntity<ApiResponse<?>> handleNotFound(NoHandlerFoundException ex) {
        return buildResponse(ErrorCode.VALIDATION_ERROR, "API endpoint not found: " + ex.getRequestURL(), null);
    }

    @ExceptionHandler(HttpRequestMethodNotSupportedException.class)
    public ResponseEntity<ApiResponse<?>> handleMethodNotAllowed(HttpRequestMethodNotSupportedException ex) {
        return buildResponse(ErrorCode.VALIDATION_ERROR, "HTTP method not supported", null);
    }

    @ExceptionHandler(Exception.class)
    public ResponseEntity<ApiResponse<?>> handleGenericException(Exception ex) {
        log.error("CRITICAL SYSTEM ERROR: ", ex);
        return buildResponse(ErrorCode.UNCATEGORIZED_EXCEPTION, ErrorCode.UNCATEGORIZED_EXCEPTION.getMessage(), null);
    }

    private ResponseEntity<ApiResponse<?>> buildResponse(ErrorCode errorCode, String message, Object result) {
        ApiResponse<?> response = ApiResponse.builder()
                .code(errorCode)
                .message(message)
                .result(result)
                .build();
        return ResponseEntity.status(errorCode.getStatusCode()).body(response);
    }


}
</file>

<file path="src/main/java/com/einvoicehub/core/exception/InsufficientQuotaException.java">
package com.einvoicehub.core.exception;

import lombok.Getter;


@Getter
public class InsufficientQuotaException extends AppException {
    public InsufficientQuotaException(String message) {
        super(ErrorCode.INSUFFICIENT_QUOTA);
    }

}
</file>

<file path="src/main/java/com/einvoicehub/core/exception/InvalidDataException.java">
package com.einvoicehub.core.exception;

import lombok.Getter;

@Getter
public class InvalidDataException extends AppException {

    public InvalidDataException(String message) {
        super(ErrorCode.INVALID_DATA, message);
    }

    public InvalidDataException(ErrorCode errorCode) {
        super(errorCode);
    }

    public InvalidDataException(ErrorCode errorCode, String customMessage) {
        super(errorCode, customMessage);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/exception/MerchantNotFoundException.java">
package com.einvoicehub.core.exception;

import lombok.Getter;
import org.springframework.http.HttpStatus;

/**
 * Exception khi kh√¥ng t√¨m th·∫•y Merchant.
 */
@Getter
public class MerchantNotFoundException extends AppException {
    private final String errorCode = "MERCHANT_NOT_FOUND";
    private final HttpStatus status = HttpStatus.NOT_FOUND;

    public MerchantNotFoundException(String merchantCode) {
        super(ErrorCode.MERCHANT_NOT_FOUND);     }
}
</file>

<file path="src/main/java/com/einvoicehub/core/mapper/EinvHubMapper.java">
package com.einvoicehub.core.mapper;

import com.einvoicehub.core.domain.entity.*;
import com.einvoicehub.core.dto.*;
import com.einvoicehub.core.dto.request.*;
import com.einvoicehub.core.dto.response.*;
import org.mapstruct.*;

import java.util.List;

@Mapper(componentModel = "spring", unmappedTargetPolicy = ReportingPolicy.IGNORE)
public interface EinvHubMapper {

    //  1. Catalog
    EinvInvoiceTypeDto toDto(EinvInvoiceTypeEntity entity);
    EinvInvoiceTypeEntity toEntity(EinvInvoiceTypeDto dto);
    EinvInvoiceStatusDto toDto(EinvInvoiceStatusEntity entity);
    EinvInvoiceStatusEntity toEntity(EinvInvoiceStatusDto dto);
    EinvPaymentMethodDto toDto(EinvPaymentMethodEntity entity);
    EinvPaymentMethodEntity toEntity(EinvPaymentMethodDto dto);
    EinvVatRateDto toDto(EinvVatRateEntity entity);
    EinvVatRateEntity toEntity(EinvVatRateDto dto);
    EinvRegistrationStatusDto toDto(EinvRegistrationStatusEntity entity);
    EinvRegistrationStatusEntity toEntity(EinvRegistrationStatusDto dto);
    EinvServiceProviderDto toDto(EinvServiceProviderEntity entity);
    EinvServiceProviderEntity toEntity(EinvServiceProviderDto dto);
    EinvInvoicePayloadDto toDto(EinvInvoicePayloadEntity entity);
    EinvInvoicePayloadEntity toEntity(EinvInvoicePayloadDto dto);
    EinvSystemConfigDto toDto(EinvSystemConfigEntity entity);
    EinvSystemConfigEntity toEntity(EinvSystemConfigDto dto);

    EinvTaxAuthorityResponseDto toDto(EinvTaxAuthorityResponseEntity entity);
    EinvTaxAuthorityResponseEntity toEntity(EinvTaxAuthorityResponseDto dto);
    EinvInvoiceSyncQueueResponse toDto(EinvInvoiceSyncQueueEntity entity);
    EinvInvoiceSyncQueueEntity toEntity(EinvInvoiceSyncQueueResponse dto);

    //  2. Merchant & User
    EinvMerchantEntity toEntity(EinvMerchantRequest request);
    EinvMerchantResponse toResponse(EinvMerchantEntity entity);
    EinvMerchantUserEntity toEntity(EinvMerchantUserRequest request);
    @Mapping(source = "merchant.id", target = "merchantId")
    @Mapping(source = "merchant.companyName", target = "merchantName")
    @Mapping(source = "merchant.taxCode", target = "merchantTaxCode")
    EinvMerchantUserResponse toResponse(EinvMerchantUserEntity entity);

    //  3. Config & Registration
    EinvMerchantProviderConfigEntity toEntity(EinvMerchantProviderConfigRequest request);
    @Mapping(source = "merchant.companyName", target = "merchantName")
    @Mapping(source = "provider.providerName", target = "providerName")
    @Mapping(source = "provider.providerCode", target = "providerCode")
    EinvMerchantProviderConfigResponse toResponse(EinvMerchantProviderConfigEntity entity);

    EinvInvoiceRegistrationEntity toEntity(EinvInvoiceRegistrationRequest request);
    @Mapping(source = "merchant.companyName", target = "merchantName")
    @Mapping(source = "status.name", target = "statusName")
    EinvInvoiceRegistrationResponse toResponse(EinvInvoiceRegistrationEntity entity);

    EinvInvoiceTemplateEntity toEntity(EinvInvoiceTemplateRequest request);
    @Mapping(source = "merchant.companyName", target = "merchantName")
    @Mapping(source = "invoiceType.typeName", target = "invoiceTypeName")
    @Mapping(source = "registration.registrationNumber", target = "registrationNumber")
    EinvInvoiceTemplateResponse toResponse(EinvInvoiceTemplateEntity entity);

    //  4. Transactions
    EinvInvoiceMetadataEntity toEntity(EinvSubmitInvoiceRequest request);
    EinvInvoiceItemEntity toEntity(EinvSubmitInvoiceDetailRequest request);
    EinvInvoiceItemEntity toEntity(EinvInvoiceItemDto dto);

    @Mapping(source = "merchant.companyName", target = "merchantName")
    @Mapping(source = "invoiceStatus.name", target = "statusName")
    @Mapping(source = "invoiceStatus.note", target = "statusMessage")
    @Mapping(source = "paymentMethodEntity.methodName", target = "paymentMethod")
    EinvInvoiceMetadataResponse toResponse(EinvInvoiceMetadataEntity entity);

    EinvInvoiceItemDto toDto(EinvInvoiceItemEntity entity);
    List<EinvInvoiceItemDto> toItemDtoList(List<EinvInvoiceItemEntity> entities);

    EinvInvoiceTaxBreakdownDto toDto(EinvInvoiceTaxBreakDownEntity entity);
    List<EinvInvoiceTaxBreakdownDto> toTaxDtoList(List<EinvInvoiceTaxBreakDownEntity> entities);

    //  5. Adjustment & Operationss
    EinvInvoiceAdjustmentsEntity toEntity(EinvInvoiceAdjustmentRequest request);
    @Mapping(source = "originalInvoice.invoiceNumber", target = "originalInvoiceNumber")
    @Mapping(source = "originalInvoice.symbolCode", target = "originalSymbolCode")
    EinvInvoiceAdjustmentResponse toResponse(EinvInvoiceAdjustmentsEntity entity);

    @Mapping(source = "merchant.companyName", target = "merchantName")
    @Mapping(source = "user.username", target = "userName")
    EinvAuditLogResponse toResponse(EinvAuditLogsEntity entity);

    @Mapping(source = "invoice.invoiceNumber", target = "invoiceNumber")
    EinvInvoiceSyncQueueResponse toResponse(EinvInvoiceSyncQueueEntity entity);

    @Mapping(source = "merchant.companyName", target = "merchantName")
    EinvApiCredentialDto toDto(EinvApiCredentialsEntity entity);
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/bkav/BkavAdapter.java">
package com.einvoicehub.core.provider.bkav;

import com.einvoicehub.core.domain.enums.InvoiceStatus;
import com.einvoicehub.core.provider.*;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.util.StringUtils;
import org.springframework.web.reactive.function.client.WebClient;

import javax.crypto.Cipher;
import javax.crypto.spec.GCMParameterSpec;
import javax.crypto.spec.SecretKeySpec;
import java.nio.charset.StandardCharsets;
import java.security.SecureRandom;
import java.time.Duration;
import java.util.*;

@Slf4j
@Service("BKAV")
public class BkavAdapter implements InvoiceProvider {

    private final WebClient webClient;
    private final BkavApiMapper apiMapper;
    private final ObjectMapper objectMapper;

    @Value("${provider.bkav.timeout-ms:30000}")
    private int timeoutMs;

    @Value("${provider.bkav.encryption-key:}")
    private String encryptionKey;

    public BkavAdapter(WebClient.Builder webClientBuilder,
                       BkavApiMapper apiMapper,
                       ObjectMapper objectMapper,
                       @Value("${provider.bkav.base-url:https://einvoice.bkav.com/api/v1}") String baseUrl) {
        this.webClient = webClientBuilder.baseUrl(baseUrl)
                .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)
                .build();
        this.apiMapper = apiMapper;
        this.objectMapper = objectMapper;
    }

    @Override public String getProviderCode() { return "BKAV"; }
    @Override public String getProviderName() { return "Bkav eInvoice"; }
    @Override public boolean isAvailable() { return true; }

    @Override
    public InvoiceResponse issueInvoice(InvoiceRequest request, ProviderConfig config) {
        log.info("BKAV: Issuing invoice for ClientID: {}", request.getClientRequestId());
        try {
            BkavCommandPayload payload = apiMapper.toBkavPayload(request);
            String encryptedData = encryptPayload(payload);

            BkavApiResponse response = callBkavApi(encryptedData, config);
            return apiMapper.toHubResponse(response, request.getClientRequestId());
        } catch (Exception e) {
            log.error("BKAV Issuance failed: {}", e.getMessage());
            return InvoiceResponse.builder()
                    .status(InvoiceResponse.ResponseStatus.FAILED)
                    .errorMessage("Issuance error: " + e.getMessage())
                    .build();
        }
    }

    @Override
    public InvoiceStatus getInvoiceStatus(String invoiceNumber, ProviderConfig config) {
        try {
            BkavCommandPayload payload = BkavCommandPayload.builder()
                    .cmdType(850)
                    .commandObject(invoiceNumber)
                    .build();

            BkavApiResponse response = callBkavApi(encryptPayload(payload), config);
            return (response != null) ? apiMapper.mapBkavStatus(response) : InvoiceStatus.FAILED;
        } catch (Exception e) {
            log.error("BKAV status check failed for {}: {}", invoiceNumber, e.getMessage());
            return InvoiceStatus.FAILED;
        }
    }

    @Override
    public InvoiceResponse cancelInvoice(String invoiceNumber, String reason, ProviderConfig config) {
        try {
            BkavCommandPayload payload = BkavCommandPayload.builder()
                    .cmdType(201)
                    .commandObject(List.of(Map.of("InvoiceGUID", invoiceNumber, "Reason", reason)))
                    .build();

            BkavApiResponse response = callBkavApi(encryptPayload(payload), config);
            return apiMapper.toHubResponse(response, null);
        } catch (Exception e) {
            return InvoiceResponse.builder()
                    .status(InvoiceResponse.ResponseStatus.FAILED)
                    .errorMessage(e.getMessage())
                    .build();
        }
    }

    @Override
    public InvoiceResponse replaceInvoice(String oldNo, InvoiceRequest newReq, ProviderConfig config) {
        try {
            BkavCommandPayload payload = apiMapper.toBkavPayload(newReq);
            payload.setCmdType(120);

            if (payload.getCommandObject() instanceof List<?> list && !list.isEmpty()) {
                Map<String, Object> invoice = (Map<String, Object>) list.get(0);
                invoice.put("OriginalInvoiceIdentify", String.format("[1]_[%s]_[%s]",
                        invoice.getOrDefault("InvoiceSerial", ""), formatInvoiceNo(oldNo)));
            }

            BkavApiResponse response = callBkavApi(encryptPayload(payload), config);
            return apiMapper.toHubResponse(response, newReq.getClientRequestId());
        } catch (Exception e) {
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage(e.getMessage()).build();
        }
    }

    @Override
    public String getInvoicePdf(String invoiceNumber, ProviderConfig config) {
        try {
            BkavCommandPayload payload = BkavCommandPayload.builder()
                    .cmdType(816)
                    .commandObject(List.of(Map.of("PartnerInvoiceID", invoiceNumber, "PartnerInvoiceStringID", "")))
                    .build();

            BkavApiResponse response = callBkavApi(encryptPayload(payload), config);
            return (response != null) ? response.getCode() : null;
        } catch (Exception e) { return null; }
    }

    @Override
    public String getInvoiceXml(String invoiceNumber, ProviderConfig config) {
        try {
            BkavCommandPayload payload = BkavCommandPayload.builder()
                    .cmdType(817)
                    .commandObject(List.of(Map.of("PartnerInvoiceID", invoiceNumber, "PartnerInvoiceStringID", "")))
                    .build();

            BkavApiResponse response = callBkavApi(encryptPayload(payload), config);
            return (response != null && response.getObject() != null) ? response.getObject().toString() : null;
        } catch (Exception e) {
            log.error("BKAV: Failed to fetch XML for {}", invoiceNumber);
            return null;
        }
    }

    @Override public String authenticate(ProviderConfig config) { return config.getUsername(); }
    @Override public boolean testConnection(ProviderConfig config) { return true; }

    /* Helper to call BKAV API with standardized headers */
    private BkavApiResponse callBkavApi(String encryptedData, ProviderConfig config) {
        return webClient.post().uri("/exec-command")
                .header("PartnerGUID", config.getUsername())
                .header("PartnerToken", config.getPassword())
                .bodyValue(Map.of("CommandData", encryptedData))
                .retrieve()
                .bodyToMono(BkavApiResponse.class)
                .timeout(Duration.ofMillis(timeoutMs))
                .block();
    }

    private String encryptPayload(BkavCommandPayload payload) throws Exception {
        String jsonData = objectMapper.writeValueAsString(payload);
        if (!StringUtils.hasText(encryptionKey)) return jsonData;

        SecretKeySpec secretKey = new SecretKeySpec(encryptionKey.getBytes(StandardCharsets.UTF_8), "AES");
        byte[] iv = new byte[12];
        new SecureRandom().nextBytes(iv);

        Cipher cipher = Cipher.getInstance("AES/GCM/NoPadding");
        cipher.init(Cipher.ENCRYPT_MODE, secretKey, new GCMParameterSpec(128, iv));
        byte[] encrypted = cipher.doFinal(jsonData.getBytes(StandardCharsets.UTF_8));

        return Base64.getEncoder().encodeToString(iv) + ":" + Base64.getEncoder().encodeToString(encrypted);
    }

    private String formatInvoiceNo(String no) {
        try { return String.format("%08d", Integer.parseInt(no)); } catch (Exception e) { return no; }
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class BkavCommandPayload { private int cmdType; private Object commandObject; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class BkavApiResponse {
        private int status;
        private Object object;
        private boolean isOk, isError;
        private String code;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/bkav/BkavApiMapper.java">
package com.einvoicehub.core.provider.bkav;

import com.einvoicehub.core.domain.enums.InvoiceStatus;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;

@Slf4j
@Component
@RequiredArgsConstructor
public class BkavApiMapper {

    private final ObjectMapper objectMapper;

    public BkavAdapter.BkavCommandPayload toBkavPayload(InvoiceRequest request) {
        List<Map<String, Object>> details = request.getItems().stream()
                .map(this::convertToBkavDetail)
                .toList();

        Map<String, Object> invoice = new LinkedHashMap<>();
        invoice.put("InvoiceTypeID", getInvoiceTypeId(request));

        LocalDateTime issueTime = request.getIssueDate() != null ?
                request.getIssueDate().atStartOfDay() : LocalDateTime.now();
        invoice.put("InvoiceDate", issueTime.format(DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ss.SSSXXX")));

        invoice.put("BuyerName", request.getBuyer() != null ? request.getBuyer().getName() : "");
        invoice.put("BuyerTaxCode", (request.getBuyer() != null && StringUtils.hasText(request.getBuyer().getTaxCode())) ?
                request.getBuyer().getTaxCode() : "");
        invoice.put("BuyerUnitName", request.getBuyer() != null ? request.getBuyer().getName() : "");
        invoice.put("BuyerAddress", request.getBuyer() != null ? request.getBuyer().getAddress() : "");
        invoice.put("PayMethodID", 3);
        invoice.put("ReceiveTypeID", 3);
        invoice.put("ReceiverEmail", request.getBuyer() != null ? request.getBuyer().getEmail() : "");
        invoice.put("CurrencyID", (request.getSummary() != null && StringUtils.hasText(request.getSummary().getCurrencyCode())) ?
                request.getSummary().getCurrencyCode() : "VND");
        invoice.put("ExchangeRate", 1.0);

        if (request.getExtraConfig() != null) {
            Optional.ofNullable(request.getExtraConfig().get("InvoiceForm")).ifPresent(v -> invoice.put("InvoiceForm", v));
            Optional.ofNullable(request.getExtraConfig().get("InvoiceSerial")).ifPresent(v -> invoice.put("InvoiceSerial", v));
        }

        invoice.put("InvoiceNo", 0);

        Map<String, Object> wrapper = new LinkedHashMap<>();
        wrapper.put("Invoice", invoice);
        wrapper.put("ListInvoiceDetailsWS", details);
        wrapper.put("ListInvoiceAttachFileWS", Collections.emptyList());
        wrapper.put("PartnerInvoiceID", request.getInvoiceMetadataId() != null ? request.getInvoiceMetadataId() : System.currentTimeMillis());

        int cmdType = (request.getExtraConfig() != null && request.getExtraConfig().containsKey("CmdType")) ?
                (Integer) request.getExtraConfig().get("CmdType") : 111;

        return BkavAdapter.BkavCommandPayload.builder()
                .cmdType(cmdType)
                .commandObject(List.of(wrapper))
                .build();
    }

    private Map<String, Object> convertToBkavDetail(InvoiceRequest.InvoiceItem item) {
        Map<String, Object> detail = new LinkedHashMap<>();
        detail.put("ItemName", item.getItemName());
        detail.put("UnitName", item.getUnitName() != null ? item.getUnitName() : "");
        detail.put("Qty", item.getQuantity());
        detail.put("Price", item.getUnitPrice());
        detail.put("Amount", item.getAmount());
        detail.put("TaxRateID", mapTaxRateToBkavId(item.getTaxRate()));
        detail.put("TaxRate", item.getTaxRate());
        detail.put("TaxAmount", item.getTaxAmount() != null ? item.getTaxAmount() : BigDecimal.ZERO);
        detail.put("ItemTypeID", 0);
        return detail;
    }

    public InvoiceResponse toHubResponse(BkavAdapter.BkavApiResponse response, String clientRequestId) {
        if (response == null) {
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage("No response from provider").build();
        }

        boolean isSuccess = response.isOk() && !response.isError();
        return InvoiceResponse.builder()
                .clientRequestId(clientRequestId)
                .status(isSuccess ? InvoiceResponse.ResponseStatus.SUCCESS : InvoiceResponse.ResponseStatus.FAILED)
                .errorCode(String.valueOf(response.getStatus()))
                .errorMessage(isSuccess ? null : extractField(response, "MessLog"))
                .transactionCode(extractField(response, "InvoiceGUID"))
                .invoiceNumber(extractField(response, "InvoiceNo"))
                .symbolCode(extractField(response, "InvoiceSerial"))
                .lookupCode(extractField(response, "MTC"))
                .pdfUrl(extractField(response, "MessLog"))
                .responseTime(LocalDateTime.now())
                .rawResponse(response)
                .build();
    }

    public InvoiceStatus mapBkavStatus(BkavAdapter.BkavApiResponse response) {
        try {
            JsonNode node = objectMapper.readTree(objectMapper.writeValueAsString(response.getObject()));
            if (node.isArray() && !node.isEmpty()) {
                int bkavStatus = node.get(0).path("BkavStatus").asInt();
                int taxStatus = node.get(0).path("TaxStatus").asInt();

                return switch (bkavStatus) {
                    case 1, 11 -> InvoiceStatus.SIGNING;
                    case 2 -> (taxStatus == 33) ? InvoiceStatus.SUCCESS : InvoiceStatus.SENT_TO_PROVIDER;
                    case 3 -> InvoiceStatus.CANCELLED;
                    case 6 -> InvoiceStatus.REPLACED;
                    case 8 -> InvoiceStatus.SUCCESS;
                    default -> InvoiceStatus.FAILED;
                };
            }
        } catch (Exception e) { log.error("BKAV status mapping failed"); }
        return InvoiceStatus.FAILED;
    }

    private String extractField(BkavAdapter.BkavApiResponse response, String field) {
        try {
            JsonNode node = objectMapper.readTree(objectMapper.writeValueAsString(response.getObject()));
            if (node.isArray() && !node.isEmpty()) return node.get(0).path(field).asText();
        } catch (Exception ignored) {}
        return null;
    }

    private int getInvoiceTypeId(InvoiceRequest request) {
        return (request.getExtraConfig() != null && request.getExtraConfig().get("InvoiceTypeID") instanceof Integer id) ? id : 1;
    }

    private int mapTaxRateToBkavId(BigDecimal taxRate) {
        if (taxRate == null) return 1;
        double rate = taxRate.doubleValue();
        if (rate == 5) return 2;
        if (rate == 10) return 3;
        if (rate == -1) return 4;
        return 1;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/exception/ProviderException.java">
package com.einvoicehub.core.provider.exception;

import lombok.Getter;
import java.time.LocalDateTime;
import java.util.Collections;
import java.util.Map;

@Getter
public class ProviderException extends RuntimeException {
    private final String providerCode;
    private final String errorCode;
    private final int statusCode;
    private final boolean retryable;
    private final LocalDateTime timestamp;
    private final Map<String, Object> details;

    public ProviderException(String message, String providerCode, String errorCode) {
        this(message, providerCode, errorCode, 500, false, null, null);
    }

    public ProviderException(String message, String providerCode, String errorCode, int statusCode) {
        this(message, providerCode, errorCode, statusCode, false, null, null);
    }

    public ProviderException(String message, String providerCode, String errorCode,
                             int statusCode, boolean retryable,
                             Map<String, Object> details, Throwable cause) {
        super(message, cause);
        this.providerCode = providerCode;
        this.errorCode = errorCode;
        this.statusCode = statusCode;
        this.retryable = retryable;
        this.details = details != null ? details : Collections.emptyMap();
        this.timestamp = LocalDateTime.now();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/misa/MisaAdapter.java">
package com.einvoicehub.core.provider.misa;

import com.einvoicehub.core.domain.enums.InvoiceStatus;
import com.einvoicehub.core.provider.*;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.*;
import org.springframework.stereotype.Service;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.reactive.function.client.WebClient;

import java.math.BigDecimal;
import java.time.Duration;
import java.time.LocalDateTime;
import java.util.*;

@Slf4j
@Service("MISA")
public class MisaAdapter implements InvoiceProvider {

    private final WebClient webClient;
    private final MisaApiMapper apiMapper;
    private final ObjectMapper objectMapper;

    @Value("${provider.misa.base-url:https://api.meinvoice.vn/api/integration}")
    private String baseUrl;

    private String cachedToken;
    private LocalDateTime tokenExpiry;

    public MisaAdapter(WebClient.Builder webClientBuilder, MisaApiMapper apiMapper, ObjectMapper objectMapper) {
        this.webClient = webClientBuilder.build();
        this.apiMapper = apiMapper;
        this.objectMapper = objectMapper;
    }

    @Override public String getProviderCode() { return "MISA"; }
    @Override public String getProviderName() { return "MISA MeInvoice"; }

    @Override
    public InvoiceResponse issueInvoice(InvoiceRequest request, ProviderConfig config) {
        log.info("MISA: Processing issuance for ClientRequestID: {}", request.getClientRequestId());
        try {
            String token = getOrRefreshToken(config);
            MisaInvoicePayload payload = apiMapper.toMisaPayload(request);

            /* Default SignType: 2 (HSM) */
            Map<String, Object> body = Map.of("SignType", 2, "InvoiceData", List.of(payload));

            MisaApiResponse response = webClient.post()
                    .uri(config.getCustomApiUrl() != null ? config.getCustomApiUrl() + "/invoice" : baseUrl + "/invoice")
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + token)
                    .bodyValue(body)
                    .retrieve()
                    .bodyToMono(MisaApiResponse.class)
                    .timeout(Duration.ofSeconds(30))
                    .block();

            return apiMapper.toHubResponse(response, request.getClientRequestId());
        } catch (Exception e) {
            log.error("MISA: Issuance failed: {}", e.getMessage());
            return InvoiceResponse.builder()
                    .status(InvoiceResponse.ResponseStatus.FAILED)
                    .errorMessage("MISA issuance error: " + e.getMessage())
                    .build();
        }
    }

    @Override
    public InvoiceStatus getInvoiceStatus(String transactionId, ProviderConfig config) {
        try {
            String token = getOrRefreshToken(config);
            MultiValueMap<String, String> params = new LinkedMultiValueMap<>();
            params.add("invoiceWithCode", "true");
            params.add("inputType", "1");

            MisaApiResponse response = webClient.post()
                    .uri(uriBuilder -> uriBuilder.path(baseUrl + "/invoice/status").queryParams(params).build())
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + token)
                    .bodyValue(List.of(transactionId))
                    .retrieve()
                    .bodyToMono(MisaApiResponse.class)
                    .block();

            if (response != null && response.getData() instanceof List<?> dataList && !dataList.isEmpty()) {
                Map<?, ?> dataMap = (Map<?, ?>) dataList.get(0);
                return apiMapper.mapMisaStatus((Integer) dataMap.get("EInvoiceStatus"));
            }
        } catch (Exception e) {
            log.error("MISA: Status check failed for TransactionID {}: {}", transactionId, e.getMessage());
        }
        return InvoiceStatus.FAILED;
    }

    @Override
    public String getInvoiceXml(String invoiceGuid, ProviderConfig config) {
        log.info("MISA: Requesting XML for InvoiceGUID: {}", invoiceGuid);
        try {
            String token = getOrRefreshToken(config);
            MisaApiResponse response = webClient.post()
                    .uri(baseUrl + "/invoice/export-xml")
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + token)
                    .bodyValue(Map.of("InvoiceGUID", invoiceGuid))
                    .retrieve()
                    .bodyToMono(MisaApiResponse.class)
                    .block();

            return (response != null && response.getData() != null) ? response.getData().toString() : null;
        } catch (Exception e) {
            log.error("MISA: XML export failed: {}", e.getMessage());
            return null;
        }
    }

    @Override
    public String authenticate(ProviderConfig config) {
        Map<String, Object> authReq = Map.of(
                "appid", config.getAppId() != null ? config.getAppId() : config.getUsername(),
                "taxcode", config.getUsername(),
                "username", config.getUsername(),
                "password", config.getPassword()
        );
        try {
            Map<?, ?> res = webClient.post()
                    .uri(baseUrl + "/auth/token")
                    .bodyValue(authReq)
                    .retrieve()
                    .bodyToMono(Map.class)
                    .block();

            return (res != null && res.get("Data") != null) ? res.get("Data").toString() : null;
        } catch (Exception e) {
            log.error("MISA: Authentication failed for taxcode {}: {}", config.getUsername(), e.getMessage());
            return null;
        }
    }

    private synchronized String getOrRefreshToken(ProviderConfig config) {
        if (cachedToken != null && tokenExpiry != null && tokenExpiry.isAfter(LocalDateTime.now().plusMinutes(5))) {
            return cachedToken;
        }
        String token = authenticate(config);
        if (token != null) {
            cachedToken = token;
            tokenExpiry = LocalDateTime.now().plusDays(7);
            return token;
        }
        throw new RuntimeException("MISA: Unable to obtain access token");
    }

    @Override public InvoiceResponse cancelInvoice(String no, String r, ProviderConfig c) { return null; }
    @Override public InvoiceResponse replaceInvoice(String o, InvoiceRequest n, ProviderConfig c) { return null; }
    @Override public String getInvoicePdf(String n, ProviderConfig c) { return null; }
    @Override public boolean isAvailable() { return true; }
    @Override public boolean testConnection(ProviderConfig c) { return authenticate(c) != null; }

    /* MISA Specific Data Models */
    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class MisaInvoicePayload {
        private String refId, invSeries, invDate, currencyCode, paymentMethodName, buyerLegalName, buyerTaxCode, buyerAddress, buyerFullName, buyerPhoneNumber, buyerEmail, totalAmountInWords;
        private BigDecimal exchangeRate, totalSaleAmountOC, totalSaleAmount, totalAmountOC, totalAmount, totalVATAmountOC;
        private boolean isInvoiceSummary;
        private List<MisaInvoiceDetail> originalInvoiceDetail;
        private List<MisaTaxRateInfo> taxRateInfo;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class MisaInvoiceDetail {
        private Integer itemType, sortOrder, lineNumber;
        private String itemName, unitName, vatRateName;
        private BigDecimal quantity, unitPrice, amountOC, amount, discountAmountOC, discountAmount, vatAmountOC, vatAmount;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class MisaTaxRateInfo {
        private String vatRateName;
        private BigDecimal amountWithoutVATOC, vatAmountOC;
    }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class MisaApiResponse {
        private Boolean success;
        private String errorCode, descriptionErrorCode;
        private List<Map<String, Object>> publishInvoiceResult;
        private Object data;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/misa/MisaApiMapper.java">
package com.einvoicehub.core.provider.misa;

import com.einvoicehub.core.domain.enums.InvoiceStatus;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;

@Slf4j
@Component
@RequiredArgsConstructor
public class MisaApiMapper {

    public MisaAdapter.MisaInvoicePayload toMisaPayload(InvoiceRequest request) {
        List<MisaAdapter.MisaInvoiceDetail> details = request.getItems().stream()
                .map(this::convertToMisaDetail)
                .toList();

        MisaAdapter.MisaInvoicePayload payload = MisaAdapter.MisaInvoicePayload.builder()
                .refId(UUID.randomUUID().toString())
                .invSeries(getInvSeries(request))
                .invDate(request.getIssueDate() != null ?
                        request.getIssueDate().format(DateTimeFormatter.ISO_DATE) :
                        LocalDateTime.now().format(DateTimeFormatter.ISO_DATE))
                .currencyCode(StringUtils.hasText(getCurrency(request)) ? getCurrency(request) : "VND")
                .exchangeRate(BigDecimal.ONE)
                .paymentMethodName("TM/CK")
                .isInvoiceSummary(false)
                .buyerLegalName(request.getBuyer() != null ? request.getBuyer().getName() : "")
                .buyerTaxCode(request.getBuyer() != null ? request.getBuyer().getTaxCode() : "")
                .buyerAddress(request.getBuyer() != null ? request.getBuyer().getAddress() : "")
                .buyerFullName(request.getBuyer() != null ? request.getBuyer().getName() : "")
                .buyerPhoneNumber(request.getBuyer() != null ? request.getBuyer().getPhone() : "")
                .buyerEmail(request.getBuyer() != null ? request.getBuyer().getEmail() : "")
                .originalInvoiceDetail(details)
                .taxRateInfo(buildTaxRateInfo(details))
                .build();

        calculateTotals(payload);
        return payload;
    }

    private void calculateTotals(MisaAdapter.MisaInvoicePayload payload) {
        BigDecimal totalSaleAmount = BigDecimal.ZERO;
        BigDecimal totalVatAmount = BigDecimal.ZERO;

        for (MisaAdapter.MisaInvoiceDetail detail : payload.getOriginalInvoiceDetail()) {
            totalSaleAmount = totalSaleAmount.add(detail.getAmountOC() != null ? detail.getAmountOC() : BigDecimal.ZERO);
            totalVatAmount = totalVatAmount.add(detail.getVatAmountOC() != null ? detail.getVatAmountOC() : BigDecimal.ZERO);
        }

        BigDecimal totalAmount = totalSaleAmount.add(totalVatAmount);

        payload.setTotalSaleAmountOC(totalSaleAmount.setScale(2, RoundingMode.HALF_UP));
        payload.setTotalSaleAmount(totalSaleAmount.setScale(2, RoundingMode.HALF_UP));
        payload.setTotalAmountOC(totalAmount.setScale(2, RoundingMode.HALF_UP));
        payload.setTotalAmount(totalAmount.setScale(2, RoundingMode.HALF_UP));
        payload.setTotalVATAmountOC(totalVatAmount.setScale(2, RoundingMode.HALF_UP));
        payload.setTotalAmountInWords(convertNumberToWords(totalAmount));
    }

    private MisaAdapter.MisaInvoiceDetail convertToMisaDetail(InvoiceRequest.InvoiceItem item) {
        BigDecimal qty = item.getQuantity() != null ? item.getQuantity() : BigDecimal.ONE;
        BigDecimal price = item.getUnitPrice() != null ? item.getUnitPrice() : BigDecimal.ZERO;
        BigDecimal amount = qty.multiply(price).setScale(2, RoundingMode.HALF_UP);
        BigDecimal taxRate = item.getTaxRate() != null ? item.getTaxRate() : BigDecimal.ZERO;
        BigDecimal vatAmount = amount.multiply(taxRate).divide(BigDecimal.valueOf(100), 2, RoundingMode.HALF_UP);

        return MisaAdapter.MisaInvoiceDetail.builder()
                .itemType(1).sortOrder(1).lineNumber(1)
                .itemName(item.getItemName())
                .unitName(item.getUnitName() != null ? item.getUnitName() : "")
                .quantity(qty.setScale(2, RoundingMode.HALF_UP))
                .unitPrice(price.setScale(2, RoundingMode.HALF_UP))
                .amountOC(amount).amount(amount)
                .vatAmountOC(vatAmount).vatAmount(vatAmount)
                .vatRateName(taxRate.stripTrailingZeros().toPlainString() + "%")
                .discountAmountOC(BigDecimal.ZERO).discountAmount(BigDecimal.ZERO)
                .build();
    }

    private List<MisaAdapter.MisaTaxRateInfo> buildTaxRateInfo(List<MisaAdapter.MisaInvoiceDetail> details) {
        Map<String, MisaAdapter.MisaTaxRateInfo> taxMap = new LinkedHashMap<>();
        for (MisaAdapter.MisaInvoiceDetail detail : details) {
            taxMap.computeIfAbsent(detail.getVatRateName(), k -> MisaAdapter.MisaTaxRateInfo.builder()
                    .vatRateName(k).amountWithoutVATOC(BigDecimal.ZERO).vatAmountOC(BigDecimal.ZERO).build());
            MisaAdapter.MisaTaxRateInfo info = taxMap.get(detail.getVatRateName());
            info.setAmountWithoutVATOC(info.getAmountWithoutVATOC().add(detail.getAmountOC()));
            info.setVatAmountOC(info.getVatAmountOC().add(detail.getVatAmountOC()));
        }
        return new ArrayList<>(taxMap.values());
    }

    /* Vietnamese Number-to-Words for invoice legality */
    public String convertNumberToWords(BigDecimal amount) {
        try {
            long wholePart = amount.longValue();
            if (wholePart == 0) return "Kh√¥ng ƒë·ªìng.";
            return convertWholeNumberToWords(wholePart) + " ƒë·ªìng.";
        } catch (Exception e) { return "Invalid amount"; }
    }

    private String convertWholeNumberToWords(long number) {
        String[] units = {"", "ngh√¨n", "tri·ªáu", "t·ª∑"};
        String result = "";
        int idx = 0;
        while (number > 0) {
            long group = number % 1000;
            if (group > 0) result = convertGroupToWords((int) group) + " " + units[idx] + " " + result;
            number /= 1000;
            idx++;
        }
        return result.trim();
    }

    private String convertGroupToWords(int n) {
        String[] digits = {"kh√¥ng", "m·ªôt", "hai", "ba", "b·ªën", "nƒÉm", "s√°u", "b·∫£y", "t√°m", "ch√≠n"};
        String[] tens = {"", "m∆∞·ªùi", "hai m∆∞∆°i", "ba m∆∞∆°i", "b·ªën m∆∞∆°i", "nƒÉm m∆∞∆°i", "s√°u m∆∞∆°i", "b·∫£y m∆∞∆°i", "t√°m m∆∞∆°i", "ch√≠n m∆∞∆°i"};
        int h = n / 100, r = n % 100;
        String res = (h > 0) ? digits[h] + " trƒÉm " : "";
        if (r > 0) {
            if (r < 10) res += "l·∫ª " + digits[r];
            else if (r < 20) res += "m∆∞·ªùi " + (r % 10 == 5 ? "lƒÉm" : digits[r % 10]);
            else res += tens[r / 10] + (r % 10 == 5 ? " lƒÉm" : (r % 10 > 0 ? " " + digits[r % 10] : ""));
        }
        return res.trim();
    }

    public InvoiceResponse toHubResponse(MisaAdapter.MisaApiResponse misaResponse, String requestId) {
        if (misaResponse == null) return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage("Provider timeout").build();

        boolean isSuccess = Boolean.TRUE.equals(misaResponse.getSuccess());
        InvoiceResponse.InvoiceResponseBuilder builder = InvoiceResponse.builder()
                .clientRequestId(requestId)
                .status(isSuccess ? InvoiceResponse.ResponseStatus.SUCCESS : InvoiceResponse.ResponseStatus.FAILED)
                .errorCode(misaResponse.getErrorCode())
                .errorMessage(misaResponse.getDescriptionErrorCode())
                .responseTime(LocalDateTime.now())
                .rawResponse(misaResponse);

        if (isSuccess && misaResponse.getPublishInvoiceResult() != null && !misaResponse.getPublishInvoiceResult().isEmpty()) {
            Map<String, Object> res = misaResponse.getPublishInvoiceResult().get(0);
            builder.transactionCode((String) res.get("TransactionID"))
                    .invoiceNumber((String) res.get("InvNo"))
                    .symbolCode((String) res.get("InvSeries"))
                    .lookupCode((String) res.get("TransactionID"));
        }
        return builder.build();
    }

    public InvoiceStatus mapMisaStatus(int status) {
        return switch (status) {
            case 1 -> InvoiceStatus.SUCCESS;
            case 2 -> InvoiceStatus.CANCELLED;
            case 3, 7 -> InvoiceStatus.REPLACED;
            default -> InvoiceStatus.FAILED;
        };
    }

    private String getInvSeries(InvoiceRequest r) { return (r.getExtraConfig() != null) ? (String) r.getExtraConfig().getOrDefault("InvSeries", "") : ""; }
    private String getCurrency(InvoiceRequest r) { return (r.getSummary() != null) ? r.getSummary().getCurrencyCode() : "VND"; }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/constant/MobifoneApiEndpoints.java">
package vn.softz.app.einvoicehub.provider.mobifone.constant;

public class MobifoneApiEndpoints {
    
    // Authentication
    public static final String LOGIN = "/api/Account/Login";
    
    // System
    public static final String GET_DATA_REFERENCES = "/api/System/GetDataReferencesByRefId";
    
    // Invoice - Create/Update
    public static final String SAVE_INVOICE = "/api/Invoice68/SaveListHoadon78";
    public static final String SAVE_INVOICE_MTT = "/api/Invoice68/SaveListHoadon78MTT";
    public static final String SAVE_AND_SIGN_INVOICE = "/api/Invoice68/SaveAndSignHoadon78";
    
    // Invoice - Sign
    public static final String SIGN_INVOICE = "/api/Invoice68/SignInvoiceCertFile68";
    public static final String SIGN_INVOICE_HSM = "/api/Invoice68/SignListInvoiceCertFile_HSM";
    public static final String SEND_TO_CQT = "/api/Invoice68/SendInvoiceToCQT68";
    public static final String GET_CERTIFICATES = "/api/Invoice68/GetListCertificatesFile68";
    
    // Invoice - Query
    public static final String GET_INVOICE_BY_ID = "/api/Invoice68/GetById";
    public static final String GET_INVOICE_BY_FKEY = "/api/Invoice68/GetHoadonFkey";
    public static final String GET_INVOICE_PDF = "/api/Invoice68/inHoadon";
    public static final String GET_INVOICE_XML = "/api/Invoice68/ExportXMLHoadon";
    public static final String GET_INVOICE_LIST_BY_DATE = "/api/Invoice68/GetInvoiceFromdateTodate";
    public static final String GET_INVOICE_LIST_BY_TIME_UNIT = "/api/Invoice68/GetInvoiceByTimeAndUnit";
    public static final String GET_INVOICE_IDS_BY_DATE = "/api/Invoice68/GetListInvoiceIdFromdateTodate";
    public static final String GET_INVOICE_HISTORY = "/api/Invoice68/GetHistoryInvoice";
    public static final String GET_PENDING_INVOICES = "/api/Invoice68/GetDataInvoiceListChoKy";
    
    // Invoice - Delete
    public static final String DELETE_UNSIGNED_INVOICE = "/api/Invoice68/hoadonXoaNhieu";
    public static final String CANCEL_NO_CODE_INVOICE = "/api/Invoice68/uploadCanceledInv";
    
    // Error Notification (TBSS)
    public static final String SAVE_ERROR_NOTIFICATION = "/api/Invoice68/huyhoadonSave";
    public static final String DELETE_ERROR_NOTIFICATION = "/api/Invoice68/deleteMau04";
    public static final String SIGN_ERROR_NOTIFICATION = "/api/Invoice/huyhoadonSign";
    public static final String GET_ERROR_NOTIFICATION_PDF = "/api/Invoice68/inMau04";
    public static final String GET_ERROR_NOTIFICATION_XML = "/api/Invoice68/XmlMau0405";
    public static final String SAVE_ERROR_NOTIFICATION_XML = "/api/Invoice68/SaveXmlMau0405";
    
    // Plugin Sign
    public static final String EXPORT_XML_PRETREATMENT = "/api/Invoice68/ExportInvoiceXmlPretreatment";
    public static final String SAVE_XML_PRETREATMENT = "/api/Invoice68/SaveXmlPretreatment";
    
    // Email
    public static final String SEND_EMAIL = "/api/Invoice68/AutoSendInvoiceByEmail";
    
    // Print Multiple
    public static final String PRINT_INVOICES = "/api/Invoice68/InDanhSachHoaDon";
    
    // Reports
    public static final String GET_SALES_REPORT = "/api/Invoice/GetDSHoaDonBangKeBanRa";
    public static final String GET_DETAIL_REPORT = "/api/Invoice/GetDSHoaDonBangKeBanRaChiTiet";
    
    // Response messages
    public static final String GET_RESPONSE_MESSAGE = "/api/Invoice68/GetResponseMessage";
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/constant/MobifoneInvoiceStatus.java">
package vn.softz.app.einvoicehub.provider.mobifone.constant;

public class MobifoneInvoiceStatus {
    
    // Invoice status (tthdon)
    public static final int ORIGINAL = 0;
    public static final int EXPLANATION = 1;
    public static final int REPLACEMENT = 2;
    public static final int CANCELLED = 3;
    public static final int REVIEW = 4;
    public static final int ADJUSTMENT = 5;
    public static final int PENDING_ADJUSTMENT = 7;
    public static final int ADJUSTED = 11;
    public static final int PENDING_CANCEL = 13;
    public static final int PENDING_REPLACEMENT = 15;
    public static final int REPLACED = 17;
    public static final int ADJUSTMENT_INCREASE = 19;
    public static final int ADJUSTMENT_DECREASE = 21;
    public static final int ADJUSTMENT_INFO = 23;
    
    // CQT status (tthai)
    public static final String STATUS_WAITING_SIGN = "Ch·ªù k√Ω";
    public static final String STATUS_SIGNED = "ƒê√£ k√Ω";
    public static final String STATUS_WAITING_CODE = "Ch·ªù c·∫•p m√£";
    public static final String STATUS_INVALID_FORMAT = "TBSS sai ƒë·ªãnh d·∫°ng";
    public static final String STATUS_CODE_DENIED = "CQT Kh√¥ng c·∫•p m√£";
    public static final String STATUS_WAITING_RESPONSE = "Ch·ªù ph·∫£n h·ªìi";
    public static final String STATUS_NOT_ACCEPTED = "CQT kh√¥ng ti·∫øp nh·∫≠n Hƒê";
    public static final String STATUS_ACCEPT_TBSS = "Ch·∫•p nh·∫≠n TBSS";
    public static final String STATUS_SENT = "ƒê√£ g·ª≠i";
    public static final String STATUS_RECEIVED = "CQT ƒë√£ nh·∫≠n";
    public static final String STATUS_CODE_GRANTED = "ƒê√£ c·∫•p m√£";
    public static final String STATUS_REJECT_TBSS = "Kh√¥ng ch·∫•p nh·∫≠n TBSS";
    
    // Item type (kmai)
    public static final int ITEM_GOODS_SERVICE = 1;
    public static final int ITEM_PROMOTION = 2;
    public static final int ITEM_DISCOUNT = 3;
    public static final int ITEM_NOTE = 4;
    public static final int ITEM_SPECIAL = 5;
    
    // Tax rate (tsuat)
    public static final String TAX_RATE_10 = "10";
    public static final String TAX_RATE_8 = "8";
    public static final String TAX_RATE_5 = "5";
    public static final String TAX_RATE_0 = "0";
    public static final String TAX_RATE_NOT_SUBJECT = "-1";
    public static final String TAX_RATE_NOT_DECLARED = "-2";
    
    // Edit mode
    public static final int EDIT_MODE_CREATE = 1;
    public static final int EDIT_MODE_UPDATE = 2;
    public static final int EDIT_MODE_DELETE = 3;
    
    // Type command (type_cmd)
    public static final String TYPE_CMD_WITH_CODE = "200";
    public static final String TYPE_CMD_NO_CODE = "203";
    public static final String TYPE_CMD_MTT = "206";
    
    // Error notification type (tctbao)
    public static final String TBSS_CANCEL = "1";
    public static final String TBSS_REPLACE = "3";
    public static final String TBSS_EXPLANATION = "4";
    public static final String TBSS_ADJUST_INCREASE = "5";
    public static final String TBSS_ADJUST_DECREASE = "6";
    public static final String TBSS_ADJUST_OTHER = "7";
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/mapper/MobifoneDataMapper.java">
package vn.softz.app.einvoicehub.provider.mobifone.mapper;

import org.springframework.stereotype.Component;
import vn.softz.app.einvoicehub.domain.entity.EinvStoreProviderEntity;
import vn.softz.app.einvoicehub.domain.repository.EinvStoreProviderRepository;
import vn.softz.app.einvoicehub.provider.mobifone.constant.MobifoneInvoiceStatus;
import vn.softz.app.einvoicehub.provider.mobifone.model.*;
import vn.softz.app.einvoicehub.provider.model.InvoiceData;
import vn.softz.app.einvoicehub.provider.model.InvoiceDetailData;
import vn.softz.app.einvoicehub.provider.model.InvoiceResult;
import vn.softz.core.common.Common;

import java.math.BigDecimal;
import java.time.Instant;
import java.time.ZoneId;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;

@Component
public class MobifoneDataMapper {
    
    private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd")
            .withZone(ZoneId.systemDefault());
    
    private final EinvStoreProviderRepository storeProviderRepository;
    
    public MobifoneDataMapper(EinvStoreProviderRepository storeProviderRepository) {
        this.storeProviderRepository = storeProviderRepository;
    }

    private EinvStoreProviderEntity getConfig() {
        String storeId = Common.getCurrentUser().map(u -> u.getLocId()).orElse(null);
        return storeProviderRepository.findByStoreId(storeId)
                .orElseThrow(() -> new RuntimeException("Ch∆∞a c·∫•u h√¨nh HƒêƒêT cho c·ª≠a h√†ng n√†y"));
    }
    
    public MobifoneInvoiceRequest toMobifoneInvoiceRequest(InvoiceData invoiceData) {
        return MobifoneInvoiceRequest.builder()
                .editmode(MobifoneInvoiceStatus.EDIT_MODE_CREATE)
                .taxCode(getConfig().getTaxCode())
                .data(List.of(toMobifoneInvoiceData(invoiceData)))
                .build();
    }
    
    public MobifoneInvoiceData toMobifoneInvoiceData(InvoiceData invoiceData) {
        var config = getConfig();
        
        return MobifoneInvoiceData.builder()
                .cctbaoId(invoiceData.getProviderSerialId()) 
                .nlap(formatDate(invoiceData.getInvoiceDate()))
                .dvtte(invoiceData.getCurrencyCode() != null ? invoiceData.getCurrencyCode() : "VND")
                .tgia(invoiceData.getExchangeRate() != null ? invoiceData.getExchangeRate() : BigDecimal.ONE)
                .htttoan(truncate(getPaymentMethodName(invoiceData.getPayMethodId()), 50))
                .mnmua(truncate(invoiceData.getPartnerInvoiceStringId(), 30))
                .mst(hasText(invoiceData.getBuyerTaxCode()) ? truncate(invoiceData.getBuyerTaxCode(), 20) : null)
                .tnmua(truncate(invoiceData.getBuyerName(), 200))
                .ten(truncate(invoiceData.getBuyerUnitName(), 200))
                .dchi(truncate(invoiceData.getBuyerAddress(), 255))
                .email(truncate(invoiceData.getReceiverEmail(), 100))
                .sdtnmua(truncate(invoiceData.getReceiverMobile(), 20))
                .stknmua(truncate(invoiceData.getBuyerBankAccount(), 50))
                .tgtcthue(n(invoiceData.getGrossAmount()))
                .tgtthue(n(invoiceData.getTaxAmount()))
                .tgtttbso(n(invoiceData.getTotalAmount()))
                .tgtttbsoLast(n(invoiceData.getTotalAmount()))
                .sdhang(truncate(
                        invoiceData.getBillCode() != null ? invoiceData.getBillCode() : 
                        (invoiceData.getPartnerInvoiceId() != null ? invoiceData.getPartnerInvoiceId() : ""), 
                        30))
                .tthdon(MobifoneInvoiceStatus.ORIGINAL)
                .details(List.of(toMobifoneDetailWrapper(invoiceData.getDetails())))
                .build();
    }
    
    public InvoiceResult toInvoiceResult(MobifoneInvoiceResponse response) {
        if (response == null) {
            return InvoiceResult.error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ MobiFone");
        }
        
        if (!response.isSuccess()) {
            return InvoiceResult.builder()
                    .success(false)
                    .message(response.getMessage() != null ? response.getMessage() : "L·ªói t·ª´ MobiFone")
                    .object(response)
                    .build();
        }
        
        InvoiceResult.InvoiceResultBuilder builder = InvoiceResult.builder()
                .success(true)
                .message("T·∫°o h√≥a ƒë∆°n th√†nh c√¥ng")
                .object(response);
        
        if (response.getData() != null) {
            var data = response.getData();

            builder.invoiceId(data.getHdonId() != null ? data.getHdonId() : data.getId())
                   .invoiceForm(extractInvoiceForm(data.getKhieu()))
                   .invoiceSerial(extractInvoiceSerial(data.getKhieu()))
                   .invoiceNo(data.getShdon())
                   .invoiceReferenceCode(data.getSbmat())
                   .taxAuthorityCode(data.getMccqthue())
                   .statusMessage(data.getTthai());
        }
        
        if (response.getLstHdonIdSuccess() != null && !response.getLstHdonIdSuccess().isEmpty()) {
            builder.invoiceId(response.getLstHdonIdSuccess().get(0));
        }
        if (response.getTthai() != null) {
            builder.statusMessage(response.getTthai());
        }
        
        return builder.build();
    }
    
    public InvoiceResult toInvoiceResultFromList(List<MobifoneInvoiceResponse> responses) {
        if (responses == null || responses.isEmpty()) {
            return InvoiceResult.error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi t·ª´ MobiFone");
        }
        return toInvoiceResult(responses.get(0));
    }
    
    private MobifoneInvoiceDetailWrapper toMobifoneDetailWrapper(List<InvoiceDetailData> details) {
        List<MobifoneInvoiceDetail> mobifoneDetails = new ArrayList<>();
        
        if (details != null) {
            for (int i = 0; i < details.size(); i++) {
                mobifoneDetails.add(toMobifoneInvoiceDetail(details.get(i), i + 1));
            }
        }
        
        return MobifoneInvoiceDetailWrapper.builder()
                .data(mobifoneDetails)
                .build();
    }
    
    private MobifoneInvoiceDetail toMobifoneInvoiceDetail(InvoiceDetailData detail, int lineNo) {
        return MobifoneInvoiceDetail.builder()
                .stt(lineNo)
                .ma(truncate(detail.getItemCode(), 30))
                .ten(truncate(detail.getItemName(), 255))
                .dvtinh(truncate(detail.getUnitName(), 20))
                .sluong(n(detail.getQuantity()))
                .dgia(n(detail.getPrice()))
                .thtien(n(detail.getAmount()))
                .tlckhau(n(detail.getDiscountRate()))
                .stckhau(n(detail.getDiscountAmount()))
                .tsuat(getTaxRateString(detail.getTaxRate()))
                .tthue(n(detail.getTaxAmount()))
                .tgtien(n(detail.getAmount()).add(n(detail.getTaxAmount())))
                .kmai(Boolean.TRUE.equals(detail.getIsDiscount()) 
                        ? MobifoneInvoiceStatus.ITEM_PROMOTION 
                        : MobifoneInvoiceStatus.ITEM_GOODS_SERVICE)
                .build();
    }
    
    private String formatDate(Instant instant) {
        return DATE_FORMATTER.format(instant != null ? instant : Instant.now());
    }
    
    private String getPaymentMethodName(Integer payMethodId) {
        if (payMethodId == null) return "Ti·ªÅn m·∫∑t/Chuy·ªÉn kho·∫£n";
        return switch (payMethodId) {
            case 1 -> "Ti·ªÅn m·∫∑t";
            case 2 -> "Chuy·ªÉn kho·∫£n";
            default -> "Ti·ªÅn m·∫∑t/Chuy·ªÉn kho·∫£n";
        };
    }
    
    private String getTaxRateString(BigDecimal taxRate) {
        if (taxRate == null) return "10";
        return String.valueOf(taxRate.intValue());
    }
    
    private BigDecimal n(BigDecimal value) {
        return value != null ? value : BigDecimal.ZERO;
    }
    
    private String truncate(String value, int maxLength) {
        if (value == null) return null;
        return value.length() > maxLength ? value.substring(0, maxLength) : value;
    }
    
    private boolean hasText(String value) {
        return value != null && !value.trim().isEmpty();
    }

    private String extractInvoiceForm(String khieu) {
        return (khieu != null && khieu.length() > 1) ? khieu.substring(0, 1) : null;
    }

    private String extractInvoiceSerial(String khieu) {
        return (khieu != null && khieu.length() > 1) ? khieu.substring(1) : khieu;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/model/MobifoneCancelInvoiceRequest.java">
package vn.softz.app.einvoicehub.provider.mobifone.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class MobifoneCancelInvoiceRequest {
    
    @JsonProperty("editmode")
    @Builder.Default
    private Integer editmode = 0;
    
    @JsonProperty("mst")
    private String mst;
    
    @JsonProperty("hdon_id")
    private String hdonId;
    
    @JsonProperty("tctbao")
    @Builder.Default
    private String tctbao = "1";
    
    @JsonProperty("ldo")
    private String ldo;
    
    @JsonProperty("khieu")
    private String khieu;
    
    @JsonProperty("shdon")
    private String shdon;
    
    @JsonProperty("nlap")
    private String nlap;
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/model/MobifoneInvoiceData.java">
package vn.softz.app.einvoicehub.provider.mobifone.model;

import com.fasterxml.jackson.annotation.JsonInclude;
import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.math.BigDecimal;
import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class MobifoneInvoiceData {
    
    @JsonProperty("cctbao_id")
    private String cctbaoId;
    
    @JsonProperty("nlap")
    private String nlap;
    
    @JsonProperty("dvtte")
    @Builder.Default
    private String dvtte = "VND";
    
    @JsonProperty("tgia")
    @Builder.Default
    private BigDecimal tgia = BigDecimal.ONE;
    
    @JsonProperty("htttoan")
    private String htttoan;
    
    @JsonProperty("mdvi")
    @JsonInclude(JsonInclude.Include.NON_EMPTY)
    private String mdvi;
    
    @JsonProperty("is_hdcma")
    @Builder.Default
    private Integer isHdcma = 1;
    
    // Buyer
    @JsonProperty("mnmua")
    private String mnmua;
    
    @JsonProperty("mst")
    private String mst;
    
    @JsonProperty("tnmua")
    private String tnmua;
    
    @JsonProperty("ten")
    private String ten;
    
    @JsonProperty("dchi")
    private String dchi;
    
    @JsonProperty("email")
    private String email;
    
    @JsonProperty("sdtnmua")
    private String sdtnmua;
    
    @JsonProperty("stknmua")
    private String stknmua;
    
    @JsonProperty("tnhmua")
    private String tnhmua;
    
    @JsonProperty("cmndmua")
    private String cmndmua;
    
    // Seller
    @JsonProperty("sdtnban")
    private String sdtnban;
    
    @JsonProperty("stknban")
    private String stknban;
    
    @JsonProperty("tnhban")
    private String tnhban;
    
    // Amounts
    @JsonProperty("tgtcthue")
    private BigDecimal tgtcthue;
    
    @JsonProperty("tgtthue")
    private BigDecimal tgtthue;
    
    @JsonProperty("tgtttbso")
    private BigDecimal tgtttbso;
    
    @JsonProperty("tgtttbso_last")
    private BigDecimal tgtttbsoLast;
    
    @JsonProperty("TGTKCThue")
    private BigDecimal tgtkcthue;
    
    @JsonProperty("tkcktmn")
    private BigDecimal tkcktmn;
    
    @JsonProperty("TGTKhac")
    private BigDecimal tgtkhac;
    
    @JsonProperty("tgtphi")
    private BigDecimal tgtphi;
    
    // Status & Result
    @JsonProperty("hdon_id")
    @JsonInclude(JsonInclude.Include.NON_EMPTY)
    private String hdonId;
    
    @JsonProperty("khieu")
    private String khieu;
    
    @JsonProperty("shdon")
    private String shdon;
    
    @JsonProperty("sdhang")
    private String sdhang;
    
    @JsonProperty("tthdon")
    private Integer tthdon;
    
    @JsonProperty("tthai")
    private String tthai;
    
    @JsonProperty("sbmat")
    private String sbmat;
    
    @JsonProperty("mccqthue")
    private String mccqthue;
    
    // Replacement/Adjustment
    @JsonProperty("hdon_id_old")
    @JsonInclude(JsonInclude.Include.NON_EMPTY)
    private String hdonIdOld;
    
    @JsonProperty("lhdclquan")
    private Integer lhdclquan;
    
    @JsonProperty("khmshdclquan")
    private String khmshdclquan;
    
    @JsonProperty("khhdclquan")
    private String khhdclquan;
    
    @JsonProperty("shdclquan")
    private String shdclquan;
    
    @JsonProperty("nlhdclquan")
    private String nlhdclquan;
    
    // Store
    @JsonProperty("tchang")
    private String tchang;
    
    @JsonProperty("mchang")
    private String mchang;
    
    // Details
    @JsonProperty("details")
    private List<MobifoneInvoiceDetailWrapper> details;
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/model/MobifoneInvoiceDetail.java">
package vn.softz.app.einvoicehub.provider.mobifone.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.math.BigDecimal;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class MobifoneInvoiceDetail {
    
    @JsonProperty("stt")
    private Integer stt;
    
    @JsonProperty("ma")
    private String ma;
    
    @JsonProperty("ten")
    private String ten;
    
    @JsonProperty("mdvtinh")
    private String mdvtinh;
    
    @JsonProperty("dvtinh")
    private String dvtinh;
    
    @JsonProperty("sluong")
    private BigDecimal sluong;
    
    @JsonProperty("dgia")
    private BigDecimal dgia;
    
    @JsonProperty("thtien")
    private BigDecimal thtien;
    
    @JsonProperty("tlckhau")
    private BigDecimal tlckhau;
    
    @JsonProperty("stckhau")
    private BigDecimal stckhau;
    
    @JsonProperty("tsuat")
    private String tsuat;
    
    @JsonProperty("tthue")
    private BigDecimal tthue;
    
    @JsonProperty("tgtien")
    private BigDecimal tgtien;
    
    @JsonProperty("kmai")
    private Integer kmai;
    
    @JsonProperty("lhhdthu")
    private Integer lhhdthu;
    
    @JsonProperty("skhung")
    private String skhung;
    
    @JsonProperty("smay")
    private String smay;
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/model/MobifoneInvoiceDetailWrapper.java">
package vn.softz.app.einvoicehub.provider.mobifone.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class MobifoneInvoiceDetailWrapper {
    
    @JsonProperty("data")
    private List<MobifoneInvoiceDetail> data;
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/model/MobifoneInvoiceRequest.java">
package vn.softz.app.einvoicehub.provider.mobifone.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class MobifoneInvoiceRequest {
    
    @JsonProperty("editmode")
    @Builder.Default
    private Integer editmode = 1;
    
    @JsonProperty("tax_code")
    private String taxCode;
    
    @JsonProperty("data")
    private List<MobifoneInvoiceData> data;
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/model/MobifoneInvoiceResponse.java">
package vn.softz.app.einvoicehub.provider.mobifone.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.List;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class MobifoneInvoiceResponse {
    
    @JsonProperty("data")
    private MobifoneInvoiceResponseData data;
    
    @JsonProperty("ok")
    private String ok;
    
    @JsonProperty("tthai")
    private String tthai;
    
    @JsonProperty("trang_thai")
    private String trangThai;
    
    @JsonProperty("lst_hdon_id_success")
    private List<String> lstHdonIdSuccess;
    
    @JsonProperty("message")
    private String message;
    
    @JsonProperty("error_code")
    private String errorCode;
    
    @JsonProperty("error")
    private String error;
    
    public boolean isSuccess() {
        if (error != null && !error.isEmpty()) {
            return false;
        }
        return "true".equalsIgnoreCase(ok) || (tthai != null && !tthai.isEmpty()) || data != null;
    }
    
    public String getErrorMessage() {
        if (error != null && !error.isEmpty()) return error;
        if (message != null && !message.isEmpty()) return message;
        return null;
    }
    
    @Data
    @Builder
    @NoArgsConstructor
    @AllArgsConstructor
    public static class MobifoneInvoiceResponseData {
        
        @JsonProperty("id")
        private String id;
        
        @JsonProperty("hdon_id")
        private String hdonId;
        
        @JsonProperty("tthai")
        private String tthai;
        
        @JsonProperty("tthdon")
        private Integer tthdon;
        
        @JsonProperty("khieu")
        private String khieu;
        
        @JsonProperty("shdon")
        private String shdon;
        
        @JsonProperty("sbmat")
        private String sbmat;
        
        @JsonProperty("mccqthue")
        private String mccqthue;
        
        @JsonProperty("tgtttbchu")
        private String tgtttbchu;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/model/MobifoneLoginRequest.java">
package vn.softz.app.einvoicehub.provider.mobifone.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class MobifoneLoginRequest {
    
    @JsonProperty("username")
    private String username;
    
    @JsonProperty("password")
    private String password;
    
    @JsonProperty("tax_code")
    private String taxCode;
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/model/MobifoneLoginResponse.java">
package vn.softz.app.einvoicehub.provider.mobifone.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class MobifoneLoginResponse {
    
    @JsonProperty("isWeakPass")
    private Boolean isWeakPass;
    
    @JsonProperty("token")
    private String token;
    
    @JsonProperty("refresh_token")
    private String refreshToken;
    
    @JsonProperty("ma_dvcs")
    private String maDvcs;
    
    @JsonProperty("wb_user_id")
    private String wbUserId;
    
    @JsonProperty("noti_sso")
    private String notiSso;
    
    @JsonProperty("notes_sso")
    private String notesSso;
    
    @JsonProperty("notify")
    private String notify;
    
    @JsonProperty("is_link_sso")
    private Boolean isLinkSso;
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/MobifoneEInvoiceProvider.java">
package vn.softz.app.einvoicehub.provider.mobifone;

import com.fasterxml.jackson.core.type.TypeReference;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;
import vn.softz.app.einvoicehub.domain.entity.EinvStoreProviderEntity;
import vn.softz.app.einvoicehub.domain.repository.EinvStoreProviderRepository;
import vn.softz.app.einvoicehub.provider.EInvoiceProvider;
import vn.softz.app.einvoicehub.provider.mobifone.constant.MobifoneApiEndpoints;
import vn.softz.app.einvoicehub.provider.mobifone.constant.MobifoneInvoiceStatus;
import vn.softz.app.einvoicehub.provider.mobifone.mapper.MobifoneDataMapper;
import vn.softz.app.einvoicehub.provider.mobifone.model.*;
import vn.softz.app.einvoicehub.provider.model.InvoiceData;
import vn.softz.app.einvoicehub.provider.model.InvoiceResult;
import vn.softz.core.common.Common;

import java.util.Base64;
import java.util.List;
import java.util.Map;

@Component
@Slf4j
@RequiredArgsConstructor
public class MobifoneEInvoiceProvider implements EInvoiceProvider {
    
    private final MobifoneHttpClient httpClient;
    private final MobifoneDataMapper dataMapper;
    private final EinvStoreProviderRepository storeProviderRepository;

    private EinvStoreProviderEntity getConfig() {
        String storeId = Common.getCurrentUser().map(u -> u.getLocId()).orElse(null);
        return storeProviderRepository.findByStoreId(storeId)
                .orElseThrow(() -> new RuntimeException("Ch∆∞a c·∫•u h√¨nh HƒêƒêT cho c·ª≠a h√†ng n√†y"));
    }
    
    @Override
    public String getProviderType() {
        return "MOBI";
    }
    
    @Override
    public InvoiceResult createInvoice(int commandType, InvoiceData invoiceData) {
        try {
            log.info("MobiFone createInvoice - partnerInvoiceId: {}", invoiceData.getPartnerInvoiceId());
            
            MobifoneInvoiceRequest request = dataMapper.toMobifoneInvoiceRequest(invoiceData);
            
            List<MobifoneInvoiceResponse> responses = httpClient.postForList(
                    MobifoneApiEndpoints.SAVE_INVOICE,
                    request,
                    new TypeReference<>() {}
            );
            
            InvoiceResult result = dataMapper.toInvoiceResultFromList(responses);
            
            if (result.isSuccess()) {
                log.info("MobiFone createInvoice success - hdon_id: {}, khieu: {}, shdon: {}", 
                        result.getInvoiceId(), result.getInvoiceSerial(), result.getInvoiceNo());
            } else {
                log.error("MobiFone createInvoice failed: {}", result.getMessage());
            }
            
            return result;
            
        } catch (Exception e) {
            log.error("MobiFone createInvoice error", e);
            return InvoiceResult.error("L·ªói t·∫°o h√≥a ƒë∆°n MobiFone: " + e.getMessage());
        }
    }
    
    @Override
    public InvoiceResult signInvoiceByHsm(String invoiceGuid) {
        try {
            log.info("MobiFone signInvoiceByHsm - invoiceId: {}", invoiceGuid);
            
            var config = getConfig();
            
            Map<String, Object> signRequest = Map.of(
                    "data", List.of(Map.of(
                            "branch_code", httpClient.getMaDvcs(),
                            "username", config.getPartnerUsr(),
                            "lsthdon_id", List.of(invoiceGuid),
                            "cer_serial", "",
                            "type_cmd", MobifoneInvoiceStatus.TYPE_CMD_WITH_CODE,
                            "is_api", "1"
                    ))
            );
            
            MobifoneInvoiceResponse response = httpClient.post(
                    MobifoneApiEndpoints.SIGN_INVOICE,
                    signRequest,
                    MobifoneInvoiceResponse.class
            );
            
            InvoiceResult result = dataMapper.toInvoiceResult(response);
            
            if (result.isSuccess()) {
                log.info("MobiFone signInvoiceByHsm success - status: {}", response.getTthai());
            } else {
                log.error("MobiFone signInvoiceByHsm failed: {}", result.getMessage());
            }
            
            return result;
            
        } catch (Exception e) {
            log.error("MobiFone signInvoiceByHsm error", e);
            return InvoiceResult.error("L·ªói k√Ω h√≥a ƒë∆°n MobiFone: " + e.getMessage());
        }
    }
    
    @Override
    public InvoiceResult getInvoiceData(String invoiceGuid) {
        try {
            log.info("MobiFone getInvoiceData - invoiceId: {}", invoiceGuid);
            
            Object response = httpClient.get(
                    MobifoneApiEndpoints.GET_INVOICE_BY_ID + "?id=" + invoiceGuid, 
                    Object.class
            );
            
            return InvoiceResult.builder()
                    .success(true)
                    .message("L·∫•y th√¥ng tin h√≥a ƒë∆°n th√†nh c√¥ng")
                    .object(response)
                    .build();
            
        } catch (Exception e) {
            log.error("MobiFone getInvoiceData error", e);
            return InvoiceResult.error("L·ªói l·∫•y th√¥ng tin h√≥a ƒë∆°n: " + e.getMessage());
        }
    }
    
    @Override
    public Object getInvoiceStatus(String invoiceGuid) {
        try {
            log.info("MobiFone getInvoiceStatus - invoiceId: {}", invoiceGuid);
            return httpClient.get(MobifoneApiEndpoints.GET_INVOICE_BY_ID + "?id=" + invoiceGuid, Object.class);
        } catch (Exception e) {
            log.error("MobiFone getInvoiceStatus error", e);
            throw new RuntimeException("L·ªói l·∫•y tr·∫°ng th√°i h√≥a ƒë∆°n: " + e.getMessage());
        }
    }
    
    @Override
    public String getInvoicePdf(String docId) {
        try {
            log.info("MobiFone getInvoicePdf - docId: {}", docId);
            
            String endpoint = MobifoneApiEndpoints.GET_INVOICE_PDF + "?id=" + docId + "&type=PDF&inchuyendoi=false";
            byte[] pdfBytes = httpClient.getBytes(endpoint);
            
            return Base64.getEncoder().encodeToString(pdfBytes);
            
        } catch (Exception e) {
            log.error("MobiFone getInvoicePdf error", e);
            throw new RuntimeException("L·ªói l·∫•y PDF h√≥a ƒë∆°n: " + e.getMessage());
        }
    }
    
    @Override
    public String getInvoiceXml(String docId) {
        try {
            log.info("MobiFone getInvoiceXml - docId: {}", docId);
            return httpClient.getString(MobifoneApiEndpoints.GET_INVOICE_XML + "?id=" + docId);
        } catch (Exception e) {
            log.error("MobiFone getInvoiceXml error", e);
            throw new RuntimeException("L·ªói l·∫•y XML h√≥a ƒë∆°n: " + e.getMessage());
        }
    }
    
    @Override
    public InvoiceResult cancelInvoiceByGuid(String invoiceGuid, String reason) {
        try {
            log.info("MobiFone cancelInvoice - invoiceId: {}, reason: {}", invoiceGuid, reason);
            
            MobifoneCancelInvoiceRequest cancelRequest = MobifoneCancelInvoiceRequest.builder()
                    .editmode(MobifoneInvoiceStatus.EDIT_MODE_CREATE)
                    .mst(getConfig().getTaxCode())
                    .hdonId(invoiceGuid)
                    .tctbao(MobifoneInvoiceStatus.TBSS_CANCEL)
                    .ldo(reason)
                    .build();
            
            Object response = httpClient.post(MobifoneApiEndpoints.SAVE_ERROR_NOTIFICATION, cancelRequest, Object.class);
            
            log.info("MobiFone cancelInvoice response: {}", response);
            
            return InvoiceResult.builder()
                    .success(true)
                    .message("H·ªßy h√≥a ƒë∆°n th√†nh c√¥ng")
                    .object(response)
                    .build();
            
        } catch (Exception e) {
            log.error("MobiFone cancelInvoice error", e);
            return InvoiceResult.error("L·ªói h·ªßy h√≥a ƒë∆°n: " + e.getMessage());
        }
    }
    
    @Override
    public InvoiceResult deleteInvoiceByGuid(String invoiceGuid) {
        try {
            log.info("MobiFone deleteInvoice - invoiceId: {}", invoiceGuid);
            
            Map<String, Object> deleteRequest = Map.of(
                    "editmode", MobifoneInvoiceStatus.EDIT_MODE_DELETE,
                    "data", List.of(Map.of("hdon_id", invoiceGuid))
            );
            
            Object response = httpClient.post(MobifoneApiEndpoints.DELETE_UNSIGNED_INVOICE, deleteRequest, Object.class);
            
            return InvoiceResult.builder()
                    .success(true)
                    .message("X√≥a h√≥a ƒë∆°n th√†nh c√¥ng")
                    .object(response)
                    .build();
            
        } catch (Exception e) {
            log.error("MobiFone deleteInvoice error", e);
            return InvoiceResult.error("L·ªói x√≥a h√≥a ƒë∆°n: " + e.getMessage());
        }
    }
    
    @Override
    public InvoiceResult createReplacementInvoice(InvoiceData invoiceData) {
        try {
            log.info("MobiFone createReplacementInvoice - originalInvoiceId: {}", invoiceData.getOriginalInvoiceIdentify());
            
            MobifoneInvoiceRequest request = dataMapper.toMobifoneInvoiceRequest(invoiceData);
            
            if (!request.getData().isEmpty()) {
                MobifoneInvoiceData data = request.getData().get(0);
                data.setHdonIdOld(invoiceData.getOriginalInvoiceIdentify());
                data.setTthdon(MobifoneInvoiceStatus.REPLACEMENT);
                data.setLhdclquan(1);
            }
            
            List<MobifoneInvoiceResponse> responses = httpClient.postForList(
                    MobifoneApiEndpoints.SAVE_INVOICE,
                    request,
                    new TypeReference<>() {}
            );
            
            return dataMapper.toInvoiceResultFromList(responses);
            
        } catch (Exception e) {
            log.error("MobiFone createReplacementInvoice error", e);
            return InvoiceResult.error("L·ªói t·∫°o h√≥a ƒë∆°n thay th·∫ø: " + e.getMessage());
        }
    }
    
    @Override
    public InvoiceResult createAdjustmentInvoice(InvoiceData invoiceData) {
        try {
            log.info("MobiFone createAdjustmentInvoice - originalInvoiceId: {}", invoiceData.getOriginalInvoiceIdentify());
            
            MobifoneInvoiceRequest request = dataMapper.toMobifoneInvoiceRequest(invoiceData);
            
            if (!request.getData().isEmpty()) {
                MobifoneInvoiceData data = request.getData().get(0);
                data.setHdonIdOld(invoiceData.getOriginalInvoiceIdentify());
                data.setLhdclquan(1);
                
                Integer adjustType = invoiceData.getTypeCreateInvoice();
                data.setTthdon(adjustType != null ? switch (adjustType) {
                    case 3 -> MobifoneInvoiceStatus.ADJUSTMENT_INCREASE;
                    case 4 -> MobifoneInvoiceStatus.ADJUSTMENT_DECREASE;
                    case 2 -> MobifoneInvoiceStatus.ADJUSTMENT_INFO;
                    default -> MobifoneInvoiceStatus.ADJUSTMENT;
                } : MobifoneInvoiceStatus.ADJUSTMENT);
            }
            
            List<MobifoneInvoiceResponse> responses = httpClient.postForList(
                    MobifoneApiEndpoints.SAVE_INVOICE,
                    request,
                    new TypeReference<>() {}
            );
            
            return dataMapper.toInvoiceResultFromList(responses);
            
        } catch (Exception e) {
            log.error("MobiFone createAdjustmentInvoice error", e);
            return InvoiceResult.error("L·ªói t·∫°o h√≥a ƒë∆°n ƒëi·ªÅu ch·ªânh: " + e.getMessage());
        }
    }
    
    @Override
    public Object lookupCompany(String taxCode) {
        log.warn("MobiFone lookupCompany not implemented - taxCode: {}", taxCode);
        return Map.of("success", false, "message", "Ch·ª©c nƒÉng tra c·ª©u doanh nghi·ªáp kh√¥ng kh·∫£ d·ª•ng v·ªõi MobiFone");
    }
    
    @Override
    public String getInvoiceLink(String partnerInvoiceId) {
        throw new UnsupportedOperationException("MobiFone kh√¥ng h·ªó tr·ª£ l·∫•y link, s·ª≠ d·ª•ng getInvoicePdf thay th·∫ø");
    }
    
    @Override
    public InvoiceResult updateInvoiceByGuid(String invoiceGuid, InvoiceData invoiceData) {
        throw new UnsupportedOperationException("Ch∆∞a implement");
    }
    
    @Override
    public InvoiceResult updateInvoiceByPartnerId(String partnerInvoiceId, InvoiceData invoiceData) {
        throw new UnsupportedOperationException("Ch∆∞a implement");
    }
    
    @Override
    public InvoiceResult cancelInvoiceByPartnerId(String partnerInvoiceId, String reason) {
        throw new UnsupportedOperationException("Ch∆∞a implement");
    }
    
    @Override
    public InvoiceResult deleteInvoiceByPartnerId(String partnerInvoiceId) {
        throw new UnsupportedOperationException("Ch∆∞a implement");
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/mobifone/MobifoneHttpClient.java">
package vn.softz.app.einvoicehub.provider.mobifone;

import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.*;
import org.springframework.stereotype.Component;
import org.springframework.web.client.HttpStatusCodeException;
import org.springframework.web.client.RestTemplate;
import vn.softz.app.einvoicehub.domain.entity.EinvProviderEntity;
import vn.softz.app.einvoicehub.domain.entity.EinvStoreProviderEntity;
import vn.softz.app.einvoicehub.domain.repository.EinvProviderRepository;
import vn.softz.app.einvoicehub.domain.repository.EinvStoreProviderRepository;
import vn.softz.app.einvoicehub.provider.mobifone.constant.MobifoneApiEndpoints;
import vn.softz.app.einvoicehub.provider.mobifone.model.MobifoneLoginRequest;
import vn.softz.app.einvoicehub.provider.mobifone.model.MobifoneLoginResponse;
import vn.softz.core.common.Common;

import java.time.Instant;
import java.util.List;
import java.util.Map;

@Component
@Slf4j
public class MobifoneHttpClient {
    
    private static final long TOKEN_VALIDITY_SECONDS = 3600;
    private static final String MOBI_PROVIDER_ID = "MOBI";
    private static final String DEFAULT_BASE_URL = "http://mobiinvoice.vn:9000";
    
    private final EinvStoreProviderRepository storeProviderRepository;
    private final EinvProviderRepository providerRepository;
    private final RestTemplate restTemplate;
    private final ObjectMapper objectMapper;
    
    private String cachedToken;
    private String cachedMaDvcs;
    private Instant tokenExpiry;
    
    public MobifoneHttpClient(EinvStoreProviderRepository storeProviderRepository, EinvProviderRepository providerRepository) {
        this.storeProviderRepository = storeProviderRepository;
        this.providerRepository = providerRepository;
        this.restTemplate = new RestTemplate();
        this.objectMapper = new ObjectMapper()
                .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);
    }

    private String getBaseUrl() {
        return providerRepository.findById(MOBI_PROVIDER_ID)
                .map(EinvProviderEntity::getIntegrationUrl)
                .orElse(DEFAULT_BASE_URL);
    }

    private EinvStoreProviderEntity getConfig() {
        String storeId = Common.getCurrentUser().map(u -> u.getLocId()).orElse(null);
        return storeProviderRepository.findByStoreId(storeId)
                .orElseThrow(() -> new RuntimeException("Ch∆∞a c·∫•u h√¨nh HƒêƒêT cho c·ª≠a h√†ng n√†y"));
    }
    
    public MobifoneLoginResponse login() {
        try {
            var config = getConfig();
            String url = getBaseUrl() + MobifoneApiEndpoints.LOGIN;
            
            MobifoneLoginRequest request = MobifoneLoginRequest.builder()
                    .username(config.getPartnerUsr())
                    .password(config.getPartnerPwd())
                    .taxCode(config.getTaxCode())
                    .build();
            
            HttpEntity<MobifoneLoginRequest> entity = new HttpEntity<>(request, createJsonHeaders());
            
            log.info("MobiFone login - URL: {}, TaxCode: {}", url, config.getTaxCode());
            
            ResponseEntity<String> response = restTemplate.exchange(url, HttpMethod.POST, entity, String.class);
            MobifoneLoginResponse loginResponse = objectMapper.readValue(response.getBody(), MobifoneLoginResponse.class);
            
            this.cachedToken = loginResponse.getToken();
            this.cachedMaDvcs = loginResponse.getMaDvcs();
            this.tokenExpiry = Instant.now().plusSeconds(TOKEN_VALIDITY_SECONDS);
            
            log.info("MobiFone login successful - ma_dvcs: {}", loginResponse.getMaDvcs());
            return loginResponse;
            
        } catch (HttpStatusCodeException e) {
            log.error("MobiFone login failed - Status: {}, Body: {}", e.getStatusCode(), e.getResponseBodyAsString());
            throw new RuntimeException("Login th·∫•t b·∫°i: " + e.getResponseBodyAsString());
        } catch (Exception e) {
            log.error("MobiFone login error", e);
            throw new RuntimeException("L·ªói k·∫øt n·ªëi MobiFone: " + e.getMessage());
        }
    }

    public MobifoneLoginResponse loginWithCredentials(String username, String password, String taxCode) {
        try {
            String url = getBaseUrl() + MobifoneApiEndpoints.LOGIN;
            
            MobifoneLoginRequest request = MobifoneLoginRequest.builder()
                    .username(username)
                    .password(password)
                    .taxCode(taxCode)
                    .build();
            
            HttpEntity<MobifoneLoginRequest> entity = new HttpEntity<>(request, createJsonHeaders());
            
            log.info("MobiFone loginWithCredentials - URL: {}, Username: {}", url, username);
            
            ResponseEntity<String> response = restTemplate.exchange(url, HttpMethod.POST, entity, String.class);
            return objectMapper.readValue(response.getBody(), MobifoneLoginResponse.class);
            
        } catch (HttpStatusCodeException e) {
            log.error("MobiFone login failed - Status: {}, Body: {}", e.getStatusCode(), e.getResponseBodyAsString());
            throw new RuntimeException("Login th·∫•t b·∫°i: " + e.getResponseBodyAsString());
        } catch (Exception e) {
            log.error("MobiFone login error", e);
            throw new RuntimeException("L·ªói k·∫øt n·ªëi MobiFone: " + e.getMessage());
        }
    }
    
    @SuppressWarnings("unchecked")
    public Object loginRaw() {
        try {
            var config = getConfig();
            String url = getBaseUrl() + MobifoneApiEndpoints.LOGIN;
            
            MobifoneLoginRequest request = MobifoneLoginRequest.builder()
                    .username(config.getPartnerUsr())
                    .password(config.getPartnerPwd())
                    .taxCode(config.getTaxCode())
                    .build();
            
            HttpEntity<MobifoneLoginRequest> entity = new HttpEntity<>(request, createJsonHeaders());
            
            log.info("MobiFone loginRaw - URL: {}, TaxCode: {}", url, config.getTaxCode());
            
            ResponseEntity<String> response = restTemplate.exchange(url, HttpMethod.POST, entity, String.class);
            Object rawResponse = objectMapper.readValue(response.getBody(), Object.class);
            
            if (rawResponse instanceof Map) {
                Map<String, Object> map = (Map<String, Object>) rawResponse;
                if (map.containsKey("token")) {
                    this.cachedToken = (String) map.get("token");
                    this.cachedMaDvcs = (String) map.get("ma_dvcs");
                    this.tokenExpiry = Instant.now().plusSeconds(TOKEN_VALIDITY_SECONDS);
                    log.info("MobiFone loginRaw successful - ma_dvcs: {}", this.cachedMaDvcs);
                }
            }
            
            return rawResponse;
            
        } catch (HttpStatusCodeException e) {
            log.error("MobiFone loginRaw failed - Status: {}, Body: {}", e.getStatusCode(), e.getResponseBodyAsString());
            throw new RuntimeException("Login th·∫•t b·∫°i: " + e.getResponseBodyAsString());
        } catch (Exception e) {
            log.error("MobiFone loginRaw error", e);
            throw new RuntimeException("L·ªói k·∫øt n·ªëi MobiFone: " + e.getMessage());
        }
    }
    
    public String getToken() {
        if (cachedToken == null || tokenExpiry == null || Instant.now().isAfter(tokenExpiry)) {
            log.debug("Token expired or not available, refreshing...");
            login();
        }
        return cachedToken;
    }
    
    public String getMaDvcs() {
        if (cachedMaDvcs == null) {
            login();
        }
        return cachedMaDvcs;
    }
    
    public <T> T post(String endpoint, Object requestBody, Class<T> responseType) {
        return executeWithRetry(() -> {
            String url = getBaseUrl() + endpoint;
            HttpEntity<Object> entity = new HttpEntity<>(requestBody, buildAuthHeaders());
            
            log.debug("MobiFone POST - URL: {}", url);
            
            ResponseEntity<String> response = restTemplate.exchange(url, HttpMethod.POST, entity, String.class);
            log.debug("MobiFone Response: {}", response.getBody());
            
            return objectMapper.readValue(response.getBody(), responseType);
        });
    }
    
    public <T> List<T> postForList(String endpoint, Object requestBody, TypeReference<List<T>> typeRef) {
        return executeWithRetry(() -> {
            String url = getBaseUrl() + endpoint;
            HttpEntity<Object> entity = new HttpEntity<>(requestBody, buildAuthHeaders());
            
            log.debug("MobiFone POST - URL: {}", url);
            
            ResponseEntity<String> response = restTemplate.exchange(url, HttpMethod.POST, entity, String.class);
            log.debug("MobiFone Response: {}", response.getBody());
            
            return objectMapper.readValue(response.getBody(), typeRef);
        });
    }
    
    public <T> T get(String endpoint, Class<T> responseType) {
        return executeWithRetry(() -> {
            String url = buildUrlWithTaxCode(getBaseUrl() + endpoint);
            HttpEntity<Void> entity = new HttpEntity<>(buildAuthHeaders());
            
            log.debug("MobiFone GET - URL: {}", url);
            
            ResponseEntity<String> response = restTemplate.exchange(url, HttpMethod.GET, entity, String.class);
            log.debug("MobiFone Response: {}", response.getBody());
            
            return objectMapper.readValue(response.getBody(), responseType);
        });
    }
    
    public byte[] getBytes(String endpoint) {
        return executeWithRetry(() -> {
            String url = buildUrlWithTaxCode(getBaseUrl() + endpoint);
            
            HttpHeaders headers = buildAuthHeaders();
            headers.setAccept(List.of(MediaType.APPLICATION_OCTET_STREAM, MediaType.APPLICATION_PDF));
            HttpEntity<Void> entity = new HttpEntity<>(headers);
            
            log.debug("MobiFone GET bytes - URL: {}", url);
            
            ResponseEntity<byte[]> response = restTemplate.exchange(url, HttpMethod.GET, entity, byte[].class);
            return response.getBody();
        });
    }
    
    public String getString(String endpoint) {
        return executeWithRetry(() -> {
            String url = buildUrlWithTaxCode(getBaseUrl() + endpoint);
            HttpEntity<Void> entity = new HttpEntity<>(buildAuthHeaders());
            
            log.debug("MobiFone GET string - URL: {}", url);
            
            ResponseEntity<String> response = restTemplate.exchange(url, HttpMethod.GET, entity, String.class);
            return response.getBody();
        });
    }
    
    private HttpHeaders createJsonHeaders() {
        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_JSON);
        return headers;
    }
    
    private HttpHeaders buildAuthHeaders() {
        HttpHeaders headers = createJsonHeaders();
        headers.set("Authorization", "Bearer " + getToken() + ";" + getMaDvcs());
        return headers;
    }

    public Object getInvoiceSeries() {
        log.info("Getting MobiFone invoice series");
        return get(MobifoneApiEndpoints.GET_DATA_REFERENCES + "?refId=RF00059", Object.class);
    }
    
    private String buildUrlWithTaxCode(String url) {
        String separator = url.contains("?") ? "&" : "?";
        return url + separator + "tax_code=" + getConfig().getTaxCode();
    }
    
    private <T> T executeWithRetry(SupplierWithException<T> action) {
        try {
            return action.get();
        } catch (HttpStatusCodeException e) {
            if (e.getStatusCode() == HttpStatus.UNAUTHORIZED) {
                log.warn("MobiFone token expired, refreshing and retrying...");
                this.cachedToken = null;
                this.tokenExpiry = null;
                try {
                    return action.get();
                } catch (Exception retryEx) {
                    log.error("MobiFone retry failed", retryEx);
                    throw new RuntimeException("L·ªói MobiFone sau khi retry: " + retryEx.getMessage());
                }
            }
            log.error("MobiFone HTTP error - Status: {}, Body: {}", e.getStatusCode(), e.getResponseBodyAsString());
            throw new RuntimeException("L·ªói MobiFone: " + e.getResponseBodyAsString());
        } catch (Exception e) {
            log.error("MobiFone error", e);
            throw new RuntimeException("L·ªói k·∫øt n·ªëi MobiFone: " + e.getMessage());
        }
    }
    
    @FunctionalInterface
    private interface SupplierWithException<T> {
        T get() throws Exception;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/model/InvoiceRequest.java">
package com.einvoicehub.core.provider.model;

import lombok.*;
import java.math.BigDecimal;
import java.time.LocalDate;
import java.util.List;
import java.util.Map;

/**
 * DTO ƒë·∫°i di·ªán cho y√™u c·∫ßu ph√°t h√†nh h√≥a ƒë∆°n n·ªôi b·ªô.
 * ƒê√£ t·ªëi ∆∞u cho vi·ªác mapping sang m·ªçi Provider (VNPT, MISA, BKAV, Viettel).
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class InvoiceRequest {

    private Long invoiceMetadataId;
    private String clientRequestId;
    private String providerCode;
    private String invoiceType; // VD: 01GTKT, 02GTTT

    /** C·∫ßn thi·∫øt cho h·∫ßu h·∫øt Provider Vi·ªát Nam */
    private String templateCode; // M·∫´u s·ªë (VD: 1/001)
    private String symbolCode;   // K√Ω hi·ªáu (VD: C23TBA)

    private SellerInfo seller;
    private BuyerInfo buyer;
    private List<InvoiceItem> items;
    private InvoiceSummary summary;

    private LocalDate issueDate;
    private PaymentTerm paymentTerm;

    /** Ch·ª©a c√°c tham s·ªë ƒë·∫∑c th√π kh√¥ng n·∫±m trong chu·∫©n chung */
    private Map<String, Object> extraConfig;

    @Data @Builder @NoArgsConstructor @AllArgsConstructor
    public static class SellerInfo {
        private String name;
        private String taxCode;
        private String address;
        private String phone;
        private String email;
        private String bankAccount;
        private String bankName;
        private String representativeName;
    }

    @Data @Builder @NoArgsConstructor @AllArgsConstructor
    public static class BuyerInfo {
        private String name;
        private String taxCode;
        private String address;
        private String phone;
        private String email;
        private String bankAccount;
        private String bankName;
        private String customerCode; // M√£ kh√°ch h√†ng n·ªôi b·ªô
    }

    @Data @Builder @NoArgsConstructor @AllArgsConstructor
    public static class InvoiceItem {
        private String itemCode;
        private String itemName;
        private String unitName;
        private BigDecimal quantity;
        private BigDecimal unitPrice;
        private BigDecimal amount; // Th√†nh ti·ªÅn tr∆∞·ªõc thu·∫ø
        private BigDecimal discountAmount;
        private BigDecimal discountPercent; // Th√™m ƒë·ªÉ h·ªó tr·ª£ t√≠nh to√°n chi·∫øt kh·∫•u %
        private BigDecimal taxRate; // Thu·∫ø su·∫•t (0, 5, 8, 10...)
        private BigDecimal taxAmount;
        private String taxCategory; // Lo·∫°i thu·∫ø (theo quy ƒë·ªãnh c·ªßa t·ª´ng h√£ng)
        private String description;
    }

    @Data @Builder @NoArgsConstructor @AllArgsConstructor
    public static class InvoiceSummary {
        private BigDecimal subtotalAmount;
        private BigDecimal totalDiscountAmount;
        private BigDecimal totalTaxAmount;
        private BigDecimal totalAmount; // T·ªïng ti·ªÅn thanh to√°n cu·ªëi c√πng
        private String currencyCode;
        private BigDecimal exchangeRate; // Th√™m ƒë·ªÉ h·ªó tr·ª£ h√≥a ƒë∆°n ngo·∫°i t·ªá
        private String amountInWords;
    }

    @Data @Builder @NoArgsConstructor @AllArgsConstructor
    public static class PaymentTerm {
        private String method; // TM, CK, TM/CK
        private LocalDate dueDate;
        private String description;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/model/InvoiceResponse.java">
package com.einvoicehub.core.provider.model;

import lombok.*;
import lombok.Getter;
import lombok.Setter;
import lombok.ToString;
import java.time.LocalDateTime;

/**
 * DTO ph·∫£n h·ªìi t·ª´ Provider - ƒê√£ chu·∫©n h√≥a d·ªØ li·ªáu tr·∫£ v·ªÅ.
 */
@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class InvoiceResponse {

    private String clientRequestId;
    private Long invoiceMetadataId;
    private ResponseStatus status;

    private String errorCode;
    private String errorMessage;

    /** M√£ ƒë·ªãnh danh giao d·ªãch ph√≠a Provider */
    private String transactionCode;
    private String invoiceNumber;
    private String symbolCode;
    private String templateCode;

    /** ƒê·ªìng b·ªô ki·ªÉu LocalDateTime ƒë·ªÉ x·ª≠ l√Ω m√∫i gi·ªù ch√≠nh x√°c */
    private LocalDateTime issueDate;

    private String lookupCode;   // M√£ tra c·ª©u
    private String securityCode; // M√£ x√°c th·ª±c/ch·ªØ k√Ω s·ªë

    private String pdfUrl;
    private String xmlData;      // D·ªØ li·ªáu XML g·ªëc (ph√°p l√Ω)
    private String portalUrl;    // Link tra c·ª©u h√≥a ƒë∆°n tr·ª±c ti·∫øp c·ªßa h√£ng

    private String cqtCode;
    private String xmlUrl;
    private String jsonUrl;
    private boolean successful;

    private LocalDateTime responseTime;
    private Object rawResponse;  // D·ªØ li·ªáu th√¥ d√πng cho debug/audit

    public enum ResponseStatus {
        SUCCESS, PENDING, FAILED, TIMEOUT
    }

    public boolean isSuccessful() { return status == ResponseStatus.SUCCESS; }
    public boolean isFailed() { return status == ResponseStatus.FAILED; }
    public boolean isPending() { return status == ResponseStatus.PENDING; }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/viettel/ViettelAdapter.java">
package com.einvoicehub.core.provider.viettel;

import com.einvoicehub.core.domain.enums.InvoiceStatus;
import com.einvoicehub.core.provider.*;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.reactive.function.client.WebClientResponseException;

import java.math.BigDecimal;
import java.time.Duration;
import java.util.*;

@Slf4j
@Service("VIETTEL")
public class ViettelAdapter implements InvoiceProvider {

    private final WebClient webClient;
    private final ViettelApiMapper apiMapper;
    private final ObjectMapper objectMapper;

    @Value("${provider.viettel.timeout-ms:30000}")
    private int timeoutMs;

    public ViettelAdapter(WebClient.Builder webClientBuilder,
                          ViettelApiMapper apiMapper,
                          ObjectMapper objectMapper,
                          @Value("${provider.viettel.base-url:https://ebill.vietteltelecom.vn/api/v1}") String baseUrl) {
        this.webClient = webClientBuilder
                .baseUrl(baseUrl)
                .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)
                .defaultHeader("X-Client-Id", "EInvoiceHub")
                .build();
        this.apiMapper = apiMapper;
        this.objectMapper = objectMapper;
    }

    @Override public String getProviderCode() { return "VIETTEL"; }
    @Override public String getProviderName() { return "Viettel Business Invoice"; }
    @Override public boolean isAvailable() { return true; }

    @Override
    public InvoiceResponse issueInvoice(InvoiceRequest request, ProviderConfig config) {
        log.info("Viettel: Issuing invoice for ClientRequestID: {}", request.getClientRequestId());
        try {
            ViettelInvoicePayload payload = apiMapper.toViettelPayload(request);
            ViettelApiResponse response = webClient.post().uri("/invoices/create")
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .bodyValue(payload)
                    .retrieve()
                    .bodyToMono(ViettelApiResponse.class)
                    .timeout(Duration.ofMillis(timeoutMs))
                    .block();

            return apiMapper.toHubResponse(response, request.getClientRequestId());
        } catch (WebClientResponseException e) {
            return apiMapper.toHubResponse(parseError(e.getResponseBodyAsString()), request.getClientRequestId());
        } catch (Exception e) {
            log.error("Viettel: Issuance failed: {}", e.getMessage());
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage(e.getMessage()).build();
        }
    }

    @Override
    public InvoiceStatus getInvoiceStatus(String invoiceNumber, ProviderConfig config) {
        try {
            ViettelApiResponse response = webClient.get()
                    .uri(uri -> uri.path("/invoices/{id}").queryParam("includeDetails", false).build(invoiceNumber))
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .retrieve()
                    .bodyToMono(ViettelApiResponse.class)
                    .block();
            return apiMapper.mapViettelStatus(response);
        } catch (Exception e) {
            log.error("Viettel: Status check failed for {}: {}", invoiceNumber, e.getMessage());
            return InvoiceStatus.FAILED;
        }
    }

    @Override
    public InvoiceResponse cancelInvoice(String invoiceNumber, String reason, ProviderConfig config) {
        try {
            ViettelCancelRequest body = ViettelCancelRequest.builder().invoiceCode(invoiceNumber).note(reason).build();
            ViettelApiResponse response = webClient.post().uri("/invoices/cancel")
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .bodyValue(body)
                    .retrieve().bodyToMono(ViettelApiResponse.class).block();
            return apiMapper.toHubResponse(response, null);
        } catch (Exception e) {
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage(e.getMessage()).build();
        }
    }

    @Override
    public InvoiceResponse replaceInvoice(String oldNo, InvoiceRequest newReq, ProviderConfig config) {
        try {
            ViettelReplaceRequest body = ViettelReplaceRequest.builder()
                    .oldInvoiceCode(oldNo)
                    .newInvoice(apiMapper.toViettelPayload(newReq))
                    .reason("Invoice replacement")
                    .build();
            ViettelApiResponse response = webClient.post().uri("/invoices/replace")
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .bodyValue(body)
                    .retrieve().bodyToMono(ViettelApiResponse.class).block();
            return apiMapper.toHubResponse(response, newReq.getClientRequestId());
        } catch (Exception e) {
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage(e.getMessage()).build();
        }
    }

    @Override
    public String getInvoicePdf(String invoiceNumber, ProviderConfig config) {
        try {
            ViettelPdfResponse res = webClient.get().uri("/invoices/{id}/pdf", invoiceNumber)
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .retrieve().bodyToMono(ViettelPdfResponse.class).block();
            return res != null ? res.getDownloadUrl() : null;
        } catch (Exception e) { return null; }
    }

    @Override
    public String getInvoiceXml(String invoiceNumber, ProviderConfig config) {
        try {
            ViettelXmlResponse res = webClient.get().uri("/invoices/{id}/xml", invoiceNumber)
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .retrieve().bodyToMono(ViettelXmlResponse.class).block();
            return res != null ? res.getXmlData() : null;
        } catch (Exception e) {
            log.error("Viettel: XML retrieval failed: {}", e.getMessage());
            return null;
        }
    }

    @Override
    public String authenticate(ProviderConfig config) {
        try {
            ViettelAuthRequest auth = ViettelAuthRequest.builder()
                    .username(config.getUsername()).password(config.getPassword()).grantType("password").build();
            Map<?, ?> res = webClient.post().uri("/auth/token").bodyValue(auth).retrieve().bodyToMono(Map.class).block();
            return res != null ? (String) res.get("access_token") : null;
        } catch (Exception e) { return null; }
    }

    @Override public boolean testConnection(ProviderConfig config) { return authenticate(config) != null; }

    private ViettelApiResponse parseError(String body) {
        try { return objectMapper.readValue(body, ViettelApiResponse.class); } catch (Exception e) { return null; }
    }

    /* Inner Data Models */
    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelInvoicePayload {
        private String invoiceType, templateCode, issueDate;
        private ViettelParty seller, buyer;
        private List<ViettelInvoiceItem> items;
        private ViettelPayment payment;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelParty {
        private String taxCode, name, address, phone, email, bankAccount, bankName, contactName;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelInvoiceItem {
        private String name, unit, description;
        private BigDecimal quantity, unitPrice, amount, discountAmount, vatRate, vatAmount;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelPayment { private String method, currency; private BigDecimal totalAmount; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelApiResponse { private String code, message, transactionId; private ViettelInvoiceData data; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelInvoiceData { private String invoiceCode, invoiceNo, checkSum, pdfUrl, status; }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelCancelRequest { private String invoiceCode, note; }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelReplaceRequest { private String oldInvoiceCode; private ViettelInvoicePayload newInvoice; private String reason; }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelAuthRequest { private String username, password, grantType; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelPdfResponse { private String downloadUrl; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class ViettelXmlResponse { private String xmlData; }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/viettel/ViettelApiMapper.java">
package com.einvoicehub.core.provider.viettel;

import com.einvoicehub.core.domain.enums.InvoiceStatus;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;

@Slf4j
@Component
@RequiredArgsConstructor
public class ViettelApiMapper {

    public ViettelAdapter.ViettelInvoicePayload toViettelPayload(InvoiceRequest request) {
        List<ViettelAdapter.ViettelInvoiceItem> items = request.getItems().stream()
                .map(this::convertToViettelItem)
                .toList();

        return ViettelAdapter.ViettelInvoicePayload.builder()
                .invoiceType(getInvoiceTypeCode(request))
                .templateCode(getTemplateCode(request))
                .issueDate(request.getIssueDate() != null ?
                        request.getIssueDate().format(DateTimeFormatter.ISO_DATE) :
                        LocalDateTime.now().format(DateTimeFormatter.ISO_DATE))
                .seller(ViettelAdapter.ViettelParty.builder()
                        .taxCode(request.getSeller().getTaxCode())
                        .name(request.getSeller().getName())
                        .address(request.getSeller().getAddress())
                        .phone(request.getSeller().getPhone())
                        .email(request.getSeller().getEmail())
                        .bankAccount(request.getSeller().getBankAccount())
                        .bankName(request.getSeller().getBankName())
                        .contactName(request.getSeller().getRepresentativeName())
                        .build())
                .buyer(ViettelAdapter.ViettelParty.builder()
                        .taxCode(request.getBuyer().getTaxCode())
                        .name(request.getBuyer().getName())
                        .address(request.getBuyer().getAddress())
                        .phone(request.getBuyer().getPhone())
                        .email(request.getBuyer().getEmail())
                        .build())
                .items(items)
                .payment(ViettelAdapter.ViettelPayment.builder()
                        .method(request.getPaymentTerm() != null ? request.getPaymentTerm().getMethod() : "TM/CK")
                        .totalAmount(request.getSummary().getTotalAmount())
                        .currency(request.getSummary().getCurrencyCode())
                        .build())
                .build();
    }

    private ViettelAdapter.ViettelInvoiceItem convertToViettelItem(InvoiceRequest.InvoiceItem item) {
        return ViettelAdapter.ViettelInvoiceItem.builder()
                .name(item.getItemName())
                .unit(item.getUnitName())
                .quantity(item.getQuantity())
                .unitPrice(item.getUnitPrice())
                .amount(item.getAmount())
                .discountAmount(item.getDiscountAmount() != null ? item.getDiscountAmount() : BigDecimal.ZERO)
                .vatRate(item.getTaxRate())
                .vatAmount(item.getTaxAmount() != null ? item.getTaxAmount() : BigDecimal.ZERO)
                .description(item.getDescription())
                .build();
    }

    private String getInvoiceTypeCode(InvoiceRequest request) {
        if (request.getInvoiceType() != null) return request.getInvoiceType();
        return (request.getExtraConfig() != null && request.getExtraConfig().containsKey("invoiceType")) ?
                (String) request.getExtraConfig().get("invoiceType") : "01";
    }

    private String getTemplateCode(InvoiceRequest request) {
        return (request.getExtraConfig() != null && request.getExtraConfig().containsKey("templateCode")) ?
                (String) request.getExtraConfig().get("templateCode") : "01GTKT0/001";
    }

    public InvoiceResponse toHubResponse(ViettelAdapter.ViettelApiResponse res, String requestId) {
        if (res == null) {
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage("Provider timeout").build();
        }

        boolean success = "200".equals(res.getCode());
        return InvoiceResponse.builder()
                .clientRequestId(requestId)
                .status(success ? InvoiceResponse.ResponseStatus.SUCCESS : InvoiceResponse.ResponseStatus.FAILED)
                .errorCode(res.getCode())
                .errorMessage(res.getMessage())
                .transactionCode(res.getTransactionId())
                .invoiceNumber(res.getData() != null ? res.getData().getInvoiceCode() : null)
                .symbolCode(res.getData() != null ? res.getData().getInvoiceNo() : null)
                .lookupCode(res.getData() != null ? res.getData().getCheckSum() : null)
                .pdfUrl(res.getData() != null ? res.getData().getPdfUrl() : null)
                .responseTime(LocalDateTime.now())
                .rawResponse(res)
                .build();
    }

    public InvoiceStatus mapViettelStatus(ViettelAdapter.ViettelApiResponse response) {
        String status = (response != null && response.getData() != null) ? response.getData().getStatus() : null;
        if (status == null) return InvoiceStatus.FAILED;

        return switch (status.toUpperCase()) {
            case "DA_PHAT_HANH", "SIGNED" -> InvoiceStatus.SUCCESS;
            case "DA_HUY" -> InvoiceStatus.CANCELLED;
            default -> InvoiceStatus.FAILED;
        };
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/vnpt/VnptAdapter.java">
package com.einvoicehub.core.provider.vnpt;

import com.einvoicehub.core.domain.enums.InvoiceStatus;
import com.einvoicehub.core.provider.*;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;
import org.springframework.web.reactive.function.client.WebClientResponseException;

import java.math.BigDecimal;
import java.time.Duration;
import java.util.*;

@Slf4j
@Service("VNPT")
public class VnptAdapter implements InvoiceProvider {

    private final WebClient webClient;
    private final VnptApiMapper apiMapper;
    private final ObjectMapper objectMapper;

    @Value("${provider.vnpt.timeout-ms:30000}")
    private int timeoutMs;

    public VnptAdapter(WebClient.Builder webClientBuilder,
                       VnptApiMapper apiMapper,
                       ObjectMapper objectMapper,
                       @Value("${provider.vnpt.base-url:https://api.vnptinvoice.com.vn/v1}") String baseUrl) {
        this.webClient = webClientBuilder
                .baseUrl(baseUrl)
                .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)
                .build();
        this.apiMapper = apiMapper;
        this.objectMapper = objectMapper;
    }

    @Override public String getProviderCode() { return "VNPT"; }
    @Override public String getProviderName() { return "VNPT Invoice"; }
    @Override public boolean isAvailable() { return true; }

    @Override
    public InvoiceResponse issueInvoice(InvoiceRequest request, ProviderConfig config) {
        log.info("VNPT: Issuing invoice for ClientRequestID: {}", request.getClientRequestId());
        try {
            VnptInvoicePayload payload = apiMapper.toVnptPayload(request);
            VnptApiResponse response = webClient.post().uri("/invoices/publish")
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .bodyValue(payload)
                    .retrieve().bodyToMono(VnptApiResponse.class)
                    .timeout(Duration.ofMillis(timeoutMs)).block();

            return apiMapper.toHubResponse(response, request.getClientRequestId());
        } catch (WebClientResponseException e) {
            return apiMapper.toHubResponse(parseError(e.getResponseBodyAsString()), request.getClientRequestId());
        } catch (Exception e) {
            log.error("VNPT: Issuance failed: {}", e.getMessage());
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage(e.getMessage()).build();
        }
    }

    @Override
    public InvoiceStatus getInvoiceStatus(String invoiceNumber, ProviderConfig config) {
        try {
            VnptStatusResponse response = webClient.get()
                    .uri(uri -> uri.path("/invoices/status").queryParam("invoiceNumber", invoiceNumber).build())
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .retrieve().bodyToMono(VnptStatusResponse.class).block();
            return (response != null) ? apiMapper.mapVnptStatus(response.getStatus()) : InvoiceStatus.FAILED;
        } catch (Exception e) {
            log.error("VNPT: Status check failed for {}: {}", invoiceNumber, e.getMessage());
            return InvoiceStatus.FAILED;
        }
    }

    @Override
    public InvoiceResponse cancelInvoice(String invoiceNumber, String reason, ProviderConfig config) {
        try {
            VnptCancelRequest req = VnptCancelRequest.builder().invoiceNumber(invoiceNumber).reason(reason).build();
            VnptApiResponse response = webClient.post().uri("/invoices/cancel")
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .bodyValue(req)
                    .retrieve().bodyToMono(VnptApiResponse.class).block();
            return apiMapper.toHubResponse(response, null);
        } catch (Exception e) {
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage(e.getMessage()).build();
        }
    }

    @Override
    public InvoiceResponse replaceInvoice(String oldNo, InvoiceRequest newReq, ProviderConfig config) {
        /* Standard VNPT flow: Cancel old and issue new */
        InvoiceResponse cancelRes = cancelInvoice(oldNo, "Replaced by new invoice", config);
        if (cancelRes.isFailed()) return cancelRes;
        return issueInvoice(newReq, config);
    }

    @Override
    public String getInvoicePdf(String invoiceNumber, ProviderConfig config) {
        try {
            VnptPdfResponse res = webClient.get().uri("/invoices/{id}/pdf", invoiceNumber)
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .retrieve().bodyToMono(VnptPdfResponse.class).block();
            return res != null ? res.getPdfUrl() : null;
        } catch (Exception e) { return null; }
    }

    @Override
    public String getInvoiceXml(String invoiceNumber, ProviderConfig config) {
        try {
            VnptXmlResponse res = webClient.get().uri("/invoices/{id}/xml", invoiceNumber)
                    .header(HttpHeaders.AUTHORIZATION, "Bearer " + config.getAccessToken())
                    .retrieve().bodyToMono(VnptXmlResponse.class).block();
            return res != null ? res.getXmlData() : null;
        } catch (Exception e) {
            log.error("VNPT: XML retrieval failed: {}", e.getMessage());
            return null;
        }
    }

    @Override
    public String authenticate(ProviderConfig config) {
        try {
            VnptAuthRequest req = VnptAuthRequest.builder().username(config.getUsername()).password(config.getPassword()).build();
            VnptAuthResponse res = webClient.post().uri("/auth/login").bodyValue(req).retrieve().bodyToMono(VnptAuthResponse.class).block();
            return (res != null) ? res.getAccessToken() : null;
        } catch (Exception e) { return null; }
    }

    @Override public boolean testConnection(ProviderConfig config) { return authenticate(config) != null; }

    private VnptApiResponse parseError(String body) {
        try { return objectMapper.readValue(body, VnptApiResponse.class); } catch (Exception e) { return null; }
    }

    /* Inner Models */
    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptInvoicePayload {
        private String invoiceType, templateCode, issueDate;
        private VnptParty seller, buyer;
        private List<VnptInvoiceDetail> details;
        private VnptSummary summary;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptParty {
        private String taxCode, companyName, address, phone, email, bankAccount, bankName, representativeName;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptInvoiceDetail {
        private String itemName, unitName, taxCategory, description;
        private BigDecimal quantity, unitPrice, amount, discountAmount, taxRate;
    }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptSummary {
        private BigDecimal subtotalAmount, totalDiscountAmount, totalTaxAmount, totalAmount;
    }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptApiResponse {
        private boolean success;
        private String errorCode, message, transactionId, invoiceNumber, fkey, lookupCode, securityCode, pdfUrl;
    }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptStatusResponse { private String status, invoiceNumber; }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptCancelRequest { private String invoiceNumber, reason; }

    @lombok.Data @lombok.Builder @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptAuthRequest { private String username, password; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptAuthResponse { private String accessToken, refreshToken; private long expiresIn; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptPdfResponse { private String pdfUrl; }

    @lombok.Data @lombok.NoArgsConstructor @lombok.AllArgsConstructor
    public static class VnptXmlResponse { private String xmlData; }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/vnpt/VnptApiMapper.java">
package com.einvoicehub.core.provider.vnpt;

import com.einvoicehub.core.domain.enums.InvoiceStatus;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.List;

@Slf4j
@Component
@RequiredArgsConstructor
public class VnptApiMapper {

    public InvoiceResponse toHubResponse(VnptAdapter.VnptApiResponse res, String requestId) {
        if (res == null) {
            return InvoiceResponse.builder().status(InvoiceResponse.ResponseStatus.FAILED).errorMessage("No response from provider").build();
        }

        return InvoiceResponse.builder()
                .clientRequestId(requestId)
                .status(res.isSuccess() ? InvoiceResponse.ResponseStatus.SUCCESS : InvoiceResponse.ResponseStatus.FAILED)
                .errorCode(res.getErrorCode())
                .errorMessage(res.getMessage())
                .transactionCode(res.getTransactionId())
                .invoiceNumber(res.getInvoiceNumber())
                /* VNPT fkey typically contains series and template info */
                .symbolCode(res.getFkey() != null && res.getFkey().length() > 10 ? res.getFkey().substring(0, 10) : res.getFkey())
                .templateCode(res.getFkey())
                .lookupCode(res.getLookupCode())
                .securityCode(res.getSecurityCode())
                .pdfUrl(res.getPdfUrl())
                .responseTime(LocalDateTime.now())
                .rawResponse(res)
                .build();
    }

    public VnptAdapter.VnptInvoicePayload toVnptPayload(InvoiceRequest request) {
        List<VnptAdapter.VnptInvoiceDetail> details = request.getItems().stream()
                .map(this::convertToVnptDetail)
                .toList();

        return VnptAdapter.VnptInvoicePayload.builder()
                .invoiceType(request.getInvoiceType() != null ? request.getInvoiceType() : "01GTKT")
                .templateCode(request.getExtraConfig() != null ?
                        (String) request.getExtraConfig().getOrDefault("templateCode", "01GTKT0/001") : "01GTKT0/001")
                .issueDate(request.getIssueDate() != null ?
                        request.getIssueDate().format(DateTimeFormatter.ISO_DATE) :
                        LocalDateTime.now().format(DateTimeFormatter.ISO_DATE))
                .seller(VnptAdapter.VnptParty.builder()
                        .taxCode(request.getSeller().getTaxCode())
                        .companyName(request.getSeller().getName())
                        .address(request.getSeller().getAddress())
                        .phone(request.getSeller().getPhone())
                        .email(request.getSeller().getEmail())
                        .build())
                .buyer(VnptAdapter.VnptParty.builder()
                        .taxCode(request.getBuyer().getTaxCode())
                        .companyName(request.getBuyer().getName())
                        .address(request.getBuyer().getAddress())
                        .phone(request.getBuyer().getPhone())
                        .email(request.getBuyer().getEmail())
                        .build())
                .details(details)
                .summary(VnptAdapter.VnptSummary.builder()
                        .subtotalAmount(request.getSummary().getSubtotalAmount())
                        .totalDiscountAmount(request.getSummary().getTotalDiscountAmount())
                        .totalTaxAmount(request.getSummary().getTotalTaxAmount())
                        .totalAmount(request.getSummary().getTotalAmount())
                        .build())
                .build();
    }

    private VnptAdapter.VnptInvoiceDetail convertToVnptDetail(InvoiceRequest.InvoiceItem item) {
        return VnptAdapter.VnptInvoiceDetail.builder()
                .itemName(item.getItemName())
                .unitName(item.getUnitName())
                .quantity(item.getQuantity())
                .unitPrice(item.getUnitPrice())
                .amount(item.getAmount())
                .discountAmount(item.getDiscountAmount())
                .taxRate(item.getTaxRate())
                .taxCategory(item.getTaxCategory() != null ? item.getTaxCategory() : "5")
                .description(item.getDescription())
                .build();
    }

    public InvoiceStatus mapVnptStatus(String vnptStatus) {
        if (vnptStatus == null) return InvoiceStatus.FAILED;
        return switch (vnptStatus.toUpperCase()) {
            case "ISSUED", "SUCCESS" -> InvoiceStatus.SUCCESS;
            case "CANCELLED" -> InvoiceStatus.CANCELLED;
            case "REPLACED" -> InvoiceStatus.REPLACED;
            default -> InvoiceStatus.FAILED;
        };
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/InvoiceProvider.java">
package com.einvoicehub.core.provider;

import com.einvoicehub.core.domain.enums.InvoiceStatus;
import com.einvoicehub.core.provider.model.InvoiceRequest;
import com.einvoicehub.core.provider.model.InvoiceResponse;

public interface InvoiceProvider {
    String getProviderCode();
    String getProviderName();
    boolean isAvailable();

    InvoiceResponse issueInvoice(InvoiceRequest request, ProviderConfig config);
    InvoiceStatus getInvoiceStatus(String invoiceNumber, ProviderConfig config);
    InvoiceResponse cancelInvoice(String invoiceNumber, String reason, ProviderConfig config);
    InvoiceResponse replaceInvoice(String oldInvoiceNumber, InvoiceRequest newRequest, ProviderConfig config);

    /* Returns PDF content as Base64 or URL */
    String getInvoicePdf(String invoiceNumber, ProviderConfig config);

    /* Returns legal XML content as Base64 or String */
    String getInvoiceXml(String invoiceNumber, ProviderConfig config);

    String authenticate(ProviderConfig config);
    boolean testConnection(ProviderConfig config);
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/ProviderConfig.java">
package com.einvoicehub.core.provider;

import lombok.*;
import java.time.LocalDateTime;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
public class ProviderConfig {
    private Long configId;
    private String providerCode;
    private String providerName;
    private String username;

    @ToString.Exclude
    private String password;

    private String appId;

    @ToString.Exclude
    private String secretKey;

    private String customApiUrl;
    private String certificateSerial;

    @ToString.Exclude
    private String certificateData;
    private LocalDateTime certificateExpiredAt;

    private String extraConfigJson;

    @ToString.Exclude
    private String accessToken;
    private LocalDateTime tokenExpiredAt;

    public boolean hasValidCertificate() {
        return certificateData != null && !certificateData.isEmpty() &&
                (certificateExpiredAt == null || certificateExpiredAt.isAfter(LocalDateTime.now()));
    }

    /* Check if token is valid with a 5-minute safety buffer */
    public boolean hasValidToken() {
        return accessToken != null && !accessToken.isEmpty() &&
                (tokenExpiredAt == null || tokenExpiredAt.isAfter(LocalDateTime.now().plusMinutes(5)));
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/provider/ProviderFactory.java">
package com.einvoicehub.core.provider;

import com.einvoicehub.core.provider.exception.ProviderException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.Map;
import java.util.function.Function;
import java.util.stream.Collectors;

@Component
public class ProviderFactory {
    private final Map<String, InvoiceProvider> providerMap;

    @Autowired
    public ProviderFactory(List<InvoiceProvider> providers) {
        this.providerMap = providers.stream()
                .collect(Collectors.toUnmodifiableMap(
                        p -> p.getProviderCode().toUpperCase(),
                        Function.identity()
                ));
    }

    public InvoiceProvider getProvider(String providerCode) {
        if (providerCode == null) throw new ProviderException("Provider code cannot be null", "SYSTEM", "NULL_CODE");

        InvoiceProvider provider = providerMap.get(providerCode.toUpperCase());
        if (provider == null) {
            throw new ProviderException("Unsupported provider: " + providerCode, providerCode, "PROVIDER_NOT_FOUND");
        }
        return provider;
    }

    public boolean hasProvider(String providerCode) {
        return providerCode != null && providerMap.containsKey(providerCode.toUpperCase());
    }

    public List<String> getAvailableProviders() {
        return providerMap.values().stream()
                .filter(InvoiceProvider::isAvailable)
                .map(InvoiceProvider::getProviderCode)
                .collect(Collectors.toList());
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/security/ApiKeyAuthenticationToken.java">
package com.einvoicehub.core.security;

import com.einvoicehub.core.domain.entity.ApiCredential;
import com.einvoicehub.core.domain.entity.MerchantEntity;
import lombok.Getter;
import org.springframework.security.authentication.AbstractAuthenticationToken;
import org.springframework.security.core.GrantedAuthority;

import java.util.Collection;

@Getter
public class ApiKeyAuthenticationToken extends AbstractAuthenticationToken {

    private final String clientId;
    private final String apiKey;
    private final ApiCredential credential;
    private final MerchantEntity merchant;

    public ApiKeyAuthenticationToken(String clientId, String apiKey,
                                     ApiCredential credential, MerchantEntity merchant,
                                     Collection<? extends GrantedAuthority> authorities) {
        super(authorities);
        this.clientId = clientId;
        this.apiKey = apiKey;
        this.credential = credential;
        this.merchant = merchant;
        setAuthenticated(authorities != null && !authorities.isEmpty());
    }

    @Override
    public Object getCredentials() {
        return apiKey;
    }

    @Override
    public Object getPrincipal() {
        return clientId;
    }

    public Long getMerchantId() {
        return merchant != null ? merchant.getId() : null;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/security/ApiKeyFilter.java">
package com.einvoicehub.core.security;

import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.domain.entity.MerchantEntity;
import com.einvoicehub.core.domain.enums.EntityStatus;
import com.einvoicehub.core.domain.entity.ApiCredential;
import com.fasterxml.jackson.databind.ObjectMapper;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.MediaType;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import org.springframework.util.AntPathMatcher;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.util.*;

@Slf4j
@Component
@RequiredArgsConstructor
public class ApiKeyFilter extends OncePerRequestFilter {

    private static final String API_KEY_HEADER = "X-API-KEY";
    private static final String CLIENT_ID_HEADER = "X-CLIENT-ID";

    private final ApiCredentialRepository apiCredentialRepository;
    private final ObjectMapper objectMapper;
    private final AntPathMatcher pathMatcher = new AntPathMatcher();

    private static final Set<String> PUBLIC_PATHS = Set.of(
            "/api/v1/auth/**",
            "/api/v1/health/**",
            "/api/v1/public/**",
            "/actuator/**"
    );

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response,
                                    FilterChain filterChain) throws ServletException, IOException {

        if (isPublicPath(request.getRequestURI())) {
            filterChain.doFilter(request, response);
            return;
        }

        String clientId = request.getHeader(CLIENT_ID_HEADER);
        String apiKey = request.getHeader(API_KEY_HEADER);

        if (clientId == null || apiKey == null) {
            writeErrorResponse(response, ErrorCode.UNAUTHENTICATED, "Missing security headers");
            return;
        }

        ApiCredential credential = apiCredentialRepository
                .findByClientIdAndIsActiveTrue(clientId)
                .orElse(null);

        if (credential == null || !hashApiKey(apiKey).equals(credential.getApiKeyHash())) {
            writeErrorResponse(response, ErrorCode.API_KEY_INVALID, "Invalid credentials");
            return;
        }

        if (!credential.isValid()) {
            writeErrorResponse(response, ErrorCode.API_KEY_INVALID, "Credential expired or inactive");
            return;
        }

        /* IP Whitelist validation */
        if (credential.getIpWhitelist() != null && !credential.getIpWhitelist().isBlank()) {
            String clientIp = getClientIp(request);
            if (!isIpAllowed(clientIp, credential.getIpWhitelist())) {
                writeErrorResponse(response, ErrorCode.UNAUTHORIZED, "IP address not whitelisted");
                return;
            }
        }

        /* Rate limit validation */
        if (!credential.canMakeRequest()) {
            writeErrorResponse(response, ErrorCode.VALIDATION_ERROR, "Rate limit exceeded");
            return;
        }

        MerchantEntity merchant = credential.getMerchant();
        if (merchant == null || merchant.getIsDeleted() || merchant.getStatus() != EntityStatus.ACTIVE) {
            writeErrorResponse(response, ErrorCode.UNAUTHORIZED, "Merchant account is inactive");
            return;
        }

        List<SimpleGrantedAuthority> authorities = buildAuthorities(credential.getScopes());
        ApiKeyAuthenticationToken auth = new ApiKeyAuthenticationToken(clientId, apiKey, credential, merchant, authorities);

        credential.incrementRequestCount();
        apiCredentialRepository.save(credential);

        SecurityContextHolder.getContext().setAuthentication(auth);
        filterChain.doFilter(request, response);
    }

    private boolean isPublicPath(String path) {
        return PUBLIC_PATHS.stream().anyMatch(pattern -> pathMatcher.match(pattern, path));
    }

    private String hashApiKey(String apiKey) {
        try {
            MessageDigest digest = MessageDigest.getInstance("SHA-256");
            byte[] hash = digest.digest(apiKey.getBytes(StandardCharsets.UTF_8));
            return HexFormat.of().formatHex(hash);
        } catch (NoSuchAlgorithmException e) {
            throw new RuntimeException("SHA-256 not available", e);
        }
    }

    private String getClientIp(HttpServletRequest request) {
        String xf = request.getHeader("X-Forwarded-For");
        return (xf != null) ? xf.split(",")[0].trim() : request.getRemoteAddr();
    }

    private boolean isIpAllowed(String clientIp, String whitelist) {
        return Arrays.stream(whitelist.split(","))
                .map(String::trim)
                .anyMatch(allowed -> allowed.equals(clientIp));
    }

    private List<SimpleGrantedAuthority> buildAuthorities(String scopes) {
        if (scopes == null || scopes.isBlank()) return List.of(new SimpleGrantedAuthority("ROLE_API"));
        return Arrays.stream(scopes.split(","))
                .map(s -> new SimpleGrantedAuthority("SCOPE_" + s.trim().toUpperCase().replace(".", "_")))
                .toList();
    }

    private void writeErrorResponse(HttpServletResponse response, ErrorCode errorCode, String message) throws IOException {
        response.setStatus(errorCode.getStatusCode().value());
        response.setContentType(MediaType.APPLICATION_JSON_VALUE);
        ApiResponse<?> apiResponse = ApiResponse.error(errorCode, message);
        response.getWriter().write(objectMapper.writeValueAsString(apiResponse));
    }

    @Override
    protected boolean shouldNotFilter(HttpServletRequest request) {
        return !request.getRequestURI().startsWith("/api/");
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/security/JwtAuthenticationFilter.java">
package com.einvoicehub.core.security;

import com.einvoicehub.core.domain.entity.MerchantUserEntity;
import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.util.StringUtils;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.util.List;

@Slf4j
@Component
@RequiredArgsConstructor
public class JwtAuthenticationFilter extends OncePerRequestFilter {

    private static final String AUTHORIZATION_HEADER = "Authorization";
    private static final String BEARER_PREFIX = "Bearer ";

    private final JwtTokenProvider jwtTokenProvider;
    private final MerchantUserRepository userRepository;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response,
                                    FilterChain filterChain) throws ServletException, IOException {
        try {
            String jwt = extractJwt(request);

            if (StringUtils.hasText(jwt) && jwtTokenProvider.validateToken(jwt)) {
                String username = jwtTokenProvider.getUsernameFromToken(jwt);

                MerchantUserEntity user = userRepository.findByUsernameAndIsActiveTrue(username).orElse(null);

                if (user != null && !user.isLocked()) {
                    List<SimpleGrantedAuthority> authorities = List.of(
                            new SimpleGrantedAuthority("ROLE_" + user.getRole().name())
                    );

                    UsernamePasswordAuthenticationToken auth = new UsernamePasswordAuthenticationToken(user, null, authorities);
                    auth.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));

                    SecurityContextHolder.getContext().setAuthentication(auth);
                    log.debug("Authenticated user: {} via JWT", username);
                }
            }
        } catch (Exception e) {
            log.error("Failed to set user authentication: {}", e.getMessage());
        }

        filterChain.doFilter(request, response);
    }

    private String extractJwt(HttpServletRequest request) {
        String bearerToken = request.getHeader(AUTHORIZATION_HEADER);
        if (StringUtils.hasText(bearerToken) && bearerToken.startsWith(BEARER_PREFIX)) {
            return bearerToken.substring(BEARER_PREFIX.length());
        }
        return null;
    }

    @Override
    protected boolean shouldNotFilter(HttpServletRequest request) {
        String path = request.getRequestURI();
        return !path.startsWith("/api/v1/admin/") && !path.startsWith("/api/v1/auth/");
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/security/JwtTokenProvider.java">
package com.einvoicehub.core.security;

import io.jsonwebtoken.*;
import io.jsonwebtoken.security.Keys;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import javax.crypto.SecretKey;
import java.nio.charset.StandardCharsets;
import java.util.Date;

@Slf4j
@Component
public class JwtTokenProvider {

    private final SecretKey signingKey;
    private final long expirationMs;

    public JwtTokenProvider(@Value("${app.jwt.secret}") String secret,
                            @Value("${app.jwt.expiration-ms:86400000}") long expirationMs) {
        this.signingKey = Keys.hmacShaKeyFor(secret.getBytes(StandardCharsets.UTF_8));
        this.expirationMs = expirationMs;
    }

    public String generateToken(String username, String role) {
        Date now = new Date();
        Date expiryDate = new Date(now.getTime() + expirationMs);

        return Jwts.builder()
                .subject(username)
                .claim("role", role)
                .issuedAt(now)
                .expiration(expiryDate)
                .signWith(signingKey)
                .compact();
    }

    public String getUsernameFromToken(String token) {
        return Jwts.parser()
                .verifyWith(signingKey)
                .build()
                .parseSignedClaims(token)
                .getPayload()
                .getSubject();
    }

    public boolean validateToken(String token) {
        try {
            Jwts.parser().verifyWith(signingKey).build().parseSignedClaims(token);
            return true;
        } catch (MalformedJwtException e) {
            log.error("Invalid JWT token structure");
        } catch (ExpiredJwtException e) {
            log.error("JWT token has expired");
        } catch (UnsupportedJwtException e) {
            log.error("JWT token type is unsupported");
        } catch (IllegalArgumentException e) {
            log.error("JWT claims string is empty");
        } catch (JwtException e) {
            log.error("JWT validation error: {}", e.getMessage());
        }
        return false;
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/security/SecurityConfig.java">
package com.einvoicehub.core.security;

import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.annotation.Order;
import org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

@Configuration
@EnableWebSecurity
@EnableMethodSecurity
@RequiredArgsConstructor
public class SecurityConfig {

    private final ApiKeyFilter apiKeyFilter;
    private final JwtAuthenticationFilter jwtAuthenticationFilter;

    @Bean
    @Order(1)
    public SecurityFilterChain apiSecurityFilterChain(HttpSecurity http) throws Exception {
        http
                .securityMatcher("/api/v1/invoices/**", "/api/v1/merchants/**", "/api/v1/configs/**")
                .csrf(AbstractHttpConfigurer::disable)
                .sessionManagement(s -> s.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(auth -> auth.anyRequest().authenticated())
                .addFilterBefore(apiKeyFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    @Bean
    @Order(2)
    public SecurityFilterChain adminSecurityFilterChain(HttpSecurity http) throws Exception {
        http
                .securityMatcher("/api/v1/admin/**", "/api/v1/portal/**")
                .csrf(AbstractHttpConfigurer::disable)
                .sessionManagement(s -> s.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/api/v1/auth/login").permitAll()
                        .requestMatchers("/api/v1/admin/users/**").hasRole("ADMIN")
                        .anyRequest().authenticated())
                .addFilterBefore(jwtAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }

    @Bean
    @Order(3)
    public SecurityFilterChain defaultSecurityFilterChain(HttpSecurity http) throws Exception {
        http
                .csrf(AbstractHttpConfigurer::disable)
                .sessionManagement(s -> s.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/actuator/**", "/api/v1/public/**").permitAll()
                        .anyRequest().denyAll());

        return http.build();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvApiCredentialService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.domain.entity.EinvApiCredentialsEntity;
import com.einvoicehub.core.domain.entity.EinvMerchantEntity;
import com.einvoicehub.core.domain.repository.EinvApiCredentialRepository;
import com.einvoicehub.core.domain.repository.EinvMerchantRepository;
import com.einvoicehub.core.dto.EinvApiCredentialDto;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvApiCredentialService {

    private final EinvApiCredentialRepository repository;
    private final EinvMerchantRepository merchantRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvApiCredentialDto> getByMerchant(Long merchantId) {
        log.info("[API] Truy v·∫•n danh s√°ch API Key cho Merchant ID: {}", merchantId);
        // L∆∞u √Ω: Repository findByFilters tr·∫£ v·ªÅ Page, ·ªü ƒë√¢y l·ªçc ƒë∆°n gi·∫£n
        return repository.findAll().stream()
                .filter(c -> c.getMerchant().getId().equals(merchantId))
                .map(mapper::toDto)
                .collect(Collectors.toList());
    }

    @Transactional
    public EinvApiCredentialDto create(Long merchantId, String scopeJson) {
        log.info("[API] T·∫°o m·ªõi API Key cho Merchant ID: {}", merchantId);

        EinvMerchantEntity merchant = merchantRepository.findById(merchantId)
                .filter(m -> !m.getIsDeleted())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND));

        // Sinh ClientID v√† API Key th√¥ (Logic SOFTZ cho t√≠ch h·ª£p)
        String clientId = UUID.randomUUID().toString().replace("-", "").substring(0, 20);
        String rawApiKey = UUID.randomUUID().toString().replace("-", "");

        EinvApiCredentialsEntity entity = EinvApiCredentialsEntity.builder()
                .merchant(merchant)
                .clientId(clientId)
                .apiKeyPrefix(rawApiKey.substring(0, 8))
                .apiKeyHash("SHA256_HASH_OF_" + rawApiKey) // Th·ª±c t·∫ø d√πng hashing chu·∫©n
                .scopes(scopeJson != null ? scopeJson : "[\"invoice:read\", \"invoice:create\"]")
                .isActive(true)
                .rateLimitPerHour(1000)
                .rateLimitPerDay(10000)
                .build();

        log.info("[API] ƒê√£ c·∫•p m·ªõi API Key v·ªõi ClientID: {}", clientId);
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[API] Thu h·ªìi API Key ID: {}", id);
        if (!repository.existsById(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√≥a API kh√¥ng t·ªìn t·∫°i");
        }
        repository.deleteById(id);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvAuditLogService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.EinvAuditLogsEntity;
import com.einvoicehub.core.domain.repository.EinvAuditLogRepository;
import com.einvoicehub.core.dto.response.EinvAuditLogResponse;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvAuditLogService {

    private final EinvAuditLogRepository repository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvAuditLogResponse> getAll() {
        log.info("[Audit] L·∫•y danh s√°ch to√†n b·ªô nh·∫≠t k√Ω h·ªá th·ªëng");
        return repository.findAll().stream()
                .map(mapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvAuditLogResponse getById(Long id) {
        return repository.findById(id)
                .map(mapper::toResponse)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y b·∫£n ghi nh·∫≠t k√Ω"));
    }

    @Transactional
    public void log(EinvAuditLogsEntity entity) {
        log.debug("[Audit] L∆∞u v·∫øt h√†nh ƒë·ªông: {} tr√™n ƒë·ªëi t∆∞·ª£ng {}", entity.getAction(), entity.getEntityType());

        if (entity.getEntityType() == null || entity.getEntityId() == null) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "D·ªØ li·ªáu nh·∫≠t k√Ω thi·∫øu th√¥ng tin ƒë·ªãnh danh");
        }

        repository.save(entity);
    }

    @Transactional
    public EinvAuditLogResponse update(Long id, String extraNote) {
        log.warn("[Audit] C·∫≠p nh·∫≠t th√¥ng tin b·ªï sung cho log ID: {}", id);
        EinvAuditLogsEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Nh·∫≠t k√Ω kh√¥ng t·ªìn t·∫°i"));

        entity.setUserAgent(entity.getUserAgent() + " | Supplement: " + extraNote);

        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.error("[Audit] C·∫¢NH B√ÅO: Thao t√°c x√≥a b·∫£n ghi nh·∫≠t k√Ω ID: {}", id);
        if (!repository.existsById(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i ƒë·ªÉ x√≥a");
        }
        // Trong h·ªá th·ªëng t√†i ch√≠nh,log ch·ªâ ƒë∆∞·ª£c x√≥a sau 10 nƒÉm .·ªû ƒë√¢y ta tri·ªÉn khai h√†m x√≥a c∆° b·∫£n cho Admin.
        repository.deleteById(id);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvInvoiceAdjustmentService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.EinvInvoiceAdjustmentsEntity;
import com.einvoicehub.core.domain.entity.EinvInvoiceMetadataEntity;
import com.einvoicehub.core.domain.repository.EinvInvoiceAdjustmentRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.dto.request.EinvInvoiceAdjustmentRequest;
import com.einvoicehub.core.dto.response.EinvInvoiceAdjustmentResponse;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvInvoiceAdjustmentService {

    private final EinvInvoiceAdjustmentRepository repository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvInvoiceAdjustmentResponse> getAll() {
        log.info("[Adjustment] Truy v·∫•n danh s√°ch bi√™n b·∫£n ƒëi·ªÅu ch·ªânh");
        return repository.findAll().stream()
                .map(mapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvInvoiceAdjustmentResponse getById(Long id) {
        log.info("[Adjustment] T√¨m ki·∫øm bi√™n b·∫£n ID: {}", id);
        return repository.findById(id).map(mapper::toResponse)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y bi√™n b·∫£n"));
    }

    @Transactional
    public EinvInvoiceAdjustmentResponse create(EinvInvoiceAdjustmentRequest request) {
        log.info("[Adjustment] L·∫≠p bi√™n b·∫£n {} cho h√≥a ƒë∆°n g·ªëc ID: {}",
                request.getAdjustmentType(), request.getOriginalInvoiceId());
        EinvInvoiceMetadataEntity originalInvoice = metadataRepository.findById(request.getOriginalInvoiceId())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n g·ªëc kh√¥ng t·ªìn t·∫°i"));

        if (originalInvoice.getInvoiceStatus().getId() != 5) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Ch·ªâ ƒë∆∞·ª£c ph√©p l·∫≠p bi√™n b·∫£n cho h√≥a ƒë∆°n ƒë√£ g·ª≠i CQT th√†nh c√¥ng");
        }

        if (Boolean.TRUE.equals(originalInvoice.getMerchant().getIsDeleted())) {
            throw new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND, "Doanh nghi·ªáp ƒë√£ b·ªã kh√≥a");
        }

        EinvInvoiceAdjustmentsEntity entity = mapper.toEntity(request);
        entity.setOriginalInvoice(originalInvoice);

        BigDecimal difference = request.getNewTotalAmount().subtract(request.getOldTotalAmount());
        entity.setDifferenceAmount(difference);

        entity = repository.save(entity);
        log.info("[Adjustment] ƒê√£ l∆∞u bi√™n b·∫£n ƒëi·ªÅu ch·ªânh ID: {}", entity.getId());
        return mapper.toResponse(entity);
    }

    @Transactional
    public EinvInvoiceAdjustmentResponse update(Long id, EinvInvoiceAdjustmentRequest request) {
        log.info("[Adjustment] C·∫≠p nh·∫≠t bi√™n b·∫£n ID: {}", id);
        EinvInvoiceAdjustmentsEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Bi√™n b·∫£n kh√¥ng t·ªìn t·∫°i"));

        if (!"PENDING".equals(entity.getStatus().name())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Bi√™n b·∫£n ƒë√£ ƒë∆∞·ª£c duy·ªát ho·∫∑c g·ª≠i ƒëi, kh√¥ng th·ªÉ s·ª≠a");
        }

        entity.setAgreementNumber(request.getAgreementNumber());
        entity.setAgreementDate(request.getAgreementDate());
        entity.setReasonDescription(request.getReasonDescription());
        entity.setNewTotalAmount(request.getNewTotalAmount());
        entity.setDifferenceAmount(request.getNewTotalAmount().subtract(entity.getOldTotalAmount()));

        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Adjustment] Y√™u c·∫ßu x√≥a bi√™n b·∫£n ID: {}", id);
        EinvInvoiceAdjustmentsEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i"));

        if (Boolean.TRUE.equals(entity.getSubmittedToCqt())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Bi√™n b·∫£n ƒë√£ ƒë∆∞·ª£c g·ª≠i cho C∆° quan Thu·∫ø, kh√¥ng th·ªÉ x√≥a");
        }

        repository.delete(entity);
        log.info("[Adjustment] ƒê√£ x√≥a bi√™n b·∫£n ID: {}", id);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvInvoiceItemService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.*;
import com.einvoicehub.core.domain.repository.*;
import com.einvoicehub.core.dto.EinvInvoiceItemDto;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvInvoiceItemService {

    private final EinvInvoiceItemRepository repository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvVatRateRepository vatRateRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvInvoiceItemDto> getByInvoiceId(Long invoiceId) {
        log.info("[Item] L·∫•y danh s√°ch h√†ng h√≥a cho h√≥a ƒë∆°n ID: {}", invoiceId);
        return repository.findByInvoiceIdOrderByLineNumberAsc(invoiceId).stream()
                .map(mapper::toDto)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvInvoiceItemDto getById(Long id) {
        return repository.findById(id).map(mapper::toDto)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "D√≤ng h√†ng kh√¥ng t·ªìn t·∫°i"));
    }


    @Transactional
    public EinvInvoiceItemDto create(Long invoiceId, EinvInvoiceItemDto dto) {
        log.info("[Item] Th√™m h√†ng h√≥a m·ªõi v√†o h√≥a ƒë∆°n ID: {}", invoiceId);

        EinvInvoiceMetadataEntity invoice = metadataRepository.findById(invoiceId)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n cha kh√¥ng t·ªìn t·∫°i"));
        if (invoice.getInvoiceStatus().getId() != 1) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n ƒë√£ ch·ªët, kh√¥ng ƒë∆∞·ª£c th√™m d√≤ng h√†ng");
        }

        EinvInvoiceItemEntity entity = mapper.toEntity(dto);
        entity.setInvoice(invoice);
        calculateItemAmounts(entity);
        entity = repository.save(entity);
        updateInvoiceTotals(invoice);

        return mapper.toDto(entity);
    }

    @Transactional
    public EinvInvoiceItemDto update(Long id, EinvInvoiceItemDto dto) {
        log.info("[Item] C·∫≠p nh·∫≠t d√≤ng h√†ng ID: {}", id);
        EinvInvoiceItemEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i"));

        if (entity.getInvoice().getInvoiceStatus().getId() != 1) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n ƒë√£ ch·ªët, kh√¥ng ƒë∆∞·ª£c s·ª≠a d√≤ng h√†ng");
        }

        entity.setProductName(dto.getProductName());
        entity.setQuantity(dto.getQuantity());
        entity.setUnitPrice(dto.getUnitPrice());
        entity.setDiscountAmount(dto.getDiscountAmount());

        calculateItemAmounts(entity);
        entity = repository.save(entity);

        updateInvoiceTotals(entity.getInvoice());
        return mapper.toDto(entity);
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Item] X√≥a d√≤ng h√†ng ID: {}", id);
        EinvInvoiceItemEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i"));

        EinvInvoiceMetadataEntity invoice = entity.getInvoice();
        if (invoice.getInvoiceStatus().getId() != 1) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n ƒë√£ ph√°t h√†nh, kh√¥ng th·ªÉ x√≥a chi ti·∫øt");
        }

        repository.delete(entity);
        updateInvoiceTotals(invoice);
    }

    private void calculateItemAmounts(EinvInvoiceItemEntity entity) {
        BigDecimal qty = entity.getQuantity() != null ? entity.getQuantity() : BigDecimal.ZERO;
        BigDecimal price = entity.getUnitPrice() != null ? entity.getUnitPrice() : BigDecimal.ZERO;
        BigDecimal discount = entity.getDiscountAmount() != null ? entity.getDiscountAmount() : BigDecimal.ZERO;

        BigDecimal gross = qty.multiply(price).setScale(2, RoundingMode.HALF_UP);
        entity.setGrossAmount(gross);

        BigDecimal net = gross.subtract(discount);
        entity.setNetAmount(net);

        if (entity.getVatRate() != null) {
            BigDecimal taxRate = entity.getVatRate().getRatePercent().divide(new BigDecimal("100"), 4, RoundingMode.HALF_UP);
            BigDecimal taxAmount = net.multiply(taxRate).setScale(2, RoundingMode.HALF_UP);
            entity.setTaxAmount(taxAmount);
            entity.setTaxRate(entity.getVatRate().getRatePercent());
        }
        entity.setTotalAmount(net.add(entity.getTaxAmount() != null ? entity.getTaxAmount() : BigDecimal.ZERO));
    }

    private void updateInvoiceTotals(EinvInvoiceMetadataEntity invoice) {
        List<EinvInvoiceItemEntity> items = repository.findByInvoiceIdOrderByLineNumberAsc(invoice.getId());

        BigDecimal subtotal = items.stream().map(EinvInvoiceItemEntity::getNetAmount).reduce(BigDecimal.ZERO, BigDecimal::add);
        BigDecimal tax = items.stream().map(i -> i.getTaxAmount() != null ? i.getTaxAmount() : BigDecimal.ZERO).reduce(BigDecimal.ZERO, BigDecimal::add);

        invoice.setSubtotalAmount(subtotal);
        invoice.setTaxAmount(tax);
        invoice.setTotalAmount(subtotal.add(tax));

        metadataRepository.save(invoice);
        log.debug("[Transaction] ƒê√£ c·∫≠p nh·∫≠t l·∫°i t·ªïng ti·ªÅn cho h√≥a ƒë∆°n ID: {}. T·ªïng c·ªông: {}", invoice.getId(), invoice.getTotalAmount());
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvInvoiceMetadataService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.*;
import com.einvoicehub.core.domain.repository.*;
import com.einvoicehub.core.dto.request.EinvSubmitInvoiceRequest;
import com.einvoicehub.core.dto.response.EinvInvoiceMetadataResponse;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvInvoiceMetadataService {

    private final EinvInvoiceMetadataRepository repository;
    private final EinvMerchantRepository merchantRepository;
    private final EinvInvoiceTemplateRepository templateRepository;
    private final EinvInvoiceStatusRepository statusRepository;
    private final EinvInvoiceItemRepository itemRepository;
    private final EinvInvoiceAdjustmentRepository adjustmentRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvInvoiceMetadataResponse> getAll() {
        log.info("[Transaction] ƒêang l·∫•y danh s√°ch to√†n b·ªô h√≥a ƒë∆°n");
        return repository.findAll().stream()
                .map(mapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvInvoiceMetadataResponse getById(Long id) {
        log.info("[Transaction] T√¨m ki·∫øm h√≥a ƒë∆°n ID: {}", id);
        return repository.findById(id)
                .map(mapper::toResponse)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n kh√¥ng t·ªìn t·∫°i"));
    }

    @Transactional
    public EinvInvoiceMetadataResponse create(EinvSubmitInvoiceRequest request) {
        log.info("[Transaction] B·∫Øt ƒë·∫ßu t·∫°o h√≥a ƒë∆°n cho Merchant ID: {}", request.getInvoiceTypeId());

        EinvInvoiceTemplateEntity template = templateRepository.findById(request.getInvoiceTypeId())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "M·∫´u h√≥a ƒë∆°n kh√¥ng t·ªìn t·∫°i"));

        EinvMerchantEntity merchant = template.getMerchant();
        // Requirement 4: Ki·ªÉm tra tr·∫°ng th√°i ho·∫°t ƒë·ªông c·ªßa Merchant
        if (Boolean.TRUE.equals(merchant.getIsDeleted())) {
            log.error("[Transaction] Merchant {} ƒë√£ ng·ª´ng ho·∫°t ƒë·ªông", merchant.getTaxCode());
            throw new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND, "Doanh nghi·ªáp ƒë√£ ng·ª´ng ho·∫°t ƒë·ªông tr√™n h·ªá th·ªëng");
        }

        synchronized (this) {
            Integer nextNumber = template.getCurrentNumber() + 1;
            if (nextNumber > template.getMaxNumber()) {
                log.error("[Transaction] M·∫´u {} ƒë√£ s·ª≠ d·ª•ng h·∫øt d·∫£i s·ªë (%d/%d)",
                        template.getSymbolCode(), nextNumber, template.getMaxNumber());
                throw new InvalidDataException(ErrorCode.INVALID_DATA, "D·∫£i s·ªë h√≥a ƒë∆°n ƒë√£ h·∫øt, vui l√≤ng th√¥ng b√°o ph√°t h√†nh d·∫£i s·ªë m·ªõi");
            }

            template.setCurrentNumber(nextNumber);
            templateRepository.save(template);

            EinvInvoiceMetadataEntity entity = mapper.toEntity(request);
            entity.setMerchant(merchant);
            entity.setInvoiceTemplate(template);
            entity.setInvoiceNumber(String.format("%08d", nextNumber)); // Format 8 ch·ªØ s·ªë chu·∫©n CQT
            entity.setSymbolCode(template.getSymbolCode());
            entity.setTemplateCode(template.getTemplateCode());

            statusRepository.findById(1).ifPresent(entity::setInvoiceStatus);

            entity.setIsDeleted(false);
            entity = repository.save(entity);

            log.info("[Transaction] ƒê√£ t·∫°o th√†nh c√¥ng h√≥a ƒë∆°n s·ªë: {} (ID: {})", entity.getInvoiceNumber(), entity.getId());
            return mapper.toResponse(entity);
        }
    }

    @Transactional
    public EinvInvoiceMetadataResponse update(Long id, EinvSubmitInvoiceRequest request) {
        log.info("[Transaction] C·∫≠p nh·∫≠t th√¥ng tin h√≥a ƒë∆°n ID: {}", id);
        EinvInvoiceMetadataEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n"));

        if (entity.getInvoiceStatus().getId() != 1) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n ƒë√£ ch·ªët tr·∫°ng th√°i, kh√¥ng th·ªÉ ch·ªânh s·ª≠a");
        }

        entity.setBuyerFullName(request.getBuyerName());
        entity.setBuyerEmail(request.getReceiverEmail());
        entity.setBuyerAddress(request.getBuyerAddress());
        entity.setBuyerTaxCode(request.getBuyerTaxCode());
        entity.setCurrencyCode(request.getCurrencyCode());
        entity.setExchangeRate(request.getExchangeRate());

        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Transaction] ƒêang th·ª±c hi·ªán x√≥a m·ªÅm h√≥a ƒë∆°n ID: {}", id);
        EinvInvoiceMetadataEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n kh√¥ng t·ªìn t·∫°i"));

        if (entity.getInvoiceStatus().getId() != 1) {
            log.error("[Transaction] X√≥a m·ªÅm th·∫•t b·∫°i: H√≥a ƒë∆°n ID {} ƒë√£ ch·ªët tr·∫°ng th√°i", id);
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Ch·ªâ ƒë∆∞·ª£c ph√©p x√≥a h√≥a ƒë∆°n ·ªü tr·∫°ng th√°i Nh√°p");
        }
        if (adjustmentRepository.existsByOriginalInvoiceId(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n n√†y ƒë√£ c√≥ bi√™n b·∫£n li√™n quan, kh√¥ng th·ªÉ x√≥a");
        }

        entity.setIsDeleted(true);
        entity.setDeletedAt(java.time.LocalDateTime.now());
        // entity.setDeletedByUser(currentUser); // N·∫øu c√≥ SecurityContext
        repository.save(entity);
        log.info("[Transaction] ƒê√£ x√≥a m·ªÅm th√†nh c√¥ng h√≥a ƒë∆°n ID: {}", id);
    }

    @Transactional
    public void hardDelete(Long id) {
        log.warn("[Transaction] C·∫¢NH B√ÅO: Th·ª±c hi·ªán x√≥a c·ª©ng h√≥a ƒë∆°n ID: {}", id);
        EinvInvoiceMetadataEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng"));

        if (entity.getInvoiceStatus().getId() != 1) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "L·ªánh x√≥a c·ª©ng b·ªã ch·∫∑n: H√≥a ƒë∆°n kh√¥ng ph·∫£i tr·∫°ng th√°i Nh√°p");
        }

        if (adjustmentRepository.existsByOriginalInvoiceId(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Vi ph·∫°m r√†ng bu·ªôc: H√≥a ƒë∆°n ƒëang c√≥ bi√™n b·∫£n thay th·∫ø/ƒëi·ªÅu ch·ªânh");
        }
        itemRepository.deleteByInvoiceId(id);
        log.debug("[Transaction] ƒê√£ d·ªçn d·∫πp chi ti·∫øt h√†ng h√≥a c·ªßa h√≥a ƒë∆°n ID: {}", id);
        repository.delete(entity);
        log.info("[Transaction] ƒê√£ x√≥a vƒ©nh vi·ªÖn h√≥a ƒë∆°n ID: {} kh·ªèi Database", id);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvInvoicePayloadService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.EinvInvoiceMetadataEntity;
import com.einvoicehub.core.domain.entity.EinvInvoicePayloadEntity;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.domain.repository.EinvInvoicePayloadRepository;
import com.einvoicehub.core.dto.EinvInvoicePayloadDto;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvInvoicePayloadService {

    private final EinvInvoicePayloadRepository repository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvInvoicePayloadDto> getAll() {
        log.info("[Infra] Truy v·∫•n danh s√°ch payload k·ªπ thu·∫≠t");
        return repository.findAll().stream()
                .map(mapper::toDto)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvInvoicePayloadDto getById(Long invoiceId) {
        log.info("[Infra] L·∫•y d·ªØ li·ªáu payload cho h√≥a ƒë∆°n ID: {}", invoiceId);
        return repository.findByInvoiceId(invoiceId)
                .map(mapper::toDto)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n ch∆∞a c√≥ d·ªØ li·ªáu k·ªπ thu·∫≠t"));
    }

    @Transactional
    public EinvInvoicePayloadDto create(EinvInvoicePayloadDto dto) {
        log.info("[Infra] ƒêang kh·ªüi t·∫°o Payload cho h√≥a ƒë∆°n ID: {}", dto.getInvoiceId());
        EinvInvoiceMetadataEntity invoice = metadataRepository.findById(dto.getInvoiceId())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n g·ªëc kh√¥ng t·ªìn t·∫°i"));

        if (Boolean.TRUE.equals(invoice.getMerchant().getIsDeleted())) {
            throw new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND, "Doanh nghi·ªáp ƒë√£ b·ªã kh√≥a, kh√¥ng th·ªÉ t·∫°o d·ªØ li·ªáu");
        }

        if (repository.existsById(dto.getInvoiceId())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Payload cho h√≥a ƒë∆°n n√†y ƒë√£ t·ªìn t·∫°i");
        }

        EinvInvoicePayloadEntity entity = mapper.toEntity(dto);
        entity.setInvoice(invoice);

        entity = repository.save(entity);
        log.info("[Infra] ƒê√£ l∆∞u th√†nh c√¥ng Payload cho h√≥a ƒë∆°n ID: {}", entity.getInvoiceId());
        return mapper.toDto(entity);
    }

    @Transactional
    public EinvInvoicePayloadDto update(Long invoiceId, EinvInvoicePayloadDto dto) {
        log.info("[Infra] C·∫≠p nh·∫≠t n·ªôi dung k√Ω s·ªë cho h√≥a ƒë∆°n ID: {}", invoiceId);

        EinvInvoicePayloadEntity entity = repository.findByInvoiceId(invoiceId)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y payload ƒë·ªÉ c·∫≠p nh·∫≠t"));

        if (entity.getInvoice().getInvoiceStatus().getId() == 5) {
            log.error("[Infra] Ch·∫∑n thao t√°c s·ª≠a d·ªØ li·ªáu h√≥a ƒë∆°n ƒë√£ ph√°t h√†nh th√†nh c√¥ng: {}", invoiceId);
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n ƒë√£ ho√†n t·∫•t, kh√¥ng ƒë∆∞·ª£c ph√©p thay ƒë·ªïi n·ªôi dung k·ªπ thu·∫≠t");
        }
        entity.setSignedXml(dto.getSignedXml());
        entity.setPdfData(dto.getPdfData());
        entity.setJsonContent(dto.getJsonContent());

        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Long invoiceId) {
        log.warn("[Infra] Y√™u c·∫ßu x√≥a vƒ©nh vi·ªÖn Payload h√≥a ƒë∆°n ID: {}", invoiceId);

        EinvInvoicePayloadEntity entity = repository.findByInvoiceId(invoiceId)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i"));

        if (entity.getInvoice().getInvoiceStatus().getId() != 1) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Ch·ªâ ƒë∆∞·ª£c ph√©p x√≥a d·ªØ li·ªáu k·ªπ thu·∫≠t c·ªßa h√≥a ƒë∆°n Nh√°p");
        }
        repository.delete(entity);
        log.info("[Infra] ƒê√£ x√≥a th√†nh c√¥ng Payload c·ªßa h√≥a ƒë∆°n ID: {}", invoiceId);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvInvoiceRegistrationService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.EinvInvoiceRegistrationEntity;
import com.einvoicehub.core.domain.entity.EinvMerchantEntity;
import com.einvoicehub.core.domain.entity.EinvRegistrationStatusEntity;
import com.einvoicehub.core.domain.repository.EinvInvoiceRegistrationRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceTemplateRepository;
import com.einvoicehub.core.domain.repository.EinvMerchantRepository;
import com.einvoicehub.core.domain.repository.EinvRegistrationStatusRepository;
import com.einvoicehub.core.dto.EinvInvoiceRegistrationRequest;
import com.einvoicehub.core.dto.EinvInvoiceRegistrationResponse;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvInvoiceRegistrationService {

    private final EinvInvoiceRegistrationRepository repository;
    private final EinvMerchantRepository merchantRepository;
    private final EinvRegistrationStatusRepository statusRepository;
    private final EinvInvoiceTemplateRepository templateRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvInvoiceRegistrationResponse> getAll() {
        log.info("[Registration] L·∫•y danh s√°ch to√†n b·ªô c√°c d·∫£i s·ªë ƒë√£ ƒëƒÉng k√Ω");
        return repository.findAll().stream()
                .map(mapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvInvoiceRegistrationResponse getById(Long id) {
        log.info("[Registration] Truy v·∫•n chi ti·∫øt ƒëƒÉng k√Ω ID: {}", id);
        return repository.findById(id)
                .map(mapper::toResponse)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y d·∫£i s·ªë ƒëƒÉng k√Ω"));
    }

    @Transactional
    public EinvInvoiceRegistrationResponse create(EinvInvoiceRegistrationRequest request) {
        log.info("[Registration] ƒêang t·∫°o ƒëƒÉng k√Ω m·ªõi cho Merchant ID: {}, S·ªë TB: {}",
                request.getMerchantId(), request.getRegistrationNumber());

        // 1. Ki·ªÉm tra tr·∫°ng th√°i Merchant (Ph·∫£i c√≤n ho·∫°t ƒë·ªông)
        EinvMerchantEntity merchant = merchantRepository.findById(request.getMerchantId())
                .filter(m -> !m.getIsDeleted())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND));

        // 2. Validate d·∫£i s·ªë: From <= To v√† Quantity kh·ªõp
        validateRange(request.getFromNumber(), request.getToNumber(), request.getQuantity());

        // 3. Ki·ªÉm tra tr·∫°ng th√°i ƒëƒÉng k√Ω
        EinvRegistrationStatusEntity status = statusRepository.findById(request.getStatusId())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Tr·∫°ng th√°i ƒëƒÉng k√Ω kh√¥ng h·ª£p l·ªá"));

        EinvInvoiceRegistrationEntity entity = mapper.toEntity(request);
        entity.setMerchant(merchant);
        entity.setStatus(status);
        entity.setCurrentNumber(0L); // Kh·ªüi t·∫°o s·ªë ƒë√£ d√πng l√† 0

        entity = repository.save(entity);
        log.info("[Registration] ƒê√£ l∆∞u th√†nh c√¥ng d·∫£i s·ªë ID: {}", entity.getId());
        return mapper.toResponse(entity);
    }

    @Transactional
    public EinvInvoiceRegistrationResponse update(Long id, EinvInvoiceRegistrationRequest request) {
        log.info("[Registration] C·∫≠p nh·∫≠t ƒëƒÉng k√Ω ID: {}", id);

        EinvInvoiceRegistrationEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "D·ªØ li·ªáu kh√¥ng t·ªìn t·∫°i"));

        if (Boolean.TRUE.equals(entity.getMerchant().getIsDeleted())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Doanh nghi·ªáp ƒë√£ ng·ª´ng ho·∫°t ƒë·ªông, kh√¥ng th·ªÉ s·ª≠a");
        }

        validateRange(request.getFromNumber(), request.getToNumber(), request.getQuantity());

        entity.setRegistrationNumber(request.getRegistrationNumber());
        entity.setFromNumber(request.getFromNumber());
        entity.setToNumber(request.getToNumber());
        entity.setQuantity(request.getQuantity());
        entity.setEffectiveDate(request.getEffectiveDate());
        entity.setExpirationDate(request.getExpirationDate());
        entity.setIssuedBy(request.getIssuedBy());
        entity.setNote(request.getNote());

        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Registration] Y√™u c·∫ßu x√≥a d·∫£i s·ªë ID: {}", id);

        if (!repository.existsById(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i");
        }

        // Ki·ªÉm tra r√†ng bu·ªôc tham chi·∫øu t·ª´ b·∫£ng invoice_template
        if (templateRepository.existsByRegistrationId(id)) {
            log.error("[Registration] X√≥a th·∫•t b·∫°i: D·∫£i s·ªë ID {} ƒëang ƒë∆∞·ª£c d√πng trong M·∫´u h√≥a ƒë∆°n", id);
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "D·∫£i s·ªë n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ c·∫•u h√¨nh m·∫´u h√≥a ƒë∆°n, kh√¥ng th·ªÉ x√≥a");
        }

        repository.deleteById(id);
        log.info("[Registration] ƒê√£ x√≥a th√†nh c√¥ng d·∫£i s·ªë ID: {}", id);
    }

    private void validateRange(Long from, Long to, Long qty) {
        if (from == null || to == null || from > to) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "D·∫£i s·ªë kh√¥ng h·ª£p l·ªá (S·ªë b·∫Øt ƒë·∫ßu ph·∫£i nh·ªè h∆°n ho·∫∑c b·∫±ng s·ªë k·∫øt th√∫c)");
        }
        if (qty != null && (to - from + 1) != qty) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "S·ªë l∆∞·ª£ng kh√¥ng kh·ªõp v·ªõi d·∫£i s·ªë (To - From + 1 != Quantity)");
        }
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvInvoiceStatusService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.domain.entity.EinvInvoiceStatusEntity;
import com.einvoicehub.core.domain.repository.EinvInvoiceStatusRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.dto.EinvInvoiceStatusDto;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvInvoiceStatusService {

    private final EinvInvoiceStatusRepository repository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvInvoiceStatusDto> getAll() {
        log.info("[Catalog] L·∫•y danh m·ª•c tr·∫°ng th√°i h√≥a ƒë∆°n");
        return repository.findAll().stream().map(mapper::toDto).collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvInvoiceStatusDto getById(Integer id) {
        log.info("[Catalog] T√¨m tr·∫°ng th√°i ID: {}", id);
        return repository.findById(id).map(mapper::toDto)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Tr·∫°ng th√°i kh√¥ng t·ªìn t·∫°i"));
    }

    @Transactional
    public EinvInvoiceStatusDto create(EinvInvoiceStatusDto dto) {
        log.info("[Catalog] Th√™m m·ªõi tr·∫°ng th√°i: {}", dto.getName());
        if (repository.findByName(dto.getName()).isPresent()) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "T√™n tr·∫°ng th√°i ƒë√£ t·ªìn t·∫°i");
        }
        EinvInvoiceStatusEntity entity = mapper.toEntity(dto);
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public EinvInvoiceStatusDto update(Integer id, EinvInvoiceStatusDto dto) {
        log.info("[Catalog] C·∫≠p nh·∫≠t tr·∫°ng th√°i ID: {}", id);
        EinvInvoiceStatusEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y tr·∫°ng th√°i"));
        entity.setName(dto.getName());
        entity.setDescription(dto.getDescription());
        entity.setNote(dto.getNote());
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Integer id) {
        log.warn("[Catalog] X√≥a tr·∫°ng th√°i ID: {}", id);
        if (metadataRepository.existsByStatusId(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "D·ªØ li·ªáu ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng trong Metadata h√≥a ƒë∆°n");
        }
        repository.deleteById(id);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvInvoiceSyncQueueService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.EinvInvoiceMetadataEntity;
import com.einvoicehub.core.domain.entity.EinvInvoiceSyncQueueEntity;
import com.einvoicehub.core.domain.entity.enums.SyncStatus;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceSyncQueueRepository;
import com.einvoicehub.core.dto.response.EinvInvoiceSyncQueueResponse;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvInvoiceSyncQueueService {

    private final EinvInvoiceSyncQueueRepository repository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvInvoiceSyncQueueResponse> getAll() {
        log.info("[Queue] L·∫•y danh s√°ch h√†ng ƒë·ª£i ƒë·ªìng b·ªô");
        return repository.findAll().stream()
                .map(mapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvInvoiceSyncQueueResponse getById(Long id) {
        log.info("[Queue] Truy v·∫•n y√™u c·∫ßu ƒë·ªìng b·ªô ID: {}", id);
        return repository.findById(id).map(mapper::toResponse)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Y√™u c·∫ßu ƒë·ªìng b·ªô kh√¥ng t·ªìn t·∫°i"));
    }

    @Transactional
    public EinvInvoiceSyncQueueResponse create(EinvInvoiceSyncQueueResponse dto) {
        log.info("[Queue] Th√™m m·ªõi y√™u c·∫ßu ƒë·ªìng b·ªô cho h√≥a ƒë∆°n ID: {}", dto.getInvoiceId());

        EinvInvoiceMetadataEntity invoice = metadataRepository.findById(dto.getInvoiceId())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n g·ªëc kh√¥ng t·ªìn t·∫°i"));

        //Ki·ªÉm tra doanh nghi·ªáp ph·∫£i c√≤n ho·∫°t ƒë·ªông m·ªõi ƒë∆∞·ª£c ƒë·ªìng b·ªô
        if (Boolean.TRUE.equals(invoice.getMerchant().getIsDeleted())) {
            throw new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND, "Doanh nghi·ªáp ƒë√£ ng·ª´ng ho·∫°t ƒë·ªông");
        }

        EinvInvoiceSyncQueueEntity entity = mapper.toEntity(dto);
        entity.setInvoice(invoice);
        entity.setAttemptCount(0); // Kh·ªüi t·∫°o s·ªë l·∫ßn th·ª≠ l·∫°i l√† 0

        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public EinvInvoiceSyncQueueResponse update(Long id, EinvInvoiceSyncQueueResponse dto) {
        log.info("[Queue] C·∫≠p nh·∫≠t tr·∫°ng th√°i x·ª≠ l√Ω y√™u c·∫ßu ID: {}", id);
        EinvInvoiceSyncQueueEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i"));

        entity.setStatus(SyncStatus.valueOf(dto.getStatus()));
        entity.setErrorMessage(dto.getErrorMessage());
        entity.setAttemptCount(dto.getAttemptCount());
        entity.setProcessedBy(dto.getProcessedBy());

        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Queue] Y√™u c·∫ßu x√≥a kh·ªèi h√†ng ƒë·ª£i ID: {}", id);
        EinvInvoiceSyncQueueEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i"));

        // R√†ng bu·ªôc:kh√¥ng x√≥a y√™u c·∫ßu ƒëang ƒë∆∞·ª£c worker x·ª≠ l√Ω
        if (SyncStatus.PROCESSING.equals(entity.getStatus())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Y√™u c·∫ßu ƒëang trong ti·∫øn tr√¨nh x·ª≠ l√Ω, kh√¥ng th·ªÉ x√≥a");
        }

        repository.delete(entity);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvInvoiceTaxBreakdownService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.EinvInvoiceMetadataEntity;
import com.einvoicehub.core.domain.entity.EinvInvoiceTaxBreakDownEntity;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceTaxBreakdownRepository;
import com.einvoicehub.core.dto.EinvInvoiceTaxBreakdownDto;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvInvoiceTaxBreakdownService {

    private final EinvInvoiceTaxBreakdownRepository repository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvInvoiceTaxBreakdownDto> getAllByInvoiceId(Long invoiceId) {
        log.info("[TaxBreakdown] Truy v·∫•n danh s√°ch ph√¢n r√£ thu·∫ø cho h√≥a ƒë∆°n ID: {}", invoiceId);
        return repository.findByInvoiceId(invoiceId).stream()
                .map(mapper::toDto)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvInvoiceTaxBreakdownDto getById(Long id) {
        log.info("[TaxBreakdown] L·∫•y chi ti·∫øt ph√¢n r√£ thu·∫ø ID: {}", id);
        return repository.findById(id).map(mapper::toDto)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "D·ªØ li·ªáu thu·∫ø kh√¥ng t·ªìn t·∫°i"));
    }

    @Transactional
    public EinvInvoiceTaxBreakdownDto create(Long invoiceId, EinvInvoiceTaxBreakdownDto dto) {
        log.info("[TaxBreakdown] T·∫°o m·ªõi ph√¢n r√£ thu·∫ø cho h√≥a ƒë∆°n ID: {}", invoiceId);
        EinvInvoiceMetadataEntity invoice = metadataRepository.findById(invoiceId)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n g·ªëc kh√¥ng t·ªìn t·∫°i"));

        if (Boolean.TRUE.equals(invoice.getMerchant().getIsDeleted())) {
            throw new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND, "Doanh nghi·ªáp ƒë√£ ng·ª´ng ho·∫°t ƒë·ªông");
        }
        if (invoice.getInvoiceStatus().getId() != 1) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng th·ªÉ s·ª≠a ƒë·ªïi th√¥ng tin thu·∫ø c·ªßa h√≥a ƒë∆°n ƒë√£ ch·ªët");
        }

        EinvInvoiceTaxBreakDownEntity entity = new EinvInvoiceTaxBreakDownEntity();
        entity.setInvoice(invoice);
        entity.setVatRateCode(dto.getVatRateCode());
        entity.setVatRatePercent(dto.getVatRatePercent());

        calculateBreakdownAmounts(entity, dto);

        entity = repository.save(entity);
        return mapper.toDto(entity);
    }

    @Transactional
    public EinvInvoiceTaxBreakdownDto update(Long id, EinvInvoiceTaxBreakdownDto dto) {
        log.info("[TaxBreakdown] C·∫≠p nh·∫≠t ph√¢n r√£ thu·∫ø ID: {}", id);
        EinvInvoiceTaxBreakDownEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i"));

        if (entity.getInvoice().getInvoiceStatus().getId() != 1) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng ƒë∆∞·ª£c ph√©p c·∫≠p nh·∫≠t thu·∫ø cho h√≥a ƒë∆°n ƒë√£ ph√°t h√†nh");
        }

        entity.setVatRateCode(dto.getVatRateCode());
        entity.setVatRatePercent(dto.getVatRatePercent());
        calculateBreakdownAmounts(entity, dto);

        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[TaxBreakdown] Y√™u c·∫ßu x√≥a ph√¢n r√£ thu·∫ø ID: {}", id);
        EinvInvoiceTaxBreakDownEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë·ªÉ x√≥a"));

        if (entity.getInvoice().getInvoiceStatus().getId() != 1) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng th·ªÉ x√≥a d√≤ng thu·∫ø c·ªßa h√≥a ƒë∆°n ƒë√£ ho√†n t·∫•t");
        }

        repository.delete(entity);
    }

    private void calculateBreakdownAmounts(EinvInvoiceTaxBreakDownEntity entity, EinvInvoiceTaxBreakdownDto dto) {
        BigDecimal taxable = dto.getTaxableAmount() != null ? dto.getTaxableAmount() : BigDecimal.ZERO;
        BigDecimal taxRate = entity.getVatRatePercent().divide(new BigDecimal("100"), 4, RoundingMode.HALF_UP);

        BigDecimal taxAmount = taxable.multiply(taxRate).setScale(2, RoundingMode.HALF_UP);
        entity.setTaxableAmount(taxable);
        entity.setTaxAmount(taxAmount);
        entity.setTotalAmount(taxable.add(taxAmount));
        entity.setSubtotalAmount(taxable);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvInvoiceTemplateService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.*;
import com.einvoicehub.core.domain.repository.*;
import com.einvoicehub.core.dto.EinvInvoiceTemplateRequest;
import com.einvoicehub.core.dto.EinvInvoiceTemplateResponse;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvInvoiceTemplateService {

    private final EinvInvoiceTemplateRepository repository;
    private final EinvMerchantRepository merchantRepository;
    private final EinvInvoiceTypeRepository typeRepository;
    private final EinvInvoiceRegistrationRepository registrationRepository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvInvoiceTemplateResponse> getAllByMerchant(Long merchantId) {
        log.info("[Template] L·∫•y danh s√°ch m·∫´u h√≥a ƒë∆°n cho Merchant ID: {}", merchantId);
        return repository.searchTemplates(merchantId, null).stream()
                .map(mapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvInvoiceTemplateResponse getById(Long id) {
        return repository.findWithDetailsById(id)
                .map(mapper::toResponse)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh m·∫´u h√≥a ƒë∆°n"));
    }

    @Transactional
    public EinvInvoiceTemplateResponse create(EinvInvoiceTemplateRequest request) {
        log.info("[Template] ƒêang c·∫•u h√¨nh m·∫´u m·ªõi cho Merchant ID: {}, K√Ω hi·ªáu: {}",
                request.getMerchantId(), request.getSymbolCode());

        EinvMerchantEntity merchant = merchantRepository.findById(request.getMerchantId())
                .filter(m -> !m.getIsDeleted())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND));

        EinvInvoiceTypeEntity type = typeRepository.findById(request.getInvoiceTypeId())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Lo·∫°i h√≥a ƒë∆°n kh√¥ng t·ªìn t·∫°i"));

        EinvInvoiceRegistrationEntity registration = null;
        if (request.getRegistrationId() != null) {
            registration = registrationRepository.findById(request.getRegistrationId())
                    .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "D·∫£i s·ªë ƒëƒÉng k√Ω kh√¥ng t·ªìn t·∫°i"));

            validateTemplateRangeAgainstRegistration(request.getMinNumber(), request.getMaxNumber(), registration);
        }

        EinvInvoiceTemplateEntity entity = mapper.toEntity(request);
        entity.setMerchant(merchant);
        entity.setInvoiceType(type);
        entity.setRegistration(registration);
        entity.setCurrentNumber(0);

        entity = repository.save(entity);
        log.info("[Template] ƒê√£ t·∫°o th√†nh c√¥ng m·∫´u h√≥a ƒë∆°n ID: {}", entity.getId());
        return mapper.toResponse(entity);
    }

    @Transactional
    public EinvInvoiceTemplateResponse update(Long id, EinvInvoiceTemplateRequest request) {
        log.info("[Template] C·∫≠p nh·∫≠t m·∫´u h√≥a ƒë∆°n ID: {}", id);

        EinvInvoiceTemplateEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "D·ªØ li·ªáu kh√¥ng t·ªìn t·∫°i"));

        if (Boolean.TRUE.equals(entity.getMerchant().getIsDeleted())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Merchant ƒë√£ b·ªã kh√≥a");
        }

        entity.setTemplateCode(request.getTemplateCode());
        entity.setSymbolCode(request.getSymbolCode());
        entity.setIsActive(request.getIsActive());
        entity.setStartDate(request.getStartDate());
        entity.setProviderId(request.getProviderId());
        entity.setProviderSerialId(request.getProviderSerialId());

        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Template] Y√™u c·∫ßu x√≥a m·∫´u h√≥a ƒë∆°n ID: {}", id);

        if (!repository.existsById(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i");
        }

        if (metadataRepository.existsByTemplateId(id)) {
            log.error("[Template] X√≥a th·∫•t b·∫°i: M·∫´u ID {} ƒë√£ ph√°t sinh d·ªØ li·ªáu h√≥a ƒë∆°n", id);
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "M·∫´u h√≥a ƒë∆°n n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ ph√°t h√†nh h√≥a ƒë∆°n, kh√¥ng th·ªÉ x√≥a");
        }

        repository.deleteById(id);
        log.info("[Template] ƒê√£ x√≥a th√†nh c√¥ng m·∫´u h√≥a ƒë∆°n ID: {}", id);
    }

    private void validateTemplateRangeAgainstRegistration(Integer min, Integer max, EinvInvoiceRegistrationEntity reg) {
        if (min == null || max == null || min > max) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Gi·ªõi h·∫°n s·ªë h√≥a ƒë∆°n kh√¥ng h·ª£p l·ªá");
        }
        if (min < reg.getFromNumber() || max > reg.getToNumber()) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA,
                    String.format("D·∫£i s·ªë c·ªßa m·∫´u (%d-%d) ph·∫£i n·∫±m trong d·∫£i s·ªë ƒë√£ ƒëƒÉng k√Ω (%d-%d)",
                            min, max, reg.getFromNumber(), reg.getToNumber()));
        }
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvInvoiceTypeService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.domain.entity.EinvInvoiceTypeEntity;
import com.einvoicehub.core.domain.repository.EinvInvoiceTypeRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceTemplateRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.dto.EinvInvoiceTypeDto;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvInvoiceTypeService {

    private final EinvInvoiceTypeRepository repository;
    private final EinvInvoiceTemplateRepository templateRepository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvInvoiceTypeDto> getAll() {
        log.info("[Catalog] L·∫•y to√†n b·ªô danh m·ª•c lo·∫°i h√≥a ƒë∆°n");
        return repository.findAll().stream().map(mapper::toDto).collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvInvoiceTypeDto getById(Long id) {
        log.info("[Catalog] L·∫•y chi ti·∫øt lo·∫°i h√≥a ƒë∆°n ID: {}", id);
        return repository.findById(id).map(mapper::toDto)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Lo·∫°i h√≥a ƒë∆°n kh√¥ng t·ªìn t·∫°i"));
    }

    @Transactional
    public EinvInvoiceTypeDto create(EinvInvoiceTypeDto dto) {
        log.info("[Catalog] T·∫°o m·ªõi lo·∫°i h√≥a ƒë∆°n: {}", dto.getTypeCode());
        if (repository.findByTypeCode(dto.getTypeCode()).isPresent()) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "M√£ lo·∫°i h√≥a ƒë∆°n " + dto.getTypeCode() + " ƒë√£ t·ªìn t·∫°i");
        }
        EinvInvoiceTypeEntity entity = mapper.toEntity(dto);
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public EinvInvoiceTypeDto update(Long id, EinvInvoiceTypeDto dto) {
        log.info("[Catalog] C·∫≠p nh·∫≠t lo·∫°i h√≥a ƒë∆°n ID: {}", id);
        EinvInvoiceTypeEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "D·ªØ li·ªáu kh√¥ng t·ªìn t·∫°i"));

        entity.setTypeName(dto.getTypeName());
        entity.setDescription(dto.getDescription());
        entity.setIsActive(dto.getIsActive());
        entity.setDisplayOrder(dto.getDisplayOrder());
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Catalog] Y√™u c·∫ßu x√≥a lo·∫°i h√≥a ƒë∆°n ID: {}", id);
        EinvInvoiceTypeEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i"));

        if (templateRepository.existsByInvoiceTypeId(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng th·ªÉ x√≥a v√¨ ƒë√£ c√≥ M·∫´u h√≥a ƒë∆°n tham chi·∫øu");
        }
        if (metadataRepository.existsByInvoiceTypeCode(entity.getTypeCode())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng th·ªÉ x√≥a v√¨ ƒë√£ c√≥ H√≥a ƒë∆°n ph√°t sinh m√£ n√†y");
        }

        repository.delete(entity);
        log.info("[Catalog] ƒê√£ x√≥a lo·∫°i h√≥a ƒë∆°n: {}", entity.getTypeCode());
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvMerchantProviderConfigService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.EinvMerchantEntity;
import com.einvoicehub.core.domain.entity.EinvMerchantProviderConfigEntity;
import com.einvoicehub.core.domain.entity.EinvServiceProviderEntity;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.domain.repository.EinvMerchantProviderConfigRepository;
import com.einvoicehub.core.domain.repository.EinvMerchantRepository;
import com.einvoicehub.core.domain.repository.EinvServiceProviderRepository;
import com.einvoicehub.core.dto.EinvMerchantProviderConfigRequest;
import com.einvoicehub.core.dto.EinvMerchantProviderConfigResponse;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvMerchantProviderConfigService {

    private final EinvMerchantProviderConfigRepository repository;
    private final EinvMerchantRepository merchantRepository;
    private final EinvServiceProviderRepository providerRepository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvMerchantProviderConfigResponse> getAll() {
        log.info("[Config] ƒêang truy v·∫•n danh s√°ch to√†n b·ªô c·∫•u h√¨nh k·∫øt n·ªëi h·ªá th·ªëng");
        return repository.findAll().stream()
                .map(mapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public List<EinvMerchantProviderConfigResponse> getByMerchantId(Long merchantId) {
        log.info("[Config] ƒêang truy v·∫•n danh s√°ch c·∫•u h√¨nh k·∫øt n·ªëi cho Merchant ID: {}", merchantId);
        return repository.searchConfigs(merchantId, null).stream()
                .map(mapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvMerchantProviderConfigResponse getById(Long id) {
        log.info("[Config] Truy v·∫•n chi ti·∫øt c·∫•u h√¨nh ID: {}", id);
        return repository.findById(id)
                .map(mapper::toResponse)
                .orElseThrow(() -> {
                    log.error("[Config] Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh v·ªõi ID: {}", id);
                    return new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh k·∫øt n·ªëi");
                });
    }

    @Transactional
    public EinvMerchantProviderConfigResponse create(EinvMerchantProviderConfigRequest request) {
        log.info("[Config] ƒêang t·∫°o c·∫•u h√¨nh m·ªõi cho Merchant {} v·ªõi Provider {}",
                request.getMerchantId(), request.getProviderId());

        EinvMerchantEntity merchant = merchantRepository.findById(request.getMerchantId())
                .filter(m -> !m.getIsDeleted())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND));

        EinvServiceProviderEntity provider = providerRepository.findById(request.getProviderId())
                .filter(EinvServiceProviderEntity::getIsActive)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Nh√† cung c·∫•p kh√¥ng t·ªìn t·∫°i ho·∫∑c ng·ª´ng h·ªó tr·ª£"));

        if (repository.existsByMerchantIdAndProviderId(request.getMerchantId(), request.getProviderId())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Doanh nghi·ªáp ƒë√£ c·∫•u h√¨nh t√†i kho·∫£n cho nh√† cung c·∫•p n√†y");
        }

        EinvMerchantProviderConfigEntity entity = mapper.toEntity(request);
        entity.setMerchant(merchant);
        entity.setProvider(provider);

        entity.setPasswordServiceEncrypted("ENC_" + request.getPasswordService());

        handleDefaultConfigLogic(merchant.getId(), request.getIsDefault(), entity);

        entity = repository.save(entity);
        log.info("[Config] ƒê√£ t·∫°o th√†nh c√¥ng c·∫•u h√¨nh k·∫øt n·ªëi ID: {}", entity.getId());
        return mapper.toResponse(entity);
    }

    @Transactional
    public EinvMerchantProviderConfigResponse update(Long id, EinvMerchantProviderConfigRequest request) {
        log.info("[Config] ƒêang c·∫≠p nh·∫≠t c·∫•u h√¨nh ID: {}", id);

        EinvMerchantProviderConfigEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "D·ªØ li·ªáu kh√¥ng t·ªìn t·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t"));

        if (Boolean.TRUE.equals(entity.getMerchant().getIsDeleted())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Doanh nghi·ªáp ƒë√£ ng·ª´ng ho·∫°t ƒë·ªông, kh√¥ng ƒë∆∞·ª£c s·ª≠a c·∫•u h√¨nh");
        }

        entity.setPartnerId(request.getPartnerId());
        entity.setPartnerToken(request.getPartnerToken());
        entity.setTaxCode(request.getTaxCode());
        entity.setIntegrationUrl(request.getIntegrationUrl());
        entity.setUsernameService(request.getUsernameService());
        entity.setIsTestMode(request.getIsTestMode());
        entity.setIsActive(request.getIsActive());
        entity.setExtraConfig(request.getExtraConfig());

        if (request.getPasswordService() != null && !request.getPasswordService().isBlank()) {
            entity.setPasswordServiceEncrypted("ENC_UPDATED_" + request.getPasswordService());
        }

        handleDefaultConfigLogic(entity.getMerchant().getId(), request.getIsDefault(), entity);

        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Config] ƒêang th·ª±c hi·ªán y√™u c·∫ßu x√≥a c·∫•u h√¨nh ID: {}", id);

        if (!repository.existsById(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i");
        }

       if (metadataRepository.existsByProviderConfigId(id)) {
            log.error("[Config] X√≥a th·∫•t b·∫°i: C·∫•u h√¨nh ID {} ƒë√£ ph√°t sinh d·ªØ li·ªáu h√≥a ƒë∆°n", id);
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng th·ªÉ x√≥a c·∫•u h√¨nh ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ ph√°t h√†nh h√≥a ƒë∆°n");
        }

        repository.deleteById(id);
        log.info("[Config] ƒê√£ x√≥a th√†nh c√¥ng c·∫•u h√¨nh ID: {}", id);
    }

    /**
     * Logic n·ªôi b·ªô ƒë·∫£m b·∫£o t·∫°i m·ªói th·ªùi ƒëi·ªÉm ch·ªâ c√≥ 1 c·∫•u h√¨nh m·∫∑c ƒë·ªãnh duy nh·∫•t cho m·ªói Merchant.
     */
    private void handleDefaultConfigLogic(Long merchantId, Boolean isNewDefault, EinvMerchantProviderConfigEntity currentEntity) {
        if (Boolean.TRUE.equals(isNewDefault)) {
            // T√¨m c·∫•u h√¨nh m·∫∑c ƒë·ªãnh c≈© v√† g·ª° b·ªè
            repository.findByMerchantIdAndIsDefaultTrueAndIsActiveTrue(merchantId).ifPresent(oldDefault -> {
                if (!oldDefault.getId().equals(currentEntity.getId())) {
                    oldDefault.setIsDefault(false);
                    repository.save(oldDefault);
                    log.debug("[Config] ƒê√£ t·∫Øt tr·∫°ng th√°i m·∫∑c ƒë·ªãnh c·ªßa c·∫•u h√¨nh c≈© ID: {}", oldDefault.getId());
                }
            });
            currentEntity.setIsDefault(true);
        } else {
            currentEntity.setIsDefault(false);
        }
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvMerchantService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.domain.entity.EinvMerchantEntity;
import com.einvoicehub.core.domain.repository.EinvMerchantRepository;
import com.einvoicehub.core.domain.repository.EinvMerchantUserRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.dto.EinvMerchantRequest;
import com.einvoicehub.core.dto.EinvMerchantResponse;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvMerchantService {

    private final EinvMerchantRepository repository;
    private final EinvMerchantUserRepository userRepository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvMerchantResponse> getAll() {
        log.info("[Merchant] L·∫•y danh s√°ch doanh nghi·ªáp ƒëang ho·∫°t ƒë·ªông");
        return repository.findAll().stream()
                .filter(m -> !m.getIsDeleted())
                .map(mapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvMerchantResponse getById(Long id) {
        log.info("[Merchant] Truy v·∫•n th√¥ng tin doanh nghi·ªáp ID: {}", id);
        return repository.findById(id)
                .filter(m -> !m.getIsDeleted())
                .map(mapper::toResponse)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND));
    }

    @Transactional
    public EinvMerchantResponse create(EinvMerchantRequest request) {
        log.info("[Merchant] ƒêƒÉng k√Ω doanh nghi·ªáp m·ªõi v·ªõi MST: {}", request.getTaxCode());

        // 1. Ki·ªÉm tra MST ƒë√£ t·ªìn t·∫°i v√† ch∆∞a b·ªã x√≥a
        if (repository.existsByTaxCodeAndIsDeletedFalse(request.getTaxCode())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "M√£ s·ªë thu·∫ø n√†y ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω tr√™n h·ªá th·ªëng");
        }

        EinvMerchantEntity entity = mapper.toEntity(request);
        // Thi·∫øt l·∫≠p c√°c gi√° tr·ªã m·∫∑c ƒë·ªãnh theo SOFTZ
        entity.setIsDeleted(false);
        entity = repository.save(entity);

        return mapper.toResponse(entity);
    }

    @Transactional
    public EinvMerchantResponse update(Long id, EinvMerchantRequest request) {
        log.info("[Merchant] C·∫≠p nh·∫≠t th√¥ng tin doanh nghi·ªáp ID: {}", id);
        EinvMerchantEntity entity = repository.findById(id)
                .filter(m -> !m.getIsDeleted())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND));

        // 2. C·∫≠p nh·∫≠t c√°c tr∆∞·ªùng th√¥ng tin c∆° b·∫£n
        entity.setCompanyName(request.getCompanyName());
        entity.setShortName(request.getShortName());
        entity.setAddress(request.getAddress());
        entity.setEmail(request.getEmail());
        entity.setPhone(request.getPhone());
        entity.setRepresentativeName(request.getRepresentativeName());
        entity.setTaxAuthorityCode(request.getTaxAuthorityCode());

        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Merchant] Y√™u c·∫ßu x√≥a doanh nghi·ªáp ID: {}", id);
        EinvMerchantEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND));
        // 3. Ki·ªÉm tra r√†ng bu·ªôc giao d·ªãch tr∆∞·ªõc khi x√≥a
        if (metadataRepository.existsByMerchantId(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng th·ªÉ x√≥a doanh nghi·ªáp ƒë√£ ph√°t sinh h√≥a ƒë∆°n");
        }
        // 4. Soft Delete
        entity.setIsDeleted(true);
        entity.setDeletedAt(LocalDateTime.now());
        repository.save(entity);
        log.info("[Merchant] ƒê√£ th·ª±c hi·ªán x√≥a m·ªÅm doanh nghi·ªáp ID: {}", id);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvMerchantUserService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.domain.entity.EinvMerchantEntity;
import com.einvoicehub.core.domain.entity.EinvMerchantUserEntity;
import com.einvoicehub.core.domain.repository.EinvMerchantRepository;
import com.einvoicehub.core.domain.repository.EinvMerchantUserRepository;
import com.einvoicehub.core.dto.EinvMerchantUserRequest;
import com.einvoicehub.core.dto.EinvMerchantUserResponse;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvMerchantUserService {

    private final EinvMerchantUserRepository repository;
    private final EinvMerchantRepository merchantRepository;
    private final EinvHubMapper mapper;

    // L∆∞u √Ω: Trong th·ª±c t·∫ø h√£y Inject PasswordEncoder t·ª´ Spring Security
    // private final PasswordEncoder passwordEncoder;

    @Transactional(readOnly = true)
    public List<EinvMerchantUserResponse> getAllByMerchant(Long merchantId) {
        log.info("[User] L·∫•y danh s√°ch nh√¢n s·ª± cho Merchant ID: {}", merchantId);
        return repository.findAll().stream()
                .filter(u -> u.getMerchant().getId().equals(merchantId))
                .map(mapper::toResponse)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvMerchantUserResponse getById(Long id) {
        return repository.findById(id)
                .map(mapper::toResponse)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Ng∆∞·ªùi d√πng kh√¥ng t·ªìn t·∫°i"));
    }

    @Transactional
    public EinvMerchantUserResponse create(EinvMerchantUserRequest request) {
        log.info("[User] T·∫°o t√†i kho·∫£n m·ªõi: {} cho Merchant ID: {}", request.getUsername(), request.getMerchantId());

        // 1. Ki·ªÉm tra tr·∫°ng th√°i Merchant (Logic SOFTZ)
        EinvMerchantEntity merchant = merchantRepository.findById(request.getMerchantId())
                .filter(m -> !m.getIsDeleted())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.MERCHANT_NOT_FOUND));

        // 2. Ki·ªÉm tra tr√πng l·∫∑p t√†i kho·∫£n
        if (repository.findByUsername(request.getUsername()).isPresent()) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "T√™n ƒëƒÉng nh·∫≠p ƒë√£ t·ªìn t·∫°i");
        }

        EinvMerchantUserEntity entity = mapper.toEntity(request);
        entity.setMerchant(merchant);

        // 3. Logic SOFTZ: M√£ h√≥a m·∫≠t kh·∫©u (Gi·∫£ ƒë·ªãnh hash m·∫≠t kh·∫©u ·ªü ƒë√¢y)
        // entity.setPasswordHash(passwordEncoder.encode(request.getPassword()));
        entity.setPasswordHash("HASHED_" + request.getPassword());

        entity.setIsActive(true);
        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public EinvMerchantUserResponse update(Long id, EinvMerchantUserRequest request) {
        log.info("[User] C·∫≠p nh·∫≠t th√¥ng tin ng∆∞·ªùi d√πng ID: {}", id);
        EinvMerchantUserEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i"));

        entity.setFullName(request.getFullName());
        entity.setPhone(request.getPhone());
        entity.setRole(com.einvoicehub.core.domain.entity.enums.UserRole.valueOf(request.getRole()));

        return mapper.toResponse(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[User] X√≥a t√†i kho·∫£n ID: {}", id);
        EinvMerchantUserEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "T√†i kho·∫£n kh√¥ng t·ªìn t·∫°i"));

        if (entity.getIsPrimary()) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng th·ªÉ x√≥a t√†i kho·∫£n ch·ªß c·ªßa doanh nghi·ªáp");
        }

        repository.delete(entity);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvPaymentMethodService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.domain.entity.EinvPaymentMethodEntity;
import com.einvoicehub.core.domain.repository.EinvPaymentMethodRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.dto.EinvPaymentMethodDto;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvPaymentMethodService {

    private final EinvPaymentMethodRepository repository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvPaymentMethodDto> getAll() {
        log.info("[Catalog] L·∫•y danh m·ª•c ph∆∞∆°ng th·ª©c thanh to√°n");
        return repository.findAll().stream().map(mapper::toDto).collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvPaymentMethodDto getById(Long id) {
        return repository.findById(id).map(mapper::toDto)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "D·ªØ li·ªáu kh√¥ng t·ªìn t·∫°i"));
    }

    @Transactional
    public EinvPaymentMethodDto create(EinvPaymentMethodDto dto) {
        log.info("[Catalog] T·∫°o m·ªõi PTTT: {}", dto.getMethodCode());
        if (repository.findByMethodCode(dto.getMethodCode()).isPresent()) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "M√£ thanh to√°n ƒë√£ t·ªìn t·∫°i");
        }
        EinvPaymentMethodEntity entity = mapper.toEntity(dto);
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public EinvPaymentMethodDto update(Long id, EinvPaymentMethodDto dto) {
        log.info("[Catalog] C·∫≠p nh·∫≠t PTTT ID: {}", id);
        EinvPaymentMethodEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu"));
        entity.setMethodName(dto.getMethodName());
        entity.setIsActive(dto.getIsActive());
        entity.setDisplayOrder(dto.getDisplayOrder());
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        EinvPaymentMethodEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i"));

        // Theo SQL: Tham chi·∫øu qua method_code
        if (metadataRepository.existsByPaymentMethod(entity.getMethodCode())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "PTTT n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng trong h√≥a ƒë∆°n");
        }
        repository.delete(entity);
        log.info("[Catalog] ƒê√£ x√≥a PTTT: {}", entity.getMethodCode());
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvRegistrationStatusService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.domain.entity.EinvRegistrationStatusEntity;
import com.einvoicehub.core.domain.repository.EinvRegistrationStatusRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceRegistrationRepository;
import com.einvoicehub.core.dto.EinvRegistrationStatusDto;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvRegistrationStatusService {

    private final EinvRegistrationStatusRepository repository;
    private final EinvInvoiceRegistrationRepository registrationRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvRegistrationStatusDto> getAll() {
        log.info("[Catalog] L·∫•y danh m·ª•c tr·∫°ng th√°i ƒëƒÉng k√Ω");
        return repository.findAll().stream().map(mapper::toDto).collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvRegistrationStatusDto getById(Integer id) {
        return repository.findById(id).map(mapper::toDto)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Tr·∫°ng th√°i kh√¥ng t·ªìn t·∫°i"));
    }

    @Transactional
    public EinvRegistrationStatusDto create(EinvRegistrationStatusDto dto) {
        log.info("[Catalog] T·∫°o tr·∫°ng th√°i ƒëƒÉng k√Ω: {}", dto.getName());
        if (repository.findByName(dto.getName()).isPresent()) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "T√™n tr·∫°ng th√°i ƒë√£ t·ªìn t·∫°i");
        }
        EinvRegistrationStatusEntity entity = mapper.toEntity(dto);
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public EinvRegistrationStatusDto update(Integer id, EinvRegistrationStatusDto dto) {
        EinvRegistrationStatusEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu"));
        entity.setName(dto.getName());
        entity.setDescription(dto.getDescription());
        entity.setNote(dto.getNote());
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Integer id) {
        log.warn("[Catalog] X√≥a tr·∫°ng th√°i ƒëƒÉng k√Ω ID: {}", id);
        if (registrationRepository.existsByStatusId(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Tr·∫°ng th√°i n√†y ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng cho d·∫£i s·ªë h√≥a ƒë∆°n");
        }
        repository.deleteById(id);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvServiceProviderService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.EinvServiceProviderEntity;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.domain.repository.EinvMerchantProviderConfigRepository;
import com.einvoicehub.core.domain.repository.EinvServiceProviderRepository;
import com.einvoicehub.core.dto.EinvServiceProviderDto;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvServiceProviderService {

    private final EinvServiceProviderRepository repository;
    private final EinvMerchantProviderConfigRepository providerConfigRepository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;


    @Transactional(readOnly = true)
    public List<EinvServiceProviderDto> getAll() {
        log.info("[Config] ƒêang truy v·∫•n danh s√°ch to√†n b·ªô nh√† cung c·∫•p d·ªãch v·ª•");
        return repository.findAll().stream()
                .map(mapper::toDto)
                .collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvServiceProviderDto getById(Long id) {
        log.info("[Config] ƒêang t√¨m ki·∫øm nh√† cung c·∫•p ID: {}", id);
        return repository.findById(id)
                .map(mapper::toDto)
                .orElseThrow(() -> {
                    log.error("[Config] Kh√¥ng t√¨m th·∫•y nh√† cung c·∫•p v·ªõi ID: {}", id);
                    return new InvalidDataException(ErrorCode.INVALID_DATA, "Nh√† cung c·∫•p kh√¥ng t·ªìn t·∫°i tr√™n h·ªá th·ªëng");
                });
    }

    @Transactional
    public EinvServiceProviderDto create(EinvServiceProviderDto dto) {
        log.info("[Config] ƒêang t·∫°o m·ªõi nh√† cung c·∫•p v·ªõi m√£: {}", dto.getProviderCode());

        if (repository.findByProviderCodeAndIsActiveTrue(dto.getProviderCode()).isPresent()) {
            log.warn("[Config] M√£ nh√† cung c·∫•p {} ƒë√£ t·ªìn t·∫°i", dto.getProviderCode());
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "M√£ nh√† cung c·∫•p ƒë√£ t·ªìn t·∫°i trong danh m·ª•c");
        }

        if (Boolean.TRUE.equals(dto.getIsDefault())) {
            repository.findByIsDefaultTrue().ifPresent(oldDefault -> {
                oldDefault.setIsDefault(false);
                repository.save(oldDefault);
            });
        }

        EinvServiceProviderEntity entity = mapper.toEntity(dto);
        entity = repository.save(entity);

        log.info("[Config] ƒê√£ t·∫°o th√†nh c√¥ng nh√† cung c·∫•p: {} (ID: {})", entity.getProviderName(), entity.getId());
        return mapper.toDto(entity);
    }

    @Transactional
    public EinvServiceProviderDto update(Long id, EinvServiceProviderDto dto) {
        log.info("[Config] ƒêang c·∫≠p nh·∫≠t th√¥ng tin nh√† cung c·∫•p ID: {}", id);

        EinvServiceProviderEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "D·ªØ li·ªáu kh√¥ng t·ªìn t·∫°i ƒë·ªÉ c·∫≠p nh·∫≠t"));

        entity.setProviderName(dto.getProviderName());
        entity.setOfficialApiUrl(dto.getOfficialApiUrl());
        entity.setLookupUrl(dto.getLookupUrl());
        entity.setSupportEmail(dto.getSupportEmail());
        entity.setSupportPhone(dto.getSupportPhone());
        entity.setIsActive(dto.getIsActive());
        entity.setDisplayOrder(dto.getDisplayOrder());

        // X·ª≠ l√Ω logic ƒë·ªïi Provider m·∫∑c ƒë·ªãnh
        if (Boolean.TRUE.equals(dto.getIsDefault()) && !entity.getIsDefault()) {
            repository.findByIsDefaultTrue().ifPresent(oldDefault -> {
                oldDefault.setIsDefault(false);
                repository.save(oldDefault);
            });
            entity.setIsDefault(true);
        }

        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Config] ƒêang th·ª±c hi·ªán y√™u c·∫ßu x√≥a nh√† cung c·∫•p ID: {}", id);
        if (!repository.existsById(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i");
        }
        if (providerConfigRepository.existsByProviderId(id)) {
            log.error("[Config] X√≥a th·∫•t b·∫°i: Nh√† cung c·∫•p ID {} ƒëang ƒë∆∞·ª£c d√πng trong c·∫•u h√¨nh Merchant", id);
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng th·ªÉ x√≥a nh√† cung c·∫•p ƒëang c√≥ doanh nghi·ªáp li√™n k·∫øt");
        }
        if (metadataRepository.existsByProviderId(id)) {
            log.error("[Config] X√≥a th·∫•t b·∫°i: Nh√† cung c·∫•p ID {} ƒë√£ ph√°t sinh d·ªØ li·ªáu h√≥a ƒë∆°n", id);
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "H·ªá th·ªëng ƒë√£ ph√°t sinh h√≥a ƒë∆°n th√¥ng qua nh√† cung c·∫•p n√†y, kh√¥ng ƒë∆∞·ª£c x√≥a");
        }
        repository.deleteById(id);
        log.info("[Config] ƒê√£ x√≥a th√†nh c√¥ng nh√† cung c·∫•p ID: {}", id);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvSystemConfigService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.EinvSystemConfigEntity;
import com.einvoicehub.core.domain.repository.EinvSystemConfigRepository;
import com.einvoicehub.core.dto.EinvSystemConfigDto;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvSystemConfigService {

    private final EinvSystemConfigRepository repository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvSystemConfigDto> getAll() {
        log.info("[Config] L·∫•y danh s√°ch tham s·ªë h·ªá th·ªëng");
        return repository.findAll().stream().map(mapper::toDto).collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvSystemConfigDto getById(Long id) {
        return repository.findById(id).map(mapper::toDto)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "C·∫•u h√¨nh kh√¥ng t·ªìn t·∫°i"));
    }

    @Transactional
    public EinvSystemConfigDto create(EinvSystemConfigDto dto) {
        log.info("[Config] Th√™m m·ªõi tham s·ªë: {}", dto.getConfigKey());

        if (repository.findByConfigKey(dto.getConfigKey()).isPresent()) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√≥a c·∫•u h√¨nh ƒë√£ t·ªìn t·∫°i");
        }

        EinvSystemConfigEntity entity = mapper.toEntity(dto);
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public EinvSystemConfigDto update(Long id, EinvSystemConfigDto dto) {
        log.info("[Config] Thay ƒë·ªïi tham s·ªë h·ªá th·ªëng: {}", dto.getConfigKey());
        EinvSystemConfigEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y tham s·ªë"));

        // R√†ng bu·ªôc:N·∫øu c·∫•u h√¨nh ƒë∆∞·ª£c ƒë√°nh d·∫•u l√† kh√¥ng ƒë∆∞·ª£c s·ª≠a (is_editable = 0)
        if (Boolean.FALSE.equals(entity.getIsEditable())) {
            log.error("[Config] Ch·∫∑n thao t√°c s·ª≠a c·∫•u h√¨nh h·ªá th·ªëng c·ªë ƒë·ªãnh: {}", entity.getConfigKey());
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Tham s·ªë n√†y thu·ªôc h·ªá th·ªëng l√µi, kh√¥ng ƒë∆∞·ª£c ph√©p ch·ªânh s·ª≠a");
        }

        entity.setConfigValue(dto.getConfigValue());
        entity.setDescription(dto.getDescription());

        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Config] Y√™u c·∫ßu x√≥a c·∫•u h√¨nh ID: {}", id);
        EinvSystemConfigEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i"));
        if (Boolean.FALSE.equals(entity.getIsEditable())) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng th·ªÉ x√≥a c·∫•u h√¨nh b·∫Øt bu·ªôc c·ªßa h·ªá th·ªëng");
        }

        repository.delete(entity);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvTaxAuthorityResponseService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.domain.entity.EinvInvoiceMetadataEntity;
import com.einvoicehub.core.domain.entity.EinvTaxAuthorityResponseEntity;
import com.einvoicehub.core.domain.repository.EinvInvoiceMetadataRepository;
import com.einvoicehub.core.domain.repository.EinvTaxAuthorityResponseRepository;
import com.einvoicehub.core.dto.EinvTaxAuthorityResponseDto;
import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvTaxAuthorityResponseService {

    private final EinvTaxAuthorityResponseRepository repository;
    private final EinvInvoiceMetadataRepository metadataRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvTaxAuthorityResponseDto> getAll() {
        log.info("[CQT] L·∫•y danh s√°ch to√†n b·ªô ph·∫£n h·ªìi t·ª´ Thu·∫ø");
        return repository.findAll().stream().map(mapper::toDto).collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvTaxAuthorityResponseDto getById(Long id) {
        return repository.findById(id).map(mapper::toDto)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y ph·∫£n h·ªìi ph√°p l√Ω"));
    }

    @Transactional
    public EinvTaxAuthorityResponseDto create(EinvTaxAuthorityResponseDto dto) {
        log.info("[CQT] Ti·∫øp nh·∫≠n m√£ CQT cho h√≥a ƒë∆°n ID: {}", dto.getInvoiceId());

        EinvInvoiceMetadataEntity invoice = metadataRepository.findById(dto.getInvoiceId())
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "H√≥a ƒë∆°n ƒë√≠ch kh√¥ng t·ªìn t·∫°i"));

        EinvTaxAuthorityResponseEntity entity = mapper.toEntity(dto);
        entity.setInvoice(invoice);

        entity = repository.save(entity);

        // C·∫≠p nh·∫≠t ng∆∞·ª£c l·∫°i m√£ CQT (tax_authority_code) v√†o metadata h√≥a ƒë∆°n
        if (entity.getCqtCode() != null) {
            invoice.setTaxAuthorityCode(entity.getCqtCode());
            metadataRepository.save(invoice);
            log.info("[CQT] ƒê√£ ƒë·ªìng b·ªô m√£ CQT {} v√†o Metadata h√≥a ƒë∆°n", entity.getCqtCode());
        }

        return mapper.toDto(entity);
    }

    @Transactional
    public EinvTaxAuthorityResponseDto update(Long id, EinvTaxAuthorityResponseDto dto) {
        log.info("[CQT] C·∫≠p nh·∫≠t di·ªÖn gi·∫£i ph·∫£n h·ªìi ID: {}", id);
        EinvTaxAuthorityResponseEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "D·ªØ li·ªáu kh√¥ng t·ªìn t·∫°i"));

        entity.setErrorMessage(dto.getErrorMessage());
        entity.setStatusFromCqt(dto.getStatusFromCqt());

        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.error("[CQT] C·∫¢NH B√ÅO: Thao t√°c x√≥a ph·∫£n h·ªìi Thu·∫ø nh·∫°y c·∫£m ID: {}", id);
        if (!repository.existsById(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "B·∫£n ghi kh√¥ng t·ªìn t·∫°i");
        }
        //logs n√†y ch·ªâ Admin m·ªõi ƒë∆∞·ª£c x√≥a
        repository.deleteById(id);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/service/EinvVatRateService.java">
package com.einvoicehub.core.service;

import com.einvoicehub.core.exception.ErrorCode;
import com.einvoicehub.core.exception.InvalidDataException;
import com.einvoicehub.core.domain.entity.EinvVatRateEntity;
import com.einvoicehub.core.domain.repository.EinvVatRateRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceItemRepository;
import com.einvoicehub.core.domain.repository.EinvInvoiceTaxBreakdownRepository;
import com.einvoicehub.core.dto.EinvVatRateDto;
import com.einvoicehub.core.mapper.EinvHubMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigDecimal;
import java.util.List;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class EinvVatRateService {

    private final EinvVatRateRepository repository;
    private final EinvInvoiceItemRepository itemRepository;
    private final EinvInvoiceTaxBreakdownRepository taxRepository;
    private final EinvHubMapper mapper;

    @Transactional(readOnly = true)
    public List<EinvVatRateDto> getAll() {
        log.info("[Catalog] L·∫•y danh m·ª•c thu·∫ø su·∫•t GTGT");
        return repository.findAll().stream().map(mapper::toDto).collect(Collectors.toList());
    }

    @Transactional(readOnly = true)
    public EinvVatRateDto getById(Long id) {
        return repository.findById(id).map(mapper::toDto)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Thu·∫ø su·∫•t kh√¥ng t·ªìn t·∫°i"));
    }

    @Transactional
    public EinvVatRateDto create(EinvVatRateDto dto) {
        log.info("[Catalog] T·∫°o m·ªõi thu·∫ø su·∫•t: {}", dto.getRateCode());
        if (repository.findByRateCode(dto.getRateCode()).isPresent()) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "M√£ thu·∫ø su·∫•t ƒë√£ t·ªìn t·∫°i");
        }
        if (dto.getRatePercent() != null && dto.getRatePercent().compareTo(BigDecimal.ZERO) < 0) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "T·ª∑ l·ªá thu·∫ø su·∫•t kh√¥ng ƒë∆∞·ª£c √¢m");
        }
        EinvVatRateEntity entity = mapper.toEntity(dto);
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public EinvVatRateDto update(Long id, EinvVatRateDto dto) {
        EinvVatRateEntity entity = repository.findById(id)
                .orElseThrow(() -> new InvalidDataException(ErrorCode.INVALID_DATA, "Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu"));
        entity.setRateName(dto.getRateName());
        entity.setRatePercent(dto.getRatePercent());
        entity.setIsActive(dto.getIsActive());
        entity.setDisplayOrder(dto.getDisplayOrder());
        return mapper.toDto(repository.save(entity));
    }

    @Transactional
    public void delete(Long id) {
        log.warn("[Catalog] X√≥a thu·∫ø su·∫•t ID: {}", id);
        if (itemRepository.existsByVatRateId(id) || taxRepository.existsByVatRateId(id)) {
            throw new InvalidDataException(ErrorCode.INVALID_DATA, "Thu·∫ø su·∫•t ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng trong chi ti·∫øt h√≥a ƒë∆°n");
        }
        repository.deleteById(id);
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/util/IdGenerator.java">
package com.einvoicehub.core.util;

import org.springframework.stereotype.Component;
import java.security.SecureRandom;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

/**
 * ID Generator Utility - C·∫≠p nh·∫≠t theo chu·∫©n EInvoiceHub
 * * Th√†nh ph·∫ßn h·ªó tr·ª£ t·∫°o c√°c ƒë·ªãnh danh c√≥ c·∫•u tr√∫c, gi√∫p ƒë·ªëi so√°t d·ªØ li·ªáu
 * gi·ªØa MySQL v√† MongoDB d·ªÖ d√†ng h∆°n so v·ªõi UUID th√¥ng th∆∞·ªùng.
 */
@Component
public class IdGenerator {

    private static final String CHARS = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    private final SecureRandom random = new SecureRandom();
    private final DateTimeFormatter timestampFormatter = DateTimeFormatter.ofPattern("yyyyMMdd-HHmmss");
    private final DateTimeFormatter dateFormatter = DateTimeFormatter.ofPattern("yyyyMMdd");

    /**
     * T·∫°o ID ƒë·ªãnh danh duy nh·∫•t cho m·ªói y√™u c·∫ßu khi ti·∫øp nh·∫≠n v√†o Hub.
     * Kh·∫Øc ph·ª•c: ƒê·ªïi t√™n t·ª´ generateClientRequestId ƒë·ªÉ ph√¢n bi·ªát v·ªõi ID c·ªßa Merchant truy·ªÅn l√™n.
     * Format: HUB-YYYYMMDD-HHMMSS-XXXXXX
     */
    public String generateHubRequestId() {
        String timestamp = LocalDateTime.now().format(timestampFormatter);
        return String.format("HUB-%s-%s", timestamp, generateRandom(6));
    }

    /**
     * T·∫°o m√£ giao d·ªãch n·ªôi b·ªô ƒë·ªÉ li√™n k·∫øt Metadata (MySQL) v√† Payload (MongoDB).
     * Format: TXN-YYYYMMDD-HHMMSS-XXXXXXXX
     */
    public String generateTransactionId() {
        String timestamp = LocalDateTime.now().format(timestampFormatter);
        return String.format("TXN-%s-%s", timestamp, generateRandom(8));
    }

    /**
     * T·∫°o s·ªë h√≥a ƒë∆°n n·ªôi b·ªô (Ch·ªâ d√πng cho b·∫£n nh√°p DRAFT ho·∫∑c tra c·ª©u n·ªôi b·ªô).
     * C·∫£nh b√°o: S·ªë h√≥a ƒë∆°n ph√°p l√Ω s·∫Ω do Provider (MISA, VNPT...) c·∫•p sau khi ph√°t h√†nh.
     * Format: DRAFT-YYYYMMDD-XXXXXX
     */
    public String generateInternalDraftNumber() {
        String date = LocalDateTime.now().format(dateFormatter);
        return String.format("DRAFT-%s-%s", date, generateRandom(6));
    }

    /**
     * Sinh chu·ªói ng·∫´u nhi√™n an to√†n (Alphanumeric)
     * S·ª≠ d·ª•ng SecureRandom ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh b·∫£o m·∫≠t v√† tr√°nh tr√πng l·∫∑p.
     */
    private String generateRandom(int length) {
        StringBuilder sb = new StringBuilder(length);
        for (int i = 0; i < length; i++) {
            sb.append(CHARS.charAt(random.nextInt(CHARS.length())));
        }
        return sb.toString();
    }
}
</file>

<file path="src/main/java/com/einvoicehub/core/EinvoiceCoreApplication.java">
package com.einvoicehub.core;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class EinvoiceCoreApplication {

	public static void main(String[] args) {
		SpringApplication.run(EinvoiceCoreApplication.class, args);
	}

}
</file>

<file path="src/main/resources/db/migration/Initial_Schema_Ver01.sql">
-- EInvoiceHub Database Schema [MySQL - MongoDB]

--Table
-- merchants , merchant_users,
-- api_credentials, service_providers,merchant_provider_configs
-- invoices_metadata,
-- audit_logs, system_config

-- 1. ENUM Types Definition
-- Subscription Plan: Trial, Basic, Premium
DROP TYPE IF EXISTS subscription_plan;
CREATE TYPE subscription_plan AS ENUM ('TRIAL', 'BASIC', 'PREMIUM');

-- Entity Status: Active, Inactive, Suspended
DROP TYPE IF EXISTS entity_status;
CREATE TYPE entity_status AS ENUM ('ACTIVE', 'INACTIVE', 'SUSPENDED');

-- Invoice Status: Workflow states
DROP TYPE IF EXISTS invoice_status;
CREATE TYPE invoice_status AS ENUM ('DRAFT', 'PENDING', 'SIGNING', 'SENT_TO_PROVIDER', 'SUCCESS', 'FAILED', 'CANCELLED', 'REPLACED');

-- User Role: Ph√¢n quy·ªÅn trong Merchant
DROP TYPE IF EXISTS user_role;
CREATE TYPE user_role AS ENUM ('ADMIN', 'MANAGER', 'STAFF', 'VIEWER');


-- 2. Merchants Table - Qu·∫£n l√Ω doanh nghi·ªáp
CREATE TABLE merchants (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    tax_code VARCHAR(20) NOT NULL UNIQUE COMMENT 'M√£ s·ªë thu·∫ø - ƒë·ªãnh danh doanh nghi·ªáp',
    company_name VARCHAR(255) NOT NULL COMMENT 'T√™n c√¥ng ty ƒë·∫ßy ƒë·ªß',
    short_name VARCHAR(100) COMMENT 'T√™n vi·∫øt t·∫Øt',
    address TEXT COMMENT 'ƒê·ªãa ch·ªâ tr·ª• s·ªü ch√≠nh',
    district VARCHAR(100) COMMENT 'Qu·∫≠n/Huy·ªán',
    city VARCHAR(100) COMMENT 'T·ªânh/Th√†nh ph·ªë',
    email VARCHAR(255) COMMENT 'Email li√™n h·ªá',
    phone VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    representative_name VARCHAR(100) COMMENT 'T√™n ng∆∞·ªùi ƒë·∫°i di·ªán',
    representative_title VARCHAR(100) COMMENT 'Ch·ª©c danh ng∆∞·ªùi ƒë·∫°i di·ªán',
    subscription_plan subscription_plan NOT NULL DEFAULT 'TRIAL' COMMENT 'G√≥i d·ªãch v·ª•',
    invoice_quota INT NOT NULL DEFAULT 100 COMMENT 'H·∫°n m·ª©c h√≥a ƒë∆°n/th√°ng',
    invoice_used INT NOT NULL DEFAULT 0 COMMENT 'H√≥a ƒë∆°n ƒë√£ s·ª≠ d·ª•ng trong th√°ng',
    status entity_status NOT NULL DEFAULT 'ACTIVE' COMMENT 'Tr·∫°ng th√°i ho·∫°t ƒë·ªông',
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'Soft delete flag',
    deleted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    INDEX idx_tax_code (tax_code),
    INDEX idx_status (status),
    INDEX idx_subscription_plan (subscription_plan),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω doanh nghi·ªáp s·ª≠ d·ª•ng d·ªãch v·ª•';


-- 3. Merchant Users - T√†i kho·∫£n ng∆∞·ªùi d√πng c·ªßa Merchant
CREATE TABLE merchant_users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Li√™n k·∫øt v·ªõi doanh nghi·ªáp',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT 'T√™n ƒëƒÉng nh·∫≠p',
    email VARCHAR(255) NOT NULL UNIQUE COMMENT 'Email ng∆∞·ªùi d√πng',
    password_hash VARCHAR(255) NOT NULL COMMENT 'M·∫≠t kh·∫©u ƒë√£ m√£ h√≥a BCrypt',
    full_name VARCHAR(100) COMMENT 'H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß',
    phone VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    avatar_url VARCHAR(500) COMMENT 'URL ·∫£nh ƒë·∫°i di·ªán',
    role user_role NOT NULL DEFAULT 'STAFF' COMMENT 'Vai tr√≤ trong h·ªá th·ªëng',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'K√≠ch ho·∫°t t√†i kho·∫£n',
    is_primary BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'T√†i kho·∫£n ch√≠nh c·ªßa doanh nghi·ªáp',
    last_login_at TIMESTAMP NULL COMMENT 'ƒêƒÉng nh·∫≠p l·∫ßn cu·ªëi',
    failed_login_attempts INT NOT NULL DEFAULT 0 COMMENT 'S·ªë l·∫ßn ƒëƒÉng nh·∫≠p sai',
    locked_until TIMESTAMP NULL COMMENT 'Kh√≥a t√†i kho·∫£n ƒë·∫øn th·ªùi ƒëi·ªÉm',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_merchant_users_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_role (role),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='T√†i kho·∫£n ng∆∞·ªùi d√πng thu·ªôc Merchant';


-- 4. API Credentials - B·∫£o m·∫≠t v√† t√≠ch h·ª£p API
CREATE TABLE api_credentials (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu credential',
    client_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'ID c√¥ng khai c·ªßa ·ª©ng d·ª•ng',
    api_key_hash VARCHAR(255) NOT NULL COMMENT 'Hash c·ªßa API Key (SHA-256)',
    api_key_prefix VARCHAR(8) NOT NULL COMMENT '8 k√Ω t·ª± ƒë·∫ßu c·ªßa API Key (hi·ªÉn th·ªã)',
    scopes TEXT NOT NULL COMMENT 'Quy·ªÅn h·∫°n - JSON array: [invoice.create, invoice.view]',
    ip_whitelist TEXT NULL COMMENT 'Danh s√°ch IP ƒë∆∞·ª£c ph√©p - JSON array ho·∫∑c NULL',
    rate_limit_per_hour INT NOT NULL DEFAULT 1000 COMMENT 'Gi·ªõi h·∫°n request/gi·ªù',
    rate_limit_per_day INT NOT NULL DEFAULT 10000 COMMENT 'Gi·ªõi h·∫°n request/ng√†y',
    request_count_hour INT NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong gi·ªù',
    request_count_day INT NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong ng√†y',
    request_count_resetted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm reset counter',
    expired_at TIMESTAMP NULL COMMENT 'Ng√†y h·∫øt h·∫°n - NULL l√† kh√¥ng gi·ªõi h·∫°n',
    last_used_at TIMESTAMP NULL COMMENT 'L·∫ßn s·ª≠ d·ª•ng cu·ªëi',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    created_by BIGINT NULL COMMENT 'Ng∆∞·ªùi t·∫°o - merchant_users.id',
    
    CONSTRAINT fk_api_credentials_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    CONSTRAINT fk_api_credentials_created_by FOREIGN KEY (created_by) 
        REFERENCES merchant_users(id) ON DELETE SET NULL,
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_client_id (client_id),
    INDEX idx_api_key_hash (api_key_hash),
    INDEX idx_expired_at (expired_at),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Credentials cho API access';


-- 5. Service Providers - Nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠
CREATE TABLE service_providers (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    provider_code VARCHAR(20) NOT NULL UNIQUE COMMENT 'M√£ provider: VNPT, VIETTEL, MISA, BKAV',
    provider_name VARCHAR(100) NOT NULL COMMENT 'T√™n ƒë·∫ßy ƒë·ªß nh√† cung c·∫•p',
    official_api_url VARCHAR(500) NOT NULL COMMENT 'URL API ch√≠nh th·ª©c',
    documentation_url VARCHAR(500) NULL COMMENT 'Link t√†i li·ªáu API',
    support_email VARCHAR(255) NULL COMMENT 'Email h·ªó tr·ª£',
    support_phone VARCHAR(20) NULL COMMENT 'Hotline h·ªó tr·ª£',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'Provider c√≤n ho·∫°t ƒë·ªông',
    is_default BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh c·ªßa h·ªá th·ªëng',
    display_order INT NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
    extra_config_schema JSON NULL COMMENT 'Schema c·∫•u h√¨nh b·ªï sung cho provider',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_provider_code (provider_code),
    INDEX idx_is_active (is_active),
    INDEX idx_is_default (is_default),
    INDEX idx_display_order (display_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠';

-- Insert default providers
INSERT INTO service_providers (provider_code, provider_name, official_api_url, is_active, is_default, display_order) VALUES
('VNPT', 'VNPT Invoice', 'https://api.vnptinvoice.com.vn/v1', TRUE, FALSE, 1),
('VIETTEL', 'Viettel Business Invoice', 'https://ebill.vietteltelecom.vn/api/v1', TRUE, FALSE, 2),
('MISA', 'MISA Mimosa', 'https://api.misa.com.vn/einvoice/v1', FALSE, FALSE, 3),
('BKAV', 'BKAV eInvoice', 'https://einvoice.bkav.com/api/v1', FALSE, FALSE, 4);


-- 6. Merchant Provider Configs - C·∫•u h√¨nh ri√™ng c·ªßa Merchant
CREATE TABLE merchant_provider_configs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu',
    provider_id BIGINT NOT NULL COMMENT 'Nh√† cung c·∫•p ƒë∆∞·ª£c ch·ªçn',
    username_service VARCHAR(100) NOT NULL COMMENT 'T√†i kho·∫£n API do Provider c·∫•p',
    password_service_encrypted VARCHAR(500) NOT NULL COMMENT 'M·∫≠t kh·∫©u API - ƒë√£ m√£ h√≥a AES-256',
    certificate_serial VARCHAR(100) NULL COMMENT 'Serial number c·ªßa ch·ªØ k√Ω s·ªë',
    certificate_data TEXT NULL COMMENT 'Ch·ª©ng th∆∞ s·ªë - ƒë√£ m√£ h√≥a',
    certificate_expired_at TIMESTAMP NULL COMMENT 'H·∫°n ch·ª©ng th∆∞ s·ªë',
    extra_config JSON NULL COMMENT 'C·∫•u h√¨nh b·ªï sung: pattern, serial, template',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C·∫•u h√¨nh c√≤n hi·ªáu l·ª±c',
    is_default BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh c·ªßa Merchant',
    last_sync_at TIMESTAMP NULL COMMENT 'L·∫ßn ƒë·ªìng b·ªô cu·ªëi v·ªõi Provider',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_mpc_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    CONSTRAINT fk_mpc_provider FOREIGN KEY (provider_id) 
        REFERENCES service_providers(id) ON DELETE RESTRICT,
    CONSTRAINT uq_merchant_provider UNIQUE (merchant_id, provider_id),
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_provider_id (provider_id),
    INDEX idx_is_active (is_active),
    INDEX idx_is_default (is_default)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='C·∫•u h√¨nh k·∫øt n·ªëi Provider cho t·ª´ng Merchant';


-- 7. Invoice Metadata - Th√¥ng tin t√≥m t·∫Øt h√≥a ƒë∆°n
CREATE TABLE invoices_metadata (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp ph√°t h√†nh',
    provider_id BIGINT NULL COMMENT 'Provider x·ª≠ l√Ω h√≥a ƒë∆°n',
    provider_config_id BIGINT NULL COMMENT 'C·∫•u h√¨nh Provider ƒë∆∞·ª£c s·ª≠ d·ª•ng',
    client_request_id VARCHAR(100) NULL COMMENT 'ID request t·ª´ Merchant',
    
    -- Th√¥ng tin h√≥a ƒë∆°n
    invoice_number VARCHAR(20) NULL COMMENT 'S·ªë h√≥a ƒë∆°n t·ª´ Provider tr·∫£ v·ªÅ',
    symbol_code VARCHAR(10) NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n ',
    invoice_type_code VARCHAR(10) NULL COMMENT 'M√£ lo·∫°i h√≥a ƒë∆°n: 01GTKT, 02GTTT, 07KPTQ...',
    template_code VARCHAR(20) NULL COMMENT 'M·∫´u h√≥a ƒë∆°n: 01GTKT0/001, 02GTTT0/001...',
    
    -- Th√¥ng tin ng∆∞·ªùi b√°n (t·ª´ merchant data)
    seller_name VARCHAR(255) NULL COMMENT 'T√™n ng∆∞·ªùi b√°n',
    seller_tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi b√°n',
    seller_address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi b√°n',
    
    -- Th√¥ng tin ng∆∞·ªùi mua
    buyer_name VARCHAR(255) NULL COMMENT 'T√™n ng∆∞·ªùi mua',
    buyer_tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi mua',
    buyer_email VARCHAR(255) NULL COMMENT 'Email ng∆∞·ªùi mua (nh·∫≠n h√≥a ƒë∆°n)',
    buyer_phone VARCHAR(20) NULL COMMENT 'ƒêi·ªán tho·∫°i ng∆∞·ªùi mua',
    buyer_address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi mua',
    
    -- Th√¥ng tin t√†i ch√≠nh
    subtotal_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø',
    tax_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ø',
    discount_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng chi·∫øt kh·∫•u',
    total_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thanh to√°n',
    currency_code VARCHAR(3) NOT NULL DEFAULT 'VND' COMMENT 'ƒê∆°n v·ªã ti·ªÅn t·ªá',
    exchange_rate DECIMAL(10,4) NOT NULL DEFAULT 1.0000 COMMENT 'T·ª∑ gi√° v·ªõi VND',
    
    -- Th√¥ng tin th·ªùi gian
    issue_date DATE NULL COMMENT 'Ng√†y l·∫≠p h√≥a ƒë∆°n',
    accounting_date DATE NULL COMMENT 'Ng√†y h·∫°ch to√°n',
    due_date DATE NULL COMMENT 'Ng√†y thanh to√°n ƒë·∫øn h·∫°n',
    
    -- Tr·∫°ng th√°i v√† ƒëi·ªÅu kho·∫£n
    status invoice_status NOT NULL DEFAULT 'DRAFT' COMMENT 'Tr·∫°ng th√°i x·ª≠ l√Ω',
    status_message TEXT NULL COMMENT 'Th√¥ng b√°o tr·∫°ng th√°i chi ti·∫øt',
    cancellation_reason VARCHAR(500) NULL COMMENT 'L√Ω do h·ªßy/thay th·∫ø',
    replaced_by_invoice_id BIGINT NULL COMMENT 'ID h√≥a ƒë∆°n thay th·∫ø',
    
    -- Li√™n k·∫øt MongoDB
    mongo_payload_id VARCHAR(50) NULL COMMENT 'ObjectId trong collection invoice_payloads',
    mongo_transaction_id VARCHAR(50) NULL COMMENT 'ObjectId trong collection provider_transactions',
    
    -- Tracking
    signed_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm k√Ω ƒëi·ªán t·ª≠',
    sent_to_provider_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i sang Provider',
    received_from_provider_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
    delivered_to_buyer_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i h√≥a ƒë∆°n cho ng∆∞·ªùi mua',
    
    -- Provider response reference
    provider_transaction_code VARCHAR(100) NULL COMMENT 'M√£ giao d·ªãch t·ª´ Provider',
    provider_error_code VARCHAR(50) NULL COMMENT 'M√£ l·ªói t·ª´ Provider',
    provider_error_message TEXT NULL COMMENT 'Chi ti·∫øt l·ªói t·ª´ Provider',
    
    -- Soft delete
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'H√≥a ƒë∆°n ƒë√£ b·ªã x√≥a',
    deleted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
    deleted_by BIGINT NULL COMMENT 'Ng∆∞·ªùi x√≥a - merchant_users.id',
    
    -- Timestamps
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    -- Foreign Keys
    CONSTRAINT fk_invoice_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE RESTRICT,
    CONSTRAINT fk_invoice_provider FOREIGN KEY (provider_id) 
        REFERENCES service_providers(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_config FOREIGN KEY (provider_config_id) 
        REFERENCES merchant_provider_configs(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_replaced_by FOREIGN KEY (replaced_by_invoice_id) 
        REFERENCES invoices_metadata(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_deleted_by FOREIGN KEY (deleted_by) 
        REFERENCES merchant_users(id) ON DELETE SET NULL,
    
    -- Indexes for performance
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_provider_id (provider_id),
    INDEX idx_invoice_number (invoice_number),
    INDEX idx_symbol_code (symbol_code),
    INDEX idx_buyer_tax_code (buyer_tax_code),
    INDEX idx_status (status),
    INDEX idx_issue_date (issue_date),
    INDEX idx_created_at (created_at),
    INDEX idx_client_request_id (client_request_id),
    INDEX idx_merchant_status (merchant_id, status),
    INDEX idx_merchant_created (merchant_id, created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Metadata h√≥a ƒë∆°n - ph·ª•c v·ª• tra c·ª©u nhanh';


-- 8. Audit Log - Nh·∫≠t k√Ω thao t√°c
CREATE TABLE audit_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NULL COMMENT 'Doanh nghi·ªáp li√™n quan',
    user_id BIGINT NULL COMMENT 'Ng∆∞·ªùi th·ª±c hi·ªán',
    entity_type VARCHAR(50) NOT NULL COMMENT 'Lo·∫°i entity: Invoice, Merchant, Config...',
    entity_id BIGINT NOT NULL COMMENT 'ID c·ªßa entity',
    action VARCHAR(50) NOT NULL COMMENT 'H√†nh ƒë·ªông: CREATE, UPDATE, DELETE, STATUS_CHANGE',
    old_value JSON NULL COMMENT 'Gi√° tr·ªã c≈©',
    new_value JSON NULL COMMENT 'Gi√° tr·ªã m·ªõi',
    ip_address VARCHAR(45) NULL COMMENT 'IP th·ª±c hi·ªán',
    user_agent VARCHAR(500) NULL COMMENT 'User Agent c·ªßa browser/client',
    request_id VARCHAR(100) NULL COMMENT 'ID request t·ª´ frontend',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm x·∫£y ra',
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_user_id (user_id),
    INDEX idx_entity (entity_type, entity_id),
    INDEX idx_action (action),
    INDEX idx_created_at (created_at),
    INDEX idx_merchant_entity (merchant_id, entity_type, entity_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Nh·∫≠t k√Ω thay ƒë·ªïi h·ªá th·ªëng';


-- 9. System Configuration - C·∫•u h√¨nh h·ªá th·ªëng
CREATE TABLE system_config (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    config_key VARCHAR(100) NOT NULL UNIQUE COMMENT 'Kh√≥a c·∫•u h√¨nh',
    config_value TEXT NOT NULL COMMENT 'Gi√° tr·ªã c·∫•u h√¨nh',
    config_type VARCHAR(20) NOT NULL DEFAULT 'STRING' COMMENT 'Lo·∫°i: STRING, NUMBER, BOOLEAN, JSON',
    description VARCHAR(500) NULL COMMENT 'M√¥ t·∫£ c·∫•u h√¨nh',
    is_encrypted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'C√≥ c·∫ßn m√£ h√≥a kh√¥ng',
    is_editable BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≥ th·ªÉ ch·ªânh s·ª≠a kh√¥ng',
    updated_by BIGINT NULL COMMENT 'Ng∆∞·ªùi c·∫≠p nh·∫≠t cu·ªëi',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    CONSTRAINT fk_config_updated_by FOREIGN KEY (updated_by) 
        REFERENCES merchant_users(id) ON DELETE SET NULL,
    
    INDEX idx_config_key (config_key)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='C·∫•u h√¨nh h·ªá th·ªëng';

-- Insert default configurations
INSERT INTO system_config (config_key, config_value, config_type, description) VALUES
('SYSTEM_NAME', 'EInvoiceHub', 'STRING', 'T√™n hi·ªÉn th·ªã c·ªßa h·ªá th·ªëng'),
('INVOICE_EXPIRY_DAYS', '30', 'NUMBER', 'S·ªë ng√†y h√≥a ƒë∆°n c√≥ hi·ªáu l·ª±c sau khi ph√°t h√†nh'),
('MAX_RETRY_ATTEMPTS', '3', 'NUMBER', 'S·ªë l·∫ßn th·ª≠ l·∫°i khi g·ªçi Provider th·∫•t b·∫°i'),
('RETRY_DELAY_MS', '1000', 'NUMBER', 'Th·ªùi gian ch·ªù gi·ªØa c√°c l·∫ßn th·ª≠ l·∫°i (milliseconds)'),
('SESSION_TIMEOUT_MINUTES', '60', 'NUMBER', 'Th·ªùi gian timeout c·ªßa session'),
('PASSWORD_MIN_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i t·ªëi thi·ªÉu c·ªßa m·∫≠t kh·∫©u'),
('API_KEY_PREFIX_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i prefix hi·ªÉn th·ªã c·ªßa API Key'),
('DEFAULT_CURRENCY', 'VND', 'STRING', 'ƒê∆°n v·ªã ti·ªÅn t·ªá m·∫∑c ƒë·ªãnh'),
('TAX_DEFAULT_RATE', '10.00', 'NUMBER', 'Thu·∫ø su·∫•t m·∫∑c ƒë·ªãnh (%)');


/* TRIGGER VERSION 3
-- PH·∫¶N 3: TRIGGERS
-- Trigger 1: T·ª± ƒë·ªông c·∫≠p nh·∫≠t merchants.invoice_used khi h√≥a ƒë∆°n chuy·ªÉn sang SUCCESS
DELIMITER //

CREATE TRIGGER trg_invoice_status_success
    AFTER UPDATE ON invoices_metadata
    FOR EACH ROW
BEGIN
    -- Ki·ªÉm tra n·∫øu tr·∫°ng th√°i chuy·ªÉn sang SUCCESS v√† merchant_id t·ªìn t·∫°i
    IF NEW.status = 'SUCCESS' AND OLD.status != 'SUCCESS' AND NEW.merchant_id IS NOT NULL THEN
    UPDATE merchants
    SET invoice_used = invoice_used + 1,
        updated_at = NOW()
    WHERE id = NEW.merchant_id;

    -- Ghi audit log
    INSERT INTO audit_logs (merchant_id, user_id, entity_type, entity_id, action, old_value, new_value)
    VALUES (
               NEW.merchant_id,
               NULL,
               'Invoice',
               NEW.id,
               'STATUS_CHANGE',
               CONCAT('{"status": "', OLD.status, '"}'),
               CONCAT('{"status": "', NEW.status, '", "invoice_used_incremented": true}')
           );
END IF;

-- X·ª≠ l√Ω tr∆∞·ªùng h·ª£p h·ªßy h√≥a ƒë∆°n: gi·∫£m invoice_used
IF NEW.status = 'CANCELLED' AND OLD.status = 'SUCCESS' AND NEW.merchant_id IS NOT NULL THEN
UPDATE merchants
SET invoice_used = GREATEST(0, invoice_used - 1),
    updated_at = NOW()
WHERE id = NEW.merchant_id;
END IF;
END //

DELIMITER ;


-- Trigger 2: T·ª± ƒë·ªông t√≠nh to√°n total_amount t·ª´ invoice_items
DELIMITER //

CREATE TRIGGER trg_calculate_invoice_totals
    AFTER INSERT ON invoice_items
    FOR EACH ROW
BEGIN
    -- T√≠nh to√°n l·∫°i c√°c t·ªïng ti·ªÅn cho h√≥a ƒë∆°n
    UPDATE invoices_metadata SET
                                 subtotal_amount = (
                                     SELECT COALESCE(SUM(amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 tax_amount = (
                                     SELECT COALESCE(SUM(tax_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 discount_amount = (
                                     SELECT COALESCE(SUM(discount_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 total_amount = (
                                     SELECT COALESCE(SUM(total_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 updated_at = NOW()
    WHERE id = NEW.invoice_id;
END //

DELIMITER ;


-- Trigger 3: T·ª± ƒë·ªông c·∫≠p nh·∫≠t totals khi invoice_items ƒë∆∞·ª£c c·∫≠p nh·∫≠t
DELIMITER //

CREATE TRIGGER trg_update_invoice_totals
    AFTER UPDATE ON invoice_items
    FOR EACH ROW
BEGIN
    UPDATE invoices_metadata SET
                                 subtotal_amount = (
                                     SELECT COALESCE(SUM(amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 tax_amount = (
                                     SELECT COALESCE(SUM(tax_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 discount_amount = (
                                     SELECT COALESCE(SUM(discount_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 total_amount = (
                                     SELECT COALESCE(SUM(total_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = NEW.invoice_id
                                 ),
                                 updated_at = NOW()
    WHERE id = NEW.invoice_id;
END //

DELIMITER ;


-- Trigger 4: T·ª± ƒë·ªông c·∫≠p nh·∫≠t totals khi invoice_items b·ªã x√≥a
DELIMITER //

CREATE TRIGGER trg_delete_invoice_totals
    AFTER DELETE ON invoice_items
    FOR EACH ROW
BEGIN
    UPDATE invoices_metadata SET
                                 subtotal_amount = (
                                     SELECT COALESCE(SUM(amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = OLD.invoice_id
                                 ),
                                 tax_amount = (
                                     SELECT COALESCE(SUM(tax_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = OLD.invoice_id
                                 ),
                                 discount_amount = (
                                     SELECT COALESCE(SUM(discount_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = OLD.invoice_id
                                 ),
                                 total_amount = (
                                     SELECT COALESCE(SUM(total_amount), 0)
                                     FROM invoice_items
                                     WHERE invoice_id = OLD.invoice_id
                                 ),
                                 updated_at = NOW()
    WHERE id = OLD.invoice_id;
END //

DELIMITER ;


-- Trigger 5: T·ª± ƒë·ªông t·∫°o invoice_tax_breakdowns khi invoice ƒë∆∞·ª£c t·∫°o
DELIMITER //

CREATE TRIGGER trg_create_tax_breakdowns
    AFTER INSERT ON invoice_items
    FOR EACH ROW
BEGIN
    -- Ch·ªâ ch·∫°y m·ªôt l·∫ßn sau khi t·∫•t c·∫£ items ƒë∆∞·ª£c insert (ki·ªÉm tra b·∫±ng count)
    INSERT INTO invoice_tax_breakdowns
    (invoice_id, vat_rate_id, vat_rate_code, vat_rate_percent,
     subtotal_amount, discount_amount, taxable_amount, tax_amount, total_amount)
    SELECT
        NEW.invoice_id,
        vr.id,
        vr.rate_code,
        vr.rate_percent,
        COALESCE(SUM(ii.amount), 0) AS subtotal_amount,
        COALESCE(SUM(ii.discount_amount), 0) AS discount_amount,
        COALESCE(SUM(ii.amount - ii.discount_amount), 0) AS taxable_amount,
        COALESCE(SUM(ii.tax_amount), 0) AS tax_amount,
        COALESCE(SUM(ii.total_amount), 0) AS total_amount
    FROM invoice_items ii
             INNER JOIN vat_rates vr ON vr.id = NEW.vat_rate_id
    WHERE ii.invoice_id = NEW.invoice_id
        ON DUPLICATE KEY UPDATE
                             subtotal_amount = VALUES(subtotal_amount),
                             discount_amount = VALUES(discount_amount),
                             taxable_amount = VALUES(taxable_amount),
                             tax_amount = VALUES(tax_amount),
                             total_amount = VALUES(total_amount);
END //

DELIMITER ;


-- Trigger 6: T·ª± ƒë·ªông c·∫≠p nh·∫≠t current_number trong invoice_registrations
DELIMITER //

CREATE TRIGGER trg_update_registration_number
    AFTER INSERT ON invoices_metadata
    FOR EACH ROW
BEGIN
    IF NEW.invoice_registration_id IS NOT NULL AND NEW.status = 'SUCCESS' THEN
    UPDATE invoice_registrations SET
                                     current_number = current_number + 1,
                                     status = CASE
                                                  WHEN current_number + 1 >= to_number THEN 'EXHAUSTED'
                                                  ELSE 'ACTIVE'
                                         END,
                                     updated_at = NOW()
    WHERE id = NEW.invoice_registration_id;
END IF;
END //

DELIMITER ;


-- Trigger 7: T·ª± ƒë·ªông t·∫°o lookup_code khi h√≥a ƒë∆°n ƒë∆∞·ª£c t·∫°o
DELIMITER //

CREATE TRIGGER trg_generate_lookup_code
    BEFORE INSERT ON invoices_metadata
    FOR EACH ROW
BEGIN
    -- T·ª± ƒë·ªông t·∫°o lookup_code n·∫øu ch∆∞a c√≥
    IF NEW.lookup_code IS NULL AND NEW.invoice_number IS NOT NULL THEN
        SET NEW.lookup_code = CONCAT(
            NEW.invoice_number,
            '-',
            LPAD(FLOOR(RAND() * 1000000), 6, '0')
        );
END IF;
END //

DELIMITER ;


-- View: T·ªïng h·ª£p th√¥ng tin h√≥a ƒë∆°n ƒë·∫ßy ƒë·ªß
CREATE VIEW v_invoices_full AS
SELECT
    im.id AS invoice_id,
    im.invoice_number,
    im.symbol_code,
    im.template_code,
    im.cqt_code,
    im.status,
    im.issue_date,
    im.total_amount,
    im.tax_amount,
    im.subtotal_amount,
    im.discount_amount,
    im.currency_code,
    im.payment_method,
    im.issuance_method,
    m.tax_code AS merchant_tax_code,
    m.company_name AS merchant_name,
    im.seller_name,
    im.seller_tax_code,
    im.buyer_name,
    im.buyer_tax_code,
    im.buyer_email,
    im.created_at,
    im.provider_transaction_code
FROM invoices_metadata im
         INNER JOIN merchants m ON m.id = im.merchant_id;


-- View: T·ªïng h·ª£p tax breakdown theo h√≥a ƒë∆°n
CREATE VIEW v_invoice_tax_summary AS
SELECT
    itb.invoice_id,
    im.invoice_number,
    im.symbol_code,
    itb.vat_rate_code,
    itb.vat_rate_percent,
    itb.subtotal_amount,
    itb.taxable_amount,
    itb.tax_amount,
    itb.total_amount
FROM invoice_tax_breakdowns itb
         INNER JOIN invoices_metadata im ON im.id = itb.invoice_id
ORDER BY im.invoice_number, itb.vat_rate_percent DESC;


-- View: Th·ªëng k√™ s·ªë l∆∞·ª£ng h√≥a ƒë∆°n theo tr·∫°ng th√°i
CREATE VIEW v_invoice_stats_by_status AS
SELECT
    m.id AS merchant_id,
    m.tax_code AS merchant_tax_code,
    m.company_name AS merchant_name,
    im.status,
    COUNT(*) AS invoice_count,
    COALESCE(SUM(im.total_amount), 0) AS total_amount,
    COALESCE(SUM(im.tax_amount), 0) AS total_tax_amount
FROM invoices_metadata im
         INNER JOIN merchants m ON m.id = im.merchant_id
WHERE im.is_deleted = FALSE
GROUP BY m.id, m.tax_code, m.company_name, im.status;


-- View: Danh s√°ch pending sync jobs
CREATE VIEW v_pending_sync_jobs AS
SELECT
    isq.id AS queue_id,
    isq.invoice_id,
    im.invoice_number,
    im.symbol_code,
    m.tax_code AS merchant_tax_code,
    sp.provider_code,
    isq.sync_type,
    isq.priority,
    isq.attempt_count,
    isq.max_attempts,
    isq.status,
    isq.error_message,
    isq.next_retry_at
FROM invoice_sync_queue isq
         INNER JOIN invoices_metadata im ON im.id = isq.invoice_id
         INNER JOIN merchants m ON m.id = isq.merchant_id
         LEFT JOIN service_providers sp ON sp.id = isq.provider_id
WHERE isq.status IN ('PENDING', 'RETRYING')
ORDER BY isq.priority ASC, isq.next_retry_at ASC;


-- ============================================================================
-- PH·∫¶N 5: STORED PROCEDURES (TH·ª¶ T·ª§C TH∆Ø·ªúNG D√ôNG)
-- ============================================================================

-- Procedure: C·∫≠p nh·∫≠t invoice_registration khi s·ª≠ d·ª•ng s·ªë h√≥a ƒë∆°n
DELIMITER //

CREATE PROCEDURE sp_use_invoice_number(
    IN p_registration_id BIGINT,
    OUT p_new_number BIGINT
)
BEGIN
    DECLARE v_current_number BIGINT;
    DECLARE v_max_number BIGINT;

    -- L·∫•y s·ªë hi·ªán t·∫°i v√† max
SELECT current_number, max_number INTO v_current_number, v_max_number
FROM invoice_registrations
WHERE id = p_registration_id
    FOR UPDATE;

-- Ki·ªÉm tra c√≤n s·ªë kh√¥ng
IF v_current_number < v_max_number THEN
        -- TƒÉng s·ªë hi·ªán t·∫°i
UPDATE invoice_registrations SET
                                 current_number = current_number + 1,
                                 updated_at = NOW()
WHERE id = p_registration_id;

SET p_new_number = v_current_number + 1;
ELSE
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'D·∫£i s·ªë h√≥a ƒë∆°n ƒë√£ h·∫øt';
END IF;
END //

DELIMITER ;


-- Procedure: Reset invoice_used ƒë·∫ßu th√°ng cho t·∫•t c·∫£ merchants
DELIMITER //

CREATE PROCEDURE sp_reset_monthly_invoice_usage()
BEGIN
UPDATE merchants SET
                     invoice_used = 0,
                     updated_at = NOW()
WHERE status = 'ACTIVE';

SELECT ROW_COUNT() AS merchants_reset;
END //

DELIMITER ;


-- Procedure: T·∫°o adjustment cho h√≥a ƒë∆°n ƒëi·ªÅu ch·ªânh
DELIMITER //

CREATE PROCEDURE sp_create_adjustment(
    IN p_original_invoice_id BIGINT,
    IN p_adjustment_type ENUM('ADJUSTMENT', 'REPLACEMENT', 'CANCELLATION'),
    IN p_agreement_number VARCHAR(50),
    IN p_agreement_date DATE,
    IN p_agreement_content TEXT,
    IN p_reason_code VARCHAR(50),
    IN p_reason_description VARCHAR(500),
    OUT p_adjustment_id BIGINT
        )
BEGIN
    DECLARE v_old_subtotal DECIMAL(18,2);
    DECLARE v_old_tax DECIMAL(18,2);
    DECLARE v_old_total DECIMAL(18,2);

    -- L·∫•y th√¥ng tin h√≥a ƒë∆°n g·ªëc
SELECT subtotal_amount, tax_amount, total_amount
INTO v_old_subtotal, v_old_tax, v_old_total
FROM invoices_metadata
WHERE id = p_original_invoice_id;

-- T·∫°o b·∫£n ghi adjustment
INSERT INTO invoice_adjustments (
    original_invoice_id,
    adjustment_type,
    agreement_number,
    agreement_date,
    agreement_content,
    reason_code,
    reason_description,
    old_subtotal_amount,
    old_tax_amount,
    old_total_amount,
    status,
    created_at
) VALUES (
             p_original_invoice_id,
             p_adjustment_type,
             p_agreement_number,
             p_agreement_date,
             p_agreement_content,
             p_reason_code,
             p_reason_description,
             v_old_subtotal,
             v_old_tax,
             v_old_total,
             'PENDING',
             NOW()
         );

SET p_adjustment_id = LAST_INSERT_ID();
END //

DELIMITER ;


-- Procedure: Retry failed sync jobs
DELIMITER //

CREATE PROCEDURE sp_retry_failed_sync_jobs(
    IN p_limit INT
)
BEGIN
    -- C·∫≠p nh·∫≠t c√°c job failed ƒë·ªÉ retry
UPDATE invoice_sync_queue SET
                              status = 'RETRYING',
                              next_retry_at = DATE_ADD(NOW(), INTERVAL 5 MINUTE),
                              updated_at = NOW()
WHERE status = 'FAILED'
  AND attempt_count < max_attempts
  AND next_retry_at <= NOW()
    LIMIT p_limit;

SELECT ROW_COUNT() AS jobs_requeued;
END //

DELIMITER ;
*/

-- End of Database Schema Version 3
</file>

<file path="src/main/resources/db/migration/Initial_Schema_Ver02.sql">
-- EInvoiceHub Database Schema - Version 2 (Optimized)
-- Database: MariaDB 

-- 1. Merchants Table - Qu·∫£n l√Ω doanh nghi·ªáp
CREATE TABLE merchants (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    tax_code VARCHAR(20) NOT NULL UNIQUE COMMENT 'M√£ s·ªë thu·∫ø - ƒë·ªãnh danh doanh nghi·ªáp',
    company_name VARCHAR(255) NOT NULL COMMENT 'T√™n c√¥ng ty ƒë·∫ßy ƒë·ªß',
    short_name VARCHAR(100) COMMENT 'T√™n vi·∫øt t·∫Øt',
    address TEXT COMMENT 'ƒê·ªãa ch·ªâ tr·ª• s·ªü ch√≠nh',
    district VARCHAR(100) COMMENT 'Qu·∫≠n/Huy·ªán',
    city VARCHAR(100) COMMENT 'T·ªânh/Th√†nh ph·ªë',
    email VARCHAR(255) COMMENT 'Email li√™n h·ªá',
    phone VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    representative_name VARCHAR(100) COMMENT 'T√™n ng∆∞·ªùi ƒë·∫°i di·ªán',
    representative_title VARCHAR(100) COMMENT 'Ch·ª©c danh ng∆∞·ªùi ƒë·∫°i di·ªán',
    subscription_plan ENUM('TRIAL', 'BASIC', 'PREMIUM') NOT NULL DEFAULT 'TRIAL' COMMENT 'G√≥i d·ªãch v·ª•: TRIAL, BASIC, PREMIUM',
    invoice_quota INT NOT NULL DEFAULT 100 COMMENT 'H·∫°n m·ª©c h√≥a ƒë∆°n/th√°ng',
    invoice_used INT NOT NULL DEFAULT 0 COMMENT 'H√≥a ƒë∆°n ƒë√£ s·ª≠ d·ª•ng trong th√°ng',
    is_using_hsm BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'S·ª≠ d·ª•ng HSM hay USB Token ƒë·ªÉ k√Ω ƒëi·ªán t·ª≠',
    status ENUM('ACTIVE', 'INACTIVE', 'SUSPENDED') NOT NULL DEFAULT 'ACTIVE' COMMENT 'Tr·∫°ng th√°i ho·∫°t ƒë·ªông',
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'C·ªù x√≥a m·ªÅm',
    deleted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    INDEX idx_tax_code (tax_code),
    INDEX idx_status (status),
    INDEX idx_subscription_plan (subscription_plan),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω doanh nghi·ªáp s·ª≠ d·ª•ng d·ªãch v·ª• h√≥a ƒë∆°n ƒëi·ªán t·ª≠';


-- 2. Merchant Users - T√†i kho·∫£n ng∆∞·ªùi d√πng c·ªßa Merchant
CREATE TABLE merchant_users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Li√™n k·∫øt v·ªõi doanh nghi·ªáp',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT 'T√™n ƒëƒÉng nh·∫≠p',
    email VARCHAR(255) NOT NULL UNIQUE COMMENT 'Email ng∆∞·ªùi d√πng',
    password_hash VARCHAR(255) NOT NULL COMMENT 'M·∫≠t kh·∫©u ƒë√£ m√£ h√≥a BCrypt',
    full_name VARCHAR(100) COMMENT 'H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß',
    phone VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    avatar_url VARCHAR(500) COMMENT 'URL ·∫£nh ƒë·∫°i di·ªán',
    role ENUM('ADMIN', 'MANAGER', 'STAFF', 'VIEWER') NOT NULL DEFAULT 'STAFF' COMMENT 'Vai tr√≤ trong h·ªá th·ªëng: ADMIN, MANAGER, STAFF, VIEWER',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'K√≠ch ho·∫°t t√†i kho·∫£n',
    is_primary BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'T√†i kho·∫£n ch√≠nh c·ªßa doanh nghi·ªáp',
    last_login_at TIMESTAMP NULL COMMENT 'ƒêƒÉng nh·∫≠p l·∫ßn cu·ªëi',
    failed_login_attempts INT NOT NULL DEFAULT 0 COMMENT 'S·ªë l·∫ßn ƒëƒÉng nh·∫≠p sai',
    locked_until TIMESTAMP NULL COMMENT 'Kh√≥a t√†i kho·∫£n ƒë·∫øn th·ªùi ƒëi·ªÉm',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    CONSTRAINT fk_merchant_users_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_role (role),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='T√†i kho·∫£n ng∆∞·ªùi d√πng thu·ªôc Merchant';


-- 3. API Credentials - B·∫£o m·∫≠t v√† t√≠ch h·ª£p API


CREATE TABLE api_credentials (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu credential',
    client_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'ID c√¥ng khai c·ªßa ·ª©ng d·ª•ng',
    api_key_hash VARCHAR(255) NOT NULL COMMENT 'Hash c·ªßa API Key (SHA-256)',
    api_key_prefix VARCHAR(8) NOT NULL COMMENT '8 k√Ω t·ª± ƒë·∫ßu c·ªßa API Key (hi·ªÉn th·ªã)',
    scopes TEXT NOT NULL COMMENT 'Quy·ªÅn h·∫°n - JSON array: [invoice.create, invoice.view]',
    ip_whitelist TEXT NULL COMMENT 'Danh s√°ch IP ƒë∆∞·ª£c ph√©p - JSON array ho·∫∑c NULL',
    rate_limit_per_hour INT NOT NULL DEFAULT 1000 COMMENT 'Gi·ªõi h·∫°n request/gi·ªù',
    rate_limit_per_day INT NOT NULL DEFAULT 10000 COMMENT 'Gi·ªõi h·∫°n request/ng√†y',
    request_count_hour INT NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong gi·ªù',
    request_count_day INT NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong ng√†y',
    request_count_resetted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm reset counter',
    expired_at TIMESTAMP NULL COMMENT 'Ng√†y h·∫øt h·∫°n - NULL l√† kh√¥ng gi·ªõi h·∫°n',
    last_used_at TIMESTAMP NULL COMMENT 'L·∫ßn s·ª≠ d·ª•ng cu·ªëi',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    created_by BIGINT NULL COMMENT 'Ng∆∞·ªùi t·∫°o - merchant_users.id',
    
    CONSTRAINT fk_api_credentials_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    CONSTRAINT fk_api_credentials_created_by FOREIGN KEY (created_by) 
        REFERENCES merchant_users(id) ON DELETE SET NULL,
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_client_id (client_id),
    INDEX idx_api_key_hash (api_key_hash),
    INDEX idx_expired_at (expired_at),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Credentials cho API access';


-- 4. Service Providers - Nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠
CREATE TABLE service_providers (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    provider_code VARCHAR(20) NOT NULL UNIQUE COMMENT 'M√£ provider: VNPT, VIETTEL, MISA, BKAV',
    provider_name VARCHAR(100) NOT NULL COMMENT 'T√™n ƒë·∫ßy ƒë·ªß nh√† cung c·∫•p',
    official_api_url VARCHAR(500) NOT NULL COMMENT 'URL API ch√≠nh th·ª©c',
    documentation_url VARCHAR(500) NULL COMMENT 'Link t√†i li·ªáu API',
    support_email VARCHAR(255) NULL COMMENT 'Email h·ªó tr·ª£',
    support_phone VARCHAR(20) NULL COMMENT 'Hotline h·ªó tr·ª£',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'Provider c√≤n ho·∫°t ƒë·ªông',
    is_default BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh c·ªßa h·ªá th·ªëng',
    display_order INT NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
    extra_config_schema JSON NULL COMMENT 'Schema c·∫•u h√¨nh b·ªï sung cho provider',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    INDEX idx_provider_code (provider_code),
    INDEX idx_is_active (is_active),
    INDEX idx_is_default (is_default),
    INDEX idx_display_order (display_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠';

-- Insert default providers
INSERT INTO service_providers (provider_code, provider_name, official_api_url, is_active, is_default, display_order) VALUES
('VNPT', 'VNPT Invoice', 'https://api.vnptinvoice.com.vn/v1', TRUE, FALSE, 1),
('VIETTEL', 'Viettel Business Invoice', 'https://ebill.vietteltelecom.vn/api/v1', TRUE, FALSE, 2),
('MISA', 'MISA Mimosa', 'https://api.misa.com.vn/einvoice/v1', FALSE, FALSE, 3),
('BKAV', 'BKAV eInvoice', 'https://einvoice.bkav.com/api/v1', FALSE, FALSE, 4);


-- 5. Merchant Provider Configs - C·∫•u h√¨nh ri√™ng c·ªßa Merchant
CREATE TABLE merchant_provider_configs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu',
    provider_id BIGINT NOT NULL COMMENT 'Nh√† cung c·∫•p ƒë∆∞·ª£c ch·ªçn',
    username_service VARCHAR(100) NOT NULL COMMENT 'T√†i kho·∫£n API do Provider c·∫•p',
    password_service_encrypted VARCHAR(500) NOT NULL COMMENT 'M·∫≠t kh·∫©u API - ƒë√£ m√£ h√≥a AES-256',
    certificate_serial VARCHAR(100) NULL COMMENT 'Serial number c·ªßa ch·ª©ng th∆∞ s·ªë',
    certificate_data TEXT NULL COMMENT 'Ch·ª©ng th∆∞ s·ªë - ƒë√£ m√£ h√≥a',
    certificate_chain LONGTEXT NULL COMMENT 'Chu·ªói ch·ª©ng th∆∞ s·ªë ƒë·∫ßy ƒë·ªß (Certificate Chain)',
    certificate_expired_at TIMESTAMP NULL COMMENT 'H·∫°n ch·ª©ng th∆∞ s·ªë',
    extra_config JSON NULL COMMENT 'C·∫•u h√¨nh b·ªï sung: pattern, serial, template',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C·∫•u h√¨nh c√≤n hi·ªáu l·ª±c',
    is_default BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh c·ªßa Merchant',
    last_sync_at TIMESTAMP NULL COMMENT 'L·∫ßn ƒë·ªìng b·ªô cu·ªëi v·ªõi Provider',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    CONSTRAINT fk_mpc_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    CONSTRAINT fk_mpc_provider FOREIGN KEY (provider_id) 
        REFERENCES service_providers(id) ON DELETE RESTRICT,
    CONSTRAINT uq_merchant_provider UNIQUE (merchant_id, provider_id),
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_provider_id (provider_id),
    INDEX idx_is_active (is_active),
    INDEX idx_is_default (is_default)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='C·∫•u h√¨nh k·∫øt n·ªëi Provider cho t·ª´ng Merchant';


-- 6. Invoice Templates - Qu·∫£n l√Ω M·∫´u s·ªë & K√Ω hi·ªáu h√≥a ƒë∆°n
CREATE TABLE invoice_templates (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu m·∫´u',
    provider_id BIGINT NOT NULL COMMENT 'Nh√† cung c·∫•p h√≥a ƒë∆°n',
    invoice_type_code VARCHAR(10) NOT NULL COMMENT 'Lo·∫°i h√≥a ƒë∆°n: 01GTKT, 02GTTT, 07KPTQ, 03KPTQ...',
    template_code VARCHAR(20) NOT NULL COMMENT 'M·∫´u h√≥a ƒë∆°n: 01GTKT0/001, 02GTTT0/001...',
    symbol_code VARCHAR(10) NOT NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n: AA/22E, AB/23T...',
    current_number INT NOT NULL DEFAULT 0 COMMENT 'S·ªë hi·ªán h√≥a ƒë∆°n hi·ªán t·∫°i',
    prefix VARCHAR(20) NULL COMMENT 'Ti·ªÅn t·ªë s·ªë h√≥a ƒë∆°n',
    suffix VARCHAR(20) NULL COMMENT 'H·∫≠u t·ªë s·ªë h√≥a ƒë∆°n',
    min_number INT NOT NULL DEFAULT 1 COMMENT 'S·ªë b·∫Øt ƒë·∫ßu',
    max_number INT NOT NULL DEFAULT 99999 COMMENT 'S·ªë k·∫øt th√∫c',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'M·∫´u c√≤n hi·ªáu l·ª±c',
    is_sequential BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'S·ª≠ d·ª•ng s·ªë th·ª© t·ª± li√™n t·ª•c',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    CONSTRAINT fk_invoice_template_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    CONSTRAINT fk_invoice_template_provider FOREIGN KEY (provider_id) 
        REFERENCES service_providers(id) ON DELETE RESTRICT,
    CONSTRAINT uq_merchant_template UNIQUE (merchant_id, template_code, symbol_code),
    
    INDEX idx_template_merchant (merchant_id),
    INDEX idx_template_code (template_code),
    INDEX idx_symbol_code (symbol_code),
    INDEX idx_invoice_type (invoice_type_code),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω m·∫´u s·ªë v√† k√Ω hi·ªáu h√≥a ƒë∆°n theo quy ƒë·ªãnh';


-- 7. Customers - Danh m·ª•c kh√°ch h√†ng c·ªßa Merchant
CREATE TABLE customers (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu kh√°ch h√†ng',
    customer_code VARCHAR(50) NULL COMMENT 'M√£ kh√°ch h√†ng n·ªôi b·ªô',
    tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø kh√°ch h√†ng',
    name VARCHAR(255) NOT NULL COMMENT 'T√™n kh√°ch h√†ng/ƒë∆°n v·ªã',
    address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ',
    email VARCHAR(255) NULL COMMENT 'Email nh·∫≠n h√≥a ƒë∆°n',
    phone VARCHAR(20) NULL COMMENT 'ƒêi·ªán tho·∫°i',
    contact_person VARCHAR(100) NULL COMMENT 'Ng∆∞·ªùi li√™n h·ªá',
    bank_account VARCHAR(50) NULL COMMENT 'T√†i kho·∫£n ng√¢n h√†ng',
    bank_name VARCHAR(100) NULL COMMENT 'T√™n ng√¢n h√†ng',
    note TEXT NULL COMMENT 'Ghi ch√∫',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n ho·∫°t ƒë·ªông',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    CONSTRAINT fk_customer_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE CASCADE,
    
    INDEX idx_customer_merchant (merchant_id),
    INDEX idx_customer_code (customer_code),
    INDEX idx_tax_code (tax_code),
    INDEX idx_name (name),
    INDEX idx_email (email),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c kh√°ch h√†ng th∆∞·ªùng xuy√™n c·ªßa Merchant';


-- 8. Invoices Metadata - Th√¥ng tin t√≥m t·∫Øt h√≥a ƒë∆°n
CREATE TABLE invoices_metadata (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp ph√°t h√†nh',
    provider_id BIGINT NULL COMMENT 'Provider x·ª≠ l√Ω h√≥a ƒë∆°n',
    provider_config_id BIGINT NULL COMMENT 'C·∫•u h√¨nh Provider ƒë∆∞·ª£c s·ª≠ d·ª•ng',
    invoice_template_id BIGINT NULL COMMENT 'M·∫´u h√≥a ƒë∆°n ƒë∆∞·ª£c s·ª≠ d·ª•ng',
    client_request_id VARCHAR(100) NULL COMMENT 'ID request t·ª´ Merchant',
    
    -- Th√¥ng tin h√≥a ƒë∆°n
    invoice_number VARCHAR(20) NULL COMMENT 'S·ªë h√≥a ƒë∆°n t·ª´ Provider tr·∫£ v·ªÅ',
    symbol_code VARCHAR(10) NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n (VD: 1C23TML)',
    invoice_type_code VARCHAR(10) NULL COMMENT 'M√£ lo·∫°i h√≥a ƒë∆°n: 01GTKT, 02GTTT, 07KPTQ...',
    template_code VARCHAR(20) NULL COMMENT 'M·∫´u h√≥a ƒë∆°n: 01GTKT0/001, 02GTTT0/001...',
    is_summary_invoice BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'H√≥a ƒë∆°n t·ªïng h·ª£p hay h√≥a ƒë∆°n chi ti·∫øt',
    
    -- Th√¥ng tin C∆° quan Thu·∫ø
    cqt_code VARCHAR(50) NULL COMMENT 'M√£ C∆° quan Thu·∫ø qu·∫£n l√Ω',
    
    -- Th√¥ng tin ng∆∞·ªùi b√°n (t·ª´ merchant data)
    seller_name VARCHAR(255) NULL COMMENT 'T√™n ng∆∞·ªùi b√°n',
    seller_tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi b√°n',
    seller_address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi b√°n',
    
    -- Th√¥ng tin ng∆∞·ªùi mua
    buyer_name VARCHAR(255) NULL COMMENT 'T√™n ng∆∞·ªùi mua',
    buyer_tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi mua',
    buyer_email VARCHAR(255) NULL COMMENT 'Email ng∆∞·ªùi mua (nh·∫≠n h√≥a ƒë∆°n)',
    buyer_phone VARCHAR(20) NULL COMMENT 'ƒêi·ªán tho·∫°i ng∆∞·ªùi mua',
    buyer_address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi mua',
    customer_id BIGINT NULL COMMENT 'Li√™n k·∫øt v·ªõi b·∫£ng customers',
    
    -- Th√¥ng tin t√†i ch√≠nh
    subtotal_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø',
    tax_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ø',
    discount_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng chi·∫øt kh·∫•u',
    total_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thanh to√°n',
    currency_code VARCHAR(3) NOT NULL DEFAULT 'VND' COMMENT 'ƒê∆°n v·ªã ti·ªÅn t·ªá',
    exchange_rate DECIMAL(10,4) NOT NULL DEFAULT 1.0000 COMMENT 'T·ª∑ gi√° v·ªõi VND',
    
    -- Th√¥ng tin th·ªùi gian
    issue_date DATE NULL COMMENT 'Ng√†y l·∫≠p h√≥a ƒë∆°n',
    accounting_date DATE NULL COMMENT 'Ng√†y h·∫°ch to√°n',
    due_date DATE NULL COMMENT 'Ng√†y thanh to√°n ƒë·∫øn h·∫°n',
    
    -- Tr·∫°ng th√°i v√† ƒëi·ªÅu kho·∫£n
    status ENUM('DRAFT', 'PENDING', 'SIGNING', 'SENT_TO_PROVIDER', 'SUCCESS', 'FAILED', 'CANCELLED', 'REPLACED') NOT NULL DEFAULT 'DRAFT' COMMENT 'Tr·∫°ng th√°i x·ª≠ l√Ω h√≥a ƒë∆°n',
    status_message TEXT NULL COMMENT 'Th√¥ng b√°o tr·∫°ng th√°i chi ti·∫øt',
    cancellation_reason VARCHAR(500) NULL COMMENT 'L√Ω do h·ªßy/thay th·∫ø',
    replaced_by_invoice_id BIGINT NULL COMMENT 'ID h√≥a ƒë∆°n thay th·∫ø',
    
    -- Tracking
    signed_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm k√Ω ƒëi·ªán t·ª≠',
    sent_to_provider_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i sang Provider',
    received_from_provider_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
    delivered_to_buyer_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i h√≥a ƒë∆°n cho ng∆∞·ªùi mua',
    
    -- Provider response reference
    provider_transaction_code VARCHAR(100) NULL COMMENT 'M√£ giao d·ªãch t·ª´ Provider',
    provider_error_code VARCHAR(50) NULL COMMENT 'M√£ l·ªói t·ª´ Provider',
    provider_error_message TEXT NULL COMMENT 'Chi ti·∫øt l·ªói t·ª´ Provider',
    
    -- Soft delete
    is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'H√≥a ƒë∆°n ƒë√£ b·ªã x√≥a',
    deleted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
    deleted_by BIGINT NULL COMMENT 'Ng∆∞·ªùi x√≥a - merchant_users.id',
    
    -- Timestamps
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    -- Foreign Keys
    CONSTRAINT fk_invoice_merchant FOREIGN KEY (merchant_id) 
        REFERENCES merchants(id) ON DELETE RESTRICT,
    CONSTRAINT fk_invoice_provider FOREIGN KEY (provider_id) 
        REFERENCES service_providers(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_config FOREIGN KEY (provider_config_id) 
        REFERENCES merchant_provider_configs(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_template FOREIGN KEY (invoice_template_id) 
        REFERENCES invoice_templates(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_customer FOREIGN KEY (customer_id) 
        REFERENCES customers(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_replaced_by FOREIGN KEY (replaced_by_invoice_id) 
        REFERENCES invoices_metadata(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_deleted_by FOREIGN KEY (deleted_by) 
        REFERENCES merchant_users(id) ON DELETE SET NULL,
    
    -- Indexes for performance
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_provider_id (provider_id),
    INDEX idx_invoice_number (invoice_number),
    INDEX idx_symbol_code (symbol_code),
    INDEX idx_buyer_tax_code (buyer_tax_code),
    INDEX idx_status (status),
    INDEX idx_issue_date (issue_date),
    INDEX idx_created_at (created_at),
    INDEX idx_client_request_id (client_request_id),
    INDEX idx_merchant_status (merchant_id, status),
    INDEX idx_merchant_created (merchant_id, created_at),
    INDEX idx_cqt_code (cqt_code),
    INDEX idx_invoice_template (invoice_template_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Metadata h√≥a ƒë∆°n - ph·ª•c v·ª• tra c·ª©u nhanh';


-- 9. Invoice Items - Chi ti·∫øt h√†ng h√≥a/d·ªãch v·ª• trong h√≥a ƒë∆°n
CREATE TABLE invoice_items (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    invoice_id BIGINT NOT NULL COMMENT 'ID h√≥a ƒë∆°n cha',
    line_number INT NOT NULL DEFAULT 1 COMMENT 'S·ªë th·ª© t·ª± d√≤ng',
    product_name VARCHAR(500) NOT NULL COMMENT 'T√™n s·∫£n ph·∫©m/d·ªãch v·ª•',
    product_code VARCHAR(100) NULL COMMENT 'M√£ s·∫£n ph·∫©m theo danh m·ª•c',
    unit_name VARCHAR(50) NOT NULL COMMENT 'ƒê∆°n v·ªã t√≠nh: c√°i, kg, chi·∫øc...',
    quantity DECIMAL(18,4) NOT NULL DEFAULT 0 COMMENT 'S·ªë l∆∞·ª£ng',
    unit_price DECIMAL(18,4) NOT NULL DEFAULT 0 COMMENT 'ƒê∆°n gi√° tr∆∞·ªõc thu·∫ø',
    amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Th√†nh ti·ªÅn = quantity * unit_price',
    discount_rate DECIMAL(5,2) NOT NULL DEFAULT 0 COMMENT 'T·ª∑ l·ªá chi·∫øt kh·∫•u (%)',
    discount_amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Ti·ªÅn chi·∫øt kh·∫•u',
    tax_rate DECIMAL(5,2) NOT NULL DEFAULT 0 COMMENT 'Thu·∫ø su·∫•t GTGT (%)',
    tax_amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Ti·ªÅn thu·∫ø GTGT',
    total_amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Th√†nh ti·ªÅn bao g·ªìm thu·∫ø',
    description TEXT NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt s·∫£n ph·∫©m',
    tax_category_code VARCHAR(20) NULL COMMENT 'M√£ nh√≥m h√†ng h√≥a theo thu·∫ø',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    
    CONSTRAINT fk_invoice_item_invoice FOREIGN KEY (invoice_id) 
        REFERENCES invoices_metadata(id) ON DELETE CASCADE,
    
    INDEX idx_item_invoice (invoice_id),
    INDEX idx_line_number (line_number)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Chi ti·∫øt t·ª´ng d√≤ng h√†ng h√≥a/d·ªãch v·ª• trong h√≥a ƒë∆°n';


-- 10. Invoice Payloads - L∆∞u tr·ªØ n·ªôi dung XML/JSON g·ªëc (Thay th·∫ø MongoDB)
CREATE TABLE invoice_payloads (
    invoice_id BIGINT NOT NULL PRIMARY KEY COMMENT 'ID h√≥a ƒë∆°n - kh√≥a ch√≠nh v√† kh√≥a ngo·∫°i',
    raw_data JSON NULL COMMENT 'D·ªØ li·ªáu th√¥ request/response d·∫°ng JSON',
    xml_content LONGTEXT NULL COMMENT 'N·ªôi dung XML g·ªëc c·ªßa h√≥a ƒë∆°n (ph·ª•c v·ª• in ·∫•n)',
    json_content LONGTEXT NULL COMMENT 'N·ªôi dung JSON ƒë·∫ßy ƒë·ªß c·ªßa h√≥a ƒë∆°n',
    signed_xml LONGTEXT NULL COMMENT 'XML ƒë√£ k√Ω ƒëi·ªán t·ª≠ (ch·ªØ k√Ω s·ªë)',
    pdf_data LONGTEXT NULL COMMENT 'D·ªØ li·ªáu PDF ƒë√£ t·∫°o (base64)',
    extra_data JSON NULL COMMENT 'D·ªØ li·ªáu b·ªï sung kh√°c',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm l∆∞u',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    CONSTRAINT fk_invoice_payload_invoice FOREIGN KEY (invoice_id) 
        REFERENCES invoices_metadata(id) ON DELETE CASCADE,
    
    INDEX idx_payload_created (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u tr·ªØ n·ªôi dung XML/JSON g·ªëc h√≥a ƒë∆°n - thay th·∫ø MongoDB';


-- 11. Tax Authority Responses - Ph·∫£n h·ªìi t·ª´ C∆° quan Thu·∫ø
CREATE TABLE tax_authority_responses (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    invoice_id BIGINT NOT NULL COMMENT 'H√≥a ƒë∆°n li√™n quan',
    cqt_code VARCHAR(50) NOT NULL COMMENT 'M√£ C∆° quan Thu·∫ø',
    status_from_cqt VARCHAR(50) NOT NULL COMMENT 'Tr·∫°ng th√°i t·ª´ C∆° quan Thu·∫ø: APPROVED, REJECTED, PENDING',
    processing_code VARCHAR(100) NULL COMMENT 'M√£ x·ª≠ l√Ω t·ª´ C∆° quan Thu·∫ø',
    signature_data TEXT NULL COMMENT 'D·ªØ li·ªáu ch·ªØ k√Ω t·ª´ C∆° quan Thu·∫ø',
    raw_response JSON NULL COMMENT 'Response th√¥ t·ª´ C∆° quan Thu·∫ø',
    error_code VARCHAR(50) NULL COMMENT 'M√£ l·ªói t·ª´ C∆° quan Thu·∫ø',
    error_message TEXT NULL COMMENT 'Th√¥ng b√°o l·ªói t·ª´ C∆° quan Thu·∫ø',
    received_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
    processed_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x·ª≠ l√Ω ho√†n t·∫•t',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o b·∫£n ghi',
    
    CONSTRAINT fk_tax_response_invoice FOREIGN KEY (invoice_id) 
        REFERENCES invoices_metadata(id) ON DELETE CASCADE,
    
    INDEX idx_tax_response_invoice (invoice_id),
    INDEX idx_cqt_code (cqt_code),
    INDEX idx_status_cqt (status_from_cqt),
    INDEX idx_received_at (received_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u v·∫øt t∆∞∆°ng t√°c v·ªõi C∆° quan Thu·∫ø';


-- 12. Audit Log - Nh·∫≠t k√Ω thao t√°c
CREATE TABLE audit_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NULL COMMENT 'Doanh nghi·ªáp li√™n quan',
    user_id BIGINT NULL COMMENT 'Ng∆∞·ªùi th·ª±c hi·ªán',
    entity_type VARCHAR(50) NOT NULL COMMENT 'Lo·∫°i entity: Invoice, Merchant, Config...',
    entity_id BIGINT NOT NULL COMMENT 'ID c·ªßa entity',
    action VARCHAR(50) NOT NULL COMMENT 'H√†nh ƒë·ªông: CREATE, UPDATE, DELETE, STATUS_CHANGE',
    old_value JSON NULL COMMENT 'Gi√° tr·ªã c≈©',
    new_value JSON NULL COMMENT 'Gi√° tr·ªã m·ªõi',
    ip_address VARCHAR(45) NULL COMMENT 'IP th·ª±c hi·ªán',
    user_agent VARCHAR(500) NULL COMMENT 'User Agent c·ªßa browser/client',
    request_id VARCHAR(100) NULL COMMENT 'ID request t·ª´ frontend',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm x·∫£y ra',
    
    INDEX idx_merchant_id (merchant_id),
    INDEX idx_user_id (user_id),
    INDEX idx_entity (entity_type, entity_id),
    INDEX idx_action (action),
    INDEX idx_created_at (created_at),
    INDEX idx_merchant_entity (merchant_id, entity_type, entity_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Nh·∫≠t k√Ω thay ƒë·ªïi h·ªá th·ªëng';


-- 13. System Configuration - C·∫•u h√¨nh h·ªá th·ªëng
CREATE TABLE system_config (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    config_key VARCHAR(100) NOT NULL UNIQUE COMMENT 'Kh√≥a c·∫•u h√¨nh',
    config_value TEXT NOT NULL COMMENT 'Gi√° tr·ªã c·∫•u h√¨nh',
    config_type VARCHAR(20) NOT NULL DEFAULT 'STRING' COMMENT 'Lo·∫°i: STRING, NUMBER, BOOLEAN, JSON',
    description VARCHAR(500) NULL COMMENT 'M√¥ t·∫£ c·∫•u h√¨nh',
    is_encrypted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'C√≥ c·∫ßn m√£ h√≥a kh√¥ng',
    is_editable BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≥ th·ªÉ ch·ªânh s·ª≠a kh√¥ng',
    updated_by BIGINT NULL COMMENT 'Ng∆∞·ªùi c·∫≠p nh·∫≠t cu·ªëi',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    
    CONSTRAINT fk_config_updated_by FOREIGN KEY (updated_by) 
        REFERENCES merchant_users(id) ON DELETE SET NULL,
    
    INDEX idx_config_key (config_key)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='C·∫•u h√¨nh h·ªá th·ªëng';

-- Insert default configurations
INSERT INTO system_config (config_key, config_value, config_type, description) VALUES
('SYSTEM_NAME', 'EInvoiceHub', 'STRING', 'T√™n hi·ªÉn th·ªã c·ªßa h·ªá th·ªëng'),
('INVOICE_EXPIRY_DAYS', '30', 'NUMBER', 'S·ªë ng√†y h√≥a ƒë∆°n c√≥ hi·ªáu l·ª±c sau khi ph√°t h√†nh'),
('MAX_RETRY_ATTEMPTS', '3', 'NUMBER', 'S·ªë l·∫ßn th·ª≠ l·∫°i khi g·ªçi Provider th·∫•t b·∫°i'),
('RETRY_DELAY_MS', '1000', 'NUMBER', 'Th·ªùi gian ch·ªù gi·ªØa c√°c l·∫ßn th·ª≠ l·∫°i (milliseconds)'),
('SESSION_TIMEOUT_MINUTES', '60', 'NUMBER', 'Th·ªùi gian timeout c·ªßa session'),
('PASSWORD_MIN_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i t·ªëi thi·ªÉu c·ªßa m·∫≠t kh·∫©u'),
('API_KEY_PREFIX_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i prefix hi·ªÉn th·ªã c·ªßa API Key'),
('DEFAULT_CURRENCY', 'VND', 'STRING', 'ƒê∆°n v·ªã ti·ªÅn t·ªá m·∫∑c ƒë·ªãnh'),
('TAX_DEFAULT_RATE', '10.00', 'NUMBER', 'Thu·∫ø su·∫•t m·∫∑c ƒë·ªãnh (%)'),
('INVOICE_NUMBER_FORMAT', 'PREFIX + NUMBER + SUFFIX', 'STRING', 'C·∫•u tr√∫c s·ªë h√≥a ƒë∆°n m·∫∑c ƒë·ªãnh');

-- End of Migration V1
</file>

<file path="src/main/resources/db/migration/Initial_Schema_Ver03.sql">
-- EInvoiceHub Database Schema
-- Database: MariaDB   |   Character Set: utf8mb4_unicode_ci

--  I: NH√ìM DANH M·ª§C
-- 1. Invoice Types - Danh m·ª•c lo·∫°i h√≥a ƒë∆°n
CREATE TABLE invoice_types
(
    id         BIGINT AUTO_INCREMENT PRIMARY KEY,
    type_code  VARCHAR(10)  NOT NULL UNIQUE COMMENT 'M√£ lo·∫°i (VD: 01GTKT)',
    type_name  VARCHAR(100) NOT NULL COMMENT 'T√™n lo·∫°i h√≥a ƒë∆°n',
    is_active  BOOLEAN      NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP             DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 2. Invoice Status - Tr·∫°ng th√°i h√≥a ƒë∆°n
CREATE TABLE invoice_status
(
    id          INT PRIMARY KEY,
    name        VARCHAR(100) NOT NULL UNIQUE COMMENT 'DRAFT, SUCCESS, FAILED...',
    description VARCHAR(255) NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 3. Payment Method - Ph∆∞∆°ng th·ª©c thanh to√°n
CREATE TABLE payment_method
(
    id          BIGINT AUTO_INCREMENT PRIMARY KEY,
    method_code VARCHAR(10)  NOT NULL UNIQUE COMMENT 'TM, CK...',
    method_name VARCHAR(100) NOT NULL,
    is_active   BOOLEAN      NOT NULL DEFAULT TRUE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- II: NH√ìM QU·∫¢N TR·ªä DOANH NGHI·ªÜP
-- 4. Merchants - Th√¥ng tin doanh nghi·ªáp
CREATE TABLE merchants
(
    id           BIGINT AUTO_INCREMENT PRIMARY KEY,
    tax_code     VARCHAR(20)  NOT NULL UNIQUE,
    company_name VARCHAR(255) NOT NULL,
    address      TEXT,
    email        VARCHAR(255),
    phone        VARCHAR(20),
    is_active    BOOLEAN   DEFAULT TRUE,
    created_at   TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 5. Merchant User - Ng∆∞·ªùi d√πng (UserAuthor)
CREATE TABLE merchant_user
(
    id            BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id   BIGINT       NOT NULL,
    username      VARCHAR(50)  NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    full_name     VARCHAR(100),
    role          VARCHAR(20) DEFAULT 'STAFF',
    CONSTRAINT fk_user_merchant FOREIGN KEY (merchant_id) REFERENCES merchants (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 6. Merchant Provider Configs - C·∫•u h√¨nh k·∫øt n·ªëi NCC (StoreProvider)
CREATE TABLE merchant_provider_configs
(
    id                         BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id                BIGINT       NOT NULL,
    provider_code              VARCHAR(20)  NOT NULL COMMENT 'VNPT, VIETTEL, BKAV...',
    username_service           VARCHAR(100) NOT NULL,
    password_service_encrypted VARCHAR(500) NOT NULL,
    is_active                  BOOLEAN DEFAULT TRUE,
    CONSTRAINT fk_config_merchant FOREIGN KEY (merchant_id) REFERENCES merchants (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- III.NH√ìM NGHI·ªÜP V·ª§ H√ìA ƒê∆†N
-- 7. Invoice Template - M·∫´u s·ªë & K√Ω hi·ªáu (StoreSerial)
CREATE TABLE invoice_template
(
    id             BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id    BIGINT      NOT NULL,
    config_id      BIGINT      NOT NULL COMMENT 'Li√™n k·∫øt StoreProvider',
    template_code  VARCHAR(20) NOT NULL COMMENT 'M·∫´u: 01GTKT0/001',
    symbol_code    VARCHAR(10) NOT NULL COMMENT 'K√Ω hi·ªáu: 1C23TML',
    current_number INT DEFAULT 0,
    CONSTRAINT fk_template_merchant FOREIGN KEY (merchant_id) REFERENCES merchants (id),
    CONSTRAINT fk_template_config FOREIGN KEY (config_id) REFERENCES merchant_provider_configs (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 8. Invoices Metadata - Th√¥ng tin t·ªïng qu√°t h√≥a ƒë∆°n
CREATE TABLE invoice_metadata
(
    id                BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id       BIGINT NOT NULL,
    user_author_id    BIGINT NOT NULL,
    template_id       BIGINT NOT NULL,
    type_id           BIGINT NOT NULL,
    status_id         INT    NOT NULL,
    payment_method_id BIGINT NOT NULL,

    invoice_number    VARCHAR(20),
    issue_date        DATE,

    -- Th√¥ng tin ng∆∞·ªùi mua (Flattened t·ª´ b·∫£ng Customers c≈©)
    buyer_name        VARCHAR(255),
    buyer_tax_code    VARCHAR(20),
    buyer_email       VARCHAR(255),
    buyer_address     TEXT,

    -- Ti·ªÅn b·∫°c
    subtotal_amount   DECIMAL(18, 2) DEFAULT 0,
    tax_amount        DECIMAL(18, 2) DEFAULT 0,
    total_amount      DECIMAL(18, 2) DEFAULT 0,

    created_at        TIMESTAMP      DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT fk_inv_merchant FOREIGN KEY (merchant_id) REFERENCES merchants (id),
    CONSTRAINT fk_inv_user FOREIGN KEY (user_author_id) REFERENCES merchant_user (id),
    CONSTRAINT fk_inv_template FOREIGN KEY (template_id) REFERENCES invoice_template (id),
    CONSTRAINT fk_inv_type FOREIGN KEY (type_id) REFERENCES invoice_types (id),
    CONSTRAINT fk_inv_status FOREIGN KEY (status_id) REFERENCES invoice_status (id),
    CONSTRAINT fk_inv_payment FOREIGN KEY (payment_method_id) REFERENCES payment_method (id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 9. Invoice Items - Chi ti·∫øt d√≤ng h√†ng
CREATE TABLE invoice_items
(
    id           BIGINT AUTO_INCREMENT PRIMARY KEY,
    invoice_id   BIGINT       NOT NULL,
    line_number  INT          NOT NULL,
    product_name VARCHAR(500) NOT NULL,
    quantity     DECIMAL(18, 4) DEFAULT 0,
    unit_price   DECIMAL(18, 4) DEFAULT 0,
    tax_rate     DECIMAL(5, 2)  DEFAULT 0,
    total_amount DECIMAL(18, 2) DEFAULT 0,
    CONSTRAINT fk_items_invoice FOREIGN KEY (invoice_id) REFERENCES invoice_metadata (id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
</file>

<file path="src/main/resources/db/migration/Initial_Schema_Ver04.sql">
-- EInvoiceHub Database Schema - Version 3
-- Database: MariaDB   |   Character Set: utf8mb4_unicode_ci

--  I: C√ÅC B·∫¢NG DANH M·ª§C (CATALOG TABLES)
-- 1. Invoice Types - Danh m·ª•c lo·∫°i h√≥a ƒë∆°n chu·∫©n TCT
CREATE TABLE invoice_types (
       id BIGINT AUTO_INCREMENT PRIMARY KEY,
       type_code VARCHAR(10) NOT NULL UNIQUE COMMENT 'M√£ lo·∫°i h√≥a ƒë∆°n: 01GTKT, 02GTTT, 07KPTQ, 03KPTQ...',
       type_name VARCHAR(100) NOT NULL COMMENT 'T√™n lo·∫°i h√≥a ƒë∆°n',
       description TEXT NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
       is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
       display_order INT NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
       created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
       updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
       INDEX idx_type_code (type_code),
       INDEX idx_is_active (is_active),
       INDEX idx_display_order (display_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c lo·∫°i h√≥a ƒë∆°n theo quy ƒë·ªãnh TCT';

-- Insert danh m·ª•c lo·∫°i h√≥a ƒë∆°n chu·∫©n
INSERT INTO invoice_types (type_code, type_name, description, display_order) VALUES
     ('01GTKT', 'H√≥a ƒë∆°n gi√° tr·ªã gia tƒÉng', 'H√≥a ƒë∆°n GTGT m·∫´u 01GTKT theo Th√¥ng t∆∞ 78/2021/TT-BTC', 1),
     ('02GTTT', 'H√≥a ƒë∆°n b√°n h√†ng', 'H√≥a ƒë∆°n b√°n h√†ng m·∫´u 02GTTT theo Th√¥ng t∆∞ 78/2021/TT-BTC', 2),
     ('07KPTQ', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ ki·ªÉm so√°t', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ ki·ªÉm so√°t theo Ngh·ªã ƒë·ªãnh 123/2020/Nƒê-CP', 3),
     ('03KPTQ', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ kh√¥ng ki·ªÉm so√°t', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ kh√¥ng ki·ªÉm so√°t theo Ngh·ªã ƒë·ªãnh 123/2020/Nƒê-CP', 4),
     ('04HGDL', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ h√†ng kh√¥ng', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ cho d·ªãch v·ª• h√†ng kh√¥ng', 5),
     ('01TTDN', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ t√†i ch√≠nh', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ cho t·ªï ch·ª©c t√≠n d·ª•ng', 6);


-- 2. Payment Methods - Danh m·ª•c ph∆∞∆°ng th·ª©c thanh to√°n chu·∫©n
CREATE TABLE payment_methods (
     id BIGINT AUTO_INCREMENT PRIMARY KEY,
     method_code VARCHAR(10) NOT NULL UNIQUE COMMENT 'M√£ ph∆∞∆°ng th·ª©c: TM (Ti·ªÅn m·∫∑t), CK (Chuy·ªÉn kho·∫£n), TM/CK...',
     method_name VARCHAR(100) NOT NULL COMMENT 'T√™n ph∆∞∆°ng th·ª©c thanh to√°n',
     description TEXT NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
     is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
     display_order INT NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
     created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
     updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

     INDEX idx_method_code (method_code),
     INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c ph∆∞∆°ng th·ª©c thanh to√°n chu·∫©n';

-- Insert danh m·ª•c ph∆∞∆°ng th·ª©c thanh to√°n
INSERT INTO payment_methods (method_code, method_name, description, display_order) VALUES
   ('TM', 'Ti·ªÅn m·∫∑t', 'Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t tr·ª±c ti·∫øp', 1),
   ('CK', 'Chuy·ªÉn kho·∫£n', 'Thanh to√°n qua chuy·ªÉn kho·∫£n ng√¢n h√†ng', 2),
   ('TM/CK', 'Ti·ªÅn m·∫∑t/Chuy·ªÉn kho·∫£n', 'K·∫øt h·ª£p c·∫£ hai h√¨nh th·ª©c', 3),
   ('POS', 'Th·∫ª POS', 'Thanh to√°n qua m√°y POS', 4),
   ('V√ç ƒêI·ªÜN T·ª¨', 'V√≠ ƒëi·ªán t·ª≠', 'Thanh to√°n qua v√≠ ƒëi·ªán t·ª≠ (MoMo, ZaloPay, VNPay...)', 5),
   ('TH·∫∫', 'Th·∫ª ng√¢n h√†ng', 'Thanh to√°n b·∫±ng th·∫ª t√≠n d·ª•ng/ghi n·ª£', 6);


-- 3. VAT Rates - Danh m·ª•c thu·∫ø su·∫•t GTGT
CREATE TABLE vat_rates (
   id BIGINT AUTO_INCREMENT PRIMARY KEY,
   rate_code VARCHAR(10) NOT NULL UNIQUE COMMENT 'M√£ thu·∫ø su·∫•t: 0, 5, 8, 10, KCT, KKKNT',
   rate_percent DECIMAL(5,2) NOT NULL COMMENT 'Gi√° tr·ªã ph·∫ßn trƒÉm thu·∫ø su·∫•t',
   rate_name VARCHAR(100) NOT NULL COMMENT 'T√™n thu·∫ø su·∫•t',
   description TEXT NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
   is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
   display_order INT NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
   created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
   updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
   CONSTRAINT chk_vat_rate_percent CHECK (rate_percent >= 0),
   INDEX idx_rate_code (rate_code),
   INDEX idx_rate_percent (rate_percent),
   INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c thu·∫ø su·∫•t GTGT theo quy ƒë·ªãnh';

-- Insert danh m·ª•c thu·∫ø su·∫•t
INSERT INTO vat_rates (rate_code, rate_percent, rate_name, description, display_order) VALUES
   ('0', 0.00, 'Thu·∫ø su·∫•t 0%', '√Åp d·ª•ng cho h√†ng h√≥a, d·ªãch v·ª• xu·∫•t kh·∫©u', 1),
   ('5', 5.00, 'Thu·∫ø su·∫•t 5%', '√Åp d·ª•ng cho h√†ng h√≥a, d·ªãch v·ª• thi·∫øt y·∫øu', 2),
   ('8', 8.00, 'Thu·∫ø su·∫•t 8%', 'Gi·∫£m thu·∫ø theo Ngh·ªã quy·∫øt 43/2022/QH15', 3),
   ('10', 10.00, 'Thu·∫ø su·∫•t 10%', 'Thu·∫ø su·∫•t th√¥ng th∆∞·ªùng GTGT', 4),
   ('KCT', 0.00, 'Kh√¥ng ch·ªãu thu·∫ø', 'H√†ng h√≥a, d·ªãch v·ª• kh√¥ng ch·ªãu thu·∫ø GTGT', 5),
   ('KKKNT', 0.00, 'Kh√¥ng k√™ khai, t√≠nh n·ªôp', 'H√†ng h√≥a, d·ªãch v·ª• kh√¥ng k√™ khai n·ªôp thu·∫ø GTGT', 6);


-- II: C√ÅC B·∫¢NG NGHI·ªÜP V·ª§ CH√çNH (CORE BUSINESS TABLES)
-- 4. Merchants Table - Qu·∫£n l√Ω doanh nghi·ªáp (ƒê√£ c·∫≠p nh·∫≠t)
CREATE TABLE merchants (
   id BIGINT AUTO_INCREMENT PRIMARY KEY,
   tax_code VARCHAR(20) NOT NULL UNIQUE COMMENT 'M√£ s·ªë thu·∫ø - ƒë·ªãnh danh doanh nghi·ªáp',
   company_name VARCHAR(255) NOT NULL COMMENT 'T√™n c√¥ng ty ƒë·∫ßy ƒë·ªß',
   short_name VARCHAR(100) COMMENT 'T√™n vi·∫øt t·∫Øt',
   address TEXT COMMENT 'ƒê·ªãa ch·ªâ tr·ª• s·ªü ch√≠nh',
   district VARCHAR(100) COMMENT 'Qu·∫≠n/Huy·ªán',
   city VARCHAR(100) COMMENT 'T·ªânh/Th√†nh ph·ªë',
   email VARCHAR(255) COMMENT 'Email li√™n h·ªá',
   phone VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
   representative_name VARCHAR(100) COMMENT 'T√™n ng∆∞·ªùi ƒë·∫°i di·ªán',
   representative_title VARCHAR(100) COMMENT 'Ch·ª©c danh ng∆∞·ªùi ƒë·∫°i di·ªán',
   tax_authority_code VARCHAR(10) NULL COMMENT 'M√£ c∆° quan thu·∫ø qu·∫£n l√Ω (VD: 01GD, 02HT...)',

   subscription_plan ENUM('TRIAL', 'BASIC', 'PREMIUM') NOT NULL DEFAULT 'TRIAL' COMMENT 'G√≥i d·ªãch v·ª•: TRIAL, BASIC, PREMIUM',
   invoice_quota INT NOT NULL DEFAULT 100 COMMENT 'H·∫°n m·ª©c h√≥a ƒë∆°n/th√°ng',
   invoice_used INT NOT NULL DEFAULT 0 COMMENT 'H√≥a ƒë∆°n ƒë√£ s·ª≠ d·ª•ng trong th√°ng',
   is_using_hsm BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'S·ª≠ d·ª•ng HSM hay USB Token ƒë·ªÉ k√Ω ƒëi·ªán t·ª≠',
   status ENUM('ACTIVE', 'INACTIVE', 'SUSPENDED') NOT NULL DEFAULT 'ACTIVE' COMMENT 'Tr·∫°ng th√°i ho·∫°t ƒë·ªông',
   is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'C·ªù x√≥a m·ªÅm',
   deleted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
   created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
   updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

   INDEX idx_tax_code (tax_code),
   INDEX idx_status (status),
   INDEX idx_subscription_plan (subscription_plan),
   INDEX idx_created_at (created_at),
   INDEX idx_tax_authority (tax_authority_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω doanh nghi·ªáp s·ª≠ d·ª•ng d·ªãch v·ª• h√≥a ƒë∆°n ƒëi·ªán t·ª≠';


-- 5. Merchant Users - T√†i kho·∫£n ng∆∞·ªùi d√πng c·ªßa Merchant
CREATE TABLE merchant_users (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Li√™n k·∫øt v·ªõi doanh nghi·ªáp',
    username VARCHAR(50) NOT NULL UNIQUE COMMENT 'T√™n ƒëƒÉng nh·∫≠p',
    email VARCHAR(255) NOT NULL UNIQUE COMMENT 'Email ng∆∞·ªùi d√πng',
    password_hash VARCHAR(255) NOT NULL COMMENT 'M·∫≠t kh·∫©u ƒë√£ m√£ h√≥a BCrypt',
    full_name VARCHAR(100) COMMENT 'H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß',
    phone VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    avatar_url VARCHAR(500) COMMENT 'URL ·∫£nh ƒë·∫°i di·ªán',
    role ENUM('ADMIN', 'MANAGER', 'STAFF', 'VIEWER') NOT NULL DEFAULT 'STAFF' COMMENT 'Vai tr√≤ trong h·ªá th·ªëng: ADMIN, MANAGER, STAFF, VIEWER',
    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'K√≠ch ho·∫°t t√†i kho·∫£n',
    is_primary BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'T√†i kho·∫£n ch√≠nh c·ªßa doanh nghi·ªáp',
    last_login_at TIMESTAMP NULL COMMENT 'ƒêƒÉng nh·∫≠p l·∫ßn cu·ªëi',
    failed_login_attempts INT NOT NULL DEFAULT 0 COMMENT 'S·ªë l·∫ßn ƒëƒÉng nh·∫≠p sai',
    locked_until TIMESTAMP NULL COMMENT 'Kh√≥a t√†i kho·∫£n ƒë·∫øn th·ªùi ƒëi·ªÉm',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT fk_merchant_users_merchant FOREIGN KEY (merchant_id)
        REFERENCES merchants(id) ON DELETE CASCADE,

    INDEX idx_merchant_id (merchant_id),
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_role (role),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='T√†i kho·∫£n ng∆∞·ªùi d√πng thu·ªôc Merchant';

-- 6. API Credentials - B·∫£o m·∫≠t v√† t√≠ch h·ª£p API
CREATE TABLE api_credentials (
     id BIGINT AUTO_INCREMENT PRIMARY KEY,
     merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu credential',
     client_id VARCHAR(50) NOT NULL UNIQUE COMMENT 'ID c√¥ng khai c·ªßa ·ª©ng d·ª•ng',
     api_key_hash VARCHAR(255) NOT NULL COMMENT 'Hash c·ªßa API Key (SHA-256)',
     api_key_prefix VARCHAR(8) NOT NULL COMMENT '8 k√Ω t·ª± ƒë·∫ßu c·ªßa API Key (hi·ªÉn th·ªã)',
     scopes TEXT NOT NULL COMMENT 'Quy·ªÅn h·∫°n - JSON array: [invoice.create, invoice.view]',
     ip_whitelist TEXT NULL COMMENT 'Danh s√°ch IP ƒë∆∞·ª£c ph√©p - JSON array ho·∫∑c NULL',
     rate_limit_per_hour INT NOT NULL DEFAULT 1000 COMMENT 'Gi·ªõi h·∫°n request/gi·ªù',
     rate_limit_per_day INT NOT NULL DEFAULT 10000 COMMENT 'Gi·ªõi h·∫°n request/ng√†y',
     request_count_hour INT NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong gi·ªù',
     request_count_day INT NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong ng√†y',
     request_count_resetted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm reset counter',
     expired_at TIMESTAMP NULL COMMENT 'Ng√†y h·∫øt h·∫°n - NULL l√† kh√¥ng gi·ªõi h·∫°n',
     last_used_at TIMESTAMP NULL COMMENT 'L·∫ßn s·ª≠ d·ª•ng cu·ªëi',
     is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
     created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
     updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

     CONSTRAINT fk_api_credentials_merchant FOREIGN KEY (merchant_id)
         REFERENCES merchants(id) ON DELETE CASCADE,

     INDEX idx_merchant_id (merchant_id),
     INDEX idx_client_id (client_id),
     INDEX idx_api_key_hash (api_key_hash),
     INDEX idx_expired_at (expired_at),
     INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Credentials cho API access';


-- 7. Service Providers - Nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠
CREATE TABLE service_providers (
       id BIGINT AUTO_INCREMENT PRIMARY KEY,
       provider_code VARCHAR(20) NOT NULL UNIQUE COMMENT 'M√£ provider: VNPT, VIETTEL, MISA, BKAV',
       provider_name VARCHAR(100) NOT NULL COMMENT 'T√™n ƒë·∫ßy ƒë·ªß nh√† cung c·∫•p',
       official_api_url VARCHAR(500) NOT NULL COMMENT 'URL API ch√≠nh th·ª©c',
       documentation_url VARCHAR(500) NULL COMMENT 'Link t√†i li·ªáu API',
       support_email VARCHAR(255) NULL COMMENT 'Email h·ªó tr·ª£',
       support_phone VARCHAR(20) NULL COMMENT 'Hotline h·ªó tr·ª£',
       is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'Provider c√≤n ho·∫°t ƒë·ªông',
       is_default BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh c·ªßa h·ªá th·ªëng',
       display_order INT NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
       extra_config_schema JSON NULL COMMENT 'Schema c·∫•u h√¨nh b·ªï sung cho provider',
       created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
       updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

       INDEX idx_provider_code (provider_code),
       INDEX idx_is_active (is_active),
       INDEX idx_is_default (is_default),
       INDEX idx_display_order (display_order)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠';

-- Insert default providers
INSERT INTO service_providers (provider_code, provider_name, official_api_url, is_active, is_default, display_order) VALUES
                                                                                                               ('BKAV', 'BKAV eInvoice', 'https://einvoice.bkav.com/api/v1', FALSE, FALSE, 4);
-- 8. Merchant Provider Configs - C·∫•u h√¨nh ri√™ng c·ªßa Merchant
CREATE TABLE merchant_provider_configs (
       id BIGINT AUTO_INCREMENT PRIMARY KEY,
       merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu',
       provider_id BIGINT NOT NULL COMMENT 'Nh√† cung c·∫•p ƒë∆∞·ª£c ch·ªçn',
       username_service VARCHAR(100) NOT NULL COMMENT 'T√†i kho·∫£n API do Provider c·∫•p',
       password_service_encrypted VARCHAR(500) NOT NULL COMMENT 'M·∫≠t kh·∫©u API - ƒë√£ m√£ h√≥a AES-256',
       certificate_serial VARCHAR(100) NULL COMMENT 'Serial number c·ªßa ch·ª©ng th∆∞ s·ªë',
       certificate_data TEXT NULL COMMENT 'Ch·ª©ng th∆∞ s·ªë - ƒë√£ m√£ h√≥a',
       certificate_chain LONGTEXT NULL COMMENT 'Chu·ªói ch·ª©ng th∆∞ s·ªë ƒë·∫ßy ƒë·ªß (Certificate Chain)',
       certificate_expired_at TIMESTAMP NULL COMMENT 'H·∫°n ch·ª©ng th∆∞ s·ªë',
       extra_config JSON NULL COMMENT 'C·∫•u h√¨nh b·ªï sung: pattern, serial, template',
       is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C·∫•u h√¨nh c√≤n hi·ªáu l·ª±c',
       is_default BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh c·ªßa Merchant',
       last_sync_at TIMESTAMP NULL COMMENT 'L·∫ßn ƒë·ªìng b·ªô cu·ªëi v·ªõi Provider',
       created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
       updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

       CONSTRAINT fk_mpc_merchant FOREIGN KEY (merchant_id)
           REFERENCES merchants(id) ON DELETE CASCADE,
       CONSTRAINT fk_mpc_provider FOREIGN KEY (provider_id)
           REFERENCES service_providers(id) ON DELETE RESTRICT,
       CONSTRAINT uq_merchant_provider UNIQUE (merchant_id, provider_id),

       INDEX idx_merchant_id (merchant_id),
       INDEX idx_provider_id (provider_id),
       INDEX idx_is_active (is_active),
       INDEX idx_is_default (is_default)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='C·∫•u h√¨nh k·∫øt n·ªëi Provider cho t·ª´ng Merchant';


-- 9. Invoice Registrations - Qu·∫£n l√Ω ƒëƒÉng k√Ω d·∫£i s·ªë h√≥a ƒë∆°n v·ªõi CQT
CREATE TABLE invoice_registrations (
   id BIGINT AUTO_INCREMENT PRIMARY KEY,
   registration_number VARCHAR(50) NULL COMMENT 'S·ªë quy·∫øt ƒë·ªãnh/ph√™ duy·ªát c·ªßa CQT',
   from_number BIGINT NOT NULL COMMENT 'S·ªë b·∫Øt ƒë·∫ßu c·ªßa d·∫£i (VD: 0000001)',
   to_number BIGINT NOT NULL COMMENT 'S·ªë k·∫øt th√∫c c·ªßa d·∫£i (VD: 0001000)',
   quantity BIGINT NOT NULL COMMENT 'S·ªë l∆∞·ª£ng h√≥a ƒë∆°n trong d·∫£i',
   current_number BIGINT NOT NULL DEFAULT 0 COMMENT 'S·ªë hi·ªán t·∫°i ƒë√£ s·ª≠ d·ª•ng',

   effective_date DATE NOT NULL COMMENT 'Ng√†y c√≥ hi·ªáu l·ª±c',
   expiration_date DATE NULL COMMENT 'Ng√†y h·∫øt h·∫°n (n·∫øu c√≥)',

   status ENUM('ACTIVE', 'EXHAUSTED', 'EXPIRED', 'CANCELLED') NOT NULL DEFAULT 'ACTIVE' COMMENT 'Tr·∫°ng th√°i ƒëƒÉng k√Ω',
   issued_by VARCHAR(255) NULL COMMENT 'Ng∆∞·ªùi ph√™ duy·ªát/CQT',
   note TEXT NULL COMMENT 'Ghi ch√∫ b·ªï sung',

   created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
   updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

   CONSTRAINT chk_registration_range CHECK (from_number <= to_number),
   CONSTRAINT chk_registration_quantity CHECK (quantity = (to_number - from_number + 1)),

   INDEX idx_registration_merchant (merchant_id),
   INDEX idx_registration_status (status),
   INDEX idx_registration_effective (effective_date),
   INDEX idx_registration_expiration (expiration_date),
   INDEX idx_registration_number (registration_number)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω l·ªãch s·ª≠ ƒëƒÉng k√Ω d·∫£i s·ªë h√≥a ƒë∆°n v·ªõi C∆° quan Thu·∫ø';


-- 10. Invoice Templates - Qu·∫£n l√Ω M·∫´u s·ªë & K√Ω hi·ªáu h√≥a ƒë∆°n
CREATE TABLE invoice_templates (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu m·∫´u',
    invoice_type_id BIGINT NULL COMMENT 'Lo·∫°i h√≥a ƒë∆°n (li√™n k·∫øt b·∫£ng invoice_types)',
    invoice_registration_id BIGINT NULL COMMENT 'ƒêƒÉng k√Ω d·∫£i s·ªë li√™n k·∫øt',

    template_code VARCHAR(20) NOT NULL COMMENT 'M·∫´u h√≥a ƒë∆°n: 01GTKT0/001, 02GTTT0/001...',
    symbol_code VARCHAR(10) NOT NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n: AA/22E, AB/23T...',
    current_number INT NOT NULL DEFAULT 0 COMMENT 'S·ªë hi·ªán h√≥a ƒë∆°n hi·ªán t·∫°i',
    prefix VARCHAR(20) NULL COMMENT 'Ti·ªÅn t·ªë s·ªë h√≥a ƒë∆°n',
    suffix VARCHAR(20) NULL COMMENT 'H·∫≠u t·ªë s·ªë h√≥a ƒë∆°n',
    min_number INT NOT NULL DEFAULT 1 COMMENT 'S·ªë b·∫Øt ƒë·∫ßu',
    max_number INT NOT NULL DEFAULT 99999 COMMENT 'S·ªë k·∫øt th√∫c',

    CONSTRAINT chk_symbol_code_format CHECK (symbol_code REGEXP '^[A-Z0-9]{2,7}/[0-9]{2,4}[A-Z0-9]*$'),

    is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'M·∫´u c√≤n hi·ªáu l·ª±c',
    is_sequential BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'S·ª≠ d·ª•ng s·ªë th·ª© t·ª± li√™n t·ª•c',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT fk_invoice_template_merchant FOREIGN KEY (merchant_id)
        REFERENCES merchants(id) ON DELETE CASCADE,
    CONSTRAINT fk_invoice_template_type FOREIGN KEY (invoice_type_id)
        REFERENCES invoice_types(id) ON DELETE SET NULL,
    CONSTRAINT fk_invoice_template_registration FOREIGN KEY (invoice_registration_id)
        REFERENCES invoice_registrations(id) ON DELETE SET NULL,
    CONSTRAINT uq_merchant_template_symbol UNIQUE (merchant_id, template_code, symbol_code),

    INDEX idx_template_merchant (merchant_id),
    INDEX idx_template_code (template_code),
    INDEX idx_symbol_code (symbol_code),
    INDEX idx_invoice_type (invoice_type_id),
    INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Qu·∫£n l√Ω m·∫´u s·ªë v√† k√Ω hi·ªáu h√≥a ƒë∆°n theo quy ƒë·ªãnh';


-- 11. Customers - Danh m·ª•c kh√°ch h√†ng c·ªßa Merchant
CREATE TABLE customers (
   id BIGINT AUTO_INCREMENT PRIMARY KEY,
   merchant_id BIGINT NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu kh√°ch h√†ng',
   customer_code VARCHAR(50) NULL COMMENT 'M√£ kh√°ch h√†ng n·ªôi b·ªô',
   tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø kh√°ch h√†ng',
   name VARCHAR(255) NOT NULL COMMENT 'T√™n kh√°ch h√†ng/ƒë∆°n v·ªã',
   address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ',
   email VARCHAR(255) NULL COMMENT 'Email nh·∫≠n h√≥a ƒë∆°n',
   phone VARCHAR(20) NULL COMMENT 'ƒêi·ªán tho·∫°i',
   contact_person VARCHAR(100) NULL COMMENT 'Ng∆∞·ªùi li√™n h·ªá',
   bank_account VARCHAR(50) NULL COMMENT 'T√†i kho·∫£n ng√¢n h√†ng',
   bank_name VARCHAR(100) NULL COMMENT 'T√™n ng√¢n h√†ng',
   note TEXT NULL COMMENT 'Ghi ch√∫',
   is_active BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≤n ho·∫°t ƒë·ªông',
   created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
   updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

   CONSTRAINT fk_customer_merchant FOREIGN KEY (merchant_id)
       REFERENCES merchants(id) ON DELETE CASCADE,

   INDEX idx_customer_merchant (merchant_id),
   INDEX idx_customer_code (customer_code),
   INDEX idx_tax_code (tax_code),
   INDEX idx_name (name),
   INDEX idx_email (email),
   INDEX idx_is_active (is_active)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Danh m·ª•c kh√°ch h√†ng th∆∞·ªùng xuy√™n c·ªßa Merchant';


-- 12. Invoices Metadata - Th√¥ng tin t√≥m t·∫Øt h√≥a ƒë∆°n
CREATE TABLE invoices_metadata (
   id BIGINT AUTO_INCREMENT PRIMARY KEY,
   provider_config_id BIGINT NULL COMMENT 'C·∫•u h√¨nh Provider ƒë∆∞·ª£c s·ª≠ d·ª•ng',
   invoice_template_id BIGINT NULL COMMENT 'M·∫´u h√≥a ƒë∆°n ƒë∆∞·ª£c s·ª≠ d·ª•ng',
   client_request_id VARCHAR(100) NULL COMMENT 'ID request t·ª´ Merchant',

   invoice_number VARCHAR(20) NULL COMMENT 'S·ªë h√≥a ƒë∆°n t·ª´ Provider tr·∫£ v·ªÅ',
   symbol_code VARCHAR(10) NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n (VD: 1C23TML)',
   template_code VARCHAR(20) NULL COMMENT 'M·∫´u h√≥a ƒë∆°n: 01GTKT0/001, 02GTTT0/001...',
   is_summary_invoice BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'H√≥a ƒë∆°n t·ªïng h·ª£p hay h√≥a ƒë∆°n chi ti·∫øt',

   cqt_code VARCHAR(50) NULL COMMENT 'M√£ C∆° quan Thu·∫ø qu·∫£n l√Ω',

   payment_method VARCHAR(10) NULL COMMENT 'M√£ ph∆∞∆°ng th·ª©c thanh to√°n (li√™n k·∫øt b·∫£ng payment_methods)',
   lookup_code VARCHAR(50) NULL COMMENT 'M√£ tra c·ª©u h√≥a ƒë∆°n cho kh√°ch l·∫ª (pattern: S·ªë h√≥a ƒë∆°n + M√£ tra c·ª©u)',
   issuance_method ENUM('STANDARD', 'POS') NOT NULL DEFAULT 'STANDARD' COMMENT 'Ph∆∞∆°ng th·ª©c ph√°t h√†nh: STANDARD (th√¥ng th∆∞·ªùng), POS (m√°y t√≠nh ti·ªÅn)',

   seller_name VARCHAR(255) NULL COMMENT 'T√™n ng∆∞·ªùi b√°n',
   seller_tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi b√°n',
   seller_address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi b√°n',

   buyer_name VARCHAR(255) NULL COMMENT 'T√™n ng∆∞·ªùi mua',
   buyer_tax_code VARCHAR(20) NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi mua',
   buyer_email VARCHAR(255) NULL COMMENT 'Email ng∆∞·ªùi mua (nh·∫≠n h√≥a ƒë∆°n)',
   buyer_phone VARCHAR(20) NULL COMMENT 'ƒêi·ªán tho·∫°i ng∆∞·ªùi mua',
   buyer_address TEXT NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi mua',
   customer_id BIGINT NULL COMMENT 'Li√™n k·∫øt v·ªõi b·∫£ng customers',

   subtotal_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø',
   tax_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ø',
   discount_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng chi·∫øt kh·∫•u',
   total_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thanh to√°n',
   currency_code VARCHAR(3) NOT NULL DEFAULT 'VND' COMMENT 'ƒê∆°n v·ªã ti·ªÅn t·ªá',
   exchange_rate DECIMAL(10,4) NOT NULL DEFAULT 1.0000 COMMENT 'T·ª∑ gi√° v·ªõi VND',

   issue_date DATE NULL COMMENT 'Ng√†y l·∫≠p h√≥a ƒë∆°n',
   accounting_date DATE NULL COMMENT 'Ng√†y h·∫°ch to√°n',
   due_date DATE NULL COMMENT 'Ng√†y thanh to√°n ƒë·∫øn h·∫°n',

   status ENUM('DRAFT', 'PENDING', 'SIGNING', 'SENT_TO_PROVIDER', 'SUCCESS', 'FAILED', 'CANCELLED', 'REPLACED') NOT NULL DEFAULT 'DRAFT' COMMENT 'Tr·∫°ng th√°i x·ª≠ l√Ω h√≥a ƒë∆°n',
   status_message TEXT NULL COMMENT 'Th√¥ng b√°o tr·∫°ng th√°i chi ti·∫øt',
   cancellation_reason VARCHAR(500) NULL COMMENT 'L√Ω do h·ªßy/thay th·∫ø',
   replaced_by_invoice_id BIGINT NULL COMMENT 'ID h√≥a ƒë∆°n thay th·∫ø',
   adjustment_type ENUM('ADJUSTMENT', 'REPLACEMENT', 'CANCELLATION') NULL COMMENT 'Lo·∫°i ƒëi·ªÅu ch·ªânh/thay th·∫ø/h·ªßy',

   signed_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm k√Ω ƒëi·ªán t·ª≠',
   sent_to_provider_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i sang Provider',
   received_from_provider_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
   delivered_to_buyer_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i h√≥a ƒë∆°n cho ng∆∞·ªùi mua',

   provider_transaction_code VARCHAR(100) NULL COMMENT 'M√£ giao d·ªãch t·ª´ Provider',
   provider_error_code VARCHAR(50) NULL COMMENT 'M√£ l·ªói t·ª´ Provider',
   provider_error_message TEXT NULL COMMENT 'Chi ti·∫øt l·ªói t·ª´ Provider',

   is_deleted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'H√≥a ƒë∆°n ƒë√£ b·ªã x√≥a',
   deleted_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
   deleted_by BIGINT NULL COMMENT 'Ng∆∞·ªùi x√≥a - merchant_users.id',

   created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
   updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

   CONSTRAINT fk_invoice_template FOREIGN KEY (invoice_template_id)
       REFERENCES invoice_templates(id) ON DELETE SET NULL,
   CONSTRAINT fk_invoice_config FOREIGN KEY (provider_config_id)
       REFERENCES merchant_provider_configs(id) ON DELETE SET NULL,
   CONSTRAINT fk_invoice_customer FOREIGN KEY (customer_id)
       REFERENCES customers(id) ON DELETE SET NULL,
   CONSTRAINT fk_invoice_payment_method FOREIGN KEY (payment_method)
       REFERENCES payment_methods(method_code) ON DELETE SET NULL,
   CONSTRAINT fk_invoice_replaced_by FOREIGN KEY (replaced_by_invoice_id)
       REFERENCES invoices_metadata(id) ON DELETE SET NULL,
   CONSTRAINT fk_invoice_deleted_by FOREIGN KEY (deleted_by)
       REFERENCES merchant_users(id) ON DELETE SET NULL,
   CONSTRAINT uq_invoice_lookup_code UNIQUE (lookup_code) COMMENT 'M√£ tra c·ª©u ph·∫£i duy nh·∫•t',

   INDEX idx_merchant_id (merchant_id),
   INDEX idx_provider_id (provider_id),
   INDEX idx_invoice_number (invoice_number),
   INDEX idx_symbol_code (symbol_code),
   INDEX idx_buyer_tax_code (buyer_tax_code),
   INDEX idx_status (status),
   INDEX idx_issue_date (issue_date),
   INDEX idx_created_at (created_at),
   INDEX idx_client_request_id (client_request_id),
   INDEX idx_merchant_status (merchant_id, status),
   INDEX idx_merchant_created (merchant_id, created_at),
   INDEX idx_cqt_code (cqt_code),
   INDEX idx_invoice_template (invoice_template_id),
   INDEX idx_lookup_code (lookup_code),
   INDEX idx_payment_method (payment_method)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Metadata h√≥a ƒë∆°n - ph·ª•c v·ª• tra c·ª©u nhanh';


-- 13. Invoice Items - Chi ti·∫øt h√†ng h√≥a/d·ªãch v·ª• trong h√≥a ƒë∆°n (ƒê√£ c·∫≠p nh·∫≠t)
CREATE TABLE invoice_items (
   id BIGINT AUTO_INCREMENT PRIMARY KEY,
   invoice_id BIGINT NOT NULL COMMENT 'ID h√≥a ƒë∆°n cha',
   line_number INT NOT NULL DEFAULT 1 COMMENT 'S·ªë th·ª© t·ª± d√≤ng',
   product_name VARCHAR(500) NOT NULL COMMENT 'T√™n s·∫£n ph·∫©m/d·ªãch v·ª•',
   product_code VARCHAR(100) NULL COMMENT 'M√£ s·∫£n ph·∫©m theo danh m·ª•c',
   unit_name VARCHAR(50) NOT NULL COMMENT 'ƒê∆°n v·ªã t√≠nh: c√°i, kg, chi·∫øc...',
   quantity DECIMAL(18,4) NOT NULL DEFAULT 0 COMMENT 'S·ªë l∆∞·ª£ng',
   unit_price DECIMAL(18,4) NOT NULL DEFAULT 0 COMMENT 'ƒê∆°n gi√° tr∆∞·ªõc thu·∫ø',
   amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Th√†nh ti·ªÅn = quantity * unit_price',
   discount_rate DECIMAL(5,2) NOT NULL DEFAULT 0 COMMENT 'T·ª∑ l·ªá chi·∫øt kh·∫•u (%)',
   discount_amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Ti·ªÅn chi·∫øt kh·∫•u',
   tax_rate DECIMAL(5,2) NOT NULL DEFAULT 0 COMMENT 'Thu·∫ø su·∫•t GTGT (%)',
   tax_amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Ti·ªÅn thu·∫ø GTGT',
   total_amount DECIMAL(18,2) NOT NULL DEFAULT 0 COMMENT 'Th√†nh ti·ªÅn bao g·ªìm thu·∫ø',
   description TEXT NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt s·∫£n ph·∫©m',

   tax_category_code VARCHAR(20) NULL COMMENT 'M√£ nh√≥m h√†ng h√≥a theo thu·∫ø',
   vat_rate_id BIGINT NULL COMMENT 'Li√™n k·∫øt v·ªõi danh m·ª•c thu·∫ø su·∫•t (vat_rates)',
   is_promotion BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'H√†ng khuy·∫øn m√£i (TRUE) hay h√†ng th∆∞·ªùng (FALSE)',

   created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',

   CONSTRAINT fk_invoice_item_invoice FOREIGN KEY (invoice_id)
       REFERENCES invoices_metadata(id) ON DELETE CASCADE,
   CONSTRAINT fk_invoice_item_vat_rate FOREIGN KEY (vat_rate_id)
       REFERENCES vat_rates(id) ON DELETE SET NULL,

   INDEX idx_item_invoice (invoice_id),
   INDEX idx_line_number (line_number),
   INDEX idx_vat_rate (vat_rate_id),
   INDEX idx_is_promotion (is_promotion)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Chi ti·∫øt t·ª´ng d√≤ng h√†ng h√≥a/d·ªãch v·ª• trong h√≥a ƒë∆°n';


-- 14. Invoice Tax Breakdowns - Ph√¢n r√£ thu·∫ø su·∫•t tr√™n t·ª´ng h√≥a ƒë∆°n
CREATE TABLE invoice_tax_breakdowns (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    invoice_id BIGINT NOT NULL COMMENT 'ID h√≥a ƒë∆°n cha',
    vat_rate_id BIGINT NOT NULL COMMENT 'Li√™n k·∫øt v·ªõi danh m·ª•c thu·∫ø su·∫•t',
    vat_rate_code VARCHAR(10) NOT NULL COMMENT 'M√£ thu·∫ø su·∫•t (0, 5, 8, 10, KCT, KKKNT)',
    vat_rate_percent DECIMAL(5,2) NOT NULL COMMENT 'Gi√° tr·ªã ph·∫ßn trƒÉm thu·∫ø su·∫•t',

    subtotal_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø v·ªõi thu·∫ø su·∫•t n√†y',
    discount_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn chi·∫øt kh·∫•u',
    taxable_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn ch·ªãu thu·∫ø (sau chi·∫øt kh·∫•u)',
    tax_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ø GTGT',
    total_amount DECIMAL(18,2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn bao g·ªìm thu·∫ø',

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',

    CONSTRAINT fk_tax_breakdown_invoice FOREIGN KEY (invoice_id)
        REFERENCES invoices_metadata(id) ON DELETE CASCADE,
    CONSTRAINT fk_tax_breakdown_vat_rate FOREIGN KEY (vat_rate_id)
        REFERENCES vat_rates(id) ON DELETE RESTRICT,
    CONSTRAINT uq_invoice_vat_rate UNIQUE (invoice_id, vat_rate_id),

    INDEX idx_breakdown_invoice (invoice_id),
    INDEX idx_breakdown_vat_rate (vat_rate_id),
    INDEX idx_vat_rate_code (vat_rate_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u t·ªïng ti·ªÅn t√≥m t·∫Øt theo t·ª´ng lo·∫°i thu·∫ø su·∫•t ph·ª•c v·ª• in ·∫•n h√≥a ƒë∆°n';


CREATE TABLE invoice_adjustments (
     id BIGINT AUTO_INCREMENT PRIMARY KEY,
     original_invoice_id BIGINT NOT NULL COMMENT 'H√≥a ƒë∆°n g·ªëc b·ªã ƒëi·ªÅu ch·ªânh/thay th·∫ø/h·ªßy',
     adjustment_type ENUM('ADJUSTMENT', 'REPLACEMENT', 'CANCELLATION') NOT NULL COMMENT 'Lo·∫°i ƒëi·ªÅu ch·ªânh',

     agreement_number VARCHAR(50) NULL COMMENT 'S·ªë bi√™n b·∫£n th·ªèa thu·∫≠n',
     agreement_date DATE NULL COMMENT 'Ng√†y l·∫≠p bi√™n b·∫£n',
     agreement_content TEXT NULL COMMENT 'N·ªôi dung bi√™n b·∫£n th·ªèa thu·∫≠n',
     signers TEXT NULL COMMENT 'Ng∆∞·ªùi k√Ω bi√™n b·∫£n (JSON array)',

     reason_code VARCHAR(50) NULL COMMENT 'M√£ l√Ω do (theo quy ƒë·ªãnh)',
     reason_description VARCHAR(500) NULL COMMENT 'M√¥ t·∫£ l√Ω do chi ti·∫øt',

     old_subtotal_amount DECIMAL(18,2) NULL COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø c≈©',
     old_tax_amount DECIMAL(18,2) NULL COMMENT 'Ti·ªÅn thu·∫ø c≈©',
     old_total_amount DECIMAL(18,2) NULL COMMENT 'T·ªïng ti·ªÅn c≈©',
     new_subtotal_amount DECIMAL(18,2) NULL COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø m·ªõi',
     new_tax_amount DECIMAL(18,2) NULL COMMENT 'Ti·ªÅn thu·∫ø m·ªõi',
     new_total_amount DECIMAL(18,2) NULL COMMENT 'T·ªïng ti·ªÅn m·ªõi',
     difference_amount DECIMAL(18,2) NULL COMMENT 'Ch√™nh l·ªách ti·ªÅn',

     status ENUM('PENDING', 'APPROVED', 'REJECTED', 'CANCELLED') NOT NULL DEFAULT 'PENDING' COMMENT 'Tr·∫°ng th√°i duy·ªát',
     approved_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm duy·ªát',

    -- Th√¥ng tin g·ª≠i CQT
     submitted_to_cqt BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'ƒê√£ g·ª≠i C∆° quan Thu·∫ø',
     cqt_response_code VARCHAR(50) NULL COMMENT 'M√£ ph·∫£n h·ªìi t·ª´ CQT',
     cqt_response_message TEXT NULL COMMENT 'N·ªôi dung ph·∫£n h·ªìi t·ª´ CQT',

     created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
     updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

     CONSTRAINT fk_adjustment_original_invoice FOREIGN KEY (original_invoice_id)
         REFERENCES invoices_metadata(id) ON DELETE RESTRICT,


     INDEX idx_adjustment_original (original_invoice_id),
     INDEX idx_adjustment_type (adjustment_type),
     INDEX idx_adjustment_status (status),
     INDEX idx_agreement_date (agreement_date),
     INDEX idx_submitted_cqt (submitted_to_cqt)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u th√¥ng tin bi√™n b·∫£n th·ªèa thu·∫≠n cho h√≥a ƒë∆°n ƒëi·ªÅu ch·ªânh/thay th·∫ø/h·ªßy';


CREATE TABLE invoice_sync_queue (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    invoice_id BIGINT NOT NULL COMMENT 'ID h√≥a ƒë∆°n c·∫ßn ƒë·ªìng b·ªô',
    sync_type ENUM('SEND_TO_PROVIDER', 'SEND_TO_CQT', 'CANCEL_INVOICE', 'REPLACE_INVOICE') NOT NULL COMMENT 'Lo·∫°i thao t√°c ƒë·ªìng b·ªô',
    priority INT NOT NULL DEFAULT 5 COMMENT 'ƒê·ªô ∆∞u ti√™n (1=cao nh·∫•t, 10=th·∫•p nh·∫•t)',

    status ENUM('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED', 'RETRYING') NOT NULL DEFAULT 'PENDING' COMMENT 'Tr·∫°ng th√°i x·ª≠ l√Ω',
    attempt_count INT NOT NULL DEFAULT 0 COMMENT 'S·ªë l·∫ßn th·ª≠',
    max_attempts INT NOT NULL DEFAULT 3 COMMENT 'S·ªë l·∫ßn th·ª≠ t·ªëi ƒëa',
    last_attempt_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm th·ª≠ l·∫ßn cu·ªëi',
    next_retry_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm th·ª≠ ti·∫øp theo',

    request_data JSON NULL COMMENT 'D·ªØ li·ªáu request g·ª≠i ƒëi',
    response_data JSON NULL COMMENT 'D·ªØ li·ªáu response nh·∫≠n v·ªÅ',
    error_code VARCHAR(50) NULL COMMENT 'M√£ l·ªói',
    error_message TEXT NULL COMMENT 'Chi ti·∫øt l·ªói',

    processed_by VARCHAR(100) NULL COMMENT 'Worker x·ª≠ l√Ω',
    processing_started_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu x·ª≠ l√Ω',
    processing_completed_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm ho√†n th√†nh',

    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT fk_sync_queue_invoice FOREIGN KEY (invoice_id)
        REFERENCES invoices_metadata(id) ON DELETE CASCADE,

    CONSTRAINT chk_sync_attempt_count CHECK (attempt_count <= max_attempts),

    INDEX idx_sync_queue_status (status),
    INDEX idx_sync_queue_invoice (invoice_id),
    INDEX idx_sync_queue_merchant (merchant_id),
    INDEX idx_sync_queue_priority (priority),
    INDEX idx_sync_queue_next_retry (next_retry_at),
    INDEX idx_sync_queue_created (created_at),
    INDEX idx_sync_queue_status_priority (status, priority, next_retry_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='H√†ng ƒë·ª£i g·ª≠i h√≥a ƒë∆°n sang Provider/CQT v·ªõi c∆° ch·∫ø Retry';


-- 17. Invoice Payloads - L∆∞u tr·ªØ n·ªôi dung XML/JSON g·ªëc
CREATE TABLE invoice_payloads (
      invoice_id BIGINT NOT NULL PRIMARY KEY COMMENT 'ID h√≥a ƒë∆°n - kh√≥a ch√≠nh v√† kh√≥a ngo·∫°i',
      raw_data JSON NULL COMMENT 'D·ªØ li·ªáu th√¥ request/response d·∫°ng JSON',
      xml_content LONGTEXT NULL COMMENT 'N·ªôi dung XML g·ªëc c·ªßa h√≥a ƒë∆°n (ph·ª•c v·ª• in ·∫•n)',
      json_content LONGTEXT NULL COMMENT 'N·ªôi dung JSON ƒë·∫ßy ƒë·ªß c·ªßa h√≥a ƒë∆°n',
      signed_xml LONGTEXT NULL COMMENT 'XML ƒë√£ k√Ω ƒëi·ªán t·ª≠ (ch·ªØ k√Ω s·ªë)',
      pdf_data LONGTEXT NULL COMMENT 'D·ªØ li·ªáu PDF ƒë√£ t·∫°o (base64)',
      extra_data JSON NULL COMMENT 'D·ªØ li·ªáu b·ªï sung kh√°c',
      created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm l∆∞u',
      updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

      CONSTRAINT fk_invoice_payload_invoice FOREIGN KEY (invoice_id)
          REFERENCES invoices_metadata(id) ON DELETE CASCADE,

      INDEX idx_payload_created (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u tr·ªØ n·ªôi dung XML/JSON g·ªëc h√≥a ƒë∆°n';


-- 18. Tax Authority Responses - Ph·∫£n h·ªìi t·ª´ C∆° quan Thu·∫ø
CREATE TABLE tax_authority_responses (
     id BIGINT AUTO_INCREMENT PRIMARY KEY,
     invoice_id BIGINT NOT NULL COMMENT 'H√≥a ƒë∆°n li√™n quan',
     cqt_code VARCHAR(50) NOT NULL COMMENT 'M√£ C∆° quan Thu·∫ø',
     status_from_cqt VARCHAR(50) NOT NULL COMMENT 'Tr·∫°ng th√°i t·ª´ C∆° quan Thu·∫ø: APPROVED, REJECTED, PENDING',
     processing_code VARCHAR(100) NULL COMMENT 'M√£ x·ª≠ l√Ω t·ª´ C∆° quan Thu·∫ø',
     signature_data TEXT NULL COMMENT 'D·ªØ li·ªáu ch·ªØ k√Ω t·ª´ C∆° quan Thu·∫ø',
     raw_response JSON NULL COMMENT 'Response th√¥ t·ª´ C∆° quan Thu·∫ø',
     error_code VARCHAR(50) NULL COMMENT 'M√£ l·ªói t·ª´ C∆° quan Thu·∫ø',
     error_message TEXT NULL COMMENT 'Th√¥ng b√°o l·ªói t·ª´ C∆° quan Thu·∫ø',
     received_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
     processed_at TIMESTAMP NULL COMMENT 'Th·ªùi ƒëi·ªÉm x·ª≠ l√Ω ho√†n t·∫•t',
     created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o b·∫£n ghi',

     CONSTRAINT fk_tax_response_invoice FOREIGN KEY (invoice_id)
         REFERENCES invoices_metadata(id) ON DELETE CASCADE,

     INDEX idx_tax_response_invoice (invoice_id),
     INDEX idx_cqt_code (cqt_code),
     INDEX idx_status_cqt (status_from_cqt),
     INDEX idx_received_at (received_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='L∆∞u v·∫øt t∆∞∆°ng t√°c v·ªõi C∆° quan Thu·∫ø';


-- 19. Audit Log - Nh·∫≠t k√Ω thao t√°c
CREATE TABLE audit_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    merchantuser_id BIGINT NULL COMMENT 'Doanh nghi·ªáp li√™n quan',
    user_id BIGINT NULL COMMENT 'Ng∆∞·ªùi th·ª±c hi·ªán',
    entity_type VARCHAR(50) NOT NULL COMMENT 'Lo·∫°i entity: Invoice, Merchant, Config...',
    entity_id BIGINT NOT NULL COMMENT 'ID c·ªßa entity',
    action VARCHAR(50) NOT NULL COMMENT 'H√†nh ƒë·ªông: CREATE, UPDATE, DELETE, STATUS_CHANGE',
    old_value JSON NULL COMMENT 'Gi√° tr·ªã c≈©',
    new_value JSON NULL COMMENT 'Gi√° tr·ªã m·ªõi',
    ip_address VARCHAR(45) NULL COMMENT 'IP th·ª±c hi·ªán',
    user_agent VARCHAR(500) NULL COMMENT 'User Agent c·ªßa browser/client',
    request_id VARCHAR(100) NULL COMMENT 'ID request t·ª´ frontend',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm x·∫£y ra',

    CONSTRAINT fk_merchant_user FOREIGN KEY (merchantuser_id)
        REFERENCES merchant_users(id) ON DELETE CASCADE,

    INDEX idx_merchant_id (merchant_id),
    INDEX idx_user_id (user_id),
    INDEX idx_entity (entity_type, entity_id),
    INDEX idx_action (action),
    INDEX idx_created_at (created_at),
    INDEX idx_merchant_entity (merchant_id, entity_type, entity_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Nh·∫≠t k√Ω thay ƒë·ªïi h·ªá th·ªëng';


-- 20. System Configuration - C·∫•u h√¨nh h·ªá th·ªëng
CREATE TABLE system_config (
   id BIGINT AUTO_INCREMENT PRIMARY KEY,
   config_key VARCHAR(100) NOT NULL UNIQUE COMMENT 'Kh√≥a c·∫•u h√¨nh',
   config_value TEXT NOT NULL COMMENT 'Gi√° tr·ªã c·∫•u h√¨nh',
   config_type VARCHAR(20) NOT NULL DEFAULT 'STRING' COMMENT 'Lo·∫°i: STRING, NUMBER, BOOLEAN, JSON',
   description VARCHAR(500) NULL COMMENT 'M√¥ t·∫£ c·∫•u h√¨nh',
   is_encrypted BOOLEAN NOT NULL DEFAULT FALSE COMMENT 'C√≥ c·∫ßn m√£ h√≥a kh√¥ng',
   is_editable BOOLEAN NOT NULL DEFAULT TRUE COMMENT 'C√≥ th·ªÉ ch·ªânh s·ª≠a kh√¥ng',
   updated_by BIGINT NULL COMMENT 'Ng∆∞·ªùi c·∫≠p nh·∫≠t cu·ªëi',
   updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

   CONSTRAINT fk_config_updated_by FOREIGN KEY (updated_by)
       REFERENCES merchant_users(id) ON DELETE SET NULL,

   INDEX idx_config_key (config_key)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='C·∫•u h√¨nh h·ªá th·ªëng';

-- Insert default configurations
INSERT INTO system_config (config_key, config_value, config_type, description) VALUES
('SYSTEM_NAME', 'EInvoiceHub', 'STRING', 'T√™n hi·ªÉn th·ªã c·ªßa h·ªá th·ªëng'),
('INVOICE_EXPIRY_DAYS', '30', 'NUMBER', 'S·ªë ng√†y h√≥a ƒë∆°n c√≥ hi·ªáu l·ª±c sau khi ph√°t h√†nh'),
('MAX_RETRY_ATTEMPTS', '3', 'NUMBER', 'S·ªë l·∫ßn th·ª≠ l·∫°i khi g·ªçi Provider th·∫•t b·∫°i'),
('RETRY_DELAY_MS', '1000', 'NUMBER', 'Th·ªùi gian ch·ªù gi·ªØa c√°c l·∫ßn th·ª≠ l·∫°i (milliseconds)'),
('SESSION_TIMEOUT_MINUTES', '60', 'NUMBER', 'Th·ªùi gian timeout c·ªßa session'),
('PASSWORD_MIN_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i t·ªëi thi·ªÉu c·ªßa m·∫≠t kh·∫©u'),
('API_KEY_PREFIX_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i prefix hi·ªÉn th·ªã c·ªßa API Key'),
('DEFAULT_CURRENCY', 'VND', 'STRING', 'ƒê∆°n v·ªã ti·ªÅn t·ªá m·∫∑c ƒë·ªãnh'),
('TAX_DEFAULT_RATE', '10.00', 'NUMBER', 'Thu·∫ø su·∫•t m·∫∑c ƒë·ªãnh (%)'),
('INVOICE_NUMBER_FORMAT', 'PREFIX + NUMBER + SUFFIX', 'STRING', 'C·∫•u tr√∫c s·ªë h√≥a ƒë∆°n m·∫∑c ƒë·ªãnh'),
('BACKGROUND_JOB_ENABLED', 'true', 'BOOLEAN', 'K√≠ch ho·∫°t x·ª≠ l√Ω background jobs'),
('INVOICE_LOOKUP_CODE_LENGTH', '6', 'NUMBER', 'ƒê·ªô d√†i m√£ tra c·ª©u h√≥a ƒë∆°n ng·∫´u nhi√™n');
</file>

<file path="src/main/resources/db/migration/V1__Initial_Schema.sql">
-- =============================================================================
-- EInvoiceHub Database Schema - Core + Shell Strategy
-- Database: MariaDB | Character Set: utf8mb4_unicode_ci
-- =============================================================================

SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- SECTION 1: CATALOG TABLES (Reference Data)
-- 1. Invoice Types - Danh m·ª•c lo·∫°i h√≥a ƒë∆°n
CREATE TABLE `invoice_types`
(
    `id`            BIGINT AUTO_INCREMENT PRIMARY KEY,
    `type_code`     VARCHAR(10)  NOT NULL UNIQUE COMMENT 'M√£ lo·∫°i h√≥a ƒë∆°n (VD: 01GTKT)',
    `type_name`     VARCHAR(100) NOT NULL COMMENT 'T√™n lo·∫°i h√≥a ƒë∆°n',
    `description`   TEXT         NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
    `is_active`     BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    `display_order` INT          NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
    `created_at`    TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`    TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX `idx_type_code` (`type_code`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Danh m·ª•c lo·∫°i h√≥a ƒë∆°n';
INSERT INTO invoice_types (type_code, type_name, description, display_order)
VALUES ('01GTKT', 'H√≥a ƒë∆°n gi√° tr·ªã gia tƒÉng', 'H√≥a ƒë∆°n GTGT m·∫´u 01GTKT theo Th√¥ng t∆∞ 78/2021/TT-BTC', 1),
       ('02GTTT', 'H√≥a ƒë∆°n b√°n h√†ng', 'H√≥a ƒë∆°n b√°n h√†ng m·∫´u 02GTTT theo Th√¥ng t∆∞ 78/2021/TT-BTC', 2),
       ('07KPTQ', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ ki·ªÉm so√°t', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ ki·ªÉm so√°t theo Ngh·ªã ƒë·ªãnh 123/2020/Nƒê-CP', 3),
       ('03KPTQ', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ kh√¥ng ki·ªÉm so√°t', 'H√≥a ƒë∆°n ƒëi·ªán t·ª≠ kh√¥ng ki·ªÉm so√°t theo Ngh·ªã ƒë·ªãnh 123/2020/Nƒê-CP',
        4);

-- 2. Invoice Statuses - Danh m·ª•c tr·∫°ng th√°i h√≥a ƒë∆°n
CREATE TABLE `invoice_statuses`
(
    `id`          INT PRIMARY KEY COMMENT 'ID tr·∫°ng th√°i',
    `name`        VARCHAR(100) NOT NULL UNIQUE COMMENT 'T√™n tr·∫°ng th√°i',
    `description` VARCHAR(255) NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt tr·∫°ng th√°i',
    `note`        VARCHAR(500) NULL COMMENT 'Ghi ch√∫ nghi·ªáp v·ª•',
    `created_at`  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    `updated_at`  TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='B·∫£ng danh m·ª•c tr·∫°ng th√°i h√≥a ƒë∆°n';
INSERT INTO invoice_statuses (id, name, description, note)
VALUES (1, 'DRAFT', 'H√≥a ƒë∆°n nh√°p', 'M·ªõi t·∫°o, ch∆∞a k√Ω'),
       (2, 'PENDING', 'ƒêang x·ª≠ l√Ω', 'ƒêang ch·ªù g·ª≠i sang Provider'),
       (3, 'SIGNING', 'ƒêang k√Ω s·ªë', 'ƒêang th·ª±c hi·ªán k√Ω ƒëi·ªán t·ª≠'),
       (4, 'SENT_TO_PROVIDER', 'ƒê√£ g·ª≠i Provider', 'ƒê√£ g·ª≠i nh∆∞ng ch∆∞a c√≥ k·∫øt qu·∫£ t·ª´ CQT'),
       (5, 'SUCCESS', 'Th√†nh c√¥ng', 'H√≥a ƒë∆°n ƒë√£ h·ª£p l·ªá v√† c√≥ m√£ CQT'),
       (6, 'FAILED', 'Th·∫•t b·∫°i', 'L·ªói t·ª´ Provider ho·∫∑c CQT'),
       (7, 'CANCELLED', 'ƒê√£ h·ªßy', 'H√≥a ƒë∆°n ƒë√£ b·ªã h·ªßy b·ªè'),
       (8, 'REPLACED', 'ƒê√£ thay th·∫ø', 'ƒê√£ c√≥ h√≥a ƒë∆°n kh√°c thay th·∫ø cho h√≥a ƒë∆°n n√†y');

-- 3. Payment Methods - Danh m·ª•c ph∆∞∆°ng th·ª©c thanh to√°n
CREATE TABLE `payment_methods`
(
    `id`            BIGINT AUTO_INCREMENT PRIMARY KEY,
    `method_code`   VARCHAR(10)  NOT NULL UNIQUE COMMENT 'M√£ ph∆∞∆°ng th·ª©c: TM, CK...',
    `method_name`   VARCHAR(100) NOT NULL COMMENT 'T√™n ph∆∞∆°ng th·ª©c',
    `description`   TEXT         NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
    `is_active`     BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    `display_order` INT          NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
    `created_at`    TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`    TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX `idx_method_code` (`method_code`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Danh m·ª•c ph∆∞∆°ng th·ª©c thanh to√°n';
INSERT INTO payment_methods (method_code, method_name, description, display_order)
VALUES ('TM', 'Ti·ªÅn m·∫∑t', 'Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t tr·ª±c ti·∫øp', 1),
       ('CK', 'Chuy·ªÉn kho·∫£n', 'Thanh to√°n qua chuy·ªÉn kho·∫£n ng√¢n h√†ng', 2),
       ('TM/CK', 'Ti·ªÅn m·∫∑t/Chuy·ªÉn kho·∫£n', 'K·∫øt h·ª£p c·∫£ hai h√¨nh th·ª©c', 3),
       ('POS', 'Th·∫ª POS', 'Thanh to√°n qua m√°y POS', 4),
       ('V√ç ƒêI·ªÜN T·ª¨', 'V√≠ ƒëi·ªán t·ª≠', 'Thanh to√°n qua v√≠ ƒëi·ªán t·ª≠', 5),
       ('TH·∫∫', 'Th·∫ª ng√¢n h√†ng', 'Thanh to√°n b·∫±ng th·∫ª t√≠n d·ª•ng/ghi n·ª£', 6);

-- 4. VAT Rates - Danh m·ª•c thu·∫ø su·∫•t GTGT
CREATE TABLE `vat_rates`
(
    `id`            BIGINT AUTO_INCREMENT PRIMARY KEY,
    `rate_code`     VARCHAR(10)   NOT NULL UNIQUE COMMENT 'M√£ thu·∫ø su·∫•t: 0, 5, 8, 10, KCT',
    `rate_percent`  DECIMAL(5, 2) NOT NULL COMMENT 'Gi√° tr·ªã ph·∫ßn trƒÉm thu·∫ø su·∫•t',
    `rate_name`     VARCHAR(100)  NOT NULL COMMENT 'T√™n thu·∫ø su·∫•t',
    `description`   TEXT          NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
    `is_active`     BOOLEAN       NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    `display_order` INT           NOT NULL DEFAULT 0 COMMENT 'Th·ª© t·ª± hi·ªÉn th·ªã',
    `created_at`    TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`    TIMESTAMP     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',
    CONSTRAINT `chk_vat_rate_percent` CHECK (rate_percent >= 0),
    INDEX `idx_rate_code` (`rate_code`),
    INDEX `idx_rate_percent` (`rate_percent`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Danh m·ª•c thu·∫ø su·∫•t GTGT';
INSERT INTO vat_rates (rate_code, rate_percent, rate_name, description, display_order)
VALUES ('0', 0.00, 'Thu·∫ø su·∫•t 0%', '√Åp d·ª•ng cho h√†ng h√≥a, d·ªãch v·ª• xu·∫•t kh·∫©u', 1),
       ('5', 5.00, 'Thu·∫ø su·∫•t 5%', '√Åp d·ª•ng cho h√†ng h√≥a, d·ªãch v·ª• thi·∫øt y·∫øu', 2),
       ('8', 8.00, 'Thu·∫ø su·∫•t 8%', 'Gi·∫£m thu·∫ø theo Ngh·ªã quy·∫øt 43/2022/QH15', 3),
       ('10', 10.00, 'Thu·∫ø su·∫•t 10%', 'Thu·∫ø su·∫•t th√¥ng th∆∞·ªùng GTGT', 4),
       ('KCT', 0.00, 'Kh√¥ng ch·ªãu thu·∫ø', 'H√†ng h√≥a, d·ªãch v·ª• kh√¥ng ch·ªãu thu·∫ø GTGT', 5);

-- 5. Service Providers - Danh m·ª•c nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠
CREATE TABLE `service_providers`
(
    `id`                  BIGINT AUTO_INCREMENT PRIMARY KEY,
    `provider_code`       VARCHAR(20)  NOT NULL UNIQUE COMMENT 'M√£ ƒë·ªãnh danh (VNPT, VIETTEL...)',
    `provider_name`       VARCHAR(100) NOT NULL COMMENT 'T√™n nh√† cung c·∫•p',
    `official_api_url`    VARCHAR(500) NOT NULL COMMENT 'URL t√≠ch h·ª£p',
    `lookup_url`          VARCHAR(500) NULL COMMENT 'URL tra c·ª©u h√≥a ƒë∆°n',
    `documentation_url`   VARCHAR(500) NULL COMMENT 'Link t√†i li·ªáu API',
    `support_email`       VARCHAR(255) NULL,
    `support_phone`       VARCHAR(20)  NULL,
    `is_active`           BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'Ki·ªÉm tra c√≤n ho·∫°t ƒë·ªông kh√¥ng',
    `is_default`          BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'Provider m·∫∑c ƒë·ªãnh h·ªá th·ªëng',
    `display_order`       INT          NOT NULL DEFAULT 0,
    `extra_config_schema` JSON         NULL COMMENT 'C·∫•u h√¨nh ƒë·∫∑c th√π c·ªßa t·ª´ng h√£ng',
    `created_at`          TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`          TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX `idx_provider_code` (`provider_code`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Danh m·ª•c nh√† cung c·∫•p h√≥a ƒë∆°n ƒëi·ªán t·ª≠';
INSERT INTO service_providers (provider_code, provider_name, official_api_url, lookup_url, is_active, display_order)
VALUES ('VNPT', 'VNPT e-Invoice', 'https://api-itg.vnpt.vn', 'https://tracuu.vnpt.vn', TRUE, 1),
       ('VIETTEL', 'SInvoice Viettel', 'https://sinvoice.viettel.vn/api', 'https://sinvoice.viettel.vn/tracuu', TRUE,
        2),
       ('BKAV', 'BKAV eInvoice', 'https://einvoice.bkav.com/api', 'https://tracuuhdon.bkav.com', TRUE, 3),
       ('MOBIFONE', 'MobiFone Invoice', 'https://thongke.mobifoneinvoice.vn/api/v1',
        'https://mobifoneinvoice.vn/tracuu', TRUE, 4);



-- SECTION 2: CORE JPA TABLES (Business Logic Foundation)
-- CORE TABLE 1: Merchants (Root Entity)
CREATE TABLE `merchants`
(
    -- Core Fields (Required for JPA compatibility)
    `id`                   BIGINT AUTO_INCREMENT PRIMARY KEY,
    `tax_code`             VARCHAR(20)                        NOT NULL UNIQUE COMMENT 'M√£ s·ªë thu·∫ø - ƒë·ªãnh danh doanh nghi·ªáp',
    `company_name`         VARCHAR(255)                       NOT NULL COMMENT 'T√™n c√¥ng ty ƒë·∫ßy ƒë·ªß',
    `short_name`           VARCHAR(100) COMMENT 'T√™n vi·∫øt t·∫Øt',
    `address`              TEXT COMMENT 'ƒê·ªãa ch·ªâ tr·ª• s·ªü ch√≠nh',
    `district`             VARCHAR(100) COMMENT 'Qu·∫≠n/Huy·ªán',
    `city`                 VARCHAR(100) COMMENT 'T·ªânh/Th√†nh ph·ªë',
    `email`                VARCHAR(255) COMMENT 'Email li√™n h·ªá',
    `phone`                VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    `representative_name`  VARCHAR(100) COMMENT 'T√™n ng∆∞·ªùi ƒë·∫°i di·ªán',
    `representative_title` VARCHAR(100) COMMENT 'Ch·ª©c danh ng∆∞·ªùi ƒë·∫°i di·ªán',
    `tax_authority_code`   VARCHAR(10)                        NULL COMMENT 'M√£ c∆° quan thu·∫ø qu·∫£n l√Ω (VD: 01GD, 02HT...)',

    -- Enterprise Shell Fields (SaaS Extensions - NULLABLE for JPA compatibility)
    `subscription_plan`    ENUM ('TRIAL', 'BASIC', 'PREMIUM') NOT NULL DEFAULT 'TRIAL' COMMENT 'G√≥i d·ªãch v·ª•: TRIAL, BASIC, PREMIUM',
    `invoice_quota`        INT                                NOT NULL DEFAULT 100 COMMENT 'H·∫°n m·ª©c h√≥a ƒë∆°n/th√°ng',
    `invoice_used`         INT                                NOT NULL DEFAULT 0 COMMENT 'H√≥a ƒë∆°n ƒë√£ s·ª≠ d·ª•ng trong th√°ng',
    `is_using_hsm`         BOOLEAN                            NOT NULL DEFAULT FALSE COMMENT 'S·ª≠ d·ª•ng HSM hay USB Token ƒë·ªÉ k√Ω ƒëi·ªán t·ª≠',
    `is_deleted`           BOOLEAN                            NOT NULL DEFAULT FALSE COMMENT 'C·ªù x√≥a m·ªÅm',
    `deleted_at`           TIMESTAMP                          NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
    `created_at`           TIMESTAMP                          NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`           TIMESTAMP                          NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    INDEX `idx_tax_code` (`tax_code`),
    INDEX `idx_subscription_plan` (`subscription_plan`),
    INDEX `idx_created_at` (`created_at`),
    INDEX `idx_tax_authority` (`tax_authority_code`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Qu·∫£n l√Ω doanh nghi·ªáp s·ª≠ d·ª•ng d·ªãch v·ª• h√≥a ƒë∆°n ƒëi·ªán t·ª≠';

-- CORE TABLE 2: Merchant User (Child of Merchant)
CREATE TABLE `merchant_user`
(
    `id`                    BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`           BIGINT                                       NOT NULL COMMENT 'Li√™n k·∫øt v·ªõi doanh nghi·ªáp',
    `username`              VARCHAR(50)                                  NOT NULL UNIQUE COMMENT 'T√™n ƒëƒÉng nh·∫≠p',
    `email`                 VARCHAR(255)                                 NOT NULL UNIQUE COMMENT 'Email ng∆∞·ªùi d√πng',
    `password_hash`         VARCHAR(255)                                 NOT NULL COMMENT 'M·∫≠t kh·∫©u ƒë√£ m√£ h√≥a BCrypt',
    `full_name`             VARCHAR(100) COMMENT 'H·ªç v√† t√™n ƒë·∫ßy ƒë·ªß',
    `phone`                 VARCHAR(20) COMMENT 'S·ªë ƒëi·ªán tho·∫°i',
    `avatar_url`            VARCHAR(500) COMMENT 'URL ·∫£nh ƒë·∫°i di·ªán',
    `role`                  ENUM ('ADMIN', 'MANAGER', 'STAFF', 'VIEWER') NOT NULL DEFAULT 'STAFF' COMMENT 'Vai tr√≤ trong h·ªá th·ªëng',
    `is_active`             BOOLEAN                                      NOT NULL DEFAULT TRUE COMMENT 'K√≠ch ho·∫°t t√†i kho·∫£n',
    `is_primary`            BOOLEAN                                      NOT NULL DEFAULT FALSE COMMENT 'T√†i kho·∫£n ch√≠nh c·ªßa doanh nghi·ªáp',
    `last_login_at`         TIMESTAMP                                    NULL COMMENT 'ƒêƒÉng nh·∫≠p l·∫ßn cu·ªëi',
    `failed_login_attempts` INT                                          NOT NULL DEFAULT 0 COMMENT 'S·ªë l·∫ßn ƒëƒÉng nh·∫≠p sai',
    `locked_until`          TIMESTAMP                                    NULL COMMENT 'Kh√≥a t√†i kho·∫£n ƒë·∫øn th·ªùi ƒëi·ªÉm',
    `created_at`            TIMESTAMP                                    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`            TIMESTAMP                                    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT `fk_merchant_user_merchant` FOREIGN KEY (`merchant_id`)
        REFERENCES `merchants` (`id`) ON DELETE CASCADE,

    INDEX `idx_merchant_id` (`merchant_id`),
    INDEX `idx_username` (`username`),
    INDEX `idx_email` (`email`),
    INDEX `idx_role` (`role`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='T√†i kho·∫£n ng∆∞·ªùi d√πng thu·ªôc Merchant';

-- CORE TABLE 3: Merchant Provider Configs (Child of Merchant)
CREATE TABLE `merchant_provider_configs`
(
    -- Core Fields
    `id`                         BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`                BIGINT       NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu',
    `provider_id`                BIGINT       NOT NULL COMMENT 'Nh√† cung c·∫•p ƒë∆∞·ª£c ch·ªçn',

    -- Connection Credentials
    `partner_id`                 VARCHAR(50)  NULL COMMENT 'ID ƒë·ªëi t√°c (partner_id)',
    `partner_token`              VARCHAR(500) NULL COMMENT 'Token truy c·∫≠p (partner_token)',
    `tax_code`                   VARCHAR(20)  NULL COMMENT 'M√£ s·ªë thu·∫ø k·∫øt n·ªëi',
    `integration_url`            VARCHAR(500) NULL COMMENT 'URL t√≠ch h·ª£p ri√™ng',
    `integrated_date`            TIMESTAMP    NULL COMMENT 'Ng√†y t√≠ch h·ª£p',

    -- Service Account
    `username_service`           VARCHAR(100) NOT NULL COMMENT 'T√†i kho·∫£n API',
    `password_service_encrypted` VARCHAR(500) NOT NULL COMMENT 'M·∫≠t kh·∫©u API (ƒë√£ m√£ h√≥a)',

    -- Digital Certificate
    `certificate_serial`         VARCHAR(100) NULL,
    `certificate_data`           TEXT         NULL,
    `certificate_chain`          LONGTEXT     NULL,
    `certificate_expired_at`     TIMESTAMP    NULL,

    -- Extra Configuration
    `extra_config`               JSON         NULL COMMENT 'C·∫•u h√¨nh b·ªï sung (pattern, serial...)',

    -- Enterprise Shell Fields (NULLABLE for JPA compatibility)
    `is_test_mode`               BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'Ch·∫ø ƒë·ªô ki·ªÉm th·ª≠ (Sandbox)',
    `encrypted_password_storage` VARCHAR(500) NULL COMMENT 'L∆∞u tr·ªØ m·∫≠t kh·∫©u ƒë√£ m√£ h√≥a (AES256)',

    -- Status & Timestamps
    `is_active`                  BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'Tr·∫°ng th√°i k√≠ch ho·∫°t',
    `is_default`                 BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'C·∫•u h√¨nh m·∫∑c ƒë·ªãnh',
    `last_sync_at`               TIMESTAMP    NULL COMMENT 'Th·ªùi ƒëi·ªÉm ƒë·ªìng b·ªô cu·ªëi',
    `created_at`                 TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`                 TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT `fk_mpc_merchant` FOREIGN KEY (`merchant_id`) REFERENCES `merchants` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_mpc_provider` FOREIGN KEY (`provider_id`) REFERENCES `service_providers` (`id`) ON DELETE RESTRICT,
    CONSTRAINT `uq_merchant_provider` UNIQUE (`merchant_id`, `provider_id`),

    INDEX `idx_merchant_provider` (`merchant_id`, `provider_id`),
    INDEX `idx_is_active` (`is_active`),
    INDEX `idx_is_test_mode` (`is_test_mode`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='B·∫£ng c·∫•u h√¨nh chi ti·∫øt NCC cho t·ª´ng Merchant';

-- CORE TABLE 4: Invoice Template (Child of Merchant)
CREATE TABLE `invoice_template`
(
    `id`                      BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`             BIGINT      NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu',
    `invoice_type_id`         BIGINT      NULL COMMENT 'Lo·∫°i h√≥a ƒë∆°n',
    `invoice_registration_id` BIGINT      NULL COMMENT 'Li√™n k·∫øt ƒëƒÉng k√Ω d·∫£i s·ªë',
    `provider_id`             VARCHAR(36) NULL COMMENT 'M√£ NCC',
    `provider_serial_id`      VARCHAR(50) NULL COMMENT 'ID d·∫£i s·ªë ph√≠a NCC',

    -- Template Configuration
    `template_code`           VARCHAR(20) NOT NULL COMMENT 'M·∫´u h√≥a ƒë∆°n: 01GTKT0/001',
    `symbol_code`             VARCHAR(10) NOT NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n: AA/22E',

    -- Serial Number Management
    `current_number`          INT         NOT NULL DEFAULT 0 COMMENT 'S·ªë hi·ªán t·∫°i',
    `min_number`              INT         NOT NULL DEFAULT 1,
    `max_number`              INT         NOT NULL DEFAULT 99999999,
    `start_date`              TIMESTAMP   NULL COMMENT 'Ng√†y b·∫Øt ƒë·∫ßu hi·ªáu l·ª±c',

    -- Status
    `status_id`               INT         NULL COMMENT 'ID tr·∫°ng th√°i',
    `is_active`               BOOLEAN     NOT NULL DEFAULT TRUE,

    -- Timestamps
    `created_at`              TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`              TIMESTAMP   NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    CONSTRAINT `fk_template_merchant` FOREIGN KEY (`merchant_id`) REFERENCES `merchants` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_template_type` FOREIGN KEY (`invoice_type_id`) REFERENCES `invoice_types` (`id`) ON DELETE SET NULL,
    CONSTRAINT `uq_merchant_template_symbol` UNIQUE (`merchant_id`, `template_code`, `symbol_code`),

    INDEX `idx_template_codes` (`template_code`, `symbol_code`),
    INDEX `idx_is_active` (`is_active`),
    INDEX `idx_merchant_id` (`merchant_id`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Qu·∫£n l√Ω m·∫´u s·ªë v√† k√Ω hi·ªáu h√≥a ƒë∆°n';

-- CORE TABLE 5: Invoice Registrations (Supporting Core Table)
-- Registration Statuses
CREATE TABLE `registration_statuses`
(
    `id`          INT PRIMARY KEY COMMENT 'ID tr·∫°ng th√°i',
    `name`        VARCHAR(100) NOT NULL UNIQUE COMMENT 'T√™n tr·∫°ng th√°i',
    `description` VARCHAR(255) NULL COMMENT 'M√¥ t·∫£ chi ti·∫øt',
    `note`        VARCHAR(500) NULL COMMENT 'Ghi ch√∫ nghi·ªáp v·ª•',
    `created_at`  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    `updated_at`  TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Danh m·ª•c tr·∫°ng th√°i ƒëƒÉng k√Ω d·∫£i s·ªë';
INSERT INTO registration_statuses (id, name, description, note)
VALUES (1, 'ACTIVE', 'ƒêang hi·ªáu l·ª±c', 'D·∫£i s·ªë ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng'),
       (2, 'EXHAUSTED', 'ƒê√£ d√πng h·∫øt', 'To√†n b·ªô s·ªë trong d·∫£i ƒë√£ ph√°t h√†nh'),
       (3, 'EXPIRED', 'ƒê√£ h·∫øt h·∫°n', 'D·∫£i s·ªë ƒë√£ qu√° ng√†y hi·ªáu l·ª±c'),
       (4, 'CANCELLED', 'ƒê√£ h·ªßy', 'D·∫£i s·ªë b·ªã h·ªßy b·ªè');

CREATE TABLE `invoice_registrations`
(
    `id`                  BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`         BIGINT       NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu d·∫£i s·ªë',
    `registration_number` VARCHAR(50)  NULL COMMENT 'S·ªë quy·∫øt ƒë·ªãnh/ph√™ duy·ªát c·ªßa CQT',
    `from_number`         BIGINT       NOT NULL COMMENT 'S·ªë b·∫Øt ƒë·∫ßu c·ªßa d·∫£i',
    `to_number`           BIGINT       NOT NULL COMMENT 'S·ªë k·∫øt th√∫c c·ªßa d·∫£i',
    `quantity`            BIGINT       NOT NULL COMMENT 'S·ªë l∆∞·ª£ng h√≥a ƒë∆°n trong d·∫£i',
    `current_number`      BIGINT       NOT NULL DEFAULT 0 COMMENT 'S·ªë hi·ªán t·∫°i ƒë√£ s·ª≠ d·ª•ng',
    `effective_date`      DATE         NOT NULL COMMENT 'Ng√†y c√≥ hi·ªáu l·ª±c',
    `expiration_date`     DATE         NULL COMMENT 'Ng√†y h·∫øt h·∫°n',
    `status_id`           INT          NOT NULL DEFAULT 1 COMMENT 'Tr·∫°ng th√°i ƒëƒÉng k√Ω',
    `issued_by`           VARCHAR(255) NULL COMMENT 'Ng∆∞·ªùi ph√™ duy·ªát/C∆° quan Thu·∫ø',
    `note`                TEXT         NULL COMMENT 'Ghi ch√∫ b·ªï sung',
    `created_at`          TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`          TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    CONSTRAINT `fk_invoice_registrations_registration_statuses` FOREIGN KEY (`status_id`) REFERENCES `registration_statuses` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_registration_merchant` FOREIGN KEY (`merchant_id`) REFERENCES `merchants` (`id`) ON DELETE CASCADE,
    CONSTRAINT `chk_registration_range` CHECK (`from_number` <= `to_number`),

    INDEX `idx_registration_merchant` (`merchant_id`),
    INDEX `idx_registration_status` (`status_id`),
    INDEX `idx_registration_effective` (`effective_date`),
    INDEX `idx_registration_number` (`registration_number`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Qu·∫£n l√Ω ƒëƒÉng k√Ω d·∫£i s·ªë h√≥a ƒë∆°n v·ªõi C∆° quan Thu·∫ø';

-- CORE TABLE 6: Invoice Metadata (Central Transaction Table)
CREATE TABLE `invoice_metadata`
(
    -- Primary Key
    `id`                        BIGINT AUTO_INCREMENT PRIMARY KEY,

    -- Foreign Keys (Hierarchical references)
    `merchant_id`               BIGINT                                             NOT NULL COMMENT 'Li√™n k·∫øt doanh nghi·ªáp s·ªü h·ªØu',
    `provider_id`               BIGINT                                             NULL COMMENT 'Li√™n k·∫øt nh√† cung c·∫•p d·ªãch v·ª•',
    `provider_config_id`        BIGINT                                             NULL COMMENT 'C·∫•u h√¨nh Provider ƒë∆∞·ª£c s·ª≠ d·ª•ng',
    `invoice_template_id`       BIGINT                                             NULL COMMENT 'M·∫´u h√≥a ƒë∆°n ƒë∆∞·ª£c s·ª≠ d·ª•ng',
    `payment_method`            VARCHAR(10)                                        NULL COMMENT 'M√£ ph∆∞∆°ng th·ª©c thanh to√°n',

    -- Identifiers & References
    `client_request_id`         VARCHAR(100)                                       NULL COMMENT 'ID request t·ª´ h·ªá th·ªëng Merchant',
    `partner_invoice_id`        VARCHAR(50)                                        NULL COMMENT 'ID ƒë·ªãnh danh t·ª´ ƒë·ªëi t√°c',

    -- Invoice Information
    `invoice_number`            VARCHAR(20)                                        NULL COMMENT 'S·ªë h√≥a ƒë∆°n t·ª´ Provider tr·∫£ v·ªÅ',
    `symbol_code`               VARCHAR(10)                                        NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n',
    `template_code`             VARCHAR(20)                                        NULL COMMENT 'M·∫´u h√≥a ƒë∆°n',
    `invoice_type_code`         VARCHAR(10)                                        NULL COMMENT 'M√£ lo·∫°i h√≥a ƒë∆°n',
    `is_summary_invoice`        BOOLEAN                                            NOT NULL DEFAULT FALSE COMMENT 'H√≥a ƒë∆°n t·ªïng h·ª£p',
    `issuance_method`           ENUM ('STANDARD', 'POS')                           NOT NULL DEFAULT 'STANDARD' COMMENT 'Ph∆∞∆°ng th·ª©c ph√°t h√†nh',

    -- Enterprise Shell Fields (NULLABLE for JPA compatibility)
    `lookup_code`               VARCHAR(50)                                        NULL COMMENT 'M√£ tra c·ª©u h√≥a ƒë∆°n (Unique)',
    `cqt_code`                  VARCHAR(50)                                        NULL COMMENT 'M√£ C∆° quan Thu·∫ø c·∫•p',
    `provider_transaction_id`   VARCHAR(100)                                       NULL COMMENT 'ID giao d·ªãch t·ª´ Provider',

    -- Seller Information (Flattened from Merchant)
    `seller_name`               VARCHAR(255)                                       NULL COMMENT 'T√™n ng∆∞·ªùi b√°n',
    `seller_tax_code`           VARCHAR(20)                                        NULL COMMENT 'M√£ s·ªë thu·∫ø ng∆∞·ªùi b√°n',
    `seller_address`            TEXT                                               NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi b√°n',

    -- Buyer Information (FLATTENED - No Customer FK to prevent circular dependencies)
    `buyer_name`                VARCHAR(255)                                       NULL COMMENT 'T√™n ƒë∆°n v·ªã ng∆∞·ªùi mua',
    `buyer_tax_code`            VARCHAR(20)                                        NULL COMMENT 'MST ng∆∞·ªùi mua',
    `buyer_id_no`               VARCHAR(20)                                        NULL COMMENT 'S·ªë CMND/CCCD/H·ªô chi·∫øu',
    `buyer_full_name`           VARCHAR(200)                                       NULL COMMENT 'H·ªç t√™n ng∆∞·ªùi mua h√†ng',
    `buyer_email`               VARCHAR(255)                                       NULL COMMENT 'Email ng∆∞·ªùi mua',
    `buyer_phone`               VARCHAR(20)                                        NULL COMMENT 'ƒêi·ªán tho·∫°i ng∆∞·ªùi mua',
    `buyer_mobile`              VARCHAR(50)                                        NULL COMMENT 'Di ƒë·ªông ng∆∞·ªùi mua',
    `buyer_address`             TEXT                                               NULL COMMENT 'ƒê·ªãa ch·ªâ ng∆∞·ªùi mua',
    `buyer_bank_account`        VARCHAR(50)                                        NULL COMMENT 'T√†i kho·∫£n ng√¢n h√†ng',
    `buyer_bank_name`           VARCHAR(200)                                       NULL COMMENT 'T√™n ng√¢n h√†ng',
    `buyer_budget_code`         VARCHAR(20)                                        NULL COMMENT 'M√£ ch∆∞∆°ng/NSNN',

    -- Amounts & Currency (DECIMAL(18,2) for precision)
    `subtotal_amount`           DECIMAL(18, 2)                                     NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø',
    `tax_amount`                DECIMAL(18, 2)                                     NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ø',
    `discount_amount`           DECIMAL(18, 2)                                     NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng chi·∫øt kh·∫•u',
    `total_amount`              DECIMAL(18, 2)                                     NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thanh to√°n',
    `gross_amount`              DECIMAL(18, 2)                                              DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn th√¥',
    `net_amount`                DECIMAL(18, 2)                                              DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ßn',
    `currency_code`             VARCHAR(3)                                         NOT NULL DEFAULT 'VND' COMMENT 'ƒê∆°n v·ªã ti·ªÅn t·ªá',
    `exchange_rate`             DECIMAL(10, 4)                                     NOT NULL DEFAULT 1.0000 COMMENT 'T·ª∑ gi√°',

    -- Adjustment / Original Invoice Info
    `org_invoice_id`            VARCHAR(36)                                        NULL COMMENT 'ID h√≥a ƒë∆°n g·ªëc',
    `org_invoice_form`          VARCHAR(50)                                        NULL COMMENT 'M·∫´u h√≥a ƒë∆°n g·ªëc',
    `org_invoice_series`        VARCHAR(50)                                        NULL COMMENT 'K√Ω hi·ªáu h√≥a ƒë∆°n g·ªëc',
    `org_invoice_no`            VARCHAR(50)                                        NULL COMMENT 'S·ªë h√≥a ƒë∆°n g·ªëc',
    `org_invoice_date`          TIMESTAMP                                          NULL COMMENT 'Ng√†y h√≥a ƒë∆°n g·ªëc',
    `org_invoice_reason`        VARCHAR(500)                                       NULL COMMENT 'L√Ω do ƒëi·ªÅu ch·ªânh',
    `adjustment_type`           ENUM ('ADJUSTMENT', 'REPLACEMENT', 'CANCELLATION') NULL COMMENT 'Lo·∫°i ƒëi·ªÅu ch·ªânh',
    `cancellation_reason`       VARCHAR(500)                                       NULL COMMENT 'L√Ω do h·ªßy',
    `replaced_by_invoice_id`    BIGINT                                             NULL COMMENT 'H√≥a ƒë∆°n thay th·∫ø',

    -- Status & Dates
    `status_id`                 INT                                                NOT NULL DEFAULT 1 COMMENT 'Tr·∫°ng th√°i h√≥a ƒë∆°n',
    `status_message`            TEXT                                               NULL COMMENT 'Th√¥ng b√°o l·ªói ho·∫∑c tr·∫°ng th√°i chi ti·∫øt',
    `issue_date`                DATE                                               NULL COMMENT 'Ng√†y l·∫≠p h√≥a ƒë∆°n',
    `accounting_date`           DATE                                               NULL COMMENT 'Ng√†y h·∫°ch to√°n',
    `due_date`                  DATE                                               NULL COMMENT 'Ng√†y h·∫°n thanh to√°n',

    -- Timestamps for Audit Trail
    `signed_at`                 TIMESTAMP                                          NULL COMMENT 'Th·ªùi ƒëi·ªÉm k√Ω s·ªë',
    `sent_to_provider_at`       TIMESTAMP                                          NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i NCC',
    `received_from_provider_at` TIMESTAMP                                          NULL COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
    `delivered_to_buyer_at`     TIMESTAMP                                          NULL COMMENT 'Th·ªùi ƒëi·ªÉm g·ª≠i kh√°ch h√†ng',

    -- Provider Feedback
    `provider_error_code`       VARCHAR(50)                                        NULL COMMENT 'M√£ l·ªói t·ª´ Provider',
    `provider_error_message`    TEXT                                               NULL COMMENT 'Chi ti·∫øt l·ªói t·ª´ Provider',

    -- Soft Delete
    `is_deleted`                BOOLEAN                                            NOT NULL DEFAULT FALSE,
    `deleted_at`                TIMESTAMP                                          NULL COMMENT 'Th·ªùi ƒëi·ªÉm x√≥a',
    `deleted_by`                BIGINT                                             NULL COMMENT 'Ng∆∞·ªùi x√≥a',

    -- System Audit Timestamps
    `created_at`                TIMESTAMP                                          NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `updated_at`                TIMESTAMP                                          NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t cu·ªëi',

    -- Constraints
    CONSTRAINT `fk_invoice_merchant` FOREIGN KEY (`merchant_id`) REFERENCES `merchants` (`id`),
    CONSTRAINT `fk_invoice_status` FOREIGN KEY (`status_id`) REFERENCES `invoice_statuses` (`id`),
    CONSTRAINT `fk_invoice_provider` FOREIGN KEY (`provider_id`) REFERENCES `service_providers` (`id`),
    CONSTRAINT `fk_invoice_template` FOREIGN KEY (`invoice_template_id`) REFERENCES `invoice_template` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_invoice_config` FOREIGN KEY (`provider_config_id`) REFERENCES `merchant_provider_configs` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_invoice_payment_method` FOREIGN KEY (`payment_method`) REFERENCES `payment_methods` (`method_code`) ON DELETE SET NULL,
    CONSTRAINT `fk_invoice_replaced_by` FOREIGN KEY (`replaced_by_invoice_id`) REFERENCES `invoice_metadata` (`id`) ON DELETE SET NULL,
    CONSTRAINT `fk_invoice_deleted_by` FOREIGN KEY (`deleted_by`) REFERENCES `merchant_user` (`id`) ON DELETE SET NULL,
    CONSTRAINT `uq_invoice_lookup_code` UNIQUE (`lookup_code`),

    -- Indexes for Search Optimization
    INDEX `idx_merchant_status` (`merchant_id`, `status_id`),
    INDEX `idx_invoice_number` (`invoice_number`),
    INDEX `idx_client_request_id` (`client_request_id`),
    INDEX `idx_partner_invoice` (`partner_invoice_id`),
    INDEX `idx_buyer_tax_code` (`buyer_tax_code`),
    INDEX `idx_issue_date` (`issue_date`),
    INDEX `idx_created_at` (`created_at`),
    INDEX `idx_cqt_code` (`cqt_code`),
    INDEX `idx_template_code` (`template_code`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='B·∫£ng l∆∞u tr·ªØ Metadata h√≥a ƒë∆°n t·ªïng h·ª£p';

-- CORE TABLE 7: Invoice Items (Child of Invoice)
CREATE TABLE `invoice_items`
(
    `id`              BIGINT AUTO_INCREMENT PRIMARY KEY,
    `invoice_id`      BIGINT         NOT NULL COMMENT 'ID h√≥a ƒë∆°n cha',
    `line_number`     INT            NOT NULL DEFAULT 1 COMMENT 'S·ªë th·ª© t·ª± d√≤ng',

    -- Product Information
    `is_free`         BOOLEAN                 DEFAULT FALSE COMMENT 'H√†ng khuy·∫øn m√£i/bi·∫øu t·∫∑ng',
    `product_type_id` INT            NULL COMMENT 'Lo·∫°i h√†ng h√≥a/d·ªãch v·ª•',
    `product_code`    VARCHAR(100)   NULL COMMENT 'M√£ s·∫£n ph·∫©m',
    `product_name`    VARCHAR(500)   NOT NULL COMMENT 'T√™n h√†ng h√≥a/d·ªãch v·ª•',
    `unit_name`       VARCHAR(50)    NULL COMMENT 'ƒê∆°n v·ªã t√≠nh',

    -- Quantity & Unit Price
    `quantity`        DECIMAL(18, 4) NOT NULL DEFAULT 0 COMMENT 'S·ªë l∆∞·ª£ng',
    `unit_price`      DECIMAL(18, 4) NOT NULL DEFAULT 0 COMMENT 'ƒê∆°n gi√° ch∆∞a thu·∫ø',

    -- Amount Calculations
    `gross_amount`    DECIMAL(18, 2)          DEFAULT 0 COMMENT 'Th√†nh ti·ªÅn th√¥',
    `discount_rate`   DECIMAL(5, 2)           DEFAULT 0 COMMENT 'T·ª∑ l·ªá chi·∫øt kh·∫•u (%)',
    `discount_amount` DECIMAL(18, 2)          DEFAULT 0 COMMENT 'Ti·ªÅn chi·∫øt kh·∫•u',
    `net_price`       DECIMAL(18, 4)          DEFAULT 0 COMMENT 'Gi√° sau chi·∫øt kh·∫•u ch∆∞a thu·∫ø',
    `net_amount`      DECIMAL(18, 2)          DEFAULT 0 COMMENT 'Th√†nh ti·ªÅn sau chi·∫øt kh·∫•u tr∆∞·ªõc thu·∫ø',

    -- Tax Information
    `vat_rate_id`     BIGINT                  NULL COMMENT 'Ph√¢n lo·∫°i thu·∫ø',
    `tax_rate`        DECIMAL(5, 2)           DEFAULT 0 COMMENT 'M·ª©c thu·∫ø su·∫•t (%)',
    `tax_amount`      DECIMAL(18, 2)          DEFAULT 0 COMMENT 'Ti·ªÅn thu·∫ø GTGT',

    -- Total
    `total_amount`    DECIMAL(18, 2) NOT NULL DEFAULT 0 COMMENT 'T·ªïng thanh to√°n d√≤ng',

    -- Description
    `description`     TEXT           NULL COMMENT 'M√¥ t·∫£ s·∫£n ph·∫©m',
    `notes`           VARCHAR(500)   NULL COMMENT 'Ghi ch√∫ th√™m',

    `created_at`      TIMESTAMP      NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT `fk_item_invoice` FOREIGN KEY (`invoice_id`) REFERENCES `invoice_metadata` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_item_vat_rate` FOREIGN KEY (`vat_rate_id`) REFERENCES `vat_rates` (`id`) ON DELETE CASCADE,

    INDEX `idx_item_invoice` (`invoice_id`),
    INDEX `idx_product_code` (`product_code`),
    INDEX `idx_line_number` (`line_number`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Chi ti·∫øt t·ª´ng d√≤ng h√†ng h√≥a/d·ªãch v·ª• trong h√≥a ƒë∆°n';

-- CORE TABLE 8: Invoice Tax Breakdowns (Supporting Core Table)
CREATE TABLE `invoice_tax_breakdowns`
(
    `id`               BIGINT AUTO_INCREMENT PRIMARY KEY,
    `invoice_id`       BIGINT         NOT NULL COMMENT 'ID h√≥a ƒë∆°n cha',
    `vat_rate_id`      BIGINT         NOT NULL COMMENT 'Li√™n k·∫øt v·ªõi danh m·ª•c thu·∫ø su·∫•t',
    `vat_rate_code`    VARCHAR(10)    NOT NULL COMMENT 'M√£ thu·∫ø su·∫•t',
    `vat_rate_percent` DECIMAL(5, 2)  NOT NULL COMMENT 'Gi√° tr·ªã ph·∫ßn trƒÉm thu·∫ø su·∫•t',

    `subtotal_amount`  DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø',
    `discount_amount`  DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn chi·∫øt kh·∫•u',
    `taxable_amount`   DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn ch·ªãu thu·∫ø',
    `tax_amount`       DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn thu·∫ø GTGT',
    `total_amount`     DECIMAL(18, 2) NOT NULL DEFAULT 0.00 COMMENT 'T·ªïng ti·ªÅn bao g·ªìm thu·∫ø',

    `created_at`       TIMESTAMP      NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',

    CONSTRAINT `fk_tax_breakdown_invoice` FOREIGN KEY (`invoice_id`)
        REFERENCES `invoice_metadata` (`id`) ON DELETE CASCADE,
    CONSTRAINT `fk_tax_breakdown_vat_rate` FOREIGN KEY (`vat_rate_id`)
        REFERENCES `vat_rates` (`id`) ON DELETE RESTRICT,
    CONSTRAINT `uq_invoice_vat_rate` UNIQUE (`invoice_id`, `vat_rate_id`),

    INDEX `idx_breakdown_invoice` (`invoice_id`),
    INDEX `idx_breakdown_vat_rate` (`vat_rate_id`),
    INDEX `idx_vat_rate_code` (`vat_rate_code`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Ph√¢n r√£ thu·∫ø su·∫•t tr√™n t·ª´ng h√≥a ƒë∆°n';

-- CORE TABLE 9: Invoice Adjustments (Supporting Core Table)
CREATE TABLE `invoice_adjustments`
(
    `id`                   BIGINT AUTO_INCREMENT PRIMARY KEY,
    `original_invoice_id`  BIGINT                                                NOT NULL COMMENT 'H√≥a ƒë∆°n g·ªëc b·ªã ƒëi·ªÅu ch·ªânh/thay th·∫ø/h·ªßy',
    `adjustment_type`      ENUM ('ADJUSTMENT', 'REPLACEMENT', 'CANCELLATION')    NOT NULL COMMENT 'Lo·∫°i ƒëi·ªÅu ch·ªânh',

    `agreement_number`     VARCHAR(50)                                           NULL COMMENT 'S·ªë bi√™n b·∫£n th·ªèa thu·∫≠n',
    `agreement_date`       DATE                                                  NULL COMMENT 'Ng√†y l·∫≠p bi√™n b·∫£n',
    `agreement_content`    TEXT                                                  NULL COMMENT 'N·ªôi dung bi√™n b·∫£n th·ªèa thu·∫≠n',
    `signers`              TEXT                                                  NULL COMMENT 'Ng∆∞·ªùi k√Ω bi√™n b·∫£n (JSON array)',

    `reason_code`          VARCHAR(50)                                           NULL COMMENT 'M√£ l√Ω do',
    `reason_description`   VARCHAR(500)                                          NULL COMMENT 'M√¥ t·∫£ l√Ω do chi ti·∫øt',

    `old_subtotal_amount`  DECIMAL(18, 2)                                        NULL COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø c≈©',
    `old_tax_amount`       DECIMAL(18, 2)                                        NULL COMMENT 'Ti·ªÅn thu·∫ø c≈©',
    `old_total_amount`     DECIMAL(18, 2)                                        NULL COMMENT 'T·ªïng ti·ªÅn c≈©',
    `new_subtotal_amount`  DECIMAL(18, 2)                                        NULL COMMENT 'T·ªïng ti·ªÅn tr∆∞·ªõc thu·∫ø m·ªõi',
    `new_tax_amount`       DECIMAL(18, 2)                                        NULL COMMENT 'Ti·ªÅn thu·∫ø m·ªõi',
    `new_total_amount`     DECIMAL(18, 2)                                        NULL COMMENT 'T·ªïng ti·ªÅn m·ªõi',
    `difference_amount`    DECIMAL(18, 2)                                        NULL COMMENT 'Ch√™nh l·ªách ti·ªÅn',

    `status`               ENUM ('PENDING', 'APPROVED', 'REJECTED', 'CANCELLED') NOT NULL DEFAULT 'PENDING' COMMENT 'Tr·∫°ng th√°i duy·ªát',
    `approved_at`          TIMESTAMP                                             NULL COMMENT 'Th·ªùi ƒëi·ªÉm duy·ªát',

    `submitted_to_cqt`     BOOLEAN                                               NOT NULL DEFAULT FALSE COMMENT 'ƒê√£ g·ª≠i C∆° quan Thu·∫ø',
    `cqt_response_code`    VARCHAR(50)                                           NULL COMMENT 'M√£ ph·∫£n h·ªìi t·ª´ CQT',
    `cqt_response_message` TEXT                                                  NULL COMMENT 'N·ªôi dung ph·∫£n h·ªìi t·ª´ CQT',

    `created_at`           TIMESTAMP                                             NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`           TIMESTAMP                                             NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT `fk_adjustment_original_invoice` FOREIGN KEY (`original_invoice_id`)
        REFERENCES `invoice_metadata` (`id`) ON DELETE RESTRICT,

    INDEX `idx_adjustment_original` (`original_invoice_id`),
    INDEX `idx_adjustment_type` (`adjustment_type`),
    INDEX `idx_adjustment_status` (`status`),
    INDEX `idx_agreement_date` (`agreement_date`),
    INDEX `idx_submitted_cqt` (`submitted_to_cqt`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Th√¥ng tin bi√™n b·∫£n th·ªèa thu·∫≠n cho h√≥a ƒë∆°n ƒëi·ªÅu ch·ªânh/thay th·∫ø/h·ªßy';


-- SECTION 3: ENTERPRISE SHELL MODULES (Management & Auxiliary Tables)
-- MANAGEMENT TABLE 1: Invoice Payloads (One-to-One with Metadata)
CREATE TABLE `invoice_payloads`
(
    `invoice_id`   BIGINT    NOT NULL PRIMARY KEY COMMENT 'ID h√≥a ƒë∆°n - kh√≥a ch√≠nh v√† kh√≥a ngo·∫°i',
    `raw_data`     JSON      NULL COMMENT 'D·ªØ li·ªáu th√¥ request/response d·∫°ng JSON',
    `xml_content`  LONGTEXT  NULL COMMENT 'N·ªôi dung XML g·ªëc c·ªßa h√≥a ƒë∆°n',
    `json_content` LONGTEXT  NULL COMMENT 'N·ªôi dung JSON ƒë·∫ßy ƒë·ªß c·ªßa h√≥a ƒë∆°n',
    `signed_xml`   LONGTEXT  NULL COMMENT 'XML ƒë√£ k√Ω ƒëi·ªán t·ª≠',
    `pdf_data`     LONGTEXT  NULL COMMENT 'D·ªØ li·ªáu PDF ƒë√£ t·∫°o (base64)',
    `extra_data`   JSON      NULL COMMENT 'D·ªØ li·ªáu b·ªï sung kh√°c',
    `created_at`   TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm l∆∞u',
    `updated_at`   TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT `fk_invoice_payload_invoice` FOREIGN KEY (`invoice_id`)
        REFERENCES `invoice_metadata` (`id`) ON DELETE CASCADE,

    INDEX `idx_payload_created` (`created_at`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='L∆∞u tr·ªØ n·ªôi dung XML/JSON g·ªëc h√≥a ƒë∆°n';

-- MANAGEMENT TABLE 2: API Credentials
CREATE TABLE `api_credentials`
(
    `id`                        BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id`               BIGINT       NOT NULL COMMENT 'Doanh nghi·ªáp s·ªü h·ªØu credential',
    `client_id`                 VARCHAR(50)  NOT NULL UNIQUE COMMENT 'ID c√¥ng khai c·ªßa ·ª©ng d·ª•ng',
    `api_key_hash`              VARCHAR(255) NOT NULL COMMENT 'Hash c·ªßa API Key (SHA-256)',
    `api_key_prefix`            VARCHAR(8)   NOT NULL COMMENT '8 k√Ω t·ª± ƒë·∫ßu c·ªßa API Key',
    `scopes`                    TEXT         NOT NULL COMMENT 'Quy·ªÅn h·∫°n - JSON array',
    `ip_whitelist`              TEXT         NULL COMMENT 'Danh s√°ch IP ƒë∆∞·ª£c ph√©p - JSON array',
    `rate_limit_per_hour`       INT          NOT NULL DEFAULT 1000 COMMENT 'Gi·ªõi h·∫°n request/gi·ªù',
    `rate_limit_per_day`        INT          NOT NULL DEFAULT 10000 COMMENT 'Gi·ªõi h·∫°n request/ng√†y',
    `request_count_hour`        INT          NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong gi·ªù',
    `request_count_day`         INT          NOT NULL DEFAULT 0 COMMENT 'Request ƒë√£ d√πng trong ng√†y',
    `request_count_resetted_at` TIMESTAMP    NULL COMMENT 'Th·ªùi ƒëi·ªÉm reset counter',
    `expired_at`                TIMESTAMP    NULL COMMENT 'Ng√†y h·∫øt h·∫°n - NULL kh√¥ng gi·ªõi h·∫°n',
    `last_used_at`              TIMESTAMP    NULL COMMENT 'L·∫ßn s·ª≠ d·ª•ng cu·ªëi',
    `is_active`                 BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'C√≤n hi·ªáu l·ª±c',
    `created_at`                TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`                TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    -- Using INDEX instead of FK for performance (decoupled from merchant table)
    INDEX `idx_merchant_id` (`merchant_id`),
    INDEX `idx_client_id` (`client_id`),
    INDEX `idx_api_key_hash` (`api_key_hash`),
    INDEX `idx_expired_at` (`expired_at`),
    INDEX `idx_is_active` (`is_active`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Credentials cho API access';

-- MANAGEMENT TABLE 3: Audit Logs
CREATE TABLE `audit_logs`
(
    `id`          BIGINT AUTO_INCREMENT PRIMARY KEY,
    `merchant_id` BIGINT       NULL COMMENT 'Doanh nghi·ªáp li√™n quan',
    `user_id`     BIGINT       NULL COMMENT 'Ng∆∞·ªùi th·ª±c hi·ªán',
    `entity_type` VARCHAR(50)  NOT NULL COMMENT 'Lo·∫°i entity: Invoice, Merchant, Config...',
    `entity_id`   BIGINT       NOT NULL COMMENT 'ID c·ªßa entity',
    `action`      VARCHAR(50)  NOT NULL COMMENT 'H√†nh ƒë·ªông: CREATE, UPDATE, DELETE, STATUS_CHANGE',
    `old_value`   JSON         NULL COMMENT 'Gi√° tr·ªã c≈©',
    `new_value`   JSON         NULL COMMENT 'Gi√° tr·ªã m·ªõi',
    `ip_address`  VARCHAR(45)  NULL COMMENT 'IP th·ª±c hi·ªán',
    `user_agent`  VARCHAR(500) NULL COMMENT 'User Agent c·ªßa browser/client',
    `request_id`  VARCHAR(100) NULL COMMENT 'ID request t·ª´ frontend',
    `created_at`  TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm x·∫£y ra',

    -- Using INDEX instead of FK for high-performance logging
    INDEX `idx_merchant_id` (`merchant_id`),
    INDEX `idx_user_id` (`user_id`),
    INDEX `idx_entity` (`entity_type`, `entity_id`),
    INDEX `idx_action` (`action`),
    INDEX `idx_created_at` (`created_at`),
    INDEX `idx_merchant_entity` (`merchant_id`, `entity_type`, `entity_id`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='Nh·∫≠t k√Ω thay ƒë·ªïi h·ªá th·ªëng';

-- MANAGEMENT TABLE 4: Invoice Sync Queue
CREATE TABLE `invoice_sync_queue`
(
    `id`                      BIGINT AUTO_INCREMENT PRIMARY KEY,
    `invoice_id`              BIGINT                                                                        NOT NULL COMMENT 'ID h√≥a ƒë∆°n c·∫ßn ƒë·ªìng b·ªô',
    `sync_type`               ENUM ('SEND_TO_PROVIDER', 'SEND_TO_CQT', 'CANCEL_INVOICE', 'REPLACE_INVOICE') NOT NULL COMMENT 'Lo·∫°i thao t√°c ƒë·ªìng b·ªô',
    `priority`                INT                                                                           NOT NULL DEFAULT 5 COMMENT 'ƒê·ªô ∆∞u ti√™n (1=cao nh·∫•t, 10=th·∫•p nh·∫•t)',

    `status`                  ENUM ('PENDING', 'PROCESSING', 'COMPLETED', 'FAILED', 'RETRYING')             NOT NULL DEFAULT 'PENDING' COMMENT 'Tr·∫°ng th√°i x·ª≠ l√Ω',
    `attempt_count`           INT                                                                           NOT NULL DEFAULT 0 COMMENT 'S·ªë l·∫ßn th·ª≠',
    `max_attempts`            INT                                                                           NOT NULL DEFAULT 3 COMMENT 'S·ªë l·∫ßn th·ª≠ t·ªëi ƒëa',
    `last_attempt_at`         TIMESTAMP                                                                     NULL COMMENT 'Th·ªùi ƒëi·ªÉm th·ª≠ l·∫ßn cu·ªëi',
    `next_retry_at`           TIMESTAMP                                                                     NULL COMMENT 'Th·ªùi ƒëi·ªÉm th·ª≠ ti·∫øp theo',

    `request_data`            JSON                                                                          NULL COMMENT 'D·ªØ li·ªáu request g·ª≠i ƒëi',
    `response_data`           JSON                                                                          NULL COMMENT 'D·ªØ li·ªáu response nh·∫≠n v·ªÅ',
    `error_code`              VARCHAR(50)                                                                   NULL COMMENT 'M√£ l·ªói',
    `error_message`           TEXT                                                                          NULL COMMENT 'Chi ti·∫øt l·ªói',

    `processed_by`            VARCHAR(100)                                                                  NULL COMMENT 'Worker x·ª≠ l√Ω',
    `processing_started_at`   TIMESTAMP                                                                     NULL COMMENT 'Th·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu x·ª≠ l√Ω',
    `processing_completed_at` TIMESTAMP                                                                     NULL COMMENT 'Th·ªùi ƒëi·ªÉm ho√†n th√†nh',

    `created_at`              TIMESTAMP                                                                     NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o',
    `updated_at`              TIMESTAMP                                                                     NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    CONSTRAINT `fk_sync_queue_invoice` FOREIGN KEY (`invoice_id`)
        REFERENCES `invoice_metadata` (`id`) ON DELETE CASCADE,

    CONSTRAINT `chk_sync_attempt_count` CHECK (`attempt_count` <= `max_attempts`),

    INDEX `idx_sync_queue_status` (`status`),
    INDEX `idx_sync_queue_invoice` (`invoice_id`),
    INDEX `idx_sync_queue_merchant` (`invoice_id`),
    INDEX `idx_sync_queue_priority` (`priority`),
    INDEX `idx_sync_queue_next_retry` (`next_retry_at`),
    INDEX `idx_sync_queue_created` (`created_at`),
    INDEX `idx_sync_queue_status_priority` (`status`, `priority`, `next_retry_at`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='H√†ng ƒë·ª£i g·ª≠i h√≥a ƒë∆°n sang Provider/CQT';

-- MANAGEMENT TABLE 5: Tax Authority Responses
CREATE TABLE `tax_authority_responses`
(
    `id`              BIGINT AUTO_INCREMENT PRIMARY KEY,
    `invoice_id`      BIGINT       NOT NULL COMMENT 'H√≥a ƒë∆°n li√™n quan',
    `cqt_code`        VARCHAR(50)  NOT NULL COMMENT 'M√£ C∆° quan Thu·∫ø',
    `status_from_cqt` VARCHAR(50)  NOT NULL COMMENT 'Tr·∫°ng th√°i t·ª´ C∆° quan Thu·∫ø',
    `processing_code` VARCHAR(100) NULL COMMENT 'M√£ x·ª≠ l√Ω t·ª´ C∆° quan Thu·∫ø',
    `signature_data`  TEXT         NULL COMMENT 'D·ªØ li·ªáu ch·ªØ k√Ω t·ª´ C∆° quan Thu·∫ø',
    `raw_response`    JSON         NULL COMMENT 'Response th√¥ t·ª´ C∆° quan Thu·∫ø',
    `error_code`      VARCHAR(50)  NULL COMMENT 'M√£ l·ªói t·ª´ C∆° quan Thu·∫ø',
    `error_message`   TEXT         NULL COMMENT 'Th√¥ng b√°o l·ªói t·ª´ C∆° quan Thu·∫ø',
    `received_at`     TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm nh·∫≠n ph·∫£n h·ªìi',
    `processed_at`    TIMESTAMP    NULL COMMENT 'Th·ªùi ƒëi·ªÉm x·ª≠ l√Ω ho√†n t·∫•t',
    `created_at`      TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm t·∫°o b·∫£n ghi',

    CONSTRAINT `fk_tax_response_invoice` FOREIGN KEY (`invoice_id`)
        REFERENCES `invoice_metadata` (`id`) ON DELETE CASCADE,

    INDEX `idx_tax_response_invoice` (`invoice_id`),
    INDEX `idx_cqt_code` (`cqt_code`),
    INDEX `idx_status_cqt` (`status_from_cqt`),
    INDEX `idx_received_at` (`received_at`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='L∆∞u v·∫øt t∆∞∆°ng t√°c v·ªõi C∆° quan Thu·∫ø';

-- MANAGEMENT TABLE 6: System Configuration
CREATE TABLE `system_config`
(
    `id`           BIGINT AUTO_INCREMENT PRIMARY KEY,
    `config_key`   VARCHAR(100) NOT NULL UNIQUE COMMENT 'Kh√≥a c·∫•u h√¨nh',
    `config_value` TEXT         NOT NULL COMMENT 'Gi√° tr·ªã c·∫•u h√¨nh',
    `config_type`  VARCHAR(20)  NOT NULL DEFAULT 'STRING' COMMENT 'Lo·∫°i: STRING, NUMBER, BOOLEAN, JSON',
    `description`  VARCHAR(500) NULL COMMENT 'M√¥ t·∫£ c·∫•u h√¨nh',
    `is_encrypted` BOOLEAN      NOT NULL DEFAULT FALSE COMMENT 'C√≥ c·∫ßn m√£ h√≥a kh√¥ng',
    `is_editable`  BOOLEAN      NOT NULL DEFAULT TRUE COMMENT 'C√≥ th·ªÉ ch·ªânh s·ª≠a kh√¥ng',
    `updated_by`   BIGINT       NULL COMMENT 'Ng∆∞·ªùi c·∫≠p nh·∫≠t cu·ªëi',
    `updated_at`   TIMESTAMP    NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'Th·ªùi ƒëi·ªÉm c·∫≠p nh·∫≠t',

    INDEX `idx_config_key` (`config_key`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4
  COLLATE = utf8mb4_unicode_ci COMMENT ='C·∫•u h√¨nh h·ªá th·ªëng';
INSERT INTO system_config (config_key, config_value, config_type, description)
VALUES ('SYSTEM_NAME', 'EInvoiceHub', 'STRING', 'T√™n hi·ªÉn th·ªã c·ªßa h·ªá th·ªëng'),
       ('INVOICE_EXPIRY_DAYS', '30', 'NUMBER', 'S·ªë ng√†y h√≥a ƒë∆°n c√≥ hi·ªáu l·ª±c sau khi ph√°t h√†nh'),
       ('MAX_RETRY_ATTEMPTS', '3', 'NUMBER', 'S·ªë l·∫ßn th·ª≠ l·∫°i khi g·ªçi Provider th·∫•t b·∫°i'),
       ('RETRY_DELAY_MS', '1000', 'NUMBER', 'Th·ªùi gian ch·ªù gi·ªØa c√°c l·∫ßn th·ª≠ l·∫°i (milliseconds)'),
       ('SESSION_TIMEOUT_MINUTES', '60', 'NUMBER', 'Th·ªùi gian timeout c·ªßa session'),
       ('PASSWORD_MIN_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i t·ªëi thi·ªÉu c·ªßa m·∫≠t kh·∫©u'),
       ('API_KEY_PREFIX_LENGTH', '8', 'NUMBER', 'ƒê·ªô d√†i prefix hi·ªÉn th·ªã c·ªßa API Key'),
       ('DEFAULT_CURRENCY', 'VND', 'STRING', 'ƒê∆°n v·ªã ti·ªÅn t·ªá m·∫∑c ƒë·ªãnh'),
       ('TAX_DEFAULT_RATE', '10.00', 'NUMBER', 'Thu·∫ø su·∫•t m·∫∑c ƒë·ªãnh (%)'),
       ('BACKGROUND_JOB_ENABLED', 'true', 'BOOLEAN', 'K√≠ch ho·∫°t x·ª≠ l√Ω background jobs'),
       ('INVOICE_LOOKUP_CODE_LENGTH', '6', 'NUMBER', 'ƒê·ªô d√†i m√£ tra c·ª©u h√≥a ƒë∆°n ng·∫´u nhi√™n');

-- SECTION 4: SYSTEM VIEWS
-- View for user authorization
CREATE OR REPLACE VIEW `vw_sys_user_author` AS
SELECT CAST(id AS CHAR) AS id,
       username         AS name,
       full_name        AS full_name
FROM merchant_user
WHERE is_active = TRUE;

SET FOREIGN_KEY_CHECKS = 1;










-- SCHEMA SUMMARY
/*
Architecture Overview:
======================

CORE JPA TABLES (9 tables - Hierarchical Flow):
-------------------------------------------------
1. merchants              -> Root entity (contains Shell fields: subscription_plan, invoice_quota, updated_at)
2. merchant_user         -> Child of merchants
3. merchant_provider_configs -> Child of merchants (contains Shell fields: is_test_mode, encrypted_password_storage)
4. invoice_template      -> Child of merchants
5. invoice_registrations -> Child of merchants
6. invoice_metadata      -> Central transaction (contains Shell fields: lookup_code, cqt_code, provider_transaction_id)
7. invoice_items         -> Child of invoice_metadata
8. invoice_tax_breakdowns -> Child of invoice_metadata
9. invoice_adjustments   -> Related to invoice_metadata

ENTERPRISE SHELL MODULES (Management Tables):
----------------------------------------------
- invoice_payloads       -> One-to-One with invoice_metadata
- api_credentials        -> INDEX-based (decoupled)
- audit_logs             -> INDEX-based (high-performance)
- invoice_sync_queue     -> Background processing
- tax_authority_responses -> External system integration
- system_config          -> Key-value configuration

Data Flow (Hierarchical - No Reverse Dependencies):
---------------------------------------------------
Merchants -> ProviderConfigs -> Templates -> Invoices -> InvoiceItems
     |
     +-> Users
     +-> Registrations

Key Design Decisions:
---------------------
1. Flat Metadata Strategy: Buyer information stored directly in invoice_metadata
   to prevent circular dependencies when generating historical reports.

2. Hard FK for Core Relations: Ensures data integrity for business-critical
   relationships (Invoice->Items, Invoice->Template, etc.)

3. INDEX for Auxiliary Tables: audit_logs and system_config use INDEX instead
   of FK to maintain high performance and prevent locking issues.

4. NULLABLE Shell Fields: All new enterprise fields are NULLABLE to maintain
   JPA compatibility with existing Spring Boot save() methods.

5. DECIMAL(18,2): Used for all monetary values to ensure precision.

6. utf8mb4_unicode_ci: Full Unicode support including emojis.
*/
</file>

<file path="src/main/resources/application-dev.yaml">
# Development Profile - Optimized for Hybrid Workflow (IDE + Docker DB)
spring:
  datasource:
    url: jdbc:mariadb://localhost:3306/einvoicehub?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
    username: einvoice_user
    password: einvoice_pass
    driver-class-name: org.mariadb.jdbc.Driver

  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    properties:
      hibernate:
        format_sql: true
        highlight_sql: true

  flyway:
    enabled: true
    clean-disabled: false

app:
  encryption:
    secret-key: "dev-secret-key-32-chars-long-abc"
  jwt:
    secret: "dev-jwt-secret-key-very-long-and-secure-for-testing"
    expiration-ms: 36000000

  provider:
    bkav:
      base-url: https://demo.ehoadon.vn/api/v1
    misa:
      base-url: https://testapi.meinvoice.vn/api/integration

logging:
  level:
    com.einvoicehub: DEBUG
    org.springframework.security: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.orm.results: TRACE
</file>

<file path="src/main/resources/application.yaml">
spring:
  threads:
    virtual:
      enabled: true

  application:
    name: einvoice-core

  # =============================================================================
  # MariaDB Database Configuration
  # =============================================================================
  datasource:
    url: jdbc:mariadb://localhost:3306/einvoicehub?createDatabaseIfNotExist=true&useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
    username: root
    password: ${DB_PASSWORD:root}
    driver-class-name: org.mariadb.jdbc.Driver

    hikari:
      minimum-idle: 5
      maximum-pool-size: 20
      idle-timeout: 300000
      max-lifetime: 1200000
      connection-timeout: 20000

  # JPA/Hibernate Configuration - S·ª≠ d·ª•ng MariaDBDialect
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.MariaDBDialect
        jdbc:
          batch_size: 50
        order_inserts: true
        order_updates: true

  # =============================================================================
  # Flyway Migration
  # =============================================================================
  flyway:
    enabled: true
    locations: classpath:db/migration
    baseline-on-migrate: true
    validate-on-migrate: true
    baseline-version: 0
    out-of-order: false

# Server Configuration
server:
  port: 8080
  servlet:
    context-path: /api

# Application Custom Properties
app:
  # Encryption
  encryption:
    secret-key: ${ENCRYPTION_SECRET_KEY: CH∆ØA C√ì!}

  # JWT Configuration
  jwt:
    secret: ${JWT_SECRET: CH∆ØA C√ì!}
    expiration-ms: 86400000  # 24 hours

  # API Key Configuration
  api-key:
    prefix-length: 8
    default-rate-limit-per-hour: 1000
    default-rate-limit-per-day: 10000

  # Provider Configuration
  provider:
    default-timeout-ms: 30000
    max-retry-attempts: 3
    retry-delay-ms: 1000
    vnpt:
      base-url: https://api.vnptinvoice.com.vn/v1
      timeout-ms: 30000
    viettel:
      base-url: https://ebill.vietteltelecom.vn/api/v1
      timeout-ms: 30000
    bkav:
      base-url: https://einvoice.bkav.com/api/v1
      test-base-url: https://demo.ehoadon.vn/api/v1
      timeout-ms: 30000
      encryption-key: ${BKAV_ENCRYPTION_KEY: CH∆ØA C√ì }  # AES-256 key t·ª´ BKAV
    misa:
      base-url: https://api.meinvoice.vn/api/integration
      test-base-url: https://testapi.meinvoice.vn/api/integration
      timeout-ms: 30000

# Logging Configuration
logging:
  level:
    root: INFO
    com.einvoicehub: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# Management/Actuator
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: always
</file>

<file path="src/test/java/com/einvoicehub/core/EinvoiceCoreApplicationTests.java">
package com.einvoicehub.core;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class EinvoiceCoreApplicationTests {

	@Test
	void contextLoads() {
	}

}
</file>

<file path="terraform/main.tf">
# EInvoiceHub Infrastructure as Code (Terraform)

terraform {
  required_version = ">= 1.5.0"

  required_providers {
    kubernetes = {
      source  = "hashicorp/kubernetes"
      version = "~> 2.24"
    }

    helm = {
      source  = "hashicorp/helm"
      version = "~> 2.12"
    }

    random = {
      source  = "hashicorp/random"
      version = "~> 3.6"
    }

    kubectl = {
      source  = "gavinbunney/kubectl"
      version = "~> 1.14"
    }
  }

  # Configure backend (modify for production)
  backend "local" {
    path = "terraform.tfstate"
  }
}

# Kubernetes Provider Configuration

provider "kubernetes" {
  config_path    = "~/.kube/config"
  config_context = var.kubernetes_context
}

provider "helm" {
  kubernetes {
    config_path    = "~/.kube/config"
    config_context = var.kubernetes_context
  }
}

provider "kubectl" {
  config_path    = "~/.kube/config"
  config_context = var.kubernetes_context
}

# Random Resources for Password Generation

resource "random_string" "mysql_password" {
  length  = 32
  special = false
}

resource "random_string" "mongodb_password" {
  length  = 32
  special = false
}

resource "random_string" "redis_password" {
  length  = 32
  special = false
}

resource "random_string" "grafana_password" {
  length  = 32
  special = false
}

resource "random_id" "session_id" {
  byte_length = 4
}

# Namespace Creation

resource "kubernetes_namespace" "einvoice_namespace" {
  metadata {
    name        = var.namespace
    labels = {
      environment = var.environment
      project     = "einvoicehub"
      managed_by  = "terraform"
    }
  }
}

# ConfigMap for Application Configuration

resource "kubernetes_config_map" "app_config" {
  metadata {
    name      = "${var.app_name}-config"
    namespace = kubernetes_namespace.einvoice_namespace.metadata[0].name
    labels = {
      app = var.app_name
    }
  }

  data = {
    # Application Settings
    APP_NAME                = var.app_name
    APP_VERSION             = var.app_version
    SERVER_PORT             = var.server_port
    SPRING_PROFILES_ACTIVE  = var.environment

    # Logging Configuration
    LOG_LEVEL               = var.log_level
    LOG_FORMAT              = "json"

    # Database Configuration (placeholders - use secrets for actual values)
    SPRING_DATASOURCE_URL   = "jdbc:mysql://${var.mysql_host}:${var.mysql_port}/${var.mysql_database}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC"
    SPRING_JPA_HIBERNATE_DDL_AUTO = "update"

    # MongoDB Configuration
    SPRING_DATA_MONGODB_URI = "mongodb://${var.mongo_host}:${var.mongo_port}/${var.mongo_database}?authSource=admin"

    # Redis Configuration
    SPRING_REDIS_HOST       = var.redis_host
    SPRING_REDIS_PORT       = var.redis_port

    # Actuator Endpoints
    MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE = "health,info,metrics,prometheus"
    MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS    = "when_authorized"

    # Virtual Threads (Java 21)
    JAVA_THREADS_VIRTUAL_ENABLED = "true"
  }
}

# Secrets for Sensitive Data
resource "kubernetes_secret" "database_secrets" {
  metadata {
    name      = "${var.app_name}-db-secrets"
    namespace = kubernetes_namespace.einvoice_namespace.metadata[0].name
    labels = {
      app = var.app_name
    }
  }

  type = "Opaque"

  data = {
    # Base64 encoded values
    SPRING_DATASOURCE_USERNAME = base64encode(var.mysql_username)
    SPRING_DATASOURCE_PASSWORD = base64encode(random_string.mysql_password.result)
    SPRING_DATA_MONGODB_USERNAME = base64encode(var.mongo_username)
    SPRING_DATA_MONGODB_PASSWORD = base64encode(random_string.mongodb_password.result)
    SPRING_REDIS_PASSWORD = base64encode(random_string.redis_password.result)
  }
}

resource "kubernetes_secret" "api_secrets" {
  metadata {
    name      = "${var.app_name}-api-secrets"
    namespace = kubernetes_namespace.einvoice_namespace.metadata[0].name
    labels = {
      app = var.app_name
    }
  }

  type = "Opaque"

  data = {
    # API Key encryption key (should be rotated regularly)
    ENCRYPTION_KEY_AES256 = base64encode(var.encryption_key)
    ENCRYPTION_KEY_IV     = base64encode(var.encryption_iv)

    # JWT Configuration
    JWT_SECRET_KEY        = base64encode(var.jwt_secret)
    JWT_EXPIRATION_MS     = base64encode(var.jwt_expiration_ms)
  }
}

resource "kubernetes_secret" "provider_secrets" {
  metadata {
    name      = "${var.app_name}-provider-secrets"
    namespace = kubernetes_namespace.einvoice_namespace.metadata[0].name
    labels = {
      app = var.app_name
    }
  }

  type = "Opaque"

  data = {
    # Provider-specific API keys (encrypted)
    VIETTEL_API_KEY      = base64encode(var.viettel_api_key)
    VIETTEL_CLIENT_ID    = base64encode(var.viettel_client_id)

    BKAV_API_KEY         = base64encode(var.bkav_api_key)
    BKAV_CLIENT_ID       = base64encode(var.bkav_client_id)

    MISA_API_KEY         = base64encode(var.misa_api_key)
    MISA_CLIENT_ID       = base64encode(var.misa_client_id)
    MISA_CLIENT_SECRET   = base64encode(var.misa_client_secret)
  }
}

# =============================================================================
# Resource Quotas
# =============================================================================

resource "kubernetes_resource_quota" "namespace_quota" {
  metadata {
    name      = "${var.app_name}-quota"
    namespace = kubernetes_namespace.einvoice_namespace.metadata[0].name
  }

  spec {
    hard = {
      "limits.cpu"    = var.resource_quota.cpu_limit
      "limits.memory" = var.resource_quota.memory_limit
      "pods"          = "20"
      "services"      = "10"
      "secrets"       = "20"
      "configmaps"    = "20"
      "persistentvolumeclaims" = "10"
    }
  }
}

# Limit Ranges

resource "kubernetes_limit_range" "namespace_limits" {
  metadata {
    name      = "${var.app_name}-limits"
    namespace = kubernetes_namespace.einvoice_namespace.metadata[0].name
  }

  spec {
    limit {
      type = "Container"

      default_request = {
        cpu    = var.limit_range.cpu_request
        memory = var.limit_range.memory_request
      }

      default = {
        cpu    = var.limit_range.cpu_limit
        memory = var.limit_range.memory_limit
      }

      min = {
        cpu    = var.limit_range.cpu_min
        memory = var.limit_range.memory_min
      }

      max = {
        cpu    = var.limit_range.cpu_max
        memory = var.limit_range.memory_max
      }
    }
  }
}

# Network Policy

resource "kubernetes_network_policy" "einvoice_network_policy" {
  metadata {
    name      = "${var.app_name}-network-policy"
    namespace = kubernetes_namespace.einvoice_namespace.metadata[0].name
  }

  spec {
    pod_selector {
      match_labels = {
        app = var.app_name
      }
    }

    policy_types = ["Ingress", "Egress"]

    ingress {
      from {
        namespace_selector {
          match_labels = {
            name = "ingress-nginx"
          }
        }
      }

      from {
        pod_selector {
          match_labels = {
            app = var.app_name
          }
        }
      }

      ports {
        protocol = "TCP"
        port     = var.server_port
      }

      ports {
        protocol = "TCP"
        port     = 9090
      }
    }

    egress {
      # Allow DNS resolution
      to {
        namespace_selector {
          match_labels = {
            name = "kube-system"
          }
        }
      }

      # Allow traffic to MySQL
      to {
        pod_selector {
          match_labels = {
            tier = "database"
          }
        }
        ports {
          protocol = "TCP"
          port     = 3306
        }
      }

      # Allow traffic to MongoDB
      to {
        pod_selector {
          match_labels = {
            tier = "database"
          }
        }
        ports {
          protocol = "TCP"
          port     = 27017
        }
      }

      # Allow traffic to Redis
      to {
        pod_selector {
          match_labels = {
            tier = "cache"
          }
        }
        ports {
          protocol = "TCP"
          port     = 6379
        }
      }

      # Allow external API calls
      to {
        ip_block {
          cidr = "0.0.0.0/0"
          except = [
            "10.0.0.0/8",
            "172.16.0.0/12",
            "192.168.0.0/16"
          ]
        }
      }
    }
  }
}
</file>

<file path="terraform/outputs.tf">
# EInvoiceHub Terraform Outputs
output "namespace_name" {
  description = "Kubernetes namespace name"
  value       = kubernetes_namespace.einvoice_namespace.metadata[0].name
}

output "namespace_creation_timestamp" {
  description = "Namespace creation timestamp"
  value       = kubernetes_namespace.einvoice_namespace.metadata[0].creation_timestamp
}

# Application Configuration Outputs
output "app_name" {
  description = "Application name"
  value       = var.app_name
}

output "app_version" {
  description = "Application version"
  value       = var.app_version
}

output "environment" {
  description = "Deployment environment"
  value       = var.environment
}

output "server_port" {
  description = "Application server port"
  value       = var.server_port
}

# Resource Outputs
output "replica_count" {
  description = "Number of pod replicas configured"
  value       = var.replicas
}

output "cpu_limit" {
  description = "CPU limit per pod"
  value       = var.limit_range.cpu_limit
}

output "memory_limit" {
  description = "Memory limit per pod"
  value       = var.limit_range.memory_limit
}

# Database Configuration Outputs

output "mysql_host" {
  description = "MySQL hostname"
  value       = var.mysql_host
}

output "mysql_port" {
  description = "MySQL port"
  value       = var.mysql_port
}

output "mysql_database" {
  description = "MySQL database name"
  value       = var.mysql_database
}

output "mongodb_uri" {
  description = "MongoDB connection URI"
  value       = "mongodb://${var.mongo_host}:${var.mongo_port}/${var.mongo_database}"
  sensitive   = false
}

output "redis_host" {
  description = "Redis hostname"
  value       = var.redis_host
}

output "redis_port" {
  description = "Redis port"
  value       = var.redis_port
}

# Secret Names (not values)
output "database_secret_name" {
  description = "Kubernetes secret name for database credentials"
  value       = kubernetes_secret.database_secrets.metadata[0].name
}

output "api_secret_name" {
  description = "Kubernetes secret name for API credentials"
  value       = kubernetes_secret.api_secrets.metadata[0].name
}

output "provider_secret_name" {
  description = "Kubernetes secret name for provider credentials"
  value       = kubernetes_secret.provider_secrets.metadata[0].name
}

output "configmap_name" {
  description = "Kubernetes ConfigMap name for application configuration"
  value       = kubernetes_config_map.app_config.metadata[0].name
}

# Network Policy Outputs
output "network_policy_name" {
  description = "Kubernetes NetworkPolicy name"
  value       = kubernetes_network_policy.einvoice_network_policy.metadata[0].name
}

# Resource Quota Outputs
output "resource_quota_name" {
  description = "ResourceQuota name"
  value       = kubernetes_resource_quota.namespace_quota.metadata[0].name
}

# Connection Information
output "application_url" {
  description = "Application URL (if ingress is enabled)"
  value       = var.ingress_enabled ? "http://${var.ingress_host}" : "http://localhost:${var.server_port}"
}

output "health_endpoint" {
  description = "Application health check endpoint"
  value       = var.ingress_enabled ? "http://${var.ingress_host}/actuator/health" : "http://localhost:${var.server_port}/actuator/health"
}

output "metrics_endpoint" {
  description = "Prometheus metrics endpoint"
  value       = var.ingress_enabled ? "http://${var.ingress_host}/actuator/prometheus" : "http://localhost:${var.server_port}/actuator/prometheus"
}

# Monitoring Endpoints (if enabled)
output "grafana_url" {
  description = "Grafana dashboard URL"
  value       = var.monitoring_enabled ? "http://${var.ingress_host}:3000" : "Grafana not enabled"
}

output "prometheus_url" {
  description = "Prometheus URL"
  value       = var.monitoring_enabled ? "http://${var.ingress_host}:9090" : "Prometheus not enabled"
}

output "jaeger_url" {
  description = "Jaeger tracing UI URL"
  value       = var.tracing_enabled ? "http://${var.ingress_host}:16686" : "Jaeger not enabled"
}

# Kubernetes Context Information
output "kubernetes_context" {
  description = "Kubernetes context used"
  value       = var.kubernetes_context
}

output "kubectl_command" {
  description = "Example kubectl command to access the application"
  value       = "kubectl port-forward -n ${kubernetes_namespace.einvoice_namespace.metadata[0].name} svc/${var.app_name} ${var.server_port}:${var.server_port}"
}

# Image Information
output "image_repository" {
  description = "Container image repository"
  value       = var.image_repository
}

output "image_tag" {
  description = "Container image tag"
  value       = var.image_tag
}

output "full_image_name" {
  description = "Full container image name with tag"
  value       = "${var.image_repository}:${var.image_tag}"
}

# Autoscaling Information
output "hpa_min_replicas" {
  description = "HPA minimum replicas"
  value       = var.autoscaling.min_replicas
}

output "hpa_max_replicas" {
  description = "HPA maximum replicas"
  value       = var.autoscaling.max_replicas
}

output "hpa_cpu_target" {
  description = "HPA CPU target utilization percentage"
  value       = var.autoscaling.cpu_target
}

output "hpa_memory_target" {
  description = "HPA memory target utilization percentage"
  value       = var.autoscaling.memory_target
}

# Security Information

output "encryption_enabled" {
  description = "Whether encryption is enabled"
  value       = var.encryption_key != ""
}

output "tls_enabled" {
  description = "Whether TLS is enabled"
  value       = var.tls_enabled
}

output "ingress_enabled" {
  description = "Whether ingress is enabled"
  value       = var.ingress_enabled
}

# Provider Information

output "providers_configured" {
  description = "List of invoice providers configured"
  value       = ["viettel", "bkav", "misa", "vnpt"]
}

# Summary Message

output "deployment_summary" {
  description = "Summary of deployment configuration"
  value       = <<-EOT
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                  EInvoiceHub Deployment Summary                   ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë Application: ${var.app_name} v${var.app_version}
‚ïë Environment: ${var.environment}
‚ïë Namespace: ${kubernetes_namespace.einvoice_namespace.metadata[0].name}
‚ïë Replicas: ${var.replicas}
‚ïë
‚ïë Database: ${var.mysql_host}:${var.mysql_port}/${var.mysql_database}
‚ïë Cache: ${var.redis_host}:${var.redis_port}
‚ïë MongoDB: ${var.mongo_host}:${var.mongo_port}/${var.mongo_database}
‚ïë
‚ïë Access: ${var.ingress_enabled ? "http://${var.ingress_host}" : "http://localhost:${var.server_port}"}
‚ïë Health: ${var.ingress_enabled ? "http://${var.ingress_host}/actuator/health" : "http://localhost:${var.server_port}/actuator/health"}
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOT
}
</file>

<file path="terraform/variables.tf">
# EInvoiceHub Terraform Variables

# Environment Configuration

variable "environment" {
  description = "Deployment environment (dev, staging, prod)"
  type        = string
  default     = "dev"
}

variable "app_name" {
  description = "Application name"
  type        = string
  default     = "einvoicehub"
}

variable "app_version" {
  description = "Application version"
  type        = string
  default     = "1.0.0"
}

# Kubernetes Configuration

variable "kubernetes_context" {
  description = "Kubernetes context to use"
  type        = string
  default     = "k3d-einvoice"
}

variable "namespace" {
  description = "Kubernetes namespace"
  type        = string
  default     = "einvoice-dev"
}

variable "replicas" {
  description = "Number of pod replicas"
  type        = number
  default     = 2
}

variable "server_port" {
  description = "Application server port"
  type        = number
  default     = 8080
}

# Resource Configuration

variable "resource_quota" {
  description = "Resource quota configuration"
  type = object({
    cpu_limit    = string
    memory_limit = string
  })
  default = {
    cpu_limit    = "8"
    memory_limit = "8Gi"
  }
}

variable "limit_range" {
  description = "Container limit range configuration"
  type = object({
    cpu_request  = string
    memory_request = string
    cpu_limit    = string
    memory_limit = string
    cpu_min      = string
    memory_min   = string
    cpu_max      = string
    memory_max   = string
  })
  default = {
    cpu_request    = "250m"
    memory_request = "256Mi"
    cpu_limit      = "1000m"
    memory_limit   = "1Gi"
    cpu_min        = "100m"
    memory_min     = "128Mi"
    cpu_max        = "2000m"
    memory_max     = "2Gi"
  }
}

variable "autoscaling" {
  description = "Horizontal Pod Autoscaler configuration"
  type = object({
    min_replicas = number
    max_replicas = number
    cpu_target   = number
    memory_target = number
  })
  default = {
    min_replicas = 2
    max_replicas = 10
    cpu_target   = 70
    memory_target = 80
  }
}

# Logging Configuration

variable "log_level" {
  description = "Application log level"
  type        = string
  default     = "INFO"
}

# Database Configuration (for ConfigMap - use secrets for actual values)

variable "mysql_host" {
  description = "MySQL hostname"
  type        = string
  default     = "mysql"
}

variable "mysql_port" {
  description = "MySQL port"
  type        = number
  default     = 3306
}

variable "mysql_database" {
  description = "MySQL database name"
  type        = string
  default     = "einvoicehub"
}

variable "mysql_username" {
  description = "MySQL username"
  type        = string
  default     = "einvoice_user"
}

# MongoDB Configuration

variable "mongo_host" {
  description = "MongoDB hostname"
  type        = string
  default     = "mongodb"
}

variable "mongo_port" {
  description = "MongoDB port"
  type        = number
  default     = 27017
}

variable "mongo_database" {
  description = "MongoDB database name"
  type        = string
  default     = "einvoicehub"
}

variable "mongo_username" {
  description = "MongoDB username"
  type        = string
  default     = "admin"
}

# Redis Configuration

variable "redis_host" {
  description = "Redis hostname"
  type        = string
  default     = "redis"
}

variable "redis_port" {
  description = "Redis port"
  type        = number
  default     = 6379
}

# Security Variables (use environment variables or secret management)

variable "encryption_key" {
  description = "AES-256 encryption key (32 bytes)"
  type        = string
  default     = ""
  sensitive   = true
}

variable "encryption_iv" {
  description = "AES encryption initialization vector (16 bytes)"
  type        = string
  default     = ""
  sensitive   = true
}

variable "jwt_secret" {
  description = "JWT secret key"
  type        = string
  default     = ""
  sensitive   = true
}

variable "jwt_expiration_ms" {
  description = "JWT expiration time in milliseconds"
  type        = string
  default     = "86400000"
}

# Provider API Credentials (use secrets for actual values)

variable "viettel_api_key" {
  description = "Viettel API Key"
  type        = string
  default     = ""
  sensitive   = true
}

variable "viettel_client_id" {
  description = "Viettel Client ID"
  type        = string
  default     = ""
  sensitive   = true
}

variable "bkav_api_key" {
  description = "BKAV API Key"
  type        = string
  default     = ""
  sensitive   = true
}

variable "bkav_client_id" {
  description = "BKAV Client ID"
  type        = string
  default     = ""
  sensitive   = true
}

variable "misa_api_key" {
  description = "MISA API Key"
  type        = string
  default     = ""
  sensitive   = true
}

variable "misa_client_id" {
  description = "MISA Client ID"
  type        = string
  default     = ""
  sensitive   = true
}

variable "misa_client_secret" {
  description = "MISA Client Secret"
  type        = string
  default     = ""
  sensitive   = true
}

# Image Configuration

variable "image_repository" {
  description = "Container image repository"
  type        = string
  default     = "einvoicehub/backend"
}

variable "image_tag" {
  description = "Container image tag"
  type        = string
  default     = "latest"
}

variable "image_pull_policy" {
  description = "Image pull policy (Always, Never, IfNotPresent)"
  type        = string
  default     = "IfNotPresent"
}

# Persistence Configuration

variable "persistence" {
  description = "Persistence configuration"
  type = object({
    enabled  = bool
    size     = string
    storage  = string
  })
  default = {
    enabled  = true
    size     = "10Gi"
    storage  = "standard"
  }
}

# Monitoring Configuration

variable "monitoring_enabled" {
  description = "Enable monitoring stack"
  type        = bool
  default     = true
}

variable "metrics_port" {
  description = "Port for Prometheus metrics"
  type        = number
  default     = 9090
}

# Tracing Configuration

variable "tracing_enabled" {
  description = "Enable distributed tracing"
  type        = bool
  default     = true
}

variable "jaeger_endpoint" {
  description = "Jaeger collector endpoint"
  type        = string
  default     = "http://jaeger:4317"
}

# Ingress Configuration

variable "ingress_enabled" {
  description = "Enable ingress controller"
  type        = bool
  default     = true
}

variable "ingress_host" {
  description = "Ingress hostname"
  type        = string
  default     = "einvoice.local"
}

variable "ingress_class" {
  description = "Ingress class name"
  type        = string
  default     = "nginx"
}

# Certificate Configuration

variable "tls_enabled" {
  description = "Enable TLS for ingress"
  type        = bool
  default     = false
}

variable "tls_secret_name" {
  description = "TLS secret name"
  type        = string
  default     = "einvoice-tls"
}
</file>

<file path=".gitattributes">
/mvnw text eol=lf
*.cmd text eol=crlf
</file>

<file path=".gitignore">
HELP.md
target/
.mvn/wrapper/maven-wrapper.jar
!**/src/main/**/target/
!**/src/test/**/target/

### STS ###
.apt_generated
.classpath
.factorypath
.project
.settings
.springBeans
.sts4-cache

### IntelliJ IDEA ###
.idea
*.iws
*.iml
*.ipr

### NetBeans ###
/nbproject/private/
/nbbuild/
/dist/
/nbdist/
/.nb-gradle/
build/
!**/src/main/**/build/
!**/src/test/**/build/

### VS Code ###
.vscode/
/bin/
</file>

<file path="config.yaml">
spring:
  application:
    name: einvoicehub-core
    
  # MySQL Configuration
  datasource:
    url: jdbc:mysql://${DATABASE_HOST:localhost}:${DATABASE_PORT:3306}/${DATABASE_NAME:einvoicehub}?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
    username: ${DATABASE_USERNAME:root}
    password: ${DATABASE_PASSWORD:password}
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      minimum-idle: 5
      maximum-pool-size: 20
      idle-timeout: 300000
      pool-name: EInvoiceHubHikariCP
      max-lifetime: 1200000
      connection-timeout: 20000
      register-mbeans: true
      
  # JPA Configuration
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.MySQLDialect
        format_sql: true
        jdbc:
          time_zone: UTC
          
  # MongoDB Configuration
  data:
    mongodb:
      uri: mongodb://${MONGODB_USERNAME:admin}:${MONGODB_PASSWORD:password}@${MONGODB_HOST:localhost}:${MONGODB_PORT:27017}/${MONGODB_DATABASE:einvoicehub}?authSource=admin
      auto-index-creation: true
      
# Server Configuration
server:
  port: ${SERVER_PORT:8080}
  servlet:
    context-path: /api/v1
  tomcat:
    threads:
      max: 200
      min-spare: 10
    accept-count: 100
    max-connections: 10000
    
# Application Custom Configuration
app:
  name: EInvoiceHub
  version: 1.0.0
  
  # Virtual Threads Configuration
  virtual-threads:
    enabled: true
    
  # Security Configuration
  security:
    api-key:
      header-name: X-API-KEY
      client-id-header: X-CLIENT-ID
      
# Provider Configuration
providers:
  vnpt:
    base-url: ${VNPT_BASE_URL:https://api.vnpt-invoice.vn}
    timeout: 30000
    retry-count: 3
    
  viettel:
    base-url: ${VIETTEL_BASE_URL:https://einvoice.viettel.vn}
    timeout: 30000
    retry-count: 3
    
  bkav:
    base-url: ${BKAV_BASE_URL:https://bkav-invoice.com}
    timeout: 30000
    retry-count: 3
    encryption-key: ${BKAV_ENCRYPTION_KEY:your-256-bit-key}
    
  misa:
    base-url: ${MISA_BASE_URL:https://api.meinvoice.vn}
    timeout: 30000
    retry-count: 3
    app-id: ${MISA_APP_ID:your-app-id}
    
# Actuator & Monitoring
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
  endpoint:
    health:
      show-details: when-authorized
  metrics:
    tags:
      application: ${spring.application.name}
      
# Logging Configuration
logging:
  level:
    root: INFO
    com.einvoicehub: DEBUG
    org.springframework.security: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    
# OpenAPI Configuration
springdoc:
  api-docs:
    path: /v3/api-docs
  swagger-ui:
    path: /swagger-ui.html
    operations-sorter: method
    tags-sorter: alpha
  show-actuator: true
</file>

<file path="docker-compose.yml">
# Docker Compose configuration for EInvoiceHub local development environment
services:
  # MariaDB Database - Primary relational database
  mariadb:
    image: mariadb:10.11
    container_name: einvoice-mariadb
    hostname: mariadb
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD:-einvoice_root_pass}
      MARIADB_DATABASE: einvoicehub
      MARIADB_USER: einvoice_user
      MARIADB_PASSWORD: ${MARIADB_PASSWORD:-einvoice_pass}
    ports:
      - "3306:3306"
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./sql/init:/docker-entrypoint-initdb.d
      - ./sql/config/my.cnf:/etc/mysql/conf.d/my.cnf:ro
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "localhost", "-u", "root", "-p${MARIADB_ROOT_PASSWORD:-einvoice_root_pass}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - einvoice-network
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
  
  # Prometheus - Metrics collection
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: einvoice-prometheus
    hostname: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/rules:/etc/prometheus/rules:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
    networks:
      - einvoice-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  
  # Grafana - Metrics visualization 
  grafana:
    image: grafana/grafana:10.2.0
    container_name: einvoice-grafana
    hostname: grafana
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-einvoice_grafana}
      - GF_USERS_ALLOW_SIGN_UP=false
    ports:
      - "3000:3000"
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards
      - grafana_data:/var/lib/grafana
    depends_on:
      prometheus:
        condition: service_started
    networks:
      - einvoice-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  
  # EInvoiceHub Application - Main backend service
  backend:
    build:
      context: .
      dockerfile: dockerfile-temp.txt
      target: runtime
    container_name: einvoice-backend
    hostname: backend
    ports:
      - "8080:8080"
      - "5005:5005"
    environment:
      # Spring Boot Configuration
      - SPRING_PROFILES_ACTIVE=dev
      - SERVER_PORT=8080

      # Database Configuration - Thay ƒë·ªïi sang MariaDB
      - SPRING_DATASOURCE_URL=jdbc:mariadb://mariadb:3306/einvoicehub?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      - SPRING_DATASOURCE_USERNAME=einvoice_user
      - SPRING_DATASOURCE_PASSWORD=einvoice_pass
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update

      # Application Specific
      - APP_NAME=einvoicehub
      - LOG_LEVEL=INFO

      # Java VM Options
      - JAVA_OPTS=-XX:+UseG1GC -XX:MaxGCPauseMillis=200 -Xms256m -Xmx512m
    depends_on:
      mariadb:
        condition: service_healthy
    volumes:
      - ./logs:/app/logs:rw
      - ./config:/app/config:ro
    networks:
      - einvoice-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    restart: unless-stopped


# Networks Configuration
networks:
  einvoice-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16


# Volumes Configuration
volumes:
  mariadb_data:
    driver: local
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
</file>

<file path="Dockerfile">
# Stage 1: Builder Stage
FROM maven:3.9.6-eclipse-temurin-21-alpine AS builder
WORKDIR /build

COPY pom.xml .

RUN --mount=type=cache,target=/root/.m2 mvn dependency:go-offline -B

COPY src ./src
RUN --mount=type=cache,target=/root/.m2 mvn clean package -DskipTests -B

FROM eclipse-temurin:21-jre-alpine AS runtime
LABEL maintainer="EInvoiceHub Team" \
      project="EInvoiceHub"
ENV JAVA_OPTS="-XX:+UseG1GC -XX:MaxRAMPercentage=75.0 -Djdk.tracePinnedThreads=short"

RUN addgroup -g 1000 appgroup && \
    adduser -u 1000 -G appgroup -s /bin/sh -D appuser

WORKDIR /app

COPY --from=builder /build/target/*.jar app.jar
RUN mkdir -p /app/logs && chown -R appuser:appgroup /app
USER appuser

EXPOSE 8080

HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
CMD ["--spring.profiles.active=prod"]


FROM builder AS dev
WORKDIR /build
EXPOSE 5005

ENV JAVA_TOOL_OPTIONS="-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005"
ENTRYPOINT ["mvn", "spring-boot:run", "-Dspring-boot.run.profiles=dev"]
</file>

<file path="dockerfile-temp.txt">
# Multi-stage Dockerfile for EInvoiceHub Spring Boot Application
# Optimized for Java 21 with Virtual Threads support



# Stage 1: Builder Stage - Compile and package the application
FROM maven:3.9-eclipse-temurin-21-alpine AS builder
# Set working directory
WORKDIR /build

# Copy pom.xml first for dependency caching
COPY pom.xml ./

# Download dependencies (this layer will be cached unless pom.xml changes)
RUN mvn dependency:go-offline -B

# Copy source code
COPY src ./src

# Build the application with Spring Boot thin launcher for smaller image
RUN mvn package -DskipTests -B


# Stage 2: Runtime Stage - Minimal JRE image for production

FROM eclipse-temurin:21-jre-alpine AS runtime

# Labels for container metadata
LABEL maintainer="EInvoiceHub Team" \
      version="1.0.0" \
      description="EInvoiceHub - Electronic Invoice Hub Service" \
      org.opencontainers.image.source="https://github.com/hkhuang07/EInvoiceHub-SpringBoot-Angular-GitOps-Kubernetes/tree/main/backend-springboot"

# Set environment variables
ENV JAVA_OPTS="-XX:+EnableDynamicAgentLoading -XX:+UseG1GC" \
    APP_NAME="einvoicehub" \
    APP_VERSION="1.0.0"

# Create non-root user for security
RUN addgroup -g 1000 appgroup && \
    adduser -u 1000 -G appgroup -s /bin/sh -D appuser

# Set working directory
WORKDIR /app

# Copy the built artifact from builder stage
COPY --from=builder /build/target/*.jar app.jar

# Create directories for logs and config
RUN mkdir -p /app/logs /app/config && \
    chown -R appuser:appgroup /app

# Switch to non-root user
USER appuser

# Expose application port (default Spring Boot port)
EXPOSE 8080

# Health check configuration
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1

# Entrypoint and CMD
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -Djava.security.egd=file:/dev/./urandom -jar /app/app.jar"]
CMD ["--spring.profiles.active=prod"]


# Stage 3: Development Stage - For local development with debug support

FROM builder AS dev

# Expose debug port
EXPOSE 5005

# Debug JVM options
ENV JAVA_TOOL_OPTIONS="-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005"

# Entrypoint for development with debug
ENTRYPOINT ["sh", "-c", "java $JAVA_TOOL_OPTIONS -Djava.security.egd=file:/dev/./urandom -jar /app/target/*.jar"]


# Alternative: Native Build Stage (Optional - for GraalVM)

# Uncomment this section and comment out the runtime stage for native image
# FROM ghcr.io/graalvm/native-image:21-ol8 AS native-builder

# WORKDIR /build
# COPY --from=builder /build/target/*.jar application.jar
# COPY --from=builder /build/src src

# RUN native-image \
#     -J-Xmx8g \
#     -H:Class=com.einvoicehub.EinvoicehubApplication \
#     -H:Name=einvoicehub-native \
#     -H:+ReportExceptionStackTraces \
#     --no-fallback \
#     -H:+StaticExecutableWithDynamicLibC \
#     -cp application.jar

# FROM ubuntu:22.04 AS native-runtime
# COPY --from=native-builder /build/einvoicehub-native /app/einvoicehub
# RUN chmod +x /app/einvoicehub
# EXPOSE 8080
# ENTRYPOINT ["/app/einvoicehub"]
</file>

<file path="Jenkinsfile.txt">
// =============================================================================
// EInvoiceHub Jenkins CI/CD Pipeline
// =============================================================================
// Purpose: Automated build, test, and deployment pipeline for EInvoiceHub
// Author: EInvoiceHub Team
// =============================================================================

pipeline {
    agent {
        label 'docker-build-agent'
    }

    options {
        // Timeout for the entire pipeline
        timeout(time: 60, unit: 'MINUTES')

        // Disable concurrent builds for the same branch
        disableConcurrentBuilds()

        // Build retention
        buildDiscarder(logRotator(
            numToKeepStr: '10',
            artifactNumToKeepStr: '10'
        ))

        // Skip default checkout
        skipDefaultCheckout()
    }

    environment {
        // Application Info
        APP_NAME = 'einvoicehub'
        APP_VERSION = "${BUILD_NUMBER}"

        // Docker Configuration
        DOCKER_REGISTRY = 'registry.einvoicehub.io'
        DOCKER_IMAGE = "${DOCKER_REGISTRY}/${APP_NAME}/backend:${APP_VERSION}"
        DOCKER_IMAGE_LATEST = "${DOCKER_REGISTRY}/${APP_NAME}/backend:latest"

        // Maven Configuration
        MAVEN_OPTS = '-Xmx1024m'

        // SonarQube Configuration
        SONAR_SCANNER_HOME = tool 'sonar-scanner'

        // Environment
        ENVIRONMENT = 'dev'

        // Kubernetes
        K8S_NAMESPACE = 'einvoice-dev'

        // Tools
        JAVA_VERSION = '21'
    }

    stages {
        // =====================================================================
        // Stage 1: Checkout
        // =====================================================================
        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/einvoicehub/backend.git',
                        credentialsId: 'github-credentials'
                    ]]
                ])
            }
        }

        // =====================================================================
        // Stage 2: Build
        // =====================================================================
        stage('Build') {
            parallel {
                stage('Maven Build') {
                    steps {
                        dir('backend') {
                            withMaven(
                                maven: 'maven-3.9',
                                jdk: 'java-21'
                            ) {
                                sh 'mvn clean compile -DskipTests -B'
                            }
                        }
                    }
                }

                stage('Security Scan') {
                    steps {
                        dir('backend') {
                            withMaven(
                                maven: 'maven-3.9',
                                jdk: 'java-21'
                            ) {
                                sh 'mvn dependency-check:check -B'
                            }
                        }
                    }
                }
            }
        }

        // =====================================================================
        // Stage 3: Unit Tests
        // =====================================================================
        stage('Unit Tests') {
            steps {
                dir('backend') {
                    withMaven(
                        maven: 'maven-3.9',
                        jdk: 'java-21'
                    ) {
                        sh 'mvn test -B'
                    }
                }
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                    cobertura(
                        coberturaReportFile: '**/target/site/cobertura/coverage.xml',
                        autoUpdateHealth: false,
                        autoUpdateStability: false,
                        onlyStable: false
                    )
                }
            }
        }

        // =====================================================================
        // Stage 4: Code Quality
        // =====================================================================
        stage('Code Quality') {
            steps {
                dir('backend') {
                    withMaven(
                        maven: 'maven-3.9',
                        jdk: 'java-21'
                    ) {
                        sh 'mvn sonar:sonar ' +
                           '-Dsonar.projectKey=einvoicehub_backend ' +
                           '-Dsonar.projectName=EInvoiceHub_Backend ' +
                           '-Dsonar.projectVersion=${BUILD_NUMBER} ' +
                           '-Dsonar.sourceEncoding=UTF-8 ' +
                           '-Dsonar.java.binaries=target/classes ' +
                           '-Dsonar.tests=target/test-classes'
                    }
                }
            }
        }

        // =====================================================================
        // Stage 5: Package
        // =====================================================================
        stage('Package') {
            steps {
                dir('backend') {
                    withMaven(
                        maven: 'maven-3.9',
                        jdk: 'java-21'
                    ) {
                        sh 'mvn package -DskipTests -B'
                    }
                }
            }
        }

        // =====================================================================
        // Stage 6: Build Docker Image
        // =====================================================================
        stage('Build Docker Image') {
            steps {
                script {
                    dockerImage = docker.build(
                        "${DOCKER_IMAGE}",
                        "-f Dockerfile --build-arg APP_VERSION=${BUILD_NUMBER} ./backend"
                    )
                }
            }
        }

        // =====================================================================
        // Stage 7: Push Docker Image
        // =====================================================================
        stage('Push Docker Image') {
            steps {
                script {
                    docker.withRegistry("${DOCKER_REGISTRY}", 'docker-registry-credentials') {
                        dockerImage.push()
                        dockerImage.push('latest')
                    }
                }
            }
        }

        // =====================================================================
        // Stage 8: Trivy Vulnerability Scan
        // =====================================================================
        stage('Vulnerability Scan') {
            steps {
                script {
                    trivy(
                        imageRef: "${DOCKER_IMAGE}",
                        exitCode: '0',
                        severity: 'HIGH,CRITICAL',
                        timeout: '300'
                    )
                }
            }
        }

        // =====================================================================
        // Stage 9: Deploy to Development
        // =====================================================================
        stage('Deploy to Development') {
            when {
                branch 'develop'
            }
            steps {
                script {
                    // Update Kubernetes manifests with new image tag
                    sh "sed -i 's|image: ${DOCKER_REGISTRY}/${APP_NAME}/backend:.*|image: ${DOCKER_IMAGE}|g' kubernetes/deployment.yaml"

                    // Deploy to Kubernetes
                    kubernetesDeploy(
                        configs: 'kubernetes/*.yaml',
                        kubeconfigId: 'kubernetes-credentials',
                        namespace: "${K8S_NAMESPACE}"
                    )

                    // Wait for deployment
                    sh "kubectl rollout status deployment/${APP_NAME} -n ${K8S_NAMESPACE} --timeout=300s"

                    // Health check
                    sh "curl -f http://einvoice.local/actuator/health || exit 1"
                }
            }
        }

        // =====================================================================
        // Stage 10: Deploy to Staging
        // =====================================================================
        stage('Deploy to Staging') {
            when {
                branch 'release/*'
            }
            steps {
                script {
                    // Tag release image
                    dockerImage.push("release-${BUILD_NUMBER}")

                    // Update Kubernetes manifests
                    sh "sed -i 's|image: ${DOCKER_REGISTRY}/${APP_NAME}/backend:.*|image: ${DOCKER_IMAGE}|g' kubernetes/deployment.yaml"

                    // Deploy to staging namespace
                    kubernetesDeploy(
                        configs: 'kubernetes/*.yaml',
                        kubeconfigId: 'kubernetes-credentials',
                        namespace: 'einvoice-staging'
                    )

                    // Wait for deployment
                    sh "kubectl rollout status deployment/${APP_NAME} -n einvoice-staging --timeout=300s"

                    // Run integration tests
                    sh "mvn verify -B -DskipUnitTests"
                }
            }
        }

        // =====================================================================
        // Stage 11: Deploy to Production
        // =====================================================================
        stage('Deploy to Production') {
            when {
                branch 'main'
                environment name: 'DEPLOY_TO_PROD', value: 'true'
            }
            steps {
                script {
                    // Approval step
                    timeout(time: 1, unit: 'HOURS') {
                        input message: 'Deploy to Production?', ok: 'Deploy'
                    }

                    // Blue/Green deployment
                    def blueVersion = 'blue'
                    def greenVersion = 'green'
                    def currentVersion = readFile('current-version.txt').trim()
                    def newVersion = currentVersion == blueVersion ? greenVersion : blueVersion

                    // Deploy new version
                    sh "sed -i 's|image: ${DOCKER_REGISTRY}/${APP_NAME}/backend:.*|image: ${DOCKER_IMAGE}|g' kubernetes/deployment.yaml"

                    kubernetesDeploy(
                        configs: 'kubernetes/*.yaml',
                        kubeconfigId: 'kubernetes-credentials',
                        namespace: 'einvoice-prod'
                    )

                    // Wait for deployment
                    sh "kubectl rollout status deployment/${APP_NAME} -n einvoice-prod --timeout=600s"

                    // Health check
                    sh "curl -f https://api.einvoicehub.com/actuator/health || exit 1"

                    // Update current version
                    writeFile file: 'current-version.txt', text: newVersion
                }
            }
        }

        // =====================================================================
        // Stage 12: Post-Deployment
        // =====================================================================
        stage('Post-Deployment') {
            when {
                anyOf {
                    branch 'develop'
                    branch 'release/*'
                    branch 'main'
                }
            }
            steps {
                script {
                    // Send notification
                    slackSend(
                        channel: '#deployments',
                        color: 'good',
                        message: "Deployment Successful: ${APP_NAME} v${BUILD_NUMBER} to ${ENVIRONMENT}"
                    )

                    // Archive artifacts
                    archiveArtifacts(
                        artifacts: '**/target/*.jar,**/target/site/**/*.html',
                        fingerprint: true,
                        allowEmptyArchive: true
                    )
                }
            }
        }
    }

    // =====================================================================
    // Post Actions
    // =====================================================================
    post {
        success {
            echo '‚úì Pipeline completed successfully'
            script {
                if (env.BRANCH_NAME == 'main') {
                    slackSend(
                        channel: '#deployments',
                        color: 'good',
                        message: "‚úÖ Production deployment successful: ${APP_NAME} v${BUILD_NUMBER}"
                    )
                }
            }
        }

        failure {
            echo '‚úó Pipeline failed'
            script {
                slackSend(
                    channel: '#deployments',
                    color: 'danger',
                    message: "‚ùå Deployment failed: ${APP_NAME} v${BUILD_NUMBER}\n${env.BUILD_URL}"
                )
            }
        }

        unstable {
            echo 'Pipeline marked as unstable'
        }

        cleanup {
            // Clean up workspace
            cleanWs(
                deleteDirs: true,
                patterns: [
                    pattern: '.gitignore',
                    invert: true
                ]
            )
        }
    }
}
</file>

<file path="Makefile">
# ƒê·ªãnh nghƒ©a c√°c bi·∫øn
DC = docker-compose
APP_NAME = einvoicehub-backend

# L·ªánh m·∫∑c ƒë·ªãnh khi g√µ 'make'
all: help

help:
	@echo "Common Command:"
	@echo "  make up      : Start Docker containers"
	@echo "  make down    : Stop containers"
	@echo "  make restart : Restart System"
	@echo "  make build   : Rebuild Spring Boot Application and Docker"
	@echo "  make logs    : Views Log  of Application

up:
	$(DC) up -d

down:
	$(DC) down

restart:
	$(DC) down && $(DC) up -d

build:
	./mvnw clean package -DskipTests
	$(DC) up --build -d

logs:
	$(DC) logs -f app
</file>

<file path="pom.xml">
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.4.1</version>
        <relativePath/>
    </parent>

    <groupId>com.einvoicehub</groupId>
    <artifactId>einvoicehub-core</artifactId>
    <version>1.0.0-SNAPSHOT</version>
    <name>EInvoiceHub Core</name>
    <description>H·ªá th·ªëng trung gian k·∫øt n·ªëi h√≥a ƒë∆°n ƒëi·ªán t·ª≠ - EInvoiceHub </description>

    <properties>
        <java.version>21</java.version>
        <spring-boot.version>3.4.1</spring-boot.version>
        <snakeyaml.version>2.2</snakeyaml.version>
    </properties>

    <dependencies>
        <!-- Spring Boot Starters -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>

        <!-- <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-mongodb</artifactId>
        </dependency> -->

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
        </dependency>

        <dependency>
            <groupId>org.flywaydb</groupId>
            <artifactId>flyway-core</artifactId>
        </dependency>

        <dependency>
            <groupId>org.flywaydb</groupId>
            <artifactId>flyway-mysql</artifactId>
        </dependency>

        <!-- Database Drivers -->
        <dependency>
            <groupId>org.mariadb.jdbc</groupId>
            <artifactId>mariadb-java-client</artifactId>
        </dependency>

        <!--Mapstruct - Lombok -->
        <dependency>
            <groupId>org.mapstruct</groupId>
            <artifactId>mapstruct</artifactId>
            <version>1.5.5.Final</version>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>

        <!-- Jackson for JSON -->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
        </dependency>

        <dependency>
            <groupId>com.fasterxml.jackson.dataformat</groupId>
            <artifactId>jackson-dataformat-xml</artifactId>
        </dependency>

        <dependency>
            <groupId>com.fasterxml.jackson.datatype</groupId>
            <artifactId>jackson-datatype-jsr310</artifactId>
        </dependency>
        <!-- SOAP - HttpClient -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web-services</artifactId>        </dependency>

        <dependency>
            <groupId>jakarta.xml.bind</groupId>
            <artifactId>jakarta.xml.bind-api</artifactId>
        </dependency>
        <dependency>
            <groupId>org.glassfish.jaxb</groupId>
            <artifactId>jaxb-runtime</artifactId>
        </dependency>

        <dependency>
            <groupId>org.apache.httpcomponents.client5</groupId>
            <artifactId>httpclient5</artifactId>
        </dependency>

        <!-- Utility -->
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-lang3</artifactId>
        </dependency>

        <dependency>
            <groupId>org.bouncycastle</groupId>
            <artifactId>bcprov-jdk18on</artifactId>
            <version>1.77</version>
        </dependency>

        <!-- YAML Configuration -->
        <dependency>
            <groupId>org.yaml</groupId>
            <artifactId>snakeyaml</artifactId>
            <version>${snakeyaml.version}</version>
        </dependency>

        <!-- OpenAPI/Swagger -->
        <dependency>
            <groupId>org.springdoc</groupId>
            <artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
            <version>2.5.0</version>
        </dependency>

        <!-- Micrometer for metrics -->
        <dependency>
            <groupId>io.micrometer</groupId>
            <artifactId>micrometer-registry-prometheus</artifactId>
        </dependency>

        <!-- Testing -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>org.springframework.security</groupId>
            <artifactId>spring-security-test</artifactId>
            <scope>test</scope>
        </dependency>

        <!-- H2 for testing -->
        <dependency>
            <groupId>com.h2database</groupId>
            <artifactId>h2</artifactId>
            <scope>test</scope>
        </dependency>

        <!-- Mockito -->
        <dependency>
            <groupId>org.mockito</groupId>
            <artifactId>mockito-core</artifactId>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt-api</artifactId>
            <version>0.12.6</version>
        </dependency>

        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt-impl</artifactId>
            <version>0.12.6</version>
            <scope>runtime</scope>
        </dependency>

        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt-jackson</artifactId>
            <version>0.12.6</version>
            <scope>runtime</scope>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>

            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.11.0</version>
                <configuration>
                    <source>21</source>
                    <target>21</target>
                    <annotationProcessorPaths>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                            <version>1.18.30</version>
                        </path>
                        <path>
                            <groupId>org.mapstruct</groupId>
                            <artifactId>mapstruct-processor</artifactId>
                            <version>1.5.5.Final</version>
                        </path>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok-mapstruct-binding</artifactId>
                            <version>0.2.0</version>
                        </path>
                    </annotationProcessorPaths>
                </configuration>
            </plugin>

            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-surefire-plugin</artifactId>
                <version>3.2.2</version>
            </plugin>
        </plugins>
    </build>
</project>
</file>

<file path="purge-data.sh">
#!/bin/bash

# =============================================================================
# EInvoiceHub Data Purge Script
# =============================================================================
# Purpose: Clean up and reset data for local K8s development environment
# Usage: ./purge-data.sh [environment]
# Environments: dev, staging, prod
# =============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Default environment
ENVIRONMENT=${1:-dev}
NAMESPACE="einvoice-${ENVIRONMENT}"

# Confirmation prompt
confirm_purge() {
    echo -e "${YELLOW}‚ö†Ô∏è  WARNING: This will delete all data for environment '${ENVIRONMENT}'${NC}"
    echo -e "${RED}This action cannot be undone!${NC}"
    read -p "Are you sure you want to continue? (yes/no): " CONFIRM

    if [ "$CONFIRM" != "yes" ]; then
        echo -e "${YELLOW}Purge operation cancelled.${NC}"
        exit 0
    fi
}

# Print banner
print_banner() {
    echo -e "${BLUE}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë           EInvoiceHub Data Purge Script                        ‚ïë"
    echo "‚ïë                                                                ‚ïë"
    echo "‚ïë  Environment: ${ENVIRONMENT}${NC}                                  "
    echo -e "${BLUE}‚ïë  Namespace:  ${NAMESPACE}${NC}                                      "
    echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
}

# Check prerequisites
check_prerequisites() {
    echo -e "\n${GREEN}‚úì Checking prerequisites...${NC}"

    # Check for required tools
    local MISSING_TOOLS=()

    if ! command -v kubectl &> /dev/null; then
        MISSING_TOOLS+=("kubectl")
    fi

    if ! command -v docker &> /dev/null; then
        MISSING_TOOLS+=("docker")
    fi

    if ! command -v mongosh &> /dev/null; then
        MISSING_TOOLS+=("mongosh")
    fi

    if ! command -v mysql &> /dev/null; then
        MISSING_TOOLS+=("mysql")
    fi

    if [ ${#MISSING_TOOLS[@]} -ne 0 ]; then
        echo -e "${RED}‚úó Missing required tools: ${MISSING_TOOLS[*]}${NC}"
        echo "Please install the missing tools before running this script."
        exit 1
    fi

    echo -e "${GREEN}‚úì All prerequisites met${NC}"
}

# Stop and remove containers
stop_containers() {
    echo -e "\n${GREEN}‚úì Stopping Docker containers...${NC}"

    if command -v docker &> /dev/null; then
        docker compose down -v --remove-orphans 2>/dev/null || true
        echo -e "${GREEN}‚úì Docker containers stopped and volumes removed${NC}"
    fi
}

# Purge Kubernetes resources
purge_kubernetes() {
    echo -e "\n${GREEN}‚úì Purging Kubernetes resources...${NC}"

    # Check if kubectl is configured
    if ! kubectl cluster-info &> /dev/null; then
        echo -e "${YELLOW}‚ö†Ô∏è  Kubernetes not configured or not accessible. Skipping K8s cleanup.${NC}"
        return
    fi

    # Check if namespace exists
    if kubectl get namespace "$NAMESPACE" &> /dev/null; then
        echo -e "${YELLOW}  Deleting all resources in namespace: $NAMESPACE${NC}"

        # Delete deployments
        kubectl delete deployment --all -n "$NAMESPACE" --ignore-not-found=true

        # Delete services
        kubectl delete service --all -n "$NAMESPACE" --ignore-not-found=true

        # Delete configmaps
        kubectl delete configmap --all -n "$NAMESPACE" --ignore-not-found=true

        # Delete secrets
        kubectl delete secret --all -n "$NAMESPACE" --ignore-not-found=true

        # Delete persistentvolumeclaims
        kubectl delete pvc --all -n "$NAMESPACE" --ignore-not-found=true

        # Delete jobs
        kubectl delete job --all -n "$NAMESPACE" --ignore-not-found=true

        # Delete cronjobs
        kubectl delete cronjob --all -n "$NAMESPACE" --ignore-not-found=true

        echo -e "${GREEN}‚úì Kubernetes resources purged${NC}"
    else
        echo -e "${YELLOW}  Namespace $NAMESPACE does not exist. Skipping.${NC}"
    fi
}

# Purge MySQL data
purge_mysql() {
    echo -e "\n${GREEN}‚úì Purging MySQL data...${NC}"

    local MYSQL_HOST=${MYSQL_HOST:-localhost}
    local MYSQL_PORT=${MYSQL_PORT:-3306}
    local MYSQL_USER=${MYSQL_USER:-root}
    local MYSQL_PASSWORD=${MYSQL_PASSWORD:-einvoice_root_pass}
    local DATABASE=${DATABASE:-einvoicehub}

    # Check if MySQL is running
    if ! docker ps | grep -q "einvoice-mysql"; then
        echo -e "${YELLOW}‚ö†Ô∏è  MySQL container not running. Attempting direct connection...${NC}"
    fi

    # Drop and recreate database
    mysql -h "$MYSQL_HOST" -P "$MYSQL_PORT" -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" <<EOF
DROP DATABASE IF EXISTS $DATABASE;
CREATE DATABASE $DATABASE CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
GRANT ALL PRIVILEGES ON $DATABASE.* TO '$MYSQL_USER'@'%';
FLUSH PRIVILEGES;
EOF

    echo -e "${GREEN}‚úì MySQL data purged and database recreated${NC}"
}

# Purge MongoDB data
purge_mongodb() {
    echo -e "\n${GREEN}‚úì Purging MongoDB data...${NC}"

    local MONGODB_HOST=${MONGODB_HOST:-localhost}
    local MONGODB_PORT=${MONGODB_PORT:-27017}
    local MONGODB_USER=${MONGODB_USER:-admin}
    local MONGODB_PASSWORD=${MONGODB_PASSWORD:-einvoice_mongo_pass}
    local DATABASE=${MONGODB_DATABASE:-einvoicehub}

    # Drop all collections
    mongosh --host "$MONGODB_HOST" --port "$MONGODB_PORT" -u "$MONGODB_USER" -p "$MONGODB_PASSWORD" --authenticationDatabase admin <<EOF
use $DATABASE
db.getCollectionNames().forEach(function(collection) {
    db[collection].drop();
});
print("All collections dropped from database: $DATABASE");
EOF

    echo -e "${GREEN}‚úì MongoDB data purged${NC}"
}

# Purge Redis cache
purge_redis() {
    echo -e "\n${GREEN}‚úì Purging Redis cache...${NC}"

    local REDIS_HOST=${REDIS_HOST:-localhost}
    local REDIS_PORT=${REDIS_PORT:-6379}

    # Flush all Redis databases
    redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" FLUSHALL

    echo -e "${GREEN}‚úì Redis cache purged${NC}"
}

# Purge Elasticsearch indices
purge_elasticsearch() {
    echo -e "\n${GREEN}‚úì Purging Elasticsearch data...${NC}"

    local ES_HOST=${ES_HOST:-localhost}
    local ES_PORT=${ES_PORT:-9200}

    # Delete all indices matching einvoice pattern
    curl -X DELETE "http://$ES_HOST:$ES_PORT/einvoice*" 2>/dev/null || true

    echo -e "${GREEN}‚úì Elasticsearch data purged${NC}"
}

# Clean up local files
cleanup_files() {
    echo -e "\n${GREEN}‚úì Cleaning up local files...${NC}"

    # Remove log files
    if [ -d "logs" ]; then
        rm -rf logs/*
        echo "  - Logs cleared"
    fi

    # Remove temporary files
    if [ -d "tmp" ]; then
        rm -rf tmp/*
        echo "  - Temporary files cleared"
    fi

    # Remove generated reports
    if [ -d "reports" ]; then
        rm -rf reports/*
        echo "  - Reports cleared"
    fi

    echo -e "${GREEN}‚úì Local files cleaned${NC}"
}

# Print summary
print_summary() {
    echo -e "\n${BLUE}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                    PURGE COMPLETED                              ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo -e "\n${GREEN}Summary:${NC}"
    echo "  - Environment: $ENVIRONMENT"
    echo "  - Namespace: $NAMESPACE"
    echo "  - Docker containers: Stopped"
    echo "  - MySQL database: Recreated"
    echo "  - MongoDB collections: Dropped"
    echo "  - Redis cache: Flushed"
    echo "  - Elasticsearch indices: Deleted"
    echo "  - Local files: Cleaned"
    echo -e "\n${YELLOW}Next steps:${NC}"
    echo "  1. Run 'docker compose up -d' to restart services"
    echo "  2. Run migrations if needed"
    echo "  3. Restart the application"
    echo -e "\n"
}

# Main execution
main() {
    print_banner
    confirm_purge
    check_prerequisites

    # Perform purging based on environment
    case "$ENVIRONMENT" in
        dev)
            stop_containers
            purge_mysql
            purge_mongodb
            purge_redis
            cleanup_files
            ;;
        staging|prod)
            purge_kubernetes
            purge_elasticsearch
            cleanup_files
            ;;
        *)
            echo -e "${RED}Invalid environment: $ENVIRONMENT${NC}"
            echo "Valid environments: dev, staging, prod"
            exit 1
            ;;
    esac

    print_summary
}

# Run main function
main "$@"
</file>

<file path="repomix.config.json">
{
  "output": {
    "filePath": "einvoicehub-full-source.txt",
    "style": "xml"
  },
  "include": ["**/*"],
  "ignore": {
    "customPatterns": [
      "**/bin/**",
      "**/target/**",
      "**/*.class",
      "**/*.exe",
      "**/*.jar",
      "mvnw",
      "mvnw.cmd",
      "**/HELP.md",
      "**/.git/**",
      "**/.idea/**",
      "**/.vscode/**",
      "**/node_modules/**",
      "**/dist/**"
    ],
    "useGitignore": true,
    "useDefaultPatterns": true
  },
  "security": {
    "enableSecurityCheck": true
  },
  "tokenCount": {
    "encoding": "cl100k_base"
  }
}
</file>

</files>
</file>

<file path="Jenkinsfile.txt">
// =============================================================================
// EInvoiceHub Jenkins CI/CD Pipeline
// =============================================================================
// Purpose: Automated build, test, and deployment pipeline for EInvoiceHub
// Author: EInvoiceHub Team
// =============================================================================

pipeline {
    agent {
        label 'docker-build-agent'
    }

    options {
        // Timeout for the entire pipeline
        timeout(time: 60, unit: 'MINUTES')

        // Disable concurrent builds for the same branch
        disableConcurrentBuilds()

        // Build retention
        buildDiscarder(logRotator(
            numToKeepStr: '10',
            artifactNumToKeepStr: '10'
        ))

        // Skip default checkout
        skipDefaultCheckout()
    }

    environment {
        // Application Info
        APP_NAME = 'einvoicehub'
        APP_VERSION = "${BUILD_NUMBER}"

        // Docker Configuration
        DOCKER_REGISTRY = 'registry.einvoicehub.io'
        DOCKER_IMAGE = "${DOCKER_REGISTRY}/${APP_NAME}/backend:${APP_VERSION}"
        DOCKER_IMAGE_LATEST = "${DOCKER_REGISTRY}/${APP_NAME}/backend:latest"

        // Maven Configuration
        MAVEN_OPTS = '-Xmx1024m'

        // SonarQube Configuration
        SONAR_SCANNER_HOME = tool 'sonar-scanner'

        // Environment
        ENVIRONMENT = 'dev'

        // Kubernetes
        K8S_NAMESPACE = 'einvoice-dev'

        // Tools
        JAVA_VERSION = '21'
    }

    stages {
        // =====================================================================
        // Stage 1: Checkout
        // =====================================================================
        stage('Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: '*/main']],
                    userRemoteConfigs: [[
                        url: 'https://github.com/einvoicehub/backend.git',
                        credentialsId: 'github-credentials'
                    ]]
                ])
            }
        }

        // =====================================================================
        // Stage 2: Build
        // =====================================================================
        stage('Build') {
            parallel {
                stage('Maven Build') {
                    steps {
                        dir('backend') {
                            withMaven(
                                maven: 'maven-3.9',
                                jdk: 'java-21'
                            ) {
                                sh 'mvn clean compile -DskipTests -B'
                            }
                        }
                    }
                }

                stage('Security Scan') {
                    steps {
                        dir('backend') {
                            withMaven(
                                maven: 'maven-3.9',
                                jdk: 'java-21'
                            ) {
                                sh 'mvn dependency-check:check -B'
                            }
                        }
                    }
                }
            }
        }

        // =====================================================================
        // Stage 3: Unit Tests
        // =====================================================================
        stage('Unit Tests') {
            steps {
                dir('backend') {
                    withMaven(
                        maven: 'maven-3.9',
                        jdk: 'java-21'
                    ) {
                        sh 'mvn test -B'
                    }
                }
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                    cobertura(
                        coberturaReportFile: '**/target/site/cobertura/coverage.xml',
                        autoUpdateHealth: false,
                        autoUpdateStability: false,
                        onlyStable: false
                    )
                }
            }
        }

        // =====================================================================
        // Stage 4: Code Quality
        // =====================================================================
        stage('Code Quality') {
            steps {
                dir('backend') {
                    withMaven(
                        maven: 'maven-3.9',
                        jdk: 'java-21'
                    ) {
                        sh 'mvn sonar:sonar ' +
                           '-Dsonar.projectKey=einvoicehub_backend ' +
                           '-Dsonar.projectName=EInvoiceHub_Backend ' +
                           '-Dsonar.projectVersion=${BUILD_NUMBER} ' +
                           '-Dsonar.sourceEncoding=UTF-8 ' +
                           '-Dsonar.java.binaries=target/classes ' +
                           '-Dsonar.tests=target/test-classes'
                    }
                }
            }
        }

        // =====================================================================
        // Stage 5: Package
        // =====================================================================
        stage('Package') {
            steps {
                dir('backend') {
                    withMaven(
                        maven: 'maven-3.9',
                        jdk: 'java-21'
                    ) {
                        sh 'mvn package -DskipTests -B'
                    }
                }
            }
        }

        // =====================================================================
        // Stage 6: Build Docker Image
        // =====================================================================
        stage('Build Docker Image') {
            steps {
                script {
                    dockerImage = docker.build(
                        "${DOCKER_IMAGE}",
                        "-f Dockerfile --build-arg APP_VERSION=${BUILD_NUMBER} ./backend"
                    )
                }
            }
        }

        // =====================================================================
        // Stage 7: Push Docker Image
        // =====================================================================
        stage('Push Docker Image') {
            steps {
                script {
                    docker.withRegistry("${DOCKER_REGISTRY}", 'docker-registry-credentials') {
                        dockerImage.push()
                        dockerImage.push('latest')
                    }
                }
            }
        }

        // =====================================================================
        // Stage 8: Trivy Vulnerability Scan
        // =====================================================================
        stage('Vulnerability Scan') {
            steps {
                script {
                    trivy(
                        imageRef: "${DOCKER_IMAGE}",
                        exitCode: '0',
                        severity: 'HIGH,CRITICAL',
                        timeout: '300'
                    )
                }
            }
        }

        // =====================================================================
        // Stage 9: Deploy to Development
        // =====================================================================
        stage('Deploy to Development') {
            when {
                branch 'develop'
            }
            steps {
                script {
                    // Update Kubernetes manifests with new image tag
                    sh "sed -i 's|image: ${DOCKER_REGISTRY}/${APP_NAME}/backend:.*|image: ${DOCKER_IMAGE}|g' kubernetes/deployment.yaml"

                    // Deploy to Kubernetes
                    kubernetesDeploy(
                        configs: 'kubernetes/*.yaml',
                        kubeconfigId: 'kubernetes-credentials',
                        namespace: "${K8S_NAMESPACE}"
                    )

                    // Wait for deployment
                    sh "kubectl rollout status deployment/${APP_NAME} -n ${K8S_NAMESPACE} --timeout=300s"

                    // Health check
                    sh "curl -f http://einvoice.local/actuator/health || exit 1"
                }
            }
        }

        // =====================================================================
        // Stage 10: Deploy to Staging
        // =====================================================================
        stage('Deploy to Staging') {
            when {
                branch 'release/*'
            }
            steps {
                script {
                    // Tag release image
                    dockerImage.push("release-${BUILD_NUMBER}")

                    // Update Kubernetes manifests
                    sh "sed -i 's|image: ${DOCKER_REGISTRY}/${APP_NAME}/backend:.*|image: ${DOCKER_IMAGE}|g' kubernetes/deployment.yaml"

                    // Deploy to staging namespace
                    kubernetesDeploy(
                        configs: 'kubernetes/*.yaml',
                        kubeconfigId: 'kubernetes-credentials',
                        namespace: 'einvoice-staging'
                    )

                    // Wait for deployment
                    sh "kubectl rollout status deployment/${APP_NAME} -n einvoice-staging --timeout=300s"

                    // Run integration tests
                    sh "mvn verify -B -DskipUnitTests"
                }
            }
        }

        // =====================================================================
        // Stage 11: Deploy to Production
        // =====================================================================
        stage('Deploy to Production') {
            when {
                branch 'main'
                environment name: 'DEPLOY_TO_PROD', value: 'true'
            }
            steps {
                script {
                    // Approval step
                    timeout(time: 1, unit: 'HOURS') {
                        input message: 'Deploy to Production?', ok: 'Deploy'
                    }

                    // Blue/Green deployment
                    def blueVersion = 'blue'
                    def greenVersion = 'green'
                    def currentVersion = readFile('current-version.txt').trim()
                    def newVersion = currentVersion == blueVersion ? greenVersion : blueVersion

                    // Deploy new version
                    sh "sed -i 's|image: ${DOCKER_REGISTRY}/${APP_NAME}/backend:.*|image: ${DOCKER_IMAGE}|g' kubernetes/deployment.yaml"

                    kubernetesDeploy(
                        configs: 'kubernetes/*.yaml',
                        kubeconfigId: 'kubernetes-credentials',
                        namespace: 'einvoice-prod'
                    )

                    // Wait for deployment
                    sh "kubectl rollout status deployment/${APP_NAME} -n einvoice-prod --timeout=600s"

                    // Health check
                    sh "curl -f https://api.einvoicehub.com/actuator/health || exit 1"

                    // Update current version
                    writeFile file: 'current-version.txt', text: newVersion
                }
            }
        }

        // =====================================================================
        // Stage 12: Post-Deployment
        // =====================================================================
        stage('Post-Deployment') {
            when {
                anyOf {
                    branch 'develop'
                    branch 'release/*'
                    branch 'main'
                }
            }
            steps {
                script {
                    // Send notification
                    slackSend(
                        channel: '#deployments',
                        color: 'good',
                        message: "Deployment Successful: ${APP_NAME} v${BUILD_NUMBER} to ${ENVIRONMENT}"
                    )

                    // Archive artifacts
                    archiveArtifacts(
                        artifacts: '**/target/*.jar,**/target/site/**/*.html',
                        fingerprint: true,
                        allowEmptyArchive: true
                    )
                }
            }
        }
    }

    // =====================================================================
    // Post Actions
    // =====================================================================
    post {
        success {
            echo '‚úì Pipeline completed successfully'
            script {
                if (env.BRANCH_NAME == 'main') {
                    slackSend(
                        channel: '#deployments',
                        color: 'good',
                        message: "‚úÖ Production deployment successful: ${APP_NAME} v${BUILD_NUMBER}"
                    )
                }
            }
        }

        failure {
            echo '‚úó Pipeline failed'
            script {
                slackSend(
                    channel: '#deployments',
                    color: 'danger',
                    message: "‚ùå Deployment failed: ${APP_NAME} v${BUILD_NUMBER}\n${env.BUILD_URL}"
                )
            }
        }

        unstable {
            echo 'Pipeline marked as unstable'
        }

        cleanup {
            // Clean up workspace
            cleanWs(
                deleteDirs: true,
                patterns: [
                    pattern: '.gitignore',
                    invert: true
                ]
            )
        }
    }
}
</file>

<file path="Makefile">
# ƒê·ªãnh nghƒ©a c√°c bi·∫øn
DC = docker-compose
APP_NAME = einvoicehub-backend

# L·ªánh m·∫∑c ƒë·ªãnh khi g√µ 'make'
all: help

help:
	@echo "Common Command:"
	@echo "  make up      : Start Docker containers"
	@echo "  make down    : Stop containers"
	@echo "  make restart : Restart System"
	@echo "  make build   : Rebuild Spring Boot Application and Docker"
	@echo "  make logs    : Views Log  of Application

up:
	$(DC) up -d

down:
	$(DC) down

restart:
	$(DC) down && $(DC) up -d

build:
	./mvnw clean package -DskipTests
	$(DC) up --build -d

logs:
	$(DC) logs -f app
</file>

<file path="pom.xml">
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.4.1</version>
        <relativePath/>
    </parent>

    <groupId>com.einvoicehub</groupId>
    <artifactId>einvoicehub-core</artifactId>
    <version>1.0.0-SNAPSHOT</version>
    <name>EInvoiceHub Core</name>
    <description>H·ªá th·ªëng trung gian k·∫øt n·ªëi h√≥a ƒë∆°n ƒëi·ªán t·ª≠ - EInvoiceHub </description>

    <properties>
        <java.version>21</java.version>
        <spring-boot.version>3.4.1</spring-boot.version>
        <snakeyaml.version>2.2</snakeyaml.version>
    </properties>

    <dependencies>
        <!-- Spring Boot Starters -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>

        <!-- <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-mongodb</artifactId>
        </dependency> -->

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
        </dependency>

        <dependency>
            <groupId>org.flywaydb</groupId>
            <artifactId>flyway-core</artifactId>
        </dependency>

        <dependency>
            <groupId>org.flywaydb</groupId>
            <artifactId>flyway-mysql</artifactId>
        </dependency>

        <!-- Database Drivers -->
        <dependency>
            <groupId>org.mariadb.jdbc</groupId>
            <artifactId>mariadb-java-client</artifactId>
        </dependency>

        <!--Mapstruct - Lombok -->
        <dependency>
            <groupId>org.mapstruct</groupId>
            <artifactId>mapstruct</artifactId>
            <version>1.5.5.Final</version>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>

        <!-- Jackson for JSON -->
        <dependency>
            <groupId>com.fasterxml.jackson.core</groupId>
            <artifactId>jackson-databind</artifactId>
        </dependency>

        <dependency>
            <groupId>com.fasterxml.jackson.dataformat</groupId>
            <artifactId>jackson-dataformat-xml</artifactId>
        </dependency>

        <dependency>
            <groupId>com.fasterxml.jackson.datatype</groupId>
            <artifactId>jackson-datatype-jsr310</artifactId>
        </dependency>
        <!-- SOAP - HttpClient -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web-services</artifactId>        </dependency>

        <dependency>
            <groupId>jakarta.xml.bind</groupId>
            <artifactId>jakarta.xml.bind-api</artifactId>
        </dependency>
        <dependency>
            <groupId>org.glassfish.jaxb</groupId>
            <artifactId>jaxb-runtime</artifactId>
        </dependency>

        <dependency>
            <groupId>org.apache.httpcomponents.client5</groupId>
            <artifactId>httpclient5</artifactId>
        </dependency>

        <!-- Utility -->
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-lang3</artifactId>
        </dependency>

        <dependency>
            <groupId>org.bouncycastle</groupId>
            <artifactId>bcprov-jdk18on</artifactId>
            <version>1.77</version>
        </dependency>

        <!-- YAML Configuration -->
        <dependency>
            <groupId>org.yaml</groupId>
            <artifactId>snakeyaml</artifactId>
            <version>${snakeyaml.version}</version>
        </dependency>

        <!-- OpenAPI/Swagger -->
        <dependency>
            <groupId>org.springdoc</groupId>
            <artifactId>springdoc-openapi-starter-webmvc-ui</artifactId>
            <version>2.5.0</version>
        </dependency>

        <!-- Micrometer for metrics -->
        <dependency>
            <groupId>io.micrometer</groupId>
            <artifactId>micrometer-registry-prometheus</artifactId>
        </dependency>

        <!-- Testing -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>org.springframework.security</groupId>
            <artifactId>spring-security-test</artifactId>
            <scope>test</scope>
        </dependency>

        <!-- H2 for testing -->
        <dependency>
            <groupId>com.h2database</groupId>
            <artifactId>h2</artifactId>
            <scope>test</scope>
        </dependency>

        <!-- Mockito -->
        <dependency>
            <groupId>org.mockito</groupId>
            <artifactId>mockito-core</artifactId>
            <scope>test</scope>
        </dependency>

        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt-api</artifactId>
            <version>0.12.6</version>
        </dependency>

        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt-impl</artifactId>
            <version>0.12.6</version>
            <scope>runtime</scope>
        </dependency>

        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt-jackson</artifactId>
            <version>0.12.6</version>
            <scope>runtime</scope>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>

            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.11.0</version>
                <configuration>
                    <source>21</source>
                    <target>21</target>
                    <annotationProcessorPaths>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                            <version>1.18.30</version>
                        </path>
                        <path>
                            <groupId>org.mapstruct</groupId>
                            <artifactId>mapstruct-processor</artifactId>
                            <version>1.5.5.Final</version>
                        </path>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok-mapstruct-binding</artifactId>
                            <version>0.2.0</version>
                        </path>
                    </annotationProcessorPaths>
                </configuration>
            </plugin>

            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-surefire-plugin</artifactId>
                <version>3.2.2</version>
            </plugin>
        </plugins>
    </build>
</project>
</file>

<file path="purge-data.sh">
#!/bin/bash

# =============================================================================
# EInvoiceHub Data Purge Script
# =============================================================================
# Purpose: Clean up and reset data for local K8s development environment
# Usage: ./purge-data.sh [environment]
# Environments: dev, staging, prod
# =============================================================================

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Default environment
ENVIRONMENT=${1:-dev}
NAMESPACE="einvoice-${ENVIRONMENT}"

# Confirmation prompt
confirm_purge() {
    echo -e "${YELLOW}‚ö†Ô∏è  WARNING: This will delete all data for environment '${ENVIRONMENT}'${NC}"
    echo -e "${RED}This action cannot be undone!${NC}"
    read -p "Are you sure you want to continue? (yes/no): " CONFIRM

    if [ "$CONFIRM" != "yes" ]; then
        echo -e "${YELLOW}Purge operation cancelled.${NC}"
        exit 0
    fi
}

# Print banner
print_banner() {
    echo -e "${BLUE}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë           EInvoiceHub Data Purge Script                        ‚ïë"
    echo "‚ïë                                                                ‚ïë"
    echo "‚ïë  Environment: ${ENVIRONMENT}${NC}                                  "
    echo -e "${BLUE}‚ïë  Namespace:  ${NAMESPACE}${NC}                                      "
    echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
}

# Check prerequisites
check_prerequisites() {
    echo -e "\n${GREEN}‚úì Checking prerequisites...${NC}"

    # Check for required tools
    local MISSING_TOOLS=()

    if ! command -v kubectl &> /dev/null; then
        MISSING_TOOLS+=("kubectl")
    fi

    if ! command -v docker &> /dev/null; then
        MISSING_TOOLS+=("docker")
    fi

    if ! command -v mongosh &> /dev/null; then
        MISSING_TOOLS+=("mongosh")
    fi

    if ! command -v mysql &> /dev/null; then
        MISSING_TOOLS+=("mysql")
    fi

    if [ ${#MISSING_TOOLS[@]} -ne 0 ]; then
        echo -e "${RED}‚úó Missing required tools: ${MISSING_TOOLS[*]}${NC}"
        echo "Please install the missing tools before running this script."
        exit 1
    fi

    echo -e "${GREEN}‚úì All prerequisites met${NC}"
}

# Stop and remove containers
stop_containers() {
    echo -e "\n${GREEN}‚úì Stopping Docker containers...${NC}"

    if command -v docker &> /dev/null; then
        docker compose down -v --remove-orphans 2>/dev/null || true
        echo -e "${GREEN}‚úì Docker containers stopped and volumes removed${NC}"
    fi
}

# Purge Kubernetes resources
purge_kubernetes() {
    echo -e "\n${GREEN}‚úì Purging Kubernetes resources...${NC}"

    # Check if kubectl is configured
    if ! kubectl cluster-info &> /dev/null; then
        echo -e "${YELLOW}‚ö†Ô∏è  Kubernetes not configured or not accessible. Skipping K8s cleanup.${NC}"
        return
    fi

    # Check if namespace exists
    if kubectl get namespace "$NAMESPACE" &> /dev/null; then
        echo -e "${YELLOW}  Deleting all resources in namespace: $NAMESPACE${NC}"

        # Delete deployments
        kubectl delete deployment --all -n "$NAMESPACE" --ignore-not-found=true

        # Delete services
        kubectl delete service --all -n "$NAMESPACE" --ignore-not-found=true

        # Delete configmaps
        kubectl delete configmap --all -n "$NAMESPACE" --ignore-not-found=true

        # Delete secrets
        kubectl delete secret --all -n "$NAMESPACE" --ignore-not-found=true

        # Delete persistentvolumeclaims
        kubectl delete pvc --all -n "$NAMESPACE" --ignore-not-found=true

        # Delete jobs
        kubectl delete job --all -n "$NAMESPACE" --ignore-not-found=true

        # Delete cronjobs
        kubectl delete cronjob --all -n "$NAMESPACE" --ignore-not-found=true

        echo -e "${GREEN}‚úì Kubernetes resources purged${NC}"
    else
        echo -e "${YELLOW}  Namespace $NAMESPACE does not exist. Skipping.${NC}"
    fi
}

# Purge MySQL data
purge_mysql() {
    echo -e "\n${GREEN}‚úì Purging MySQL data...${NC}"

    local MYSQL_HOST=${MYSQL_HOST:-localhost}
    local MYSQL_PORT=${MYSQL_PORT:-3306}
    local MYSQL_USER=${MYSQL_USER:-root}
    local MYSQL_PASSWORD=${MYSQL_PASSWORD:-einvoice_root_pass}
    local DATABASE=${DATABASE:-einvoicehub}

    # Check if MySQL is running
    if ! docker ps | grep -q "einvoice-mysql"; then
        echo -e "${YELLOW}‚ö†Ô∏è  MySQL container not running. Attempting direct connection...${NC}"
    fi

    # Drop and recreate database
    mysql -h "$MYSQL_HOST" -P "$MYSQL_PORT" -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" <<EOF
DROP DATABASE IF EXISTS $DATABASE;
CREATE DATABASE $DATABASE CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
GRANT ALL PRIVILEGES ON $DATABASE.* TO '$MYSQL_USER'@'%';
FLUSH PRIVILEGES;
EOF

    echo -e "${GREEN}‚úì MySQL data purged and database recreated${NC}"
}

# Purge MongoDB data
purge_mongodb() {
    echo -e "\n${GREEN}‚úì Purging MongoDB data...${NC}"

    local MONGODB_HOST=${MONGODB_HOST:-localhost}
    local MONGODB_PORT=${MONGODB_PORT:-27017}
    local MONGODB_USER=${MONGODB_USER:-admin}
    local MONGODB_PASSWORD=${MONGODB_PASSWORD:-einvoice_mongo_pass}
    local DATABASE=${MONGODB_DATABASE:-einvoicehub}

    # Drop all collections
    mongosh --host "$MONGODB_HOST" --port "$MONGODB_PORT" -u "$MONGODB_USER" -p "$MONGODB_PASSWORD" --authenticationDatabase admin <<EOF
use $DATABASE
db.getCollectionNames().forEach(function(collection) {
    db[collection].drop();
});
print("All collections dropped from database: $DATABASE");
EOF

    echo -e "${GREEN}‚úì MongoDB data purged${NC}"
}

# Purge Redis cache
purge_redis() {
    echo -e "\n${GREEN}‚úì Purging Redis cache...${NC}"

    local REDIS_HOST=${REDIS_HOST:-localhost}
    local REDIS_PORT=${REDIS_PORT:-6379}

    # Flush all Redis databases
    redis-cli -h "$REDIS_HOST" -p "$REDIS_PORT" FLUSHALL

    echo -e "${GREEN}‚úì Redis cache purged${NC}"
}

# Purge Elasticsearch indices
purge_elasticsearch() {
    echo -e "\n${GREEN}‚úì Purging Elasticsearch data...${NC}"

    local ES_HOST=${ES_HOST:-localhost}
    local ES_PORT=${ES_PORT:-9200}

    # Delete all indices matching einvoice pattern
    curl -X DELETE "http://$ES_HOST:$ES_PORT/einvoice*" 2>/dev/null || true

    echo -e "${GREEN}‚úì Elasticsearch data purged${NC}"
}

# Clean up local files
cleanup_files() {
    echo -e "\n${GREEN}‚úì Cleaning up local files...${NC}"

    # Remove log files
    if [ -d "logs" ]; then
        rm -rf logs/*
        echo "  - Logs cleared"
    fi

    # Remove temporary files
    if [ -d "tmp" ]; then
        rm -rf tmp/*
        echo "  - Temporary files cleared"
    fi

    # Remove generated reports
    if [ -d "reports" ]; then
        rm -rf reports/*
        echo "  - Reports cleared"
    fi

    echo -e "${GREEN}‚úì Local files cleaned${NC}"
}

# Print summary
print_summary() {
    echo -e "\n${BLUE}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                    PURGE COMPLETED                              ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo -e "\n${GREEN}Summary:${NC}"
    echo "  - Environment: $ENVIRONMENT"
    echo "  - Namespace: $NAMESPACE"
    echo "  - Docker containers: Stopped"
    echo "  - MySQL database: Recreated"
    echo "  - MongoDB collections: Dropped"
    echo "  - Redis cache: Flushed"
    echo "  - Elasticsearch indices: Deleted"
    echo "  - Local files: Cleaned"
    echo -e "\n${YELLOW}Next steps:${NC}"
    echo "  1. Run 'docker compose up -d' to restart services"
    echo "  2. Run migrations if needed"
    echo "  3. Restart the application"
    echo -e "\n"
}

# Main execution
main() {
    print_banner
    confirm_purge
    check_prerequisites

    # Perform purging based on environment
    case "$ENVIRONMENT" in
        dev)
            stop_containers
            purge_mysql
            purge_mongodb
            purge_redis
            cleanup_files
            ;;
        staging|prod)
            purge_kubernetes
            purge_elasticsearch
            cleanup_files
            ;;
        *)
            echo -e "${RED}Invalid environment: $ENVIRONMENT${NC}"
            echo "Valid environments: dev, staging, prod"
            exit 1
            ;;
    esac

    print_summary
}

# Run main function
main "$@"
</file>

<file path="repomix.config.json">
{
  "output": {
    "filePath": "einvoicehub-full-source.txt",
    "style": "xml"
  },
  "include": ["**/*"],
  "ignore": {
    "customPatterns": [
      "**/bin/**",
      "**/target/**",
      "**/*.class",
      "**/*.exe",
      "**/*.jar",
      "mvnw",
      "mvnw.cmd",
      "**/HELP.md",
      "**/.git/**",
      "**/.idea/**",
      "**/.vscode/**",
      "**/node_modules/**",
      "**/dist/**"
    ],
    "useGitignore": true,
    "useDefaultPatterns": true
  },
  "security": {
    "enableSecurityCheck": true
  },
  "tokenCount": {
    "encoding": "cl100k_base"
  }
}
</file>

</files>
