# EInvoiceHub Helm Chart Values

# Global Settings

global:
  imageRegistry: registry.einvoicehub.io
  imagePullSecrets:
    - name: registry-credentials
  storageClass: standard
  timezone: Asia/Ho_Chi_Minh

# EInvoiceHub Application Configuration
replicaCount: 2

image:
  repository: einvoicehub/backend
  tag: 1.0.0
  pullPolicy: IfNotPresent

imagePullSecrets:
  - name: registry-credentials

nameOverride: ""
fullnameOverride: ""

# Service Account
serviceAccount:
  create: true
  name: einvoicehub
  annotations: {}

# Pod Security Context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000

# Container Security Context
securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

# Service Configuration
service:
  type: ClusterIP
  port: 80
  targetPort: 8080

# Ingress Configuration
ingress:
  enabled: true
  className: nginx
  hosts:
    - host: einvoice.local
      paths:
        - path: /api
          pathType: ImplementationSpecific
        - path: /actuator
          pathType: ImplementationSpecific
  annotations:
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"

# Resources Configuration
resources:
  requests:
    cpu: 250m
    memory: 256Mi
  limits:
    cpu: 1000m
    memory: 1Gi

# Autoscaling Configuration
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

# Node Selection
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app: einvoicehub
          topologyKey: kubernetes.io/hostname

# Liveness Probe
livenessProbe:
  httpGet:
    path: /actuator/health/liveness
    port: http
  initialDelaySeconds: 60
  periodSeconds: 30
  timeoutSeconds: 10
  failureThreshold: 3
  successThreshold: 1

# Readiness Probe
readinessProbe:
  httpGet:
    path: /actuator/health/readiness
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

# Startup Probe
startupProbe:
  httpGet:
    path: /actuator/health
    port: http
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 30
  successThreshold: 1

# Application Environment Variables
env:
  # Application Settings
  APP_NAME: einvoicehub
  APP_VERSION: 1.0.0
  SPRING_PROFILES_ACTIVE: prod

  # Logging
  LOG_LEVEL: INFO
  LOG_FORMAT: json

  # JVM Options
  JAVA_OPTS: "-XX:+UseG1GC -XX:MaxGCPauseMillis=200 -Xms256m -Xmx512m"
  JAVA_THREADS_VIRTUAL_ENABLED: "true"

# Environment Variables from Secrets
envFrom:
  - configMapRef:
      name: einvoicehub-config
  - secretRef:
      name: einvoicehub-secrets
  - secretRef:
      name: einvoicehub-provider-secrets


# Database Configuration
mysql:
  enabled: true
  architecture: standalone
  auth:
    database: einvoicehub
    existingSecret: einvoicehub-mysql-secret
    secretKeys:
      rootPasswordKey: mysql-root-password
      userPasswordKey: mysql-password
  primary:
    persistence:
      enabled: true
      size: 10Gi
      storageClass: standard
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1Gi
    livenessProbe:
      enabled: true
      initialDelaySeconds: 120
    readinessProbe:
      enabled: true
      initialDelaySeconds: 30

mongodb:
  enabled: true
  architecture: standalone
  auth:
    database: einvoicehub
    existingSecret: einvoicehub-mongodb-secret
    secretKeys:
      mongodbPasswordKey: mongodb-password
      mongodbRootPasswordKey: mongodb-root-password
  persistence:
    enabled: true
    size: 10Gi
    storageClass: standard
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi

redis:
  enabled: true
  architecture: standalone
  auth:
    existingSecret: einvoicehub-redis-secret
    secretKeys:
      redisPasswordKey: redis-password
  master:
    persistence:
      enabled: false
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 250m
        memory: 256Mi

# Monitoring Configuration
prometheus:
  enabled: true
  prometheus:
    prometheusSpec:
      retention: 15d
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: standard
            resources:
              requests:
                storage: 20Gi
      ruleSelector:
        matchLabels:
          prometheus: einvoicehub
      serviceMonitorSelector:
        matchLabels:
          release: prometheus

grafana:
  enabled: true
  adminUser: admin
  adminPassword: einvoicehub_grafana_admin
  persistence:
    enabled: true
    storageClassName: standard
    size: 5Gi
  dashboardsProvider: true
  dashboardProviders:
    dashboardproviders.yaml:
      providers:
        - name: einvoicehub
          orgId: 1
          folder: EInvoiceHub
          type: file
          disableDeletion: false
          options:
            path: /var/lib/grafana/dashboards/einvoicehub
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: Prometheus
          type: prometheus
          url: http://einvoicehub-prometheus:9090
          isDefault: true

jaeger:
  enabled: true
  collector:
    replicaCount: 1
    options:
      collector:
        zipkin:
          host-port: 9411
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
  query:
    replicaCount: 1
    options:
      query:
        base-path: /jaeger
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi
  storage:
    type: memory

# Init Containers Configuration
initContainers:
  waitForMysql:
    enabled: true
    image: busybox:1.36
    resources:
      requests:
        cpu: 10m
        memory: 16Mi
      limits:
        cpu: 50m
        memory: 32Mi

  waitForMongodb:
    enabled: true
    image: busybox:1.36
    resources:
      requests:
        cpu: 10m
        memory: 16Mi
      limits:
        cpu: 50m
        memory: 32Mi

  waitForRedis:
    enabled: true
    image: busybox:1.36
    resources:
      requests:
        cpu: 10m
        memory: 16Mi
      limits:
        cpu: 50m
        memory: 32Mi

# Volume Configuration
volumes:
  logs:
    enabled: true
    type: emptyDir
  config:
    enabled: true
    type: configmap
    name: einvoicehub-config

# Topology Spread Configuration
topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: kubernetes.io/hostname
    whenUnsatisfiable: DoNotSchedule
    labelSelector:
      matchLabels:
        app: einvoicehub

# Pod Disruption Budget
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# Network Policy
networkPolicy:
  enabled: true
  ingressRules:
    - from:
        - namespaceSelector:
            matchLabels:
              name: ingress-nginx
      ports:
        - port: 8080
  egressRules:
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - port: 53
          protocol: UDP


# Rollout Strategy
rollingUpdate:
  maxSurge: 1
  maxUnavailable: 0


# Termination Grace Period
terminationGracePeriodSeconds: 30
